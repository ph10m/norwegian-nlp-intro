Summary,Description,Custom field (Epic Link),Component/s,Component/s
Mulighet til å bytte operasjon,"Som bruker av Datafangst

ønsker jeg å kunne bytte type operasjon for et NVDB-objektet som er hentet inn i kontrakten

så jeg slipper å fjerne det og så importere på nytt dersom det er feil operasjon eller importere i flere runder dersom jeg skal ha ulik operasjon på ulike objekter som importeres samtidig",NVDB-6938,Datafangst,
"""Tilkoblingslekasje"" mot oracle databasen","Jeg lager en sak her for å ha en utviklersak som har tilknytning til problemet diskutert her: https://www.vegvesen.no/jira/browse/NVDBFOR-514 .

Det er altså slik at tilkoblingspoolen til databasen jevnlig blir større. Det er altså slik at vi bruker koblinger direkte til databasen / via spørredatabasen i noen sammenhenger selv om de aller fleste spørringer går mot solr. Det finnes to databasekonfigurasjoner i utilities repoet (https://git.vegvesen.no/projects/NVDBDATA/repos/nvdb-utils/browse), den ene er basert på HikariCP mens den andre er en mer standard oracle tilkobling ( ? ). Ut i fra testing virker det som at det er Hikari som blir brukt, men konfigurasjonen som forteller at det skal være maks 10 tilkoblinger blir ikke respektert. Vi vet ikke hvorfor. 

Det kan være interessant å ta opp tråden med å sjekke debugloggingen fra noe som heter Dbix. Det virker som at den blir initialisert med nye datakilder ganske ofte. Her kan man feks. søke på ""ORIGIN=""Dbix"" NOT (""Removing session"" OR ""Opening new connection"" OR ""Calling openSession"") index=svvpnvdbapil"" i splunk.

Ut over dette tror vi at det kan ha noe med mengde trafikk å gjøre, da antall koblinger vokser betydelig fortere i PROD-miljøet.

Før vi får løst denne saken bør vi kjøre restart av prod-poddene med jevne mellomrom slik at vi får resatt mengden koblinger.
Da kan man feks. kjøre ""ac perform rolling restart b-nvdbapi-v3 -e produksjon-v3 -i nvdbapil""",NVDB-6937,Les-API,
Importere sensitive data over API,"Ved import av objekter med sensitive egenskaper fra API-lenke i Vegkart kommer disse inn som tomme felter i det importere objektet.

Sensitive egenskaper må kunne importeres.

Dersom brukeren mangler rettigheter til disse må det vises et varsel om dette (og valg om det skal importeres uten eller avbryte import).

Hva skjer dersom objektet importeres og sendes tilbake med tomme felt? Blir NVDB oppdatert med ny versjon uten disse egenskapene?",NVDB-6937,Datafangst,
NVDB-ID retur på status-endepunkt i API,,NVDB-6938,Datafangst,
Feil i SOSI-format,"Som bruker av Vegkart-eskport

opplever jeg at SOSI-eksporten i Vegkart ikke har samme format som eksport fra Datafangst eller GisLine.

Se Vedlagt sammestilling.

Standardene må være like i alle verktøy så de kan importeres og benyttes likt i alle vertøy.",NVDB-6937,Eksport,
Forespørsel fra Nye Veier/Prevas,"Årsaken til at vi ser etter en måte å få et komplett uttrekk fra Databasen med alle forekomster er at vi skal bygge en tilsvarende struktur i Nye Veier sitt _Digitale Driftssystem_ (*DDS*) som den dere har i *NVDB* i dag. Vi kan få det til ved å hente ut bruddstykker av konfigurasjonen fra APIet og sette det sammen til en helhet. Allikevel tror vi at det vil være enklere om vi kan få et uttrekk hvor vi får en total oversikt over innholdet som vi kan bruke for å automatisere konfigurering av oppsett i Infor *EAM*.

 

Nils Overgaard skrev følgende ønskeliste:
 * Liste over alle *_Objekter_* (utstyr), inkludert *Vegobjekt-ID*, *Beskrivelse*, *Type-ID**,* *Type Beskrivelse* og *Overordnet ID* Her trenger vi kun objekter som gjelder for Nye Veier.
 * Liste over *_Objekttyper_* (klasser), må inneholde *Type-ID* og *Beskrivelse*
 * Liste med *_Egenskapsfelt_* med *Egenskapsfelt ID*, *Beskrivelse* og *Datatype*
 Hvis alle egenskapsfelt kun brukes på en objekttype, kan dette oppgis i denne listen med *Type-ID.* Hvis ikke må det lages en egen liste over alle kombinasjoner av ** *Type-ID* og ** *Egenskaps ID*
 * Liste med *_Egenskapsfelt_* med verdier for alle *Objekter*.  Må inneholde *Objekt ID, Egenskaps ID* og ** *Verdi*
 * Liste med *_Egenskapsfelt Oppslagsverdier_*, som inneholder *Egenskapsfelt ID**,* *Oppslagsverdi* ** *ID* og *Beskrivelse*

 

Videre skal det opprettes en struktur i DDS etter Kontraktsområde, Vegsystemreferanse, Strekning, Delstrekning, Objekt, Objekt. Går det an å trekke ut en komplett strukturtabell med ObjektIDer som viser Mor datter eller Overordnet Underordnet forhold? Vi vil da kunne bygge strukturen i DDS basert på dette. Dette var kobling som vi finner det vanskelig å utlede i sin helhet fra API.

 

Når det gjelder Vegobjekt-ID i DDS så tenker vi å benytte den samme som i NVDB for objektene da dette er et sentralt nøkkelfelt og inngår i alle relasjoner. For å opprette nye objekter i DDS som ikke skal ligge i NVDB så trenger vi da å bruke en nummerserie som ikke benyttes nå eller i fremtiden av NVDB. Kan vi gå ut fra at om vi starter nye nummer på f.eks 2.000.000.000 så vil det ligge utenfor det området som vil bli benyttet av NVDB?",NVDB-6937,Les-API,Skriv-API
Tilgang til utv miljø for Datafangst API,"*Fra:* Kjell Håland <[kjell.haaland@traftec.no|mailto:kjell.haaland@traftec.no]> 
 *Sendt:* torsdag 29. april 2021 10:07
 *Til:* Datafangst support <[Datafangst-support@vegvesen.no|mailto:Datafangst-support@vegvesen.no]>
 *Emne:* Datafangst

 

Hei,

 

Som driftsentreprenør i veglys og elektrokontrakter ønsker vi å gjøre en integrasjon mot datafangst.

Tanken er at vi fra vårt interne system kan skrive til datafangst når våre montører gjør endringer på anlegget.

 

Hvordan går vi frem for å få til en slik integrasjon?

 

Har dere ett utviklingsmiljø for datafangst man kan få tilgang til?

 

Ser dere har ett docker-bilde for datafangst, men dette virker gammelt.

[https://hub.docker.com/r/nvdbapnevegdata/nvdb-datafangst/]

 

Hører fra dere! 😊

 

Med vennlig hilsen / best regards,

 

*Kjell Håland*

Systemutvikler

[Otera Traftec AS|https://www.otera.no/]

 

E: [kjell.haaland@traftec.no|mailto:kjell.haaland@traftec.no]

M: +47 904 00 207",NVDB-6827,Datafangst,
Gi tilbakemelding på forespørsel fra Nye Veier/Prevas,"Vi har fått henvendelsen under fra Prevas, via Nye Veier, som har behov for å diskutere spørsmålene med noen på teamet ([~magnoy] & [~joslet]?). Dette er relatert til temaer som ble tatt opp i møte arrangert av Espen Sveen den 23.4

 

Ta kontakt med Bjørn Moland (Product Manager EAM, mailto:bjorn.moland@prevas.no), med mailto:[bjornar.ostgaard@nyeveier.no|mailto:bjornar.ostgaard@nyeveier.no] og mailto:[espen.sveen@vegvesen.no|mailto:espen.sveen@vegvesen.no] på kopi.

 

-----

I forbindelse med nytt driftssystem skal Prevas tilrettelegge for NVDB data i Infor EAM. For å få dataene på plass skal det bestemmes hvilke datafelt som skal tas i bruk i, hvilke attributter som skal tas inn, struktur og forholdet mellom objekter. Kan det tilrettelegges datauttrekk fra NVDB som inneholder mer informasjon om datamodellen enn det som kan hentes ut fra APIer?

- En ren liste med data under nye veier med alle objekter i en tabell.
- Liste med egenskapsdata for alle objekter
- Liste over objekttyper
- Liste med Egenskapsfelt med ID og datatype for alle felt
- Liste med oppslagsverdier for egenskapsfelt
- Tabell med relasjoner mellom Mor og Datterobjekter for alle objekter for å bygge struktur.

Prevas spør også om det finnes en nummerserie for NVDB som ikke er benyttet som Nye veier kan benytte uten at numrene kolliderer. Har NVDB objekter f.eks. alltid et fast antall siffer i nummeret?",NVDB-6937,Les-API,Skriv-API
Leveranseinformasjon Skriv 2021.5.0,"Saker i leveransen: [NVDB: Skrive-API 2021.5 - JIRA for Statens vegvesen|https://www.vegvesen.no/jira/projects/NVDB/versions/17892]

 

*Testes av SVV:*
 * NVDB-7036 : Sjekk at informasjonen gir en bedre indikasjon på hva som mangler i søket.

 

*Testes av Capgemini:*
 * NVDB-7068 : Send inn stedfesting som er nevnt i saken. Få vellykket stedfestning innen 10 sekunder.
 * NVDB-7051 : Gå til generatoren og gjennomfør noen oppførte tester.
 * NVDB-7031 : Last ned siste Docker-image og verifiser innlogging til kontrollpanelet.
 * NVDB-6935 : Datafangst sender inn for å bekrefte at meldingen er forbedret. 

 ",NVDB-6937,Skriv-API,
Feil i stedfest peaker CPU,"h2. Bakgrunn

Det har i en lengre periode vært hendelser som har ført til at CPU i miljøene har gått rett i taket og faller ikke ned igjen. Normal CPU for skriv er mellom 0.01 og 0.4 på veldig høy last. Hendelsen har forårsaket CPU så høyt som 4-5. Dette har tatt ressurser fra andre applikasjoner i SVV.
h2. Analyse

Analyse har blitt gjennomført i NVDB-7059.
h2. Hendelse

Hendelsen som har blitt fanget opp er kall fra Datafangst som går til _*/rest/v3**/stedfest*_ 

Har klart å gjenskape feilen med å gjenskape payloaden fra Datafangst:
 _<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">_
   _<parametere>_
     _<maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>_
     _<beregnSideposisjon>true</beregnSideposisjon>_
   _</parametere>_
   _<vegobjekter>_
     _<vegobjekt typeId=""99"" tempId=""509c2d70-4231-4843-85f1-b47222d5bfb3"">_
       _<gyldighetsperiode>_
         _<startdato>2021-04-22</startdato>_
       _</gyldighetsperiode>_
       _<egenskaper>_
         _<egenskap typeId=""4798"">_
           _<geometri>_
             _<srid>25833</srid>_
             _<wkt>LINESTRING (164112.17 6604590.75, 164091.42 6604594.69, 164013.9 6604535.51, 163791.57 6604519.58, 163276.03 6604575.04, 163151.44 6604625.44, 163086.24 6604683.08, 163035.56 6604757.77, 162950.49 6605009.38, 162887.92 6605033.04, 162657.25 6605038.41, 162608.85 6605074.54, 162577.02 6605143.94, 162593.79 6605216.87, 162851.05 6605509.81, 162865.19 6605752.22, 162845.11 6605750.01, 162822.92 6605674.51, 162779 6605631.74, 162593.56 6605605.32, 162367.4 6605724.64, 162227.36 6605852.07, 162089.67 6605857.45, 161985.2 6605889.73, 161887.65 6605898.05, 161779.3 6605955.28, 161661.02 6605983.51, 161594.55 6606070.44, 161475.96 6606115, 161417.06 6606160.71, 161345.49 6606283.42, 161222.66 6606394.75, 160999.06 6606732.83, 160720.49 6606903.49, 160627.73 6606942.23, 160624.98 6607017.13, 160704.72 6607102.52, 160766.65 6607126.36, 160901.23 6607133.47, 161006.45 6607158.37, 161165.43 6607099.02, 161387.73 6606920.08, 161659.44 6606834.51, 161847.21 6606733.58, 161931.48 6606723.62, 161978.58 6606737.43, 162097.91 6606888.89, 162094.75 6606942.91, 162046.56 6607065.15, 162098.66 6607286.2, 162121.72 6607571.26, 162061.73 6607702.14, 161959.23 6607794.83, 161774.63 6607894.41, 161562.53 6607904.37, 161451.34 6608217.28, 161403.37 6608256.37, 161296.48 6608290.33, 161220.8 6608418.57, 161089.18 6608388.96)</wkt>_
           _</geometri>_
         _</egenskap>_
       _</egenskaper>_
       _<assosiasjoner/>_
     _</vegobjekt>_
   _</vegobjekter>_
 _</stedfest>_

 
  Dette fører til at requesten bare står å henger å får ingen respons.",NVDB-6937,Skriv-API,
Vise fagdata på historisk vegnett,"Jeg lovet å gi en nærmere beskrivelse av funksjonen i NVDB som gir oss mulighet til å se en vegstrekning med både operativ og historisk vegtrase og tilhørende fagdata.

Under innsyn – hent nytt datasett og spesifisering av HVOR det hentes fra er det mulig å legge inn en vegstrekning med hp og meter fra-til. Dette gjøres under «vegreferanser og gater».

Eksempel på en strekning vi vet er bygget om ser du nedenfor.

!Historisk vegstrekning i NVDB123-1.jpg!

Under HVA som hentes velger vi «trafikkulykke» og setter på et filter på periode.

Eks:

!Historisk vegstrekning i NVDB123-2.png!

Deretter trykker vi på Hent data fra NVDB og huker av for Ta med historisk vegnett og historiske fagdata (gjelder nedlagt/omlagt veg).

!Historisk vegstrekning i NVDB123-3.png!

Resultatet vises i kart på denne måten. Hvis du åpner data-tabellen vil du se at flere av ulykkene har *operativ vegreferanse=FV* og *historisk vegreferanse=EV*. Du vil altså finne eksempler på ulykker som har skjedd på ombygd veg i dette uttrekket.

!Historisk vegstrekning i NVDB123-4.jpg!

Til bruk i filter:

HVOR – 0500 (fylke) Ev6 hp13 m3639 - 0500 Ev6 hp15 m15156 (Ny vegsystemreferanse: EV6 S46D1 m3639 - EV6 S48D1 m15728).

HVA – Trafikkulykke.Ulykkesdato >= 20100101

Med hilsen
 Thea Merete Vesterås
 Mobil: +47 92444288",NVDB-6938,Les-API,
"Deaktivere knapp for lukking for ""Entreprenør""","Entreprenør som logger inn med e-post får valg om å lukke data i NVDB.

!image-2021-04-20-09-58-52-153.png!

Det gir feilmelding å trykke på knappen

!image-2021-04-20-09-58-10-784.png!

Knappen burde deaktiverast likt med innsending til NVDB for Entreprenør",NVDB-6937,Datafangst,
Mulighet for å hente ut NVDB ID fra Datafangst API,"Opprinnelig etterspørsel fra volue.com:

Vi har en kunde som ønsker å få vite nvdbid på de dataene som leveres via datafangst api’et. Jeg vet det er mulig å hente nvdbid via Les api’et, men der er det ingen kobling mot en featurecollection som er levert datafangst.
 Så er det noen som helst måte å få tilbake, enten når en sender inn en featurecollection eller i ettertid når en henter status på en featurecollection, å få vite hvilken nvdbid et objekt får tildelt. – Stig Vidar Hovland",NVDB-6937,Datafangst,
"Import av vegobjekter med ""Nøyaktighet"" lik -1","Ved import av vegobjekter med ""Nøyaktiget"" lik -1, må det endres til blank ("""") så det er mulig å sende inn til NVDB.",NVDB-6937,Datafangst,
Nøyaktighet og Målemetode har ulovlige verdier,"*Målemetode*

Målemetode er satt til verdi 0 som ikke er tillat, dette må enders til verdi 99, som er ukjent målemetode.

*Nøyaktighet*

Fra Datakatalogen skal Nøyaktighet ha verdier mellom 0 og 99999, eller blank.

Det finnes flere innslag av -1 i samtlige miljøer. Bør endres til blank.

Eksempel på feil verdi: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/15/240466141/2]

 ",NVDB-6937,Database,
Estimat: Vidareutvikling produktfortefølge,"Det er behov for en rekke større eller mindre forbedringer i portefølgen fremover.

Dette bør vi føre en oversikt over og tilhørende overordnede løsningsforslag og estimater for enkelt å eventuelt samle til ""forbedrings-prosjekter"" som vi kan gjøre avrop på for å få dedikerte ressurser etter prioritet og behov.

Bør kanskje være en Wiki likt med teknisk gjeld?

Eksempel på oppgaver som bør ligge der (enkelte er estimert andre er ikke):
 * Elveg 2.0 (Endringsmelding 2021-1)
 * Import av Datakatalogen (Endringsmelding 2021-2)
 * Import av områdegrenser (Endringsmelding 2021-2)
 * GML-støtte i NVDB (Endringsmelding 2021-3)
 * Sensitive data i Vegkart (innlogging)
 * Historiske (datospesifikke) data i Vegkart
 * Forbedret SOSI i Datafangst
 * Forbedret API i Datafangst
 * Statistikkgenerator (makro) i NVDB
 * Inhousing Datafangst

 ",NVDB-6940,,
Unngå feil fra bean valideringen til Skriv,"Til vanlig så er det forventet at endringssett fra Datafangst blir sendt til Skriv og det blir registrert. Nå i det siste har det oppstått flere problemer med at endringssett ikke kommer inn å blir registrert grunnet validering som skjer ved endepunktet. Dette er en en Bean Validering og vil returnere HTTP-400 med en feilmelding oppsatt ulikt enn hva som er forventet. Et eksempel på den type feilmelding er: 

_""registrer.vegobjekter[6].egenskaper[4].verdier[0].kvalitet.nøyaktighet: Må være større enn eller lik 0""_

Hvor meldingen sier at under *registrer* er det vegobjekt *6* som har egenskap *4* med en verdi som ikke er innenfor det datakatalogen tilsier. I dette tilfellet var det at egenskapen _nøyaktighet_ var *-1*.

 

Problemet har ført til flere supportsaker hvor bruker ikke vet hva som må endres, for Datafangst viser bar Beskrivelse: _Vegobjektene ble avvist fordi det ble funnet feil under validering_

 

Noe som er verd å merke seg er at HTTP-400 med feilmelding blir returnert allerede etter første forekomst. Dette betyr at om en bruker sender inn 100 vegobjekt med samme feilen så blir bare 1 returnert som feil, og den neste blir ikke vist før det blir sendt inn på nytt.

Grunnet dette vil det være mer hensiktsfult at det blir gjennomført en input sjekk i Datafangst *før* det blir sendt til Skriv. Det vil skape mindre frustrasjon hos brukeren. :) 

 

Foreslår derfor å implementere en sjekk for de to forekomstene som har ført til supportsak, og deretter plukke opp andre ""løse tråder"" når det kommer inn supportsak.

 ",NVDB-6938,Datafangst,
Bytte utgående brukere i tester + se på feilende live integrasjonstester,"Mange av integrasjonstestene og e2e tester benytter brukerer som er utgående. De må oppdateres til enten ""fjesløse"" brukere eller benytte brukere til teamet i NVDB.",NVDB-6937,Skriv-API,
Oversikt over teknisk gjeld,"Få en oversikt over teknisk gjeld i prosjektet.

Teknisk gjeld innebærer følgende:
 * Refaktorisering
 * Sårbarheter
 * Utgående avhengigheter
 * Utfasede bibliotek og rammeverk
 * Dokumentasjon
 * Minnelekkasjer
 * Distribusjonsstrategi
 * Overvåking og logging

 
 Dette dokumentet vil ikke inneholde tidsestimering for utredelse men omfanget vil bli kategorisert med tanke på *risiko* og *arbeidsmengde*.
  
 Dokumentet blir lagt til Wiki og saken blir oppdatert med link når dokumentet er ferdig.

 

[NVDB API SKRIV - Teknisk Gjeld - IKT - Forvaltning og videreutvikling - Confluence (vegvesen.no)|https://www.vegvesen.no/wiki/display/FoV/NVDB+API+SKRIV+-+Teknisk+Gjeld]",NVDB-6937,Skriv-API,
Flytte API Les Client,"Fra og med 01.05.2021 så vil ikke JFrog Bintray eksistere. V3 klienten til les ligger der og må derfor flyttes. [https://jfrog.com/blog/into-the-sunset-bintray-jcenter-gocenter-and-chartcenter/] 

 

Alt annet i NVDB ligger i JFrog Artifactory, og vil ikke klienten også kunne legges inn der?

 ",NVDB-6937,Les-API,
"Estimat: historisk og sensitiv data, faglig filter.","Vi må vurdere nye funksjoner i Vegkart og trenger skisse/estimat for utvikling av dette:
 * Historisk data (datospesifik).
 Legge til felt for å skrive inn dato som Vegkart skal vise data i forhold til.
 * Sensitive data.
 Innlogging for å vise sensitive data:
 ** Ved første forsøk på å vise sensitiv data. (fortrinnsvis)
 ** Kopi av Vegkart med innlogging.
 * Faglige filter
 Mulighet for å filtrere basert på andre fagdata. For eksempel vise alle trafikkulykker på veg med fartsgrense 60 eller større.",NVDB-6938,Vegkart,
Feilmelding vises når den ikke skal ved automatisk stedfesting der mor er i NVDB fra før,"Supportsak fra Raymond:
""Her skjedde det en feil igjen med stedfesting selv om de har like koordinater. Om feilen bare var at det hang på objektet som var hentet inn, at det kun måtte hentes inn på nytt, eller om det var Operasjon Korriger som trøblet vet/husker jeg ikke fra sist, men jeg fikk det lagret til NVDB når jeg fjernet den med Korriger fra tabellen og hentet den inn igjen med Oppdater. Dog, når jeg så skulle stedfeste/vegtilknytte den på ny, byttet fra hovedvei til GangSykkelveg(GS-veg) for alle platene og skiltpunktet, så fikk jeg feilen under. Jeg har fått det tidligere også, noen ganger er den reell andre ganger ikke, denne gangen ikke, men fint om den kun kommer opp når stedfestinga faktisk ikke ble flyttet automatisk. Litt småpirk kanskje, men kan bli forvirrende…""
 
!image-2021-03-29-15-06-05-480.png|thumbnail! ",NVDB-6937,Datafangst,
Ny SQL-funksjon for håndtering av vegnummer for privatveger,"Referer til sak: NVDB-6428 for Automatisk populere vegnummer i Vegsystem (915).

Gjennomført møte med [~extt09] og [~trykra] og har vært gjennom ønsket funksjonalitet.

 

I *SKRIV* ønsker vi å gjennomføre et kall til: _nvdb.RoadSystemUtils.getNextFreePrivateRoadnumber( ? )_ hvor følgende parameter er _kommunenummeret_ og den skal returnere et vegnummer som ikke er benyttet.

 

Vegnummer er et tall mellom 0-99999 hvor det starter på 99999 og blir dekrementert. Det er hull i løpenummeret som gjør for eks. at 99920 er ledig men ikke 99917. Må derfor sjekke i kommunen hvilke vegnummer som allerede er benyttet.",NVDB-6937,Database,
Brukertilpasset eksport,"*Fra:* Raymond Krossøy Hermansen <[raymond.hermansen@vtfk.no|mailto:raymond.hermansen@vtfk.no]> 
 *Sendt:* onsdag 24. mars 2021 11:08
 *Til:* Hans Anton Ålien <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]>
 *Kopi:* Vilhelm Børnes <[vilhelm.bornes@vegvesen.no|mailto:vilhelm.bornes@vegvesen.no]>; Knut Dammen <[knut.dammen@vtfk.no|mailto:knut.dammen@vtfk.no]>; Torbjørn Gjendem <[torbjorn.gjendem@vegvesen.no|mailto:torbjorn.gjendem@vegvesen.no]>
 *Emne:* SV: Vegkart: Kritisk, dette er ikke bra!!!

 

Hei igjen.

 

Angående utfordringa i det vi mailer om her og det vi diskuterte per tlf. sist, så er det veldig mange fagpersoner som både legger inn data og som tar ut data, og ikke så mange av oss har kunnskapene som trengs for å gjøre dette «riktig» sånn systemet i dag fungerer, det er komplisert, vi er alt for mange om det og uten god nok opplæring. Selv erfarne NVDB folk sliter jo til en viss grad med å huske alt. Er det noen måte vi kan diskutere oss frem til en løsning som vil serve flest mulig brukere best? Jeg prøver meg på noen tanker, antakelser, forslag og ønsker under. PS! Sitter ikke på noen fasit.

 

*+Problemstillinger+*
 * Jeg tenker at det er vanskelig å lære alle NVDB-forvaltere å legge inn data i NVDB _«helt riktig»_ sånn over natta, altså alt etter føringer gitt/nødvendigheter for å få riktige uttrekk o.l. Det kan f.eks. være at man bør splitte alle strekningsobjekter i alle kryss og eventuelt i andre unaturlige veglenkeoverganger. Jeg mener det er viktig at vi prøver å forenkle så mye som mulig for å sikre og unngå muligheter for feilkilder.
 * I tillegg har vi andre fagfolk som ønsker å legge inn data og som kan det enda dårligere. Noen av de +må+ legge inn data selv, da forvaltere ellers ikke har kapasitet til alt.
 * Så har vi jo den at det kanskje ikke er ønskelig å legge inn alle strekningsdata med splittelser også…?

 * Verktøy for mottak av data og innleggelse har ikke funksjonalitet til å splitte, sy, lukke en splittet flate igjen, osv. for å få dataene levert fra entreprenør inn i NVDB på denne måten heller.

 * Burde vi hatt en godkjent opplæring ala Matrikkelkurs for å kunne få tilgang til å føre i NVDB? Da må selvsagt føringsinstrukser være på plass først.


 * Det som også er vanskelig er å informere og få alle til å huske og forstå at data som tas ut i excellister kan bli feil dersom man tenker å summere opp i antall, lengde eller areal. Hva annet bruker folk disse listene til egentlig?
 * Antall og noen lengder kan vises riktig i kartvisninga og infoen i Vegkart, men spesielt areal, og mest sannsynlig noen lengder, vil man ikke kunne se riktig summerte tall på der. Derfor må vi ty til excel. Da er det viktig at det man ser der blir riktig for flest mulig brukere.
 * Vi som tar ut til kontraktutlysning vil nok få det riktig, for det meste, men for de som vil se ferske tall, se tall for kun et utvalg av forekomstene av et objekt e.l. vil ta ut nye lister og mest sannsynlig summere opp feil uten å vite om det, veldig uheldig.

 

*+Tenkte løsningsforslag+*
 * +Antakelse;+ I vegkart ville jeg tru at de fleste, spesielt ikke-fagpersoner, som vil ha ut en excelliste for oversikt over det filteret de har satt i kartet, kun vil se en telling av en forekomst, altså FØRSTE FOREKOMST=1. 
 * +Forslag på kort sikt;+ Kunne dere ha snudd på det, satt Standard filter i CSV-fila til FØRSTE FOREKOMST=1 sånn at det automatisk viser kun en telling. Dersom folk da ønsker å faktisk se alle tellingene av forekomsten og vegtilknytningene den har så må heller +de+ slå av filteret eller filtrere på 0 verdien etter eget ønske.
 * +Forslag på lenger sikt;+ Kan det være riktig å anta at det kun er interessant å vise hvilke vegnumre som et objekt tilstøter og ikke alle mulige veglenker? Med unntak av administrative objekter kanskje. I så fall håper jeg at det burde være mulig å ha en kolonneegenskap med tilknyttede vegnummer listet opp i, sånn at forekomster vises med kun en linje samtidig som man kan se at denne forekomsten er tilknyttet flere veier. Verdi for kolonnen Vegnummer i disse tilfellene med flere vegtilknytninger kan da være «Flere».
 * +Forslag på enda lenger sikt;+
 * Gjøre det mulig å ta ut flere typer rapporter i excel via Vegkart som sånn sett løser problemet og informerer om hva den enkelte rapporten faktisk viser.
 * Ha visning av kart og tabell der man kan filtrere og summere på ønskede verdier i tabellen samtidig som man kan markere linje i tabell og få vist hvilket det er i kartet, og visa-versa. Bør også ha funksjoner som automidtstill tabellen til forekomst merket i kartet, og zoom til 1:1000 på forekomst markert i tabell ved dobbeltklikk, f.eks.
 * Dersom man tar ut info om kun en vei, vis i tabell og rapport/CSV at forekomster er tilknyttet flere veier ala _«forslag på lenger sikt»_ over.
 * Enda bedre er om det finnes en måte å la løsningen selv «splitte» forekomster som går over flere veier til to areal/lengder ved å beregne avstand fra senterlinjene og bruke midtpunktet til å splitte og sånn sett beregne ut ny lengde/areal. Ser at denne kan være utfordrende å få til, men hva vet jeg, derfor spør jeg. Hadde vært den beste løsningen om vi skal snakke om hva som er enkelt for oss alle med tanke på registrering og uthenting av informasjon.

 

 

Andre synspunkter som forklarer noen av ønskene over er at jeg mener det bør være mulig å finne mest mulig info i en og samme løsning. Eventuelt at det er en smooth integrasjon mellom flere løsninger som gjør at man ikke må ta å gjøre samme søk, filter osv. på ny, men beholder det man gjorde der man startet sitt søk etter info. Jeg vil egentlig gå så langt som å si at jeg synes det heller ville ha vært ønskelig å fjerne muligheten for å ta ut misvisende CSV- og SOSI-filer i Vegkart dersom det er tenkt at andre løsninger kan/skal gjøre det på en mer tilrettelagt og riktig måte. Vegkart viser jo mer eller mindre alle rådataene i excel og ser veldig rotete ut for de aller fleste, i tillegg til feilkildene de har/kan ha.

 

Ring meg gjerne opp om det kan være fornuftig å snakke mer rundt dette, men noen ganger er det lurt å få det ned skriftlig også, og jeg har satt noen på kopi som du ser.

 

 

Vennlig hilsen
 
 *Raymond Krossøy Hermansen*
 Rådgiver 
 Team geodata 
 Samferdsel, miljø og mobilitet
 
 Mobil: [93 03 20 25|tel:93%2003%2020%2025]",NVDB-6938,Eksport,
Tilgang til forvaltnings grensesnitt,,,,
Fylke mangler,"h1. Supportmail fra Åsmund Holen <asmund.holen@vianova.no>

Resultatfil fra «Egendefinerte rapporter – Detaljert mengdeoversikt (V4)»  inneholder ikke fylkesinformasjon. Dvs når man tar ut rapport for flere fylker i en spørring så vet man ikke hvilket fylke data tilhører. Hadde vært greit med en egen kolonne som viser fylke😊",NVDB-6937,Rapportgenerator,
Oppdater dokumentasjon - get_posisjon/EPSG6173,"h1. POB-sak fra Ole Johs.

Hei,
 
Ser på: https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Posisjon/get_posisjon
 
 !image-2021-03-24-13-57-04-084.png!
 
Denne peker videre til:
utviklerkonferanse-2018/epsg6173.md at master · nvdb-vegdata/utviklerkonferanse-2018 · GitHub
 
Anbefaling for NVDB: EPSG-kode 6173: EUREF1989UTM33 og høydereferanse NN1954. Det foretas ingen tids- og/eller stedsavhengig koordinattransformasjon av data med antatt dårlig nøyaktighet til/fra WGS1984 ved lesing eller skriving til NVDB. I løpet av 2018 har alle norske kommuner gått over til det nye høydereferansesystemet NN2000. NN2000 vil tas i bruk som høydereferanse for NVDB innen 2020. Da vil EPSG-koden igjen endres.
 
Er dette litt utdatert?",NVDB-6937,Les-API,
Ta med NVDB søkedato i metadata-delen av rapportene,"Når jeg som entreprenør eller driftskontrakt-ansvarlig tar ut vegnettsrapport, V2, V3, V4 eller tilstandsrapport ønsker jeg å se hvilken dato jeg brukte i søket mitt. I dag ser jeg kun ""Utskriftsdato"", som angir når jeg latet ned data. ",,Rapportgenerator,
Nøyaktighet er satt til -1 i NVDB,Hva er omfanget?,NVDB-6937,Datafangst,
Ikke overskriv prosjektreferanse dersom det eksisterer,"Ønske om at refferanse-ID ikkje vert overskrive dersom det er deffinert eigen refferanse-ID på objektet i data-fanen.

!image-2021-03-25-12-38-23-184.png!
h2. Alternativ løysing:

Bytt ut dagens avhuking med radioknappar:
 * (Default) Fyll inn prosjektreferanse for objekt som ikke har det i kontrakten:
 * Overskriv prosjektreferanse på alle objekt:
 * Ikke oppdater prosjektreferanse.

[innput-felt med prosjektets referanse-ID som default]
h2. Tileggsendring:

Dersom prosjektreferanse oppdaterast ved innsending til NVDB, kan original ID stå igjen i datafanene så den evt. kan korrigerast tilbake i NVDB ved feilregistrering?

 
h2. Analyse

Referanse-ID fra innstillingsfanen legger seg som default i feltet hvor man kan velge referanse-ID ved innsending til NVDB.

Skriver man inn prosjektreferanse i eksport-fanen vil denne overskrive prosjektreferanse i datafanen for alle innsendte objekter og Prosjektreferanse i NVDB, men ikke referanse-ID i kontrakta.

 
h2. Løsning

Valgte å ikke gå for alternativ løsning, siden det vil innebære endringer i Angular. Angular har jeg lite erfaring med og det vil føre til mer teknisk gjeld.

Har endret sånn at kun vegobjekter som ikke har noen prosjektreferanse i datafanen som får ny prosjektreferanse valgt i eksportfanen/innstillingsfanen. Det vil si at vegobjekter som blir importert fra vegkart og som allerede har en prosjektreferanse vil ikke få ny prosjektreferanse. Hvis man vil ha ny prosjektreferanse på de må man bruke datafanen. Vegobjekter der man manuelt har valgt prosjektreferanse vil heller ikke få overskrevet denne. Dersom vegobjekter skulle ha ""tom"" prosjektreferanse, altså at det finnes et prosjektreferanse-attributt i databasen, men at det inneholder en tom streng eller bare whitespace vil det bli overskrevet.

Funksjonen i backend er skrevet på en generell måte sånn at det vil være enkelt å legge til overskriv-alle-prosjektreferanser-alternativ i frontend senere.

Tilleggsendringen er ikke implementert.",NVDB-6937,Datafangst,
Problemer med pålogging av EXTERNAL,"*Bakgrunn*

Olav Dahl Solstad Mar 02 15:20
 Vi er flere som sliter litt med å komme inn på kontrollpanelet. Noen får ""Unauthorized"" når man prøver å gå dit, mens andre får opp en side der man kan velge ""Ekstern bruker"" og automatisk blir logget inn som ""anonymous-external""

 

Olav Dahl Solstad Mar 12 10:23

Kom over den ""gamle"" urlen til kontrollpanelet - [https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel]  - og der får man til å logge inn med ekstern bruker

*Analyse*

*Unauthorized* kommer av utdatert IPlanetory-token som ligger i coockies og en wipe vil fjerne dette. Dette kommer av bruk av AAA-tjenesten. Denne funksjonalitet vil opphøre i nær framtid.

 

*anonymous-external* kommer ved at bruker trykker på Ekstern innlogging og fører til automatisk redirect til kontrollpanelet som *ANONYMOUS-EXTERNAL*.

 

TOKEN: eyJ0eXAiOiJKV1QiLCJ6aXAiOiJOT05FIiwia2lkIjoicTJIT3o5TlNka0wvYlRIT0EzRVp0NmxQb3BjPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJhbm9ueW1vdXMtZXh0ZXJuYWwiLCJjdHMiOiJPQVVUSDJfU1RBVEVMRVNTX0dSQU5UIiwiYXV0aF9sZXZlbCI6MCwiYXVkaXRUcmFja2luZ0lkIjoiYjJmYjY2N2QtN2M3OC00NTdkLTkzOTMtMDZjYTYwNTFiMTQ2LTExNzAzODQ0NTAiLCJpc3MiOiJodHRwczovL3d3dy52ZWd2ZXNlbi5ubzo0NDMvb3BlbmFtL29hdXRoMi9yZWFsbXMvcm9vdC9yZWFsbXMvRXh0ZXJuYWwiLCJ0b2tlbk5hbWUiOiJhY2Nlc3NfdG9rZW4iLCJ0b2tlbl90eXBlIjoiQmVhcmVyIiwiYXV0aEdyYW50SWQiOiJMUEFKN2hfNW9RT3NTSzFwNWp4cENPbmg5NG8iLCJub25jZSI6IjZkMmFjYTgxMmFhNDQyMTU5ZWZhN2Y4M2Y2MzJmOTU3IiwiYXVkIjoiT0F1dGgyX252ZGJhcGlza3JpdiIsIm5iZiI6MTYxNjE2NTQyOSwiZ3JhbnRfdHlwZSI6InRva2VuIiwic2NvcGUiOlsic3Z2cHJvZmlsZSIsIm9wZW5pZCJdLCJhdXRoX3RpbWUiOjE2MTYxNjU0MjksInJlYWxtIjoiL0V4dGVybmFsIiwiZXhwIjoxNjE2MTk0MjI5LCJpYXQiOjE2MTYxNjU0MjksImV4cGlyZXNfaW4iOjI4ODAwLCJqdGkiOiJ5WV9tQ2Q1Q3gzWlpDUGVXNUJ3VFc1OUsxMFEifQ.ngfj-Q0zKunpuFAUtWqDOfvzIjTlvGYugx6NXaYX5weTauKzoejywtwTid6dtA8bbgNSaMyYqzEmL5A9T6vPXllWksZtiFoBEDCGVpyI4RFA_cFKgHX-QkSS_TkmJHCqYdGKUiFmrBOrQ6TcnBTFwI9hNXfprZ3-gdEivlET_A1scaJlAYGzUTPwoNTlwY8qRS9djx6W7lEVb86Gw9GJy1UMzjI474l4gJMiX-VnwErD6G7iOnwwRETBQfau5cqHj8-UMp_ZxxGimGRTtXXV-k8Rs04PimaL7Klr3XnKOSpgLQfc0X51-9HQIYnGLXwR1k00As6p0MbILMv47Psalw

 

Blir automatisk lagt til i URL.

Denne har informasjonen: 

{ ""sub"": ""anonymous-external"", ""cts"": ""OAUTH2_STATELESS_GRANT"", ""auth_level"": 0, ""auditTrackingId"": ""b2fb667d-7c78-457d-9393-06ca6051b146-1170384450"", ""iss"": ""https://www.vegvesen.no:443/openam/oauth2/realms/root/realms/External"", ""tokenName"": ""access_token"", ""token_type"": ""Bearer"", ""authGrantId"": ""LPAJ7h_5oQOsSK1p5jxpCOnh94o"", ""nonce"": ""6d2aca812aa442159efa7f83f632f957"", ""aud"": ""OAuth2_nvdbapiskriv"", ""nbf"": 1616165429, ""grant_type"": ""token"", ""scope"": [ ""svvprofile"", ""openid"" ], ""auth_time"": 1616165429, ""realm"": ""/External"", ""exp"": 1616194229, ""iat"": 1616165429, ""expires_in"": 28800, ""jti"": ""yY_mCd5Cx3ZZCPeW5BwTW59K10Q"" }

 

Har lokalisert hvor OIDC blir handert i Skriv. Kommer til å gjennomføre debugging for å finne rotårsaken automatisk redirect uten at bruker har fårr skrevet inn brukernavn og passord.

 

 

 ",NVDB-6937,Skriv-API,
Flere filtreringsmuligheter,"Inn fra support:  [tina.vestersager@vegvesen.no|mailto:support%C2%A0tina.vestersager@vegvesen.no] 

For fartsgrense filteret ønsker vi at man kan velge «mindre enn» og «større enn». Nå er det kun «lik» og «ulik». Det er behov for å se vei med fartsgrense til og med 50km og tilsvarende fra og med 60km og høyere.  

 

Legge til filtrering på ""større enn"" og ""mindre enn""

 

Kontakt [tina.vestersager@vegvesen.no|mailto:Kontakt%C2%A0tina.vestersager@vegvesen.no] for å sjekke om ny filtrering dekker behovet. 

 ",NVDB-6937,Vegkart,
Endre navn på kontraktgruppe,"Ønsker å endre navnet på «Drift og vedlikehold vest» til «SVV Drift og vedlikehold vest».

Jan Vidar Strømsvold <jan.vidar.stromsvold@vegvesen.no>",NVDB-6938,Datafangst,
"Bekreft-knapp ved ""oppdater alle"" i datafanen","Legg til knapp for å bekrefte likt med fjern fra kontrakt vd kopiering av eigenskap til alle objekt i Datafanen.

!image-2021-03-18-09-56-03-027.png!",NVDB-6937,Datafangst,
"Feil i visrute ""zoom til geometri""","Vi forsøkte å finne denne veglenka* i kart ved å hente ut geometrien** og bruke zoom til geometri i visrute***. Den tar oss derimot til helt feil sted på kartet.

Det korrekte område kan sees her****. Denne veglenkesekvensen er også synelig i visrute om man navigerer dit manuelt.


{code:java}

* https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/1753933

** LINESTRING Z(-25730.63 6756565.13 8.112, -25718.3598632813 6756547.38964844 7.912, -25699.2202148438 6756524.37988281 7.712, -25681.3901367188 6756505.71972656 7.512, -25659.702 6756484.302 7.312)

*** https://nvdb-vegdata.github.io/nvdb-visrute/PROD/

**** https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-25663,6756510,15/hvor:~(vegsystemreferanse~(~'EV39S73D129M10))/vegnett:~'geometri+~()/valgt:1753933:5:9

{code}
",NVDB-6937,Les-API,
Support: Feil i json format,"""Hi there!
Recently got an exception by using nvdb-api-client v.1.15:
Caused by: java.lang.RuntimeException: Error processing""



""BRUTUS heavily uses NVDB services through nvdb-api-client and now we noticed fails at critical synchronization jobs between 2 systems.
 
We use nvdb-api-client version 1.15
 
All environments, including PRODUCTION affected.""



""Below is the stack trace from Splunk logs (PROD), from recent errors at 2021-03-12T00:00:36,212+0100
 
no.vegvesen.nvdbapi.client.exceptions.ClientException: HTTP error 200 for request bfefa8ec-2d35-ecd1-5fe1-f58b7abdb7ce:
 
Caused by: java.lang.RuntimeException: Error processing 
...
{JSON payload}
...
at no.vegvesen.nvdbapi.client.gson.GsonUtil.lambda$rt$9(GsonUtil.java:231) at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193) at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193) at java.util.ArrayList$Itr.forEachRemaining(ArrayList.java:901) at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801) at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482) at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472) at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708) at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566) at no.vegvesen.nvdbapi.client.clients.GenericResultSet.next(GenericResultSet.java:144) ... 13 common frames omitted Caused by: java.lang.IllegalArgumentException: *+navn did not contain a string.+* at no.vegvesen.nvdbapi.client.gson.GsonUtil.parseStringMember(GsonUtil.java:83) at no.vegvesen.nvdbapi.client.gson.RoadObjectParser.lambda$parseStreets$3(RoadObjectParser.java:219) at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193) at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193) at java.util.ArrayList$Itr.forEachRemaining(ArrayList.java:901) at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801) at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482) at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472) at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708) at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566) at no.vegvesen.nvdbapi.client.gson.RoadObjectParser.parseStreets(RoadObjectParser.java:220) at no.vegvesen.nvdbapi.client.gson.RoadObjectParser.parseLocation(RoadObjectParser.java:173) at no.vegvesen.nvdbapi.client.gson.RoadObjectParser.lambda$parse$0(RoadObjectParser.java:115) at java.util.Optional.map(Optional.java:215) at no.vegvesen.nvdbapi.client.gson.RoadObjectParser.parse(RoadObjectParser.java:115) at no.vegvesen.nvdbapi.client.gson.GsonUtil.lambda$rt$9(GsonUtil.java:229) ... 23 common frames omitted""

",NVDB-6937,Les-API,
Regelmessige møter 2021,"Oppgave for kontinuerlig føring av timer for regelmessige møter i 2021. Alle i teamet kan føre timer på denne.

Eksempler
 * Daglige standups (åpne vegdata, forvaltning, NVDB team daglig møteplass)
 * Grooming møter for alle produktene
 * Retrospektiv",NVDB-6940,,
Slette kontraktgruppe,"Ønsker å få fjernet kontraktsgruppen «Driftskontrakter region vest»,

Jan Vidar Strømsvold <jan.vidar.stromsvold@vegvesen.no>",NVDB-6938,Datafangst,
Bruke navn i feilmelding om at objektet ikke har stedfesting som fullstendig dekkes av mor,"Eksempel på feilmelding vi får når et datterobjekt sin stedfesting ikke er fullstendig dekket av morobjektet:

Skiltplate (12-1-2021 10:40:45): Objektet har ikke stedfesting som fullstendig dekkes av morobjekt av type Skiltpunkt (95): tempId 08c6e9d7-aa5a-4019-ada4-420ff512ee12

Hvis mor ikke er i NVDB fra før får vi tilbake denne tempIden. Da kan ikke brukerne vite hvilket objekt det er snakk om. Denne brukes i datafangst kun for å ha en id i databasen. Går det an å bruke navn/alias istedenfor sånn som på datterobjektet?

!image-2021-03-11-15-10-41-789.png!",NVDB-6937,Skriv-API,
Endring av verdi i datafanen funker ikke,"Legge til verdier på enkelte vegobjekter feiler.

Fikk supportmail om at de ikke klarer å legge inn verdier på to vegobjekter. Det gjelder de som er markert med feil på bildet.

Prøvde selv og fikk det ikke til jeg heller. Prøvde å sette inn oppsettingsdato og endre på skiltnummer.

!image-2021-03-11-12-23-36-185.png!

 

 
h3. Hvordan reprodusere

Last inn vegobjekter som korriger: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/96?segmentering=true&kartutsnitt=-49702.214%2C6622999.058%2C-49417.786%2C6623108.942&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Endre verdien på skiltnummer på Skiltplate:745372148. Du vil få feil

 
h3. Analyse

Koden krasjer på linje 134 i AttributeAutoCorrector
{code:java}
String value = fa.getValue().trim();
{code}
fordi fa.getValue() er lik null.



Det er verdien på attributtet ""Tekst"" som er satt til null. Attributter som er tomme pleier egentlig ikke å ligge i datafangst-databasen i det hele tatt. Denne blir lest også når andre attributter blir oppdatert. Da krasjer koden, man får feilmelding og ønskede attributter blir ikke oppdatert.

Verdien av tekstfeltet kan derimot endres. Da kan man løse problemet enkelt ved å legge på tekst og fjerne den etterpå.

Objektet sånn det ser ut fra LES:

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/96/745372148/1]

Da ser egenskapstypen slik ut:
<egenskap>
<id>1910</id>
<navn>Tekst</navn>
<egenskapstype>Tekst</egenskapstype>
<datatype>Tekst</datatype>
</egenskap>
 
Den mangler verdi. Skal datafangst kunne håndtere dette eller er det en feil i NVDB?",NVDB-6937,Datafangst,
SOSI-eksport av leverte data,"I dag kan data under behandling eksporterast til SOSI i Eksport-fanen, men så snart det er levert til NVDB er det ikkje mogleg lenger. Det er ønske om å kunne eksportere leverte data og, til dømes for vidare import for leveranse til FKB.

 

Slik det er i dag må det være endring på et objekt av vegobjekttypen for at en skal kunne laste ned sosi-fil.

En supportsak fra Olav Løberg:

Han ønsker å kunne laste ned Sosi fra FKB filen i eksportfanen men dette er ikke mulig.",NVDB-6937,Datafangst,
580-Kontraktområde mangler vegsegmenter,"I SINUS infra er vi nå i test med det nye opplegget for å opprette/redigere/slette objekter med mange stedfestinger (vegsystemreferanser). Vi har bla. brukt Vinterdriftsklasse i vår testing og det fungerer nå fint med svært mange stedfestinger.

Når vi går løs på kontraktsområder ser denne objekttypen veldig annerledes ut enn «normale» objekttyper i Datakatalogen/NVDB. Derfor har vi noen spørsmål om Kontraktsområde (580).

Eksempel fra V3-Les-Test: [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/580/316720625/1.json?inkluder=alle]

Hvorfor mangler vegsegmenter for objekter av typen kontraktsområde (580)? Vårt opplegg for å håndtere sånne store objekter er avhengig av vegsegmentene for å kunne håndtere koblingen mellom veglenkene og stedfestingen. Endrer brukeren på en stedfesting må vi vite hvilke veglenker dette påvirker.

Er det spesiell behandling av 580 sammenlignet med 810 i Les/IND

Sigmund Fredriksen <Sigmund.Fredriksen@triona.no>",NVDB-6937,Les-API,
Fikse feilmeldinger i gradle tasks,"Flere javadoc-relaterte gradle tasks spytter ut feilmeldinger under bygging. Dette er generelt enkle feil som omhandler å definere parametere og returtyper. I tillegg kan gradle-versjonen fint oppdateres, som mulig medfører enkle endringer. Dette ble sist gjort 16.10.2020.
{quote}[NVDB Reader » master #1222 Console [Jenkins]|http://svvunvdbbuild02:8080/jenkins/view/NVDB%20API%20Les/job/NVDB%20Reader/job/master/1222/console]
 ...
 /var/opt/vegdata/jenkins_home/workspace/NVDB_Reader_master/modules/nvdbind-cache/src/main/java/no/vegvesen/nvdbind/cache/h2/RoadSystemSectionLookup.java:94: warning: no @param for period
 public List<RoadSystemSection> getByPosition(long nid, double pos, Period period) {
 ...
{quote}

 Det ble tidligere diskutert om javadocs skal fjernes helt, men med tanke på at vi allerede har en god del implementasjoner av det i koden, synes jeg det skal videreføres. I tillegg er dette en måte å få bedre kontroll på koden nå i startfasen av overtagelsen.",NVDB-6938,NVDB-IND,
Fikse feilmeldinger i gradle tasks,"Javadoc-tasks, blant annet, gir flere feilmeldinger under bygging, se f.eks siste kjøring:

[NVDB Reader » master #1222 Console [Jenkins]|http://svvunvdbbuild02:8080/jenkins/view/NVDB%20API%20Les/job/NVDB%20Reader/job/master/1222/console]
...
/var/opt/vegdata/jenkins_home/workspace/NVDB_Reader_master/modules/nvdbind-cache/src/main/java/no/vegvesen/nvdbind/cache/h2/RoadSystemSectionLookup.java:94: warning: no @param for period
    public List<RoadSystemSection> getByPosition(long nid, double pos, Period period) {
...",,,
Riksvegrute overlapp med versjon -1337,"Under full reindeksering på fredag dukket det opp mange feil som gikk på overlapp av riksvegruter i sammenheng med segmentering. Alle listede riksvegruter har versjon -1337, som er ganske mystisk. Denne verdien er typisk brukt som en dummyverdi.

Eksempel:
{code:java}
2021-03-05 16:19:12 [segmenter (02)] ERROR NetComponentBuilder - Error segmenting RefLinkPart(3, MAIN, 0.01755057 - 0.97915625@2522155) by [ConnectedRoute{id=495608796, version=-1337, netelemid=2522155, startPos=0.01755057, endPos=0.97915625, startDate=2015-05-27, endDate=null}, ConnectedRoute{id=495608796, version=-1337, netelemid=2522155, startPos=0.01755057, endPos=0.97915625, startDate=2021-01-01, endDate=null}] caused by overlap detected: ConnectedRoute{id=495608796, version=-1337, netelemid=2522155, startPos=0.01755057, endPos=0.97915625, startDate=2015-05-27, endDate=null} and ConnectedRoute{id=495608796, version=-1337, netelemid=2522155, startPos=0.01755057, endPos=0.97915625, startDate=2021-01-01, endDate=null}
{code}
",NVDB-6937,Les-API,
Prosjekt EPIC - For alle oppgaver relatert til Administrasjon NVDB,,,,
Prosjekt EPIC - For alle oppgaver relatert til Beredskap NVDB,,,,
Prosjekt EPIC - For alle oppgaver relatert til Utvikling NVDB,,,,
Prosjekt EPIC - For alle oppgaver relatert til Forvaltning NVDB,,,,
Mer brukervennlig feilmelding ved stedfesting på veglenkesekvens som ikke er gyldig i hele objektets gyldighetsperiode,"Lurer på om det er mulig å forbedre feilmeldingen som kommer når man sender inn objekt som er stedfestet på veglenkesekvens som er lukket.

Eksempel på feilmelding man kan få:

85346722: Vegobjektet er stedfestet på segment [0.38149528, 0.38149528] av veglenkesekvens 72155, som ikke er gyldig i hele vegobjektets gyldighetsperiode: 1950-01-01 - >


Denne var vanskelig å forstå for meg. Først trodde jeg ""1950-01-01 - >"" var gyldighetsperioden til veglenkesekvensen.


Er det relevant hvor på veglenkesekvensen vegobjektet er stedfestet? Denne informasjonen tror jeg gjør det vanskeligere å forstå hva feilmeldingen sier. Jeg blir dobbelt-forrvirra når dette er et punkt, skrevet som om det skulle hatt utstrekning. Som i eksempelet: ""[0.38149528, 0.38149528]"".


Jeg synes heller ikke det er åpenbart at 85346722 er vegobjektet som gjør at endringssettet feiler.


Min drømme-tilbakemelding hadde kanskje vært noe sånt som ""Vegobjektet 85346722 kunne ikke sendes inn til NVDB fordi det er stedfestet på en veglenkesekvens som ikke er gyldig i hele vegobjektets gyldighetsperiode. Veglenkesekvensen 72155 er gyldig fra og med 01.01.1950 til 01.01.2009. Vegobjektet er gyldig fra og med 01.01.1950 og fram til det oppdateres eller lukkes.""",NVDB-6937,Skriv-API,
Leveranseinformasjon,"*Testes av SVV:*
 * NVDB-6455 -Legg til bruker: Sjekk at en kan søke på brukere som ikke er i kontrakten. (se kommentarer)
 * NVDB-6476 -Sjekk  at spinner i chrome (når du laster inn datafangst kontrakt eller lignende) er i høyere oppløsning enn før (se skjermdump)
 * NVDB-6480 -Sjekk at en kan navigere i dataen med piltastene i datagriden og merket celle vises i vinduet (i en kontrakt med mange vegobjekter)
 * NVDB-6481 -Sjekk at ""gyldig fra data"" er fjernet fra modalt vindu ved nedlastning av SOSI-fil (export)
 * NVDB-6511 -Sjekk stavefeil ""Gjenomføres"" er rettet opp ved feilmelding i datafangst.
 * NVDB-6532 -Sjekk i sammenkoblingsfanen at egenskaper vises på en linje, ikke brekker ved listeverdier og har annenhver hvit og grå linje.
 * NVDB-6899 -Sjekk at en kontraktsgruppe har en ""gul boks""  som vises når ingen kontrakt er lagt til og en ""gul boks"" når de ingen brukere er lagt til.  Sjekk også at disse fjernes og blir lagt til dersom en fjerner/legger til brukere i kontrakten
 * NVDB-6541 -Sjekk at en får samme stedfesting ved kopiering av vegobjekt. Sjekk også at ny dialogboks vises ved kopiering til ny objekttype (fortsatt samme stedfesting men uten egenskaper).
 * NVDB-6894 -Verifiser at changeloggen viser riktig dato til release. (sjekk ATM nå) og at den settes riktig i prod ved release.
 * NVDB-6891 -Sjekk at fanemenyen på venstre side ikke blir deaktivert(grået ut) når en har vegobjekter i kontrakten.  NB: Denne fikser ikke hele problemet. Vi ser etter en måte å få reprodusert denne på.
 * NVDB-6535 -Sjekk at en får beskjed om mor/datterobjekt må registreres inn i samme endringssett

I denne versjonen oppdaterer vi blant annet Java, NPM pakker og SQL DSL-bibliotek. Test grundig at flyt( i datafangst funker som normalt.

*Testes av leverandør:*
 * NVDB-6533 -Sjekk i console at riktig kall sendes ved sammenkobling til mor i NVDB (2 GET og to OPTIONS)
 * NVDB-6516 -Sjekk at godkjenning av innsendt stedfesting ikke gir dirty vegobjekt.
 * NVDB-6517 -Sjekk at innsending med dirty ute av sync gir systemfeil.
 NVDB-6906 - Sjekk at en ikke får konsollfeil om ikke-unik ID til barna i kontrakten.

*Saker som ikke teste manuelt i ATM:* 
* NVDB-6914 -Oppgradere Java avhengigheter
* NVDB-6548 -Ta i bruk oppdaterte SQL DSL bibliotek
* NVDB-6518 - Oppgradere NPM pakker
Sjekk at flyt fungerer som normalt",NVDB-6937,Datafangst,
Kartlegge erstatning av Makroer i Klassisk,"Klassisk har enkelte makroar for å berekne verdiar basert på andre data i NVDB.

[~hansal] kan oppdatere kva for makroar som finst i Klassisk ut over Skredpunkt?

Kartlegge dokumentasjon av desse makroane.
 # Skaffe oversikt over makro
 # Beskrive funksjon
 # Vurdere om funksjon skal vedareførast

I tillegg vurdere implementasjon.
 * Gensesnitt i skriv
 * Eget kontrollpanel

Duplikat fra NVDB-2827

Tilsvarende makeNextPass i Klassisk NVDB.

Dokumentasjon fra API Skriv sitt utviklingsprosjekt:

Fra Tor Storruste, Triona;

Det finnes et opplegg som genererer statistikkobjekter basert på innsjekkede data. Jeg klipper inn fra systemdokumentasjonen:
«Statistikktjenesten er en tjeneste som finnes på server, og som har til hensikt å generere statistikk ut fra predefinerte statistikkdefinisjoner og en eksekvert task.
Nye og/eller endrede objekt som er sjekket inn gjennom eksekvert task blir krysset mot de predefinerte statistikkdefinisjonene, og dersom disse objektene medfører endringer i statistikken vil tidligere statistikk slettes, og ny statistikk beregnet, hvor det er behov for dette.»
Det som skjer er at når fagdataredigeringsoppdrag sjekkes inn til serveren, kontrolleres det om noen av de berørte fagdatatypene er aktuelle for de avledete typene. Det vil si at om fagdatatypen 540 (trafikkmengde) oppdateres, vil det være aktuelt å regenerere statistikkobjekter for type 643 (Statistikk, trafikkmengde). Det opprettes da en task som settes til å utføres i fremtiden hvor regenerering av aktuelle statistikkobjekter skjer. Denne tasken plukkes opp av et program på serveren som heter ScheduledTaskExecutor. Den spør databasen med jevne mellomrom om det er noen oppgaver som skal utføres, og utfører alle den finner. Så venter den en liten stund før den prøver igjen.
Selve genereringen av statistikkdata skjer i en C++-tjeneste på serveren. Den henter ut de aktuelle «kildeobjektene», utfører beregninger og genererer avledete objekter.
Hvor-delen i oppgaven hentes fra hvor-delen i fagdataredigeringsoppdraget som ble sjekket inn. Hva som skal gjøres hentes fra hvilke objekttyper som ble sjekket inn. Funksjonaliteten som bygger opp oppgavene som skal utføres ligger definitivt utenfor databasen, men for å fortelle nøyaktig hvor må jeg eventuelt lete det frem i kildekoden, da jeg ikke har jobbet med dette selv. Antageligvis ligger funksjonaliteten et sted i C++-koden på serversiden.
Jeg forhørte meg litt rundt for å være sikker på at det ikke er noen del av systemet jeg ikke har vært borte i som gjør det. Så langt jeg har funnet ut, blir ikke andre objekt-/egenskapstyper enn statistikktypene oppdatert automatisk. Andre avledete objekt-/egenskapstyper blir altså ikke gjort noe med.

Fra Eivind Nilsen, Triona:

Skredpunkt(824) har også egenskaper blir oppdatert automatisk..
Det laget regler for at Holdeplassutrustning(487) også skal oppdateres automatisk, men jeg er usikker på om dette er driftsatt eller om det testes av kunde.
En vesentlig forskjell mellom disse og statistikkobjektene, er at disse oppdateres, mens statistikkobjektene blir slettet og det blir opprettet nye.",NVDB-6937,Skriv-API,
"Tilstandsrapport fane ""Kommentar"" har vegreferanse i ""Beskrivelse""-feltet","Ved gjennomgang av tilstandsrapport fant vi ut at fanen ""297 - *Kommentar*"" -Dokumentasjon-"" (EDIT: Feil objekttypenavn) har vegreferanser i fanen ""Beskrivelse"", i stedet for egenskapverdier hentet fra 297-objektet. 

Eksempel: For k.området 9305 Sunnfjord 2021-2026 så har objektet 78782429 egenskapverdien _Beskrivelse = Utløp i fjorden,_ men i tilstandsrapporten så står det _Beskrivelse=RV5KS4D30M2400_. 

Mistenker at dette er navnekollisjon med kode vi eksperimenterte med i fjor, hvor vi sammenfattet vegreferansen på denne måten i feltet ""Beskrivelse"". Slik sett kan dette problemet gjelde alle objekttyper med egenskapsnavn ""Beskrivelse"". ",NVDB-6827,Rapportgenerator,
Endepunkt /vegnett/veglenkesekvenser/segmentert mangler data,"Hei,
 
I forbindelse med TNE3 henter jeg hver natt ned data far /vegnett/veglenkesekvenser/segmentert
(https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?historisk=true?antall=500)
 
Jeg opplever at jeg mangler data når jeg sammenstiller resultatet i TNE3 i etterkant, mangler data for noen lenker. Jeg trenger derfor å vite hvordan endepunktet fungerer. 
 
Er dataene alltid komplette? Gis det alltid data for alle lenker som finnes i NVDB, eller det etterslep i segmenteringen som gis?
 
Startet f.eks uthenting:
 
2021-02-19 12:47:23,405 INFO NvdbExporter - X-Client-Session for job: a8b9a6ee-d379-45d0-bf4b-a0802944fbc0
 
Dette er jo en jobb som bruker over to timer, henter 500 stk. i «deler»:
 
2021-02-19 12:47:23,998 INFO NvdbExporter - Call to https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?historisk=true?antall=500 completed in 0,4843819. Status of result was Ok
2021-02-19 12:47:24,342 INFO NvdbExporter - Call to https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?historisk=true%3Fantall=500&start=A5421GTyTMu2rgs7ithAWd9zo2CUAdoErEsjwRwqvY7hRMTezzmMzXL8Vgm4ADnVyuDRXpVtAbCGb42ajFAzHiFapKks5SXCqpHqcdf3LuGBPqqHeVaTMsvcLtPwqnPfgh8Zmpa53vkubrtJrk8bS7FpvzqnapocBqtp completed in 0,3437409. Status of result was Ok
2021-02-19 12:47:24,673 INFO NvdbExporter - Call to https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?historisk=true%3Fantall=500&start=A5421GTyTMu2rgs7ithAWfQVpsifBsD3hrj4dyDFPMfKxT4uZddygmeHnhxrmM62akW6hKoWdodnxFkP1oz7SciuEVJ74wxxgpZ8jjyN8wS1fNXosFc3Ap15TX6sCjK4cFZAQAVzRm5Gp9JzpXAk9E5FUNoqL9X5FScU completed in 0,3306551. Status of result was Ok
2021-02-19 12:47:25,001 INFO NvdbExporter - Call to https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?historisk=true%3Fantall=500&start=A5421GTyTMu2rgs7ithAWimYHpavdw3pWgY9xVEAy9hxqEDUoihsPt8rqNjSMoEvcRcfDyAhoLj4ABsWuM5gBsYNEkK12sBv78CaDB3nRs6GWKZtfE7G7Cxj8cEwpRLQbtV4J3EkidKtD15cqjCSa8zbVH7T3P6umsR6 completed in 0,3281186. Status of result was Ok
.
.
.
.
Er det da datene som var i endepunket 2021-02-19 12:47:23,405 som vil bli gitt ut? Hvordan fanges eventuelt opp data endringer som inntreffer i tidsrommet jobben med å hentet data tar?
 
Ser også at jeg fanger opp, det som oppfattes som dataavvik av TNE3:
2021-02-19 15:01:23,386 INFO NvdbExporter - Segmented network part with id 3243697, linknumber 8, segmentnumber 5 has no section, crossroadsystem or sidesystem. Removing from import
2021-02-19 15:01:23,386 INFO NvdbExporter - Segmented network part with id 3243697, linknumber 9, segmentnumber 5 has no section, crossroadsystem or sidesystem. Removing from import
2021-02-19 15:01:23,386 INFO NvdbExporter - Segmented network part with id 3243697, linknumber 10, segmentnumber 5 has no section, crossroadsystem or sidesystem. Removing from import
 
Hvordan betrakter NVDB «has no section, crossroadsystem or sidesystem"" er det tillatt? 
 
 
Mvh. Ole Johs.",NVDB-6937,Les-API,
Oppdatere DaKatLite,"Datakatalogen Lite ([Nasjonal vegdatabank Datakatalog|https://datakatalogen.vegdata.no/]) er basert på v2 og delar av funksjonaliteten er alt ute av drift. Den må oppdaterast og endrast til v3.

Ser to alternativ her:
 # Oppdatere dagens produkt til v3 og reparere knekt funksjonalitet
 # Utvikle ny versjon basert på DaKat i Vegkart.

!image-2021-02-26-09-43-37-377.png!!image-2021-02-26-09-44-12-604.png!",NVDB-6937,Vegkart,
Kaskadefjerning av morobjekt fjerner ikke datterobjekt,"h2. Observasjon

Sigmund Fredriksen (Trion/Sinus) spør: Vi har et spørsmål om sletting av «ikke-tidsromrelevante» objekter, som f.eks. trafikkulykke. Pr. i dag har vi bare LUKK med angivelse av lukkedato i SINUS infra. For «ikke-tidsromrelevante» objekttyper antar vi at FJERN skal brukes, og vi bruker KASKADEFJERNING PÅ.

{code:json}
{
  ""fjern"": {
    ""vegobjekter"": [
      {
        ""kaskadefjerning"": ""JA"",
        ""typeId"": 570,
        ""nvdbId"": 85174545,
        ""versjon"": 1
      }
    ]
  },
  ""status"": {
    ""mottatt"": ""2021-02-17T08:38:03.226"",
    ""fremdrift"": ""AVVIST"",
    ""fremdriftOppdatert"": ""2021-02-17T08:38:12.76"",
    ""kanselleringBestilt"": false,
    ""avvistårsak"": ""VALIDERINGSFEIL"",
    ""eier"": ""sigmfred"",
    ""klient"": ""NVDB API Skriv Generator"",
    ""apiversjon"": ""3"",
    ""transaksjon"": {},
    ""ressurser"": [
      {
        ""rel"": ""endringssett"",
        ""src"": ""https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/8e4789e5-3cbf-4f78-9495-8fec680b69b2""
      },
      {
        ""rel"": ""self"",
        ""src"": ""https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/8e4789e5-3cbf-4f78-9495-8fec680b69b2/status""
      }
    ]
  },
  ""datakatalogversjon"": ""2.23"",
  ""id"": ""8e4789e5-3cbf-4f78-9495-8fec680b69b2""
}]]>
{code}

Type	Kode	Melding
  Feil	MANGLER MOROBJEKT	Objektet er av en type som krever morobjekt, men det har ingen: VEGOBJEKTTYPE=571; ID=85174546; VERSJON=1; STARTDATO=1996-09-10; SLUTTDATO=null

Varsler for vegobjekter
Feil (1)
Id	Operasjon	Type	Kode	Melding
85174545:1	Fjern	  Feil	DATTEROBJEKT UTEN MOR	Objektet har et datterobjekt som også må lukkes: Datterobjekt av type 571, id 85174546, versjon 1 har gyldighet etter morobjektets sluttdato 1996-09-10

Er dette en feil i SKRIV?",NVDB-6937,Skriv-API,
Systemfeil: ORA-01795: maximum number of expressions in a list is 1000,"h2. Bakgrunn

Følgende feilmelding kom på e-post fra en superbruker. Jeg har fortalt ham at dette er en begrensning som gjelder alle miljøer. Han ønsker egentlig muligheten for større endringssett.

Hvordan kan vi hjelpe ham? Feilen bør i det minste håndteres bedre.

Hei Hans Anton!

Jeg har i det siste jobbet med å lage ei løype som tar for seg alle lenker og noder innenfor en kommune, og tildeler alle oppdatert Z-verdi. Løype henter inn vegnettet fra STM og draperes over på en høydemodell, slik at vegnettet blir da mest mulig korrekt i 3D, uten at en gjør noen endring i XY-grunnrisset.

Løypa fungerer enkelt forklart slikt:

Henter lenkesekvenser og noder fra nvdbapiles-v3-stm.utv – filtrerer ut historiske lenker og lenker med medium + noder i mellom. Sender alle lenker og noder gjennom en draperingsfunksjon for å høste inn Z-verdi fra høydemodellen. Håndterer historikk i noder som får oppdatert z-verdi ved å kun oppdatere koordinat knyttet inn til disse nodene. Likeså skjer i lenker med medium at koordinatene inn mot disse nodene blir uberørt.

Jeg måtte opprette en lås. Dette ble gjort i Quadri ved å kun bruke kommunen som søkekriterier, uten noen objekter:

[https://nvdbapiskriv-stm.utv.atlas.vegvesen.no/kontrollpanel/#/locks/view/18568604]

Denne testen jeg prøvde på nå, utspillet seg på Randaberg kommune 1127, hvor jeg fant totalt 2954 noder og 1732 lenkesekvenser med 3968 lenker ,som ble sydd sammen til et endringssett.

Forsøket kan ses her:

[https://nvdbapiskriv-stm.utv.atlas.vegvesen.no/kontrollpanel/#/jobs/view/d7fb5a37-6874-4cbd-bff4-2faeba0fc681]

Etter at all valideringskontroll og godkjenning ble utført, dukket det opp en systemfeil med en konkret melding:

Caused by: java.sql.SQLSyntaxErrorException: ORA-01795: maximum number of expressions in a list is 1000

Dette får jo meg til å lure på om det størrelse begrensning i STM? Er dette noe du justerer etter hvert som testing og slikt pågår?

Med hilsen
 Joakim Møyholm
 Mobil: +47 97090538

h2. Analyse

Hendelsesloggen for endringsettet:


{code:java}
no.vegvesen.vt.nvdb.apiskriv.api.exception.NvdbRepositoryException: Failed to execute JDBC update
	at no.vegvesen.vt.nvdb.apiskriv.api.exception.ApplicationException$Builder.build(ApplicationException.java:44)
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.NvdbExecutors.executeUpdate(NvdbExecutors.java:70)
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.NvdbExecutors.executeUpdate(NvdbExecutors.java:22)
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.JdbcAreaLocationRepository.removeForRefLinkNvdbId(JdbcAreaLocationRepository.java:41)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.NvdbTransactionWriter.updateAreaLocations(NvdbTransactionWriter.java:371)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.NvdbTransactionWriter.writeJob(NvdbTransactionWriter.java:145)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$24(JobWorker.java:766)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:110)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:109)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:105)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$updateNvdb$25(JobWorker.java:764)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:110)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:109)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:105)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.updateNvdb(JobWorker.java:764)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$0(JobWorker.java:215)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.processJobAndRetryOnException(JobWorker.java:243)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$1(JobWorker.java:152)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:151)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.messageHandler(JobListener.java:60)
	at no.vegvesen.vt.nvdb.apiskriv.rabbitmqclient.RabbitMqSubscription.onMessage(RabbitMqSubscription.java:181)
Caused by: Error : 1795, Position : 6959, Sql = delete from nvdb.arealocations al where al.location.netelemid in (:1 , :2 , :3 , :4 , :5 , :6 , :7 , :8 , :9 , :10 , :11 , :12 , :13 , :14 , :15 , :16 , :17 , :18 , :19 , :20 , :21 , :22 , :23 , :24 , :25 , :26 , :27 , :28 , :29 , :30 , :31 , :32 , :33 , :34 , :35 , :36 , :37 , :38 , :39 , :40 , :41 , :42 , :43 , :44 , :45 , :46 , :47 , :48 , :49 , :50 , :51 , :52 , :53 , :54 , :55 , :56 , :57 , :58 , :59 , :60 , :61 , :62 , :63 , :64 , :65 , :66 , :67 , :68 , :69 , :70 , :71 , :72 , :73 , :74 , :75 , :76 , :77 , :78 , :79 , :80 , :81 , :82 , :83 , :84 , :85 , :86 , :87 , :88 , :89 , :90 , :91 , :92 , :93 , :94 , :95 , :96 , :97 , :98 , :99 , :100 , :101 , :102 , :103 , :104 , :105 , :106 , :107 , :108 , :109 , :110 , :111 , :112 , :113 , :114 , :115 , :116 , :117 , :118 , :119 , :120 , :121 , :122 , :123 , :124 , :125 , :126 , :127 , :128 , :129 , :130 , :131 , :132 , :133 , :134 , :135 , :136 , :137 , :138 , :139 , :140 , :141 , :142 , :143 , :144 , :145 , :146 , :147 , :148 , :149 , :150 , :151 , :152 , :153 , :154 , :155 , :156 , :157 , :158 , :159 , :160 , :161 , :162 , :163 , :164 , :165 , :166 , :167 , :168 , :169 , :170 , :171 , :172 , :173 , :174 , :175 , :176 , :177 , :178 , :179 , :180 , :181 , :182 , :183 , :184 , :185 , :186 , :187 , :188 , :189 , :190 , :191 , :192 , :193 , :194 , :195 , :196 , :197 , :198 , :199 , :200 , :201 , :202 , :203 , :204 , :205 , :206 , :207 , :208 , :209 , :210 , :211 , :212 , :213 , :214 , :215 , :216 , :217 , :218 , :219 , :220 , :221 , :222 , :223 , :224 , :225 , :226 , :227 , :228 , :229 , :230 , :231 , :232 , :233 , :234 , :235 , :236 , :237 , :238 , :239 , :240 , :241 , :242 , :243 , :244 , :245 , :246 , :247 , :248 , :249 , :250 , :251 , :252 , :253 , :254 , :255 , :256 , :257 , :258 , :259 , :260 , :261 , :262 , :263 , :264 , :265 , :266 , :267 , :268 , :269 , :270 , :271 , :272 , :273 , :274 , :275 , :276 , :277 , :278 , :279 , :280 , :281 , :282 , :283 , :284 , :285 , :286 , :287 , :288 , :289 , :290 , :291 , :292 , :293 , :294 , :295 , :296 , :297 , :298 , :299 , :300 , :301 , :302 , :303 , :304 , :305 , :306 , :307 , :308 , :309 , :310 , :311 , :312 , :313 , :314 , :315 , :316 , :317 , :318 , :319 , :320 , :321 , :322 , :323 , :324 , :325 , :326 , :327 , :328 , :329 , :330 , :331 , :332 , :333 , :334 , :335 , :336 , :337 , :338 , :339 , :340 , :341 , :342 , :343 , :344 , :345 , :346 , :347 , :348 , :349 , :350 , :351 , :352 , :353 , :354 , :355 , :356 , :357 , :358 , :359 , :360 , :361 , :362 , :363 , :364 , :365 , :366 , :367 , :368 , :369 , :370 , :371 , :372 , :373 , :374 , :375 , :376 , :377 , :378 , :379 , :380 , :381 , :382 , :383 , :384 , :385 , :386 , :387 , :388 , :389 , :390 , :391 , :392 , :393 , :394 , :395 , :396 , :397 , :398 , :399 , :400 , :401 , :402 , :403 , :404 , :405 , :406 , :407 , :408 , :409 , :410 , :411 , :412 , :413 , :414 , :415 , :416 , :417 , :418 , :419 , :420 , :421 , :422 , :423 , :424 , :425 , :426 , :427 , :428 , :429 , :430 , :431 , :432 , :433 , :434 , :435 , :436 , :437 , :438 , :439 , :440 , :441 , :442 , :443 , :444 , :445 , :446 , :447 , :448 , :449 , :450 , :451 , :452 , :453 , :454 , :455 , :456 , :457 , :458 , :459 , :460 , :461 , :462 , :463 , :464 , :465 , :466 , :467 , :468 , :469 , :470 , :471 , :472 , :473 , :474 , :475 , :476 , :477 , :478 , :479 , :480 , :481 , :482 , :483 , :484 , :485 , :486 , :487 , :488 , :489 , :490 , :491 , :492 , :493 , :494 , :495 , :496 , :497 , :498 , :499 , :500 , :501 , :502 , :503 , :504 , :505 , :506 , :507 , :508 , :509 , :510 , :511 , :512 , :513 , :514 , :515 , :516 , :517 , :518 , :519 , :520 , :521 , :522 , :523 , :524 , :525 , :526 , :527 , :528 , :529 , :530 , :531 , :532 , :533 , :534 , :535 , :536 , :537 , :538 , :539 , :540 , :541 , :542 , :543 , :544 , :545 , :546 , :547 , :548 , :549 , :550 , :551 , :552 , :553 , :554 , :555 , :556 , :557 , :558 , :559 , :560 , :561 , :562 , :563 , :564 , :565 , :566 , :567 , :568 , :569 , :570 , :571 , :572 , :573 , :574 , :575 , :576 , :577 , :578 , :579 , :580 , :581 , :582 , :583 , :584 , :585 , :586 , :587 , :588 , :589 , :590 , :591 , :592 , :593 , :594 , :595 , :596 , :597 , :598 , :599 , :600 , :601 , :602 , :603 , :604 , :605 , :606 , :607 , :608 , :609 , :610 , :611 , :612 , :613 , :614 , :615 , :616 , :617 , :618 , :619 , :620 , :621 , :622 , :623 , :624 , :625 , :626 , :627 , :628 , :629 , :630 , :631 , :632 , :633 , :634 , :635 , :636 , :637 , :638 , :639 , :640 , :641 , :642 , :643 , :644 , :645 , :646 , :647 , :648 , :649 , :650 , :651 , :652 , :653 , :654 , :655 , :656 , :657 , :658 , :659 , :660 , :661 , :662 , :663 , :664 , :665 , :666 , :667 , :668 , :669 , :670 , :671 , :672 , :673 , :674 , :675 , :676 , :677 , :678 , :679 , :680 , :681 , :682 , :683 , :684 , :685 , :686 , :687 , :688 , :689 , :690 , :691 , :692 , :693 , :694 , :695 , :696 , :697 , :698 , :699 , :700 , :701 , :702 , :703 , :704 , :705 , :706 , :707 , :708 , :709 , :710 , :711 , :712 , :713 , :714 , :715 , :716 , :717 , :718 , :719 , :720 , :721 , :722 , :723 , :724 , :725 , :726 , :727 , :728 , :729 , :730 , :731 , :732 , :733 , :734 , :735 , :736 , :737 , :738 , :739 , :740 , :741 , :742 , :743 , :744 , :745 , :746 , :747 , :748 , :749 , :750 , :751 , :752 , :753 , :754 , :755 , :756 , :757 , :758 , :759 , :760 , :761 , :762 , :763 , :764 , :765 , :766 , :767 , :768 , :769 , :770 , :771 , :772 , :773 , :774 , :775 , :776 , :777 , :778 , :779 , :780 , :781 , :782 , :783 , :784 , :785 , :786 , :787 , :788 , :789 , :790 , :791 , :792 , :793 , :794 , :795 , :796 , :797 , :798 , :799 , :800 , :801 , :802 , :803 , :804 , :805 , :806 , :807 , :808 , :809 , :810 , :811 , :812 , :813 , :814 , :815 , :816 , :817 , :818 , :819 , :820 , :821 , :822 , :823 , :824 , :825 , :826 , :827 , :828 , :829 , :830 , :831 , :832 , :833 , :834 , :835 , :836 , :837 , :838 , :839 , :840 , :841 , :842 , :843 , :844 , :845 , :846 , :847 , :848 , :849 , :850 , :851 , :852 , :853 , :854 , :855 , :856 , :857 , :858 , :859 , :860 , :861 , :862 , :863 , :864 , :865 , :866 , :867 , :868 , :869 , :870 , :871 , :872 , :873 , :874 , :875 , :876 , :877 , :878 , :879 , :880 , :881 , :882 , :883 , :884 , :885 , :886 , :887 , :888 , :889 , :890 , :891 , :892 , :893 , :894 , :895 , :896 , :897 , :898 , :899 , :900 , :901 , :902 , :903 , :904 , :905 , :906 , :907 , :908 , :909 , :910 , :911 , :912 , :913 , :914 , :915 , :916 , :917 , :918 , :919 , :920 , :921 , :922 , :923 , :924 , :925 , :926 , :927 , :928 , :929 , :930 , :931 , :932 , :933 , :934 , :935 , :936 , :937 , :938 , :939 , :940 , :941 , :942 , :943 , :944 , :945 , :946 , :947 , :948 , :949 , :950 , :951 , :952 , :953 , :954 , :955 , :956 , :957 , :958 , :959 , :960 , :961 , :962 , :963 , :964 , :965 , :966 , :967 , :968 , :969 , :970 , :971 , :972 , :973 , :974 , :975 , :976 , :977 , :978 , :979 , :980 , :981 , :982 , :983 , :984 , :985 , :986 , :987 , :988 , :989 , :990 , :991 , :992 , :993 , :994 , :995 , :996 , :997 , :998 , :999 , :1000 , :1001 , :1002 , :1003 , :1004 , :1005 , :1006 , :1007 , :1008 , :1009 , :1010 , :1011 , :1012 , :1013 , :1014 , :1015 , :1016 , :1017 , :1018 , :1019 , :1020 , :1021 , :1022 , :1023 , :1024 , :1025 , :1026 , :1027 , :1028 , :1029 , :1030 , :1031 , :1032 , :1033 , :1034 , :1035 , :1036 , :1037 , :1038 , :1039 , :1040 , :1041 , :1042 , :1043 , :1044 , :1045 , :1046 , :1047 , :1048 , :1049 , :1050 , :1051 , :1052 , :1053 , :1054 , :1055 , :1056 , :1057 , :1058 , :1059 , :1060 , :1061 , :1062 , :1063 , :1064 , :1065 , :1066 , :1067 , :1068 , :1069 , :1070 , :1071 , :1072 , :1073 , :1074 , :1075 , :1076 , :1077 , :1078 , :1079 , :1080 , :1081 , :1082 , :1083 , :1084 , :1085 , :1086 , :1087 , :1088 , :1089 , :1090 , :1091 , :1092 , :1093 , :1094 , :1095 , :1096 , :1097 , :1098 , :1099 , :1100 , :1101 , :1102 , :1103 , :1104 , :1105 , :1106 , :1107 , :1108 , :1109 , :1110 , :1111 , :1112 , :1113 , :1114 , :1115 , :1116 , :1117 , :1118 , :1119 , :1120 , :1121 , :1122 , :1123 , :1124 , :1125 , :1126 , :1127 , :1128 , :1129 , :1130 , :1131 , :1132 , :1133 , :1134 , :1135 , :1136 , :1137 , :1138 , :1139 , :1140 , :1141 , :1142 , :1143 , :1144 , :1145 , :1146 , :1147 , :1148 , :1149 , :1150 , :1151 , :1152 , :1153 , :1154 , :1155 , :1156 , :1157 , :1158 , :1159 , :1160 , :1161 , :1162 , :1163 , :1164 , :1165 , :1166 , :1167 , :1168 , :1169 , :1170 , :1171 , :1172 , :1173 , :1174 , :1175 , :1176 , :1177 , :1178 , :1179 , :1180 , :1181 , :1182 , :1183 , :1184 , :1185 , :1186 , :1187 , :1188 , :1189 , :1190 , :1191 , :1192 , :1193 , :1194 , :1195 , :1196 , :1197 , :1198 , :1199 , :1200 , :1201 , :1202 , :1203 , :1204 , :1205 , :1206 , :1207 , :1208 , :1209 , :1210 , :1211 , :1212 , :1213 , :1214 , :1215 , :1216 , :1217 , :1218 , :1219 , :1220 , :1221 , :1222 , :1223 , :1224 , :1225 , :1226 , :1227 , :1228 , :1229 , :1230 , :1231 , :1232 , :1233 , :1234 , :1235 , :1236 , :1237 , :1238 , :1239 , :1240 , :1241 , :1242 , :1243 , :1244 , :1245 , :1246 , :1247 , :1248 , :1249 , :1250 , :1251 , :1252 , :1253 , :1254 , :1255 , :1256 , :1257 , :1258 , :1259 , :1260 , :1261 , :1262 , :1263 , :1264 , :1265 , :1266 , :1267 , :1268 , :1269 , :1270 , :1271 , :1272 , :1273 , :1274 , :1275 , :1276 , :1277 , :1278 , :1279 , :1280 , :1281 , :1282 , :1283 , :1284 , :1285 , :1286 , :1287 , :1288 , :1289 , :1290 , :1291 , :1292 , :1293 , :1294 , :1295 , :1296 , :1297 , :1298 , :1299 , :1300 , :1301 , :1302 , :1303 , :1304 , :1305 , :1306 , :1307 , :1308 , :1309 , :1310 , :1311 , :1312 , :1313 , :1314 , :1315 , :1316 , :1317 , :1318 , :1319 , :1320 , :1321 , :1322 , :1323 , :1324 , :1325 , :1326 , :1327 , :1328 , :1329 , :1330 , :1331 , :1332 , :1333 , :1334 , :1335 , :1336 , :1337 , :1338 , :1339 , :1340 , :1341 , :1342 , :1343 , :1344 , :1345 , :1346 , :1347 , :1348 , :1349 , :1350 , :1351 , :1352 , :1353 , :1354 , :1355 , :1356 , :1357 , :1358 , :1359 , :1360 , :1361 , :1362 , :1363 , :1364 , :1365 , :1366 , :1367 , :1368 , :1369 , :1370 , :1371 , :1372 , :1373 , :1374 , :1375 , :1376 , :1377 , :1378 , :1379 , :1380 , :1381 , :1382 , :1383 , :1384 , :1385 , :1386 , :1387 , :1388 , :1389 , :1390 , :1391 , :1392 , :1393 , :1394 , :1395 , :1396 , :1397 , :1398 , :1399 , :1400 , :1401 , :1402 , :1403 , :1404 , :1405 , :1406 , :1407 , :1408 , :1409 , :1410 , :1411 , :1412 , :1413 , :1414 , :1415 , :1416 , :1417 , :1418 , :1419 , :1420 , :1421 , :1422 , :1423 , :1424 , :1425 , :1426 , :1427 , :1428 , :1429 , :1430 , :1431 , :1432 , :1433 , :1434 , :1435 , :1436 , :1437 , :1438 , :1439 , :1440 , :1441 , :1442 , :1443 , :1444 , :1445 , :1446 , :1447 , :1448 , :1449 , :1450 , :1451 , :1452 , :1453 , :1454 , :1455 , :1456 , :1457 , :1458 , :1459 , :1460 , :1461 , :1462 , :1463 , :1464 , :1465 , :1466 , :1467 , :1468 , :1469 , :1470 , :1471 , :1472 , :1473 , :1474 , :1475 , :1476 , :1477 , :1478 , :1479 , :1480 , :1481 , :1482 , :1483 , :1484 , :1485 , :1486 , :1487 , :1488 , :1489 , :1490 , :1491 , :1492 , :1493 , :1494 , :1495 , :1496 , :1497 , :1498 , :1499 , :1500 , :1501 , :1502 , :1503 , :1504 , :1505 , :1506 , :1507 , :1508 , :1509 , :1510 , :1511 , :1512 , :1513 , :1514 , :1515 , :1516 , :1517 , :1518 , :1519 , :1520 , :1521 , :1522 , :1523 , :1524 , :1525 , :1526 , :1527 , :1528 , :1529 , :1530 , :1531 , :1532 , :1533 , :1534 , :1535 , :1536 , :1537 , :1538 , :1539 , :1540 , :1541 , :1542 , :1543 , :1544 , :1545 , :1546 , :1547 , :1548 , :1549 , :1550 , :1551 , :1552 , :1553 , :1554 , :1555 , :1556 , :1557 , :1558 , :1559 , :1560 , :1561 , :1562 , :1563 , :1564 , :1565 , :1566 , :1567 , :1568 , :1569 , :1570 , :1571 , :1572 , :1573 , :1574 , :1575 , :1576 , :1577 , :1578 , :1579 , :1580 , :1581 , :1582 , :1583 , :1584 , :1585 , :1586 , :1587 , :1588 , :1589 , :1590 , :1591 , :1592 , :1593 , :1594 , :1595 , :1596 , :1597 , :1598 , :1599 , :1600 , :1601 , :1602 , :1603 , :1604 , :1605 , :1606 , :1607 , :1608 , :1609 , :1610 , :1611 , :1612 , :1613 , :1614 , :1615 , :1616 , :1617 , :1618 , :1619 , :1620 , :1621 , :1622 , :1623 , :1624 , :1625 , :1626 , :1627 , :1628 , :1629 , :1630 , :1631 , :1632 , :1633 , :1634 , :1635 , :1636 , :1637 , :1638 , :1639 , :1640 , :1641 , :1642 , :1643 , :1644 , :1645 , :1646 , :1647 , :1648 , :1649 , :1650 , :1651 , :1652 , :1653 , :1654 , :1655 , :1656 , :1657 , :1658 , :1659 , :1660 , :1661 , :1662 , :1663 , :1664 , :1665 , :1666 , :1667 , :1668 , :1669 , :1670 , :1671 , :1672 , :1673 , :1674 , :1675 , :1676 , :1677 , :1678 , :1679 , :1680 , :1681 , :1682 , :1683 , :1684 , :1685 , :1686 , :1687 , :1688 , :1689 , :1690 , :1691 , :1692 , :1693 , :1694 , :1695 , :1696 , :1697 , :1698 , :1699 , :1700 , :1701 , :1702 , :1703 , :1704 , :1705 , :1706 , :1707 , :1708 , :1709 , :1710 , :1711 , :1712 , :1713 , :1714 , :1715 , :1716 , :1717 , :1718 , :1719 , :1720 , :1721 , :1722 , :1723 , :1724 , :1725 , :1726 , :1727 , :1728 , :1729 , :1730 , :1731 , :1732 ), OriginalSql = delete from nvdb.arealocations al where al.location.netelemid in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?), Error Msg = ORA-01795: maximum number of expressions in a list is 1000
	at oracle.jdbc.driver.T4CTTIoer11.processError(T4CTTIoer11.java:513)
	... 50 more
{code}

Et IN-uttrykk i SQLen som genereres i JdbcAreaLocationRepository.removeForRefLinkNvdbId har flere enn 1000 elementer. Maksimum antall i Oracle er 1000.

h2. Løsning

Fikses i JdbcAreaLocationRepository.removeForRefLinkNvdbId: Del opp parameter refLinkNvdbIds i flere batcher/dellister (á f.eks. 500) og utfør DELETE for hver batch/delliste. 
",NVDB-6937,Skriv-API,
Analyser avvistårsaker fra Datafangst,"Når det registreres endringssett mot Skriv fra Datafangst blir mange av disse AVVIST. Disse blir alltid avvist korrekt, men i mange tilfeller av årsaker som Datafangst burde ha håndtert før innsending. Et eksempel, som vi har sett tidligere, er STØRRE_ENN_ABSOLUTT_MAKSIMUM - noe Datafangst burde ha fanga opp når den har full kontroll over Datakatalogen.

Oppgaven går på å gjøre en slik analyse på nytt. For å gjøre dette kan man benytte Python-script som ligger i API Skriv sitt prosjekt.

Se howto i
{noformat}
/nvdb-skrive-api/performance-test/src/test/python/rejectReasonsInProd
{noformat}
For å bli kjent med hvordan det virker, legg inn (som beskrevet) en fil password.txt med kun ditt passord i Prod. Kjør deretter kommando i eksempel 3 fra howto.

Deretter kjør skriptet med oppdaterte fra- og til-tider og se på avvistårsakene til Datafangst.

(Dette kan også utføres uten å angi Datafangst i kommandoen s.a. man ser avvistårsaker for andre klienter)

*MERK* Anbefaler å kjøre slike analyser jevnlig - både for å kvalitetssikre egne klienter, se hva Skriv avviser flest ganger, og hjelpe andre klienter med typiske avvistårsaker.",NVDB-6937,Datafangst,
Anrop til LDAP-API henger uten timeout,"h2. Observasjon

Ser ut som at anrop til SVVs LDAP-API blir stående å henge (blokkere) for enkelte typer requester:

https://loggsentralen.vegvesen.no/loggsentralen/en-GB/app/SVV_nvdbapis/search?q=search%20index%3D%22svvunvdbapis%22%20APPENV%3D%22utvikling%22%20sourcetype%3D%22nvdbapis-exchange%3ANA-log%22%20host%3D%22svvpocp1sn1n010.vegvesen.no%22&display.page.search.mode=smart&dispatch.sample_ratio=1&earliest=-4h%40m&latest=now&sid=1614179269.15845_C5996C14-FEA3-4A85-B277-7060A0DC991F

Metrikker: https://atlas-grafana.atlas.vegvesen.no/d/pods/pods-and-containers?orgId=1&from=now-6h&to=now&var-iktlosning=nvdbapis&var-appmiljo=utvikling&var-pod=All

Ser ut til at CPU-last øker mye og holdes høy akkurat i tidsrommet requesten til LDAP-API sendes (respons uteblir).

h2. Analyse

Caset er repeterbart: Hver gang API Skriv anropes med /rest/v1/ldap/bruker?etternavn=test holdes en CPU kjerne i gang til evig tid. Tomcat-tråden blokkerer mens den venter på responsen fra SVVs LDAP-endepunkt, som aldri kommer. Gjelder alle Atlas-miljøer.

h2. Forsøk på løsning

Caset er meldt til Mats Faugli, utvikler av LDAP-API for analyse på den siden.

Følgende er forsøkt i API Skriv:

# La inn blokkering i Fake-LDAP-API og får da korrekt SocketTimeoutException ved kjøring av API Skriv lokalt. Dette beviser at oppsett av timeout-verdier i Jersey Client er korrekt satt.
# Bruke asynkron request, med egen timeout på fullføring av request-tråden. Request-tråden avbrytes når tidsgrensen er nådd, men det er fortsatt blokkering i anropet mot LDAP-API. CPU-last som tidligere.
# Erstattet Jersey Client med RESTeasy som JAX-RS-klient. Samme oppførsel.

Det som ikke er forsøkt:

# Bytte til nyere versjon av klient-bibliotekene. Dette lar seg foreløpig ikke gjøre fordi disse er basert på JAX-RS v2.1, mens API Skriv må bruke v2.0.1, siden det er det RestStop bruker.

---

Fikk rettet noen memory leaks i samme seansen: Manglet close() på flere Response-objekter der body ikke leses.",NVDB-6937,Skriv-API,
E2E-test av manuell stedfesting,"Sak NVDB-6369 innførte manuell stedfesting med ankerpunkter. Det er ikke laget e2e-tester for denne funksjonen.

Et lite skjellet er laget på branch NVDB-6916 med tips om hva disse bør inneholde. Dette gjelder testene:
 * /nvdb-datafangst/e2e-tests/cypress/integration/tests/locational_spec.js: should manually localize a single feature with line geometry
 * /nvdb-datafangst/e2e-tests/cypress/integration/tests/locational_spec.js: should manually localize a single feature with point geometry

Oppgaven går på å sjekke ut branch NVDB-6916 (må gjerne merge inn master på nytt om det er en stund mellom branchen ble laget og denne saken tas tak i) eller se hva som ligger i de to testene og heller lage en ny branch fra master, kopiere inn testene, for så å slette branch NVDB-6916.

 Se: [https://git.vegvesen.no/projects/NVDBDATA/repos/nvdb-datafangst/commits/01d278ba9446a303417b54b958055d77d7c5ffbf]

 ",NVDB-6937,Datafangst,
LDAP-endepunkt feiler ved søk på etternavn,"h2. Observasjon

Fra Håvard W: Ser ut som jeg får en feil fra Skriv som kommer av 500 fra ldap-api hvis jeg søker etter ""test"" (både med og uten wildcard), f.eks. https://www.test.vegvesen.no/nvdb/apiskriv/rest/v1/ldap/bruker/?etternavn=test

h2. Analyse

Årsaken til 500-respons er NPE:

{code:java}
java.lang.NullPointerException: null
	at no.vegvesen.vt.nvdb.apiskriv.domain.ldap.UserType.fromUsername(UserType.java:42)
	at no.vegvesen.vt.nvdb.apiskriv.security.soabasis.SoaBasisWsClient.createUserProfile(SoaBasisWsClient.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.security.soabasis.SoaBasisWsClient.toUserProfile(SoaBasisWsClient.java:85)
	at no.vegvesen.vt.nvdb.apiskriv.security.soabasis.EmployeeSearchWsClient.findUserProfiles(EmployeeSearchWsClient.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.security.soabasis.SoaBasisLdapGateway.findUserProfiles(SoaBasisLdapGateway.java:50)
	at no.vegvesen.vt.nvdb.apiskriv.security.CachingLdapGateway.findUserProfiles(CachingLdapGateway.java:33)
	at no.vegvesen.vt.nvdb.apiskriv.rest.ldap.v1.LdapResource.lambda$listUsers$3(LdapResource.java:103)
	at no.vegvesen.vt.nvdb.apiskriv.rest.ResourceUtils.catchExceptions(ResourceUtils.java:63)
	at no.vegvesen.vt.nvdb.apiskriv.rest.ldap.v1.LdapResource.listUsers(LdapResource.java:98)
{code}

Ser ut til at uid-feltet noen ganger ikke er utfylt i responsen fra LDAP.

h2. Løsning

Gjorde SoaBasisWsClient (og subklasser) mer null-safe. Tilsvarende i DefaultLdapGateway.",NVDB-6937,Skriv-API,
Oppdater changelog,"Flytte changelog til frontend, ettersom gradle jobb i backend ikke er pålitelig.

Testes ikke funksjonelt
 ",NVDB-6937,Vegkart,
Egenskapen Sideveg mangler i segmentering,"[~linsto] lagt til en kommentar
Det har nå blitt oppdaget at egenskapen Sideveg ikke legges ut sammen med gatekode og gatenavn i segmenteringen. Dette trenger vi for å kunne levere korrekt Elveg 2.0 frem til eksportløsningen er klar. Regner med at dette også vil være nødvendig i eksportløsningen.

Eksempel på veg som mangler Sideveg: [https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3197357]",NVDB-6937,Les-API,
Automatisk stedfestning får overlapp når visning viser god avstand mellom kurve 1 og 10,"Supportsak:

Visning viser fortau et godt stykke fra hverandre(Kurve 1 og 10). Ved automatisk stedfestning så vises det overlapp i stedfestningen. Burde etterforskes hvorfor dette skjer. 

Sosi -fil er lagt til. En kan laste opp sosi fil i UTV og kjøre automatisk stedfesting for å gjenskape feilen.

Kan fikses ved å bruke ny manuell stedfestning.

 

!image-2021-02-23-11-16-13-532.png!

 ",NVDB-6937,Skriv-API,
Helsesjekk gir 500 når API Les svarer med 503,"h2. Observasjon

Helsesjekkendepunktet /rest/health pinger alle API Skriv sine integrasjonspunkter deriblant API Les (stedfestingstjenesten bruker API Les sitt ruteendepunkt). Ved et tilfelle ser det ut til at API Les var nede i Atlas og lastbalanserer returnerte 503. Dette ser ut til å ha trigget 500-respons fra API Skriv:

https://loggsentralen.vegvesen.no/loggsentralen/en-GB/app/SVV_nvdb/search?dispatch.sample_ratio=1&display.page.search.mode=verbose&earliest=-4h%40m&latest=now&q=search%20index%3Dsvvpnvdb%20host%3Dsvvptomcat25%20OR%20host%3Dsvvptomcat26%20613863a9-5be1-2d9c-2927-d97364487b18&sid=1614069295.10014_C5996C14-FEA3-4A85-B277-7060A0DC991F

h2. Analyse

Det er HealthCheckResource i API Skriv som samler inn rapporter fra pinging av ulike integrasjonspunkter. Dersom en rapport inneholder feilbeskrivelse vil denne legges inn i payloaden og responsen får statuskode 500. Oppførselen er derfor ""by design"" og skyldes ikke mangelfull exception-håndtering.
",NVDB-6937,Skriv-API,
E2E-test for å søke direkte på NVDB-id,"Ny funksjonalitet i Vegkart er å kunne søke direkte på en NVDB-id. Vi bør ha en e2e-test for dette. Velg gjerne en NVDB-id det allerede finnes opptak av i wiremock. Det som bør gjøres:

*Test 1:*
 * Start Vegkart
 * Skriv inn en NVDB-id
 * Sjekk at infoboks kommer opp med riktig NVDB-id
 * Sjekk at url inneholder NVDB-id
 * Velg ""zoom til"" og verifiser at zoom-nivå er endret til mindre tall og at url fortsatt inneholder NVDB-id

*Test 2*
 * Start Vegkart
 * Skriv inn en NVDB-id
 * Sjekk at infoboks kommer opp med riktig NVDB-id
 * Sjekk at url inneholder NVDB-id
 * Velg ""legg til i søk""
 * Verifiser at aktuell type er lagt til i søket",NVDB-6937,Vegkart,
Systemfeil /transaksjoner,"Dersom /transaksjoner kjøres og NVDBIND ikke har prosessert noen transaksjoner etter oppstart feilet /transaksjoner med 
{quote}
SQLDataException: ORA-01830: date format picture ends before converting entire input string
{quote}
på grunn av at tidspunktet brukt for spørring har millisekunder. ",NVDB-6937,Les-API,
Kontraktgrupper uten brukere skulle ha vist en boks om dette,"Det finner kode for å vise en boks som sier ""Ingen brukere i denne gruppen"" når man velger en kontraktgruppe uten brukere. Denne vises aldri fordi det er skevet litt feil i koden.

Steg for å reprodusere:
1. Gå til admin -> kontraktgrupper
2. Lag en ny kontraktgruppe
3. Observer: Der hvor det skal dukke opp brukere hvis de finnes er det ingenting. Det skulle ha vært en boks som sa:  ""Ingen brukere i denne gruppen""",NVDB-6937,Datafangst,
Vise/skjule NVDB/FKB i rapport,"Legge til knappar for å vise/skjule (velge) om NVDB- og/eller FKB-data skal visast i rapportmodulen i DF.

!image-2021-02-19-15-21-08-785.png!",NVDB-6937,Datafangst,
Få inn dato i changeloggen automatisk,"Løsningen vi har i dag fungerer dårlig. Vi må enten sette på riktig dato for produksjon allerede når vi bygger prosjektet for å ta det til ATM, eller vi må bygge på nytt med dato etter at det er testet i ATM.

 

Jeg (Maria) vet ikke hvordan vi skal få til dette.  Vi kan hente ut byggedato, men vi kan vel ikke hente ut dato for release til prod?

h2. Løsning
Har lagret tidspunkt for deploy til server i fil, og bruker dette som versjon for release.
Dette vil være riktig i alle tilfeller utenom der det må rulles tilbake til en tidligere versjon, og for de tilfellene kan fil på disk (i /opt/datafangst på server) redigeres for å sette riktig tidspunkt.",NVDB-6937,Datafangst,
Overføre komplette datasett over DF-API,"For registrering av data til NVDB etter utfasing av klassisk vil det vere behov for å behandle data i ulike produkt. For å gjere dette effektiv må vi ha ein effektiv måte å overføre data mellom produkt på. DF-API kan vere ei løysing der delar av eller heile datasett kan hentast ut og lastast opp. Det må då utvidast til å kunne sende objekt som er oppreta i DF, importert via API eller direkte i DF. Det må og omfatte alle eigenskapar og endringar som er gjort så ein ikkje må gjere arbeid opp igjen etter overføring.
h2. Ønske frå Raymond Krossøy Hermansen

Håper på en bedre *API bru mellom Datafangst og Sinus modulene.* Sinus felt entreprenør modulen kan i dag hente en del info fra Datafangst og kontraktene som ligger der, men ikke alt av data fra kontraktene kan ses eller jobbes videre med. Denne muligheten til å hente inn data fra Datafangst skulle vi absolutt ha hatt muligheten til i Sinus infra også, bare man da kan få til å hente alt som er gjort med dataene fra kontraktene for både Infra og felt entreprenør modulen. Dvs. at vi trenger å få fram alle objekter som ligger i kontraktene, alle endringer som er gjort på objektene generelt og uavhengig av om objektene er nye fra sosifiler, eksisterende hentet fra Vegkart som igjen har fått endrede egenskaper eller plassering, og nye digitaliserte objekter opprettet i Datafangst. En API`bru der alle disse dataene med endringer utført i bl.a. Datafangst, per kontrakt, kan hentes inn direkte for å jobbes videre med i felt modulen for entreprenør før dataene sendes tilbake fra felt entreprenør til Datafangst igjen, eller der dataene lagres direkte fra Infra og inn i NVDB. Dette vil kunne løse mange utfordringer.
h2. 1. Analyse (svar frå Tor Kjetil)

Det du kan hente ut er:
 - All data som er innsendt via det eksterne-API, inkludert nye og importerte NVDB-objekter.
 - All data som er innsendt som del av en SOSI-fil
 
 Det du *ikke* kan hente ut per i dag er:
 - NVDB-objekter som er importert fra kart i datafanen
 - NVDB-objekter som er importert fra Vegkart
 - Nye objekter som er kopierte fra enten andre nye objekter eller NVDB-objekter",NVDB-6937,Datafangst,
Fanemenyene blir disablet av og til når datakatalogen ikke blir initiert,"h2. Observasjon

Fanemenyen blir av og til disablet og man får ikke til å bruke datafangst.
h2. Analyse

Dette ser ut til å oppstå av og til fordi datakatalogen ikke er initiert. Av og til går det bra fordi en annen funksjon klarer å initiere datakatalogen før feilen oppstår.
Feilen oppstår når fordi readFeatureList er avhengig av datakatalogen, men datakatalogen er ikke initiert.
Feilen oppstår ikke når readFKFeatureList kjører ferdig før readFeatureList prøver å bruke datakatalogen fordi readFKBFeatureList forsikrer seg om at datakatalogen er initiert først.
h2. Løsning

Legg inn kall til å initiere datakatalogen på readFeatureList på lik linje som readFKBFeatureList gjør.

 ",NVDB-6937,Datafangst,
Oppdaterte Dashboard i Grafana,Nå som skriv eksponerer flere metrikker fra prometheus så vil det være nyttig å oppdatere grafana til å presentere de nye metrikkene. Samtidig vil det være nyttig å legge inn alerts som rapporterer til Slack om unormaliteter.,NVDB-6937,Skriv-API,
Leveranseinformasjon Lese API V3 2021.4.0+.1+.2+5.0,"*Testes av SVV:*
 * NVDB-5977 - funksjonalitet som før. Krever full reindeksering, når full reindeksering er utført sette konfig areacache.NVDB5977=true. For kontraktsområder/riksvegruter/gater med flere objekter skal solrspørring inneholde kun én id.
 * NVDB-6224 - Test at å legge til kommune som vegobjekttype og et fylke som områdefilter gir ut kommunene i fylket.
 * NVDB-6456 - Test å filtrer med relativposisjon 0 og 1.
 * NVDB-6544 - Ved filtrering på ikke-eksisterende riksvegrute vil responsen nå være feilmelding.
 * NVDB-6461: Re-kjør stedfestingskall mot aktuelt miljø. Resposnen skal nå kun ha en veglenkesekvens-id
 * NVDB-6545: Verifiser filtrering med riksvegrute. Bruk gjerne url i beskrivelsen.
 * NVDB-6917: Ved filtrering på gate skal objekter ha komplett lokasjon

*Testes av Leverandør:*
 * NVDB-6493 - Kontrakter, riksvegruter og gater som består av flere objekter skal komme kun én gang for /omrader/X. Med header «Accept: application/vnd.vegvesen.nvdb-v3-rev2+json» vil alle objekter bli listet ut for hvert kontrakt/rute, med rev1 blir kun laveste id returnert.

Saker som ikke er nevnt her testes ikke manuelt",NVDB-6937,Les-API,
Ta hensyn til eksisterende NVDB-døtre ved re-stedfesting av NVDB-objekter,"h2. Bakgrunn

Vi har hatt noen case i Datafangst hvor en bruker har re-stedfestet et NVDB-objekt som da får en stedfesting som er litt ulik sin tidligere stedfesting - og da videre stedfestingen til sine døtre i NVDB. Ved et support-tilfelle hadde et belysningspunkt fått veldig ny stedfesting da Les ga beskjed om at punktet lå nærmest en KV som gikk over tunnelen langs E6. Her fikk altså et NVDB-objekt stedfesting på KV når alle døtrene var på E6 (ingen preferanse var satt på veg og kategori i Datafangst).

For de fleste re-stedfestingene så er det kun nede i desimalene at ny stedfesting skiller seg fra enten mors eller døtres stedfesting i NVDB. I slike tilfeller er det raskt å tenke at Skriv kunne benyttet original stedfesting for objektet - men det må her være grenser for hva Skriv antar er innenfor ""slingsringsmonnet"". Har brukeren benyttet f.ex manuell stedfesting i klienten og vet at den SKAL endres eller ikke? Og det siste eksemplet over med KV vs EV er stedfestingen ganske forskjellig. Hva bør Skriv gjøre her? Gi beskjed om at objektet ikke blir re-stedfestet pga eksisterende NVDB-døtre?

Det ligger sak på å stedfeste hierarki i Datafangst, men dette vil uansett ikke hjelpe her da man vanligvis ikke importerer hele NVDB-hierarkier (tenk type 581 -> 67 -> ...).

Gode forslag mottas!

h2. Analyse

Stedfestingstjenesten til API Skriv tar i mot vegobjekter for stedfesting uten å vite om dette er nye vegobjekter som skal registreres eller om det er eksisterende vegobjekter i NVDB som skal restedfestes. I representasjonsmodellen er vegobjektene derfor oppgitt kun med tempId, som i DF sitt tilfelle settes lik DFs interne feature-id (UUID). Tjenesten er altså frikoblet fra aspekter som er irrelevant for beregning av en stedfesting basert på egengeometri. Det reduserer kompleksitet via ""separation of concerns"".

I saken ønskes en løsning der stedfestingstjenesten gjøres kjent med at et vegobjekt finnes i NVDB og dermed har en eksisterende stedfesting. For å realisere dette må en nvdbId oppgis for relevante vegobjekter i tillegg til tempId. Det første endringsforslaget går på å returnere eksisterende stedfesting i NVDB, dersom ny beregnet stedfesting ikke avviker mer enn en terskelverdi. Dette medfører en del ekstra round-trips mot NVDB for å hente data og responstiden for det synkrone endepunktet kan potensielt øke. Dog antageligvis ikke mye.

Det andre endringsforslaget går ut på at datterobjekter til et eksisterende vegobjekt som stedfestes også hentes inn i prosessen og kontrolleres mot morobjektets nye stedfesting. Jeg tenker at dette er en dypere form for validering som går utover naturlig ansvarsområde for stedfestingstjenesten. Også her vil kompleksisteten øke i API Skriv og responstiden forringes. Det er DF som kjenner den aktuelle konteksten, nemlig at vegobjektet finnes i NVDB fra før og kan også hente eventuelle datterobjekter fra NVDB uten å tenke på krav til responstid (ved automatisk stedfesting). Mengden datterobjekter trenger ikke være stor da DF ikke behøver hente dypere enn til den generasjonen der ""innenfor mor"" ikke er et krav. I det aktuelle tilfellet med morobjekt som havner på annen veg enn datterobjektene, kunne dette vært løst ved at datterobjektene med krav om ""innenfor mor"" ble inspisert og vegbenevnelsen hentet fra disse og matet inn i requesten for stedfesting av mor som foretrukken veg. For å hindre at mor får annen plassering på denne vegen enn døtrene kunne ankerpunkter beregnet ut fra datterobjektenes ytterposisjoner vært angitt. Eksisterende døtre blir her styrende for stedfestingen til mor. For å forenkle dette kunne eventuelt API Skriv vært utvidet til å ta i mot lokasjoner (lenkesekvensposisjoner) som ankerpunkter. I dag støttes kun geometriposisjoner som ankerpunkter.",NVDB-6937,Skriv-API,
Ta i bruk oppdatert versjon av SQL DSL-bibliotek,"Datafangst har en gammel versjon av et bibliotek for å lage SQL integrert i koden (pakke ""{color:#000000}no.svv.nvdb.datafangst.jdbc.dsl"" i jdbc-modulen). Denne koden er stort sett urørt siden 2015, men er videreutviklet i Skriv og er skilt ut som et eksternt bibliotek.{color}

{color:#000000}Koden som Datafangst har mangler f.eks. fundamentale sammenlikningsoperasjoner som ""like"" i spørringer, så i stedet for å flikke på gammel kode her bør vi gå over til den versjonen som er vedlikeholdt i fellesskap.{color}",NVDB-6937,Datafangst,
Filtrering på riksvegrute gir feil svar,"h2. Observasjon

Filtrerer på en riksvegrute [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/96.json?riksvegrute=%22RUTE16%202006-2009%22&antall=12&segmentering=false&inkluder=lokasjon]

Men alle resultater viser riksvegrute RUTE6B - og ikke RUTE16 som er etterspurt.",NVDB-6937,Les-API,
Ikke eksisterende riksvegrute gir mange treff,"h2. Observasjon

Kallet [https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert.json?antall=25&riksvegrute=%22RUTE5YX%202014-2023%20/%202018-2029%22] etter en ikke-eksisterende riksvegrute gir mange treff. Riktignok har alle riksvegrute: [].

Tilsvarende for f.ex kontraktsområde-filteret gir type _Finner ikke noe kontraktsområde ved navn '120199999 Asola tillegg 2020-2023'._",NVDB-6937,Les-API,
Endre kolonneoverskrift tillatt for modulvogntog,"Når jeg som faggruppe vegliste skal publisere veglister tømmertransport ønsker jeg at kolonnen for ""tillatt for modulvogntog"" har teksten Tillatt for modulvogntog 1 og 2 med sporingskrav"" slik at dette med ""tillatt for modulvogntog"" blir formidlet tydelig til brukerne våre og ikke kan misforstås. 

 

Gjelder altså word-rapporten for ""Tømmertransport, uoffisiell"" i produksjon av ferdige veglister https://nvdb-veglister.atlas.vegvesen.no/#/generer

 ",NVDB-6937,Rapportgenerator,
"Problem med Paginering i ""Data factory""","h1. Support

Hei.

Er som alltid veldig imponert over det dere lever! Sender bare inn et innspill her. Tidligere har jeg brukt Python for å importere data fra dere, men har test litt Azure Data Factory i dag, og gjort noen forsøk på å lese data ut fra deres API på https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?srid=4326 

Måten «pagination» er lagt opp hos dere fungerer veldig bra med Data Factory, man treger bare å legge til «$.metadata.neste.href», så leser REST komponent de resterende sidene automatisk:  !image-2021-02-12-14-46-51-206.png!

Dessverre ser det ut som at når lesingen går mot den siste batchene, så henger den seg opp i en «uendelig loop». Hos meg stod løsningen slik i nær 30 min, etter den egentlig var ferdig.  Så restatte den og startet å lese inn pånytt. Jeg får ikke sporete det, men jeg antar at siste «neste» url gikk om igjen hele tiden.

Om man ser på siste url: https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?start=2PPhBHmfx4TFYHG8CwcBYsr3sT2NAVp3kyi95w48hMvvrNF1JeHhLPVzFgsoedAqZqfhw1VrGqARi35h9tCbG2n9z3nq1Wngh3KcFX1nc2DimiBsGimZGWyKD41S9NMdRzc6r2o9EHafvCNnx5BY1NJnXMaY2uP&srid=4326, så ser det ut som Data Factory blir forvirret av at det leveres «$.metadata.neste.href» når resultatet har kommet så langt at det er tomt:

!image-2021-02-12-14-49-19-340.png!

Jeg vet ikke om det er hensikten fra deres side at «neste» kommer, selv om det ikke er flere rader? Strengt tatt burde Data Factory sluttet å lese her, men det er så vidt jeg vet, ingen gode måter å overstyre denne logikken på. 

Tenkte det kunne være greit for dere å vite, det er sikkert flere som kunne tenke seg å lese data fra dere med Data Factory. Stort sett forenkler det hele ETL prosessen. Om det var en mulighet til å ikke få «neste» når man har kommet til slutten av filen, tror jeg i hvert fall det kunne vært nyttig. 

Med vennlig hilsen  
Jarle Bjørnbeth  
Databasearkitekt
t: 934 28 766
e:jb@bonum.no",NVDB-6937,Les-API,
Må vi stedfeste objekter som kopieres fra NVDB-objekter,"h2. Problem

Dette tilfellet kommer fra testing knyttet til Ketil Johansen sitt problem på support (12-02-21). Kanskje ikke direkte problemet, men likevel kan det ha vært med på å skape et problem.

Saken er at når man kopierer et NVDB-objekt til en ny type, gjør forvalterne ofte dette for å lage et objekt som skal kobles på NVDB-objektet - eller erstatte NVDB-objektet. Når nytt objekt blir laget så stedfestes dette gjennom Skriv, noe som kan føre til at man får en litt annen stedfesting enn det opprinnelige NVDB-objektet. Dette skaper problemer. To tilfeller her:

Importer url i en kontrakt: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/87?segmentering=true&kartutsnitt=275791.812%2C7041152.653%2C276089.883%2C7041291.229&vegsystemreferanse=E6&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

*Observasjon #1*

Kopier 87-671973535 til ny type 88 (datter). Da får vi stedfestingene:
 * 87-671973535: EV6: 0.8718908@72811
 * copy-as-new 88: EV6: 0.87192732@72811

Request og respons fra Skriv:
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""88"" tempId=""eab0836f-c322-4faa-8655-b7ddd46e2178""><egenskaper><egenskap typeId=""4788""><geometri><srid>5973</srid><wkt>POINT (275815.74 7041161.92 19.259)</wkt><datafangstdato>2015-10-22</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>10</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>20</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-02-12</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>

<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt tempId=""eab0836f-c322-4faa-8655-b7ddd46e2178""><stedfesting><oversikt><veg><kategori>E</kategori><fase>V</fase><nummer>6</nummer></veg><lengde>0.0</lengde></oversikt><punkt veglenkesekvensNvdbId=""72811"" posisjon=""0.87192732""><sideposisjon>V</sideposisjon><geometri><srid>5973</srid><wkt>POINT (275809.8950182986 7041149.537822907)</wkt></geometri></punkt></stedfesting></vegobjekt></stedfestingResultat>
{noformat}
 

Denne lille forskjellen går bra når man vil sammenkoble. For etter sammenkobling får man:
 * 87-671973535: EV6: 0.8718908@72811
 * new-88: EV6: 0.8718908@72811

Men new-88 er fortsatt oransje i stedfestingsfanen, og ved en ny aut.stedfesting (sannsynligvis pga flere nye av samme type - eller at man ikke av-huker type 88) gir da derimot tilbake:
 * new-88: EV6: 0.87192732@72811

Dette gir problemer ved registrering

*Observasjon #2*

Kopier 87-671973536 til ny type 88 (datter). Da får vi stedfestingene:
 * 87-671973536: EV6: 0.86927441@72811
 * copy-as-new 88: KV7660: 0.60475016@42651

Request og respons til Skriv
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""88"" tempId=""3b655639-138f-41f9-88ef-ea94249d039b""><egenskaper><egenskap typeId=""4788""><geometri><srid>5973</srid><wkt>POINT (275793.44 7041173.21 19.749)</wkt><datafangstdato>2015-10-22</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>10</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>20</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-02-12</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>

<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt tempId=""3b655639-138f-41f9-88ef-ea94249d039b""><stedfesting><oversikt><veg><kategori>K</kategori><fase>V</fase><nummer>7660</nummer></veg><lengde>0.0</lengde></oversikt><punkt veglenkesekvensNvdbId=""42651"" posisjon=""0.60475016""><sideposisjon>V</sideposisjon><geometri><srid>5973</srid><wkt>POINT (275789.2740009451 7041171.569511681)</wkt></geometri></punkt></stedfesting></vegobjekt></stedfestingResultat>
{noformat}
Denne forskjellen går ikke bra ved sammenkobling. Så jeg ønsker derfor videre å ta en stedfesting av kun new-88 til E6. Dette gir imidlertid en feil. Her er jeg usikker på om dette er en feil pga ytelsestest mot Skriv i ATM på gjennomføringstidpunkt eller om dette er en faktisk feil, men poenget i denne saken går ikke på det. Kibana: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.13-2021.02.12/doc/?id=5nJLlncBczWDIpQ8Hm0p]
h2. Forslag

Ved kopiering til nytt objekt (ny type eller ikke) så beholdes geometri. Kunne vi da bare beholdt stedfestingen også - og samtidig satt denne til grønn i stedfestingsfanen? Dersom geometri endres i etterkant så blir det en annen sak, og da får man jo muligheten til å re-stedfeste, men når geometri ikke endres så vil et slikt forslag bevare stedfestingen fra NVDB og vi kan få færre problemer.

 
h2. Løsning

Ved kopiering av objekt kopieres stedfesting fra det originale objektet. Det gjelder både kopiering innenfor samme objekttype og kopiering til ny objekttype. Også hvor sikker stedfestingen er kopieres. Eksempel: kopi av vegobjekt med usikker stedfesting vil også få usikker stedfesting.

Endret knappen ""Kopier geometri til ny objekttype"" til ""Kopier til annen objekttype"". (""kopier geometri og stedfesting ..."" ble litt langt). Forklarer bedre i dialogen som kommer opp hva som skjer.",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Testes av SVV:*
 * NVDB-6496 -Sjekke at støtte for import av v2 url ikke støttes lenger (og at v3 funker)
 * NVDB-6369 -Sjekke at manuelt angi stedfestning i ny versjon funker
 * NVDB-6253 -Sjekke oppdatert påloggingshjelp for fk
 * NVDB-6226 -Sjekke Visning av stedfesting på flere veger
 * NVDB-5669 -Sjekke at en kan registrere nye døtre til samme NVDB-mor på samme dag
 * NVDB-6351 -Sjekke at hendelseslogg er sortert etter nyeste øverst
 * NVDB-6354 -Sjekke changelog som egen DF komponent
 * NVDB-6364 -Sjekke at ny manuell stedfesting funker for de to observasjonene (sosi filer er i attachment)
 * NVDB-4510 -Sjekke at Morobjekter fra NVDB importeres til kontrakten
 * NVDB-6514 -Sjekke at scrolling funker i sammenkoblingsfanen for døtre ++NY Torbjørn!!
 * Siste her er ny Torbjørn(6514)

*Testes av leverandør:*
 * NVDB-6416 -Sjekke at polling stopper ved automatisk stedfestning når stedfestning allerede er satt
 * NVDB-6464 -Sjekke riktig feilkoder 405, 409
 * NVDB-6499 -Sjekke at E2E tester kjøres grønt etter oppdatert webpack-cli

*Testes ikke i ATM:*
 * NVDB-6437 - Integrasjonstest - Validere geometritype i alle vegobjekter
 * NVDB-6465 - Tekstendringer - Oppdatere dokumentasjon om feilkoder
 * NVDB-6475 -Integrasjonstest",NVDB-6937,Datafangst,
Manglende beskjed om å registrere mor samtidig i eksportfanen,"*Observasjon #1*

(Fra NVDB-4510): Laster inn 96.sos og kobler til NVDB-mor 95. I eksport fanen så får jeg ikke beskjed om at 95 må registreres samtidig ved markering av kun 96 (ser MISSING_RELATION_IN_CHANGESET: 1 i responsen). Får melding om at 96 må registreres samtidig som 95 ved kun å markere 95.

*Observasjon #2*

Importerer et NVDB-objekt av type 95 (95-1011051982 v2) og 96.sos. Kobler NVDB-objektet til det nye 96-objektet internt i kontrakten. Får samme observasjon som i #1 med at det ikke kommer melding om å registrere 95 samtidig ved kun markering av 96 i eksportfanen.

Gjenskapt på UTV ved å importere 95-599558224 fra kartet i datafanen + 96.sos. Kobler disse sammen (kontrakt-til-kontrakt) etter å ha stedfestet 96. Samme observasjon. Eksportfanen: Markering av kun 95 gir beskjed om å markere 96 samtidig, mens markering av kun 96 gir ingen info om hva som må registreres sammen med 96 + registrer-knappen er disablet.",NVDB-6937,Datafangst,
Mangler markering av NVDB-mor etter sammenkobling,"h2. Observasjon

Etter å ha funnet kandidatmødre i NVDB, for deretter å koble kontrakt-datter til en NVDB-mor, så ble tilkoblet NVDB-mor tidligere ""farget"" grønn (kan det ha noe med at den tidligere fikk klassen ""isInTargetAssociation"", noe den ikke får nå). Det skjer ikke nå. Etter import av NVDB-mor så kan jeg nå markere den nye datteren og på nytt hente opp aktuelle mødre. Da er ikke allerede påkoblet NVDB-mor markert som tidligere. Skulle man da fått beskjed (med en grønnfarge) om at akkurat denne NVDB-mor allerede er koblet til datter

 

Fra [~havwig]: Jeg synes også at det skulle ha virket som før med markering, men det er en uforholdsmessig stor jobb. Vi kan vurdere å enten skille det ut som en egen sak så vi kan ta dette ut nå, eller vente på et mer helhetlig redesign i NVDB-6450.",NVDB-6937,Datafangst,
Doble kall for å hente info i sammenkoblingsfanen,"h2. Observasjon

Jeg kobler til NVDB-mor som igjen har en NVDB-mor, og får da opp hierarkiet på venstre side. Når jeg så markerer Tunnel for å få vist info om denne tunnelen går det doble kall mot API Les. Dvs doble OPTIONS-kall og doble GET-kall (både for å finne versjon og den faktiske versjonen).
h2. Gjenskap

Kan gjenskapes med å importere 95.sos og koble til Tunnelløp ""Helltunnelen"" (søk 1000 m unna). Marker Tunnel. Og se i networks-tab under Inspect.",NVDB-6937,Datafangst,
boksen med egenskaper på sammenkobling brekker ved listeverdier,"Boksen for egenskapsverdier som vises når man har valgt et vegobjekt på sammenkoblingsfanen klarer ikke å vise verdier riktig når verdiene er liste-verdier.

 

Analyse:

Fant ingen vegobjekter med egenskapstyper som hadde liste-verdier. Vi så derimot at vegobjekter med egenskapstyper med lange navn gjorde tabellen merkelig.",NVDB-6937,Datafangst,
Ta ut omitNorms fra solr-skjema,"Det er sannsynligvis ikke nødvendig å ha ""omitNorms=x"" i skjemaet, og det forårsaker en del systemmisnøye i loggene. Jeg har derfor blitt anbefalt at vi bør fjerne dem.",NVDB-6937,Les-API,
For lave lengder i veglistene,"Vegliste arbeid har feil (altfor små) lengdeverdier. Iallfall for BK tømmertransport, uoffisiell (objekttype 901) for Vestland fylke langs Fv50: 

!image-2021-02-11-14-06-33-467.png!

Her har vi ett NVDB-objekt for hvert av strekningene, så dette burde være en veldig god case for feilsøking og feilretting. 

Riktige verdier: 
|   nvdbId|Strekningsbeskrivelse|Sum lengde|
|777617084|Arm Steine bru - Bjelde|1159,340|
|777617562|Viken gr. / Geiteryggen - Aurland (Nyheim) x E16|42394,511|

 

 

 

 ",,Rapportgenerator,
"Oppdatering av datakatalog via Skriv, løsningsbeskrivelse/design m/grovestimater","Ref. NVDBFOR-446, samt foreløpig utredning på [Oppdatering av datakatalog - Veg og transport – NVDB og Geodata - Confluence (vegvesen.no)|https://www.vegvesen.no/wiki/display/NVDBogGeodata/Oppdatering+av+datakatalog]

 

Vi går for ""Alt.3: Ny klient for å generere endringssett med datakatalogendringer"", der klienten ønskes implementert som fane/menyvalg i Kontrollpanelet i Skriv.

Vi ber med dette om utarbeidelse av mer detaljert løsningsbeskrivelse/design m/grovestimater.

 

Løsningsbeskrivelse:

[Ny klient for å generere endringssett for datakatalogendringer - IKT - Forvaltning og videreutvikling - Confluence (vegvesen.no)|https://www.vegvesen.no/wiki/pages/viewpage.action?pageId=147710190]",NVDB-6937,Skriv-API,
Flytte api-client koden fra bintray,"Bintray vil foreta seg en såkalt ""sunset"" hvor de ikke lenger vil hoste opensource-kode ( https://jfrog.com/blog/into-the-sunset-bintray-jcenter-gocenter-and-chartcenter/ ).
Dette medfører at vi bør flytte vekk ""client-api"" repoet vårt fra Bintray, og til en annen tjeneste, feks. Maven central.",NVDB-6937,Les-API,
Fikse integrasjonstester i LES V3,"Integrasjonstester feiler ofte i LES V3. Det har vært snakk om at det noe randomisering som brukes i testene. Dette kan føre til at testene noen ganger kjører OK og andre ganger ikke. Hadde vært greit å få disse testene mer konsistente, og at lykkes oftere.

!jenkins.png|thumbnail!

 

*Løsning*

Har tatt en ny datadump og gjort noen justeringer i henting av testdata. Det ser ut til å løse de periodiske feilene vi har hatt i det siste.",NVDB-6937,Les-API,
Oppdatert status for objekt i kontrakt,"Ønske om å vise informasjon og oppdatert status for objekt.

Til dømes:
 * om det kom inn frå SOSI, API, NVDB
 * om det er uendra eller oppdatert
 * er det levert til nvdb, forsøkt levert...",NVDB-6937,Datafangst,
Døtre for lukking vises i sammenkobling,"h2. Observasjon

Last inn en ny mor og en datter til lukking. Ved forsøk på å manuelt sammenkoble ny mor til NVDB-datter i prosjektet, så får man en HTTP 400 på kallet /create_manually med beskjeden 
{noformat}
(FeatureToBeClosedException) Attempting to associate from/to feature with id 9d2e1419-c614-409f-bd73-342a3dbe4903 and NVDB id 1011051973:1 that is marked for closing
{noformat}
NVDB-objekter som har operasjon Lukk burde ikke kunne blitt valgt i utgangspunktet inne i sammenkoblingsfanen. Disse bør filtreres bort.

Dette er et problem også noen på support har støtt borti: 

[https://vegdata.kantega.no/kibana/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:'2021-02-07T23:00:00.000Z',mode:absolute,to:'2021-02-12T22:59:59.999Z'))&_a=(columns:!(_source),index:'datafangst-logs-*',interval:auto,query:(language:lucene,query:'HOSTNAME:datafangst.kantega.no%20AND%20%22d36ca338-ff40-427d-8db1-3f229a164227%22%20AND%20%22that%20is%20marked%20for%20closing%22'),sort:!('@timestamp',desc))]",NVDB-6937,Datafangst,
Endre til responsrevisjon 2,"NVDB-6493 innfører gruppering av kontraktsområder og riksvegruter, slik at kontrakter som består av flere objekter i NVDB vises som én kontrakt. 
Når et kontraktsområde velges i Vegkart ser det ut som de faktiske objektene for kontrakten blir hentet. Det må undersøkes om dette må endres og hva det brukes til.",NVDB-6937,Vegkart,
Oppgradere npm pakker,"Oppgradere generelle npm pakker.

Se siste versjon av pakkene vi bruer med: npx npm-check-updates

Bla. ny versjon av React og Leaflet.",NVDB-6937,Datafangst,
Innsending med dirty ute av sync gir systemfeil,"Det kan skje at vegobjekter ved en feil (f.eks. fra NVDB-6516) bli markert som endret (""dirty"") i databasen, uten at det er faktiske endringer.

Da kan bruker sende inn, men vil få systemfeil fordi vi ender opp med et tomt endringssett. Vi kunne ha brukt denne anledningen til å synkronisere oss på dirty, sånn at i de tilfeller vi finner at et objekt er dirty men ikke har endringer så nullstiller vi dirty. I så fall må bruker få en fornuftig beskjed tilbake om at det ikke er noen innsending (siden hen forventer å få det), men at status er oppdatert eller noe.",NVDB-6937,Datafangst,
Godkjenning av innsendt stedfesting gir dirty vegobjekt,"Support-sak fra Jon Bråten (Jon.Braten@afgruppen.no) 8. februar, etter at han har klaget over ""dårlig pålitelighet"" og at Datafangst har glemt status.

I dette konkrete tilfellet ser det ut som det er vegobjekter som er sendt inn, for så å få godkjent sin stedfesting på nytt (sikkert som en del av et større utvalg). For dette så beholder vi operasjon for stedfesting, så den skrives ikke på nytt (som forventet), men selv om alle stedfestinger er satt til ""READ"" så settes fortsatt vegobjektet til ""dirty"".

Steg for å reprodusere:
 # Last opp og stedfest vedlagt SOSI
 # Send inn til NVDB, sjekk at ingen vegobjekter er markert som endret etterpå
 # Veg en stedfesting og trykk ""Godkjenn"" på den
 # Se at eksport-fanen nå rapporterer om ett endret vegobjekt",NVDB-6937,Datafangst,
Scrolling i sammenkoblingsfanen,"h2. Observasjon

I sammenkoblingsfanen, velg et vegobjekt som har mange potensielle døtre. Det går ikke an å scrolle selv om lista over potensielle døtre blir så lang at den er lengre enn vinduet.

!image-2021-02-08-15-23-54-702.png!
h2. Analyse

Feilen oppstår i Blink-baserte nettlesere som Edge og Vivaldi, og Firefox (Gecko) men oppstår merkelig nok ikke i Chrome.

Jeg antar dette har mest med timing i DOM vs renderen å gjøre. Feilen oppstår når listen over døtre blir så lang at listen får scrollbar.
 Elementene er implementert med Flex-layout, men elementene blir ikke contained i flex-boxen riktig. jeg tror dette oppstår fordi listen får en kakulerte høyde som er høyere enn max tillatt innenfor flexboksen. Da burde overflow-regelen slått inn, men det gjør den bare i chrome. 
h2. Løsning

Vi kan hjelpe rendrene litt på vei ved å sette height: 0 på listen, slik at den blir initelt rendret som veldig liten, og flex-grow regelen blir overholdt.

 ",NVDB-6937,Datafangst,
Statistikk veglister,"Som kunnskapsgrunnlag for veglisteproduksjon ønsker vi en logg over hvilke veglisterapporter som er kjørt i systemets levetid. Ideelt sett bør denne loggen ha med tidspunkt, type og geografisk område. Jeg antar kanskje at innholdet i databasen samsvarer med valgmulighetene i AP, så ut fra [Swagger UI (vegvesen.no)|https://nvdbrapportapi.atlas.vegvesen.no/swagger-ui/#/Veglister/get_rapporter_veglister__bruksklasse_] skulle det bli noe slikt som : 
 * bruksklasse
 * fylke (liste)
 * kommune (liste)
 * publisering (boolean) 
 * vegsystemreferanse

Ved produksjonstopper så er både PROD, ATM og UTV - miljøene brukt, så vi trenger nok statistikk fra alle tre miljøene. ",NVDB-6825,Rapportgenerator,
Får ikke koblet til NVDB-datter på importert NVDB-mor pga feil versjon,"*Observasjon*

Oppdaget under test av NVDB-5669. Fant ut under analyse av saken at det er NVDB-5713 som blokkerer denne (som NVDB-6365), men beholder saken for enkel re-testing.

Her har jeg koblet til ny 96 på NVDB-obj 95 og registrert. UTFØRT. Deretter koblet til NVDB-obj 96 på samme NVDB-obj 95. Da feiler registreringen med at det ikke finnes noen relasjon fra gammel NVDB-mor til NVDB-datter (DF vil slette assosiasjon på v2, men v2 av NVDB-mor har ikke denne assosiasjonen, det er det v1 som har).

*Gjenskap*

Last inn 96.sos. Stedfest og koble til NVDB-obj 95 (ikke velg 1011051974). Registrer. Deretter velg importert NVDB-obj 95 og koble til NVDB-datter (velg 1011051973). Da feiler registreringen med _1011051974: Egenskapstypen 220004 finnes ikke i objektet_.

*Problem*

Relatert til at Les gir ut feilaktig foreldre-relasjon for Skiltplata. Se [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/96/1011051973/1.json] hvor forelder er 95-1011051974 (i tillegg til riktig mor). Dette kan også sjekkes via Skriv sitt Kontrollpanel - velg _Innsyn_ og tast inn 95 - 1011051974 - v1/v2).

Løses nok ikke før NVDB-5713.",NVDB-6937,Datafangst,
Systemfeil ved aut.sammenkobling når NVDB-objekt ikke har stedfesting,"h2. Observasjon

Laster inn vedlagte SOSI og kjører auto-sammenkobling mot døtre i NVDB (avstand 25). Da kommer det en systemfeil opp.

[https://datafangst.utv.vegvesen.no/#!/contract/bb291d56-c106-4630-aa76-c4524557aad5/association]

Kan se ut til at vi klarer å sende avgårde [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/-1]

som gir et uventet svar tilbake.

Se Kibana logg for kontrakten over:

[https://vegdata.kantega.no/kibana/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:'2021-02-04T23:00:00.000Z',mode:absolute,to:'2021-02-05T22:59:59.999Z'))&_a=(columns:!(_source),index:'datafangst-logs-*',interval:auto,query:(language:lucene,query:'HOSTNAME:datafangst-utv.kantega.no%20AND%20%22bb291d56-c106-4630-aa76-c4524557aad5%22'),sort:!('@timestamp',desc))]

 ",NVDB-6937,Datafangst,
Gap i segmentert vegnett (gir geometrifeil på veglenker i Elveg2.0),"h3. Sak frå Arne Sonflå

Jeg har ""tunet"" geometrikontrollene på Elveg20 nå og finner en del geometrihull på veglenkene. Når disse oppsto vet jeg ikke, men de var ikke der i september i alle fall.

Stedene feilene oppstår er der vi har gateobjekter som ikke er snappet til port. Da blir det hull på 1-3 meter i veglenkegeometrien før resten av lenka kommer videre.

Lurer på om dette kan ha noe med at LES nå segmenterer på gate?? (mail fra Marvin 19.01). Men uansett om den segmenterer på gate skal ikke slike hull på veglenkene oppstå.

Ettersom Einar snart skal slutte og det ifølge det siste jeg har hørt jobbes med ny eksport (stemmer det?) så lurer jeg på hva som er det beste å gjøre. Er ny eksportfunksjon snart klar er det vel greit å vente på den. Om ikke så bør Einar finne ut hva som er feil og rette det? Jeg vet i alle fall ikke, men en plan bør vi ha. Jeg finner en del feil i mine kontroller der avstand mellom lenkedelene er mindre enn 2,5 meter, men klarer ikke å finne de over. Og Hans Jørgen har ingen kontroll som kan gi meg en fornuftig liste over hvor vi har slike gate objekter.

Eksempel på lenker som får brudd på geometrien er
 * 2462758
 * 2461671
 * 2461571

Alle i kommune 1528
h3. Svar frå Linda Støeng:

Ser i Vegkart at det også er gap her, så dette handler nok om segmenteringen (NVDB-6040 Segmetering av vegnett og Gate - JIRA for Statens vegvesen).

2462758: PV99059
2461671: PV99176
2461571: PV99192


[Vegkart (vegvesen.no)|https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@65573,6941095,10/hva:~(~(id~538))/hvor:~(kommune~(~1528)~vegsystemreferanse~(~'PV99176~'PV99059~'PV99192))/vegnett:~'geometri+~()]
 
Det er helt riktig at slike gap ikke skal oppstå. Jeg husker ikke om det ble forutsatt at Gate skulle dekke hele veglenka. Det er jo en naturlig forutsetning vil jeg tro, men det finnes helt sikkert eksempler der gate ikke skal dekke hele veglenka, f.eks. der en veg ender blindt (?).",NVDB-6937,Les-API,
Vegobjektersegmenter mangler områder,"Kontraktsområder, riksvegruter og gate mangler i vegobjektsegmenter. Dataene er der, så de trenger bare skrives ut,
",NVDB-6937,Les-API,
Leveranseinformasjon,"*Testes av SVV i ATM:*
 * NVDB-6283: Sjekk Vegkart-lenkene i observasjonene
 * NVDB-6397: Sjekk skrivefeil
 * NVDB-6489: Verifiser ingen vit.notasjon på relativ posisjon i lenke fra beskrivelsen (sammenlign ATM og Prod)
 * NVDB-6443: Sjekk dokumantasjon for gater ([https://nvdbapiles-v3.test.atlas.vegvesen.no/dokumentasjon/openapi])

*Testes av leverandør i ATM:*
 * NVDB-6472: Sjekk at riktig cache-Control-header benyttes. Bruk gjerne Vegkart.

Saker i leveransen som ikke er nevnt over trenger ikke eksplisitt å testes.

*MERK* at noen av sakene krever at NVDBIND V3 2021.2.0 er levert og reindeksert (https://www.vegvesen.no/jira/projects/NVDB/versions/17403)",NVDB-6937,Les-API,
Melding om å benytte v3 for import,"Dersom det er oppgitt url til API v2 ved import skal det gis ein beskjed om at det ikkje lenger er støtte for det.
h3. Forslag til tekst:

_API-v2 kan ikke lenger benyttes for import fra NVDB. Benytt API-v3 for å importere._
_Ved bruk av Vegkart for å generere API-URL, må den nå hentes fra ""Nye"" Vegkart. Vegkart-2019 kan ikke lenger benyttes for å generere API-URL til import._",,,
Fjerne støtte for API-v2-import,"Import av objekt med API-v2 skaper potensielt problemer med multigeometri. Det skjer dersom det er feil i NVDB frå før. Det skjer ikkje ved å bruke v3.Det er ikkje behov for å støtteimport over v2, så vi kan unngå problemet med å fjerne støtte for import.",NVDB-6937,Datafangst,
Klipp/kopier vegsysref med kommunenummer for KPS,"Funksjonen for å klikke på veg og kopiere vegreferanse gir ikkje unik referanse for KPS. For å gjere det må den ha med evt. kommunenummer i referansen.
h2. Beskrive behov:

[https://www.vegvesen.no/_attachment/2912425/binary/1360253?fast_title=Faktaark+-+Vegreferansesystemet+i+NVDB.pdf]

Ref ERF veg OK

Fungerer slik det skal i vegkart og API

 

KPS-veger derimot blir som faktaarket sier ikke unike uten kommunenummer.

Bare for å ha klarlagt det, så nei folk vet ikke hva kommunen heter nødvendigvis og langt mindre kommunenummer.

 

Kan bruke der jeg bor som eksempel

PV91596 S1D1 m88

Som går ut fra

SV439 S1D1 m321

 

Disse blir ikke unike uten prefikset 4 sifret kommunenummer

Tilfeldigvis er privatvegen unik i norge men skogsbilvegen finnes i 18 kommuner

 

 

Eksempeloppslag på PV1S1D1 viser hvordan dette da selvsagt ikke blir unikt

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@311259,6915208,4/hva:~(~(id~915))/hvor:~(vegsystemreferanse~(~'PV1S1D1))]

 

Men at kommunenummer må være del av områdeoppslaget  (I vegkart er ikke kommune nummer søkbart kun kommunenavnet)

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@261088,6729184,9/hva:~(~(id~915))/hvor:~(kommune~(~3443)~vegsystemreferanse~(~'PV1S1D1))]

 

 

En veldig stor andel av oppdragene kommer inn med stedfestinger langs vegnettet, veldig ofte i form av excel ark.

Selv om jeg i tunge stunder har tenkt at excel burde avskaffes i denne etaten er nok ikke det sannsynlig at vil skje så vi vil fortsette å få inn stedfestinger på denne måten.

 

Vi har testet litt nå i forbindelse med Militærøvelsen Joint Viking 2021

 

Der vi sendte ut følgende hjelpetekst for «sikker» stedfesting av strekninger.

Hele poenget her er klikk og kopier uten menneskelige feil

 
|Åpne vegkart|+[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@744529,7639849,5]+|
|Enkel bruksanvisning for vegkart:|+[http://www.vegdata.no/vegkart/brukerveiledning/]+|
|For innlegging i lista|Klikk i kartet for å få ønsket fra posisjon.|
| |Kopier med knappen til høyre|
| |Lim inn i de angitte kolonnene i regnearket|
|+[FRA_KOPIERT|https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@744529,7639849,5]+| | | |
|TIL_KOPIERT| | | |

  !klipp-lim.png!

Dersom denne metodikken kan nyttes også for KPS veger hadde dette forenklet men da må minimum kommunenummeret legges på for KPS vegene i Vegkart

Helst burde også Kortformen berikes med kommunenummer for disse vegene KPS.

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/915?segmentering=true&kartutsnitt=257987.477%2C6775502.963%2C258622.478%2C6775812.857&vegsystemreferanse=SV439S1D1&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

 

<lokasjon>

<kommuner>

<kommune>3411</kommune>

</kommuner>

<fylker>

<fylke>34</fylke>

</fylker>

<vegsystemreferanser>

<vegsystemreferanse>

<vegsystem>

<id>1002451341</id>

<versjon>1</versjon>

<vegkategori>S</vegkategori>

<fase>V</fase>

<nummer>439</nummer>

</vegsystem>

<strekning>

<id>-1</id>

<versjon>-1</versjon>

<strekning>1</strekning>

<delstrekning>1</delstrekning>

<arm>false</arm>

<adskilte_løp>Nei</adskilte_løp>

<trafikantgruppe>K</trafikantgruppe>

<fra_meter>0.0</fra_meter>

<til_meter>1587.317</til_meter>

<retning>MED</retning>

</strekning>

<kortform>SV439 S1D1 m0-1587</kortform>

</vegsystemreferanse>

</vegsystemreferanser>

 

Alternativet blir at dette må «Trekkes» ut og behandles særskilt på uttrekksklienter.

Geodata AS jobber konkret med en slik klient og vi er i dialog med dem.

KORTFORM er der basis ID for bygging av Rute datasett

 

Setter Jan Kristian også på kopi siden han har holdt i tråden på NVDB Uttrekk arbeidet.

 

Med hilsen
 Roger Bakkestuen

Statens vegvesen, Transport og samfunn
 Transportutvikling, Geodata 3
 *Besøksadresse:* Industrigata 1, Lillehammer
 *Mobil:* +47 94833636 *epost:* [roger.bakkestuen@vegvesen.no|mailto:roger.bakkestuen@vegvesen.no]
 [www.vegvesen.no|http://www.vegvesen.no/] *epost:* [firmapost@vegvesen.no|mailto:firmapost@vegvesen.no]",NVDB-6937,Vegkart,
Aggregering av kontraktsområder og riksvegruter,"/omrader/kontraktsomrader og /riksvegruter antar det er ett objekt per kontrakt. 
Aggreger objekter som tilhører samme kontrakt. 
Utlisting av alle objektene i kontrakten blir ny responsrevisjon.",NVDB-6937,Les-API,
Nye regler for KOSTRA veglengder,"Regelverket for beregning av veglenger har vært  uklart, nå har vegnettsgruppa talt: 

Vi teller med kryssdeler, og typeveg=kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun og veglenketype=hoved. 

Vi teller IKKE med sideanlegg, konnekteringslenker og _adskilte løp=Mot_. 

Dette er nesten, men ikke helt slik NVDB rapporter gjør det nå, tror jeg. 

{'sideanlegg': 'false', 'trafikantgruppe': 'K', 'detaljniva': 'VT,VTKB', 'adskiltelop': 'med,nei', 'typeveg': 'kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun', 'historisk': 'true', 'tidspunkt': '2020-12-31', 'veglenketype': 'hoved'}

 

Unntaket her er 4-feltsveg-rapporten, der det ikke gir mening å ta med kryssdeler. ",NVDB-6826,Rapportgenerator,
Merkelig systemfeil-tilfelle i STM,"h2. Observasjon

1) Endringssett https://nvdbapiskriv-stm.utv.atlas.vegvesen.no/kontrollpanel/#/jobs/view/ecd15d89-14e7-4273-a6d6-89db2c8dded8 havner i SYSTEMFEIL, men det er uklart hvorfor. Hendelsesloggen ser ikke helt frisk ut.

2) Et annet eksempel fra PROD: https://nvdbapiskriv.atlas.vegvesen.no/kontrollpanel/#/jobs/view/9f07a32a-f9a7-431d-8adf-7671e1486782. Endringssettet er i status SYSTEMFEIL, men hendelsesloggen ser OK ut.

h2. Analyse

1) Ser ut til at AutoPro eller Atlas-versjonen i STM ble avbrutt under behandling av dette endringssett da ny versjon ble rullet ut 2/2 kl 13:45. Det er rundt dette tidspunktet de merkelige innslagene dukker opp i hendelsesloggen. Ved oppstart prøver ActiveMQ å sende start-meldingen på nytt. Dette kommer muligens i konflikt med at JobRecoveryService forsøker å tilbakestille endringssett som har vært i status RUNNING for lenge. Finner ingen logger fra AutoProd da de ikke er indeksert av Splunk. Finner heller ingenting i Atlas-loggene. 

2) Det kastes exception ved anrop LDAP-API rundt 28/1 kl 22:44:37 ifølge Splunk:

https://loggsentralen.vegvesen.no/loggsentralen/en-GB/app/SVV_nvdbapis/search?q=search%20index%3D%22svvpnvdbapis%22%209f07a32a-f9a7-431d-8adf-7671e1486782%20sourcetype%3D%22nvdbapis-stacktrace%3ANA-log%22&display.page.search.mode=smart&dispatch.sample_ratio=1&earliest=1609455600&latest=1612442456&sid=1612453134.125629_C5996C14-FEA3-4A85-B277-7060A0DC991F

{code:java}
com.google.common.util.concurrent.UncheckedExecutionException: javax.ws.rs.ProcessingException: javax.net.ssl.SSLException: Connection reset
	at com.google.common.cache.LocalCache$Segment.get(LocalCache.java:2203)
	at com.google.common.cache.LocalCache.get(LocalCache.java:3937)
	at com.google.common.cache.LocalCache.getOrLoad(LocalCache.java:3941)
	at com.google.common.cache.LocalCache$LocalLoadingCache.get(LocalCache.java:4824)
	at com.google.common.cache.LocalCache$LocalLoadingCache.getUnchecked(LocalCache.java:4830)
	at no.vegvesen.vt.nvdb.apiskriv.security.CachingLdapGateway.getUserProfile(CachingLdapGateway.java:32)
	at no.vegvesen.vt.nvdb.apiskriv.security.DefaultPermissionManager.hasPermission(DefaultPermissionManager.java:91)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.FeatureTypeAuthorizationJobFilter.doFilter(FeatureTypeAuthorizationJobFilter.java:31)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:133)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:466)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$0(JobWorker.java:177)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.processJobAndRetryOnException(JobWorker.java:230)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$1(JobWorker.java:144)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:143)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.rabbitmqclient.RabbitMqSubscription.onMessage(RabbitMqSubscription.java:181)
{code}

Dette fører helt korrekt til SYSTEMFEIL, men det er ingen spor etter det i hendelsesloggen i Kontrollpanelet. Siste innslag der er 11:46 samme dag med info om VENTER_PÅ_LÅS.
Et søk i EVENT og EVENT_THREAD-tabellene viser imidlertid at SYSTEM_ERROR er registrert der:

{code:sql}
select et.title, e.time, e.code
from nvdbapiskriv.event_thread et, nvdbapiskriv.event e
where et.job_id = '9f07a32a-f9a7-431d-8adf-7671e1486782'
and e.code = 'SYSTEM_ERROR'
and e.thread_id = et.id
order by e.time;
{code}

Når Kontrollpanelet skal hente hendelser sendes requesten https://nvdbapiskriv.atlas.vegvesen.no/kontrollpanel/data/events?jobid=9f07a32a-f9a7-431d-8adf-7671e1486782 som resulterer i et søk i databasen med default ""page"" på [0, 1000]. Dersom det, som i dette tilfellet, er flere enn 1000 events, vil de overskytende ikke bli returnert til Kontrollpanelet.

h2. Løsning

I jobs.services.js i frontendkoden for Kontrollpanelet utvides funksjonen getJobEvents() til å hente alle ""pages"" med hendelser, ikke bare de 1000 første.
",NVDB-6937,Skriv-API,
Format på desimaltall i xml-svar fra api bør forandres,"""Hei, Jeg tror jeg har oppdaget en liten feil. Jeg fikk problemer med parsing av XML som returneres fra denne https://nvdbapiles-v3.atlas.vegvesen.no/veg/batch?veglenkesekvenser=0.00065647%40578625 . <relativPosisjon> inneholder en desimalverdi på ""scientific notation"", og det liker ikke XML-parseren min. I følge dette http://books.xmlschemata.org/relaxng/ch19-77057.html så er det heller ikke tillatt i XML. Akkurat for min applikasjon så trenger jeg ikke egentlig denne verdien, så jeg kan alltids parse den som streng i stedet for tall. Men det burde kanskje vært rettet?""

Vi burde legge om fra vitenskapelig notasjon på denne verdien slik at ikke brukere opplever unødvendig trøbbel med parsing.",NVDB-6937,Les-API,
Spørredb får ikke oppdatert datakatalog ved datakatalogoppdatering,Den delen av Spørredatabasen som lagrer data laster datakatalogen kun ved oppstart. Så gammel datakatalog blir brukt etter datakatalogoppdatering.,NVDB-6937,NVDB-IND,
Skjemaendring kreves for Solr-8.7.0,En liten skjemaendring som kreves for Solr-8.7.0,NVDB-6937,NVDB-IND,
Oppgrader curator,"NVDBIND og API bruker ganske gammel versjon av [Curator|https://curator.apache.org/]. 
Når nvdb-shared definerte Solr 8.7.0 ble nyere versjon av zookeeper dratt inn, som ikke er kompatibel med den versjonen av Curator som er brukt. Oppgrader til siste versjon av Curator.",NVDB-6937,NVDB-IND,
Gyldig fra dato vises feilaktig på last ned som SOSI-modal,"gyldighet er noe som er relevant for NVDB, men ikke for nedlasting av sosi

 

!image-2021-01-29-14-01-38-417.png!",NVDB-6937,Datafangst,
"Skriv avviser med feil sideposisjon, men den ser rett ut","h2. Observasjon

Se kontrollpanel her:

[https://nvdbapiskriv.test.atlas.vegvesen.no/kontrollpanel/#/jobs/view/2461d66e-e1b9-49d5-bc54-ad3d95a9fc51]

Endringssettet er avvist med STEDFESTING INNENFOR MOROBJEKT MEN ANNEN SIDEPOSISJON, men både mor og datter har sideposisjon H

h2. Analyse

Endringssettet avvises med:

{noformat}
2a9a2d4d-a74a-4413-b9c9-794abdfb2ae7 Feil STEDFESTING INNENFOR MOROBJEKT MEN ANNEN SIDEPOSISJON Objektet har stedfesting som fullstendig dekkes av morobjekt av type Skiltpunkt (95), men sideposisjonene er forskjellige: nvdbId 1011052124:2
{noformat}

Vegobjekt av type skiltplate (96), med tempId 2a9a2d4d-a74a-4413-b9c9-794abdfb2ae7, registreres i endringssettet med følgende stedfesting:

{code:json}
""punkt"": [
    {
        ""posisjon"": 0.21161864,
        ""sideposisjon"": ""H"",
        ""veglenkesekvensNvdbId"": 72234
    }
]
{code}

I feilmeldingen refereres til morobjekt av type Skiltpunkt (95), med nvdbId 1011052124 som delvis oppdateres i samme endringssett. Oppdateringen består i å legge til skiltplaten over som datterobjekt. Stedfestingen til skiltpunktet i NVDB er:

{code:xml}
<punkt veglenkesekvensNvdbId=""72234"" posisjon=""0.21161864""/>
{code}

Stedfestingen er altså i samme punkt på vegnettet, men datterobjektet har angitt sideposisjon H, mens morobjektet ikke har angitt sideposisjon. Assosiasjonstypen som styrer sammenkoblingen mellom skiltpunkt og skiltplate krever at tverrposisjon er identisk, derfor avvises endringssettet. ",NVDB-6937,Skriv-API,
Datakatalog og områder cachet i en uke,"For endepunktene som støtter ETag (alt under /omrader/ untatt /omrader/gater, og /vegobjekttyper/) har vi før satt header «Cache-Control: public, max-age=604800». 
Denne sier til nettleseren at responsen kan caches i en uke. Dette kan føre til at brukere ikke får opp de kontraktsområdene og riksvegrutene de forventer.
Endres til «Cache-Control: must-revalidate», som gjør at det alltid blir gjort et kall til Les, men om det ikke er noen endringer vil responsen være 304 uten innhold.",NVDB-6937,Les-API,
E2E-test: Få karttestene til å virke igjen,"Karttestene har ikke fungert, dvs klikk og sjekk av selve kartet og objekter her, på en stund pga Cypress ikke har latt et klikk traversere ned til selve objektene. Dette skjedde ved overgangen fra ol 5.x til ol 6.x.

Etter litt initiell testing ser det nå ut til at Cypress (oppgradert mye siden siste forsøk) klarer å propagere et klikk ned til objektene i kartet.

Oppgaven går på å få karttestene for desktop og mobil opp å kjøre igjen (desktop_map.js og mobile_map.js).",NVDB-6937,Vegkart,
Bedre sortering/utvalg i søk,"h2. Problemstilling
Det er fast rekkefølje på søkeresultat i vegkart. Objekttype - Fylke - Kommune - Riksvegrute --- 
Resultat visast i den rekkefølje og når det er søkt med tal, som til dømes 50. Det er truleg ikkje så mange som søker etter kommune etter nummer, og i alle fall ikkje utan å skrive inn alle fire siffer.
Resultat på til dømes kontraktområde som ofte starter med nummer kan då visast legre oppe når søket er på tal.
 
h2. Supportsak
Stian Soberg
@StianSoberg_gitlab[Jan 14 11:20|https://gitter.im/nvdb-vegdata/vegkart-v3?at=60001ad981c55b09c708ef46]
Hva har skjedd med søkefunksjonen i v-3 når den ikke lenger gir mest logiske resultat først. Hvis jeg f.eks søker på 34(01) får jeg opp objekt typer og kommuner som i utgangspunktet ikke har 34 i seg først?
 
!https://avatars2.githubusercontent.com/u/33287065?v=4&s=30!
 
magnusoy
@magnusoy[Jan 18 15:16|https://gitter.im/nvdb-vegdata/vegkart-v3?at=6005985b14cec811eca7616f]
I datakatalogen er alle typer vegobjekt også søkbare med ID, så når du f.eks skriver 34 så søker den også blant id'ene til datakatalogen. Her finner du en komplett liste av alle typer vegobjekter i datakatalogen: [https://datakatalogen.vegdata.no/?sort=nummer]
!https://secure.gravatar.com/avatar/3c5f9ea584e5f524bc484a2098835d28?s=30&d=identicon!
 
Stian Soberg
@StianSoberg_gitlab[12:02|https://gitter.im/nvdb-vegdata/vegkart-v3?at=600ff6d46244ee1450b29574]
Det er greit men jeg ønsker jo og finne kontrakts område 3402 og det kommer jo ikke opp som forslag en gang før på tredje sifferet og da nederst på lista med mange kontraktsområder over seg som ikke har noe med sifrene og gjøre.",NVDB-6937,Vegkart,
Oppdatere dokumentasjon om feilkoder,"Feilkodene 400-404 er beskrevet i dokumentasjon. 405, 409 og 413 må også legges inn.",NVDB-6937,Datafangst,
Endre feilkode 409 til 405,"Vi har forskjellige 409-feilkoder:
 # Feature collection [id] is currently being processed, please try again later
 # Feature collection [id] is not created from API, can't replace this collection
 # Feature collection [id] is not created from API, can't add to this collection

Ved nummer 1 er noe under behandling, så klienten må vente.

Ved nummer 2 og 3 sier vi at ressursen klienten prøver å skrive til er ikke skrivbar.

 

Nummer 2 og 3 kan endres til 405 - method not allowed.

 ",NVDB-6937,Datafangst,
Merkelig stedfesting på kabel,"h2. Observasjon

Sjekker ut [kabel 1006210802|https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@267707,7031168,17/hva:~(~(id~92))/vegnett:~'geometri+~()/valgt:1006210802:92] (i Sandmoenkrysset) i forbindelse med testing av NVDB-6226. I NVDB så er denne kabelen stedfestet både på E6 og F704, så ville se hvordan det gikk med Skriv.

Jeg får stedfesting på kun E6, og det er jo fint. Men jeg får stedfesting både på påkjøringsrampa like ved som det er naturlig å stedfeste til, pluss et lite segment til, som så vidt jeg kan se er langt unna. Det er stedfestet på veglenkesekvens-ID 72191, en rampe som dekker hele utstrekning av kabel, men i tillegg på 2641856 som etter det jeg kan se er ut av rundkjøringa på vei ned mot 72191.

I tillegg blir opptegning i Datafangst veldig rar, mulig at vi fikser det selv, eller så er det kanskje noen feil med returnert WKT.
h3. Request
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <parametere>
        <maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>
        <beregnSideposisjon>true</beregnSideposisjon>
    </parametere>
    <vegobjekter>
        <vegobjekt typeId=""92"" tempId=""616d4b15-7926-43d3-a9ee-5342b0996a9c"">
            <egenskaper>
                <egenskap typeId=""4792"">
                    <geometri>
                        <srid>5973</srid>
                        <wkt>LINESTRING (267675.72 7031216.75 143.033, 267675.14 7031214.92 142.943, 267673.59
                            7031210.17 142.783, 267672.22 7031205.7 142.633, 267672.17 7031205.47 142.603, 267671.84
                            7031204.53 142.383, 267671.32 7031202.89 142.783, 267671.51 7031200.49 143.293, 267671.69
                            7031198.06 143.843, 267671.74 7031196.02 144.243, 267671.56 7031193.22 144.603, 267671.29
                            7031190.16 144.923, 267671.38 7031189.83 144.893, 267676.3 7031170.83 143.753)
                        </wkt>
                        <datafangstdato>2018-05-23</datafangstdato>
                        <referansegeometri>false</referansegeometri>
                        <kvalitet>
                            <målemetode>96</målemetode>
                            <målemetodeHøyde>96</målemetodeHøyde>
                            <nøyaktighet>50</nøyaktighet>
                            <nøyaktighetHøyde>25</nøyaktighetHøyde>
                            <synbarhet>0</synbarhet>
                        </kvalitet>
                    </geometri>
                </egenskap>
            </egenskaper>
            <gyldighetsperiode>
                <startdato>2021-01-24</startdato>
            </gyldighetsperiode>
        </vegobjekt>
    </vegobjekter>
</stedfest>{noformat}
h3. Response
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""616d4b15-7926-43d3-a9ee-5342b0996a9c"">
        <stedfesting>
            <oversikt>
                <veg>
                    <kategori>E</kategori>
                    <fase>V</fase>
                    <nummer>6</nummer>
                </veg>
                <lengde>223.76061914181741</lengde>
            </oversikt>
            <linje veglenkesekvensNvdbId=""72191"" fra=""0.07582129"" til=""0.51927188"">
                <sideposisjon>H</sideposisjon>
                <geometri>
                    <srid>5973</srid>
                    <wkt>LINESTRING (267747.187957764 7031104.19374847, 267744.73 7031100.99, 267740.27 7031096.68,
                        267735.19 7031093.21, 267729.6 7031090.65, 267723.75 7031089.11, 267720.931610107
                        7031088.64801025, 267717.52 7031088.57, 267714.284393311 7031088.5679245, 267710.640045166
                        7031089.17991638, 267702.7 7031091.39, 267699.156890869 7031092.53531647, 267691.46 7031094.96,
                        267689.27 7031095.72, 267687.11 7031096.55, 267685.1 7031097.39, 267682.86 7031098.45, 267680.8
                        7031099.51, 267678.78 7031100.64, 267676.79 7031101.85, 267674.85 7031103.13, 267672.96
                        7031104.47, 267671.12 7031105.88, 267669.33 7031107.36, 267667.59 7031108.9, 267665.9
                        7031110.49, 267664.28 7031112.15, 267662.72 7031113.87, 267661.22 7031115.65, 267659.78
                        7031117.48, 267658.43 7031119.39, 267657.15 7031121.36, 267655.97 7031123.37, 267654.88
                        7031125.44, 267653.89 7031127.55, 267652.98 7031129.71, 267652.18 7031131.9, 267651.48
                        7031134.13, 267650.87 7031136.39, 267650.37 7031138.67, 267649.96 7031140.96, 267649.65
                        7031143.28, 267649.46 7031145.61, 267649.37 7031147.94, 267649.38 7031150.29, 267649.55
                        7031153.56, 267649.9 7031156.82, 267650.14 7031158.43, 267650.69 7031161.05, 267650.92
                        7031162.05, 267651.57 7031164.63, 267651.8 7031165.52, 267652.74 7031169.01, 267653.72
                        7031172.49, 267654.17 7031174.02, 267654.75 7031175.94, 267655.82 7031179.4, 267655.98
                        7031179.89, 267656.94 7031182.83, 267657.91 7031185.72, 267658.09 7031186.24, 267659.3
                        7031189.64, 267660.54 7031193.02, 267661.84 7031196.4, 267662.18 7031197.26, 267663.18
                        7031199.74, 267664.55 7031203.08, 267665.97 7031206.39, 267666.95 7031208.6, 267667.43
                        7031209.69, 267668.95 7031212.97, 267669.51 7031214.18, 267670.49 7031216.23, 267671.69757602253
                        7031218.708708678)
                    </wkt>
                </geometri>
            </linje>
            <linje veglenkesekvensNvdbId=""2641856"" fra=""0.30178672"" til=""1.0"">
                <sideposisjon>H</sideposisjon>
                <geometri>
                    <srid>5973</srid>
                    <wkt>LINESTRING (267751.38 7031117.87, 267751.2 7031117.01, 267750.59 7031114.55, 267749.71
                        7031110.42, 267748.34 7031106.41, 267747.85 7031105.18, 267747.187957764 7031104.19374847)
                    </wkt>
                </geometri>
            </linje>
        </stedfesting>
    </vegobjekt>
</stedfestingResultat>{noformat}
h2. Analyse

API Les sin ruteberegner gir følgende resultat:

!VisRute.png|thumbnail!

Kabelen er markert i gult, mens beregnet rute vises i blått. Ruten gir mening fordi den starter på veglokasjonen som er nærmest geometriens start og slutter på veglokasjonen som er nærmest geometriens slutt. API Skriv masserer responsen ved å fjerne konnekteringslenkesegmenter og finner deretter lengste sammenhengende delrute innenfor samme veg, i dette tilfellet EV6. Responsen fra Skriv blir dermed to sammenhengende segmenter som representerer hele rampen fra avkjøring EV6 helt fram til rundkjøringen.

Dette er en stedfesting som forventet gitt geometrien til kabelen. Det merkelige resultatet må tilskrives kabelgeometrien kombinert med den litt kinkige vegsituasjonen i området. API Skriv kan ikke forventes å produsere ""perfekt"" stedfesting for alle situasjoner og denne må nok manuelt stedfestes i etterkant ved å angi EV6 som ønsket veg. I så fall produserer API Skriv ""perfekt"" stedfesting, det vil si bare den delen av rampen som kabelen kan projiseres ned på.

 

*Løsning*

Tar vare på mer enn bare nærmeste veglenke for start og endepunkt, og lagt til et steg som sjekker om kalkulert rute er mer enn 3 ganger lengre enn innsendt geometri. I tilfelle dette slår til forsøkes det med alternative endepunkt.",NVDB-6937,Les-API,
Får ikke stedfestet på angitt gangveg,"h2. Observasjon

Ikke noe resultat for denne i prod, der vegobjekt ligger rett over gangveg. Kan ha noe med angitte typeVeg å gjøre.

(!) I ATM får jeg stedfesting, men på feil veg. Datafangst sender ikke med noe for typeVeg der av en eller annen grunn, men en kurve som ligger rett over gangvegen burde vel kanskje bli plassert der også uten valg av typeVeg?
h3. Request
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <parametere>
        <maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>
        <veger>
            <veg>
                <kategori>F</kategori>
                <fase>V</fase>
                <nummer>503</nummer>
            </veg>
        </veger>
        <typeVeger>
            <typeVeg>GANG_OG_SYKKELVEG</typeVeg>
            <typeVeg>SYKKELVEG</typeVeg>
            <typeVeg>GANGVEG</typeVeg>
            <typeVeg>GÅGATE</typeVeg>
            <typeVeg>FORTAU</typeVeg>
            <typeVeg>TRAPP</typeVeg>
            <typeVeg>GANGFELT</typeVeg>
        </typeVeger>
        <beregnSideposisjon>true</beregnSideposisjon>
    </parametere>
    <vegobjekter>
        <vegobjekt typeId=""791"" tempId=""f307a11a-914c-4fe1-9aa7-243b389a87c6"">
            <egenskaper>
                <egenskap typeId=""8874"">
                    <geometri>
                        <srid>25833</srid>
                        <wkt>LINESTRING (-14834.69 6534556.01 101.76, -14832.67 6534555.61 101.86, -14830.65 6534555.78
                            101.96000000000001, -14828.82 6534555.9 102.08, -14825.04 6534557.39 102.33, -14817.71
                            6534561.69 102.88, -14813.19 6534562.85 103.2, -14806.37 6534563.72 103.56, -14797.5
                            6534565.06 103.97, -14790.01 6534566.39 104.31, -14783.12 6534567.87 104.62, -14775.27
                            6534569.93 104.95, -14765.22 6534572.91 105.35000000000001, -14756.02 6534576.13 105.65,
                            -14747.5 6534579.43 105.87, -14737.46 6534583.84 106.09, -14723.24 6534590.77
                            106.35000000000001, -14710.86 6534596.88 106.60000000000001, -14690.99 6534606.6
                            106.85000000000001, -14672.52 6534615.66 107.03, -14654.34 6534624.55 107.12, -14643.56
                            6534629.69 106.93, -14635.5 6534632.97 106.72, -14635.37 6534633.02 106.74000000000001)
                        </wkt>
                        <datafangstdato>2020-12-09</datafangstdato>
                        <referansegeometri>false</referansegeometri>
                        <kvalitet>
                            <målemetode>96</målemetode>
                            <målemetodeHøyde>96</målemetodeHøyde>
                            <nøyaktighet>5</nøyaktighet>
                            <nøyaktighetHøyde>5</nøyaktighetHøyde>
                            <synbarhet>0</synbarhet>
                        </kvalitet>
                    </geometri>
                </egenskap>
            </egenskaper>
            <gyldighetsperiode>
                <startdato>2021-01-22</startdato>
            </gyldighetsperiode>
        </vegobjekt>
    </vegobjekter>
</stedfest>
{noformat}
h3. Response
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""f307a11a-914c-4fe1-9aa7-243b389a87c6"">
        <feil>
            <feil kode=""STEDFESTING_MISLYKTES"">
                <melding>Ingen relevant vegnettstilknytning ble funnet med de angitte parametere</melding>
            </feil>
        </feil>
    </vegobjekt>
</stedfestingResultat>
{noformat}

h2. Analyse

Requesten over gir samme respons (STEDFESTING_MISLYKTES) både i ATM og PROD.

Se https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@-14759,6534574,18/vegnett:~'geometri+~()/valgt:3296617:2:1

Geometrien ligger rett over gang- og sykkelveg FV508. Requesten ber om stedfesting for ulike ""gående"" typeveger for veg FV503. Det finnes ikke slike i området. API Les returnerer derfor ingen rute, hvilket er korrekt.

Dersom vegparameteren droppes blir det generert rute (og stedfesting) på FV508.
",NVDB-6937,Skriv-API,
Leveranseinformasjon,"*Testes av SVV i AT:*
 * NVDB-6427: Ta inn NVDB-mor og -datter for å sammenkoble. Se at dette går bra. Tips til test i kommentar på saken.
 * NVDB-6366: Regresjonstest av å stedfeste objekter som kan og kan ikke ha sideposisjon. Sjekk datafanen etter stedfesting.
 * NVDB-6055: Gjenta testbeskrivelse i saken og verifiser at det fungerer

*Testes av leverandør i AT:*
 * NVDB-5228: Verifiser at multigeometri mot API ikke går. Sjekk at endring på NVDB-objekt med multigeo kan endres og lagres. Se testbeskrivelser i saken.
 * NVDB-6301: Sjekk at https returneres i ressurser fra API - og ikke http
 * NVDB-6211: Sjekk at kall mot Les og Skriv inneholder unik ID. Sjekk i Splunk at denne finnes igjen.

Saker i leveransen som ikke er nevnt over trenger ikke å eksplisitt testes i ATM",NVDB-6937,Datafangst,
"Feil formatering på søkeord i openapi ""try it out""","I les-apiets openapi (https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/ ) finner man under diverse mulige søk en ""try it out"" funksjon som hjelper brukere å sette sammen spørringer. 

De funker dog ikke spesielt bra nå fordi de formaterer søkeord med stor forbokstav (Kommune), mens apiet kun godtar små forbokstaver (kommune). 

Dette resulterer i at man som regel får en respons som ligner denne:

{code:java}
[
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Fylke"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Kontraktsomrade"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Overlapp"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Veglenkesekvens"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Riksvegrute"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Vegsystemreferanse"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: dybde"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Kommune"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Kartutnitt"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  },
  {
    ""code"": 4013,
    ""message"": ""Ukjent parameter: Polygon"",
    ""help_url"": ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Vegobjekter""
  }
]
{code}


Utover dette har vi fått flere tilbakemeldinger på openapi ""test it out"":

""Det er også litt forvirrende at eksemplet her: https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Posisjon/get_veg tilsynelatende skal ha som input en liste av vegsystemreferanser, men det er uklart hvilket format som skal brukes for dette. Eksempelet som kommer fram (List [ ""EV6S1D1m341"", ""R6S1D1m1300KD4m129"", ""SP12S1D3m123"" ]) godtas ikke, ei heller forenklingen til EV6S1D1m341, R6S1D1m1300KD4m129, SP12S1D3m123; da får man beskjed om at ""Må inneholde bare en vegreferanse"".""
",NVDB-6937,Les-API,
Ikke treff på vegobjektsøk med plassering 0 eller 1 på veglenkesek,"bq. ""Hei! Her er en bug-report på filtrering på veglenkesekvens. Det ser ut som at filtreringen sliter med grenseverdier for veglenkeposisjon - når relativ veglenkeposisjon er 0 eller 1 får man ikke treff. Men når man bytter ut 0 og 1 med 0.000001 og 0.999999, så finner man dem. I stedfestingen til objektene står det at de skal ha startposisjon/sluttposisjon lik 0/1, så de skulle ha dukket opp opprinnelig. Eksempler i tråd.""
bq. ""https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/616?veglenkesekvens=0@1993681""
bq. ""https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/616?veglenkesekvens=1@444329""

Det er altså slik at kall mot /vegobjekter/id?veglenkesekvens=0 eller 1 aldri gir treff.",NVDB-6937,Les-API,
Søke på navn i tilknyttet bruker,"I dag kan vi berre legge til brukarnamn (e-post eller SVV-brukar) når ein brukar skal knyttast til kontrakt.

Dette er spesielt problematisk med p-brukarar som ikkje ka nidentifiserast med brukaren på anna måte enn oppslag i oversikt.

Veg å kunne søke på regsitrerte brukarar i Datafangst vil dette vere lettare for alle.",NVDB-6937,Datafangst,
Stedfestingsfeil for kontraktsområde oppdages ikke,"h2. Observasjon

V2 har meldt feil ved full reindeksering og indeksering av vegnett, nærmere bestemt segmentering for starten av lenkesekvens 2539075:

2021-01-19 01:32:43 [segmenter] ERROR NetComponentBuilder - Error segmenting RefLinkPart(CONNECTION, [2539075@0.0|mailto:2539075@0.0] - 0.00444528) 2021-01-12 - null, [no.vegvesen.nvdb.segmentation.SpatialObjectCollection@5fdfb971|mailto:no.vegvesen.nvdb.segmentation.SpatialObjectCollection@5fdfb971], [ConnectedContract\{id=1008541173, version=1, startPos=0.0, endPos=0.00444528, startDate=2020-05-22, endDate=null}, ConnectedContract\{id=1008541173, version=1, startPos=0.0, endPos=1.0, startDate=2020-05-22, endDate=null}, ConnectedContract\{id=1009963296, version=8, startPos=0.0, endPos=1.0, startDate=2021-01-12, endDate=null}, ConnectedContract\{id=1009963299, version=2, startPos=0.0, endPos=1.0, startDate=2020-04-24, endDate=null}], [], 2020-06-22T10:01:20

svvpnvdbind01:/data/vegkart/logs/nvdbind>

Etter litt forskning fant jeg fram til at kontraktsområde med NVDB_ID=1008541173 hadde interntt overlappende lokasjonsattributter, og det ser ut som om dette er innført i følgende endringssett, sendt inn fra NovaPoint 7. desember 2020:

Id: 60f8b281-e8a5-44e9-b5f1-2c9228d7a7c2 
Ekstern referanse: Joakim_Vegnett 2020-12-07 20-27
Mottatt: 2020-12-07 22:05:12
Klient: Novapoint
API-versjon: 3
Eier: joamoy

Resultatet ble to lokasjonsattributt på lenkesekvens 2539075, akkurat som angitt over.

Etter at denne interne overlappen ble eliminert, feiler ikke lenger indeksering av vegnett i V2.

Jeg mener dette er en datafeil for stedfesting, som bør oppdages av validering i Skriv, og
 * enten føre til feilmelding og avvisning av endr.settet,
 * eller elimineres av logikk i Skriv (evt. med NB-melding).

Er det definert noen validering i Skriv som burde fanga opp dette?

Dette burde kanskje også vært oppdaget/forhindret i Novapoint.

h2. Analyse

Jeg tror hovedproblemet i denne saken er hvordan API Skriv håndterer styringsregelen “retningsrelevant”. Regelen angis med 0/1 (Nei/Ja) i datakatalogen. API Skriv tolker “Ja” som at retning MÅ angis på stedfestingselementer (og avviser endringssettet om det mangler), mens “Nei” tolkes som at retning ikke må angis, men endringssettet avvises ikke dersom retning likevel er satt. I dette konkrete caset er det snakk om vegobjekter av type Kontraktsområde, som har retningsrelevant=Nei og API Skriv godtar dermed vilkårlig bruk av retningsattributten i stedfestingen.

API Skriv har allerede optimalisering av overlappende og butt-i-butt stedfestingselementer, men denne algoritmen tar hensyn til retning, sideposisjon og kjørefelt. Er det overlapp i veglenkesekvensintervallet mellom to stedfestingselementer vil det derfor ikke utføres sammenslåing dersom de har ulik retning, sideposisjon eller kjørefelt.

Jeg tenker at fix’en her er å tolke retningsrelevant på (nesten) samme måte som sideposisjonrelevant og kjørefeltrelevant. Altså tolke verdi 0 som “KAN IKKE” og avvise bruk av retning, og tolke verdi 1 som “MÅ” og kreve retning (som nå). Alternativt kunne vi også tolket verdi 1 som “KAN”, slik som for sideposisjon og kjørefelt, og ikke avvise dersom retning mangler. I mitt hode virker imidlertid ikke det siste alternativet korrekt slik jeg forstår datakatalogen.

Tilbakemelding fra Vilhelm B og Hans Anton:

Vi er langt på veg enig i det du skriver, Tore. Imidlertid er det slik at nesten alle stedfestinger i NVDB har verdi, DIR=1 (MED), for retning, og vi mistenker at det kan finnes tilfeller der verdi er forventa, selv om objekttypen ikke er retningsrelevant. Vi ber derfor om at Skriv inntil videre for objekttyper uten retningsrelevans ikke tar hensyn til verdien på retning, mens retningsrelevante objekttyper fortsatt valideres som i dag. Dersom dette medfører at lokasjonsattributt kan slås sammen, men har ulike verdier for retning, som i eksemplet med Kontraktsområde, lagres verdien 1 på det sammenslåtte lokasjonsattributtet.

h2. Løsning

Endret OptimizeLocationalAttributeFilter.optimizeLocationalAttribute til å anrope ny metode Locational.optimizeNonDirectional når vegobjekttypen ikke er retningsrelevant.  Implementerte Locational.optimizeNonDirectional og LocationalLine.optimizeNonDirectional.",NVDB-6937,Skriv-API,
Redesign av sammenkobling med mindre fokus på i kontrakt vs i NVDB,"Dagens design for brukergrensesnittet for sammenkobling er fra da Datafangst hovedsaklig var kun for å legge nye vegobjekter inn i NVDB, og det var lite import til kontrakt eller endring av innsendte vegobjekter.

Dette brukergrensesnittet bør designes på nytt ut i fra dagens forutsetninger, der det ikke er et like skarpt skille mellom i eller utenfor NVDB.

Det er også etterspurt en ny type kobling (NVDB-6387) som det kan være naturlig å se i sammenheng her.",NVDB-6937,Datafangst,
Geometri på segmenter opprydding,"Etter NVDB-6283 er prodsatt kan det ryddes opp skjema (fjerne ubrukte felt) og fjernes noe kode i SolrRoadObjectSegmentDecoder som er kommentert med TODO.

Fjern de gamle feltene fra segmentFields i QueryBuilders i api-et.",NVDB-6937,NVDB-IND,
V2/V3 Arealberegning med withAreaFromAttributeOrCrossSection feiler,"Lengdeberegning med metoden withAreaFromAttributeOrCrossSection gir 30-55% større verdier enn det vi får med python-kode som gjør tilsvarende summering av V4-rapporten.

Akkurat nå vet vi ikke om det er python-koden, NVDB rapporter eller begge som er feil. 

Jeg har prøvd å finne en fasit for Mur (62 Støttekonstruksjon) med vedlagte python-script (forutsetter en del biblioteker). Beregnigen i detalj: 

Areal fra 521 objekter med Areal-egenskap: 58773.0
 -Areal fra 192 objekter der vi bruker lengde- og høydeegenskap: 19831-
 -Areal fra 131 vegsegmenter (121 objekt) der vi bruker vegnettlengde  X høydeegenskap 14844-
 -Areal totalt: 93447 <= NVDB rapporter har 190093 (E+R) + 25946 (G/S) = 216039 m2.-   

Dobbeltsjekker lengden langs veg også
 Lengde ut fra egenskap: 44214
 Lengde ut fra vegnett: 16388
 Lengde totalt: 60602

 ",,Rapportgenerator,
Oppgradere frontend-bygg til webpack 5,"Ny major versjon av webpack har vært ute en stund, og på et eller annet tidspunkt må vi oppgradere. Dette haster ikke, men kan være en fin oppgave for å bli bedre kjent med byggesystemet.

https://webpack.js.org/migrate/5/",NVDB-6937,Datafangst,
Gater er ikke dokumentert ,/omrader/gater mangler i dokumentasjonen. Sjekk også at det er dokumentert i vegobjekt og veglenkesegment-respons.,NVDB-6937,Les-API,
Synliggjøre søk på vegreferanse og NVDB-ID,"Det er ikkje synleg i Vegkart at man kan gjere søk på vegreferanse. Det er noko som ein berre må vite om.
Kan dette synleggjerast for brukar?",NVDB-6937,Vegkart,
Feil automatisk sideposisjon ved rundkjøring,"h2. Observasjon

Mail fra Jon Bråten (Jon.Braten@afgruppen.no) på datafangst-support 15/1 16:04. Usikker på om dette er noe vi får gjort noe med, i alle fall så lenge Datafangst kun stedfester enkeltobjekter, men dere får se på det.
----
Jeg tror det må være en bug i den automatiske sideposisjoneringen. Her har den registrert Høyreposisjon når det skal være venstre. Det kan virke som det noe rot med stedfesting og rundkjøring da det for så vidt er korrekt at rekkverksenden er Høyre når den kun er stedfestet i rundkjøringen. Det oppstår et problem når rekkverket også er stedfestet  utenfor rundkjøringen og retningen da er motsatt.

 

  !image006.jpg! 

  !image007.jpg! 

Som dere ser her så er jo kurven stedfestet både på rundkjæringen og rettlinjen, mens rekkverksenden kun er i rundkjøringen.

  !image008.jpg! 

Kan dere sjekke dette?

 

For moro skyld så kjørte jeg gammel stedfesting på kurvene og tvang de inn på rundkjøringen. Da forsvant de feilmeldingene og jeg fikk registrert alt i NVDB.

h2. Analyse

Svært tidkrevende å reprodusere dette caset da det verken er angitt X-Request-ID, request/respons fra stedfestingstjenesten eller vegobjekt-id.

Reproduserte stedfestingen ved å hente det jeg tror er nevnte rekkverk fra https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/5/1013166898/1.

Rev ut geometrien herfra og kjørte denne requesten mot stedfestingstjenesten:

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <parametere>
        <maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>
        <veger>
            <veg>
                <kategori>F</kategori>
                <fase>V</fase>
                <nummer>409</nummer>
            </veg>
        </veger>
        <typeVeger>
            <typeVeg>ENKEL_BILVEG</typeVeg>
            <typeVeg>KANALISERT_VEG</typeVeg>
            <typeVeg>RAMPE</typeVeg>
            <typeVeg>RUNDKJØRING</typeVeg>
        </typeVeger>
        <beregnSideposisjon>true</beregnSideposisjon>
    </parametere>
    <vegobjekter>
        <vegobjekt typeId=""5"" tempId=""2d1c0a30-04dc-4073-8b1b-3de6d90590a9"">
            <egenskaper>
                <egenskap typeId=""4714"">
                    <geometri>
                        <srid>25833</srid>
                        <wkt>LINESTRING Z(138628.19052113325 6501111.248446529 65.34, 138630.21257454116 6501111.353813271 65.31, 138630.24246977415 6501111.350909486 65.31, 138630.40481480188 6501111.365317872 65.31, 138630.77933024504 6501111.389295003 65.3, 138630.97157050506 6501111.400799604 65.29, 138631.0323288992 6501111.404957117 65.29, 138631.08312221547 6501111.410082555 65.29, 138631.15384568705 6501111.413272136 65.29, 138631.40587641223 6501111.418969172 65.29, 138631.52739319962 6501111.4272841895 65.29, 138631.88903977763 6501111.422334016 65.28, 138631.93983309355 6501111.427459453 65.28, 138631.98965848138 6501111.422619813 65.28, 138632.03048671992 6501111.428713181 65.28, 138632.2616193599 6501111.426380993 65.27, 138632.57150469162 6501111.406340303 65.26, 138632.61233292992 6501111.412433671 65.26, 138632.63226308487 6501111.410497814 65.26, 138633.0019388807 6501111.384649556 65.25, 138633.15238297085 6501111.380095715 65.25, 138633.19224328082 6501111.376224005 65.25, 138633.22213851317 6501111.373320222 65.25, 138633.38157975272 6501111.357833374 65.24, 138633.75028761796 6501111.32202004 65.23, 138633.80011300527 6501111.317180402 65.23, 138634.11802755413 6501111.27624163 65.22, 138634.3362913286 6501111.244982139 65.21000000000001, 138634.37615163805 6501111.241110428 65.21000000000001, 138634.40604687022 6501111.238206643 65.21000000000001, 138634.48479956115 6501111.220498141 65.21000000000001, 138634.851571567 6501111.164754657 65.2, 138634.94028933498 6501111.146078228 65.19, 138634.97018456686 6501111.143174442 65.19, 138634.9901147216 6501111.141238588 65.19, 138635.01904202555 6501111.128369725 65.19, 138635.21737564355 6501111.099046091 65.19, 138635.57224671397 6501111.024340378 65.17, 138635.93611493253 6501110.93870166 65.12, 138636.02386477188 6501110.910060155 65.1, 138636.29901522218 6501110.843097868 65.09, 138636.58316282107 6501110.765202573 65.08, 138636.66191551049 6501110.747494072 65.08, 138637.012914865 6501110.632928053 65.07000000000001, 138637.15948723827 6501110.588513904 65.06, 138637.19837961905 6501110.574677117 65.07000000000001, 138637.36391421844 6501110.518362034 65.06, 138637.7149135708 6501110.403796016 65.05, 138637.76280310075 6501110.379026224 65.05, 138638.06397706678 6501110.269299846 65.04, 138638.32529072434 6501110.163445181 65.03, 138638.4130405619 6501110.134803678 65.02, 138638.75117105083 6501109.991310356 65.01, 138638.86688026343 6501109.939834916 65.01, 138639.08833361138 6501109.837851962 65, 138639.4155310942 6501109.685361496 64.99, 138639.44445839728 6501109.672492636 64.99, 138639.7607228745 6501109.511005021 64.98, 138639.97124321654 6501109.40002492 64.97, 138640.08598450036 6501109.3385844035 64.97, 138640.41027819784 6501109.15619871 64.95, 138640.49609217886 6501109.107627057 64.95, 138641.972242016 6501108.149459128 63.93)</wkt>
                    </geometri>
                </egenskap>
            </egenskaper>
            <gyldighetsperiode>
                <startdato>2021-01-13</startdato>
            </gyldighetsperiode>
        </vegobjekt>
    </vegobjekter>
</stedfest>
{code}

Responsen var:

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""2d1c0a30-04dc-4073-8b1b-3de6d90590a9"">
        <stedfesting>
            <oversikt>
                <veg>
                    <kategori>F</kategori>
                    <fase>V</fase>
                    <nummer>409</nummer>
                </veg>
                <lengde>21.80261827381404</lengde>
            </oversikt>
            <linje veglenkesekvensNvdbId=""2809662"" fra=""0.90136236"" til=""0.96668122"">
                <sideposisjon>V</sideposisjon>
                <geometri>
                    <srid>5973</srid>
                    <wkt>LINESTRING (138619.65458841514 6501109.175709964, 138620.3 6501106.52, 138620.64 6501105.14, 138621.62030895 6501100.80423356)</wkt>
                </geometri>
            </linje>
            <linje veglenkesekvensNvdbId=""2809650"" fra=""0.8607037"" til=""0.95206637"">
                <sideposisjon>H</sideposisjon>
                <geometri>
                    <srid>5973</srid>
                    <wkt>LINESTRING (138635.00007580407 6501095.289942364, 138635 6501095.29, 138631.99 6501096.77, 138629.24 6501097.55, 138625.72 6501097.84, 138623 6501097.55, 138622.39 6501097.4)</wkt>
                </geometri>
            </linje>
        </stedfesting>
    </vegobjekt>
</stedfestingResultat>
{code}

Beregnet stedfesting er korrekt plassert delvis på konnekteringslenke koblet til rundkjøringen og en lenke i rundkjøringen. Sideposisjon er også korrekt beregnet for hvert av elementene relativ til de to lenkeretningene.

Den delen av stedfestingen som er inne i rundkjøringen har sideposisjon H, det samme som rekkverksenden som nevnes over. Slik jeg tolker caset blir rekkverksenden avvist fordi den ikke har samme sideposisjon som rekkverket inne i rundkjøringen. Dette valideres av constraint'ene CoveredByParent og CoversChild. Begge delegerer til klassen InsideParentEvaluator for å finne eventuelle feil. Her ser det ut til at det ikke tas hensyn til at sideposisjon (og kjørefelt) kan variere når stedfestingen består av flere elementer. Sammenligningen gjøres mellom sideposisjon hentet fra første element for begge vegobjekter og de er jo forskjellige.

h2. Løsning

InsideParentEvaluator oppdateres til å matche korrekte stedfestingselementer mot hverandre når sideposisjon (og kjørefelt) sammenlignes.",NVDB-6937,Skriv-API,
Ruteberegning av rekkverk,"Se vedlagt SOSI. Denne stedfestes i Datafangst gjennom Skriv/Les. Her er to utvalgte rekkverk med observasjoner.
h2. KURVE 3

Her går rekkverket langs en veglenkesekvens som man forventer den stedfestet til. Men muligens er ene enden nærmere en annen veglenkesekvens som gjør at stedfestingen ser litt ""unødvendig ut"". Se skjermbilde KURVE3.png vedlagt som viser ruteberegningen fra [https://nvdb-vegdata.github.io/nvdb-visrute/ATM/]

Resultat: [ 0.0-0.66325399@805009, 0.73497357-1.0@805010 ]

POST [https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><veger><veg><kategori>R</kategori><fase>V</fase><nummer>555</nummer></veg></veger><typeVeger><typeVeg>KANALISERT_VEG</typeVeg><typeVeg>ENKEL_BILVEG</typeVeg><typeVeg>RAMPE</typeVeg><typeVeg>RUNDKJØRING</typeVeg><typeVeg>GATETUN</typeVeg></typeVeger><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""5"" tempId=""e67748ae-ea03-40c0-8b45-4fdcc317ee69""><egenskaper><egenskap typeId=""4714""><geometri><srid>25833</srid><wkt>LINESTRING (-32323.43 6733673.33 0, -32320.38 6733670.95 0, -32318.4 6733667.91 0, -32316.55 6733665.26 0, -32314.96 6733661.82 0, -32314.3 6733658.12 0, -32314.030000000002 6733654.41 0, -32314.43 6733650.98 0, -32315.36 6733647.54 0, -32316.68 6733643.3 0, -32327.66 6733634.7 0, -32337.05 6733626.7700000005 0)</wkt><referansegeometri>false</referansegeometri><kvalitet><målemetode>45</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>100</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-01-15</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>
{noformat}
POST [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""start"":null,""slutt"":null,""geometri"":""LINESTRING (-32323.43 6733673.33, -32314.96 6733661.82, -32315.36 6733647.54, -32316.68 6733643.3, -32337.05 6733626.77)"",""maks_avstand"":300,""omkrets"":100,""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""RV555"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2021-01-15"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
*Ny stedfesting med forankring gjennom Skriv*

Skriv har innført elementet <forankring> som spesifiserer start- og sluttpunkt i kallet mot /rute i stedet for å oppgi geometri. Ved å bruke denne så blir stedfestingen bra. Se vedlagte bilde KURVE3_medForankring.png.

POST [https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><forankring><srid>5973</srid><startWkt>POINT (-32328.88597080266 6733667.570919707)</startWkt><sluttWkt>POINT (-32340.303678489945 6733629.524711821)</sluttWkt></forankring><veger><veg><kategori>R</kategori><fase>V</fase><nummer>555</nummer></veg></veger><typeVeger><typeVeg>KANALISERT_VEG</typeVeg><typeVeg>ENKEL_BILVEG</typeVeg><typeVeg>RAMPE</typeVeg><typeVeg>RUNDKJØRING</typeVeg><typeVeg>GATETUN</typeVeg></typeVeger><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""5"" tempId=""e67748ae-ea03-40c0-8b45-4fdcc317ee69""><egenskaper><egenskap typeId=""4714""><geometri><srid>25833</srid><wkt>LINESTRING (-32323.43 6733673.33 0, -32320.38 6733670.95 0, -32318.4 6733667.91 0, -32316.55 6733665.26 0, -32314.96 6733661.82 0, -32314.3 6733658.12 0, -32314.030000000002 6733654.41 0, -32314.43 6733650.98 0, -32315.36 6733647.54 0, -32316.68 6733643.3 0, -32327.66 6733634.7 0, -32337.05 6733626.7700000005 0)</wkt><referansegeometri>false</referansegeometri><kvalitet><målemetode>45</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>100</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-01-15</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>
{noformat}
POST [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""start"":""-32328.88597080266,6733667.570919707"",""slutt"":""-32340.303678489945,6733629.524711821"",""geometri"":null,""maks_avstand"":300,""omkrets"":100,""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""RV555"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2021-01-15"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
*Spørsmål:*

Hvorfor får man ikke den ""pene"" stedfestingen man oppnår ved å bruke start- og sluttpunkt mot /rute når man i stedet benytter geometri mot /rute?

 
h2. KURVE 5

Her går rekkverket langs en veglenke i hele dens utstrekning. Stedfesting gjennom Skriv/Les klarer ikke å finne en stedfesting gjennom Datafangst.

POST [https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><veger><veg><kategori>R</kategori><fase>V</fase><nummer>555</nummer></veg></veger><typeVeger><typeVeg>GANG_OG_SYKKELVEG</typeVeg><typeVeg>SYKKELVEG</typeVeg><typeVeg>GANGVEG</typeVeg><typeVeg>GÅGATE</typeVeg><typeVeg>FORTAU</typeVeg><typeVeg>TRAPP</typeVeg><typeVeg>GANGFELT</typeVeg></typeVeger><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""5"" tempId=""b538230e-ac04-4844-bc53-a2a7b344e47d""><egenskaper><egenskap typeId=""4714""><geometri><srid>25833</srid><wkt>LINESTRING (-32350.940000000002 6733581.26 0, -32356.5 6733576.49 0, -32360.600000000002 6733572.66 0, -32365.23 6733568.43 0, -32370.920000000002 6733562.87 0, -32376.74 6733556.92 0, -32383.88 6733549.24 0, -32391.16 6733541.57 0, -32401.48 6733530.72 0, -32417.350000000002 6733513.79 0, -32445.530000000002 6733483.76 0, -32471.33 6733456.51 0, -32511.54 6733413.25 0, -32523.190000000002 6733401.08 0, -32545.54 6733377.79 0, -32567.24 6733354.38 0, -32593.96 6733326.33 0, -32615.260000000002 6733303.71 0, -32637.88 6733279.76 0, -32644.23 6733274.08 0)</wkt><referansegeometri>false</referansegeometri><kvalitet><målemetode>45</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>100</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-01-18</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>
{noformat}
Skriv forenkler geometrien til:

POST [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""start"":null,""slutt"":null,""geometri"":""LINESTRING (-32350.94 6733581.26, -32644.23 6733274.08)"",""maks_avstand"":300,""omkrets"":100,""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""RV555"",""trafikantgruppe"":null,""typeveg"":""gangOgSykkelveg,sykkelveg,gangveg,gågate,fortau,trapp,gangfelt"",""tidspunkt_start"":""2021-01-18"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}{noformat}
Her blir ingen rute funnet.

*Ny stedfesting med forankring gjennom Skriv*

Dersom vi, som over, benytter <forankring> mot Skriv - som da benytter start- og sluttpunkt i kallet mot /rute i stedet for å oppgi geometri, så går følgende kall - *og* vi få en fin rute tilbake.

POST [https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><parametere><maksimalAvstandTilVeg>300</maksimalAvstandTilVeg><forankring><srid>5973</srid><startWkt>POINT (-32349.59 6733580.2)</startWkt><sluttWkt>POINT (-32643.32670927604 6733273.268868647)</sluttWkt></forankring><veger><veg><kategori>R</kategori><fase>V</fase><nummer>555</nummer></veg></veger><typeVeger><typeVeg>GANG_OG_SYKKELVEG</typeVeg><typeVeg>SYKKELVEG</typeVeg><typeVeg>GANGVEG</typeVeg><typeVeg>GÅGATE</typeVeg><typeVeg>FORTAU</typeVeg><typeVeg>TRAPP</typeVeg><typeVeg>GANGFELT</typeVeg></typeVeger><beregnSideposisjon>true</beregnSideposisjon></parametere><vegobjekter><vegobjekt typeId=""5"" tempId=""b538230e-ac04-4844-bc53-a2a7b344e47d""><egenskaper><egenskap typeId=""4714""><geometri><srid>25833</srid><wkt>LINESTRING (-32350.940000000002 6733581.26 0, -32356.5 6733576.49 0, -32360.600000000002 6733572.66 0, -32365.23 6733568.43 0, -32370.920000000002 6733562.87 0, -32376.74 6733556.92 0, -32383.88 6733549.24 0, -32391.16 6733541.57 0, -32401.48 6733530.72 0, -32417.350000000002 6733513.79 0, -32445.530000000002 6733483.76 0, -32471.33 6733456.51 0, -32511.54 6733413.25 0, -32523.190000000002 6733401.08 0, -32545.54 6733377.79 0, -32567.24 6733354.38 0, -32593.96 6733326.33 0, -32615.260000000002 6733303.71 0, -32637.88 6733279.76 0, -32644.23 6733274.08 0)</wkt><referansegeometri>false</referansegeometri><kvalitet><målemetode>45</målemetode><målemetodeHøyde>-1</målemetodeHøyde><nøyaktighet>100</nøyaktighet><nøyaktighetHøyde>0</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2021-01-18</startdato></gyldighetsperiode></vegobjekt></vegobjekter></stedfest>
{noformat}
POST [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""start"":""-32349.59,6733580.2"",""slutt"":""-32643.32670927604,6733273.268868647"",""geometri"":null,""maks_avstand"":300,""omkrets"":100,""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""RV555"",""trafikantgruppe"":null,""typeveg"":""gangOgSykkelveg,sykkelveg,gangveg,gågate,fortau,trapp,gangfelt"",""tidspunkt_start"":""2021-01-18"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
*Spørsmål:*

Hvorfor får man stedfesting ved å bruke start- og sluttpunkt mot /rute, men ikke når man benytter geometri? I dette tilfellet burde vel også bruk av geometri finne rute?

 

 ",NVDB-6937,Les-API,
Fjern aktivitetslogging i NVDBIND V3,"NVDB-5113 deaktiverte bare opprydding, NVDBIND lagrer ennå til database.
Fjern dette.",NVDB-6937,NVDB-IND,
Rydding i hvordan Solr-request bygges,"-[532/980977947/1|https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/532/980977947/1] (startdato: 2019-10-03) er stedfestet på 0.60568412-0.60620364@885116. 
[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/580/777263582/4| 1815 Helgeland sør 2017-2032 (777263582 v3) (2020-08-31-2020-11-04)] er også stedfestet her.
Men 
[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/580/777263582/4| 1815 Helgeland sør 2017-2032 (777263582 v4) (2020-11-04)] er ikke stedfestet her. 

532/980977947/1 er beriket med «1815 Helgeland sør 2017-2032». Siden siste versjon av dette kontraktsområdet ikke er stedfestet samme sted som dette vegreferanseobjektet er det nok ikke korrekt å berike «hovedobjektet»(docType:objekt i Solr) med dette kontraktsområdet. -

Det ser ut som den opprinnelige saken skyldes at kontrakt er oppdatert, og objekter ikke er oppdatert. Så det som er beskrevet er ikke reproduserbart etter reindeksering.

Så denne endringen teste ved å kjøre full regresjonstest. Alt skal fungere som før. 
Det som er endret er at det er ryddet i hvordan Solrspørringer genereres. Slik at det er lettere å skjønne hva som skjer for /vegobjekter/X og /vegobjekter/X/statistikk med og uten segmentering aktivert.",NVDB-6937,NVDB-IND,
Migrere til Cypress 6.0,Cypress har kommet med versjon 6.0 (siste 6.2.1). I den forbindelse må noen av funksjonene (cy.request) migreres til nye funksjoner (cy.intercept) da de utgående etterhvert ikke vil støttes.,NVDB-6937,Vegkart,
Fra 1.8.2021 - Automatisk populere vegnummer i Vegsystem (915),"h2. Bakgrunn

Det store volumet når det gjelder vedlikehold av vegnettet for Kartverket er endringer og innleggelse av PV i NVDB, deriblant tildele unikt, ledig nummer for disse vegene. I dag gjøres dette parallelt i to vegreferansesystemer.

Dagens funksjonalitet for håndtering av dette på en effektiv måte, er funksjonalitet i NP/Vegnettseditoren basert på 532 Vegreferanse. 532 Vegreferanse vil fra 01.08.2021 ikke lengre ajourholdes og alle gyldige 532 objekt i NVDB, vil få satt en sluttdato. Dermed så vil dagens funksjonalitet måtte kodes om/endres.

Vegnettsgruppa og Kartverket har vurdert at den mest smidige og ikke minst fremtidsrettede løsningen, vil være funksjonalitet i SKRIV for tildeling av vegnummer for PV.

Gitt avvikling av 532 Vegreferanse 1.8.2020 så må løsningen som lages nå, fungere frem til dette skjer. Her vil man kunne benytte seg av 532 Vegreferanse – dette objektet legges på av Quadri/Vegnettseditoren og skal vedlikeholdes frem til avvikling. Viktig at det er samsvar med 915 Vegsystem frem til 01.08.
 Med kun noen måneder igjen, anses det lite hensiktsmessig å innføre ny arbeidsmetodikk rundt dette og vi ser for oss at SKRIV kan hente info. om vegnummer fra 532 Vegreferanse, som også sikrer samsvar mellom dem.

 

Det nevnt ovenfor ble utredet i saken denne er klonet fra. NVDB-6382

 

Etter 01.08.2021 skal NVDB API Skriv ikke lengre populere vegnummer ved å hente fra Vegreferanse (532), men populere via et løpenummer:
 * Nå vil vi ikke lengre ha gyldige 532 Vegreferanse å hente info fra, disse er lukket. Men, endringssettet vil kunne ha 915 Vegsystem uten nummer.
 * Her ønskes kort fortalt en funksjon i SKRIV som tildeler nummer på PV, som er unikt innenfor en kommune. Skal tildele første ledige nummer etter 99999 (nedadgående) på de objektene som mangler dette i endringssettet. Dersom neste ledige løpenummer allerede er i bruk, skal neste nummer prøves. Eventuelle ledige ""hull"" i nummersekvensen kan brukes.
 * Her må det finnes andre løsninger enn 532 Vegreferanse for å kunne hente ut info som trengs for å kunne tildele ledige, unike nummer på PV. F. eks. på 38 nye PV`er i et gitt endringssett.",NVDB-6937,Skriv-API,
Tillate sammenkobling til barn importert fra NVDB,"Hvis man importerer både mor og datter fra NVDB, så hindrer vi automatisk sammenkoblinger mellom disse typene.

Denne hindringen kan fjernes, og saken må ses i forbindelse med NVDB-6055",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Testes av SVV i ATM:*
 * NVDB-6424: Sjekk at geodata-kart vises på de ulike fanene
 * NVDB-6395: Verifiser at innloggingsdialog kun vises på ""test.vegvesen"" og ikke på ""-test.kantega""
 * NVDB-6140: Sjekk at vegobjekter listes riktig numerisk (stedfesting, sammenkobling, etc). Sjekk både nye (type PUNKT 1, PUNKT 2, PUNKT 10) og NVDB-id.
 * NVDB-6401: Verifiser at beskrivende navn vises i stedfestingsfanen om dette er togglet på. (eksempel er skiltplate)
 * NVDB-6379  Skrivefeil i feltkategori",NVDB-6937,Datafangst,
Tilpasse URL for Geodata-kart,"Karttjeneste for Geodata svarer ikke lengre på de URL'ene vi bruker, URL må tilpasses.

Ulike subdomener (brukt for at IE skal kunne laste flere samtidig) er ikke lengre i bruk, og gir HTTP 503.",NVDB-6937,Datafangst,
Inkludere konnekteringslenke og filtrere i etterkant,"h2. Bakgrunn

Saken går på at det er mange vegobjekter i Datafangst som ikke får stedfesting gjennom Skriv siden Les gir ingen rute tilbake når konnekteringslenker er satt til false. Gammel stedfesting for Datafangst ga konnekteringslenker tilbake s.a. Datafangst filtrerte selv i etterkant.

*Fra Mattermost* ([https://mattermost.kantega.no/svv/pl/8gbpzzoi77y1dpocdgr9qft4ro])

Har sett på noen vanskelige tilfeller av stedfesting med Skriv. Vedlagte SOSI (843_difficult.sos) er utdrag av større SOSI (843.sos) med noen vanskelige tilfeller. Manuell stedfesting med Skriv genererer følgende kall mot Les for utvalgte kurver. Problemet er generelt at det ikke finnes ruter. *MEN* om vi setter {{konnekteringslenker=true}} finnes det ruter (da med rutesegmenter som ikke er konnektering OG konnekteringslenker).

Gammel stedfesting finner stedfesting for alle. Er det ikke slik at vi for gammel stedfesting får konnekteringslenker, men filtrerer bort disse i Datafangst?

Hva tenker folk om å be om konnekteringslenker også for Datafangst og heller filtrere disse bort i Skriv/Datafangst etter at rute er oppnådd fra Les? Eksemplene her er typiske eksempler hvor det er veier som møtes. Alternativet her blir jo å stedfeste alle som går med Skriv og deretter velge gammel for de som ikke går. Alle 1018 objektene i 843.sos er tatt fra Prod og reflekterer reelle situasjoner vi helt sikkert kommer borti mange ganger.
 
{noformat}
KURVE 246 
{""geometri"":""LINESTRING (138553.42 6501292.32, 138554 6501288.68, 138546.53 6501278.28, 138489.17 6501242.18)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 255 {""geometri"":""LINESTRING (138554.32 6501292.18, 138572.76 6501271.68)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 258 {""geometri"":""LINESTRING (138568.71 6501250.91, 138562.89 6501231.29)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV18"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 278 {""geometri"":""LINESTRING (138591.19 6501078.74, 138598.13 6501077.81, 138601.35 6501076.33, 138604.65 6501071.57)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV18"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker
{noformat}

*Kommentar fra Tore:*

Skriv anroper Les /rute med konnekteringsparameter=JA/NEI avhengig av om vegobjekttypen tillater det. Tanken var nok opprinnelig at Les da skulle foreta denne filtreringen, men det har jo runnet en del vann i Gaula siden da. Mulig Skriv skal sende konsekvent JA her og plukke ut konnekteringslenkene etterpå selv. Dermed blir det som i gammel DF-løsning.

h2. Analyse

Min kommentar ovenfor var nok litt forhastet. Stedfestingstjenesten bruker faktisk allerede strategien som angitt over. Årsaken til at det ikke fungerer som tenkt er at requesten til Les sin rutetjeneste påføres ""konnekteringslenker"": false når det ikke skal stedfestes på konnekteringslenker (punktstedfesting), mens det *ikke* angis ""konnekteringslenker"": true når det kan stedfestes på konnekteringslenker (strekningsstedfesting, med filtrering i etterkant).

h2. Løsning

Setter eksplisitt ""konnekteringslenker"" i requesten til Les, enten verdien fra RouteParams.isConnectingRefLinksAllowed() er true eller false",NVDB-6937,Skriv-API,
Migrere til Cypress 6.0,Cypress har kommet med versjon 6.0 (siste 6.2.1). I den forbindelse må noen av funksjonene (cy.request) migreres til nye funksjoner (cy.intercept) da de utgående etterhvert ikke vil støttes.,NVDB-6937,Datafangst,
Leveransesak - Vegkart V3 2021.2.0,"SVV tester i ATM
 * Gang- og sykkleveg mangler under gående og syklende. NVDB-6259
 * Legge til tekst og feilkode ved ""Ulykke""NVDB-6263
 * Link til support i feilmelding https://www.vegvesen.no/jira/browse/NVDB-6463
 * Vise startdato for objekt https://www.vegvesen.no/jira/browse/NVDB-6441
 * Søke på NVDB-ID https://www.vegvesen.no/jira/browse/NVDB-5809",NVDB-6937,Vegkart,
v2 returnerer forskjellig resultat med samme spørring,"Hei,

Det ser ut til at vi får forskjellige data når vi spør på det samme fra nvdbV2 , ser ut til at dette har startet engang i helgen.

Har vedlagt respons data vi får ved kall til [https://nvdbapiles-v2.atlas.vegvesen.no/vegobjekter]/\{id} 

Zip filen inneholder en katalog for alle spørringer med dato for hver gang vi gjør spørringer og det ser ut som vi får litt random resultat.

Filnanvnene er URL til tjeneste med parametere og med page nummer for de paginerte dataene ( : ,? og / er erstattet med _ )

f.eks for uthenting av vinterdriftsklasse returnerer kallet under 25 i metadata:

*20210111_152229*\https___nvdbapiles-v2.atlas.vegvesen.no_vegobjekter_*810*_antall=250&inkluder=vegsegmenter,egenskaper&kontraktsomrade=*1815 Helgeland sør 2017-2032*_page_*1*.json

mens denne har 21:

*20210111_152241*\https___nvdbapiles-v2.atlas.vegvesen.no_vegobjekter_*810*_antall=250&inkluder=vegsegmenter,egenskaper&kontraktsomrade=*1815 Helgeland sør 2017-2032*_page_*1*.json

Det virker som vi kan få forskjellige data vegobjekttypene vi spør på ( 106,532,540,577 og 810) mellom hvert kall, kan det ha skjedd noe med indekseringen her?

mvh

morten

<[Morten.Stenseth@norconsult.com|mailto:Morten.Stenseth@norconsult.com]>",NVDB-6937,Les-API,
Polling stopper ikke når alle er stedfestet,"h2. Observasjon

Når man laster inn en type og stedfester vil POST /rest/vegobjekt/<id>/autostedfest returnere > 0 (auto stedfesting), og polling med GET /antall stopper når denne blir 0.

Hvis man stedfester og godkjenner s.a. alle objektene er grønne så vil en påfølgende automatisk stedfesting (POST /rest/vegobjekt/<id>/autostedfest) returnere 0. Imidlertid så fortsetter GET /antall å polle selv om resultatet er 0. Stopper ikke før man refresher siden. Det hjelper ikke å gå bort fra stedfestingsfanen til en annen fane.",NVDB-6937,Datafangst,
Deassosiering fører til lukking av datter,"h2. Observasjon

Sinus har problem med sletting av assosiasjon.
I endringssett 25c402a2-2dd7-4859-a5a6-30a88ec1330d skulle assosiasjon til kum 83:842987759 slettast i obejektet 79:842988050, men heile kum-objektet var lukka.
Dette er i ATM. https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/25c402a2-2dd7-4859-a5a6-30a88ec1330d

h2. Analyse

Stikkrenne (79) har en assosiasjon til Kum (83) av type KOMPOSISJON (også kjent som ""sterk kobling""). Ved lukking av 79 vil derfor alle datterobjekter av type 83 lukkes på samme dato gjennom en kaskadeoperasjon. Skriv betrakter fjerning av denne assosiasjonen i en ny versjon av 79 som konseptuelt samme sak, at mor lukkes. Derfor utføres også lukking av 83 her. Kum har ikke styringsparameter ""må ha mor"" så den kunne forsåvidt overlevd i NVDB.

Trunkering av datterobjekt etter lukking av mor håndteres av TruncateDeassociatedFeaturesEnricherFilter.

h2. Løsning

I doFilter-metoden, rett etter anrop getParentsWithRemovedChildren: Tar ut assosiasjoner til datterobjekttyper som ikke krever mor via ny metode discardChildrenNotRequiringParent.",NVDB-6937,Skriv-API,
Avviser ikke overlapp ved korrigert gyldighetsperiode,"h2. Observasjon

Endringssett aaf8beff-396c-4bba-9622-7e6bff74078b korrigerer sluttdato på et Vegsystem-objekt som allerede overlapper med et annet i NVDB (datafeil). Det er fortsatt overlapp etter korrigert sluttdato, men endringssettet blir ikke avvist.

h2. Analyse

NVDB API Skriv utfører overlappskontroll for alle vegobjekttyper som ikke tillater overlapp iht styringsparameter i datakatalogen. Vegsystem (915) tillater ikke overlapp. For å få avvist et endringssett må det være overlapp både i tid og rom (stedfesting).
 
Et søk på det aktuelle vegobjektet i transaksjonsloggen (https://nvdbapiskriv.atlas.vegvesen.no/kontrollpanel/#/tasks/transactions?time=0&featureId=1011249727) viser følgende:
 
+5025354               2021-01-06 14:33:09       groknu+ 
 
Operasjon          ObjektId              Ver.       Startdato            Sluttdato
OPPDATERT       1011249727       1             1950-01-01         2020-10-04         
 
+5027004               2021-01-07 08:29:45       hansal+
 
Operasjon          ObjektId              Ver.       Startdato            Sluttdato
SLETTET               1011249727       1             1950-01-01         2020-10-04
 
Det er altså ingen innslag for etablering av vegobjektet. Jeg antar det skjedde via et SQL-script.
 
Oppdrag 5025354 stammer fra endringssett aaf8beff-396c-4bba-9622-7e6bff74078b. Her utføres delvis korrigering av Vegsystem-objektet. Eneste endring er oppdatering av gyldighetsperiode, antagelig er det bare sluttdato som settes for å lukke vegobjektet:
 
{code:xml}
<vegobjekt typeId=""915"" nvdbId=""1011249727"" versjon=""1"">
  <gyldighetsperiode>
    <startdato>1950-01-01</startdato>
    <sluttdato>2020-10-04</sluttdato>
  </gyldighetsperiode>
  <validering>
    <lestFraNvdb>2021-01-05T12:46:34</lestFraNvdb>
  </validering>
</vegobjekt>
{code}
 
Under behandling av endringssettet finner API Skriv korrekt at det er overlapp med et annet Vegsystem-objekt i NVDB med id 1011249729. Dette har identisk stedfesting og har gyldighetsperiode 2020-10-03 ->. Etter korrigering er det altså overlappende stedfesting mellom disse to på datoen 2020-10-04. Siden stedfestingen ikke berøres av korrigeringen velger API Skriv å neglisjere overlappet og i stedet logge dette som datafeil i NVDB:
 
https://loggsentralen.vegvesen.no/loggsentralen/en-GB/app/SVV_nvdb/search?q=search%20index%3Dsvvpnvdb%20host%3Dsvvptomcat25%20OR%20host%3Dsvvptomcat26%20NvdbDataErrorReporter%201011249727&display.page.search.mode=verbose&dispatch.sample_ratio=1&earliest=1609714800&latest=1610013623&sid=1610013826.1900086_C5996C14-FEA3-4A85-B277-7060A0DC991F
 
Det kan se ut som at brukeren her har forsøkt å rette datafeilen, men bommet på lukkedato med én dag.

h2. Løsning

Tar nå hensyn til om både stedfesting og gyldighetsperiode er endret ved overlappskontroll i NoOverlapsValidator. Endret navn på støttemetoden isUnchangedLocation til isUnchangedLocationAndLifetime og la inn kontroll på om gyldighetsperiode er endret. Tilsvarende endring ble også gjort i tvillingvalidatoren NoInterOverlapsValidator. Etter denne endringen blir det kun rapportert datafeil ved overlapp når både stedfesting og gyldighetsperiode er uendret av endringssettet.",NVDB-6937,Skriv-API,
V2 ser ut til å mangle vegnett,"https://gitter.im/nvdb-vegdata/api-les-v2?at=5ff856314498e01bbf953dd2
",NVDB-6937,NVDB-IND,
segment.lengde ikke riktig ved segmentering,"Det ser ut som veglenkesegment.lengde og veglenkesegment.geometri.lengde har verdi fra orginal veglenke.
https://github.com/nvdb-vegdata/nvdb-api-client/issues/102

*Test*

Sjekk at lengde og geometri.lengde er like i disse veglenkesegmentene:
https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2721409?historisk=false&srid=6173 ",NVDB-6937,NVDB-IND,
Får ikke registrert objekt med allerede registrert datter,"h2. Observasjon

Har et Leskur og Holdeplassutrustning. Leskur trenger ikke mor, men kan være barn av Holdeplass. Hvis man registrerer Leskur først, deretter assosierer Holdeplass til barn i kontrakten (les: Leskur), så vil Registrer-knapp ligge inaktiv på eksportfanen for Holdeplass. GUI gir inntrykk av at alt er greit, men kallet /submittability_report viser at ""MISSING_RELATION_IN_CHANGESET: 1"".

For å gjenskape, importer vedlagte SOSI og følg beskrivelsen.

For å komme rundt må bruker heller assosiere til NVDB-utgaven av Leskuret, men dette er vanskelig å finne ut av selv når man klart ser - og vet - at det er Leskur i kontrakten som er det riktige Leskuret.",NVDB-6937,Datafangst,
Intern feil når NVDB-objekt er borte,"h2. Observasjon

Under registrering så hentes info inn fra API Les om ulike objekter. I et tilfelle som ble oppdaget under support-feilsøk så er det et tilfelle hvor en versjon av et objekt er borte. Type respons som mottas fra Les (HTTP 410):
{noformat}
[ { ""code"" : 4016, ""message"" : ""Feature 86180198, version 2 of type 14 gone!"", ""help_url"" : ""https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/"" } ]
{noformat}
Da reagerer Datafangst med
{noformat}
javax.ws.rs.ProcessingException: Error reading entity from input stream.
...
Caused by: com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot deserialize instance of `no.svv.nvdb.datafangst.integration.nvdbapi.binding.lesV3.Vegobjekt` out of START_ARRAY toke
{noformat}
[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.13-2021.01.06/doc/?id=AsOW13YBLuQOkdqhz7LS]

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.13-2021.01.06/doc/?id=BsOW13YBLuQOkdqhz7LT]

 ",NVDB-6937,Datafangst,
Vise beskrivende navn i stedfestingsfanen,"Når featuretoggle ""Beskrivende navn"" er satt skal beskrivende navn også vises i stedfestingsfanen.

Dette ble gjort i Angular-komponenten, men ble ikke implementert i React.",NVDB-6937,Datafangst,
Atlas-utrulling via Jenkinsfile feiler sporadisk,"Jenkins bygger applikasjonen og ruller ut i Atlas-UTV via Jenkinsfile. Dette feiler sporadisk, antagelig fordi /home/vegdata/.ac.yaml oppdateres med info fra andre byggejobber som ikke er kompatibel med NVDB API Skriv.

Jenkinsfile bør justeres slik at egen .ac.yaml etableres inne i workspace før Atlas Client-brukes. Dette er beskrevet her: https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/byggserver.html",NVDB-6937,Skriv-API,
Skrivefeil i api-doc,"https://nvdbapiles-v3.atlas.vegvesen.no/dokumentasjon/openapi/#/Datakatalog/get_vegobjekttyper_version

Datakatalog: GET /vegobjekttyper/version -> GET /vegobjekttyper/*versjon*

PS: Trenger denne tasken noe mer innhold / info?",NVDB-6937,Les-API,
Avbruddssikkerhet i JobRetryService,"h2. Bakgrunn

JobRetryService er en separat tråd som kjører i NVDB API Skriv. Den søker etter endringssett som er flagget for et nytt behandlingsforsøk, dvs. endringssett i status VENTER_PÅ_LÅS eller VENTER_PÅ_DATAKATALOG. Tråden sparkes i gang hvert 30 sekund. Dersom det inntreffer et databaseavbrudd i samme øyeblikk som søket i JOBS-tabellen vil tråden dø, og (ser det ut for) aldri starte opp igjen.

h2. Analyser

Etter å ha sett på loggene i Splunk ser det ut til at JobRetryService fortsatt kjører etter SqlException. Tråden logger hver gang den startes av ExecutionService. Loggingen stopper plutselig uten at det er spor av andre exceptions i loggen.

Javadoc for ExecutorService sin scheduleAtFixedRate-metode indikerer at det ikke gjøres nye forsøk på å starte tråden om en exception kastes mens den kjører. Det er en catch-blokk i JobRetryService.run som fanger opp eventuelle exceptions, men det er en finally-blokk som potensielt også kan feile.

h2. Løsning

Etablerer en CatchingRunnable som kapsler inn JobRetryService.run og fanger alle exceptions og logger slike.",NVDB-6937,Skriv-API,
Skru av innloggingsdialog for kantega-adresser,"Brukere som går til Kantega-domener for Datafangst får fra før beskjed om å bruke Vegvesen-adresse i stedet. For å fortsette overgangen bør vi endre kode sånn at innloggings-dialogen ikke kommer opp for Kantega-domener.

 
h2. Implementasjon

Endret innloggingsinfo til å kun vises dersom url ikke inneholder ""kantega"".",NVDB-6937,Datafangst,
Mors endrede stedfesting må endre NVDB-datters stedfesting,"h2. Observasjon

Det har vært et gjentakende problem på support i det siste med at man importerer NVDB-objekter i kontrakten (typisk rettekontraktene rundt E18 Tvedestrand-Arendal), kanskje lukker et objekt og erstatter med et annet, men ender opp med å re-stedfeste NVDB-objekter. Disse har igjen døtre som ligger i NVDB. Ofte har vi da sett at ny stedfesting skiller seg fra den eksisterende - og gjerne bare på 3. eller 4.desimal.

Det generelle problemet er at man re-stedfester et NVDB-objekt som da vil få stedfesting som ikke fullstendig dekker NVDB-datters stedfesting, men som må det.

Et eksempel fra Jon Bråten på support (05-01-21 14:01, [https://datafangst.vegvesen.no/#!/contract/db3a2eb8-8673-4184-b35e-e4a357f23753/locational2]):
{noformat}
Nå har jeg støtt på et nytt problem med rekkverk og rekkverksende. Hvorfor får jeg feil på Tilstandsgrad?
{noformat}
!bråten.png!",NVDB-6937,Datafangst,
Uforutsigbare stedfestinger når mor har feil stedfesting fra VVI,"En feil i den gamle stedfestingsmetoden som benytter VVI gjorde at objekter fikk feil stedfesting (men riktig wkt). feilen er rettet (vi bruker ikke VVI lenger) men enkelte objekter er lagret til NVDB med feil verdier. 

Når vi prøver å stedfeste døtre til disse objektene vil døtrene få stedfestinger som også er helt feil, men de vil i motsetning til mødrene også se feil ut. 

Dette kan rettes ved å restedfeste mor. Vi kan legge inn en sjekk for om stedfestingen er helt feil i forhold til en ny stedfesting med Skriv, og enten gi tilbakemelding til bruker om at mor må stedfestes på nytt, eller automatisk restedfeste mor hvis det er mulig.

Se NVDB-6225",NVDB-6937,Datafangst,
NVDBIND stoppet transaksjonsbehandling etter infrastrukturproblemer,"NVDBIND stoppet å behandle transaksjoner etter infrastrukturproblemer 29. desember. 
Det er ingen feilmeldinger i loggen. ",NVDB-6937,NVDB-IND,
Overføre vegnummer fra Vegreferanse (532) til Vegsystem (915),"h2. Bakgrunn
 
Det store volumet når det gjelder vedlikehold av vegnettet for Kartverket er endringer og innleggelse av PV i NVDB, deriblant tildele unikt, ledig nummer for disse vegene. I dag gjøres dette parallelt i to vegreferansesystemer.

Dagens funksjonalitet for håndtering av dette på en effektiv måte, er funksjonalitet i NP/Vegnettseditoren basert på 532 Vegreferanse. 532 Vegreferanse vil fra 01.08.2021 ikke lengre ajourholdes og alle gyldige 532 objekt i NVDB, vil få satt en sluttdato. Dermed så vil dagens funksjonalitet måtte kodes om/endres.
 
Vegnettsgruppa og Kartverket har vurdert at den mest smidige og ikke minst fremtidsrettede løsningen, vil være funksjonalitet i SKRIV for tildeling av vegnummer for PV.  
 
Gitt avvikling av 532 Vegreferanse 1.8.2020 så må løsningen som lages nå, fungere frem til dette skjer. Her vil man kunne benytte seg av 532 Vegreferanse – dette objektet legges på av Quadri/Vegnettseditoren og skal vedlikeholdes frem til avvikling. Viktig at det er samsvar med 915 Vegsystem frem til 01.08.
Med kun noen måneder igjen, anses det lite hensiktsmessig å innføre ny arbeidsmetodikk rundt dette og vi ser for oss at SKRIV kan hente info. om vegnummer fra 532 Vegreferanse, som også sikrer samsvar mellom dem.
 
Frem til 01.08.2021 gjelder dette:

* SKRIV sjekker om det er 915 vegsystemobjekter uten nr i endringssettet og tar tak i disse (det vil i praksis være P-veger)
* SKRIV sjekker OM det finnes gyldig 532 vegreferanse på samme lenke/sted, der hvor vi har 915 Vegsystem uten nr. (dette skal eksistere via normal ajourholdsrutine):
* SKRIV henter vegnr fra 532 Vegreferanse og overføre til vegsystem 915 på disse lenkene.

Etter 01.08.2021 skal dette endres til en annen strategi. Dette er beskrevet i sak NVDB-6428.

h2. Analyse

Det er kun Vegsystem-objekter med vegkategori P uten angitt vegnummer-egenskap som skal behandles. Alle relevante operasjoner, det vil si registrer, korriger og oppdater m/overskriv (+ delvis-varianter), skal behandles. Dette gjelder selv om korrigeringen innebærer å fjerne vegnummer-egenskapen.

Vegnummer-egenskapen populeres med verdi fra tilsvarende egenskap på den/de Vegreferanse-objekt(er) med sammenfallende stedfesting og gyldighetsperiode. Dersom det er ingen slike skal endringssettet avvises med beskrivende feilmelding tilknyttet Vegsystem-objektet i endringssettet. Dersom det er flere sammenfallende Vegreferanse-objekter og disse har ulike vegnummere skal endringssettet også avvises med beskrivende feilmelding.

Dersom Vegreferanse-objektet sin vegnummer-egenskap ikke er populert (datafeil i NVDB), skal endringssettet avvises med beskrivende feilmelding tilknyttet Vegsystem-objektet i endringssettet.

Denne følgeoppdateringen må utføres etter at det er kontrollert at Vegreferanse er heldekkende.

---

Vegreferanser hentes inn i jobben i dag via filteret RoadRefEnricherFilter i BeforeLockingPipeline. Kontroll av heldekkende Vegreferanse gjøres i RefLinkPart-constraint CoveredByRoadReference som eksekveres i AfterLockingPipeline.

h2. Løsning

Nytt FeatureFilter, RoadNumberAttributeEnricherFilter, som legges inn i AfterLockingPipeline.",NVDB-6937,Skriv-API,
Etterarbeid etter overgang til nye startscript,"For Solr, Zookeeper og NVDBIND, fjern koden som ligger igjen midlertidig, søk etter:

""/sbin/chkconfig --del""",NVDB-6937,NVDB-IND,
Skrivefeil i feltkategori,"h2. Observasjon

Det er skrivefeil i feltkategori ved val av falt i Datafanen.

!image-2020-12-22-12-20-17-569.png!",NVDB-6937,Datafangst,
Finner ikke rute for objekt den bør finne rute for,"h2. Observasjon

Vedlagt SOSI vises som vedlagte skjermbilde i Datafangst, hvor det bør gå å finne en rute. Datafangst sender POST /rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=E&vegnummer=6&fase=V&typeVeg=KANALISERT_VEG%2CENKEL_BILVEG%2CRAMPE%2CRUNDKJ%C3%98RING%2CGATETUN
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""77"" tempId=""cb09eb7f-c308-4938-b392-ae728b2e960c""><egenskaper><egenskap typeId=""4778""><geometri><srid>25833</srid><wkt>LINESTRING (272775.11 6760327.12 241.83, 272775.32 6760326.95 241.85, 272777.72 6760325.95 241.93, 272778.35 6760325.65 241.95000000000002, 272778.64 6760324.2 242.01, 272779.07 6760322.4 242.12, 272781.35 6760320.28 242.20000000000002, 272784.11 6760317.69 242.34, 272785.73 6760316.3 242.39000000000001, 272788.75 6760313.84 242.47, 272793.42 6760310 242.59, 272798.06 6760306.13 242.69, 272802.74 6760302.31 242.84, 272807.35 6760298.65 242.93)</wkt><datafangstdato>2019-05-15</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>96</målemetode><målemetodeHøyde>96</målemetodeHøyde><nøyaktighet>10</nøyaktighet><nøyaktighetHøyde>10</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-12-21</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
til Skriv som igjen sender POST /beta/vegnett/rute
{noformat}
{""geometri"":""LINESTRING (272775.11 6760327.12, 272778.35 6760325.65, 272779.07 6760322.4, 272784.11 6760317.69, 272807.35 6760298.65)"",""maks_avstand"":""300"",""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV6"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-12-21"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
til Les.

Les gir tilbake svaret _IKKE_FUNNET_RUTE_.

 

*Løsning*

I tilfellet her skyldes det at nærmeste startpunkt og sluttpunkt havner på rampe og kanalisert_veg og det er ikke mulig å få en rute mellom de. I tilfeller der resultatet er ""IKKE_FUNNET_RUTE"" gjøres det et nytt forsøk med en intern ""beholdTypeVeg"". Når det sendes inn flere typeVeg i requesten (som i tilfellet her) prøver den alle til den finner første mulig rute. Første punkt i geometrien som sendes inn i requesten brukes for å velge hvilken typeVeg som testes først.",NVDB-6937,Les-API,
Paginering på /gater,"/omrader/gater er en stor respons, legg til paginering.",NVDB-6937,Les-API,
500 og NPE ved POST til /stedfest,"h2. Observasjon

POST https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest med

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
  <parametere>
    <maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>
    <veger>
      <veg>
        <kategori>E</kategori>
        <fase>V</fase>
        <nummer>0</nummer>
      </veg>
    </veger>
    <beregnSideposisjon>true</beregnSideposisjon>
  </parametere>
  <vegobjekter>
    <vegobjekt typeId=""96"" tempId=""bdd8e197-680d-40e9-91ac-7401e12a71b2"">
      <egenskaper>
        <egenskap typeId=""4795"">
          <geometri>
            <srid>25833</srid>
            <wkt>POINT (291464.82 7038427.63 33.733744518756865)</wkt>
            <datafangstdato>2014-07-29</datafangstdato>
            <temakode>999</temakode>
            <referansegeometri>false</referansegeometri>
            <kvalitet>
              <målemetode>96</målemetode>
              <målemetodeHøyde>96</målemetodeHøyde>
              <nøyaktighet>8</nøyaktighet>
              <nøyaktighetHøyde>8</nøyaktighetHøyde>
              <synbarhet>0</synbarhet>
            </kvalitet>
          </geometri>
        </egenskap>
      </egenskaper>
      <gyldighetsperiode>
        <startdato>2020-12-17</startdato>
      </gyldighetsperiode>
    </vegobjekt>
  </vegobjekter>
</stedfest>
{code}

Gir respons 500 med payload:

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1"">
  <message>roadTypes</message>
</fault>
{code}

h2. Analyse

500-response skyldes at det kastes en NPE fordi typeVeger er null i RouteParams.withRoadTypes().

h2. Løsning

Fikset i NetElementTransforms.toRoadTypes() ved å returnere tomt EnumSet i stedet for null, når input er null.",NVDB-6937,Skriv-API,
Beregne stedfesting fra ankerpunkter,"Datafangst trenger å angi manuelle ankerpunkter for å få stedfestet vegobjekter mer presist. Skriv sin stedfestingstjeneste skal derfor godta én (punktstedfesting) eller to (strekningstedfesting) WKT-strenger med POINT-geometri i parameter-elementet som skal brukes til dette formålet. Disse benyttes til ruteberegning i stedet for egengeometrien til vegobjektene dersom de er angitt.
",NVDB-6937,Skriv-API,
tilbakemelding om vellykkede sammenkoblinger vises ikke,"h2. Observasjon

Ved sammenkobling lages det meldinger om at x antall vegobjekter har fått ny stedfesting, men meldingen vises ikke i GUI
h2. Analyse

Kan ikke finne meldingene.
h2. Løsning

Lager liste med vegobjektene som har fått ny stedfesting (roadObjectsWithUpdatedLocational).

Sender denne til frontend.

Viser fram en melding om at x antall vegobjekter har fått ny stedfesting.",NVDB-6937,Datafangst,
Manuelt angi stedfestingsposisjoner med ny stedfesting,"Det vil alltid være tilfeller der vi ikke klarer å finne en stedfesting, eller der vi ikke gjør helt det som bruker ønsker. Det bør derfor være en mulighet for å manuelt angi punkt eller start og slutt for stedfesting ved å klikke i kart, og så få dette som stedfesting tilbake med riktige vegsegmenter.

Det er mulig for Datafangst å beregne disse selv, men siden Skriv ellers gjør tilsvarende operasjoner kan det også vurderes om API i Skriv skal utvides (eller lages et nytt endepunkt) sånn at Datafangst kan sende inn koordinater eller posisjon og at Skriv lager en stedfesting av det.",NVDB-6937,Datafangst,
Test: Fullføre de automatiserte testene av Eksport,"NVDB-6175 har opprettet flere tester av SOSI- og CSV-eksport, men det står igjen å fullføre disse. det som skal gjøres:
 * Fullføre tomme tester i v3.apiExport.SosiExport
 * Fullføre tomme tester i v3.apiExport.CsvExport
 * Legge de nye testene inn i v3.apiExport.ApiExportScenario

Testene kan kjøres ved
{noformat}
/nvdb-rest-api/gradlew e2e -Denvironment=utv -DuseCase=v3Export -DtestInfo=true -DsimulationTime=900 -Dapihash=NA
{noformat}
og kjører nå nattlig mot UTV på Jenkins: [http://svvunvdbbuild02:8080/jenkins/view/NVDB%20API%20Les/job/NVDB%20Test%20Eksport%20-%20UTV/]

Under utvikling av testene kan en og en enables i usecase ""test"" ved å utkommentere aktuell test, for deretter å kjøre:
{noformat}
/nvdb-rest-api/gradlew e2e -Denvironment=utv -DuseCase=test -DtestInfo=true -DsimulationTime=900 -Dapihash=NA  
{noformat}",NVDB-6937,Eksport,
Fjern kode for å filtrere sideposisjon,For å kunne ta ut sideposisjon fra Skriv nå er det gjort en work-around i Datafangst for NVDB-6348. Når denne er deployet (etter frysperioden) så kan koden i Datafangst fjernes. Dette gjelder commit https://github.com/nvdb-vegdata/nvdb-datafangst/pull/1123/commits/8110fa6d347bf0de62e171396da38cf239f1b857,NVDB-6937,Datafangst,
Håndtere feilaktig mor fra Les,"h2. Observasjon

(fra support ved Terje Ringen)

I kontrakt [https://datafangst.kantega.no/#!/contract/c24657c8-a810-4609-b519-fd4c1ae09540/export] blir registreringen avvist med _268578406: Egenskapstypen 220077 finnes ikke i objektet._ Dette refererer til endringssettet ([https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/02563fda-4399-403c-a6bd-fb79ed7c26a8]) som er sendt inn som inneholder
{noformat}
""assosiasjoner"": [ { ""typeId"": 200077, ""tempId"": [], ""nvdbId"": [ { ""verdi"": 268578407, ""operasjon"": ""slett"" } ], ""operasjon"": ""oppdater"" }
{noformat}
men objekt 268578406 har ingen barn i NVDB ([https://www.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/89/268578406/2).] Årsaken til at Datafangst legger til denne ass-slettingen er pga at 268578407 også sendes inn og da spør DF Les om dette objektet: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/90/268578407/1?inkluder=relasjoner]

HER kan vi se at Les mener at 268578406 er mor til 268578407. Dette er en foreldre-relasjon som henger igjen. Sannsynligvis er denne relasjonen fjernet, men henger altså igjen i Les. Dermed vil DF sette på en ass-slett for denne relasjonen som Skriv ikke godtar.

Den beste løsningen er å rette dette i Les (NVDB-5713 og NVDB-6360). En alternativ løsning er å ikke ta foreldre-relasjonen for god fisk, men i tillegg sjekke på objektet som oppgis som forelder om det virkelig har dette barnet (barne-relasjonen i Les er oppdatert).",NVDB-6937,Datafangst,
Får ikke stedfestet til ønsket vegstrekning,"h2. Observasjon

(fra support ved Janet Berringer)

Vedlagte skjermbilde viser at Kum-PUNKT 4 (vedlagt SOSI) manuelt stedfestes til rundkjøring når man egentlig har valgt vegstrekning inn mot rundkjøringen. Ved automatisk så velges FG til høyre (ingen parametre satt i innstillinger). Når man så markerer ønsket veg og stedfester manuelt blir objektet knyttet til rundkjøringen.

Basert på dagens algoritme er dette naturlig. Vi sender POST /rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=F&vegnummer=420&fase=V&typeVeg=KANALISERT_VEG%2CENKEL_BILVEG%2CRAMPE%2CRUNDKJ%C3%98RING%2CGATETUN

med
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""83"" tempId=""946e95a4-8449-498a-9311-0ff4c8d88e75""><egenskaper><egenskap typeId=""4784""><geometri><srid>25833</srid><wkt>POINT (109997.57681420061 6474407.890970628 35.35)</wkt><datafangstdato>2019-03-12</datafangstdato><temakode>0</temakode><referansegeometri>false</referansegeometri><kvalitet><målemetode>96</målemetode><målemetodeHøyde>96</målemetodeHøyde><nøyaktighet>10</nøyaktighet><nøyaktighetHøyde>10</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-12-15</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
noe som gjør at Skriv tar med RUNDKJØRING i beregningen. men dette blir altså feil her.

*Mulige løsninger:*
 * Introdusere sjekkbokser for hvilke tyep veger bruker ønsker å benytte (default alle)
 * Ta hensyn til veglenkesekvens som bruker faktisk sender inn via UI i kallet POST /stedfesting (_...""roadSegment"":{""linkId"":3212989,..._). Da må evt Skriv utvides til å ta inn ønsket veglenkesekvens om dette ikke støttes.
 * Innføre parameter ""behold_typeVeg=true"" som må benyttes i Skriv OG Les.
 * annet?

En notis er at gammel stedfesting fungerer bedre i dette tilfellet.
h2. Observasjon 2

Samme support-henvendelse, analyse og løsning som over. Denne gang for Vegdekke-KURVE 26. Også vedlagt.",NVDB-6937,Datafangst,
Feil i openapi-spesifikkasjon,"Gitter: 
{quote}
Olav Dahl Solstad
@olav89
12:15
Ok. Jeg har prøvd å generere opp klientkode fra openapi-dokumentasjonen, men ser ut som det er noen ting som ikke stemmer helt i den - her er iallefall det jeg har funnet så langt:
""forenklet"" på geometri har ingen type (2 tilfeller)
""egenskapstyper"" har i vegobjekttype-endepunktet blitt til ""egenskaper""
konnekteringslenkeOk burde vel være med _ok i vegobjekttype
{quote}",NVDB-6937,Les-API,
Barn-Forelder-relasjon henger igjen,"h2. Support

Vi har nå testet «bytte av mor» både for skiltpunkt-skiltplate og rekkverk-rekkverksende vha. «Redigere kobling» i SINUS:

Det ser bra ut! NVDB SKRIV tar imot vårt endringssett og utfører «omkoblingen» som den skal. Datterobjekt kobles til ny mor og forsvinner fra gammelmora. Om man betrakter hierarkiet ovenfra og nedover.

*MEN*: Vi mener det var snakk om at det genereres en ekstra indeks fra datter-til-mor i LES. En kobling som ikke finnes i NVDB. Det kan se ut som denne indeksoppdateringen ikke utføres helt riktig. Resultatet er at sett fra datterobjektet og «oppover» så har den to mødre. Både det gamle og det nye skiltpunktet/rekkverket.

 

Sigmund Fredriksen",NVDB-6937,Les-API,
Patch for å støtte gammel og ny Skriv URL mens auth redirect fikses,"Ved utrulling av datafangst-2020.3.3.0 fikk ikke brukere til å logge inn.
releasen inneholder ny URL til API Skriv i atlas.
[~exttxa] mistenker at dette er en feil i hvordan innlogging rutes i SVV, og tar det med drift.

Vi har to mulige scenarier for å rette dette, der den ene er å rulletilbake til en tidligere release, og den andre er å patche releasen.

Etter analysering av kodeendringene som berører problemet beslutter vi å patche releasen. det innebærer at vi tilpasser koden for å også støtte gammel Skriv URL, som vil si en liten endring i hvordan vi fornyer auth token.

Vi setter da conf i PROD til å peke mot gammel skriv-url (uten atlas). Når rutingen av autentisering blir fikset senere, skal vi da kunne gå over til atlas-url uten å trenge å gjøre en ny release.",NVDB-6937,Datafangst,
Systemfeil på eksport pga overgang til Atlas,"h2. Observasjon

Gå til [https://datafangst.kantega.no/#!/contract/59f52e49-7ba9-4108-bae6-b814592b28fb/export]

Kallet GET [https://datafangst.kantega.no/rest/contract/59f52e49-7ba9-4108-bae6-b814592b28fb/nvdb_submission/registration]

gir HTTP 500 og
{noformat}
{""messages"":[""java.lang.IllegalStateException: Unexpected NVDB Write API URL: https://www.vegvesen.no/nvdb/apiskriv""]}
{noformat}",NVDB-6937,Datafangst,
Veglister feiler for kv40142 i Saltdal kommune,"Vi får denne feilmeldingen når vi tar ut vegliste, arbeid for kv40142 i Saltdal kommune, eller alle andre områder som omfatter denne vegen. Feilen skjer på normaltransport, tømmertransport og spesialtransport, både offisiell og uoffisiell. 
 
FEIL (00:00:23.116) Vegliste feilet! (java.util.NoSuchElementException: No value present)
 
Mistanken går jo primært mot en datafeil i NVDB vegnett for KV40142, den gjør jo det...  ",NVDB-6869,Rapportgenerator,
Flytt change log inn som en DF-komponent,"I dag ligger change log som en egen side på github.

Det er uheldig, fordi changelog må skrives som et eget steg i release, der noen må manuelt gå igjenom hele releasen. Istedet burde utvikler legge inn et innslag i changelog som en de av å utføre en jiraoppgave, og sjekk av changelog blir en del av QA. 
Github skal også fases ut, kodebasen flyttes til Bitbucket internt i SVV. da få vi sannsynligvis ikke like like lett offentlig tilkang til changelog.

 

Lag en changelog-komponent i DF

 - må funke med gave-ikon, slik dagens løsning gjør

 

 ",NVDB-6937,Datafangst,
Veglister feiler for kv40142 i Saltdal kommune,"Vi får denne feilmeldingen når vi tar ut vegliste, arbeid for kv40142 i Saltdal kommune, eller alle andre områder som omfatter denne vegen. Feilen skjer på normaltransport, tømmertransport og spesialtransport, både offisiell og uoffisiell. 
 
FEIL (00:00:23.116) Vegliste feilet! (java.util.NoSuchElementException: No value present)
 
Mistanken går jo primært mot en datafeil i NVDB vegnett for KV40142, den gjør jo det...  ",,Rapportgenerator,
Brukere mottar ikke epost,"h2. Observasjon

(meldt på support fra Stian Søberg)

Det har vært flere tilfeller på support av brukere som melder at de ikke mottar epost. Den ligger heller ikke i søppelposten. Jeg har selv prøvd å legge til en bruker uten å få epost.

For aktuell bruker i Søberg sitt tilfelle er denne:

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.13-2020.12.09/doc/?id=IHuzRnYBZ_myVmB8gJUe]

Fra eposten:
{noformat}
Hei 
Jeg har lagt inn noen nye brukere ved hjelp av e-post i datafangst, men får ingen mail om oppretting av passord. Det er nå gått to dager, er dette riktig? 

Brukerne det er snakk om er: 
- Innlandetfk1@gmail.com
- Innlandetfk2@gmail.com
- Innlandetfk3@gmail.com
{noformat}
h2. Løsning

Dette er fiksa ved konfigurasjonsendring i prod og ATM.
h2. Installasjon

Når versjon med denne saken rulles ut kan konfigurasjon for SMTP fjernes i config-fil i ATM og prod.",NVDB-6937,Datafangst,
Stedfesting ikke mulig på privat veg i ATM,"h2. Observasjon

Ved forsøk på stedfesting på privat veg med Skriv vil det ikke produseres kandidater på den private vegen. enten får du beskjed om at ingen kandidater finnes, eller så får du stedfesting på nærmeste hovedveg.

Eksempel på request med oppgitt veg:
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfest xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <parametere>
        <maksimalAvstandTilVeg>300</maksimalAvstandTilVeg>
        <veger>
            <veg>
                <kategori>P</kategori>
                <fase>V</fase>
                <nummer>97730</nummer>
            </veg>
        </veger>
        <typeVeger>
            <typeVeg>KANALISERT_VEG</typeVeg>
            <typeVeg>ENKEL_BILVEG</typeVeg>
            <typeVeg>RAMPE</typeVeg>
            <typeVeg>RUNDKJØRING</typeVeg>
            <typeVeg>GATETUN</typeVeg>
        </typeVeger>
        <beregnSideposisjon>true</beregnSideposisjon>
    </parametere>
    <vegobjekter>
        <vegobjekt typeId=""96"" tempId=""2d1c0a30-04dc-4073-8b1b-3de6d90590a9"">
            <egenskaper>
                <egenskap typeId=""4795"">
                    <geometri>
                        <srid>25833</srid>
                        <wkt>POINT (273354.28 7044384.03 21.73)</wkt>
                        <referansegeometri>false</referansegeometri>
                        <kvalitet>
                            <målemetode>82</målemetode>
                            <målemetodeHøyde>-1</målemetodeHøyde>
                            <nøyaktighet>100</nøyaktighet>
                            <nøyaktighetHøyde>0</nøyaktighetHøyde>
                            <synbarhet>99</synbarhet>
                        </kvalitet>
                    </geometri>
                </egenskap>
            </egenskaper>
            <gyldighetsperiode>
                <startdato>2021-01-14</startdato>
            </gyldighetsperiode>
        </vegobjekt>
    </vegobjekter>
</stedfest>{noformat}
Respons:
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""2d1c0a30-04dc-4073-8b1b-3de6d90590a9"">
        <feil>
            <feil kode=""STEDFESTING_MISLYKTES"">
                <melding>Ingen relevant vegnettstilknytning ble funnet med de angitte parametere</melding>
            </feil>
        </feil>
    </vegobjekt>
</stedfestingResultat>{noformat}

h2. Analyse

Prøvde requesten over mot API Skriv i PROD og fikk:

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""2d1c0a30-04dc-4073-8b1b-3de6d90590a9"">
        <stedfesting>
            <oversikt>
                <veg>
                    <kategori>P</kategori>
                    <fase>V</fase>
                    <nummer>97730</nummer>
                </veg>
                <lengde>0.0</lengde>
            </oversikt>
            <punkt veglenkesekvensNvdbId=""46678"" posisjon=""0.28120338"">
                <sideposisjon>H</sideposisjon>
                <geometri>
                    <srid>5973</srid>
                    <wkt>POINT (273350.57284296886 7044379.740949327)</wkt>
                </geometri>
            </punkt>
        </stedfesting>
    </vegobjekt>
</stedfestingResultat>
{code}

 ",NVDB-6937,Les-API,
Veglenkesekvenser uten strekningsdata fører til NPE,"h2. Observasjon

Beskrevet på NVDB-6340, men med feil referanse til koden.

Auto.assos i kontrakt [https://datafangst.kantega.no/#!/contract/db3a2eb8-8673-4184-b35e-e4a357f23753] mellom kontrakt-96 og NVDB-95 gjør at DF henter ned aktuelle 95-objekter fra NVDB: GET [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/95?kartutsnitt=138644.77811097656%2C6501017.379412278%2C138748.77811097656%2C6501121.379412278&inkluder=lokasjon%2Cgeometri%2Cegenskaper%2Cmetadata%2Crelasjoner&srid=UTM33]
h2. Analyse

Siden en av disse er stedfestet på veglenkesekvens 3153539 så hentes denne med GET [https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3153539|https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3153539,]

Noen av disse segmentene -har PV uten vegnummer,- vegsystemferanse uten strekningsdata, noe som gjør at DF kaster en NPE
{noformat}
java.lang.NullPointerException at no.svv.nvdb.datafangst.integration.nvdbapi.transform.NvdbReadApiTransform.toRefLinkPart(NvdbReadApiTransform.java:78)
{noformat}
78: if (part.getVegsystemreferanse().getStrekning().getRetning().equals(""MOT""))

Vi bruker retning for å vurdere om vi skal reversere wkt eller ikke.
h2. Fix

Siden vi ikke har noe strekningsdata, og ikke noen retning på disse segmentene så kan vi ikke gjøre noen antakelse om wkt skal snus eller ikke.
Det beste vi kan gjøre er å presentere wkt slik den er.

Løsningen blir da å innføre en nullsjekk og hoppe over reversering hvis retning ikke finnes. ",NVDB-6937,Datafangst,
Beregner sideposisjon når ikke sideposisjonrelevant,Stedfestingstjenesten har fått opsjon for å beregne sideposisjon. Dette gjøres imidlertid uten å ta hensyn til om vegobjekttypen er sideposisjonrelevant eller ikke. Kun vegobjekttyper som er sideposisjonrelevant kan ha sideposisjon satt i stedfestingen.,NVDB-6937,Skriv-API,
Bruk nyere Oracle driver,,NVDB-6937,NVDB-IND,
HTTP 500 ved oppslag,"*Observasjon*

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/105.json?antall=13&adskiltelop=Med]

gir bl.a. 81497572. Oppslag mot denne gir HTTP 500

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/105/81497572/6]

*Observasjon #2*

Filtrering med kontraktsområde ""30-2E01- Veilys Viken Nord 2021-2026"" gir HTTP 500:

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/96.json?kontraktsomrade=%2230-2E01-%20Veilys%20Viken%20Nord%202021-2026%22&segmentering=true&debug=true]

 

 ",NVDB-6937,Les-API,
Må logge inn igjen etter kun 30 min,"*Observasjon fra support (Kurt Johnsen)*

Bruker må logge inn igjen etter 15 min inaktivitet. Bruker har undersøkt lokalt og har følgende uttalelse:
{noformat}
Hei, 

Har hatt it hos oss og sett på saken, alt skal være i orden lokalt. Ser at hvis jeg er inaktiv (ikke bruker datafangst) i ca.15 minutter så må jeg logge inn i datafangst på nytt, husker det også var slik i begynnelsen da datafangst ble lansert men at dette ble ordnet slik at en var innlogget selv om en var inaktiv en god stund. Jeg benytte Google Chrome nettleser. 

Andre web programmer jeg logger inn i med Google Chrome fungerer fint uten at jeg må logge inn på nytt hvis jeg er inaktiv over en time. 

Kan dere se på om det er noe i datafangst en kan endre slik at en kan være innlogget lengre når en er inaktiv (ikke bruker programmet).
{noformat}
 

Testing viser at det er 30 min og ikke 15, men uansett plagsomt.",NVDB-6937,Datafangst,
Manglende vegnummer for PV skaper trøbbel,"Se diskusjon på Mattermost som starter med: [https://mattermost.kantega.no/svv/pl/nzrus33hpjys3r1mooo4fg4meh]

 

*Observasjon stedfesting*

Hvis man stedfester til PV uten vegnummer så vil intern sjekk i Datafangst kaste en HTTP 500 siden antallet tegn ""PV"" ikke er minimum 3 som f.ex ""EV6"".

Se forøvrig stedfesting av kummer i kontrakt [https://datafangst.kantega.no/#!/contract/db3a2eb8-8673-4184-b35e-e4a357f23753.] Her lar ikke PUNKT 2 seg stedfeste til PV, mens PUNKT 1 stedfestes til en KV langt unna.

*Observasjon automatisk assosiasjon*

Auto.assos i kontrakt [https://datafangst.kantega.no/#!/contract/db3a2eb8-8673-4184-b35e-e4a357f23753] mellom kontrakt-96 og NVDB-95 gjør at DF henter ned aktuelle 95-objekter fra NVDB: GET [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/95?kartutsnitt=138644.77811097656%2C6501017.379412278%2C138748.77811097656%2C6501121.379412278&inkluder=lokasjon%2Cgeometri%2Cegenskaper%2Cmetadata%2Crelasjoner&srid=UTM33]

Siden en av disse er stedfestet på veglenkesekvens 3153539 så hentes denne med GET [https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3153539|https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3153539,]

Noen av disse segmentene har PV uten vegnummer, noe som gjør at DF kaster en NPE
{noformat}
java.lang.NullPointerException at no.svv.nvdb.datafangst.integration.nvdbapi.transform.NvdbReadApiTransform.toRefLinkPart(NvdbReadApiTransform.java:78) 

se linje 87: part.getVeglenkenummer()
{noformat}
Se søk
{noformat}
ttps://vegdata.kantega.no/kibana/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:'2020-12-07T10:00:00.000Z',mode:absolute,to:'2020-12-07T10:11:59.999Z'))&_a=(columns:!(_source),index:'datafangst-logs-*',interval:auto,query:(language:lucene,query:'HOSTNAME:datafangst.kantega.no%20AND%20%22db3a2eb8-8673-4184-b35e-e4a357f23753%22'),sort:!('@timestamp',desc))
{noformat}
h2. Løsning

Fra @havwig: _Tre tegn for vegnummer er bare et krav i vår interne kode, og bare pga en antakelse som ble gjort for lenge siden. Dropp det kravet og gjør litt testing på at ikke noe annet ramler ut._

 ",NVDB-6937,Datafangst,
Duplikat punktstedfesting fra /rute,"h2. Observasjon

Følgende request går til API Les:
{noformat}
POST https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute
Accept: application/json
X-Client: NVDB API Skriv
Content-Type: application/json
X-Request-ID: ab753475-50df-4521-9fb0-b071f5632f51
svvguid: 55f97a59-b4e8-c095-dc9a-8391c2252ac1
{""geometri"":""POINT (140947.43 6497139.56)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-12-04"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
Responsen er:
{code:json}
{
    ""vegnettsrutesegmenter"": [
        {
            ""href"": ""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/22197"",
            ""metadata"": {
                ""startdato"": ""2020-03-02""
            },
            ""veglenkesekvensid"": 22197,
            ""startposisjon"": 0.24049489,
            ""sluttposisjon"": 0.24049489,
            ""kortform"": ""0.24049489@22197"",
            ""veglenkenummer"": 10,
            ""sluttnode"": ""2962986"",
            ""type"": ""HOVED"",
            ""detaljnivå"": ""Vegtrase og kjørebane"",
            ""typeVeg"": ""Enkel bilveg"",
            ""typeVeg_sosi"": ""enkelBilveg"",
            ""feltoversikt"": [
                ""1"",
                ""2""
            ],
            ""geometri"": {
                ""wkt"": ""POINT Z(140935.99 6497172.559 5.946)"",
                ""srid"": 5973
            },
            ""lengde"": 0.0,
            ""fylke"": 42,
            ""kommune"": 4203,
            ""vegsystemreferanse"": {
                ""vegsystem"": {
                    ""id"": 1002106964,
                    ""versjon"": 1,
                    ""vegkategori"": ""F"",
                    ""fase"": ""V"",
                    ""nummer"": 409
                },
                ""strekning"": {
                    ""id"": 1003423684,
                    ""versjon"": 1,
                    ""strekning"": 1,
                    ""delstrekning"": 1,
                    ""arm"": false,
                    ""adskilte_løp"": ""Nei"",
                    ""trafikantgruppe"": ""K"",
                    ""meter"": 2183.773,
                    ""retning"": ""MED""
                },
                ""kortform"": ""FV409 S1D1 m2184""
            },
            ""kontraktsområder"": [
                {
                    ""id"": 775462797,
                    ""nummer"": 910,
                    ""navn"": ""0910 Aust-Agder elektro og veglys 2018-2023""
                },
                {
                    ""id"": 980782098,
                    ""nummer"": 920,
                    ""navn"": ""0920 Arendal 2020-2025""
                },
                {
                    ""id"": 596780270,
                    ""nummer"": 903,
                    ""navn"": ""0903 Arendal vest 2016-2021""
                }
            ],
            ""riksvegruter"": []
        },
        {
            ""href"": ""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/22197"",
            ""metadata"": {
                ""startdato"": ""2020-03-02""
            },
            ""veglenkesekvensid"": 22197,
            ""startposisjon"": 0.24049489,
            ""sluttposisjon"": 0.24049489,
            ""kortform"": ""0.24049489@22197"",
            ""veglenkenummer"": 11,
            ""startnode"": ""2962986"",
            ""type"": ""HOVED"",
            ""detaljnivå"": ""Vegtrase og kjørebane"",
            ""typeVeg"": ""Enkel bilveg"",
            ""typeVeg_sosi"": ""enkelBilveg"",
            ""feltoversikt"": [
                ""1"",
                ""2""
            ],
            ""geometri"": {
                ""wkt"": ""POINT Z(140935.99 6497172.559 5.946)"",
                ""srid"": 5973
            },
            ""lengde"": 0.0,
            ""fylke"": 42,
            ""kommune"": 4203,
            ""vegsystemreferanse"": {
                ""vegsystem"": {
                    ""id"": 1002106964,
                    ""versjon"": 1,
                    ""vegkategori"": ""F"",
                    ""fase"": ""V"",
                    ""nummer"": 409
                },
                ""strekning"": {
                    ""id"": 1003423684,
                    ""versjon"": 1,
                    ""strekning"": 1,
                    ""delstrekning"": 1,
                    ""arm"": false,
                    ""adskilte_løp"": ""Nei"",
                    ""trafikantgruppe"": ""K"",
                    ""meter"": 2183.773,
                    ""retning"": ""MED""
                },
                ""kortform"": ""FV409 S1D1 m2184""
            },
            ""kontraktsområder"": [
                {
                    ""id"": 775462797,
                    ""nummer"": 910,
                    ""navn"": ""0910 Aust-Agder elektro og veglys 2018-2023""
                },
                {
                    ""id"": 980782098,
                    ""nummer"": 920,
                    ""navn"": ""0920 Arendal 2020-2025""
                },
                {
                    ""id"": 596780270,
                    ""nummer"": 903,
                    ""navn"": ""0903 Arendal vest 2016-2021""
                }
            ],
            ""riksvegruter"": []
        }
    ],
    ""metadata"": {
        ""antall"": 2,
        ""lengde"": 0.0,
        ""status"": 2000,
        ""status_tekst"": ""KOMPLETT""
    }
}
{code}
Samme punktstedfesting er angitt to ganger.

 

*Løsning*

Samme punkt ble gitt ut 2 ganger fordi det var slutten på en lenke og starten på neste lenke (veglenkenummer er forskjellig i de 2 i responsen). Lagt til et steg som fjerner punkter med samme stedfestning.",NVDB-6937,Les-API,
Mulighet for å endre navn på kontraktgrupper,Sjå tittel,NVDB-6937,Datafangst,
Kontrollere rettigheter i REST-API,"Kontrollere at bare de med riktig rolle får tilgang til riktige funksjoner.

Rolle 9_system_admin skal gi tilgang til alle funksjoner
Rolle 0_bruker_fagdata skal ikke ha tilgang til alle funksjoner

I løsninger er dette foreløpig kodet til å bruke andre roller, siden våre brukere i UTV ikke har fått disse to rollene, og vi heller ikke har testbrukere som har disse rollene.",NVDB-6937,Skriv-API,
Opprette en enkelt vegobjekttype i NVDB,"Bomstasjon er en enkel vegobjekttype som kan brukes som case. Innebærer ikke låsing.

Akseptansekriterier:
- Vegobjekt finnes i NVDB og transaksjonslogg reflekterer dette.
",NVDB-6937,Skriv-API,
Synkronisering med NVDB Data ut,"Jobbstatus skal oppdateres med info om NVDB Data ut-indeksen er oppdatert.

Løsningsforslag fra møte med Data ut, 22.1:
Skrive-API eksponerer en REST-tjeneste som Lese-APIet kan anrope med informasjon om transaksjoner som er ferdig indeksert. Payloaden skal inneholde nok informasjon til at jobben kan identifiseres (transaksjonsid eller jobbid).

Testbeskrivelse:
- Utfør en jobb (f.eks testcase 0).
- Hent jobb (kontrollpanel eller URL). Sjekk at ""tilgjengeligILes=true"" ikke står i jobben.
- Hent tastId fra Jobb-databasen (select taskid from job where id='<jobbId>').
- POST /nvdb/apiskriv/synkroniser/<taskId>
- Hent jobb (kontrollpanel eller URL). Sjekk at ""tilgjengeligILes=true"" står i jobben under etterbehandling.",NVDB-6937,Skriv-API,
"Opprette, endre, korrigere og slette heldekkende vegobjekter","Akseptansekriterier
- Nytt vegobjekt på samme lokasjon som eksisterende vegobjekt skal sette det eksisterende vegobjektet historisk
- Nytt vegobjekt som ligger innenfor lokasjon som eksisterende vegobjekt, men som ikke dekker hele, skal dele opp det eksisterende vegobjektet s.a. neste versjon av det eksisterende vegobjektet nå inneholder to stedfestinger.

Testbeskrivelse
- Finn et vegobjekt og merk lokasjon, f.ex fartsgrense (105) på en vegstrekning. Sjekk eksisterende objekt gjennom /read/-API og NVDB 123 eller NVDB API Les / Vegkart
- Opprett request med samme type vegobjekt innenfor samme lokasjon
- Verifiser at nytt vegobjekt eksisterer på aktuell lokasjon gjennom NVDB API Ut / Vegkart eller NVDB 123. Det eksisterende objektet skal nå være delt og omslutte det nye vegobjektet.
- Verifiser gjennom /read/-API at versjonene er endret (dette vises ikke i NVDB 123)

Flere ulike scenario for heldekkende vegobjekter testes gjennom de automatiserte integrasjonstestene.",NVDB-6937,Skriv-API,
Vise versjon av datakatalogen i Dashboard,"Akseptansekriterium:

Datakatalogens versjon vises i Kontrollpanelet",NVDB-6937,Skriv-API,
filtrere ut doble stedfestinger fra Skriv,"En bug i skriv gjør at det av og til produseres doble stedfestinger for punktobjekter.
I mens vi venter på bugfix kan vi filtrere ut  duplikater på vår side.

",NVDB-6937,Datafangst,
"Punktgeometri får dobbel, identisk stedfesting","h2. Observasjon
Når vi sender inn punktobjekter til stedfesting får vi av og til to identiske stedfestinger tilbake. 
Punktobjekter skal ha bare en stedfesting, og to identiske stedfestinger er aldri gyldig for noen objekter.

Sender request til 

{code:java}
https://nvdbapiskriv.test.atlas.vegvesen.no/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=F&vegnummer=409&fase=V&typeVeg=KANALISERT_VEG%2CENKEL_BILVEG%2CRAMPE%2CRUNDKJ%C3%98RING%2CGATETUN
{code}

med 

{code:xml}
<vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
<vegobjekt typeId=""95"" tempId=""455efb6a-9495-46b3-8a5b-97d44cff7daa"">
    <egenskaper>
        <egenskap typeId=""4794"">
            <geometri>
                <srid>25833</srid>
                <wkt>POINT (140947.43 6497139.56 4.5200000000000005)</wkt>
                <datafangstdato>2020-05-26</datafangstdato>
                <referansegeometri>false</referansegeometri>
                <kvalitet>
                    <målemetode>96</målemetode>
                    <målemetodeHøyde>96</målemetodeHøyde>
                    <nøyaktighet>5</nøyaktighet>
                    <nøyaktighetHøyde>5</nøyaktighetHøyde>
                    <synbarhet>0</synbarhet>
                </kvalitet>
            </geometri>
        </egenskap>
    </egenskaper>
    <gyldighetsperiode>
        <startdato>2020-12-04</startdato>
    </gyldighetsperiode>
</vegobjekt>
</vegobjekter>
{code}

og får svar


{code:xml}
<stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt tempId=""455efb6a-9495-46b3-8a5b-97d44cff7daa"">
        <stedfesting>
            <oversikt>
                <veg>
                    <kategori>F</kategori>
                    <fase>V</fase>
                    <nummer>409</nummer>
                </veg>
                <lengde>0.0</lengde>
            </oversikt>
            <punkt veglenkesekvensNvdbId=""22197"" posisjon=""0.24049489"">
                <geometri>
                    <srid>5973</srid>
                    <wkt>POINT (140935.99 6497172.559)</wkt>
                </geometri>
            </punkt>
            <punkt veglenkesekvensNvdbId=""22197"" posisjon=""0.24049489"">
                <geometri>
                    <srid>5973</srid>
                    <wkt>POINT (140935.99 6497172.559)</wkt>
                </geometri>
            </punkt>
        </stedfesting>
    </vegobjekt>
</stedfestingResultat>
{code}

h2. Analyse

Følgende request går til API Les:

{noformat}
POST https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute
Accept: application/json
X-Client: NVDB API Skriv
Content-Type: application/json
X-Request-ID: ab753475-50df-4521-9fb0-b071f5632f51
svvguid: 55f97a59-b4e8-c095-dc9a-8391c2252ac1
{""geometri"":""POINT (140947.43 6497139.56)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-12-04"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}

Responsen er:

{code:json}
{
    ""vegnettsrutesegmenter"": [
        {
            ""href"": ""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/22197"",
            ""metadata"": {
                ""startdato"": ""2020-03-02""
            },
            ""veglenkesekvensid"": 22197,
            ""startposisjon"": 0.24049489,
            ""sluttposisjon"": 0.24049489,
            ""kortform"": ""0.24049489@22197"",
            ""veglenkenummer"": 10,
            ""sluttnode"": ""2962986"",
            ""type"": ""HOVED"",
            ""detaljnivå"": ""Vegtrase og kjørebane"",
            ""typeVeg"": ""Enkel bilveg"",
            ""typeVeg_sosi"": ""enkelBilveg"",
            ""feltoversikt"": [
                ""1"",
                ""2""
            ],
            ""geometri"": {
                ""wkt"": ""POINT Z(140935.99 6497172.559 5.946)"",
                ""srid"": 5973
            },
            ""lengde"": 0.0,
            ""fylke"": 42,
            ""kommune"": 4203,
            ""vegsystemreferanse"": {
                ""vegsystem"": {
                    ""id"": 1002106964,
                    ""versjon"": 1,
                    ""vegkategori"": ""F"",
                    ""fase"": ""V"",
                    ""nummer"": 409
                },
                ""strekning"": {
                    ""id"": 1003423684,
                    ""versjon"": 1,
                    ""strekning"": 1,
                    ""delstrekning"": 1,
                    ""arm"": false,
                    ""adskilte_løp"": ""Nei"",
                    ""trafikantgruppe"": ""K"",
                    ""meter"": 2183.773,
                    ""retning"": ""MED""
                },
                ""kortform"": ""FV409 S1D1 m2184""
            },
            ""kontraktsområder"": [
                {
                    ""id"": 775462797,
                    ""nummer"": 910,
                    ""navn"": ""0910 Aust-Agder elektro og veglys 2018-2023""
                },
                {
                    ""id"": 980782098,
                    ""nummer"": 920,
                    ""navn"": ""0920 Arendal 2020-2025""
                },
                {
                    ""id"": 596780270,
                    ""nummer"": 903,
                    ""navn"": ""0903 Arendal vest 2016-2021""
                }
            ],
            ""riksvegruter"": []
        },
        {
            ""href"": ""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/22197"",
            ""metadata"": {
                ""startdato"": ""2020-03-02""
            },
            ""veglenkesekvensid"": 22197,
            ""startposisjon"": 0.24049489,
            ""sluttposisjon"": 0.24049489,
            ""kortform"": ""0.24049489@22197"",
            ""veglenkenummer"": 11,
            ""startnode"": ""2962986"",
            ""type"": ""HOVED"",
            ""detaljnivå"": ""Vegtrase og kjørebane"",
            ""typeVeg"": ""Enkel bilveg"",
            ""typeVeg_sosi"": ""enkelBilveg"",
            ""feltoversikt"": [
                ""1"",
                ""2""
            ],
            ""geometri"": {
                ""wkt"": ""POINT Z(140935.99 6497172.559 5.946)"",
                ""srid"": 5973
            },
            ""lengde"": 0.0,
            ""fylke"": 42,
            ""kommune"": 4203,
            ""vegsystemreferanse"": {
                ""vegsystem"": {
                    ""id"": 1002106964,
                    ""versjon"": 1,
                    ""vegkategori"": ""F"",
                    ""fase"": ""V"",
                    ""nummer"": 409
                },
                ""strekning"": {
                    ""id"": 1003423684,
                    ""versjon"": 1,
                    ""strekning"": 1,
                    ""delstrekning"": 1,
                    ""arm"": false,
                    ""adskilte_løp"": ""Nei"",
                    ""trafikantgruppe"": ""K"",
                    ""meter"": 2183.773,
                    ""retning"": ""MED""
                },
                ""kortform"": ""FV409 S1D1 m2184""
            },
            ""kontraktsområder"": [
                {
                    ""id"": 775462797,
                    ""nummer"": 910,
                    ""navn"": ""0910 Aust-Agder elektro og veglys 2018-2023""
                },
                {
                    ""id"": 980782098,
                    ""nummer"": 920,
                    ""navn"": ""0920 Arendal 2020-2025""
                },
                {
                    ""id"": 596780270,
                    ""nummer"": 903,
                    ""navn"": ""0903 Arendal vest 2016-2021""
                }
            ],
            ""riksvegruter"": []
        }
    ],
    ""metadata"": {
        ""antall"": 2,
        ""lengde"": 0.0,
        ""status"": 2000,
        ""status_tekst"": ""KOMPLETT""
    }
}
{code}

Det kommer altså duplikate punktstedfestinger fra API Les. Registrerer en Bug-sak på dette.

h2. Løsning

Må fikses i API Les, men legger uansett inn et par kodelinjer i API Skriv for å fjerne duplikat punktstedfesting.",NVDB-6937,Skriv-API,
"Driftskontrakt tilstandsrapport: Ta med navn, id og vegkartlenke til morobjekt i tabell","For tilstandsrapporten, basert på tilbakemeldinger under og etter demo: 

Vi ønsker at tilstandsrapporten har kolonner for objekttype ID, objekttype navn og vegkart-lenke for mor-objektet. 

For det spesialtilfellet at vi har mer enn ett ""mødreobjekt"": Dette er datafeil, og vår løsning er å bruke det første objektet i listen over ""mødreobjektet"" (som ideelt sett har ett og kun ett medlem). 

Vegkart-URL oppygning er [https://vegkart.atlas.vegvesen.no/#valgt:78901692:5]  , dvs [https://vegkart.atlas.vegvesen.no/#valgt:|https://vegkart.atlas.vegvesen.no/#valgt:78901692:5]  + <nvdb objektId> + :  + <nvdb objektTypeId> ref  [https://www.vegdata.no/2020/09/23/ny-funksjon-erstattar-redirect-url-for-vegobjekter-id/] 

!image-2020-12-03-13-17-56-573.png!

 ",NVDB-6827,Rapportgenerator,
Få sideposisjon ved stedfesting med Skriv,"API Skriv sin stedfestingstjeneste er omskrevet til å ta i mot parametere som del av payload. Datafangst sin gateway må skrives om til å bruke denne i stedet for varianten med query-parametere.

 

Den nye strukturen gir også muligheten til å få automatisk sideposisjon, så det skrus på.",NVDB-6937,Datafangst,
Bruk nye OIDC-endepunkter i Skriv,"API Skriv sitt OIDC-endepunkt (og payloads) har skiftet navn til engelsk. Se detaljer på https://apiskriv.vegdata.no/autentisering#autentisering-via-openid-connect

De gamle endepunktene med norske navn er fortsatt operative, men fjernes straks denne saken gjort.",NVDB-6937,Les-API,
Vegsegmentet finnes ikke,"h2. Observasjon

via Datafangst support

les finner dette segmentet, men det gjør ikke stedfesting med skriv

[https://nvdbapiles-v3.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/3285592]

prøver å stedfeste på FG227

[https://www.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=F&vegnummer=227&fase=V&typeVeg=GANG_OG_SYKKELVEG%2CSYKKELVEG%2CGANGVEG%2CG%C3%85GATE%2CFORTAU%2CTRAPP%2CGANGFELT]

for å gjenskape i datafangst:
 last opp vedlagte sosi.
 prøv å stedfest objektetene til gangvegen.
 stedfesting med skriv gir feilaktig stedfesting på hovedvegen.
 legacy stedfesting feiler, fordi topologyprovider sier at det ikke eksisterer noe vegsegment med oppgitt id

h2. Analyse

Det eneste jeg finner av logginnslag i Splunk er dette:

{noformat}
2020-12-01T13:21:00,632+0100 [http-nio-18230-exec-14] [] [1049925] RES 405 2
host = svvptomcat25source = /data/base-nvdbskriv-03/logs/svvptomcat25.vegvesen.no_access.logsourcetype = nvdb-access-log
2020-12-01T13:21:00,630+0100 [http-nio-18230-exec-14] [] [1049925] REQ GET https://www.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=F&vegnummer=227&fase=V&typeVeg=GANG_OG_SYKKELVEG%2CSYKKELVEG%2CGANGVEG%2CG%C3%85GATE%2CFORTAU%2CTRAPP%2CGANGFELT
host = svvptomcat25source = /data/base-nvdbskriv-03/logs/svvptomcat25.vegvesen.no_access.logsourcetype = nvdb-access-log
{noformat}

Det er brukt GET på et endepunkt som krever POST. Derfor responderes med 405 METHOD NOT ALLOWED.",NVDB-6937,Skriv-API,
Trekkerør lar seg ikke stedfeste med Skriv,"h2. Observasjon

Fra support.

Vedlagt ligger sosi med trekkekrør der flere ikke lar seg stedfeste med skriv. Auto-stedfesting stedfester mange, men ikke alle.

De som mangler ligger nær eller på vei, og noen uten annen vei i nærheten, men gjerne i litt rare vinkler.

Én kurve lar seg ikke stedfeste manuelt når jeg tester, det er kurve 83. Får feilmelding som vanligvis betyr at Skriv ikke har fått svar fra Les. Hadde vært interessant å se på de automatiske som feiler, men det viktigste er nok den ene som også feiler manuelt.

API-kall mot Skriv: POST [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=E&vegnummer=39&fase=V&typeVeg=KANALISERT_VEG%2CENKEL_BILVEG%2CRAMPE%2CRUNDKJ%C3%98RING%2CGATETUN]

Request body:

{code:xml}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt typeId=""852"" tempId=""02acb0d5-c597-4604-8e35-9f0373fa2898"">
        <egenskaper>
            <egenskap typeId=""9721"">
                <geometri>
                    <srid>25833</srid>
                    <wkt>LINESTRING (-9857.29 6785067.83 15.52, -9857.11 6785067.92 16.56, -9856.85 6785067.97
                        17.490000000000002, -9856.36 6785067.95 18.36, -9855.76 6785067.93 19.04, -9855.04 6785067.89
                        19.57, -9854.23 6785067.87 19.92, -9853.44 6785067.89 20.16, -9852.92 6785067.84 20.35, -9852.51
                        6785067.84 20.38, -9852 6785067.73 20.11)
                    </wkt>
                    <datafangstdato>2019-09-02</datafangstdato>
                    <temakode>4008</temakode>
                    <referansegeometri>false</referansegeometri>
                    <kvalitet>
                        <målemetode>11</målemetode>
                        <målemetodeHøyde>11</målemetodeHøyde>
                        <nøyaktighet>10</nøyaktighet>
                        <nøyaktighetHøyde>10</nøyaktighetHøyde>
                        <synbarhet>0</synbarhet>
                    </kvalitet>
                </geometri>
            </egenskap>
        </egenskaper>
        <gyldighetsperiode>
            <startdato>2020-12-05</startdato>
        </gyldighetsperiode>
    </vegobjekt>
</vegobjekter>
{code}

h2. Analyse

Stedfestingstjenesten skal sikre at ruten fra API Les er på minst en meter. I dette tilfelle er den ikke det og det gjøres forsøk på å blåse opp geometrien slik at ruten får minstelengde. Etter tre forsøk  er fortsatt ikke lengden 1 m, og det returneres tom stedfesting med melding om at stedfesting mislyktes. Gjennom gjentatte oppblåsinger blir rutelengden slik:

* 0.973
* 0.984
* 0.986
* 0.994

Årsaken til å at den ikke tipper over 1 m ser ut til å være hvordan bufferlengden beregnes i GeometryPrimer.inflateGeometryForMinimumLocationalLength. Algoritmen tar ikke tilstrekkelig hensyn
til abnorme geometrier som i dette tilfellet.

h2. Løsning

Endret GeometryPrimer.inflateGeometryForMinimumLocationalLength til å legge til 5 cm på manglende lengde i stedet for 10 %.",NVDB-6937,Skriv-API,
Ingen progress ved automatisk stedfesting med Skriv,Ved automatisk stedfesting står bare progress bar på 50% helt til det er ferdig. Siden dette er er en operasjon som kan ta lang tid så hadde det vært veldig gunstig her om progress bar ga en reell indikasjon på hvor mye som er igjen. Slik som det er nå er det fort gjort å tro at den henger.,NVDB-6937,Datafangst,
Utfasing av datafangst.kantega.no,"Adressene til Datafangst på Kantega-domene må fasast gradvis ut.
 # Verlse brukarar som går inn på datafangst.kantega.no om at dei må bytte til ny adresse, men tillate vidare bruk denne sesjon enten med redirect eller fortsat bruk i same sesjon.
 Dette kan skje ved varselboble etter innlogging, samt melding på innloggingskjerm.
 # På ein gitt dato vise ei melding om feil adresse (kan gjerne styres via konfig). Brukar må sjølv skrive inn ny adresse, eller klikke på lenke til ny adresse.
 # Til slutt skal sida vise generell feil.",NVDB-6937,Datafangst,
Fjern alle spor av Kantega,"Finner bare en referanse til Kantega, og det er i mail template for nye brukere. den er endret til datafangst.vegvesen.no

",NVDB-6937,Datafangst,
Lokal kjøring feiler når den ikke finner jaxb-implementasjon,"Får relativt ofte feil med lokal kjøring med at den ikke finner noen jaxb-implementasjon. Kan fikses med en restart, men irriterende uansett.",NVDB-6937,Datafangst,
Unaurhorized endepunkt via API,"via Stig Vidar Hovland <Stig-Vidar.Hovland@powel.no>

Hei

Problemet med CORS ser ut til å være løst. Men det er allikevel noen andre problemer som jeg ikke helt finner ut av på egenhånd.

Jeg klarer å levere data til datafangst med


PUT /api/v1/contract/{contractId}/featurecollection/{collectionId}
og POST /api/v1/contract/{contractId}/featurecollection

Men når jeg bruker

GET /api/v1/contract/{contractId}/featurecollection/{collectionId}/status


så får jeg respons “unauthorized”

Bruker er svh@powel.com

 !screenshot-1.png|thumbnail! ",NVDB-6937,Datafangst,
Legge om til OIDC og Skrive-Atlas for index- og smoke-tester,"De jevnlige testene på Jenkins som kjører smoke-tester og indekseringstester går ikke mot Atlas-Skriv. Oppgaven går på å skrive om til å benytte oidc/jwt og Atlas-Skriv i disse testene:
 * Scenario _indexTest_
 * Scenario _smokeTest_

Merk: Behold _smokeTest_ mot de gamle miljøene.

 ",NVDB-6937,Les-API,
Sørg for at  genererte filer havner i target,"frontend/src/main/css/svviconfont.scss

frontend/src/main/fonts/svviconfont.eot

frontend/src/main/fonts/svviconfont.ttf

frontend/src/main/fonts/svviconfont.woff",NVDB-6937,Datafangst,
PV med manglende nummer fører til ugyldige stedfestinger,"..som fører til at datafangst krasjer (med vilje).

Disse stedfestingene må slettes for å unngå at datafangst kræsjer for de prosjektene det gjelder.

Brukerne må samtidig få beskjed om at de ikke må stedfeste privatvegene på nytt før feilen er rettet i NVDB.

Feilen rettes når det blir kjørt et script (som det har vært problemer med)

Mailadresse til alle som henvender seg til oss på mail kan legges i en kommentar på denne posten slik at vi kan sende ut mail til dem når feilen er rettet.",NVDB-6937,Datafangst,
Utgåtte passordtoken blir ikke slettet fra database,"Etter NVDB-4282 så er ikke lengre TokenSweeper aktiv, så utgåtte tokens for ny bruker slettes ikke fra database.",NVDB-6937,Datafangst,
API mangler CORS-headere,,NVDB-6937,Datafangst,
E2E-test av gruppeadmin,"Det mangler E2E-tester av gruppeadmin, dvs alle operasjoner under /#!/admin/groups.

Tester som må implementeres:
 * (/) Opprette ny kontraktsgruppe
 * (/) Legge til bruker i gruppe
 * (/) Fjerne bruker fra gruppe
 * (/) Endre rolle til gruppeadmin
 * (/) Endre rolle til gruppeforvalter
 * (/) Endre rolle til gruppedeltaker
 * (/) Legge til kontrakt i gruppe
 * (/) Fjerne kontrakt fra gruppe",NVDB-6937,Datafangst,
Merking av duplikate objekter i CSV,"I CSV-eksport vert objekt med stadfesting på fleire vegar delt opp i ei rad for kart vegelement. Det kan vere nyttid å ha med ei kolonne som indikerer om dette er primære (første) forekomst av dette objektet, eller det er duplikat av ei tidlegare rad.

Til dømes kan det indikerast med ""1"" for første rad, og ""0"" for resterande rader.",NVDB-6937,Eksport,
Innlesing av datakatalog fra NVDB til intern objektgraf,"Akseptansekriterier:
- Datakatalog populeres fra NVDB og refreshes når den endres i NVDB

Testbeskrivelse:
Løsningen startes med -Plive i sandboxmiljøet. Gjør et anrop med testklienten og kontroller i loggen at datakatalogen populeres fra NVDB. Refreshing ved endret datakatalog er litt mer verre å teste...",,,
NVDBREF-608 : Vegobjekt-Belysingspunkt uten vegsystemreferanse,"Jeg har funnet et belysningspunkt (id 268323390) uten vegsystemreferanse i vegkart.
 [https://vegkart.test.atlas.vegvesen.no/#kartlag:topo4/@654839,7731893,18/hva:~(~(id~87))/valgt:268323390:87]
 Jeg tok at oppdateringsprosjekt i NVDB123 og finner objektet her med slettede døtre og uten vegreferanse.  Dette er kanskje mer enn datafeil i basen enn en vegkartfeil ?, men et sted må jeg jo melde dette.
 Se skjermdump i fila ""Belysningspunkt 268323390""
h2.  Løsning

For vegobjekter som er åpne men stedfestet på lukket vegnett brukes nå vegsystemreferansen fra vegnettet før det ble lukket, den ""nyeste"" vegsystemreferansen. I tilfellet som ble meldt i denne saken er det bare vegsystem (EV8) på det gamle vegnettet.",NVDB-6937,Les-API,
Serialisering av geometri til cache,"Caused by: java.lang.RuntimeException: No serializer for GeometryHolder

 

Oppdaget i ATM.",NVDB-6937,NVDB-IND,
Rydde i språk (engelsk/norsk) i koden,Bruke norsk for domene-objekter og engelsk ellers,,,
Jobbrelaterte entiteter,"Akseptansekriterier:
- Implementert domeneklasser for NVDB-nær representasjon av jobb-entiteter",,,
Involvere designer,"Akseptansekriterier:
- Følger SVVs design guide",,,
Avklare datakatalogkvalitet med Vilhelm Børnes,"Forskjeller i datakatalogen slik den framstår i Java webstart og NVDB, f.eks. ift. sideposisjonrelevans. Tidligere hadde flere vegobjekttyper påkrevd sideposisjon, men i siste versjon er disse endret til valgfri.",,,
Kontrollere roller på serveren,"Kontrollere på serveren at brukeren ikke får hentet ut informasjon han ikke skal ha, basert på de rollene han har",,,
Validere at verdier på egenskaper skal være riktig i henhold til gyldig datatype,"Id: 2
Navn: Tall
Kortnavn: N
Beskrivelse: Datatype benyttes for ET som skal inneholde tall.  Benyttes både om heltall og desimaltall.  Det må angis feltlengde og antall desimaler.  Både siffer foran og bak komma samt selve kommaet inngår i feltlengde.  Kan angi maksverdi, minverdi, defaultverdi og maske.  NVDB: Nf_IntegerAttributetype eller Nf_RealAttributeType

Id: 8
Navn: Dato
Kortnavn: D
Beskrivelse: Datatype benyttes for ET som skal inneholde År/Måned/Dag.  Skal ha feltlengde = 8.  Må oppgi maske.  Kan oppgi maksverdi,  minverdi og defaultverdi.  NVDB: Nf_DateAttributeType

Id: 9
Navn: KortDato
Kortnavn: KD
Beskrivelse: Datatype benyttes for ET som skal inneholde Måned/Dag for datoer som skal gjentas år etter år.  Må angi feltlengde.  Skal ha feltlengde 4.  Må angi maske.  Kan angi maksverdi, minverdi og defaultverdi.  NVDB: Nf_ShortDate

Id: 10
Navn: Klokkeslett
Kortnavn: KL
Beskrivelse: Datatype benyttes for ET som skal inneholde Time/Minutt.  Må ha feltlengde=4. Kan angi maksverdi, minverdi og defaultverdi.  NVDB: Nf_TimeAttributeType

Id: 17
Navn: GeomPunkt
Kortnavn: GP
Beskrivelse: Datatype benyttes for ET som skal inneholde koordinater til et punkt i form av x-, y- og z-verdier.  Z-koordinat kan utelates.  Det må gis informasjon om koordinatsystem.  NVDB: Ng_PointType

Id: 18
Navn: GeomLinje eller Kurve
Kortnavn: GLK
Beskrivelse: Datatype benyttes for ET som skal inneholde koordinater til ei linje/kurve.  Det kan gis linjer/kurver i 3 dimensjoner.  Linja/kurva går gjennom et sett med punkter i gitt rekkefølge.   Punktene er gitt ved x-, y- og z-verdier.  z-koordinat kan utelates.  Det må gis informasjon om koordinatsystem.  NVDB: Ng_CurveType

Id: 19
Navn: GeomFlate
Kortnavn: GF
Beskrivelse: Datatype benyttes for ET som skal inneholde koordinater til et ei flate.  Det kan gis flater i 3 dimensjoner. Flate avgrenses av ei linje/kurve. Linja/kurva går gjennom et sett med punkter i gitt rekkefølge.   Punktene er gitt ved x-, y- og z-verdier.  Z-koordinat kan utelates.  Det må gis informasjon om koordinatsystem.  NVDB: Ng_SurfaceType

Id: 20
Navn: GeomSammensatt geometri
Kortnavn: GSG
Beskrivelse: Datatype benyttes for ET som skal inneholde geometri bestående av både punkt, linje/kurve og flate

Id: 21
Navn: GeomMultiPunkt
Kortnavn: GMP
Beskrivelse: Datatype benyttes for ET som skal inneholde et sett med punkt (se datatype GP 17)

Id: 22
Navn: GeomMultiKurve/linje
Kortnavn: GMLK
Beskrivelse: Datatype benyttes for ET som skal inneholde et sett med kurver/linjer (se datatype GLK 18)

Id: 23
Navn: GeomMultiFlate
Kortnavn: GMF
Beskrivelse: Datatype benyttes for ET som skal inneholde et sett med flater (se datatype GF 19)

Id: 26
Navn: Struktur
Kortnavn: STRUKT
Beskrivelse: Datatype benyttes for ET som skal settes sammen av andre ET. NVDB: Nf_StructAttributeType

Id: 27
Navn: BinærObjekt
Kortnavn: BO
Beskrivelse: Datatype benyttes for ET som skal inneholde lyd, bilde, video, binærtekst etc.  NVDB: Nf_BlobAttributeType

Id: 28
Navn: Boolean
Kortnavn: BL
Beskrivelse: Datatype benyttes for ET hvor det skal gis enten ?Ja? eller ?Nei?. (?True? eller ?False?).  NVDB: Nf_BoolAttributeTypea

Id: 29
Navn: Tegn
Kortnavn: TG
Beskrivelse: Datatype benyttes for ET som skal ha et sett med tillatte verdier, der de tillatte verdiene er av type tekst.  Må angi feltlengde større enn strenglengde av lengste tillatte verdi.  NVDB: Nf_CharAttributeType

Id: 30
Navn: FlerverdiAttributt, Tekst
Kortnavn: FVA
Beskrivelse: Datatype benyttes for ET som skal ha et sett med tillatte verdier, der de tillatte verdiene er av type tekst.  Må angi feltlengde større enn strenglengde av lengste tillatte verdi. NVDB: Nf_PrimitiveAttributeType / Nf_EnumPrimitive / Nf_PrimitiveAttribute

Id: 31
Navn: Flerverdiattributt, Tall
Kortnavn: FVN
Beskrivelse: Datatype benyttes for ET som skal ha et sett med tillatte verdier, der de tillatte verdiene er av type tall.  Det må oppgis feltlengde og antall desimaler slik at alle tillatte verdier holder seg innenfor formatet.  NVDB: Nf_PrimitiveAttributeType / Nf_EnumPrimitive / Nf_PrimitiveAttribute

*De nedenfor støttes IKKE*

Id: 24
Navn: NettNodeEllerPunktT??
Kortnavn: NNPT
Beskrivelse:

Id: 32
Navn: Autogenerert verdi
Kortnavn: AV
Beskrivelse: Datatype benyttes for ET hvor det skal angis heltallsverdi som skal være unik innenfor objekttypen.  Ny verdi skal være høyeste eksisterende verdi + 1.  NVDB: Ikke definert

Id: 33
Navn: BinærObjekt, Bilde
Kortnavn: BB
Beskrivelse: Datatype benyttes for ET som inneholder bilde/illustrasjon.  NVDB: Erstattet av DT 27

Id: 34
Navn: BinærObjekt, Lyd
Kortnavn: BL
Beskrivelse: Datatype benyttes for ET som inneholder lyd.  NVDB: Erstattet av DT 27

Id: 35
Navn: BinærObjekt, Video
Kortnavn: BV
Beskrivelse: Datatype benyttes for ET som inneholder video.  NVDB: Erstattet av DT 27

Id: 36
Navn: BinærObjekt, TSF
Kortnavn: BTSF
Beskrivelse: Datatype benyttes for ET som inneholder ?.

Id: 37
Navn: BinærObjekt, Tekst
Kortnavn: BTX
Beskrivelse: Datatype benyttes for ET som inneholder tekst.  NVDB: Erstattet av DT 27",,,
Kopier innlesingskode fra nvdb-reader,,,,
Integrer med NVDB,,,,
Etabler repository for datakatalog,"Skal tilby metoder for å hente datakataloginformasjon (vegobjekttyper, egenskapstyper m.m.) fra NVDB.",,,
Etabler mock for datakatalog-repository,,,,
Serialisering til/fra JSON via Jackson,Trenger oppdatert JSON-fil for repository-nvdb-mock.,,,
"Implementer bedre støtte for Struct, Spatial, List og Locational i datakatalogen","Strukturmedlemmer leses ikke inn i dag.
Queryen for å hente listeattributter henter heller ikke ""lister av strukturer"".

Spatial mangler spatialType.

Locational mangler extentType

List mangler kardinalitet.",,,
Lese et vegobjekt (inkl. stedfesting) fra NVDB,,,,
Oversette KurvGen-fil ihht NVDB-API-Skriv API,"- Skaffe KurvGen-data
- Oversette",,,
Introdusere låsing i prosessen i JobWorker,,,,
Database-kode for å skape og fjerne lås,,,,
Ved sletting: Hent fossefallskandidater (cascading delete) u/attributter,"Akseptansekriterium:
- Når et objekt slettes (settes historisk), slettes også alle datterobjekter gjennom assosiasjoner med affiliation COMPOSITION rekursivt nedover i hierarkiet.
- Når et objekt slettes (settes historisk), fjernes også alle assosiasjoner inn mot objektet. Det refererende objektene får da ny versjon uten denne assosiasjonen.


Testbeskrivelse:

I PoC-miljøet:

1) Kjør testcase 63 som oppretter et objekthierarki. Noter nvdbId for rot-objektet (-1).
2) Endre testcase 64, sett inn nvdbId fra punktet over. Kjør.
3) Kontroller at alle fire objekter er bort med NVDB123 e.l.",,,
Ved registrering (ikke-overlappende): Hent overlappskandidater m/lokasjonsattributt (gyldige ved nytt objekts fødsel),,,,
Analysere uttrekk fra transaksjonsloggen,NVDB-186 har gjort uttrekk. Uttrekket er tilgjengelig på wiki under Testing-Bruksmønster.,,,
Ved oppdatering: Hent gjeldende/referert versjon u/attributter + samme som for registrering,,,,
Opprette task når det lages en lås,"En task må opprettes med alle verdier.
Det lages én task for hver jobb. Alle låser kobles til denne tasken.
Tasken lages på samme måte som det er vist i skripene i transactiontaskutils i nvdb.

Tasken knyttes midlertidig til en hardkodet bruker.

For kodereview:
- Se på JobWorker linje 67 og 80.",,,
Kopiere en bruker fra LDAP til NVDB,Dersom en task skal kobles til en bruker som ikke allerede er lagt inn i NVDB må vi legge inn brukeren. Data som skal legges inn skal hentes fra LDAP.,,,
Ved registrering av mor: Hent refererte (eksisterende) døtre med m/lokasjonsattributt (gyldige ved/etter mors fødsel),,,,
Ved sletting: Fjerne assosiasjoner til objektet som skal slettes (oppdatering),"Alle objekter som har assosiasjon til det objektet som skal slettes må oppdateres ved at disse assosiasjonsattributtene fjernes. Fjerning skjer ved at refererende objekter hentes inn i jobben med Operation UPDATE, samme validFrom som sletting og med assosiasjonsattributten tatt bort.",,,
Filtrere på låser som er i konflikt med en spesifikk jobb ,,,,
Støtte for UPDATE i representasjon og jobbehandling,,,,
Støtte for UPDATE i NvdbRepository,,,,
Teknisk installasjonsdokumentasjon,Avventer failover-løsning for ActiveMQ.,,,
Systemdokumentasjon (utkast),//Store/Felles/ProsjekterOgLøsninger/NVDB Skrive-API/Leveransedokumentasjon/NVDB API Skriv - Systemdokumentasjon.docx,,,
Støtte for CORRECT i jobbehandling,,,,
Helsesjekkmekanisme,"Forespørsel

GET /nvdb-api/status

Respons

200 OK
Content-Type: ""text/plain""

RUNNING

eller

200 OK
Content-Type: ""text/plain""

FAIL",,,
Oppdatering av feature i NvdbRepository,,,,
Validering av kvalitetsparametere i SkriveAPIet,"DAKATs SOSI-KONTROLL-applikasjon kontrollerer at kvalitetsparametrene for geometrien har lovlige verdier for målemetode, nøyaktighet osv. Dette mangler i SkriveAPIets valideringslogikk.

Verdiene må kontrolleres mot lovlige verdier angitt i datakatalogen for vegobjekttype NVDB_Dokumentasjon (typeid 793).",,,
Flytt SOSI-parser til eget GitHub-repo (open source),Flyttet til GitHub: https://github.com/nvdb-opensource/sosi-reader,,,
Autentisering mot Skrive-API,Gjenbruk pålogget brukers OpenAM-token ved anrop NVDB Skrive-API.,,,
Velge vegreferanse og stedfeste til denne,Dataforvalter kan velge en vegreferanse og en eller flere objekter og stedfeste objektene til denne vegen,,,
Domenemodell for FKB objekttyper,"En første minimums ""datakatalog"" for FKB inneholder temakode (=id), navn og assosierte NVDB vegobjekttyper.",,,
Differensiering mellom opplastede FKB- og NVDB-filer,,,,
Visning i Oversiktsfanen,,,,
Opprette dummy dokumenter med egengeometri/områder for områder,,,NVDB-IND,
Bruksmønster leseAPI,"Basert på data fra Splunk eller direkte fra logger bør man bl.a. finne:
* Hvilke endepunkter
* Hvilke spørringer/filtre brukes
* Fordeling og mengde over tid",,,
Ta i bruk byggeverktøy for frontend-ressurser,"Webpack, NPM, ES6.",,,
Norge i bilder,,,,
Driftskontrakt V4: Flytte relasjoner (assosiert-egenskaper) lengst mot høyre,"Som en siste finpuss på V4-rapporten kan vi flytte ""assosiert"" - egenskapene _(kommaseparert liste med ID til datterobjekter)_ lengst mot høyre, bortforbi sorteringskolonne #2. ",,Rapportgenerator,
Flere farger for objekter i kartet på datafanen,"Fra support (Astrid Heier Vegusdal).
{noformat}
Når vi skal ta inn NVDB data for lukking i datafangst får objektet samme farge som eksisterende objekter i datafangst. Kan dere endre denne fargen til rød slik at objekt tatt inn for lukking er forskjellig fra eksisterende
{noformat}
Dette ønsket tangerer et annet fra support (Janet Lynn Berringer Slåen) som ønsker:
{noformat}
Er det mulig å implementere bytt av farge (ikke det samme blå) når en selekterer eksisterende data i NVDB?
{noformat}
Slik jeg tolker disse ønskene så er det forrvirrende at vi kun opererer med to typer farger i kartet. Antallet farger og hvilke operasjoner som bør knyttes til hvilke farger må utforskes når saken tas tak i.",NVDB-6937,Datafangst,
Fjerne stedfesting,"Fra support (Steinar Johansen, Innlandet FK).

Ønsket er å kunne fjerne stedfesting for alle nye objekter (operasjon CREATE). Bakgrunnen er at objektene i kontrakten var stedfestet før ny veg var lagt inn i NVDB.

Kunne vært løst med en modal a la automatisk stedfesting hvor man kunne valgt typer å fjerne stedfestingen for.

Løsning i dag er å manuelt stedfeste aktuelle objekter til ny veg da automatisk stedfestinig ikke tar med objekter som har ""grønn"" stedfesting.",NVDB-6937,Datafangst,
Strekningsobjekt vises som rette linjer ved bruk av filter,"h1. Observasjon 1

Med døme frå ulike klientar

[Vegkart (vegvesen.no)|https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@26934,6943035,12/hva:~(~(filter~(~(operator~'*3d~type_id~9260~verdi~(~12905)))~id~810)~(id~5)~(id~540)~(id~105)~(id~241)~(id~775)~(id~86))/hvor:~(vegsystemreferanse~(~'FV61))]

  !fv61_nvdb123.PNG|thumbnail! !fv61_vegkart_v3.png|thumbnail! !fv61_sinus_infra.PNG|thumbnail! !fv61_vegkart_v2.png|thumbnail!

 
h1. Observasjon 2

Her er det fvk som plutselig har tatt en «liten avstikker» når filter er satt på vegen.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-37218,6580374,12/hva:~(~(id~532))/hvor:~(vegsystemreferanse~(~'E39))]

!Feilsøk API.jpg|thumbnail!

 
h1. Observasjon 3

https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@-33344,6564399,18/hva:~(~(id~105))/hvor:~(vegsystemreferanse~(~'FV))

 

*Løsning*

Algoritmen for å lagre geometri til vegobjektsegmenter er endret. Det løser alle disse observasjonene, og tidligere observasjoner på feil med segmentert geometri samtidig som vi ikke lagrer mer til solr.",NVDB-6937,Les-API,
Leveranseinformasjon,"*Testes i ATM av leverandør:*
 * NVDB-5017: Verifiser at geometriegenskaper kommer med på segmentene
 * NVDB-6287: Slå opp aktuelt objekt og verifiser at det har vegsystemreferanse
 * NVDB-6051: Verifiser at objekt i saken (se siste kommentar) har geometri

 NVDB-5017 og NVDB-6051 vil ikke gi forventede resultater før NVDBIND V3 2020.18.0 ([https://jira.kantega.no/projects/NVDB/versions/36511)] er ute og reindeksert. Sjekk derfor at disse sakene ikke gir feil etter deploy av denne leveransen, og re-test disse sakene etter reindeksering.",NVDB-6937,Les-API,
Forvirrende koble-klippe symboler på assosiasjon?,"h2. Observasjon

Hvis man importerer et NVDB-objekt som har barn, f.ex importer et skiltpunkt fra kartet ved å laste opp vedlagte SOSI først, så vil assosiasjonsfanen vise koblingene (assosiasjon_steg0.png).

Om man klipper bort en av assosiasjonene vil symbolene i menyen vise motsatt av symbolene i menyen for ""koble til NVDB-datter"" (assosiasjon_steg1.png). Dette kan forstås ved at menyen for ""koble til NVDB-datter"" viser hva som er gjort - samtidig er det en viss fare for uklarhet når de to ""menyene"" viser omvendte symboler for koblet og ikke-koblet.",NVDB-6937,Datafangst,
Tilbakestilling av assosiasjoner endrer ikke dirtyness,"*Observasjon #1*

Importerer kun et nytt 96 (96.sos). Kobler til NVDB-mor 95-1011052388 (kommer opp på søk i ass.fanen). Ser da i datafanen at 95-1011052388 er ""dirty"", som jo er naturlig når den har fått en ny assosiasjon. Men fjerner jeg assosiasjonen jeg lagde til nytt 96-objekt, så ligger 95-1011052388 fortsatt som ""dirty"". Burde ikke denne da vært synkronisert?

 

*Observasjon #2*

Importer en NVDB-datter via kartet i datafanen. F.ex skiltplate ved å laste opp vedlagt SOSI for å få ta i NVDB-skiltplater. Verifiser at objektet ikke er dirty i datafanen. Gå til assosiasjonsfanen. Slett kobling til mor. Angre så sletting ved å koble tilbake igjen. Gå til datafanen og se at objektet nå ligger som dirty. Ingenting er endret så dette skulle ligget som ikke dirty.",NVDB-6937,Datafangst,
Systemfeil etter mislykket versjonskontroll på berikede objekter,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/10f34137-a562-4c9a-8cea-a861ca9994db havner i SYSTEMFEIL pga ENRICHMENT_VERSION_CHECK_FAILED etter 12 t.

h2. Analyse

+10f34137-a562-4c9a-8cea-a861ca9994db+

VT 87 - NVDB-ID 421037274:2 (ADD): Vegobjektversjonen er ikke siste versjon. Siste versjon er 2.

Årsak: Vegobjekt 421037274 (VT87) fikk versjon 2 i oppdrag 1504408, uten at versjon 1 ble lukket. Dette forvirrer API Skriv som forventer at bare siste versjon av et vegobjekt har åpen sluttdato.

+40ad4218-7b76-4d7a-b8c6-171922ada5be+

VT 87 - NVDB-ID 421037273:2 (ADD): Vegobjektversjonen er ikke siste versjon. Siste versjon er 2.

Årsak: Vegobjekt 421037273 (VT87) fikk versjon 2 i oppdrag 1504408, uten at versjon 1 ble lukket. Dette forvirrer API Skriv som forventer at bare siste versjon av et vegobjekt har åpen sluttdato.

+4f3895e5-d218-4922-8e0f-9689ba47dde4+

VT 87 - NVDB-ID 421037282:2 (ADD): Vegobjektversjonen er ikke siste versjon. Siste versjon er 2.

Årsak: Vegobjekt 421037282 (VT87) fikk versjon 2 i oppdrag 1504408, uten at versjon 1 ble lukket. Dette forvirrer API Skriv som forventer at bare siste versjon av et vegobjekt har åpen sluttdato.

+276c721b-d5e1-44a0-9aa7-4bdfc44e99f3+

VT 87 - NVDB-ID 421037281:2 (ADD): Vegobjektversjonen er ikke siste versjon. Siste versjon er 2.

Årsak: Vegobjekt 421037281 (VT87) fikk versjon 2 i oppdrag 1504408, uten at versjon 1 ble lukket. Dette forvirrer API Skriv som forventer at bare siste versjon av et vegobjekt har åpen sluttdato.

+3fee339d-0227-41cb-b6f6-010c11119bbc+

VT 87 - NVDB-ID 421037284:2 (ADD): Vegobjektversjonen er ikke siste versjon. Siste versjon er 2.

Årsak: Vegobjekt 421037284 (VT87) fikk versjon 2 i oppdrag 1504408, uten at versjon 1 ble lukket. Dette forvirrer API Skriv som forventer at bare siste versjon av et vegobjekt har åpen sluttdato.


Konklusjon: Dette er datafeil i NVDB som må rettes med SQL-script. Sender info til Hans Anton.
",NVDB-6937,Skriv-API,
Forhindre Changeset monitor til å kjøre opp flere tråder,"Changset monitor er satt til å starte opp changeset progrerss check med jevne intervall (satt i application.properties).

Men slik den er nå, vil en ny tråd starte hvert intervall, og potensielt kjøre opp flere jobber samtidig.

Sett flagget 

concurrentExecution = Scheduled.ConcurrentExecution.SKIP

i @Scheduler annotation",NVDB-6937,Datafangst,
Systemdokumentasjon inn i ny mal fra forvaltning,"Avtalt på [2020-11-24 - IKT-møte - NVDB api Rapport overlevering til IKT drift|https://www.vegvesen.no/wiki/pages/viewpage.action?pageId=142882224]: 

Systemdokumentasjon legges over i ny mal fra Forvaltning:

[https://www.vegvesen.no/wiki/display/FoV/Systemdokumentasjon+NVDB+API+Rapport] ",,Rapportgenerator,
Systemfeil i NoOverlapValidator,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/cc50ebed-53ed-4627-8213-14f177bef6e1 havner i SYSTEMFEIL:

{code:java}
java.lang.RuntimeException: Feature 81462145:2 of type 105 has no locational attribute
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.lambda$getLocationalAttributeOrThrow$9(Feature.java:483)
	at java.util.Optional.orElseThrow(Optional.java:290)
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.getLocationalAttributeOrThrow(Feature.java:483)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.isValidOverlap(NoOverlapsValidator.java:143)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.isValid(NoOverlapsValidator.java:72)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.isValid(NoOverlapsValidator.java:39)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.ConstraintEnforcer.enforce(ConstraintEnforcer.java:58)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ConstraintJobFilter.doFilter(ConstraintJobFilter.java:32)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:455)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:177)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:145)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

Det angitte vegobjektet blir delvis korrigert i endringssettet, uten at noen detaljer faktisk endres:

{code:xml}
<vegobjekt typeId=""105"" nvdbId=""81462145"" versjon=""2"">
  <egenskaper/>
  <gyldighetsperiode>
    <startdato>2015-03-04</startdato>
  </gyldighetsperiode>
  <validering>
    <lestFraNvdb>2020-11-24T11:53:39</lestFraNvdb>
  </validering>
</vegobjekt>
{code}

Ved rekjøring på VDI lar ikke systemfeilen seg reprodusere (måtte øke versjonsnummeret på et annet vegobjekt som ble delvis oppdatert for å få det gjennom). Det avvises korrekt med valideringsfeil pga manglende endringer i vegobjektet over.

h2. Løsning

La inn mer logging på stedet der exception blir kastet for å kunne belyse caset mer om det skulle dukke opp igjen.",NVDB-6937,Skriv-API,
"Legge til tekst og feilkode ved ""Ulykke""","h2. Observasjon

I dag visast berre eit bilete av farskiltet ""Ulykke"" med generelle undertekst.

Det bør leggast til ein tekst dersom bletet ikkje kan visast i nettlesaren.

Teksten bør og vise til kva for feil som har skjedd, Feilkode, dersom nokon vil melde frå om feilen vidare.",NVDB-6937,Vegkart,
POLYGON EMPTY ved stedfesting,"h2. Observasjon

POST /nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=E&vegnummer=18&fase=V&typeVeg=GANG_OG_SYKKELVEG%2CSYKKELVEG%2CGANGVEG%2CG%C3%85GATE%2CFORTAU%2CTRAPP%2CGANGFELT mot ATM med 
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""852"" tempId=""e6dbb25f-c45c-4dfa-b36f-9271c4a81b09""><egenskaper><egenskap typeId=""9721""><geometri><srid>25833</srid><wkt>LINESTRING (135452.51403221354 6498589.168990206 46.677, 135452.6697585481 6498589.861041403 46.7)</wkt><datafangstdato>2019-06-11</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>96</målemetode><målemetodeHøyde>96</målemetodeHøyde><nøyaktighet>5</nøyaktighet><nøyaktighetHøyde>5</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-11-20</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
gjør at Skriv må utvide geometrien ved kallet mot Les. Utvidelsen gir imidlertid følgende kall mot Les
{noformat}
{""geometri"":""POLYGON EMPTY"",""maks_avstand"":""300"",""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV18"",""trafikantgruppe"":null,""typeveg"":""gangOgSykkelveg,sykkelveg,gangveg,gågate,fortau,trapp,gangfelt"",""tidspunkt_start"":""2020-11-20"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
som git HTTP 500

h2. Analyse

En LineString på ca 0.5 meter skal strekningsstedfestes. Siden ruten ikke har minimumslengde (1.0 m), blåses geometrien litt opp slik at det blir et polygon. Etter oppblåsing gjøres en Douglas-Peucker for å redusere antall punkter. I og med at punktene allerede er tette og terskelverdien er 0.05 m. Kollapser polygonet ved kjøring av DP, og det returneres POLYGON EMPTY.

h2. Løsning

Justerte noen parametere i oppblåsingsalgorirmen + la inn en sjekk på kollapset geometri etter punktreduksjon.",NVDB-6937,Skriv-API,
Script for å rydde og rapportere multigeometri,"I forbindelse med strenging for multigeometri der det ikke er tillatt (NVDB-4439) så må også Datafangst se på data som er i database fra før.

Vi trenger et script som kan gå gjennom og konvertere det som er multigeometri med ett element til singlegeometri, og kanskje også slå sammen multilinjer som egentlig er en sammenhengende linje.
Scriptet må rapportere på elementer som ikke kan konverteres automatisk, og skille på hva som er sendt inn og hva som ikke er det (READ / WRITE for geometri).",NVDB-6937,Datafangst,
POINT returneres for rutesegment,"h2. Observasjon

POST /rute med 
{noformat}
{""geometri"":""LINESTRING (136845.14 6500207.76, 136845.25 6500214.46, 136843.77 6500219.92, 136837.05 6500231.17)"",""maks_avstand"":""300"",""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""E,K,F,R"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-11-20"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
gir problemer i Skriv pga wkt er POINT for et rutesegment (0.39680943-0.40801584@2804908). Observert i UTV og ATM.

 
h2. Løsning

Første og site segment i en rute kuttes for å tilpasse seg geometrien det spørres på. I tilfellene her ble det som var igjen så kort at det bare ble et punkt i geometrien som var likt med siste koordinat i forrige segment. Dette ble løst ved å utelate disse potensielle segment-punktene i starten og slutten på en rute. ",NVDB-6937,Les-API,
Gang- og sykkleveg mangler under gående og syklende.,"Ved avkryssing av Sykkelveg vises også Type Gang- og sykkelveg.
 Ved avkryssing av  Gangveg vises Gang- og sykkel veg.

Det mangler et valg for Gang- og sykkelveg under Gående og syklende.
 Når vi krysser av for Sykkelveg skal bare denne typen vises, samme med Gangveg og Gang-og Sykkelveg. Valgene her skal gjenspeile veg typene som ligger i NVDB.",NVDB-6937,Vegkart,
NPE ved henting av fartshumper med filtre,"h2. Observasjon

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/103?kartutsnitt=157969.513,6883029.486,446344.757,6968458.324&kommune=3426,3430&segmentering=true&egenskap=(1156%3D3594)+AND+(10288%3E2010+AND+10288%3C%3D2015)&inkluder=metadata,geometri]

gir HTTP 500 NPE

Kom fra Vegkart-søk
{noformat}
https://vegkart.utv.atlas.vegvesen.no/#kartlag:geodata/@302157,6925744,8/hva:~(~(category~(id~10288~type~'interval)~intervals~(~2010~2015)~filter~(~(operator~'*3d~type_id~1156~verdi~(~3594)))~id~103)~(category~(id~1298~type~'interval)~intervals~(~50~100~500)~filter~(~(operator~'*3d~type_id~1089~verdi~(~13747)))~id~5))/hvor:~(kommune~(~3430~3426))
{noformat}",NVDB-6937,Les-API,
Driftskontrakt V4: Endre rekkefølger på kolonner,"Ønske om å endre rekkefølgen på kolonner i V4-mengderapporten: 

først NVDB Id (som i dag), så filtreringshjelp, vegsystemreferanse, egenskaper og så resten. 

 

 ",NVDB-6827,Rapportgenerator,
Støtte for bildekomprimering,Ved innsending av bilete som dokumentasjon bør det vere automatisk komprimering av bilete (og evt. anna dokumentasjon) for å møte grense for vedlegg i NVDB.,NVDB-6937,Datafangst,
Analyse: Endre grense for for vedlegg i dokumentasjon,"Grensa for storleik på vedlegg (BLOB-egenskap) i vegobjekttypen Dokumentasjon er for låg, spesilet på bilete. Den må aukast til ei fornuftig grense for både brukar og NVDB.
{quote}Må undersøke om det må endrast noko i NVDB og/eller datakatalog.
{quote}",NVDB-6937,Skriv-API,
Oppdatere påloggingshjelp for FK,"Fylkeskommunetilsette med p-brukar har same rutiner for påloggingshjelp som SVV. Info under ""Trenger du hjelp?"" må oppdaterast for å vise det.",NVDB-6937,Datafangst,
E2E-test av inkrementell lagring,"Det mangler tester som sjekker at features kan lagres på nytt med Korriger etter å først ha blitt lagret som nye objekter. Dette innebærer tester på datafanen og stedfestingsfanen, samt re-registrering av korrigerte objekter.",NVDB-6937,Datafangst,
Fjern gammel Skriv-integrasjon,Fjern kode og innstillinger for gammel integrasjon mellom NVDBIND og NVDB API Skriv.,NVDB-6937,NVDB-IND,
Tidssone «SISTE HENDELSER»,Tidspunkt på hendelser under «SISTE HENDELSER» er GMT. Endre til lokal tidssone.,NVDB-6937,Les-API,
Jenkinsfile for integrasjonstester,Ønsker å sette opp en jobb på SVV Jenkins som kan kjøre integrasjonstestene uavhengig av andre jobber. Lager en Jenkinsfile.,NVDB-6937,Datafangst,
Release med tjenestebruker,"I Jenkins må byggeplanene

* NVDB Vegkart - Release
* NVDB Export - Release

omkonfigureres til å bruke TjeVegkartDeploy_Atlas som ATLAS_USR og tilhørende passord fra PAM som ATLAS_PWD.",NVDB-6937,Vegkart,
E2E-test av stedfesting,E2E-testene av stedfestingsfanen har vært disabled siden fanen ble ny. Oppgaven går på å lage nye tester med API Skriv som stedfestingstjeneste.,NVDB-6937,Datafangst,
Integrasjon med API Skriv på Atlas,"(!) Se Installasjon lengre ned
h2. Bakgrunn

NVDB API Skriv er migrert over til Atlas.

URLer må skiftes ut slik:

*STM*
 [https://www.utv.vegvesen.no/nvdb/apiskriv/] => [https://nvdbapiskriv-stm.utv.atlas.vegvesen.no/]

*ATM*
 [https://www.test.vegvesen.no/nvdb/apiskriv/] => [https://nvdbapiskriv.test.atlas.vegvesen.no/]

*PROD*
 [https://www.vegvesen.no/nvdb/apiskriv/] => [https://nvdbapiskriv.atlas.vegvesen.no/]

De gamle URLene vil fungere ca fram til påske, så dette må gjøres innen da.

AAA-autentisering vil riktignok fungere i Atlas en periode, men autentisering med OpenId Connect bør implementeres. Se online dok for detaljer: [https://apiskriv.vegdata.no|https://apiskriv.vegdata.no/]
h2. Installasjon

Konfigurasjon i STM og ATM er riktig som default og trenger ikke å endres.

For prod så må URL i /opt/datafangst/config/application.properties endres samtidig med prodsetting.",NVDB-6937,Datafangst,
Ikon for velgemodus i kart vises ikke,"h2. Observasjon

Ikonet for å slå på Velge-modus vises ikke lenger. observert i UTV og PROD

!image-2020-11-17-19-24-24-742.png!
h2. Analyse

Da den gamle stedfestingsfanen ble slettet førte det til css-for denne knappen i datafanen sluttet å virke, fordi datafanen gjenbrukte css-regler fra stedfesting uten at css-reglene ble flyttet opp til et mer globalt scope. Det har ført til at når den gamle stedfestingsfanen ble slettet ble også css-reglene for denne knappen i datafanen slettet. (css-filen ble liggende igjen, men den ble aldri importert)


h2. Løsning

endret navn på html-klassene for knappen til å samsvare med klassene for knappen i ny stedfesting.

løftet css-for denne knappen opp til mer globalt nivå.

slettet den gamle stedfesting-css-filen som også hadde bitt liggende igjen.

 ",NVDB-6937,Datafangst,
Ingen objekter segmentert med nytt kontraktsområde,"Kontraktsområde «4607 Sunnfjord sør» har nå tre versjoner, 2021, 2022, og 2032.
https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/580/1010943929/2.json
https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/580/1010943931/2.json
https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/580/1010943932/2.json

Alle har startdato 2020-10-29, men det er kun 2021 det er segmentert objekter med.",NVDB-6937,NVDB-IND,
Disable Sentry,,NVDB-6937,Vegkart,
Last kun geometri i søkemodus,"Vegkart bruker nå ?inkluder=metadata,egenskaper,lokasjon,geometri.
Ved å endre til ?inkluder=metadata,geometri vil responsen bli betydelig mindre.",NVDB-6937,Vegkart,
Rydd bakoverkompatiblitet NVDB-5017,"NVDB-5017 endrer hvordan geometriegenskaper lagres for noder og veglenker. 
Fjern koden som leser det på gammelmåten.",NVDB-6937,Les-API,
Avslutte Sentry,,NVDB-6937,Datafangst,
Inkludere konnekteringslenke og filtrere i etterkant,"h2. Bakgrunn

Saken går på at det er mange vegobjekter i Datafangst som ikke får stedfesting gjennom Skriv siden Les gir ingen rute tilbake når konnekteringslenker er satt til false. Gammel stedfesting for Datafangst ga konnekteringslenker tilbake s.a. Datafangst filtrerte selv i etterkant.

*Fra Mattermost* ([https://mattermost.kantega.no/svv/pl/8gbpzzoi77y1dpocdgr9qft4ro])

Har sett på noen vanskelige tilfeller av stedfesting med Skriv. Vedlagte SOSI (843_difficult.sos) er utdrag av større SOSI (843.sos) med noen vanskelige tilfeller. Manuell stedfesting med Skriv genererer følgende kall mot Les for utvalgte kurver. Problemet er generelt at det ikke finnes ruter. *MEN* om vi setter {{konnekteringslenker=true}} finnes det ruter (da med rutesegmenter som ikke er konnektering OG konnekteringslenker).

Gammel stedfesting finner stedfesting for alle. Er det ikke slik at vi for gammel stedfesting får konnekteringslenker, men filtrerer bort disse i Datafangst?

Hva tenker folk om å be om konnekteringslenker også for Datafangst og heller filtrere disse bort i Skriv/Datafangst etter at rute er oppnådd fra Les? Eksemplene her er typiske eksempler hvor det er veier som møtes. Alternativet her blir jo å stedfeste alle som går med Skriv og deretter velge gammel for de som ikke går. Alle 1018 objektene i 843.sos er tatt fra Prod og reflekterer reelle situasjoner vi helt sikkert kommer borti mange ganger.
 
{noformat}
KURVE 246 
{""geometri"":""LINESTRING (138553.42 6501292.32, 138554 6501288.68, 138546.53 6501278.28, 138489.17 6501242.18)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 255 {""geometri"":""LINESTRING (138554.32 6501292.18, 138572.76 6501271.68)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""FV409"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 258 {""geometri"":""LINESTRING (138568.71 6501250.91, 138562.89 6501231.29)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV18"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker 

KURVE 278 {""geometri"":""LINESTRING (138591.19 6501078.74, 138598.13 6501077.81, 138601.35 6501076.33, 138604.65 6501071.57)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV18"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-13"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true} 
--> Ikke funnet rute 
--> OK med konnekteringslenker
{noformat}

*Kommentar fra Tore:*

Skriv anroper Les /rute med konnekteringsparameter=JA/NEI avhengig av om vegobjekttypen tillater det. Tanken var nok opprinnelig at Les da skulle foreta denne filtreringen, men det har jo runnet en del vann i Gaula siden da. Mulig Skriv skal sende konsekvent JA her og plukke ut konnekteringslenkene etterpå selv. Dermed blir det som i gammel DF-løsning.

h2. Analyse

Min kommentar ovenfor var nok litt forhastet. Stedfestingstjenesten bruker faktisk allerede strategien som angitt over. Årsaken til at det ikke fungerer som tenkt er at requesten til Les sin rutetjeneste påføres ""konnekteringslenker"": false når det ikke skal stedfestes på konnekteringslenker (punktstedfesting), mens det *ikke* angis ""konnekteringslenker"": true når det kan stedfestes på konnekteringslenker (strekningsstedfesting, med filtrering i etterkant).

h2. Løsning

Setter eksplisitt ""konnekteringslenker"" i requesten til Les, enten verdien fra RouteParams.isConnectingRefLinksAllowed() er true eller false",NVDB-6937,Skriv-API,
Visning av stedfesting på flere veger,"h2. Observasjon

Importer denne som Korriger

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/92?segmentering=true&kartutsnitt=267378.496%2C7030892.506%2C268522.821%2C7031490.796&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Sjekk stedfestingsfanen. Der ligger det noen i venstremeny med ""mangler stedfesting"" selv om de har det. Marker disse og se at det kommer opp ""undefined"" under stedfestingsinformasjonen (se skjermbilde vedlagt). Gjelder bl.a. 1006210798, 1006210799 og 1006210802.

Mulig denne løses ved NVDB-5709.
h2. Analyse

1006210798 er stedfestet på to forskjellige veger (E6 og FV704), men representasjonsmodellen til Datafangst tar bare høyde for at et vegobjekt kan være stedfestet på én veg. Dette gjelder også ved import av stedfesting, hvis den er stedfestet på flere veger blir den lagret uten veg.
h2. Løsning

Støtte stedfesting på flere veger ved nye importer. Støtte visning av stedfesting som er stedfestet til flere veger.",NVDB-6937,Datafangst,
Tegning av re-stedfestet NVDB-objekt blir upresis,"h2. Observasjon

Kommer fra test av NVDB-6001.

*Gjenskap*

Importer følgende som Korriger (case fra NVDB-6032)

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Stedfest manuelt Skjerm 101895592 og Avstandsmåling 377099404 til nærmeste vei. Da får skjermen vist stedfesting som ikke henger på veien, og avstandsmålingen får vist stedfesting langt unna på samme vei. Se vedlagt ""nvdb6032case.png"".

Imidlertid ser selve stedfestingene fine ut (de er like for begge objektene).

*Kommentar fra Håvard på NVDB-6001*

Jeg klarer fortsatt ikke å reprodusere lokalt, men feilen må nok opprettes som en egen sak.

For avstandsmåling:
 Jeg sjekker verdiene i databasen, og feature_locational2.projected_from_wkt har verdier som samsvarer med geometrien for objektet, dvs. at vi har generert riktige punkter for stedfesting. Det som imidlertid er feil er feature_locational2.wkt, dvs. beregnet geometri for stedfesting. Det er endepunktene her som gir den store sirkelen, så man kan egentlig se på bildet at å finne endepunkter i objektets geometri er riktig.

Ser også ut som vi får riktig verdi for wkt for stedfesting fra Skriv, så det skjer noe etterpå (og som er utenfor koden som er endret her). Har ikke klart å spore det helt, men _antar_ at det er noe i kode som sjekker om datter er innafor mor og gjør eventuell utvidelse av WKT, det er i alle fall det eneste stedet som jeg ser som vi gjør endringer på denne.

For skjerm:
 Hvis du ser nøye så er det en liten prikk i hver ende av objekter. Jeg tror at dette er linja ned på veg, og at det vises sånn fordi det er små forskjeller i geometrien som vi får fra Skriv / Les gjennom stedfesting, og vegnettet fra VisVegInfo.
 Har i alle fall gått gjennom koden og ser at vi finner riktige verdier, og plassering av sirkelen / linje ned på veg kommer uansett fra WKT for stedfesting, som vi ikke rører her.

Et ekstra poeng er at koden i denne saken har allerede kjørt én gang før du endrer stedfesting, siden den kjører når vi importerer vegobjekter fra NVDB, og da kommer jo ikke denne feilen. Forskjellen er at ved import fra NVDB prøver vi ikke å flytte datter innafor mor.

Dette er ganske mystisk, men jeg tror vi kan gå videre med testing av denne, og skrive opp oppførselen for avstandsmåling som egen sak.
h2. Analyse

Feilen oppstår fordi vi har sammenkoblede objekter der mor har feil i stedfestingen sin. 
 Mor sin stedfestingsfeil er fikset i en annen sak, men det har resultert i at det finnes vegobjekter med denne feilen lagret i NVDB, og det er derfor denne kan gjenskapes her.
 Feilen har oppstått fordi tidligere stedfestingsmetoder har brukt VisVegInfo sin veg-geometri til å generere stedfestinger. Problemet med VisVegInfo er at den bruker en forenklet geometri av vegnettet med mye lavere oppløsning enn det vegnettet egentlig har. det resulterer i at når vi skal manipulere stedfestinger, f.eks ved klipping og trimming og flytte datter innenfor mor, vil få feil verdi når prøver å måle lengdene på veg-geometrien. Resultatet blir stedfestings-posisjoner som er feil, men en wkt som ser riktig ut.

Vi identifiserte dette problemet og har gjort endringer i metodene som flytter datter innenfor mor til å bruke geometri fra Les istedet for VVI, men når objektene er lagret med feil stedfestigngs-verdi, vil også stedfestingsgeometrien vi genererer basert på disse bli feil.

I dette tilfellet så har mor (rekkverk) feil stedfestingsverdier (men riktig wkt).

Ved stedfesting av datteren (avstandsmåling) får vi en stedfesting basert på høyoppløst vegnett fra Les. vi ser så på mor, og genererer en høyoppløst geometri basert på vegnettet fra Les, men med de gamle verdiene som er lagret i stedfestingen til mor som kommer fra VVI. resultatet er at den geometrien vi genererer for mor får en forskyvning i forhold til geometrien vi ville ha fått fra VVI, og blir liggende ganske langt unna datter. Vi prøver deretter å flytte stedfestingen til datter innenfor denne feilaktige geometrien til mor, og det gir disse merkelige resultatene vi ser her.
h2. Løsning 

Situasjonen løser seg enkelt ved å re-stedfeste mor, fordi mor vil da få en stedfesting basert på høyoppløst vegnett fra Les.

Det er derimot vanskelig for brukerne å skjønne når vi er i en slik situasjon. For å forbedre opplevelsen kan det legges inn tiltak ved å prøve å restedfeste mor og se på om den nye stedfestingen har andre verdier enn den gamle, og så gi tilbakemelding til brukeren om at mor må restedfestes, evt løse det automatisk. 

 

 

 

 

 ",NVDB-6937,Datafangst,
Kommune gir 0 treff når områdefilter er på,"Objekttypen ""Kommune"" gir 0 treff når områdefilter er på.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@303196,7090016,5/hva:~(~(id~946))/hvor:~(fylke~(~50))]

Utan områdefilter fungerer det som det skal.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@303196,7090016,5/hva:~(~(id~946))]",NVDB-6937,Les-API,
alle_versjoner ikke tatt hensyn til ved vegsystemreferanse,"Richard Virion <richard_virion@trimble.com>:
{quote}
Vi ser at når man henter data med vegsystemreferanse parameteren blir historiske data ikke med. Men hvis vi bruker polygon parameteren blir historiske data returnert.
Er det en begrensing i vegsystemreferanse indeksen?

Her er et eksempel:
https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/915?alle_versjoner=true&segmentering=false&vegsystemreferanse=FV6092S1&fylke=15

Vi forventer å få disse objektene tilbake: 1002115196 (lukket), 1002115184 (lukket), 1002155011 (gyldig), 1003090402 (lukket). Vi får kun gyldig objektet.

Hvis vi sender en polygon rundt FV6092S1 får vi alle objektene som forventet.
https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/915?alle_versjoner=true&segmentering=false&polygon=118290.2680623 7014145.1641853,118633.449190096 7014337.76583866,119078.183916933 7014603.90630511,119529.922340256 7014666.93957348,119750.538779553 7014628.41924281,119978.158915335 7014691.45251118,120282.81971246 7014757.98762779,120576.974964856 7014800.00980671,120664.521170926 7014687.95066294,120366.864070287 7014558.38227795,119964.151522364 7014544.37488498,119648.985180511 7014498.85085783,119347.826231629 7014505.85455431,119092.191309904 7014414.8065,118787.53051278 7014229.20854313,118549.404832269 7014082.13091693,118269.256972844 7014043.61058626,118290.2680623 7014145.1641853
{quote}",NVDB-6937,Les-API,
FKB-typer der to mapper til NVDB-type mangler én på hjem-fane.,"E-post fra Ann Helen Karlsen (annk@viken.no). Hun påpeker at i de tilfellene der det er to FKB-typer som mapper til én NVDB-type i kontraktens objektliste, så vises bare den ene FKB-typen på oversikt på hjem-fanen.

Se hele Ann Helens mail i vedlegg.",NVDB-6937,Datafangst,
Skrivefeil i feilmld-boks,"*Observasjon fra support.*

Feilmeldingsboks (typisk ved registrering og 400-feil) inneholder en skrivefeil:
{noformat}
Registere vegobjekter i NVDB
Det har oppstått en intern feil. Hvis feilen gjentar seg, ta kontakt med datafangst support og oppgi feilkode QkLoMyOv
{noformat}
Det skal være ""RegistRere"".",NVDB-6937,Datafangst,
Fane for oppdrag og transaksjoner i Kontrollpanelet,"API Skriv har offentlige endepunkter for oppslag i oppdrag og transaksjoner. Disse ressursene er nyttige i forbindelse med feilsøk hos utviklere, men også for systemadmins for å avdekke kilden til datafeil i NVDB.

Ved overgang til Atlas kan man ikke bruke disse endepunktene direkte fra nettleser uten å ha med Authorization: Bearer xyz.

Det foreslås derfor å etablere ny fane for dette a la dagens fane for låser. Fanen kan f.eks. hete ""Oppdrag"" eller ""Transaksjonsjonslogg"", et begrep som brukes av erfarne NVDB-forvaltere. Denne bør kun være tilgjengelig for brukere med fagdata_admin- eller system_admin-rollen. Oppdrag og transaksjoner presenteres grafisk på samme måte som i Låser-fanen.
",NVDB-6937,Skriv-API,
Byggeplan for Release,"Etabler byggeplan ""NVDB API Skriv - Release"" etter mal av tilsvarende for NVDB API Les. Denne skal utføre maven release, deploye til Artifactory og bygge Atlas Docker Image.",NVDB-6937,Skriv-API,
Lokal kjøring med Quarkus feiler noen ganger med classloader-feil i Jersey,"Jeg får noen ganger en feil i classloading når jeg kjører lokalt med ""mvn quarkus:dev"".
Hvis jeg starter på nytt så er det som regel OK neste gang. Quarkus bruker flere classloadere ved lokal kjøring, men bare én når det ikke er utviklingsmodus, så så vidt jeg skjønner er det ingen sjanse for at dette skjer i prod.

Kan virke som det er en race condition i konfigurasjon, sånn at det er mulig at en klasse lastes flere steder.

Alternative løsninger er å gå tilbake til sette eksplisitt classloader for kjøre jersey Client (sånn som det var med RestStop), skrive om til å bruke noe annet enn Jersey client, eller finne ut om det er noe spesielt vi gjør med konfigurasjon som gjør at vi trigger dette. Den gangen vi hadde wrapper for å kalle jersey client i integrasjonsmodulen, så virka det fint å bruke Jersey client i andre moduler uten wrapper, så det kan virke som vi gjør noe litt spesielt der.

Stacktrace:
{noformat}
Caused by: java.lang.ClassCastException: class org.glassfish.jersey.jaxb.internal.JaxbAutoDiscoverable cannot be cast to class org.glassfish.jersey.internal.spi.AutoDiscoverable (org.glassfish.jersey.jaxb.internal.JaxbAutoDiscoverable is in unnamed module of loader 'app'; org.glassfish.jersey.internal.spi.AutoDiscoverable is in unnamed module of loader io.quarkus.bootstrap.classloading.QuarkusClassLoader @508ea8c7)
	at org.glassfish.jersey.model.internal.CommonConfig$2.compare(CommonConfig.java:594)
	at java.base/java.util.TreeMap.compare(TreeMap.java:1292)
	at java.base/java.util.TreeMap.put(TreeMap.java:536)
	at java.base/java.util.TreeSet.add(TreeSet.java:255)
	at java.base/java.util.AbstractCollection.addAll(AbstractCollection.java:352)
	at java.base/java.util.TreeSet.addAll(TreeSet.java:312)
	at org.glassfish.jersey.model.internal.CommonConfig.configureAutoDiscoverableProviders(CommonConfig.java:612)
	at org.glassfish.jersey.client.ClientConfig$State.configureAutoDiscoverableProviders(ClientConfig.java:364)
	at org.glassfish.jersey.client.ClientConfig$State.initRuntime(ClientConfig.java:399)
	at org.glassfish.jersey.client.ClientConfig$State.access$000(ClientConfig.java:90)
	at org.glassfish.jersey.client.ClientConfig$State$3.get(ClientConfig.java:122)
	at org.glassfish.jersey.client.ClientConfig$State$3.get(ClientConfig.java:119)
	at org.glassfish.jersey.internal.util.collection.Values$LazyValueImpl.get(Values.java:340)
	at org.glassfish.jersey.client.ClientConfig.getRuntime(ClientConfig.java:733)
	at org.glassfish.jersey.client.ClientRequest.getConfiguration(ClientRequest.java:286)
	at org.glassfish.jersey.client.JerseyInvocation.validateHttpMethodAndEntity(JerseyInvocation.java:135)
	at org.glassfish.jersey.client.JerseyInvocation.<init>(JerseyInvocation.java:105)
	at org.glassfish.jersey.client.JerseyInvocation.<init>(JerseyInvocation.java:101)
	at org.glassfish.jersey.client.JerseyInvocation.<init>(JerseyInvocation.java:92)
	at org.glassfish.jersey.client.JerseyInvocation$Builder.method(JerseyInvocation.java:420)
	at org.glassfish.jersey.client.JerseyInvocation$Builder.get(JerseyInvocation.java:316)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbWriteApiGateway.lambda$getLdapUser$12(DefaultNvdbWriteApiGateway.java:389)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbWriteApiGateway.catchAndRethrow(DefaultNvdbWriteApiGateway.java:482)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbWriteApiGateway.getLdapUser(DefaultNvdbWriteApiGateway.java:389)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbWriteApiGateway_ClientProxy.getLdapUser(DefaultNvdbWriteApiGateway_ClientProxy.zig:222)
	at no.svv.nvdb.datafangst.nvdb.NvdbUserServiceImpl.getNvdbLdapUser(NvdbUserServiceImpl.java:44)
	at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
	at java.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:948)
	at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)
	at java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)
	at java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:746)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)
{noformat}
",NVDB-6937,Datafangst,
"Vegliste: Lese ""tillatt for modulvogntog""-egenskap fra NVDB","Inntil videre faker vi ""tillatt for modulvogntog"" = Ja på serversiden til den nye modulvogntog-veglisten, for det finnes ikke gyldige data i NVDB (ennå)

Ganske snart vil NVDB ha gyldige data på denne egenskapverdien, og da bør vi legge om til å lese rett fra NVDB. ",NVDB-6825,Rapportgenerator,
Send med unik ID i kall til Skriv og Les,"Tore oppfordrer om å sende med header ""X-REQUEST-ID"" med en unik ID for requester til Skriv og Les. Om den er med til andre systemer her det heller ikke noe å si, så kan legges inn på generell interceptor under ""integration"".

Pass også på å få med bruk av Skriv i SecurityServiceImpl, som ikke dekkes av filter i integration-modulen.

ID må logges hos oss så vi får etablert sammenheng, og den kan gjerne inneholde den request-ID'en som vi genererer når backend mottar et request også.",NVDB-6937,Datafangst,
Får ikke stedfesting med valgt veg,"h2. Observasjon

Får denne i prod, og har reprodusert lokalt. Når jeg sender inn med valgt veg (EV134) får jeg ikke stedfesting, men hvis jeg dropper å velge veg så går det bra.

Request: [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegkategori=E&vegnummer=134&fase=V&typeVeg=KANALISERT_VEG%2CENKEL_BILVEG%2CRAMPE%2CRUNDKJ%C3%98RING%2CGATETUN]

Data:
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?>
<vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3"">
    <vegobjekt typeId=""92"" tempId=""aee93e82-c506-44f4-be09-06e42433ad6f"">
        <egenskaper>
            <egenskap typeId=""4792"">
                <geometri>
                    <srid>25833</srid>
                    <wkt>LINESTRING (-19111.260646962503 6643191.596462952 3.31, -19099.638620709477 6643195.484930785 2.81, -19085.646802011877 6643200.406781235 3.04, -19085.63681415812 6643200.405873666   3.0700000000000003,   -19041.73912521673 6643214.160913138 3.42, -19015.10926068644 6643222.959460426 3.61,   -18990.687467476353   6643228.182277681 3.17, -18978.581337546697 6643228.200029384 3.0300000000000002,   -18954.863862368453   6643226.5584692415 2.74, -18919.150046994793 6643222.839943237 2.54, -18892.618726656714   6643220.690940182 2.7,   -18874.531661867746 6643219.037346501 2.63, -18847.00154484372 6643216.243720112 2.34,   -18830.974698344187   6643214.636349644 2.24, -18812.079512891534 6643212.345388888 2.5300000000000002,   -18796.152567622077   6643211.190190068 2.46, -18763.97539194103 6643207.672192546 2.67, -18740.77638078481   6643205.201633486 2.7,   -18732.150447438995 6643202.383620459 2.81, -18726.969563099672 6643203.655008901 2.81,   -18683.93381504604   6643198.838148885 2.65, -18667.202387775935 6643197.00563425 2.8000000000000003,   -18665.962967545318   6643196.349216298 2.81, -18663.067402984074 6643195.9652614575 2.83, -18654.76488624455   6643197.2349637905 2.88,   -18624.894126985222 6643196.3736286005 3.14, -18561.088489930436 6643194.0500479555 3.33,   -18550.55405911745   6643192.7302860515 3.49, -18527.516782432678 6643192.026656758 3.42, -18496.8961958164   6643194.319675181 3.37,   -18492.62416109169 6643194.455142525 4.23, -18486.152151656162 6643195.971737502 4.13,   -18480.252170056803   6643197.510099924 4.04, -18466.022546030872 6643202.722491489 3.81, -18462.073803159816 6643204.065556583 3.75, -18448.502514536784 6643210.455567327 3.79, -18412.73153364251 6643225.875436061 3.91)</wkt>
                    <referansegeometri>false</referansegeometri>
                    <kvalitet/>
                </geometri>
            </egenskap>
        </egenskaper>
        <gyldighetsperiode>
            <startdato>2020-11-11</startdato>
        </gyldighetsperiode>
    </vegobjekt>
</vegobjekter>
{noformat}
h2. Analyse

Ruteberegneren til API Les klarer ikke levere sammenhengende rute.

Request:
{noformat}
1 > POST https://nvdbapiles-v3.atlas.vegvesen.no/beta/vegnett/rute
1 > Accept: application/json
1 > X-Client: NVDB API Skriv
1 > Content-Type: application/json
1 > X-REQUEST-ID: aee93e82-c506-44f4-be09-06e42433ad6f
1 > svvguid: 0b49dde8-3bd8-450a-9362-1180575d8a83
{""geometri"":""LINESTRING (-19111.26 6643191.6, -18990.69 6643228.18, -18527.52 6643192.03, -18412.73 6643225.88)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""EV134"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring,gatetun"",""tidspunkt_start"":""2020-11-11"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false,""behold_trafikantgruppe"":true}
{noformat}
Respons:
{noformat}
2 < 200
2 < Access-Control-Allow-Origin: *
2 < Access-Control-Allow-Methods: GET, POST, OPTIONS
2 < X-REQUEST-ID: aee93e82-c506-44f4-be09-06e42433ad6f
2 < Date: Wed, 11 Nov 2020 12:27:27 GMT
2 < Access-Control-Allow-Headers: accept, x-client, x-client-session, origin, content-type
2 < X-Robots-Tag: none
2 < Cache-Control: no-cache
2 < X-Datakatalog-Versjon: 2.22
2 < Set-Cookie: bd9905a474ad1ff0c3612b8d8c7da59d=6a3467d3e7ddb00a10810bb4491f3379; path=/; HttpOnly; Secure
2 < Content-Length: 119
2 < Access-Control-Max-Age: 1728000
2 < Content-Type: application/json;charset=utf-8
{""vegnettsrutesegmenter"":[],""metadata"":{""antall"":0,""lengde"":0.0,""status"":2060,""status_tekst"":""LENGSTE_SAMMENHENGENDE""}}
{noformat}
h2. Løsning

Om typeVeg er med i request-en brukes denne til å bestemme trafikantgruppe, ellers brukes geometri eller punkter som før.",NVDB-6937,Les-API,
Datafangst genererer SOSI som ikke lar seg importere,"Jeg skulle prøve å reprodusere noe som jeg snubla over på support, og tok SOSI-nedlasting fra eksport-fanen. I dette tilfellet kontrakt 830cfe6e-6ad1-42cb-9bc9-5d339053d232 i prod, og type kabel. Valgte type ""korriger"" (siden data allerede var sendt til NVDB), og tok bort markering for format kompatibelt med NVDB123.

Eksporter fil mangler ""datafangstdato"" og ""kvalitet"", og derfor blir alle vegobjekter avvist ved import. Jeg får også noen litt rare feilmeldinger på steder det ser ut om de ikke hører hjemme, men det kan være følgefeil.",NVDB-6937,Datafangst,
Brukerdokumentasjon,"Enkel brukerdokumentasjon.

På samme nivå som Les API ([https://www.vegdata.no/nvdb-api-les/)]

WordPress...",,Rapportgenerator,
Store transaksjoner bruker opp minne,"https://nvdbapiles-v3.atlas.vegvesen.no/transaksjoner?fra=2020-10-25T00:00:00&til=2020-10-26T00:00:00
Inneholder transaksjoner som er så store at api-noden i noen tilfeller tryner med OOM.
Så vi må strømme på lavere nivå.",NVDB-6937,Les-API,
Release og deploy (Atlas 2.0),"* Back end: (/)
 * Front end: (/)",,Rapportgenerator,
Eksponer antallet requester som feiler som metrikk,Vi vil ha data om antallet requester som feiler/er ok i Grafana. ,NVDB-6937,Les-API,
V1 vegnettsrapport: Beredskapsveg og serviceveg,"Avklaring - hvordan håndterer vi ""beredskapsveg"" og ""serviceveg"" i vegnettsrapporten? Dette er egne objekttyper med få forekomster, og vi bør kunne sjekke for overlapp uten at det går ut over ytelsen. 

Ett alternativ er at vi bruker kolonnen ""TypeVeg"" NVDBREF-843 til å holde på beredskap- og serviceveg. 

Avklares med vegnettsgruppa",NVDB-6827,Rapportgenerator,
Fane for å slå opp i /les-endepunkter i Kontrollpanelet,"API Skriv har noen ressurser som gir innsyn i NVDB. Disse ressursene er nyttige for å se hvordan objekter faktisk er lagret.

Ved overgang til Atlas kan man ikke bruke disse endepunktene direkte fra browser uten å ha med Authorization: Bearer xyz.

Oppgaven går ut på å opprette en ny fane ""Innsyn"" i kontrollpanel som gjør kall mot disse ressursene på vegne av brukeren (da med JWT):

* /rest/v3/les/vegobjekt/{typeId}/{vegobjektId}/{versjon}
* /rest/v3/les/veglenkesekvens/{veglenkesekvensId}
* /rest/v3/les/node/{nodeId}
* /rest/v3/les/område/{typeId}/{vegobjektId}?veglenkesekvensId={veglenkesekvensId}

Verdier angitt med {} skal kunne angis som parametere.

Fanen skal kun være tilgjengelig for system_admin-brukere.",NVDB-6937,Skriv-API,
Datakontroll inn i Atlas,"Datakontroll skal inn i Atlas-miljøet heller enn å kjøre på applikasjonstjenerne. Vi må også gå over fra å bruke LDM20 til å bruke en ny rest-tjeneste for autentisering og autorisering.

Stegene som må gjøres i følge Marvin:
•	Opprette miljø https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/create/create_env.html
•	Opprette deploymentbeskrivelse https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/init/init_config.html
•	Opprette et Docker-image basert på en jar/war https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/build/build.html
•	Opprette vault https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/init/init_vault.html
•	Legge inn databasepassord https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/init/init_secret.html
•	Opprette en kjørende instans https://atlas-docs.atlas.vegvesen.no/atlas-dokumentasjon/latest/client/create/create_deploy.html
",NVDB-6937,Datakontroll,
Oppdater NVDBIND->Skriv til OIDC og ny url,Implementer ny innlogging mot Skriv siden Skriv nå er på Atlas.,NVDB-6937,NVDB-IND,
Vegsystem mangler vegnummer i vegsystemreferansen,"h2. Observasjon

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/1001492.json] har vegsystemreferanse med et vegsystem uten vegnummer (kortform blir ""PVnull"").

Vegsystemet har nummer:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/915/1002512240/1.json]

 ",NVDB-6937,Les-API,
HTTP 500 ved /stedfest,"h2. Observasjon

En bruker (oyslun) rapporterer om konsekvent feil ved stedfesting av et vegobjekt.

Request:

POST https://www.vegvesen.no/nvdb/apiskriv/v3/stedfest?maksimumAvstandTilVeg=300&vegnummer=134&vegkategori=E&fase=V&typeVeg=ENKEL_BILVEG

<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""852"" tempId=""32f37a02-977b-4be1-b3f3-b2ac910001ae""><egenskaper><egenskap typeId=""9721""><geometri><srid>25833</srid><wkt>LINESTRING (-21255.467397820612 6643042.37843815 8.72, -21253.739523636526 6643043.550738106 8.41, -21248.732013696514 6643046.12694282 7.54, -21246.9006521118 6643047.883998728 7.26, -21246.48484532733 6643049.246015512 6.86, -21246.5575353076 6643050.440939918 6.55, -21248.695011539734 6643051.521369989 6.45, -21254.140263362555 6643050.999042361 6.09, -21266.778553300188 6643047.233038662 5.2700000000000005, -21268.616365672147 6643047.732361575 5.5200000000000005, -21269.55438904109 6643049.156973922 5.57, -21270.865609303117 6643050.796766616 6.1000000000000005, -21275.35977134196 6643062.071212064 6, -21276.666490542004 6643064.64715296 5.93)</wkt><referansegeometri>false</referansegeometri><kvalitet/></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-11-10</startdato></gyldighetsperiode></vegobjekt></vegobjekter>

h2. Analyse

DF bruker feil URL til stedfestingsendepunktet. Riktig URL er https://www.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest",NVDB-6937,Skriv-API,
Syntaksfeil i statistikkspørring,"h2. Observasjon

Åpne
{noformat}
https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@302157,6925744,8/hva:~(~(category~(id~10288~type~'interval)~intervals~(~2010~2015)~filter~(~(operator~'*3d~type_id~1156~verdi~(~3594)))~id~103)~(category~(id~1298~type~'interval)~intervals~(~50~100~500)~filter~(~(operator~'*3d~type_id~1089~verdi~(~13747)))~id~5))/hvor:~(kommune~(~3430~3426))
{noformat}
Legg merke til at enkelte statistikk-kall (de mest ""avanserte"") får HTTP 422 fra API.",NVDB-6937,Vegkart,
"Oppdatere infovindu med ""Bruk av data"" og ""Brukerveiledning""","Oppdatere infovindu med ny tekst og link som viser til betingelser og informasjon om bruka av data på vegdata.no

Gjelder både v2 og v3 (i v2 må eksisterende link fjernes/oppdateres)

 

Samtidig er det ønskelig med link til brukerveiledning for Vegkart V3",NVDB-6937,Vegkart,
Forskjellig nøyaktighet i tids-variabler,"Windows har en nøyaktighet på 9 siffer for `Instant` og `LocalDateTime`, mens Linux har nøyaktighet på 6. Databasene våre bruker en nøyaktighet på 6 siffer. Dette blir problematisk for Windows når testene skal sammenligne tids-eventer. 

 

Foreslått løsning:

`Comment` og `Event` sine sammenligningsmeoder tar ikke hensyn til deres tidsvariabler, hhv. `{{createdInstant}}` og `occurredInstant`.

`TokenRequest` sin sammenligningsmetode oversetter til `epochSeconds`.",NVDB-6937,Datafangst,
Minneproblemer med 577 /versjoner,"/vegobjekter/577/237271712/versjoner laster mange objekter i minne og tryner.
Endre til strømmende håndtering.",NVDB-6937,Les-API,
Datter med justert stedfesting bør arve konfidens fra mor,"h2. Observasjon
Importer mor og datter som har ulik stedfesting fra NVDB, f.eks. skjerm og avstandsmåling her: 
[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Gi skjerm 101895592 ny stedfesting uten å velge veg. Skjerm er nå oransje, mens datter avstandsmåling 377099404 har fått endret stedfesting, men er grønn.

Det gjelder også andre veien, gjør både mor og datter oransje ved å stedfeste uten valgt veg. Stedfest så mor med valg av veg, mor er grønn og datter oransje.",NVDB-6937,Datafangst,
Race condition kan gi feil status når både mor og datter stedfestes,"h2. Observasjon
Dette er en spesialisering av NVDB-6032, som kan leses for bakgrunn.

Endringer i forbindelse med NVDB-5907 for å få en progress bar med flere steg gjør at stedfesting av en gruppe objekter sendes i flere parallelle kall til server i stedet for ett samlet kall. Server har ingen låsemekanisme e.l. for å si at et vegobjekt er under behandling i dette tilfellet (og selv om den hadde hatt det hadde det uansett vært vanskelig når kallene kommer så tett). Vi får da fort situasjonen at når både mor og datter sendes inn for stedfesting, og en av de får posisjonen justert som følge av den andres stedfesting, så vil det sendes tilbake et objekt med beskjed om at det har fått ny posisjon som følge av endring i relasjon, men dette objektet er henta ut på et tidspunkt der det ikke har fått riktig status med endelig stedfesting.

h3. Steg for å reprodusere
# Importer objekter fra NVDB med en relasjon, f.eks. de to lenkene i NVDB-6032
# Stedfest mor og datter samtidig, for tydeligst resultat er det best å _ikke_ velge veg
# Både mor og datter skulle nå hatt oransje prikk, men det er en sjansen for at en av de er grønn eller blå
 
h2. Analyse
Hvis innsendinga ikke hadde vært delt opp hadde eksisterende server-kode håndtert dette greit. Så det enkleste alternativet er å droppe progress bar (eller leve med at den står på 0 til den er ferdig.)

Det er også mulig at klient sjekker om det er relasjoner for det sendes inn, og at disse grupperes i samme innsending. Det som taler i mot det er at fanen ikke har relasjonsinformasjon fra før, og at dette er en type kompleksitet som bedre handteres på server-sida. Kan eventuelt sees i sammenheng med stedfesting av hierarki (NVDB-5060).

Det siste alternativet er å skrive om kallet til å være en asynkron operasjon, der klient poller for status. Det kan uansett være lurt, hvis bruker stedfester mange vegobjekter (hundrevis, men det er ikke utenkelig) kan det gå så lang tid på server at en enkelt synkront kall timer ut før bruker får svar. Det må da være mulig å polle for status, sånn at vi får en fungerende progress bar. Med en slik løsning vil dette ligne mer på automatisk stedfesting, så se på om de har noe felles som kan brukes.",NVDB-6937,Datafangst,
Gjør færre kall til Solr i ruteberegning for geometri,"Ruteberegning gjør nå veldig mange kall til Solr for å finne nærmeste segmenter. 
Dette kan gjøre mer i minne, noe lignende https://github.com/nvdb-vegdata/nvdb-datafangst/blob/master/plugins/localization/src/main/java/no/svv/nvdb/datafangst/localization/localizer/SingleLineLocalizer.java

Altså beregn nærmeste segment i minne, i stedet for å spørre Solr.",NVDB-6937,Les-API,
Sette operasjon Oppdater som default ved import,"Bakgrunnen for denne saken er NVDB-6158 hvor det blir et problem når man benytter Korriger for mor og endrer døtre. Operasjon Korriger bør helst brukes når man skal rette en feil på versjon som er inne.

Vi kan legge opp til at Datafangst tilbyr Oppdater som standard med mulighet for aktivt å gå inn for å bruke Korriger.",NVDB-6937,Datafangst,
NVDBIND-status som metrikker,"Eksponer metrikker fra Forvaltning
* Hvor lang er oppgavekøen
* Hvor mange transaksjoner ligger i køen
* Hvor lenge har kjørende oppgave kjørt
",NVDB-6937,NVDB-IND,
Eksponer helsesjekker som metrikker,Eksponer helsesjekkstatus som metrikker slik at de kan legges inn i et Grafana,NVDB-6937,Les-API,
Avvisning pga. ikke-dekkende stedfesting i morobjekt,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/3d39a66a-6828-47ba-b2e2-70caa98f6e32/status avvises fordi et vegobjekt ikke dekkes fullstendig av en morobjektversjon. Men denne versjonen lukkes under behandlingen av endringssettet pga oppdatering.

h2. Analyse

I endringssettet oppdateres tre vegobjekter med ny versjon på samme startdato: Skiltpunkt A og B + Skiltplate C

- A får sin assosiasjon til B fjernet
- B får ny assosiasjon til B
- C får ny stedfesting, som er identisk med B sin.

Kort sagt: Skilplaten relokaliseres og får ny mor.

Under validering i CoveredByParentValidator kontrolleres at C dekkes av alle relevante morobjekter. I findParentFeatures() hentes aktuelle morobjektversjoner, men det tas ikke høyde for at det kan finnes flere utgaver av hver vegobjektversjon. I dette tilfelle velges READ-varianten, i stedet for CLOSE, av opprinnelig versjon av A. Denne har annen stedfesting enn den nye stedfestingen til C og det trigges en valideringsfeil.

h2. Løsning

Endret CoveredByParentValidator.findParentFeatures() til å hente mest signifikante utgave av hver morobjektversjon.",NVDB-6937,Skriv-API,
Ytelsestest av /rute,"Rute-endepunktet er litt tungt. Det hadde vært en fordel å se ytelsen på dette endepunktet. Både isolert med bare kall mot /rute og sammen med bakgrunnslast mot API Les.

Bruk reelle kall mot /rute. Her kan 
{noformat}
/nvdb-rest-api/test/e2e-test/src/test/python/makeRouteBody/makeRouteBody.py
{noformat}
benyttes for å lage rute-requester til ytelsestesten.",NVDB-6937,Les-API,
Test: Automatiserte tester av eksport fra vegkart,"Vurder hvorvidt man skal lage automatiserte tester av eksport. Spørsmål rundt dette: * hvordan sjekke resultatet? kan man lagre respons til en bestemt sti? lese fra csv?
 * per nå sjekkes kun responstypen
 ** en mulighet å kun sjekke at ulike eksporter går bra, men ikke helt nok

Det er nok mest naturlig å legge tester av Eksport inn under e2e-testene i Vegkart, men også mulig å lage helt egne tester for dette. Fordelen med å legge inn under e2e-testene i Vegkart er at man kan kontrollere resultatet opp mot hva som vises. Evt kan de også legges under API-testene til API Les. Også her kan man kontrollere resultatet opp mot hva API Les gir som svar på ""vanlige"" API-kall.
h2. Løsning

Eksport-testene er lagt under API-testene i API Les med et eget usecase ""v3Export"". SOSI- og CVS-eksportene blir konvertert til en intern Json-struktur for enklere å bli sammenlignet med tilsvarende API-kall.",NVDB-6937,Eksport,
Test: Utvid Datafangst-API testene,"Her mangler det tester som dekker bl.a. feltene arkivering og henting av alle featurecollections.

Bør gå gjennom testene og se om det er mer som bør utvides av tester.",NVDB-6937,Datafangst,
Test: Legg til scenario på e2e-testene,"Her er det flere scenarioer som mangler tester:

 
 (/) inkrementell lagring
 (/) stedfesting (med API Skriv)
 (/) NVDB-5413: klikk bort feilmld
 (/) NVDB-3720: alle kvalitetsparam
 (/) NVDB-5223: Inform.tekst ved overskriv
 (/) NVDB-5231: kopiere låste objekter
 (/) NVDB-5044: ikke kunne sette sidepos eller felt
 (/) NVDB-5361: velge felt
 (/) NVDB-5011: vise svv-navn
 (/) NVDB-5460: ny topp-meny. flere sjekker her. inkl. lenke til brukerveiledning
 (/) NVDB-5552: ny glemt-passord-flyt
(/) NVDB-4747: registrer og få systemfeil
 -(x) tester på gruppeadmin-",NVDB-6937,Datafangst,
Ytelsestest av Datafangst-API,"Dette er en stegvis prosess.
 
1. Det bør kjøres en ytelsestest av Datafangst-API med f.ex 5 brukere over noen timer
2. Sjekk antall kall/posts/etc per tid om det må endres noe på oppsettet. Kan analysere med
{noformat}
nvdb-datafangst/performance-test/src/test/python/apiFeaturecollectionLog/apiFeatureCollection_statistics.py{noformat}
3. Om OK, kjør lengre test mot Datafangst-API med flere brukere.
 
Tillegg: Kunne lagt inn noen ""peak-collections"" med type 4000 objekter i: * vanlig scenario med lav sannsynlighet
 * egen test med kun store featurecollections uten alle /feature og importer for å få generert mange store kall litt samtidig.",NVDB-6937,Datafangst,
Test: Legg til scenarioer på API-testene,"Følgende scenarioer mangler i API-testene:
  
 (/) NVDB-5897: Test at for stor bbox på /rute gir riktig svar
 (/) NVDB-5736
 (/) Testcaser i StatisticsPerformance.scala må legges inn i Statistics.scala med funksjonelle tester
(/) NVDB-5990: Testscenario i kommentar i saken",NVDB-6937,Les-API,
Slett ubrukte endepunkter for stedfesting,"Det finnes tre endepunkter for stedfesting, der to av de ser ut til å ikke være i bruk (etter at en integrasjonstest ble skrevet om i NVDB-6001).

Ville normalt sett bli gjort som en del av NVDB-6001, men siden den allerede har flere refaktoriseringer som ikke går på kjernen i den saken skiller jeg denne ut som egen sak.",NVDB-6937,Datafangst,
Grafana-dashboard for alle Atlas-miljø,"Oppgaven går på å få satt opp et Grafana-dashboard for å visualisere situasjonen på Atlas for  Vegkart, NVDB API les, NVDB API rapport og etter hvert NVDB API skriv.

 

*Epost fra Liv Helen under*

Hei Helen.

Jørn Mauseth og jeg har hatt en samtale med Marvin i dag, vedrørende et Grafana Dashboard.

SVV har anskaffet en stor skjerm på 75», som i første omgang skal speile situasjonen på NVDB porteføljen via et grensesnitt i Grafana.

 Grafana er et grafisk verktøy, som er implementert for Atlas plattformen.

Marvin har i dag et Dashboard på Grafana, som viser situasjonen for NVDB api les.

[https://atlas-app-grafana.atlas.vegvesen.no/d/bHR49LZMz/nvdb-les-v3?orgId=7&refresh=1m]

Neste steg er å få opp et Dashboard, som viser hele NVDB porteføljen på Atlas, det vil si et skjermbilde med situasjonen på Vegkart, NVDB API les, NVDB API rapport og etter hvert NVDB API skriv.

Vi har et annet fagområde i Vegvesenet, som har noe tilsvarende:

[https://atlas-app-grafana.atlas.vegvesen.no/d/zwO9y9eZk/din-side-felles?orgId=1&refresh=1m]

 I vår samtale med Marvin, har vi avdekket at han har den kompetansen som kan hjelpe oss med en oversikt V1.

 

Videre vet vi at det er ønsker fra fagsiden, om å vise en grafisk oversikt fra andre perspektiv. Men det blir i V2.

I og med at vi må se på hvilke verktøy, som er best egnet for å dekke fagsidens behov.

 

Vi vet at Grafana teknisk vil fungere på skjermen.

Så derfor er vår prioritet å få opp skjermen med en V1, så bygger vi sten på sten etter det.

 

Mitt spørsmål er da: Kan Marvin bistå oss med en V1?

 

Med vennlig hilsen

Liv Helen Rødal

NVDB teamet",NVDB-6937,Les-API,
Treg håndtering av transaksjoner med mange slettede strekninger,"{quote}
Updated 250000 road systems and deleted 195477 sections, 0 intersections, 25 intersection parts, 0 sideareas and 0 sidearea parts in task 4984890
{quote}

Behandlingen av denne transaksjonen gikk megatregt. Det som brukte veldig mye tid var å finne veglenkesekvenser for de 195477 strekningene. Det ble gjort et kall mot cache for hver at de 195477 strekningene. 
Denne delen av transaksjonshåndteringen kommer fra NVDB-5099.

Vi har forsøkt å forbedre denne delen ved å gjøre færre kall med flere strekninger om gangen.
",NVDB-6937,NVDB-IND,
Systemfeil pga NPE i JobResultWriter,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/a071ade0-06bb-4b1f-b799-8b065187014d havarerer med SYSTEMFEIL pga. NullPointerException ved skriving til jobbdatabase:

{code:java}
java.lang.NullPointerException
	at java.util.regex.Pattern.<init>(Pattern.java:1350)
	at java.util.regex.Pattern.compile(Pattern.java:1028)
	at java.lang.String.replaceAll(String.java:2223)
	at no.vegvesen.vt.nvdb.apiskriv.domain.issue.Issue.replaceTempIdWithNvdbId(Issue.java:110)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobResultWriter.lambda$null$6(JobResultWriter.java:216)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobResultWriter.lambda$collectGlobalAndJobExtensionIssues$7(JobResultWriter.java:214)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobResultWriter.collectGlobalAndJobExtensionIssues(JobResultWriter.java:213)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobResultWriter.writeResultAfterNvdbIdPopulation(JobResultWriter.java:88)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.updateNvdb(JobWorker.java:705)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:207)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:145)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

Feilen oppstår når bruk av tempId skal erstattes med nvdbId for globale varsler relatert til nye vegobjekter (registrer-operasjon). Et vegobjekt av type 60, nvdbId 274136682 har både versjon 0 og 1 i NVDB (https://www.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/60/274136682). Den første har startdato 1950-01-01 og åpen sluttdato og oppfattes derfor av AdaptFeaturesToClosedNetworkEnricherFilter som gjeldende (siste) versjon som derfor må oppdateres. Filteret har derfor etablert ny versjon 1 med redusert stedfesting. I JobResultWriter oppfattes denne som nytt vegobjekt, siden NvdbAction er ADD og versjonen er 1. Når tempId er da er null, havarerer dette i Issue.replaceTempIdWithNvdbId().

 h2. Løsning

Dette er en datafeil som må rettes i NVDB, før endringssettet restartes. Det er imidlertid implementert en kontroll på versjonsnummere i SanitationJobFilter slik at slike tilfeller rapporteres med litt mer forståelig feilmelding.
",NVDB-6937,Skriv-API,
Eksport: Flytting av mor ved lukking av barn gir feil,"h2. Observasjon

Under debugging av problem for Raymond. Scenario er at NVDB-mor (Korriger) med NVDB-barn (Lukk) er importert. NVDB-mor får nytt barn (Opprett) og endrer stedfesting får å samsvare med nytt barn. Alt ser fint ut. Men registrering feiler pga historikken. Hvis NVDB-mor (v1) endrer stedfesting så vil ikke denne dekke lukkede barns stedfesting i deres tid.

Selv om mor er importert som Korriger vil det riktige her være å ta inn mor som Oppdater s.a. mor får ny versjon samtidig som den får nye barn.

Usikker på om vi her burde benytte Oppdater ved innsending selv om bruker har satt Korriger - eller om vi burde kunne gi beskjed om det på en eller annen måte.

*Oppdatering*: NVDB-6182 er opprettet for å lede bruker inn på å heller benytte Oppdater enn Korriger. Dersom denne saken skal gjøres blir den mer a la ""hindre bruker i å endre assosiasjoner når mor sin operasjon er Korriger"".",NVDB-6937,Datafangst,
Ansvarlig bruker trenger ikke være SVV-bruker,"h2. Bakgrunn

ElRapp, og kanskje andre, har mange brukarar som ikkje nødvendigvis har SVV-brukar. Dei kan registrere data som generer eksport til NVDB, men får feil når det skal lagrast/sendast. Tenestebrukaren til ElRapp har tilstrekkelig rettar til å skrive til NVDB, men endringssettet vert avvist på grunn av ansvarleg ikkje er godkjend brukar.

Det skulle ikkje vere noko i vegen for at ansvarleg kan vere andre enn SVV-brukarar så lenge det er mogleg å kome i kontakt med brukaren.
Det vil vere ei betre løysing enn at det er ein fellesbrukar som står som ansvarelg på alle datasett frå ElRapp (og evt. andre).",NVDB-6937,Skriv-API,
"Ny veglisterapport: Modulvogntog på tømmertransport Fv,Kv","Vi må tilby en rapport for et subsett av tømmertransport, uoffisiell. Behovet er kommunikasjon mellom SVV og vegeier (fylkeskommunene, kommunene). 

Vi tar utgangspunkt i rapporten for BK tømmertransport, uoffisiell og lager en ny rapporttype slik: 
 * Rådata = BK tømmertransport, uoffisiell
 * Vegfilter: Fv,Kv
 * Egenskapfilter: Maks. vogntoglengde = 24.00 meter 

I tillegg til eksisterende informasjon (vegnr, lengde, BK-verdier etc) så føyer vil til følgende informasjon: 
 * Kommaseparert liste ned NVDB ID til de BK-objektene som bidrar på strekningen (kan være flere enn ett, eller et NVDB-objekt kan bidra på flere strekninger. Begge deler er helt OK) 
 * Gatenavn (ble løst 2.11) 
 * ""Tillatt modulvogntog"" (Ja/Nei). 
 * Kommentar fra vegeier (blankt tekstfelt) 

 

Rapporten tilbys som en ny rapporttype i nedtrekksmeny for vegliste arbeid, med tittel: ""Modulvogntog basert på tømmertransport Fv og Kv"". 

Vi må passe på at rapportuttak ikke gir snåle resultater ved kombinasjon av filter.
 * Vårt standard vegfilter = Fv,Kv
 * Dette kan overstyres, dvs hvis jeg angir Ev6 så er det det jeg får
 * Valg av kommune vs fylke påvirker ikke vegfilter, jeg får de vegene som matcher vegfilter innafor valgt område 

 

 

 ",NVDB-6825,Rapportgenerator,
Gi bedre advarsel når eksport feiler ved store eksporter,"En bruker (Erlend Dysvik) ønsker å laste ned store mengder data via CSV. I dette tilfellet er det Kurvatur for hele landet. Dette er nærmere 1 million objekter. Innmelder melder forøvrig at det typisk også feiler når man deler opp denne eksporten på fylkesbasis.

CSV-eksport starter å laste ned, men etter en del MB får man feil. Chrome melder om nettverksfeil. Kan det være en eller annen timeout som slår inn?

Jeg er usikker på om vi skal støtte eksport av så store mengder data. Men hvis ikke bør vi nok gi en eller annen beskjed om dette når man prøver å eksportere så mange objekter.

Aktuell url: [https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@600000,7225000,4/hva:~(~(id~640))]

 ",NVDB-6937,Eksport,
Forbedre automatisk valg av trafikantgruppe på ruteberegning,"Hvis ruteberegningen ikke klarer å gjette trafikantgruppe kan det likevel finnes mulig rute for f.eks K.

Om det ikke blir funnet trafikantgruppe, legg inn at det forsøkes med K og deretter G før den gir opp helt.

Ble oppdaget under test av NVDB-5990 i ATM (pga gammel datadump i ATM).

 
h3. Løsning

Lagt inn et steg på slutten som gjør et siste forsøk med trafikantgruppe kjørende hvis den ikke finner rute for å bestemme trafikantgruppe.",NVDB-6937,Les-API,
Typedefinisjoner for all frontendkode,"Datafangst ble opprinnelig skrevet i JavaScript, og senere konvertert til TypeScript. Typer i TypeScript har blit lagt til etter hvert, men det er fortsatt en god del som mangler, spesielt i definisjon av respons fra server-kall og i gammel Angular-kode.

Å ha typer for hele kodebasen vil gjøre den mye lettere å jobbe med, spesielt for den som er ny til kodebasen. Målet bør være å kunne skru på ""noImplicitAny"" for TypeScript.",NVDB-6937,Datafangst,
Støtte brukerprofiler for tjenestebrukere via LDAP-API,"h2. Bakgrunn

NVDB API Skriv som kjører i Atlas-miljø er nå integrert med det nye LDAP-API, i stedet for SoaBasis. LDAP-API kan imidlertid ikke p.t. levere brukerprofiler for tjenestebrukere. Har sendt henvendelse til systemeier (Mats Faugli) for LDAP-API. Når dette støttes må NVDB API Skriv tilpasses det nye endepunktet for søk på tjenestebrukere.

h2. Løsning

Mats Faugli har oppdatert LDAP-API med støtte for tjenestebrukere via endepunktet api/wsclients. Oppdaterte DefaultLdapGateway med søk på dette endepunktet for tjenestebrukere.",NVDB-6937,Skriv-API,
Kontraktsliste vises med nylig endret sist,"Etter at det ble rydda opp i standart sortering på kontraktslista med stigende på første klikk, så ser det ut til å ha blitt feil på standard visning før sortering. Vi viste tidligere sist endret først, men nå kommer sist endret sist.

Visning ved oppstart må fikses sånn at den vises sist endret øverst, selv om default sortering ellers er stigende.",NVDB-6937,Datafangst,
Sortér vegobjekter i liste riktig numerisk,"En del steder der vi viser lister med vegobjekter tar vi ikke hensyn til riktig sortering av tall som en del av navn. Vises spesielt godt der vi får rekkefølgen ""KURVE 1"", ""KURVE 10"", ""KURVE 2"", men det vil også gjelde for NVDB-ID'er.

Dette gjelder i alle fall for utlisting av vegobjekter på stedfesting og sammenkobling, men sikkert også andre steder.

Dette kan enkelt fikses ved å bruke Intl-API'en for sortering, sånn som det er gjort for kontraktslista.",NVDB-6937,Datafangst,
Fjern apilesv3,Fjern dispatcher nvdbapi-v3-old i prod. Mengden trafikk som går gjennom den: https://atlas-grafana.atlas.vegvesen.no/d/haproxy/load-balancer-haproxy?orgId=1&var-runtime_env=prod&var-ns=nvdbapil-produksjon-v3&var-route=All&from=now-7d&to=now&viewPanel=30,NVDB-6937,Les-API,
Fjern tom side for sammenkobling v3,"Under ""Smertefri lagring"" ble det såvidt påbegynt en ny side for sammenkobling, men dette er bare et skjelett (NVDB-4498). Kan være greit å fjerne dette fra kildekode, sånn at det ikke ligger der og forvirrer.

Etter tidligere diskusjon i forbindelse med overgang til ny leverandør er det bestemt at vi ikke skal gå videre med skissene fra smertefri lagring nå.",NVDB-6937,Datafangst,
Få ned minnebruk for Gate-cache og eksponer gate,"NVDB-6040 introduserte indeksering av vegnett på Gate(538) . På grunn av at områdecache tar veldig mye minne, med neste 500 000 gateobjekter er det deaktivert.
Få ned minnebruken og fullfør eksponering av Gate.",NVDB-6937,Les-API,
Tilgang til bintray,"Utviklere på LES må få tilgang på https://bintray.com/nvdb-vegdata, releaser av api-klienten legges her",NVDB-6065,,
Slette kode for eksport2,"Etter diskusjon i teamet er det enighet om at ""ny"" eksportfane som ble påbegynt under ""Smertefri lagring"" ikke er verdt å fullføre sånn den står nå, så det er bedre å slette denne koden.",NVDB-6937,Datafangst,
Legge om til bruk av Atlas og OIDC i ytelsestestene,"Ytelsestestene har i dag ikke konfig for å bli kjørt mot de nye Atlas-instansene, samtidig som OIDC ikke brukes. Oppgaven går ut på å legge om til å benytte Atlas-instansene og bruke OIDC ved kall mot Skriv.",NVDB-6937,Skriv-API,
Forenkle sub-domener til bakgrunnskart,"h2. Bakgrunn

Kan vi få justert lenken til bakgrunnskart?

Vi har også en logikk hvor vi itererer over subdomener. Dette er av hensyn til MS-IE, som ikke klarer laste ned parallelt fra samme domene. Å skru om slik at vi kun laster ned fra domenet services.geodataonline.no/ vil funke helt fint i moderne nettlesere (parallelt), mens IE vil kun laste ned en og en kartflis (litt treigere, men det driter vi i).

Jan

 

*From:* Joachim Eckbo Juell <[joachim.juell@geodata.no|mailto:joachim.juell@geodata.no]> 
 *Sent:* onsdag 28. oktober 2020 22:52
 *To:* Nedrebø Ole Johannes <[ole.nedrebo@vegvesen.no|mailto:ole.nedrebo@vegvesen.no]>; Jensen Jan Kristian <[jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]>
 *Subject:* Forenkle sub-domener til NVDB-bakgrunnskartet

Hei Ole Johs og Jan Kristian,

Vi har i dag veldig mange DNS-aliaser knyttet til NVDB-bakgrunnskartet vi drifter for dere (se listen under). Dette stammer nok fra «gamle dager», da nettlesere kun støttet et begrenset antall parallelle http-kall til samme adresse. Men dette er jo nå løst med http 2.0.

Alle disse sub-domenene øker kompleksiteten i konfigurasjonen vår, og øker sjansene for feilsituasjoner. Vi er veldig interessert i å få ryddet opp i dette. Men dere har vel diverse klienter som er satt opp med disse sub-domenene? Jeg kjenner kun til Vegkart og Trafikkdata, og der er de i bruk. Er det mulig for dere å få endret dette? Det beste hadde vært om dere kun benyttet services.geodataonline.no - [https://services.geodataonline.no/arcgis/rest/services/Trafikkportalen/GeocacheTrafikkJPG/MapServer/].

Vi ønsker også å flytte tjenesten over til et nytt cluster vi har i AWS Stockholm, noe som vil bedre responstiden ganske mye. Men det krever at vi får ryddet opp i antall sub-domener.

Følgende subdomener til geodataonline.no finnes i dag:
 * nvdbcache
 * m1 til m10-nvdbcache
 * m1 til m10.nvdbcache

 -Joachim",NVDB-6937,Vegkart,
Importere Kantegas jiraprosjekt inn i SVV-jira,Test ut med en prøve eksport i første omgang.,NVDB-6065,,
Eksportere Kantega-jira,"Start med en prøve eksport, for å se om SVV er i stand til å importere den.

 

Gjelder 3 jiraprosjekter:
 * Statens Vegvesen - NVDB Åpne vegdata
 * Statens vegvesen - NVDB Klassisk
 * Statens Vegvesen - NVDB Referansesystem: Modell & TNE

 

SVV har tatt tak i arbeidet med å migrere:

[https://www.vegvesen.no/wiki/display/SOAprosjektet/Migrering+av+Kantega+Jira+og+Confluence+til+SVV+Jira+og+Confluence] 

[https://www.vegvesen.no/jira/browse/NVDBFOR-377] ",NVDB-6065,,
Git - avklare om koden skal flyttes,"NB! NVDB API Skriv har sin online dokumentasjon på GitHub, med hosting på GitHub Pages. Denne kan ikke flyttes sånn uten videre.",NVDB-6065,,
Cypresstestene må kjøre på SVV jenkins,,NVDB-6065,,
Datafangst - Endre domenenavn,"Forslaget til nytt domenenavn er datafangst.vegvesen.no

Domenenavnet bør endres så snart som mulig, etter at Torbjørn har fått sjekket om ""vegvesen"" kan brukes i URL'en.
h2. Forslag til løysing

Nytt domene vert datafangst.vegvesen.no med redirect til dagens plassering.

Undersøker med IT om vi kan ta i bruk datafangst.atlas.vegvesen.no med redirect.",NVDB-6065,,
Egenposisjon er ikke stabil,"h2. Observasjon

Vist posisjon hopper og spretter og kan være opptil en kilometer feil. Problemet er visning av ""egenposisjon"" (""blå prikk""). 
h3. Innmelder

POB: 3683004
Navn:: Kjell Hauge
E-postadresse: kjell.hauge@vegvesen.no",NVDB-6937,Vegkart,
Bruker vi noe infrastruktur hos Triona?,,NVDB-6065,,
Les-bruker for tilgang til database i ATM og PROD,"Det kunne være nyttig å ha en bruker med read-only tilgang i databasenene for å kunne danne seg et bilde av bruken av systemet når det gjelder omfang, frekvenser og volum. Nyttig for statistikkformål, og for å lære mer om bruken av NVDB Rapporter. Det er ikke alt som er like lett å se ut fra loggene i Splunk.",,Rapportgenerator,
Migrere til REST-baserte SoaBasis-tjenester,"h2. Bakgrunn

NVDB API Skriv bruker i dag SOAP-baserte webtjenester for oppslag i LDAP (SoaBasis). Det finnes nå REST-baserte tjenester som har tatt over for disse. Det er kommet anmodning fra IKT om å få dette gjort snarest.

Den nye tjenesten og detaljer kan finnes i mail fra Mats Faugli fra august 2019, eller her: https://www.vegvesen.no/wiki/display/SOAprosjektet/LDAP-API
 
h2. Løsning

Etablerte LdapGateway som nytt interface, der dagens SoaBasis-løsning avledes og fortsatt brukes i de gamle AutoPro-miljøene. Dette fordi LDAP-API krever OIDC-autentisering og ønsker ikke å registrere egen AutoPro-klient for dette. I Atlas-miljøet derimot kan eksisterende OIDC-klienter brukes til dette. LDAP-API brukes derfor kun i Atlas-miljøene. Dette realiseres med DefaultLdapGateway som tar seg av kommunikasjonen med LDAP-API.

LDAP-API støtter p.t. ikke oppslag på tjenestebrukere. Har sendt forespørsel til Mats Faugli om dette og registrert egen Jira-sak for å støtte nytt endepunkt for LDAP-API når dette blir klart.",NVDB-6937,Skriv-API,
Etablere ATM- og PROD-miljø på Atlas-plattformen,"Applikasjonsmiljø for ATM og PROD i Atlas (nvdbapiskriv-akseptansetest/nvdbapiskriv-produksjon) er bestilt. Når dette er klart må det settes opp Atlas-konfigurasjon for tjenester, velv etc og rulle ut NVDB API Skriv.

Etter ytelsestesting mot ATM, må det bestilles server-redirect fra https://www.vegvesen.no/nvdb/apiskriv/* til https://nvdbapiskriv.atlas.vegvesen.no/*",NVDB-6937,Skriv-API,
Mer intuitiv kodestruktur i Datafangst,"Uten RestStop står vi friere til hvordan vi organiserer kode i Datafangst, og vi kan rydde opp i noen gamle synder. Spesielt struktur for frontendkode er barokk og lite hensiktsmessig, men også katalogen ""plugins"" som all kode ligger under gir ikke mening som navn uten RestStop.

Dette er en liten og rask endring, men det bør gjøres når det skjer minst mulig annet (spesielt på frontend), siden flytting av filer gjør merge mer komplisert.

Følgende endringer bør gjøres:
* Flytte ./plugins/dataforvalter til ./frontend
* Rename ./plugins til ./backend for det gjenværende
* Legge Typescript-kode i src/main/typescript
* SASS i src/main/sass, og ressurser ellers uten assets/dataforvalter
* Pluss kanskje å drepe CONTEXT_PATH med det samme",NVDB-6937,Datafangst,
Kan ikke kopiere feierode,"Charlie Martin Håvik (charlie.martin.havik@vegvesen.no) får systemfeil når han skal kopiere importert feierode.

Har feilsøkt litt mer, og ser ut til å gjelde uavhengig av objekt. Feierode er heller ikke tilgjengelig som objekttype for kopiering til annen type når jeg kopierer linjeobjekt.

Feil i logg er ""Feature type 884 Did not have SpatialAttributeType LINE"" som er når vi sjekker datakatalog, men så vidt jeg kan se fra vegobjekttype (https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekttyper/884.json?pretty=true) så støtter den linje. Kan være problemer med vår parsing av datakatalog, eller datafeil i datakatalog som gjør at det ikke virker.

Har prøvd med bl.a. disse dataene på import: https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/884.json?segmentering=true&kartutsnitt=-47046.887%2C6623599.745%2C-36886.867%2C6629415.298&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter

Stacktrace:
{noformat}
java.lang.IllegalArgumentException: Feature type 884 Did not have SpatialAttributeType LINE
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.ChangesetTransform.lambda$getSpatialAttributeType$29(ChangesetTransform.java:517)
	at java.util.Optional.orElseThrow(Optional.java:290)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.ChangesetTransform.getSpatialAttributeType(ChangesetTransform.java:517)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.ChangesetTransform.toGeometri(ChangesetTransform.java:506)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.ChangesetTransform.toNyttVegobjekt(ChangesetTransform.java:489)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.ChangesetTransform.lambda$toChangesetForValidation$3(ChangesetTransform.java:174)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
{noformat}
",NVDB-6937,Datafangst,
Sammenkobling til uendret datter hindrer eksport,"h2. Observasjon

export krever at sammenkoblede objekter må sendes inn i samme endringssett, men det får man ikke til å gjøre i datafangst hvis datter allerede er exportert.

Problemet kan gjenskapes ved å importere sosi-objekter som skal sammenkobles, men man lagrer datterobjektene før sammenkoblingen gjøres. dette er bare mulig bare for objekter som ikke krever mor. Vedlagt ligger sosi for holdeplassutrustning som mor, og leskur som datter. leskur krever ikke mor og kan lagres til skriv uten å være sammenkoblet med holdeplassutrustningen.

Når man havner i dette scenariet, vil submittability_report si at endringssettet ikke kan sendes inn pga manglende assosierte objekter i endringssettet, men GUI tar ikke høyde for manglende assosiasjoner, når de som mangler ikke er satt til dirty. Effekten er at GUI gråer ut knappen for innsending, men gir ikke noe beskjed om hvorfor.
h2. Analyse

Submittability_report ser bare på om det er sammenkoblinger til andre objekter, og sier fra hvis disse ikke sendes inn som en del av endringssettet. Dette henger igjen fra gamle dager da datafangst ikke skulle støtte å endre objekter som allerede eksisterer i NVDB. 
 De faktiske kravene til Skriv er at ved sammenkobling så kreves kun NVDB-ID for barnene. så når vi gør sammenkobling med eksisterende barn som har NVDB-ID, så trenger vi ikke sende inn barnene samtidig.
h2. Løsning

Submittability_report endres til å bare varsle om missing associated types hvis de assosierte barnene ikke har NVDB-ID",NVDB-6937,Datafangst,
TopologyException,"h2. Observasjon

Sender POST mot [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?debug=true] med
{code:json}
{""geometri"":""LINESTRING (310057.05 6762422.79, 310057.19 6762420.79, 310057.45 6762420.83, 310063.29 6762421.58, 310067.37 6762422.1, 310077.29 6762423.37, 310077.03 6762425.35, 310076.97 6762425.85, 310075.55 6762436.94, 310075.53 6762436.95, 310075.16 6762436.93, 310074.81 6762436.91, 310074.04 6762436.87, 310073.69 6762436.86, 310073.63 6762436.85, 310073.25 6762436.83, 310072.28 6762436.78, 310071.12 6762436.72, 310070.35 6762436.68, 310069.73 6762436.65, 310069.31 6762436.62, 310068.53 6762436.58, 310068.13 6762436.56, 310066.29 6762436.47, 310066.11 6762436.46, 310065.61 6762436.47, 310065.38 6762436.5, 310065.31 6762436.51, 310064.91 6762436.6, 310064.79 6762436.64, 310064.27 6762436.85, 310064.05 6762436.96, 310063.6 6762437.27, 310063.53 6762437.32, 310063.13 6762437.7, 310063.04 6762437.81, 310062.72 6762438.25, 310062.58 6762438.49, 310062.45 6762438.78, 310062.32 6762439.11, 310061.54 6762445.02, 310060.72 6762444.92, 310060.22 6762444.87, 310055.77 6762444.34, 310054.78 6762444.23, 310055.17 6762440.87, 310055.46 6762440.9, 310055.73 6762440.94, 310055.91 6762440.95, 310056.69 6762441.04, 310058.45 6762441.24, 310058.51 6762441.25, 310058.95 6762441.3, 310059.31 6762441.34, 310059.72 6762441.38, 310060.42 6762441.46, 310060.49 6762441.47, 310060.62 6762441.49, 310060.5 6762442.48, 310060.75 6762442.51, 310061 6762442.53, 310061.27 6762440.26, 310060.77 6762440.2, 310060.52 6762440.17, 310060.11 6762440.13, 310059.72 6762440.09, 310059.7 6762440.08, 310059.28 6762440.04, 310059.06 6762440.01, 310059.01 6762440.01, 310058.97 6762440, 310058.85 6762439.99, 310058.43 6762439.94, 310057.99 6762439.89, 310057.38 6762439.82, 310056.82 6762439.76, 310055.72 6762439.64, 310055.32 6762439.59, 310055.72 6762439.63, 310055.77 6762439.14, 310056.17 6762435.86, 310056.26 6762434.56, 310056.93 6762424.59, 310057.02 6762423.29, 310057.05 6762422.79)"",""maks_avstand"":""100"",""konnekteringslenker"":true,""detaljerte_lenker"":false,""vegsystemreferanse"":""R,E,F,K"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-16"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":true}
{code}
og får HTTP 500 med
{noformat}
Caused by: org.locationtech.jts.geom.TopologyException: found non-noded intersection between LINESTRING ( 310051.318 6762420.936, 310051.174 6762422.064 ) and LINESTRING ( 310051.307 6762421.02, 310051.172 6762422.086 ) [ (310051.2725882276, 6762421.291725551, NaN) ]
{noformat}
Setter vi imidlertid _vegsystemreferanse: null_ kommer det svar.",NVDB-6937,Les-API,
Java oppgradering fra 8 til 11,"Java 11 er tilgjengelig på Atlas nå.

Oppgraderer Java for NVDB Rapporter fra 8 til 11.",,Rapportgenerator,
Driftskontrakt V2-oppsummering tilstand/skade,"Driftsmiljøet ønsker seg et produkt tilsvarende funkra T2-listene, dvs en oppsummering av ulike typer etterslep og tilstand/skade på V2-nivå. Bør ideelt sett integreres i eksisterend eV2-lista (egen fane?). Se eksempel på T2-liste fra Funkra (9305_Sunnfjord-Std-20201019.xlsx). 

Det blir nok en del pirkete spesialregler for oppsummering, gjerne en per tilstand/skade objekttype, kan hende fler. (F.eks. generiske tilstand/skade objekt har kanskje en oppsummering per type morobjekt)? 

Trenger mer detaljering / gjennomgang før vi går løs på implementering. ",NVDB-6938,Rapportgenerator,
Omdøping et par rader i V2/V3,"Døpe om rad ""Alle NVDB data kum"" => Kum, alle NVDB data og ""Hjelpesluk => Kum, hjelpesluk"" slik at radene kommer inntil hverandre

Døpe om rad ""Alle NVDB-data for skiltplate unntatt tunnelmarkering"" => ""Skiltplate, alle NVDB-data unntatt tunnelmarkering"".",,Rapportgenerator,
Vegobjekt i liste mangler geometri,"Vi ser enkelte vegobjekter i spørringer som mangler geometri, f.eks. objekt nummer 8 i denne spørringa: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/9.json?segmentering=true&kommune=5401&inkluder=lokasjon%2Cgeometri%2Cegenskaper%2Cmetadata%2Crelasjoner]

Når jeg går rett på vegobjektet så er geometri med: [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/9/91526367/1.json]

 
h2. Løsning

Lagt til et felt på vegobjektsegmenter i solr som sier om et segment er aktivt eller ikke. Nyeste segment merkes som aktivt. Det gjør at for objekter som er stedfestet på lukket vegnett og kun har segmenter med end_date vil det likevel finnes segmenter som er merket som aktivt og da gir geometri ut i sånne tilfeller.

Denne endringen krever full indeksering, men skal fungere som før inntil full indeksering er kjørt.",NVDB-6937,Les-API,
Oppdatere ytelsestester,"Oppdatere ytelsestester ihht til reell bruksmønster i Prod.

Som ""mal"" er kan uke 41 benyttes.",NVDB-6937,Les-API,
Rutesegment med utstrekning leveres med punktgeometri,"h2. Observasjon

Følgende exchange med /rute leverer et rutesegment (det siste) med utstrekning, men med punktgeometri:


{noformat}
3 > POST https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute
3 > Accept: application/json
3 > X-Client: NVDB API Skriv
3 > Content-Type: application/json
3 > X-REQUEST-ID: 7c04dda4-d157-4c46-a53e-a58795156abd
{""geometri"":""LINESTRING (-40807.4 6563722.45, -40727.32 6563611.72, -40609.92 6563532.75, -39376.57 6563019.8, -40609.65 6563528.7, -40731.96 6563611.35, -40807.4 6563722.45)"",""maks_avstand"":""100"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""E,F,R,K"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring"",""tidspunkt_start"":""2020-01-01"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}

2020-10-19T14:55:24.526 INFO  [qtp938750341-69] [] n.v.v.nvdb.apiskriv.jersey.LoggingFilter 4 * LoggingFilter - Response received on thread qtp938750341-69
4 < 200
4 < Transfer-Encoding: chunked
4 < X-Robots-Tag: none
4 < Cache-Control: no-cache
4 < Access-Control-Allow-Origin: *
4 < Access-Control-Allow-Methods: GET, POST, OPTIONS
4 < X-Datakatalog-Versjon: 2.22
4 < X-REQUEST-ID: 7c04dda4-d157-4c46-a53e-a58795156abd
4 < Access-Control-Max-Age: 1728000
4 < Date: Mon, 19 Oct 2020 12:55:00 GMT
4 < Access-Control-Allow-Headers: accept, x-client, x-client-session, origin, content-type
4 < Content-Type: application/json;charset=utf-8
{""vegnettsrutesegmenter"":[{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.03605462,""sluttposisjon"":0.11568015,""kortform"":""0.03605462-0.11568015@320684"",""veglenkenummer"":37,""sluttnode"":""2020686"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-39373.351 6563027.688 10.263, -39387.1 6563033.3 10.207, -39411.5 6563043.2 10.007, -39436 6563053.5 9.907, -39464.5 6563065.1 9.807, -39488.7 6563075.1 9.607, -39515.7 6563086.1 9.407, -39539.8 6563096.1 9.307, -39565.8 6563106.7 9.207, -39589.6 6563116.4 9.006, -39615.2 6563127 8.806, -39639.7 6563137 8.706, -39663.4 6563146.8 8.606, -39688.7 6563157.2 8.506, -39705.7 6563164.38 8.306)"",""srid"":5973},""lengde"":359.229,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":163.109,""til_meter"":522.338,""retning"":""MED""},""kortform"":""FV4524 S1D1 m163-522""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.11568015,""sluttposisjon"":0.12982024,""kortform"":""0.11568015-0.12982024@320684"",""veglenkenummer"":29,""startnode"":""2020686"",""sluttnode"":""348337"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-39705.7 6563164.38 8.306, -39714.3 6563168 8.206, -39739.7 6563178.3 8.206, -39764.7 6563188.7 8.006)"",""srid"":5973},""lengde"":63.818,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":522.338,""til_meter"":586.156,""retning"":""MED""},""kortform"":""FV4524 S1D1 m522-586""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.12982024,""sluttposisjon"":0.16180515,""kortform"":""0.12982024-0.16180515@320684"",""veglenkenummer"":6,""startnode"":""348337"",""sluttnode"":""348586"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-39764.7 6563188.7 8.006, -39797.7 6563202.6 7.906, -39824.3 6563213.4 7.606, -39850.2 6563224.2 7.506, -39872.1 6563232.8 7.306, -39898.2 6563243.6 7.106)"",""srid"":5973},""lengde"":144.0,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":586.156,""til_meter"":730.156,""retning"":""MED""},""kortform"":""FV4524 S1D1 m586-730""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.16180515,""sluttposisjon"":0.20055436,""kortform"":""0.16180515-0.20055436@320684"",""veglenkenummer"":7,""startnode"":""348586"",""sluttnode"":""348874"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-39898.2 6563243.6 7.106, -39933.7 6563258.1 6.606, -39952.7 6563266 6.405, -39972 6563274 6.205, -40008.7 6563289.1 6.005, -40029.9 6563297.7 6.005, -40059.9 6563310.2 5.905)"",""srid"":5973},""lengde"":175.0,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":730.156,""til_meter"":905.156,""retning"":""MED""},""kortform"":""FV4524 S1D1 m730-905""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.20055436,""sluttposisjon"":0.20804552,""kortform"":""0.20055436-0.20804552@320684"",""veglenkenummer"":8,""startnode"":""348874"",""sluttnode"":""2020688"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40059.9 6563310.2 5.905, -40085.7 6563320.8 5.805, -40091.22 6563322.93 5.805)"",""srid"":5973},""lengde"":33.77,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":905.156,""til_meter"":938.926,""retning"":""MED""},""kortform"":""FV4524 S1D1 m905-939""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.20804552,""sluttposisjon"":0.23760021,""kortform"":""0.20804552-0.23760021@320684"",""veglenkenummer"":30,""startnode"":""2020688"",""sluttnode"":""349122"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40091.22 6563322.93 5.805, -40106.4 6563329.4 5.805, -40127.3 6563338.4 5.805, -40147.9 6563346.7 5.805, -40170.6 6563356.1 5.905, -40191.7 6563364.7 6.005, -40214.4 6563374.1 6.105)"",""srid"":5973},""lengde"":133.39,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":938.926,""til_meter"":1072.316,""retning"":""MED""},""kortform"":""FV4524 S1D1 m939-1072""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.23760021,""sluttposisjon"":0.34520237,""kortform"":""0.23760021-0.34520237@320684"",""veglenkenummer"":9,""startnode"":""349122"",""sluttnode"":""349833"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40214.4 6563374.1 6.105, -40240 6563384.4 6.205, -40262.7 6563393.7 6.305, -40282.1 6563401.6 6.405, -40305.8 6563411.4 6.504, -40327.4 6563420.2 6.504, -40352.5 6563430.7 6.604, -40376 6563440.3 6.704, -40400.6 6563450.5 6.704, -40421.7 6563459.2 6.604, -40444.8 6563468.4 6.604, -40461.4 6563475.6 6.604, -40496.4 6563489.9 6.304, -40509.2 6563495.2 6.204, -40533.7 6563505.4 6.004, -40556.7 6563514.9 5.704, -40593.2 6563530.8 5.304, -40605.963 6563536.69 5.126, -40605.963 6563536.69 5.126, -40607.5 6563537.4 5.104, -40632 6563549.9 4.804, -40645 6563557.1 4.804, -40659.9 6563566.4 4.804)"",""srid"":5973},""lengde"":486.0,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1072.316,""til_meter"":1558.316,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1072-1558""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.34520237,""sluttposisjon"":0.37031206,""kortform"":""0.34520237-0.37031206@320684"",""veglenkenummer"":10,""startnode"":""349833"",""sluttnode"":""349994"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40659.9 6563566.4 4.804, -40684.7 6563583 5.003, -40709.9 6563602.9 4.903, -40720 6563612.1 4.803, -40725.506 6563617.698 4.834, -40725.506 6563617.698 4.834, -40737.9 6563630.3 4.903, -40746 6563639.4 4.903)"",""srid"":5973},""lengde"":113.0,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1558.316,""til_meter"":1671.316,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1558-1671""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/320684"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":320684,""startposisjon"":0.37031206,""sluttposisjon"":0.37498969,""kortform"":""0.37031206-0.37498969@320684"",""veglenkenummer"":11,""startnode"":""349994"",""sluttnode"":""2942433"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40746 6563639.4 4.903, -40757.72 6563653.53 5.143)"",""srid"":5973},""lengde"":18.36,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459111,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1671.316,""til_meter"":1689.676,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1671-1690""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2829303"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":2829303,""startposisjon"":0.0,""sluttposisjon"":0.53105123,""kortform"":""0.0-0.53105123@2829303"",""veglenkenummer"":1,""startnode"":""2942433"",""sluttnode"":""3020658"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40757.72 6563653.53 5.143, -40759.89 6563656.37 5.173, -40763.23 6563660.75 5.213, -40768.34 6563667.46 5.263, -40769.29 6563668.74 5.273, -40771.6 6563672.02 5.303, -40773.79 6563675.38 5.333, -40775.83 6563678.84 5.373, -40777.74 6563682.36 5.423, -40779.5 6563685.98 5.493, -40781.11 6563689.65 5.563, -40782.02 6563691.89 5.613, -40782.335 6563692.743 5.628)"",""srid"":5973},""lengde"":46.517,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459112,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1689.676,""til_meter"":1736.193,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1690-1736""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2829303"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":2829303,""startposisjon"":0.53105123,""sluttposisjon"":0.74946142,""kortform"":""0.53105123-0.74946142@2829303"",""veglenkenummer"":3,""startnode"":""3020658"",""sluttnode"":""2829334"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40782.335 6563692.743 5.628, -40783.27 6563695.27 5.673, -40783.78 6563696.79 5.703, -40784.65 6563699.57 5.763, -40785.06 6563701.01 5.783, -40785.58 6563702.9 5.823, -40785.98 6563704.44 5.853, -40786.24 6563705.42 5.873, -40786.76 6563707.39 5.903, -40787.26 6563709.35 5.943, -40787.417 6563709.945 5.955)"",""srid"":5973},""lengde"":17.951,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459112,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1736.193,""til_meter"":1754.145,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1736-1754""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2829303"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":2829303,""startposisjon"":0.74946142,""sluttposisjon"":1.0,""kortform"":""0.74946142-1.0@2829303"",""veglenkenummer"":2,""startnode"":""2829334"",""sluttnode"":""2829355"",""type"":""HOVED"",""detaljnivå"":""Vegtrase"",""typeVeg"":""Kanalisert veg"",""typeVeg_sosi"":""kanalisertVeg"",""feltoversikt"":[""1"",""2""],""geometri"":{""wkt"":""LINESTRING Z(-40787.417 6563709.945 5.955, -40787.78 6563711.32 5.983, -40788.25 6563713.14 6.013, -40788.76 6563715.08 6.053, -40789.26 6563717.02 6.093, -40789.77 6563718.96 6.133, -40790.26 6563720.86 6.163, -40790.78 6563722.84 6.203, -40791.24 6563724.62 6.233, -40791.75 6563726.53 6.263, -40792.651 6563729.944 6.783)"",""srid"":5973},""lengde"":20.714,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151166,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459112,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1754.145,""til_meter"":1774.859,""retning"":""MED""},""kortform"":""FV4524 S1D1 m1754-1775""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2829307"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":2829307,""startposisjon"":0.78830758,""sluttposisjon"":0.88485326,""kortform"":""0.78830758-0.88485326@2829307"",""veglenkenummer"":11,""startnode"":""2829354"",""sluttnode"":""2829355"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Rundkjøring"",""typeVeg_sosi"":""rundkjøring"",""feltoversikt"":[""1""],""geometri"":{""wkt"":""LINESTRING Z(-40801.74 6563730.4 6.783, -40799.89 6563729.79 6.783, -40798.11 6563729.5 6.783, -40796.59 6563729.4 6.783, -40794.96 6563729.48 6.783, -40793.94 6563729.62 6.783, -40792.651 6563729.944 6.783)"",""srid"":5973},""lengde"":9.265,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151165,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459112,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""meter"":1774.859,""retning"":""MED""},""kryssystem"":{""id"":1004489128,""versjon"":1,""kryssystem"":1000,""kryssdel"":1,""fra_meter"":69.916,""til_meter"":79.181,""retning"":""MED"",""trafikantgruppe"":""K""},""kortform"":""FV4524 S1D1 m1775 KD1 m70-79""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2829307"",""metadata"":{""startdato"":""2019-11-07""},""veglenkesekvensid"":2829307,""startposisjon"":0.76731209,""sluttposisjon"":0.78830758,""kortform"":""0.76731209-0.78830758@2829307"",""veglenkenummer"":10,""sluttnode"":""2829354"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Rundkjøring"",""typeVeg_sosi"":""rundkjøring"",""feltoversikt"":[""1""],""geometri"":{""wkt"":""POINT Z(-40801.74 6563730.4 6.783)"",""srid"":5973},""lengde"":1.629,""fylke"":11,""kommune"":1124,""vegsystemreferanse"":{""vegsystem"":{""id"":1002151165,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":4524},""strekning"":{""id"":1003459112,""versjon"":1,""strekning"":1,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""meter"":1774.859,""retning"":""MED""},""kryssystem"":{""id"":1004489128,""versjon"":1,""kryssystem"":1000,""kryssdel"":1,""fra_meter"":68.287,""til_meter"":69.916,""retning"":""MED"",""trafikantgruppe"":""K""},""kortform"":""FV4524 S1D1 m1775 KD1 m68-70""},""kontraktsområder"":[{""id"":587871979,""nummer"":1103,""navn"":""1103 Stavanger 2017-2022""},{""id"":642925409,""nummer"":1153,""navn"":""1153 Sør Rogaland 2018-2023""},{""id"":1009569601,""nummer"":1103,""navn"":""1103 Stavanger 2021-2026""}],""riksvegruter"":[]}],""metadata"":{""antall"":14,""lengde"":1622.643,""status"":2000,""status_tekst"":""KOMPLETT""}}
{noformat}
",NVDB-6937,Les-API,
Åpne endringslogg direkte i Vegkart,"-Endringsloggen er ikkje oppdatert på GitHub. Vi linkar no til den frå vegdata.no, og den bør då være oppdatert.-
Legg til url-flagg for Vegkart slik at endringsloggen vises. Endre https://github.com/nvdb-vegdata/endringslogg/blob/master/vegkart.md til å peke på vegkart#endringslogg.",NVDB-6937,Vegkart,
Bruk veg ved automatisk stedfesting med Skriv selv om fase ikke er satt,"Endringer i Skriv i NVDB-6023 gjør at ""fase"" for veg ikke lengre er obligatorisk, så vi kan sende inn kun vegkategori og vegnummer ved automatisk stedfesting.
Hvis jeg forstår Tore riktig så gir det også mening å sende inn vegkategori hvis ingen av de andre er satt, men vegkategori er påkrevd hvis en av de andre to er satt.",NVDB-6937,Datafangst,
Segmetering av vegnett og Gate,Segmenter vegnett basert på Gate(538) i tillegg til Kontraktsområde og Riksvegrute,NVDB-6937,NVDB-IND,
Sikre minimumslengde på strekningsstedfesting på en mer effektiv måte,"h2. Bakgrunn

Stedfestingstjenesten til API Skriv skal sikret at en strekningsstedfesting basert på rute fra API Les har minimumslengde (p.t. 1 m). Dette gjøres i dag ved å blåse opp den opprinnelige geometrien (Geometry.buffer() i JTS) og beregne rute på nytt. Dette gjentas inntil ruten har minimumslengde. Ved oppblåsing blir imidlertid en LINESTRING-geometri til en POLYGON-geometri med svært mange punkter, noe som drastisk øker responstiden. 

Mekanismen for å sikre minimumslengde bør justeres. Ting å vurdere:

1) Angi parameter til Geometry.buffer() for å redusere antall punkter i den oppblåste geometrien.
2) Kjøre Douglas-Peucker før reberegning av rute.
3) Reimplementere ved å utvide stedfestingen langs vegnettet selv.",NVDB-6937,Skriv-API,
"Systemfeil pga for mange listeelementer i ""IN""-uttrykk i SQL","h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/6602ec76-cd81-4277-96d9-4a9f5e7c51cd (og https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/6602ec76-cd81-4277-96d9-4a9f5e7c51cd) havarerer med systemfeil:

{code:java}
no.vegvesen.vt.nvdb.apiskriv.api.FaultException: java.sql.SQLSyntaxErrorException: ORA-01795: maximum number of expressions in a list is 1000

	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.JdbcFeatureRepository.getFeatureVersions(JdbcFeatureRepository.java:283)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.JobFilter$Context.getFeaturesFromNvdb(JobFilter.java:223)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ReadMissingParentFeaturesEnricherFilter.lambda$null$6(ReadMissingParentFeaturesEnricherFilter.java:166)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ReadMissingParentFeaturesEnricherFilter.lambda$getCoParentFeaturesFromNvdb$7(ReadMissingParentFeaturesEnricherFilter.java:145)
	at java.util.ArrayList.forEach(ArrayList.java:1257)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ReadMissingParentFeaturesEnricherFilter.getCoParentFeaturesFromNvdb(ReadMissingParentFeaturesEnricherFilter.java:141)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ReadMissingParentFeaturesEnricherFilter.getMissingCoParentFeatures(ReadMissingParentFeaturesEnricherFilter.java:96)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ReadMissingParentFeaturesEnricherFilter.doFilter(ReadMissingParentFeaturesEnricherFilter.java:58)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:455)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:177)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:145)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

SQL-setningen som forårsaken feilen:

{code:sql}
with UNIQUE_FEATURE_VERSIONS as (
  select distinct
    f.feature.persistentid FID,
    fv.featureversion.versionid VID
  from
    nvdb.features_0086 f,
    table(f.featureversions) fv,
    table(fv.list_220026.attrs_200026) laa
  where
    laa.attr_200026.fid in (1006715834,1006715833,1006717326,1006717325,1006717324,1006717323,1006717322,1006717321,1006717320,1006717319,1006717318,1006717383,1006717382,1006717380,1006717379,1006717378,1006717377,1006717376,1006717375,1006717374,1006717373,1006717372,1006717371,1006717370,1006717369,1006717368,1006717367,1006717366,1006717365,1006717364,1006717363,1006717362,1006717361,1006717360,1006717359,1006717358,1006717357,1006717356,1006717355,1006717354,1006717353,1006717352,1006717351,1006717350,1006717349,1006717348,1006717347,1006717346,1006717345,1006717344,1006717343,1006717342,1006717341,1006717340,1006717339,1006717338,1006717337,1006717336,1006717335,1006717334,1006717333,1006717332,1006717331,1006717330,1006717329,1006717328,1006717327,1006717290,1006717289,1006717288,1006717287,1006717286,1006717285,1006717284,1006717283,1006717282,1006717281,1006717280,1006717279,1006717278,1006717277,1006717276,1006717275,1006717274,1006717273,1006717272,1006717271,1006717270,1006717269,1006717268,1006717267,1006717266,1006717265,1006717264,1006717263,1006717262,1006717261,1006717260,1006717259,1006717258,1006717257,1006717256,1006717255,1006717254,1006717253,1006717252,1006717251,1006717250,1006717249,1006717248,1006717247,1006717246,1006717245,1006717244,1006717243,1006717242,1006717241,1006717240,1006717239,1006717238,1006717237,1006717236,1006717235,1006717234,1006717233,1006717232,1006717231,1006717230,1006717229,1006717228,1006717227,1006717226,1006717225,1006717224,1006717223,1006717222,1006717221,1006717220,1006717219,1006717218,1006717217,1006717216,1006717215,1006717214,1006717213,1006717212,1006717211,1006717210,1006717209,1006717208,1006717207,1006717206,1006717205,1006717204,1006717203,1006717202,1006717201,1006717200,1006717199,1006717198,1006717197,1006717196,1006717195,1006717194,1006717193,1006717192,1006717191,1006717190,1006717189,1006717188,1006717187,1006717186,1006717185,1006717184,1006717183,1006717182,1006717181,1006717180,1006717179,1006717178,1006717177,1006717176,1006717175,1006717174,1006717173,1006717172,1006717171,1006717170,1006717169,1006717168,1006717167,1006717166,1006717165,1006717164,1006717163,1006717162,1006717161,1006717160,1006717159,1006717158,1006717157,1006717156,1006717155,1006717154,1006717153,1006717152,1006717151,1006717150,1006717317,1006717316,1006717315,1006717314,1006717313,1006717312,1006717311,1006717310,1006717309,1006717308,1006717307,1006717306,1006717305,1006717304,1006717303,1006717302,1006717301,1006717300,1006717299,1006717298,1006717297,1006717296,1006717295,1006717294,1006717293,1006717292,1006717291,1006717047,1006717046,1006717045,1006717044,1006717043,1006717042,1006717041,1006717040,1006717039,1006717038,1006717037,1006717036,1006717035,1006717034,1006717033,1006717032,1006717031,1006717030,1006717029,1006717028,1006717027,1006717026,1006717025,1006717024,1006717023,1006717022,1006717021,1006717020,1006717019,1006717018,1006717017,1006717016,1006717015,1006717014,1006717013,1006717012,1006717011,1006717010,1006717009,1006717008,1006717007,1006717006,1006717005,1006717004,1006717003,1006717002,1006717001,1006717000,1006717149,1006717148,1006717147,1006717146,1006717145,1006717144,1006717143,1006717142,1006717141,1006717140,1006717139,1006717138,1006717137,1006717136,1006717135,1006717134,1006717133,1006717132,1006717131,1006717130,1006717129,1006717128,1006717127,1006717126,1006717125,1006717124,1006717123,1006717122,1006717121,1006717120,1006717119,1006717118,1006717117,1006717116,1006717115,1006717114,1006717113,1006717112,1006717111,1006717110,1006717109,1006717108,1006717107,1006717106,1006717105,1006717104,1006717103,1006717102,1006717101,1006717100,1006717099,1006717098,1006717097,1006717096,1006717095,1006717094,1006717093,1006717092,1006717091,1006717090,1006717089,1006717088,1006717087,1006717086,1006717085,1006717084,1006717083,1006717082,1006717081,1006717080,1006717079,1006717078,1006717077,1006717076,1006717075,1006717074,1006717073,1006717072,1006717071,1006717070,1006717069,1006717068,1006717067,1006717066,1006717065,1006717064,1006717063,1006717062,1006717061,1006717060,1006717059,1006717058,1006717057,1006717056,1006717055,1006717054,1006717053,1006717052,1006717051,1006717050,1006717049,1006717048,1006716999,1006716998,1006716997,1006716996,1006716995,1006716994,1006716993,1006716992,1006716991,1006716990,1006716989,1006716988,1006716987,1006716986,1006716985,1006716984,1006716983,1006716982,1006716981,1006716980,1006716979,1006716978,1006716977,1006716976,1006716975,1006716974,1006716973,1006716972,1006716971,1006716970,1006716969,1006716968,1006716967,1006716966,1006716965,1006716964,1006716963,1006716962,1006716961,1006716960,1006716959,1006716958,1006716957,1006716956,1006716955,1006716954,1006716953,1006716952,1006716951,1006716950,1006716949,1006716948,1006716947,1006716946,1006716945,1006716944,1006716943,1006716942,1006716941,1006716940,1006716939,1006716938,1006716937,1006716936,1006716935,1006716934,1006716933,1006716932,1006716931,1006716930,1006716929,1006716928,1006716927,1006716926,1006716925,1006716924,1006716923,1006716922,1006716921,1006716920,1006716919,1006716918,1006716917,1006716916,1006716915,1006716914,1006716913,1006716912,1006716911,1006716910,1006716909,1006716908,1006716907,1006716906,1006716905,1006716904,1006716903,1006716902,1006716901,1006716900,1006716899,1006716898,1006716897,1006716896,1006716895,1006716894,1006716893,1006716892,1006716891,1006716890,1006716889,1006716888,1006716887,1006716886,1006716885,1006716884,1006716883,1006716882,1006716881,1006716880,1006716879,1006716878,1006716877,1006716876,1006716875,1006716874,1006716873,1006716872,1006716871,1006716870,1006716869,1006716868,1006716867,1006716866,1006716865,1006716864,1006716863,1006716862,1006716861,1006716860,1006716859,1006716858,1006716857,1006716856,1006716855,1006716854,1006716853,1006716852,1006716851,1006716850,1006716849,1006716848,1006716847,1006716846,1006716845,1006716844,1006716843,1006716842,1006716841,1006716840,1006716839,1006716838,1006716837,1006716836,1006716835,1006716834,1006716833,1006716832,1006716831,1006716830,1006716829,1006716828,1006716827,1006716826,1006716825,1006716824,1006716823,1006716822,1006716821,1006716820,1006716819,1006716818,1006716817,1006716816,1006716815,1006716814,1006716813,1006716812,1006716811,1006716810,1006716809,1006716808,1006716807,1006716806,1006716805,1006716804,1006716803,1006716802,1006716801,1006716800,1006716799,1006716798,1006716797,1006716796,1006716795,1006716794,1006716793,1006716792,1006716791,1006716790,1006716789,1006716788,1006716787,1006716786,1006716785,1006716784,1006716783,1006716782,1006716781,1006716780,1006716779,1006716778,1006716777,1006716776,1006716775,1006716774,1006716773,1006716772,1006716771,1006716770,1006716769,1006716768,1006716767,1006716766,1006716765,1006716764,1006716763,1006716762,1006716761,1006716760,1006716759,1006716758,1006716757,1006716756,1006716755,1006716754,1006716753,1006716752,1006716751,1006716750,1006716749,1006716748,1006716747,1006716746,1006716745,1006716744,1006716743,1006716742,1006716741,1006716740,1006716739,1006716738,1006716737,1006716736,1006716735,1006716734,1006716733,1006716732,1006716731,1006716730,1006716729,1006716728,1006716727,1006716726,1006716725,1006716724,1006716723,1006716722,1006716721,1006716720,1006716719,1006716718,1006716717,1006716716,1006716715,1006716714,1006716713,1006716712,1006716711,1006716710,1006716709,1006716708,1006716707,1006716706,1006716705,1006716704,1006716703,1006716702,1006716701,1006716700,1006716699,1006716698,1006716697,1006716696,1006716695,1006716694,1006716693,1006716692,1006716691,1006716690,1006716689,1006716688,1006716687,1006716686,1006716685,1006716684,1006716683,1006716682,1006716681,1006716680,1006716679,1006716678,1006716677,1006716676,1006716675,1006716674,1006716673,1006716672,1006716671,1006716670,1006716669,1006716668,1006716667,1006716666,1006716665,1006716664,1006716663,1006716662,1006716661,1006716660,1006716659,1006716658,1006716657,1006716656,1006716655,1006716654,1006716653,1006716652,1006716651,1006716650,1006716649,1006716648,1006716647,1006716646,1006716645,1006716644,1006716643,1006716642,1006716641,1006716640,1006716639,1006716638,1006716637,1006716636,1006716635,1006716634,1006716633,1006716632,1006716631,1006716630,1006716629,1006716628,1006716627,1006716626,1006716625,1006716624,1006716623,1006716622,1006716621,1006716620,1006716619,1006716618,1006716617,1006716616,1006716615,1006716614,1006716613,1006716612,1006716611,1006716610,1006716609,1006716608,1006716607,1006716606,1006716605,1006716604,1006716603,1006716602,1006716601,1006716600,1006716599,1006716598,1006716597,1006716596,1006716595,1006716594,1006716593,1006716592,1006716591,1006716590,1006716589,1006716588,1006716587,1006716586,1006716585,1006716584,1006716583,1006716582,1006716581,1006716580,1006716579,1006716578,1006716577,1006716576,1006716575,1006716574,1006716573,1006716572,1006716571,1006716570,1006716569,1006716568,1006716567,1006716566,1006716565,1006716564,1006716563,1006716562,1006716561,1006716560,1006716559,1006716558,1006716557,1006716556,1006716555,1006716554,1006716553,1006716552,1006716551,1006716550,1006716549,1006716548,1006716547,1006716546,1006716545,1006716544,1006716543,1006716542,1006716541,1006716540,1006716539,1006716538,1006716537,1006716536,1006716535,1006716534,1006716533,1006716532,1006716531,1006716530,1006716529,1006716528,1006716527,1006716526,1006716525,1006716524,1006716523,1006716522,1006716521,1006716520,1006716519,1006716518,1006716517,1006716516,1006716515,1006716514,1006716513,1006716512,1006716511,1006716510,1006716509,1006716508,1006716507,1006716506,1006716505,1006716504,1006716503,1006716502,1006716501,1006716500,1006716499,1006716498,1006716497,1006716496,1006716495,1006716494,1006716493,1006716492,1006716491,1006716490,1006716489,1006716488,1006716487,1006716238,1006716237,1006716236,1006716235,1006716234,1006716233,1006716232,1006716231,1006716230,1006716229,1006716228,1006716227,1006716226,1006716225,1006716224,1006716223,1006716222,1006716221,1006716220,1006716219,1006716218,1006716217,1006716216,1006716486,1006716485,1006716484,1006716483,1006716482,1006716481,1006716480,1006716479,1006716478,1006716477,1006716476,1006716475,1006716474,1006716473,1006716472,1006716471,1006716470,1006716469,1006716468,1006716467,1006716466,1006716465,1006716464,1006716463,1006716462,1006716461,1006716460,1006716459,1006716458,1006716457,1006716456,1006716455,1006716454,1006716453,1006716452,1006716451,1006716258,1006716257,1006716256,1006716255,1006716254,1006716253,1006716252,1006716251,1006716250,1006716249,1006716248,1006716247,1006716246,1006716245,1006716244,1006716243,1006716242,1006716241,1006716240,1006716239,1006716215,1006716214,1006716213,1006716212,1006716211,1006716210,1006716209,1006716208,1006716207,1006716206,1006716205,1006716204,1006716203,1006716202,1006716201,1006716200,1006716199,1006716198,1006716197,1006716196,1006716195,1006716194,1006716193,1006716192,1006716191,1006716190,1006716189,1006716188,1006716187,1006716186,1006716185,1006716184,1006716183,1006716182,1006716181,1006716180,1006716179,1006716178,1006716177,1006716176,1006716175,1006716174,1006716173,1006716172,1006716171,1006716170,1006716169,1006716168,1006716167,1006716166,1006716165,1006716164,1006716163,1006716162,1006716161,1006716160,1006716159,1006716158,1006716157,1006716156,1006716155,1006716154,1006716153,1006716152,1006716151,1006716150,1006716149,1006716148,1006716147,1006716146,1006716145,1006716144,1006716143,1006716142,1006716141,1006716140,1006716139,1006716138,1006716137,1006716136,1006716135,1006716134,1006716133,1006716132,1006716131,1006716130,1006716129,1006716128,1006716127,1006716126,1006716125,1006716124,1006716123,1006716122,1006716121,1006716120,1006716119,1006716118,1006716117,1006716116,1006716115,1006716114,1006716113,1006716112,1006716111,1006716110,1006716109,1006716108,1006716107,1006716106,1006716105,1006716104,1006716103,1006716102,1006716101,1006716100,1006716099,1006716098,1006716097,1006716096,1006716095,1006716094,1006716093,1006716092,1006716091,1006716090,1006716089,1006716088,1006716087,1006716086,1006716085,1006716084,1006716083,1006716082,1006716081,1006716080,1006716079,1006716078,1006716077,1006716076,1006716075,1006716074,1006716073,1006716072,1006716071,1006716070,1006716069,1006716068,1006716067)
    and (fv.featureversion.enddate is null or fv.featureversion.enddate > to_date('2020-10-15', 'yyyy-mm-dd'))
)
select
  f.feature.persistentid FID,
  fv.featureversion.versionid VID,
  fv.featureversion.startdate SDATE,
  fv.featureversion.enddate EDATE,
  fv.list_120086.attrs_100086 LIST_120086,
  fv.list_220026.attrs_200026 LIST_220026,
  fv.list_221440.attrs_201440 LIST_221440,
  fv.list_220558.attrs_200558 LIST_220558,
  fv.list_220246.attrs_200246 LIST_220246
from
  nvdb.features_0086 f,
  table(f.featureversions) fv,
  UNIQUE_FEATURE_VERSIONS ufv
where
  ufv.FID = f.feature.persistentid
  and ufv.VID = fv.featureversion.versionid
order by
  FID,
  VID, OriginalSql = with UNIQUE_FEATURE_VERSIONS as (
  select distinct
    f.feature.persistentid FID,
    fv.featureversion.versionid VID
  from
    nvdb.features_0086 f,
    table(f.featureversions) fv,
    table(fv.list_220026.attrs_200026) laa
  where
    laa.attr_200026.fid in (1006715834,1006715833,1006717326,1006717325,1006717324,1006717323,1006717322,1006717321,1006717320,1006717319,1006717318,1006717383,1006717382,1006717380,1006717379,1006717378,1006717377,1006717376,1006717375,1006717374,1006717373,1006717372,1006717371,1006717370,1006717369,1006717368,1006717367,1006717366,1006717365,1006717364,1006717363,1006717362,1006717361,1006717360,1006717359,1006717358,1006717357,1006717356,1006717355,1006717354,1006717353,1006717352,1006717351,1006717350,1006717349,1006717348,1006717347,1006717346,1006717345,1006717344,1006717343,1006717342,1006717341,1006717340,1006717339,1006717338,1006717337,1006717336,1006717335,1006717334,1006717333,1006717332,1006717331,1006717330,1006717329,1006717328,1006717327,1006717290,1006717289,1006717288,1006717287,1006717286,1006717285,1006717284,1006717283,1006717282,1006717281,1006717280,1006717279,1006717278,1006717277,1006717276,1006717275,1006717274,1006717273,1006717272,1006717271,1006717270,1006717269,1006717268,1006717267,1006717266,1006717265,1006717264,1006717263,1006717262,1006717261,1006717260,1006717259,1006717258,1006717257,1006717256,1006717255,1006717254,1006717253,1006717252,1006717251,1006717250,1006717249,1006717248,1006717247,1006717246,1006717245,1006717244,1006717243,1006717242,1006717241,1006717240,1006717239,1006717238,1006717237,1006717236,1006717235,1006717234,1006717233,1006717232,1006717231,1006717230,1006717229,1006717228,1006717227,1006717226,1006717225,1006717224,1006717223,1006717222,1006717221,1006717220,1006717219,1006717218,1006717217,1006717216,1006717215,1006717214,1006717213,1006717212,1006717211,1006717210,1006717209,1006717208,1006717207,1006717206,1006717205,1006717204,1006717203,1006717202,1006717201,1006717200,1006717199,1006717198,1006717197,1006717196,1006717195,1006717194,1006717193,1006717192,1006717191,1006717190,1006717189,1006717188,1006717187,1006717186,1006717185,1006717184,1006717183,1006717182,1006717181,1006717180,1006717179,1006717178,1006717177,1006717176,1006717175,1006717174,1006717173,1006717172,1006717171,1006717170,1006717169,1006717168,1006717167,1006717166,1006717165,1006717164,1006717163,1006717162,1006717161,1006717160,1006717159,1006717158,1006717157,1006717156,1006717155,1006717154,1006717153,1006717152,1006717151,1006717150,1006717317,1006717316,1006717315,1006717314,1006717313,1006717312,1006717311,1006717310,1006717309,1006717308,1006717307,1006717306,1006717305,1006717304,1006717303,1006717302,1006717301,1006717300,1006717299,1006717298,1006717297,1006717296,1006717295,1006717294,1006717293,1006717292,1006717291,1006717047,1006717046,1006717045,1006717044,1006717043,1006717042,1006717041,1006717040,1006717039,1006717038,1006717037,1006717036,1006717035,1006717034,1006717033,1006717032,1006717031,1006717030,1006717029,1006717028,1006717027,1006717026,1006717025,1006717024,1006717023,1006717022,1006717021,1006717020,1006717019,1006717018,1006717017,1006717016,1006717015,1006717014,1006717013,1006717012,1006717011,1006717010,1006717009,1006717008,1006717007,1006717006,1006717005,1006717004,1006717003,1006717002,1006717001,1006717000,1006717149,1006717148,1006717147,1006717146,1006717145,1006717144,1006717143,1006717142,1006717141,1006717140,1006717139,1006717138,1006717137,1006717136,1006717135,1006717134,1006717133,1006717132,1006717131,1006717130,1006717129,1006717128,1006717127,1006717126,1006717125,1006717124,1006717123,1006717122,1006717121,1006717120,1006717119,1006717118,1006717117,1006717116,1006717115,1006717114,1006717113,1006717112,1006717111,1006717110,1006717109,1006717108,1006717107,1006717106,1006717105,1006717104,1006717103,1006717102,1006717101,1006717100,1006717099,1006717098,1006717097,1006717096,1006717095,1006717094,1006717093,1006717092,1006717091,1006717090,1006717089,1006717088,1006717087,1006717086,1006717085,1006717084,1006717083,1006717082,1006717081,1006717080,1006717079,1006717078,1006717077,1006717076,1006717075,1006717074,1006717073,1006717072,1006717071,1006717070,1006717069,1006717068,1006717067,1006717066,1006717065,1006717064,1006717063,1006717062,1006717061,1006717060,1006717059,1006717058,1006717057,1006717056,1006717055,1006717054,1006717053,1006717052,1006717051,1006717050,1006717049,1006717048,1006716999,1006716998,1006716997,1006716996,1006716995,1006716994,1006716993,1006716992,1006716991,1006716990,1006716989,1006716988,1006716987,1006716986,1006716985,1006716984,1006716983,1006716982,1006716981,1006716980,1006716979,1006716978,1006716977,1006716976,1006716975,1006716974,1006716973,1006716972,1006716971,1006716970,1006716969,1006716968,1006716967,1006716966,1006716965,1006716964,1006716963,1006716962,1006716961,1006716960,1006716959,1006716958,1006716957,1006716956,1006716955,1006716954,1006716953,1006716952,1006716951,1006716950,1006716949,1006716948,1006716947,1006716946,1006716945,1006716944,1006716943,1006716942,1006716941,1006716940,1006716939,1006716938,1006716937,1006716936,1006716935,1006716934,1006716933,1006716932,1006716931,1006716930,1006716929,1006716928,1006716927,1006716926,1006716925,1006716924,1006716923,1006716922,1006716921,1006716920,1006716919,1006716918,1006716917,1006716916,1006716915,1006716914,1006716913,1006716912,1006716911,1006716910,1006716909,1006716908,1006716907,1006716906,1006716905,1006716904,1006716903,1006716902,1006716901,1006716900,1006716899,1006716898,1006716897,1006716896,1006716895,1006716894,1006716893,1006716892,1006716891,1006716890,1006716889,1006716888,1006716887,1006716886,1006716885,1006716884,1006716883,1006716882,1006716881,1006716880,1006716879,1006716878,1006716877,1006716876,1006716875,1006716874,1006716873,1006716872,1006716871,1006716870,1006716869,1006716868,1006716867,1006716866,1006716865,1006716864,1006716863,1006716862,1006716861,1006716860,1006716859,1006716858,1006716857,1006716856,1006716855,1006716854,1006716853,1006716852,1006716851,1006716850,1006716849,1006716848,1006716847,1006716846,1006716845,1006716844,1006716843,1006716842,1006716841,1006716840,1006716839,1006716838,1006716837,1006716836,1006716835,1006716834,1006716833,1006716832,1006716831,1006716830,1006716829,1006716828,1006716827,1006716826,1006716825,1006716824,1006716823,1006716822,1006716821,1006716820,1006716819,1006716818,1006716817,1006716816,1006716815,1006716814,1006716813,1006716812,1006716811,1006716810,1006716809,1006716808,1006716807,1006716806,1006716805,1006716804,1006716803,1006716802,1006716801,1006716800,1006716799,1006716798,1006716797,1006716796,1006716795,1006716794,1006716793,1006716792,1006716791,1006716790,1006716789,1006716788,1006716787,1006716786,1006716785,1006716784,1006716783,1006716782,1006716781,1006716780,1006716779,1006716778,1006716777,1006716776,1006716775,1006716774,1006716773,1006716772,1006716771,1006716770,1006716769,1006716768,1006716767,1006716766,1006716765,1006716764,1006716763,1006716762,1006716761,1006716760,1006716759,1006716758,1006716757,1006716756,1006716755,1006716754,1006716753,1006716752,1006716751,1006716750,1006716749,1006716748,1006716747,1006716746,1006716745,1006716744,1006716743,1006716742,1006716741,1006716740,1006716739,1006716738,1006716737,1006716736,1006716735,1006716734,1006716733,1006716732,1006716731,1006716730,1006716729,1006716728,1006716727,1006716726,1006716725,1006716724,1006716723,1006716722,1006716721,1006716720,1006716719,1006716718,1006716717,1006716716,1006716715,1006716714,1006716713,1006716712,1006716711,1006716710,1006716709,1006716708,1006716707,1006716706,1006716705,1006716704,1006716703,1006716702,1006716701,1006716700,1006716699,1006716698,1006716697,1006716696,1006716695,1006716694,1006716693,1006716692,1006716691,1006716690,1006716689,1006716688,1006716687,1006716686,1006716685,1006716684,1006716683,1006716682,1006716681,1006716680,1006716679,1006716678,1006716677,1006716676,1006716675,1006716674,1006716673,1006716672,1006716671,1006716670,1006716669,1006716668,1006716667,1006716666,1006716665,1006716664,1006716663,1006716662,1006716661,1006716660,1006716659,1006716658,1006716657,1006716656,1006716655,1006716654,1006716653,1006716652,1006716651,1006716650,1006716649,1006716648,1006716647,1006716646,1006716645,1006716644,1006716643,1006716642,1006716641,1006716640,1006716639,1006716638,1006716637,1006716636,1006716635,1006716634,1006716633,1006716632,1006716631,1006716630,1006716629,1006716628,1006716627,1006716626,1006716625,1006716624,1006716623,1006716622,1006716621,1006716620,1006716619,1006716618,1006716617,1006716616,1006716615,1006716614,1006716613,1006716612,1006716611,1006716610,1006716609,1006716608,1006716607,1006716606,1006716605,1006716604,1006716603,1006716602,1006716601,1006716600,1006716599,1006716598,1006716597,1006716596,1006716595,1006716594,1006716593,1006716592,1006716591,1006716590,1006716589,1006716588,1006716587,1006716586,1006716585,1006716584,1006716583,1006716582,1006716581,1006716580,1006716579,1006716578,1006716577,1006716576,1006716575,1006716574,1006716573,1006716572,1006716571,1006716570,1006716569,1006716568,1006716567,1006716566,1006716565,1006716564,1006716563,1006716562,1006716561,1006716560,1006716559,1006716558,1006716557,1006716556,1006716555,1006716554,1006716553,1006716552,1006716551,1006716550,1006716549,1006716548,1006716547,1006716546,1006716545,1006716544,1006716543,1006716542,1006716541,1006716540,1006716539,1006716538,1006716537,1006716536,1006716535,1006716534,1006716533,1006716532,1006716531,1006716530,1006716529,1006716528,1006716527,1006716526,1006716525,1006716524,1006716523,1006716522,1006716521,1006716520,1006716519,1006716518,1006716517,1006716516,1006716515,1006716514,1006716513,1006716512,1006716511,1006716510,1006716509,1006716508,1006716507,1006716506,1006716505,1006716504,1006716503,1006716502,1006716501,1006716500,1006716499,1006716498,1006716497,1006716496,1006716495,1006716494,1006716493,1006716492,1006716491,1006716490,1006716489,1006716488,1006716487,1006716238,1006716237,1006716236,1006716235,1006716234,1006716233,1006716232,1006716231,1006716230,1006716229,1006716228,1006716227,1006716226,1006716225,1006716224,1006716223,1006716222,1006716221,1006716220,1006716219,1006716218,1006716217,1006716216,1006716486,1006716485,1006716484,1006716483,1006716482,1006716481,1006716480,1006716479,1006716478,1006716477,1006716476,1006716475,1006716474,1006716473,1006716472,1006716471,1006716470,1006716469,1006716468,1006716467,1006716466,1006716465,1006716464,1006716463,1006716462,1006716461,1006716460,1006716459,1006716458,1006716457,1006716456,1006716455,1006716454,1006716453,1006716452,1006716451,1006716258,1006716257,1006716256,1006716255,1006716254,1006716253,1006716252,1006716251,1006716250,1006716249,1006716248,1006716247,1006716246,1006716245,1006716244,1006716243,1006716242,1006716241,1006716240,1006716239,1006716215,1006716214,1006716213,1006716212,1006716211,1006716210,1006716209,1006716208,1006716207,1006716206,1006716205,1006716204,1006716203,1006716202,1006716201,1006716200,1006716199,1006716198,1006716197,1006716196,1006716195,1006716194,1006716193,1006716192,1006716191,1006716190,1006716189,1006716188,1006716187,1006716186,1006716185,1006716184,1006716183,1006716182,1006716181,1006716180,1006716179,1006716178,1006716177,1006716176,1006716175,1006716174,1006716173,1006716172,1006716171,1006716170,1006716169,1006716168,1006716167,1006716166,1006716165,1006716164,1006716163,1006716162,1006716161,1006716160,1006716159,1006716158,1006716157,1006716156,1006716155,1006716154,1006716153,1006716152,1006716151,1006716150,1006716149,1006716148,1006716147,1006716146,1006716145,1006716144,1006716143,1006716142,1006716141,1006716140,1006716139,1006716138,1006716137,1006716136,1006716135,1006716134,1006716133,1006716132,1006716131,1006716130,1006716129,1006716128,1006716127,1006716126,1006716125,1006716124,1006716123,1006716122,1006716121,1006716120,1006716119,1006716118,1006716117,1006716116,1006716115,1006716114,1006716113,1006716112,1006716111,1006716110,1006716109,1006716108,1006716107,1006716106,1006716105,1006716104,1006716103,1006716102,1006716101,1006716100,1006716099,1006716098,1006716097,1006716096,1006716095,1006716094,1006716093,1006716092,1006716091,1006716090,1006716089,1006716088,1006716087,1006716086,1006716085,1006716084,1006716083,1006716082,1006716081,1006716080,1006716079,1006716078,1006716077,1006716076,1006716075,1006716074,1006716073,1006716072,1006716071,1006716070,1006716069,1006716068,1006716067)
    and (fv.featureversion.enddate is null or fv.featureversion.enddate > to_date('2020-10-15', 'yyyy-mm-dd'))
)
select
  f.feature.persistentid FID,
  fv.featureversion.versionid VID,
  fv.featureversion.startdate SDATE,
  fv.featureversion.enddate EDATE,
  fv.list_120086.attrs_100086 LIST_120086,
  fv.list_220026.attrs_200026 LIST_220026,
  fv.list_221440.attrs_201440 LIST_221440,
  fv.list_220558.attrs_200558 LIST_220558,
  fv.list_220246.attrs_200246 LIST_220246
from
  nvdb.features_0086 f,
  table(f.featureversions) fv,
  UNIQUE_FEATURE_VERSIONS ufv
where
  ufv.FID = f.feature.persistentid
  and ufv.VID = fv.featureversion.versionid
order by
  FID,
  VID
{code}

Situasjonen oppstår i ReadMissingParentFeaturesEnricherFilter som skal berike jobben med relevante morobjekter til vegobjekte i jobben. FeatureSpecification sin ChildHavingId-kriterium brukes for å finne vegobjekter med assosiasjon til aktuelle datterobjekter, men antallet datterobjekter er større enn 1000, slik at SQL-uttrykket får en IN-klausul med mer enn 1000 verdier, hvilket ikke er tillatt i Oracle.

h2. Løsning

Etablerer partisjonering av FeatureSpecification på assosiasjonsverdi slik som vi allerede har for instansverdier. Dette realiseres med ny metode partition() på AssociationCriterion, som gjen brukes av ny metode partitionForOracleSql() på FeatureSpecification.",NVDB-6937,Skriv-API,
Assosiasjon: håndterer ikke NVDB-mors versjoner,"*Problem*

Datafangst sender oppdatering på NVDB-mor som ikke lenger har kobling til NVDB-datter i siste versjon, men som Datafangst ikke vet noe om.

*Diskusjon på Mattermost*

Jeg importer et nytt skiltpunkt, kobler til en NVDB-datter og forsøker å registrere. Da får jeg opp feilmld fra Skriv 1007893667: _Fjernet verdi 1007893666 finnes ikke i egenskapen_

Dette skjønner jeg godt hvis jeg slår opp denne NVDB-mora (1007893667) som fra DF sin side er mor til NVDB-datter som skal flyttes til nytt skiltpunkt. For siste versjon av denne NVDB-mora har ikke relasjon til NVDB-datter lengre, men forrige versjon har dette.
 * Siste versjon av NVDB-mor (har ikke ass til aktuell datter): [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/95/1007893667/4]
 * Forrige versjon av NVDB-mor (har ass til aktuell datter): [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/95/1007893667/3]
 * Siste versjon av NVDB-datter (som fortsatt har 1007893667 som mor): [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/96/1007893666/1]

DF-kontrakt: [https://datafangst-utv.kantega.no/#!/contract/b3c2dbe7-4e6a-4f83-ba62-72c564e32e7a/export]

Jeg tror at vi ved henting av NVDB-datter ved assosiasjon så ser vi fra Les at denne har en mor, men vi vet ikke versjon fra kall mot Les. Legger derfor inn mor med versjon 0 (mor vil vises med <nvdb-id>:0 i GUI). Når vi så endrer noe i sammenkoblingen her, henter vi inn siste versjon av mor som videre blir lagt i endringssettet med sletting av kjobling mot denne datteren. Skriv vil derfor klage over at denne siste versjonen ikke har denne assosiasjonen.

*Fra Marvin*: Relasjoner peker kun på id, ikke versjon, så alle døtre blir koblet til alle mødre

-> Dette gjør at Datafangst antar at siste versjon av mor alltid vil ha denne koblingen hvis det oppgis at en datter har en mor.

*Fra Espen*: Dette forklarer problemet i NVDB-6011: når datafangst lager-assoc objektet mellom mor og datter i nvdb, så setter den nvdbref med 0 som versjon, som da fører til at vi får null når vi prøver å finne dette objektet i kontrakten siden objektet vi leter etter egentlig har en annen versjon enn 0 i nvdbref ",NVDB-6937,Datafangst,
Enkelte tegn fungerer ikke i passord,"h2. Deffinert problem

SVV-brukarar med norske tegn (i alle fall Ø) i passordet får ikkje logga inn. Får ""Feil brukernavn eller passord"".
h3. Kurriøst problem

I STM/ATM fungerer heller ikkje '-', men det fungerer i PROD.

Passordet var det same i STM og ATM, men ikkje i PROD. Med å bytte ut '-' med'.' fungerte passardet. Kan vere kombinasjonen av andre tegn og '-' som skaper problem.",NVDB-6937,Datafangst,
Endrede stedfestinger oppdateres ikke i GUI,"h2. Observasjon

Følg observasjon i NVDB-6003. Etter stedfesting oppdateres et av objektene i GUI, men ikke begge. Etter reload er alt på plass; både grønt symbol for de endrede objektene og grønt symbol for selve typene.

Se vedlagte skjermbilder.",NVDB-6937,Datafangst,
Får en rute som ikke er koblet sammen,"h2. Observasjon

Kall
{noformat}
https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING%20(136672.43%206500140.11,%20136671.64%206500119.29,%20136671.64%206500119.23,%20136674.15%206500098.12,%20136675.73%206500083.43,%20136675.73%206500083.4,%20136676.44%206500069.33,%20136676.44%206500069.29,%20136677.35%206500054.53,%20136677.35%206500054.49,%20136677.21%206500045.88,%20136677.21%206500045.84,%20136677.62%206500030.2,%20136677.62%206500030.15,%20136677.21%206500023.1,%20136677.2%206500023.02,%20136675.76%206500015.07,%20136675.74%206500014.98,%20136673.76%206500008.96,%20136673.71%206500008.85,%20136670.9%206500003.79,%20136670.87%206500003.75,%20136667.23%206499998.23,%20136667.17%206499998.16,%20136662.17%206499992.63,%20136662.11%206499992.58,%20136658.67%206499989.69,%20136658.62%206499989.66,%20136653.88%206499986.48,%20136653.85%206499986.46,%20136650.82%206499984.67,%20136650.77%206499984.64,%20136646.63%206499982.7,%20136646.56%206499982.67,%20136641.38%206499980.98,%20136635.91%206499979.36,%20136635.84%206499979.35,%20136629%206499978.16,%20136628.97%206499978.15,%20136625.67%206499977.71,%20136595.42%206499978.31,%20136595.16%206499978.31)&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&kortform=true
{noformat}
gir tilbake bl.a. rutesegmentene
{noformat}
<vegnettrutesegment>
  <type>Linje</type>
  <veglenkesekvensid>2077351</veglenkesekvensid>
  <startposisjon>0.13488073</startposisjon>
  <sluttposisjon>0.37951174</sluttposisjon>
  <kortform>0.13488073-0.37951174@2077351</kortform>
</vegnettrutesegment>
<vegnettrutesegment>
  <type>Linje</type>
  <veglenkesekvensid>3158628</veglenkesekvensid>
  <startposisjon>0.98046837</startposisjon>
  <sluttposisjon>1.0</sluttposisjon>
  <kortform>0.98046837-1.0@3158628</kortform>
</vegnettrutesegment>
{noformat}
Hvor 0.37951174@2077351 er koblet til node 3120474

[https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/2077351]

Og 0.0@3158628 er koblet til node 3120474

[https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/3158628]

Men altså hverken 0.98046837@3158628 eller 1.0@3158628 er koblet til denne.

Her skulle det ha vært 0.0@3158628 som var oppgitt i rute-responsen.

Observasjonen er gjenskapt i alle miljøene.

 
h3. Løsning

Problemet var at noen av de riktige segmentene ble filtrert bort under beregning av ruten, som skjedde ved at en rute fra punkt til punkt i geometrien ble beregnet og deretter sammensatt. Endet på behandling av geometri ved ruteberegning slik at segmenter mellom punktene i geometrien først blir samlet inn, og deretter blir de matet inn i ruteberegningen med resten av parametrene. Da unngår vi problemene med at ruten består av mange små ruter som ikke nødvendigvis henger sammen som en helhet.

Rute for polygon beregnes med den gamle metoden.",NVDB-6937,Les-API,
Funksjon for å angre sletting av assosiasjon,"Man kan nå slette en assosiasjon mellom 2 objekter som er lagret i NVDB.

Denne slettingen må effektueres ved å sende et endringssett til Skriv.

Vi må tillate å angre en slik sletting av assosiasjon. Hvis en bruker feilaktig sletter en slik assoisiasjon kommer hun seg ikke ut av det uten å slette objektene fra kontrakten.

 

!image-2020-10-13-14-45-20-566.png!",NVDB-6937,Datafangst,
fikse opp UI og oppførsel for sletting av sammenkobling,"Man kan slette sammenkoblinger på objekter som er importert fra NVDB, men GUI reflekterer ikke hva man kan og ikke kan gjøre.

Når en sammenkobling er merkert for sletting, kan man fortsatt trykke på knappen for å slette den, selv om det ikke har noen effekt

Når en sammenkobling er merket for sletting, kan man trykke på knappen for å koble sammen de valgte objektene, selv om det ikke har noen effekt.
 * nå når vi bruker beskrivende navn på objektene i sammenkobling, får vi dobbelt opp av navngiving. vi kan fjerne den ene.
 * 

 

!image-2020-10-13-14-43-32-850.png!

 ",NVDB-6937,Datafangst,
rydde opp ikoner på sammenkobling,"ikonene legger seg over NVDB-badgen og tekst

rydd opp i ikonvisningen

 

!image-2020-10-13-14-12-12-513.png!",NVDB-6937,Datafangst,
"Send inn ""trafikantgruppe"" for typeVeg ved stedfesting med Skriv","h2. Observasjon

Når bruker klikker på en veg for stedfesting, så henter vi typeVeg fra Les for å sende inn dette for å få riktig veg. Å bruke kun en typeVeg her kan bli for spesifikt, så vi bør mappe typeveg til en gruppe med typeVeg'er, sånn at vi f.eks. får med alle typer bilveg når bruker har klikket bilveg, i stedet for bare akkurat den typen som bruker klikket på.
h2. Løsning

Lagde en enum for mapping til og fra NVDB-verdier med funksjon for å hente ut relaterte enumer.

Sender liste med relaterte enumer til stedfesting med Skriv

Enhetstester ",NVDB-6937,Datafangst,
Feil sorteringsrekkefølge på egenskapsverdier,"h2. Observasjon

(Fra support ved Stein Idar Dyngen)

Egenskapsverdiene til Skiltnummer er ikke sortert ihht Datakatalogen. Se i Datafangst hvor f.ex verdi 146.X kommer. Denne skal sorteres etter 144 og før 148 i følge DK. Og det er flere eksempler her.",NVDB-6937,Datafangst,
Bedre deteksjon av datafeil i SingleParentValidator,"h2. Observasjon

Fra Tor Kjetil:

Denne kommer fra Datafangst https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/b6051bcb-5bb6-44c5-8859-a5777656975f (kontrakt a7654020-294a-4442-831e-32d010da52fb)
Feilmeld sier bl.a. at en datter har flere mødre. En av disse
Endringssett: Objektet har mer enn ett morobjekt i en komposisjonssammenheng: VEGOBJEKTTYPE=86; ID=656220958; VERSJON=6; STARTDATO=2019-10-15; SLUTTDATO=null. Morobjektversjoner: VEGOBJEKTTYPE=461; ID=846923099; VERSJON=3; STARTDATO=2020-01-10; SLUTTDATO=2020-10-09, VEGOBJEKTTYPE=461; ID=846923099; VERSJON=4; STARTDATO=2020-10-09; SLUTTDATO=null og VEGOBJEKTTYPE=461; ID=792006062; VERSJON=5; STARTDATO=2020-01-10; SLUTTDATO=2020-10-09

Men jeg finner ikke at v3 av mor er avsluttet, og finner ingen v4 av samme objekt: https://www.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/461/846923099/3

h2. Analyse

461/846923099/3 blir oppdatert i endringssettet. v3 blir da lukket og v4 lagt til. Begge disse versjonene har assosiasjon til (og felles levetid med) 86/656220958/6. Det gjøres ingen endring på assosiasjonen under oppdateringen. I tillegg oppdateres 461/792006062/5 i endringssettet. Dermed lukkes v5 og v6 legges til. Oppdatering består bl.a. i at assosiasjon til 656220958 fjernes (i v6).

Det er dermed korrekt at det er flere morobjekter, men i og med at disse morobjektene finnes i NVDB er det strengt tatt en datafeil. Jeg har undersøkt opphavet og ser at det er klassisk klient-api som er synderen.

API Skriv må unnlate å trigge slike avvisninger når det er datafeil. Det er allerede en slags sjekk på dette i SingleParentValidator, men den ser ikke på hva som faktisk gjøres med hver enkelt assosiasjonsattributt.

h2. Løsning

Utvider SingleParentValidator.isValidFeature() med kontroll på at assosiasjonsverdien faktisk er oppdatert i endringssettet før valideringsfeil trigges.",NVDB-6937,Skriv-API,
Advarer om manglende assosiasjon som er der,"h2. Observasjon

(Fra support ved Raymond)

Hvis man kobler en datter til en mor vil fortsatt mor ha advarsel i datafanen om at assosiert type av datterens type mangler som en advarsel.

*Gjenskap*

Last inn vedlagte SOSI. Koble disse. Gå til datafanen og observer at mor som nå har fått en datter har advarsel
{noformat}
Objektet, av typen Skiltpunkt (95), mangler egenskaper med viktighet 'påkrevd, ikke absolutt': [Assosierte Variabelt skilt (220006), Assosierte Skiltplate (220004)]
{noformat}
Se også kontrakt: [https://datafangst-utv.kantega.no/#!/contract/3005eabf-a757-43ed-aeb1-111880c3825e/features3]
h2. Analyse

Det gjøres ingen revalidering etter assosiasjons-operasjoner 
h2. Løsning

refaktoriserte og eksponerte metoder for å re-validere en liste med objekter eller en liste med objekttyper

sammenkoblingsoperasjoner (auto, manuell, slett) sender nå objektene til revalidering. ved auto og slett revalideres de beørte objekktypene, for å fange opp tilfeller der mor har blitt flyttet og evt andre bieffekter som kan oppstå.",NVDB-6937,Datafangst,
Feil advarsel om mangler på objekt,"h2. Observasjon

(fra support ved Raymond)

Hvis man i datafanen kopierer et NVDB-objekt til et nytt objekt så kan man få advarsler om at egenskaper mangler som det nye objektet faktisk har. I aktuelt tilfelle rapporteres det om at nytt objekt mangler Rekkverkstype og Bruksområde - noe som er feil.

For å gjenskape

Last inn vedlagte SOSI. Finn NVDB-objekter i kartet (datafanen). Importer det nærmeste som Oppdater. Kopier så dette NVDB-objektet som et nytt objekt og observer advarslene mot hva objektet faktisk har av egenskaper. Se også kontrakt: [https://datafangst-utv.kantega.no/#!/contract/a4e65373-fc1e-4f9c-af65-dcea602b25fc/features3]
h2. Analyse

Disse validerings-feilene genereres av API skriv. Vi sender inn ett endringsønske, og sender det til Skriv for validering, for å se hva som mangler for å kunne lagre vegobjektene.
For å få til det må vi mappe om objektene til et endringssett. denne mapperen mapper bare egenskaper som er satt til lagreing (opprett, oppdater, korriger). Hvis man kopierer et objekt som har egenskaper satt til les, vil ikke disse egenskapene mappes over til endringssettet, og Skriv gir valideringsfeil på at de mangler.

Det gjøres et forsøk for å ta høyde for dette, men timingen blir feil og egenskapene setter til ""opprett"" etter at de valideres.
h2. Løsning 

Fiks timing for å når egenskapene settes til Skriv.

I denne koden ligger det også en assert, som antakelig er ment å skulle funke som feilhåndtering, men det vil aldri funke noe bra (og asserts er slått av som default). Denne asserten fjernes.

 ",NVDB-6937,Datafangst,
Vegsystemreferanse blir ikke slått sammen,"{quote}
hvis man gjør dette kallet: https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/99?srid=4326&inkluder=lokasjon&vegsystemreferanse=FV864S2
og ser på objektet med id: 204249035 så har det åtte vegsystemreferanser der objektet er stedfestet.

Hvis man gjør dette kallet: https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/99/204249035
så ser man at vegsystemreferansene der objektet er stedfestet på er slått sammen og har fra_meter 0 og til_meter 2997.371.

Er det, eller kan det bli, en mulighet for å få slått sammen sammenhengende vegsystemreferanser også for kall tilsvarende det første?

I tillegg i det andre kallet så har objektet med id: 204249035 fått en stedfesting på strekning 1 fra_meter 3168.287 og til_meter 3168.315 som jeg ikke helt forstår hvor kommer fra, men det er en annen sak.
{quote}

",NVDB-6937,Les-API,
Velg alle/ingen ved auto stedfesting,"Fra support (Kemal Kurumahmut)

Hvis man har mange objekttyper i en kontrakt, så hadde det vært fint å ha en knapp som sier noe a la ""velg alle / ingen"" i popup for auto stedfesting. I dag velges alle per default, så om man ønsker å stedfeste en og en er det en tung prosess.",NVDB-6937,Datafangst,
Bruk Cache API for lagring av Datakatalogen,"Endringer i NVDB-4303 gjør at hele Datakatalogen nå caches i nettleser. Størrelsen har økt til 2,5 MB, som fortsatt er godt innenfor det vi kan ha i localStorage, men det er en mulighet for at endringer i Datakatalogen eller endring i hvor mye nettlesere tillater i localStorage vil gjøre at dette slutter å virke. I tillegg er det problemer med ytelse for localStorage og store objekter, siden det er en synkron API.

Cache API er bedre egnet til den type (\*ahem\*) _caching_ som gjøres her, så skriver om caching av Datakatalogen til å bruke den.",NVDB-6937,Datafangst,
stedfesting: flytt bare objekter vi finner i prosjektet,"Ved flytting må vi påse at vi bare flytter objekter som er importert i DF.

assosiasjoner har DF-ID-er eller NVDB-ID-er som referanse og begge disse kan brukes for å referere til objekter importert i NVDB.

NVDB-5978 fikset et problem der lagrede objekter (som har både DF- og NVDB-id) genererte nullpotinere.

Denne saken sørger for at vi ikke får nullpointer når assosiasjoner inneholder en referanse til en tidligere versjon av objektene som er importert i DF.

Det er også lagt til en ekstra mekanisme som sørger for at vi ikke kaster en exception når assosiasjoner inneholder referanser til objekter som ikke er importert, som dermed flytter ansvaret til hvilke objekter som skal flyttes høyere opp i arkitekturen.

Dette skal underbygge at når bruker skal gjøre endringer på objekter må de flyttes inn i prosjektet.

 ",NVDB-6937,Datafangst,
Får ikke alle objekter hver gang,"Sjekk ut dette, meldt inn via gitter (https://gitter.im/nvdb-vegdata/api-les-v3?at=5f7f124066ee4e44a88db4b6):

 

I går dreiv eg å henta ut trafikkmengdeobjekt for alle riksvegar via Java-klienten. Eg køyrde programmet mitt ein del gonger og observerte at den totale lengden veg kunne variere ganske drastisk mellom køyringar. Her er antal kilometer med veg for kvar køyring:
 * 10286.183671561386 km
 * 7534.98141968181 km
 * 6526.802729395468 km
 * 10286.149466227213 km
 * 210.47337508706784 km
 * 10286.148208214528 km

Ser ut til at eg ikkje nødvendigvis får alle trafikkmengdeobjekta ved kvar køyring. Kva er årsaken til det?",NVDB-6937,Les-API,
Etablere STM-miljø på Atlas-plattformen,"Har fått etablert applikasjonsmiljø for STM i Atlas (nvdbapiskriv-systemtest). Det gjenstår da å sette opp Atlas-konfigurasjon for tjenester, velv etc og rulle ut NVDB API Skriv.

QA: Se konfigurasjonsfiler for Atlas: https://git.vegvesen.no/projects/NVDBDATA/repos/atlas-config/browse/nvdbapis/systemtest",NVDB-6937,Skriv-API,
Linjeobjekt med to like punkter slipper inn,"h2. Observasjon

SOSI-fil vedlagt er et objekt som er hentet fra et reellt sett med objekter i en SOSI.

DF fjerner et punkt som duplikat, og tar inn objektet. Men det som da står igjen av objektet er to helt like punkter i geometrien. Lagret geometri:
{noformat}
{""type"":""LINE"",""representationPoint"":null,""shape"":{""@class"":""no.svv.nvdb.datafangst.domainmodel.geometry.shapes.LineString"",""positions"":[{""northing"":6759744.286657475,""easting"":310719.2902437562,""height"":204.966},{""northing"":6759744.286657475,""easting"":310719.2902437562,""height"":204.966}]},""srid"":25833,""heightRef"":""NN2000"",""properties"":{""map"":{}},""length"":0.0020000765930742255,""operation"":""WRITE""}
{noformat}
Dette objektet skulle blitt avvist ved import pga gurba-data. Tas det inn blir det avvist av Skriv sin stedfesting med _GEOMETRI_MED_FOR_TETTE_PUNKTER_.

[https://datafangst-test.kantega.no/#!/contract/536b5cad-4461-46eb-bb83-e465cc47ea21/files]

 ",NVDB-6937,Datafangst,
Feilmld om at datter ikke flytter hjem når hun gjør det,"h2. Observasjon

Importer følgende url-er som Korriger

[[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]]

[[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]]

Gå til stedfesting. Stedfesting er som ""stedfesting_før.png"". Bruk Skriv og manuelt stedfest Skjerm 101895592 og Avstandsmåling 377099404 til nærmeste vei. Da popper det opp flere røde feilmld + en gul infoboks om at datter ikke kan flyttes inn under mor. Skriv gir forøvrig svar på begge objektene. Loggen sier
{noformat}
2020-10-08T07:35:33.993 INFO  [http-nio-127.0.0.1-8080-exec-44] [exttxm] [0ec22eaa-2f80-4d0c-820f-1d8197f97604] n.s.n.d.a.ParentChildLocationalTrimmer Ensuring child features are inside parent features 
2020-10-08T07:35:34.007 INFO  [http-nio-127.0.0.1-8080-exec-45] [exttxm] [0ec22eaa-2f80-4d0c-820f-1d8197f97604] n.s.n.d.a.ParentChildLocationalTrimmer Ensuring child features are inside parent features 
2020-10-08T07:35:34.008 ERROR [http-nio-127.0.0.1-8080-exec-45] [exttxm] [0ec22eaa-2f80-4d0c-820f-1d8197f97604] n.s.n.datafangst.rest.ContractResource Unable to locate feature with unifiedId 377099404:0 
2020-10-08T07:35:34.008 INFO  [http-nio-127.0.0.1-8080-exec-45] [exttxm] [0ec22eaa-2f80-4d0c-820f-1d8197f97604] n.s.n.datafangst.rest.ContractResource Unable to move locationals inside parent
{noformat}
Imidlertid ser stedfesting etterpå ut som ""stedfesting_etter.png"" (også etter reload).

Hvorfor alle feilmld når det tilsynelatende ser ut som om de har fått ny stedfesting OG blitt flyttet under mor? For svaret fra Skriv er ikke eksakt likt for de to.

h2. Analyse
Etter en runde med debugging viser det seg at feilen er at metoden som skal hente kobling til foreldre gitt et barn ikke virker som den skal når barn har en NBDB-ID. Da får vi *alle* koblinger til gitt NVDB-ID som barn, uavhengig av kontrakt. Går bra for noen tilfeller / bruk, men hvis NVDB-ID er brukt i flere koblinger (igjen, uavhengig av kontrakt) så er det tilfeldig hvilken vi får.

h2. Løsning
Fikse FeatureDao.getParentAssociations til å ta hensyn til kontrakt når det spørres etter kobling til parent.",NVDB-6937,Datafangst,
Ruteberegner: Graf tolererer ikke loops,"Observasjon fra [~tormos]:
{code:java}
{
""geometri"":""LINESTRING (10478.2 6507631.35, 10467.8 6507606.99, 10456.23 6507588)"",
""maks_avstand"":""300"",
""konnekteringslenker"":false,
""detaljerte_lenker"":false,
""vegsystemreferanse"":""EV39"",
""trafikantgruppe"":null,
""typeveg"":""enkelBilveg"",
""tidspunkt_start"":""2020-10-07"",
""tidspunkt_slutt"":null,
""pretty"":false,
""kortform"":false
}
{code}
gir ikke rute, feilmelding for punkt-til-punkt er IKKE_FUNNET_SEGMENTER_I_UTSNITT.

Rute fra datafangst:

!Screenshot_datafangst.png|thumbnail!",NVDB-6937,Les-API,
Stadfesting med objekt som svingar tilbake vert feil,"h1. Obesrvasjon

Når rekkverk som svingar tilbake der det kom frå skal stadfestast treff ikkje rekkverket og rekkversende på samme punkt.
h2. Default stadfesting:

!screencapture-datafangst-test-kantega-no-2020-10-07-12_14_09.png|thumbnail!
h2. Stadfesting med skriv:

!screencapture-datafangst-test-kantega-no-2020-10-07-12_14_54.png|thumbnail!",NVDB-6937,Datafangst,
Betre informasjon ved avvist pga. ikkje siste versjon,"h1. Melding frå brukar

Ved overføring til nvdb, kan slike feil forekomme:

80239720: Versjon oppgitt for lukking er allerede lukket 2020-06-03
80239721: Versjon oppgitt for lukking er ikke siste versjon. Siste versjon er 4

Her foreslår jeg å skrive «Vegobjektet oppgitt …» i stedet for versjon på den første linjen, da det er objektet som sådan som er lukket.

Dette vil også skille bedre mellom de to feil-typene, og man ser raskere hva som må gjøres for å korrigere feilen.
{quote}Innmeldar: Lund Øystein Bjøndal <Oystein.bjondal.lund@vegvesen.no>
{quote}
h2. Forslag til løysing

… eller bare legge til aktuelt versjonsnr. i begge tilfellene, f.eks.:

80239720v2: …     -- tipper at versj.nr. er angitt i endringssettet
80239721v3: …     -- nyttig å få repetert versj.nr.et, tenker jeg.

Jeg vet ikke hva som vil være best.
{quote}Hilsen NVDB-forvaltningen, Hans Anton
{quote}
h3. Tilleggskommentar

Jo mer informasjon som vises, jo bedre, som oftest.

Poenget i dette tilfellet må være å gi en indikasjon på hvordan feilen skal fikses. Ved å si at vegobjektet som sådan er lukket, forstår man at det må slettes fra kontrakten, da man ikke skal lukke objektet en gang til (uavhengig av versjoner)

Prøver man imidlertid å lukke en versjon for lavt, betyr bare det at noen andre har lukket i mellomtiden, og da må man (slette objektet i datafangst for deretter å) hente ned siste versjon for lukking. 

(Alternativet må jo være at datafangst selv avviser det første, og selv lukker riktig versjon for det siste eksempelet (men det koster sikkert litt mer utviklingstid enn bare å endre i hva som skrives til feil loggen)",NVDB-6937,Datafangst,
Legge til vegobjekttype i feilmelding,"h1. Melding frå brukar

Vegobjektene ble avvist fordi det ble funnet feil under validering
141841407: Versjon oppgitt for lukking er allerede lukket 2020-09-24

Her bør det i tillegg legges ut hvilken vegobjekt type dette gjelder, så sparer vi tid når vi skal finne feilen!
{quote}Innmeldt av: Lund Øystein Bjøndal <Oystein.bjondal.lund@vegvesen.no>
{quote}",NVDB-6937,Datafangst,
Oppdater lenke til SINTEF datakatalog,"h2. Observasjon

Lenke til SINTEF datakatalog (ex type 5) er nå: [http://tfprod1.sintef.no:8080/datakatalog/eksport/produktspesifikasjon/5.htm]

Men den korrekte er: [https://www.vegvesen.no/nvdb/datakatalog/eksport/produktspesifikasjon/5.htm] (redirect via SVV)

 ",NVDB-6937,Datafangst,
Ruteberegning: Parameter for å unngå rute på tvers av Trafikantgrupper,"h2. Opprinnelig observasjon

Automatisk stedfesting med Skriv av vedlagte SOSI (mot UTV) gir tilbake 4 rutesegmenter hvor en av disse er på typeVeg _Gang- og sykkelveg,_ mens de tre andre er på typeVeg _enkelBilveg_. Dette er typeVeg-er som går på tvers av trafikantgruppe. 

Merk at ATM ikke gir ulike typeVeg-er da datagrunnlaget nok er forskjellig.

Kall mot Skriv:

POST [https://pm1.utv.vegvesen.no/nvdb/apiskrivbeta/rest/v3/stedfest?maksimumAvstandTilVeg=300]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""62"" tempId=""f19e76fb-e32d-4d7e-99a0-0956a14977a2""><egenskaper><egenskap typeId=""4765""><geometri><srid>25833</srid><wkt>LINESTRING (-21252.169081652944 6643074.797794869 7.26, -21255.52226438414 6643073.36029179 7.19, -21260.87664281932 6643071.067369547 6.93, -21264.54671549675 6643069.578097077 6.8100000000000005, -21269.259146525234 6643067.478605227 6.57, -21275.200999789988 6643065.14842999 6.12, -21277.961267874634 6643063.918883092 5.71, -21282.465775004996 6643062.001907458 5.37, -21287.05290469533 6643059.951452257 5.12, -21289.08860274579 6643059.048815356 6.44, -21297.744401590666 6643055.112274033 4.5, -21301.558831787785 6643053.253438639 4.49, -21305.208920193487 6643051.540798004 4.34, -21311.322363643092 6643048.652194137 4.29, -21316.38436367351 6643046.252138065 4.23, -21321.598004274012 6643043.956495468 4.11, -21325.074670816422 6643042.379153579 4.03, -21329.513801066263 6643040.405883191 4.09, -21332.253181890992 6643039.073732074 4.04, -21334.257101296214 6643038.18834785 3.87, -21336.576998423378 6643037.150406309 3.73, -21338.05247322988 6643036.539260265 3.63, -21338.5028380141 6643036.459337355 3.1, -21340.31154388131 6643035.727413284 2.32, -21341.456515074184 6643035.317857134 2.27, -21342.92381240864 6643034.575051343 2.2600000000000002, -21343.06091759837 6643034.506945568 2.2600000000000002)</wkt><datafangstdato>2019-10-31</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>96</målemetode><målemetodeHøyde>96</målemetodeHøyde><nøyaktighet>5</nøyaktighet><nøyaktighetHøyde>5</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-10-05</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
Som videre spør Les:

POST [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""geometri"":""LINESTRING (-21252.17 6643074.8, -21255.52 6643073.36, -21260.88 6643071.07, -21264.55 6643069.58, -21269.26 6643067.48, -21275.2 6643065.15, -21277.96 6643063.92, -21282.47 6643062, -21287.05 6643059.95, -21289.09 6643059.05, -21297.74 6643055.11, -21301.56 6643053.25, -21305.21 6643051.54, -21311.32 6643048.65, -21316.38 6643046.25, -21321.6 6643043.96, -21325.07 6643042.38, -21329.51 6643040.41, -21332.25 6643039.07, -21334.26 6643038.19, -21336.58 6643037.15, -21338.05 6643036.54, -21338.5 6643036.46, -21340.31 6643035.73, -21341.46 6643035.32, -21342.92 6643034.58, -21343.06 6643034.51)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""E,F,K,R"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-16"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
Oppdatert body etter optimaliseringer i Skriv:
{noformat}
{""geometri"":""LINESTRING (-21252.17 6643074.8, -21343.06 6643034.51)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""F,E,R,K"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-10-05"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
h2. Etter diskusjoner

Ruteberegning i Les skal legge opp til å kunne være mer enn en tjeneste for API Skriv sin stedfesting. Derfor vil det kunne forekomme at en rute går på tvers av trafikantgruppe. Men siden API Skriv er per nå den viktigste klienten, og denne trenger en rute som ikke går på tvers, så vil det innføres en ekstra parameter som Skriv kan sette i kallene mot /rute for å tvinge /rute til å oppgi en rute som *ikke* går på tvers av trafikantgruppe.

h3. Løsning
Ny paramter ""behold_trafikantgruppe"" som gjør at ruten som blir returnert ikke hopper mellom de 2 trafikantgruppene K og G. Trafikantgruppe velges fra start- og sluttpunkt til ruten. Om begge er like velges den aktuelle, om de er ulike foretrekkes kjørende. Implementert for oppslag på geometri, punkt og posisjon.
Man kan fortsatt tvinge gjennom en trafikantgruppe ved å sette det eksplisitt i requesten.
Nvdb-visrute er oppdatert med valg for den nye parameteren.
",NVDB-6937,Les-API,
stedfesting for barnløse morløse oppdateres ikke i GUI,"h2. Observasjon

Last inn vedlagte SOSI. Stedfest manuelt med Skriv (auto finner ikke rute). Det går kall tilbake til Skriv som gir resultater. Det samme med det interne kallet /rest/vegobjekt/<contractid>/stedfesting som gir 200 og success: true. Men selve objektet blir liggende rødt i GUI.

Reload av stedfestingsfanen viser at objektet er blitt stedfestet og er nå markert grønt.
h2. Analyse

feilen oppstår for barnløse, morløse objekter. Det er en feil i opptelling som ikke teller med objektet som stedfestes.
h2. Løsning

Teller opp alle berørte objekter.

Fikser også en corner case som gjør at stedfestingsgeometri fra locationalService ble returnert for hovedobjektet, som fører til feil visning når localizationService går på en error eller ikke finner noe hvis objektet er for langt unna valgt veg.",NVDB-6937,Datafangst,
Fjern kode for gammel stedfesting,"Kan være lurt å fjerne gammel stedfesting før vi gjør endringer som å skru på stedfesting med Skriv som default (NVDB-5706), for å slippe å vedlikeholde ting to steder.

Logg sier at gammel stedfesting er togglet 5 ganger siste 90 dager, og det er ikke usannsynlig at alle disse var oss under testing.",NVDB-6937,Datafangst,
Får ikke manuelt stedfestet med Skriv pga feil fase,"h2. Observasjon

Testet i df-test/ATM.

Vedlagte SOSI lar seg ikke stedfeste automatisk med Skriv:

POST /nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""852"" tempId=""596fbda2-61df-4388-adcb-94662b0acb68""><egenskaper><egenskap typeId=""9721""><geometri><srid>25833</srid><wkt>LINESTRING (136985.0714155052 6500454.363244808 40.394, 136975.1664273205 6500454.605032915 40.15)</wkt><datafangstdato>2019-06-11</datafangstdato><referansegeometri>false</referansegeometri><kvalitet><målemetode>96</målemetode><målemetodeHøyde>96</målemetodeHøyde><nøyaktighet>5</nøyaktighet><nøyaktighetHøyde>5</nøyaktighetHøyde><synbarhet>0</synbarhet></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-10-02</startdato></gyldighetsperiode></vegobjekt></vegobjekter>{noformat}
Den lar seg heller ikke stedfeste manuelt ved å markere veien:

POST /rest/v3/stedfest?maksimumAvstandTilVeg=300&vegnummer=18&vegkategori=E&typeVeg=ENKEL_BILVEG%2CKANALISERT_VEG&fase=A

med samme body

Derimot vil man få treff på POST /rest/v3/stedfest?maksimumAvstandTilVeg=300&vegnummer=18&vegkategori=E&typeVeg=ENKEL_BILVEG%2CKANALISERT_VEG&fase=V (merk faseendringen)

Ifølge Vegkart ligger det ingen EA her:

[https://vegkart.test.atlas.vegvesen.no/#kartlag:topo4/@137025,6500426,17/vegnett:~'geometri+~()/valgt:22151:111:12]
h2. Spørsmål

Hvor er det fase=A kommer fra?",NVDB-6937,Datafangst,
Ruteberegning: Beregn lengste delrute i geometri-spørring,Vi får i dag for punkt-til-punkt beregnet den lengste sammenhengende ruten via en fallback-graf dersom en historisk rute ikke kan beregnes på normal måte. Denne pluss en statusmelding blir returnert. Oppgaven består i å utvide dette til også å gjelde geometri-spørringer.,NVDB-6937,Les-API,
NullPointerException ved sletting fra kontrakt,"h2. Observasjon
Jeg finner en del tilfeller i logg av NPE i forbindelse med sletting av vegobjekt fra kontrakt. Ser ut som dette skjer når vi skal sjekke om fil er tom, sånn at kommentarer på fil også skal slettes.

h2. Analyse
Koden her er litt uheldig siden den starter en ny transaksjon inne i transaksjonen som sletter, tror det går an å være litt smartere her med hvordan data hentes og forhåpentligvis unngå dette. Ser også at inne i dette API-kallet så får vi ofte (alltid?) en database-exception med transaksjonsproblemer.

Eksempel fra logg: https://vegdata.kantega.no/kibana/goto/051df23b9edb429683346215ac7af702

Stacktrace:
{noformat}
java.lang.NullPointerException: null
	at no.svv.nvdb.datafangst.domainmodel.feature.FeatureList.get(FeatureList.java:78)
	at no.svv.nvdb.datafangst.orm.FeatureStorageImpl.purgeEmptyFile(FeatureStorageImpl.java:552)
	at no.svv.nvdb.datafangst.orm.FeatureStorageImpl.lambda$deleteFeature$57(FeatureStorageImpl.java:547)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:85)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.transactional(Jdbc.java:107)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.transactional(Jdbc.java:84)
	at no.svv.nvdb.datafangst.database.DatabaseImpl.transactional(DatabaseImpl.java:103)
	at no.svv.nvdb.datafangst.orm.FeatureStorageImpl.deleteFeature(FeatureStorageImpl.java:543)
	at no.svv.nvdb.datafangst.contract.ContractManagerImpl.deleteFeature(ContractManagerImpl.java:1231)
	at no.svv.nvdb.datafangst.rest.ContractResource.deleteFeature(ContractResource.java:1692)
{noformat}

h2. Løsning
Jeg klarer ikke å reprodusere denne lokalt, mistenker at det har noe med timing å gjøre siden sletting av flere objekter går som separate slettekall. 
Uansett er det uheldig at vi gjør kall som kan opprette nye transaksjoner inne i en aktiv transaksjon, så har skrevet om databasekall til å bruke eksisterende connection.",NVDB-6937,Datafangst,
"Sentry: NPX i toolsMenu, datafanen","Sentry rapporterer 146 tilfeller / 2 uker .

[https://sentry.kantega.org/kantega/datafangst/issues/32/]

det gjøres en sjekk på datakatalog-versjon før datakatalogen er hentet

skriv som selectoren til å håndtere null
{code:java}
TypeError: Cannot read property 'dataCatalogVersions' of nullarguments[{""message"":""Cannot read property 'dataCatalogVersions' of null"",""name"":""TypeError"",""stack"":""TypeError: Cannot read property 'dataCatalogVersions' of null\n    at Object.t.nvdbDatacatalogVersion (https://datafangst.kantega.no/assets/dataforvalter/app.js?c29ceabde26b574f1f5d:1:44487)\n    at Function.mapToProps (https://datafangst.kantega.no/assets/dataforvalter/app.js?c29ceabde26b574f1f5d:1:331100)\n    at i (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:149253)\n    at Function.i.mapToProps (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:149371)\n    at i (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:149235)\n    at https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:150594\n    at https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:147615\n    at Object.useMemo (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:56550)\n    at useMemo (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:101:5425)\n    at p (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:26:147559)\n    at Hr (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:53011)\n    at wo (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:59808)\n    at _o (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:59627)\n    at bo (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:59346)\n    at ko (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:68934)\n    at Ba (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:90411)\n    at ja (https://datafangst.kantega.no/assets/dataforvalter/vendors~app.js?c29ceabde26b574f1f5d:109:90795)\n    at Es (https...""}]
{code}
 
h2. Løsning
Det artige her er jo at verdien ikke var i bruk! Så sletta selector og verdi fra state.",NVDB-6937,Datafangst,
NullPointerException ved import av vegobjekter,"Jeg ser noen tilfeller av NullPointerException ved import av vegobjekter i loggen. Ut i fra stacktrace og kode ser det ut som det kan være for enkelte objekter som ikke har egengeometri.

Ett eksempel fra logg: https://vegdata.kantega.no/kibana/goto/c01b7390ba00d85182992f1bc037f048

Ser ut som URL som importeres er denne: https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/9?segmentering=true&kommune=5401&inkluder=lokasjon%2Cgeometri%2Cegenskaper%2Cmetadata%2Crelasjoner

Stacktrace:
{noformat}
java.lang.NullPointerException: null
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.NvdbReadApiTransform.toFeature(NvdbReadApiTransform.java:138)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.NvdbReadApiTransform.lambda$toFeatures$1(NvdbReadApiTransform.java:104)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1384)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
	at no.svv.nvdb.datafangst.integration.nvdbapi.transform.NvdbReadApiTransform.toFeatures(NvdbReadApiTransform.java:104)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbReadApiGateway.lambda$getFeaturesFromPagedResponse$10(DefaultNvdbReadApiGateway.java:468)
	at no.svv.nvdb.datafangst.integration.ClientInvoker.invokeWithLocalContextClassLoader(ClientInvoker.java:22)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbReadApiGateway.getFeaturesFromPagedResponse(DefaultNvdbReadApiGateway.java:452)
	at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbReadApiGateway.getFeaturesFromUri(DefaultNvdbReadApiGateway.java:319)
	at no.svv.nvdb.datafangst.contract.ContractManagerImpl.importNvdbFeatures(ContractManagerImpl.java:981)
	at no.svv.nvdb.datafangst.rest.ContractResource.addExistingFeatures(ContractResource.java:1836)
{noformat}
",NVDB-6937,Datafangst,
NullPointerException ved parsing av veg og stedfesting med Skriv,"Finner noen tilfeller av NPE med stedfesting med Skriv der det feiler når vi skal parse veg i request. Kode antar av veg er med, med stedfesting uten veg er også gyldig. Det må sjekkes om veg er satt før vi prøver å konvertere.

Ett eksempel: https://vegdata.kantega.no/kibana/goto/9b62db06e806c1dc3f19c0c16f70b0cd

Steg for å reprodusere:
# Gå til Admin-side (skiftnøkkel) og skru på ""Stedfesting med Skriv""
# Gå til stedfesting og velg et vegobjekt
# Trykk på ""Stedfest vegobjekt"" uten å velge veg

",NVDB-6937,Datafangst,
NullPointerException når bruker som ikke har satt passord forsøker innlogging,"Jeg ser en del tilfeller av NullPointerException i loggen i forbindelse med innlogging. Ser ut som vi får dette når noen som har fått opprettet e-postbruker prøver å logge inn før hen har satt passord. Vi prøver da å parse et passord-objekt som er null, og det går jo dårlig. Gjør en sjekk på om passord finnes, og logg en passende melding hvis det ikke gjør det.

Eksempel fra logg: https://vegdata.kantega.no/kibana/goto/dcc69ce318369e3089f2a1f02c8ecba0

Stacktrace:
{noformat}
java.lang.NullPointerException: null
	at com.fasterxml.jackson.core.JsonFactory.createParser(JsonFactory.java:889)
	at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3005)
	at no.svv.nvdb.datafangst.security.database.hashing.HashJsonEncoder.decode(HashJsonEncoder.java:22)
	at no.svv.nvdb.datafangst.security.database.DatabasePasswordManager.checkPassword(DatabasePasswordManager.java:55)
	at no.svv.nvdb.datafangst.security.database.DatabasePasswordManager.passwordCheck(DatabasePasswordManager.java:32)
	at no.svv.nvdb.datafangst.security.SecurityServiceImpl.login(SecurityServiceImpl.java:92)
	at no.svv.nvdb.datafangst.rest.SessionResource.login(SessionResource.java:52)
{noformat}
",NVDB-6937,Datafangst,
LocationalTrimmer bruker feilaktig NVDB-id når den tolker assosiasjoner,"h2. Observasjon

Loggen viser en del NPE i ParentChildLocationTrimmer. Ett eksempel (med kontekst): [https://vegdata.kantega.no/kibana/goto/6dca3f1529ace0a43e15d0b3d3bd31df]

Stacktrace:
{noformat}
java.lang.NullPointerException: null
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.ensureParentCoversChildren(ParentChildLocationalTrimmer.java:182)
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.lambda$ensureParentsCoverChildren$2(ParentChildLocationalTrimmer.java:121)
	at java.util.LinkedHashMap.forEach(LinkedHashMap.java:684)
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.ensureParentsCoverChildren(ParentChildLocationalTrimmer.java:117)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.ensureInsideParent(AssociationServiceImpl.java:310)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.ensureInsideParent(AssociationServiceImpl.java:300)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.associateWithinContract(AssociationServiceImpl.java:211)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.associateByProximity(AssociationServiceImpl.java:156)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.associateByGeometricProximity(AssociationServiceImpl.java:66)
	at no.svv.nvdb.datafangst.rest.ContractResource.createAssociations(ContractResource.java:923)
{noformat}
Annen variant av stacktrace:
{noformat}
java.lang.NullPointerException: null
	at java.util.stream.MatchOps$1MatchSink.accept(MatchOps.java:90)
	at java.util.ArrayList$ArrayListSpliterator.tryAdvance(ArrayList.java:1361)
	at java.util.stream.ReferencePipeline.forEachWithCancel(ReferencePipeline.java:126)
	at java.util.stream.AbstractPipeline.copyIntoWithCancel(AbstractPipeline.java:499)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:486)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.MatchOps$MatchOp.evaluateSequential(MatchOps.java:230)
	at java.util.stream.MatchOps$MatchOp.evaluateSequential(MatchOps.java:196)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.allMatch(ReferencePipeline.java:521)
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.ensureParentCoversChildren(ParentChildLocationalTrimmer.java:182)
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.lambda$ensureParentsCoverChildren$2(ParentChildLocationalTrimmer.java:121)
	at java.util.LinkedHashMap.forEach(LinkedHashMap.java:684)
	at no.svv.nvdb.datafangst.association.ParentChildLocationalTrimmer.ensureParentsCoverChildren(ParentChildLocationalTrimmer.java:117)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.ensureInsideParent(AssociationServiceImpl.java:304)
	at no.svv.nvdb.datafangst.association.AssociationServiceImpl.createAssociation(AssociationServiceImpl.java:118)
	at no.svv.nvdb.datafangst.rest.ContractResource.createAssociationManually(ContractResource.java:1018)
{noformat}
h2. Analyse

se
 [https://vegdata.kantega.no/kibana/app/kibana#/context/datafangst-logs-*/doc/90Yk5HQBAp1uBLZqqwBW?_a=(columns:!(_source),filters:!(),predecessorCount:5,sort:!('@timestamp',desc),successorCount:5)&_g=(refreshInterval:(pause:!t,value:0),time:(from:now%2FM,mode:quick,to:now%2FM))]

Såvidt jeg skjønner så handler begge disse om at vi ikke har filtrert bort null-objekter når vi setter sammen listene. Kontrakten det refereres til over logger denne feilen når det prøves å gjøre en automatisk sammenkobling internt mellom Skjæring og Bergsikring, men denne sammekoblingen ser ut til å gå helt fint nå. Kontrakten ligger i dev-miljøet. 

I det øverste tilfellet virker det innlysende at det er parent som er null. i det andre virker det plausibelt at det er en av children som er null. Det gjøres ikke noen filter på null eller isPresent i de underliggende kallene.

Siden jeg ikke klarer å gjenskape denne feilen i praksis, så blir det litt spekulasjon. Ut i fra logikken vil denne feilen oppstå hvis vi har vegobjekter som har både nvdbId og df-id, og vi gjør en autoassosiasjon internt i prosjektet. Autoassosiasjonen gir oss en liste med assosiasjoner mellom DF-id,er men det er påfølgende logikk som reduserer vegobjektId-en til enten NVDB-id eller DF-id, og NVDB-id får prioritet. vegobjekter  mappes om til Hashmap mellom NVDB-id og vegobjekt, og når det da itereres over assosiasjoner og vi setter sammen lister med parent- og child-vegojekter, refererer assosiasjonene til DF-IDer som resulterer i bom i oppslaget i hashmappen, og vi sender null-objekter til LocationalTrimmeren.

Og der fikk jeg til å gjenskape feilen også!

Feilen oppstår som beskrevet over, fremsgangsmåte beskrevet i test-beskrivelsen.

Feilen oppstår når foreldre lagres til Skriv før foreldrene får assosiasjon til barna. Da vil foreldrene få både NVDB-ID og DF-ID, og situasjonen som er beskrevet over oppstår. Situasjonen vil ikke oppstå hvis man også lagrer barna til NVDB før sammenkobling, fordi det ligger logikk i sammenkobling som forbyr sammenkobling til barn med NVDB-ID

 Dette er feil i logikken som antakelig henger igjen fra gamle dager da vi ikke tillot endringer på NVDB-objekter.

Variant 2 vil på samme måte kunne oppstår når barn er lagret før parent ved en manuell sammenkobling (her gjøres ingen sjekk på på om barn har NVDB-ID)
h2. Løsning

Logikken som mapper om assosiasjoner til ID-er må tas bort, og istedet må foreldre og barn hentes ut basert på id-ene i assosiasjonene.

Helst bør hele assosiasjons-biten  egentlig overhales.
 Dette henger sammen med importerte objekter og deres assosiasjoner, muligheten til å assosiere imorterte barn, sletting av eksisterende assosiasjoner og muligheten til å lagre vegobjekter flere ganger på en dag. 

Fjernet kall til Associaion.getUnifiedId() som alltid returnerte NVDB-id hvis den fantes.

Endret logikken som itererte over assocs og laget maps mellom parent og children til å bruke genereation objekter. det gjør koden mer lesbar og mer gjenbrukbar.

Det er en antakelse her om at en assosciation alltid har kun en parent og en child, enten i DF eller i NVDB. jeg ser ingenting som tyder på at det ikke alltid stemmer. 

 

 

 ",NVDB-6937,Datafangst,
Kontraktsområder og riksvegruter med mange stedfestinger,"API-et takler ikke kontraktsområder med veldig mange objekter. En rask løsning på dette problemet ble å fikse dette i databasen ved å slå sammen disse objektene (NVDB-5869).

Vi bør også løse dette i API-et for eventuelle nye tilfeller.

Forslag til løsning (fra NVDB-5869):
 * Vi lagrer kontraktsnavn i tillegg til id for segmenter. Da kan vi bruke navn ved søk, og fortsatt liste ut med id som nå.
 * /omrader/kontraktsomrader må forbedres litt for å støtte at det finnes flere objekter med samme navn. Enten et felt med alle id'ene eller et felt med en liste med urler til alle objektene(/vegobjekter/580/123/1).
 * Vi gjør det samme for riksvegruter.",NVDB-6937,Les-API,
Sortere kontrakter stigande først,"h1. Observasjon

Veg klikk på kolonneheader for å sortere kontraker etter ønske vert dei sortert etter den kolonna i synkande rekkefølge (Å–>A). Ved neste klikk vert dei sortert stigande.
h1. Ønske

Stigande sortering er default ved første klikk.",NVDB-6937,Datafangst,
Linje fra stedfesting er på tur,"h2. Observasjon

Se vedlagt bilde av Skjerm i kontrakt: [https://datafangst-test.kantega.no/#!/contract/7102bbbb-7835-413f-81e0-6cf234a7dc29/locational2]

Her går linjen fra stedfestingspunkt til vegen og ikke til objektet.
h2. Analyse

Feilen kan gjenskapes ved å forøke å importere linjeobjekter fra API:

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Alle stedfestede objekter må ha en projection WKT. projection er ikke noe som ligger lagret i NVDB, men er noe Datafangst bruker for å visualisere hvor en stedfesting ligger i forhold til objektet som er stedfestet, i stedfestingsfanen vises projection som strekene som går fra objektets ender og til veien de er stedfesteet.

Ved import fra API genereres det ikke noen projection WKT, men projection WKT settes istedet til å være det samme som stedfestings-WKTen. Dermed tegnes linjene men de blir helt feil. i dette eksempelet slår det ut slik at projection tegnes som en linje fra starten av stedfestingen til slutten.
h2. Løsning 

Iterere over de importerte vegobjektene og generere projection 

 ",NVDB-6937,Datafangst,
Unngå låsekonflikt mot vegnett,"h2. Bakgrunn

Vi ønsker å fjerne sekundærlås mot vegsystem ved reine fagdatainnsjekk for å unngå låsekonflikt der vegnett gjer ""større"" oppdateringar. Det vil gi ein stor gevist for betre flyt under objektoppdatering og ha ein minimal risikoauke for feil. 

Ref: e-postsak med Tore, Hans Anton og Vilhelm m.fl.

 
{quote}*Fra:* Tore Eide Andersen <[Tore.Eide.Andersen@kantega.no|mailto:Tore.Eide.Andersen@kantega.no]> 
 *Sendt:* mandag 14. september 2020 13:54
 *Til:* Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]>
 *Kopi:* Jensen Jan Kristian <[jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]>; Støeng Linda Therese <[linda.stoeng@vegvesen.no|mailto:linda.stoeng@vegvesen.no]>; Gjendem Torbjørn <[torbjorn.gjendem@vegvesen.no|mailto:torbjorn.gjendem@vegvesen.no]>; Børnes Vilhelm <[vilhelm.bornes@vegvesen.no|mailto:vilhelm.bornes@vegvesen.no]>; Ekker Hans Jørgen <[hans.jorgen.ekker@vegvesen.no|mailto:hans.jorgen.ekker@vegvesen.no]>; Rønningen Kjetil <[kjetil.ronningen@vegvesen.no|mailto:kjetil.ronningen@vegvesen.no]>; Rødal Liv Helen <[liv.rodal@vegvesen.no|mailto:liv.rodal@vegvesen.no]>; Mauseth Jørn <[jorn.mauseth@vegvesen.no|mailto:jorn.mauseth@vegvesen.no]>
 *Emne:* Re: Låsekonflikter i SKRIV
 

Hei, 

Låsing av de objekttypene som skal registreres skjer “midtveis” i behandlingen, etter at all beriking og innlesing fra NVDB er ferdig. De låses altså samtidig med de sekundærlåsene vi snakker om her.

Det er ingen andre konsekvenser enn potensiell “feil” autorisasjon av endringssettet, dersom Vegsystem ikke sekundærlåses. Men som nevnt tidligere, sannsynligheten er liten. Fagdatainnsjekk tar sjelden mer enn et par sekunder. Når både sannsynlighet og konsekvens er liten, blir også risikoen minimal.

Hans Anton skriver “Slik jeg oppfatter det, vil fjerning av denne sekundærlåsen medføre at vi validerer mot vegnettet slik det faktisk er når fagdatainnsjekekt skjer, og ikke slik det vil bli når evt. pågående vegnettsinnsjekk er ferdig.”

I et ekstremt tilfelle kan et vegnettsinnsjekk være fullført 1 millisekund etter at Vegsystem-objektene er lest inn under behandling av vårt endringssett. Halvparten av behandlingen gjenstår og vil da validere og autorisere mot et annet vegnett enn det som finnes i NVDB. Men, dette er hvis, såfremt, i fall. Og som sagt er det ingen risiko for datakvaliteten. Faren for vranglås er minimal, mener jeg. Denne mekanismen for låsing under behandling (optimistisk låsing) er har vært i drift siden 2014, uten problemer.

Å droppe sekundærlåsing av Vegsystem for rene fagdatainnsjekk er en enkel sak. Jeg estimerer en halv dags jobb, inkludert testing.

Tore
 

On 14 Sep 2020, at 10:01, Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]> wrote:


Takk, Tore, for tydelig og konkret oppklaring!

Jeg mener vi kan leve godt med å fjerne denne ekstra låseprosessen i forbindelse med validering av fagdataredigeringsinnsjekk. Fordelen er åpenbar – færre låsekonflikter og dermed enklere og raskere lagring av data til NVDB.

Slik jeg oppfatter det, vil fjerning av denne sekundærlåsen medføre at vi validerer mot vegnettet slik det faktisk er når fagdatainnsjekekt skjer, og ikke slik det vil bli når evt. pågående vegnettsinnsjekk er ferdig.

Jeg antar at vegobjektet som skal sjekkes inn uansett allerede er låst på dette tidspunktet, slik at vi ikke risikerer vranglås med evt. lås i forb. Med følgeoppdatering av pågående vegnettsinnsjekk.

Tore, er min antakelse riktig?  Ser du noen negative konsekvenser ved å fjerne denne sekundærlåsprosessen ved validering av fagdatainnsjekk, i tillegg til det du nevner ang. tilgangskontroll? Hvordan vil du anslå estimat for gjennomføring og testbehov for en slik endring?

Jeg vet ikke hvem som skal bestemme dette, men håper det kan skje raskt.  Fins det noen historikk her, dvs. spor av en diskusjon/beslutning om å benytte nåværende metode?

Uansett, hva mener dere andre?

Hilsen NVDB-forvaltningen,

Hans Anton
 

*Fra:* Tore Eide Andersen <[Tore.Eide.Andersen@kantega.no|mailto:Tore.Eide.Andersen@kantega.no]> 
 *Sendt:* søndag 13. september 2020 20:49
 *Til:* Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]>
 *Kopi:* Jensen Jan Kristian <[jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]>; Støeng Linda Therese <[linda.stoeng@vegvesen.no|mailto:linda.stoeng@vegvesen.no]>; Gjendem Torbjørn <[torbjorn.gjendem@vegvesen.no|mailto:torbjorn.gjendem@vegvesen.no]>; Ekker Hans Jørgen <[hans.jorgen.ekker@vegvesen.no|mailto:hans.jorgen.ekker@vegvesen.no]>; Rønningen Kjetil <[kjetil.ronningen@vegvesen.no|mailto:kjetil.ronningen@vegvesen.no]>
 *Emne:* Re: Låsekonflikter i SKRIV

Hei,

Endringssettet ønsker bl.a. å etablere følgende sekundærtlåser under behandling:

1) \{featureTypes=[{ftid=532, lt=SECONDARY, lr=REFLINK_OR_NETNODE_RELEVANT}], refLinks=[0.0-1.0@1215887, [0.0-1.0@922839|mailto:0.0-1.0@922839], [0.0-1.0@922835|mailto:0.0-1.0@922835]], isLockingNetwork=false}

2) \{featureTypes=[{ftid=915, lt=SECONDARY, lr=REFLINK_OR_NETNODE_RELEVANT}], refLinks=[0.0-1.0@1215934, [0.0-1.0@1215887|mailto:0.0-1.0@1215887], [0.0-1.0@922839|mailto:0.0-1.0@922839], [0.0-1.0@2804983|mailto:0.0-1.0@2804983], [0.0-0.12747561@928126|mailto:0.0-0.12747561@928126], [0.0-1.0@1215731|mailto:0.0-1.0@1215731], [0.0-1.0@1215885|mailto:0.0-1.0@1215885], [0.0-1.0@1215957|mailto:0.0-1.0@1215957], [0.0-1.0@1215972|mailto:0.0-1.0@1215972], [0.0-1.0@2722940|mailto:0.0-1.0@2722940], [0.0-1.0@2722944|mailto:0.0-1.0@2722944], [0.0-1.0@2722945|mailto:0.0-1.0@2722945], [0.0-1.0@922835|mailto:0.0-1.0@922835], [0.0-1.0@922861|mailto:0.0-1.0@922861]], isLockingNetwork=false}

Disse kommer i konflikt med følgende eksisterende lås: [https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/locks?blockingJobId=69313562-efef-4a92-8394-d183a6b6c082]

Hvorfor skal det etableres sekundærlås på Vegreferanse (532) og Vegsystem (915)?

I endringssettet registreres tre nye vegobjekter av type 905. Under behandling hentes de veglenkesekvensene som de tre vegobjektene er stedfestet på fra NVDB. Dette er veglenkesekvensene 922839, 922835 og 1215887. Som en del av valideringen skal det undersøkes om bruker har rettigheter til å registrere vegobjekter på vegnett med gitte vegkategorier. Nettelementene har ikke denne informasjonen, derfor må Vegsystem-objektene som dekker det aktuelle vegnettet leses inn fra NVDB. Vegobjekter som er innlest for å brukes under validering må være uendrede så lenge valideringen pågår. Derfor låses Vegsystem-objektene med en sekundærlås på det vegnettet de stedfestet på. De aktuelle Vegsystem-objektene kan ha stedfesting som går utenfor de tre interessante veglenkesekvensene og vil derfor kunne komme i konflikt med vegnettsredigering i ""nærområdet"".

Årsaken til at Vegreferanse-objekter hentes inn skyldes at det skal valideres at nytt og endret vegnett er dekket av Vegreferanse-objekter (der det er aktuelt). I endringssettet gjøres ingen endring på vegnettet, så innlesingen av 532 kunne vært droppet. At det fortsatt hentes Vegreferanse-objekter for innlest (uendret) vegnett er noe som henger igjen fra den gangen vegkategori ble hentet fra slike vegobjekttyper. Å fikse dette er så enkelt som å slette 4 tegn (READ).

Hva så med Vegsystem, trenger vi egentlig sekudærlås på disse? Om vi dropper det vil fagdatainnsjekk kunne slippe gjennom med endring på vegkategorier som brukeren ikke har tilgang til, men bare dersom det gjøres et vegnettsinnsjekk der vegkategori endres på de aktuelle Vegsystem-objektene i løpet av den normalt svært korte behandlingstiden som fagdatainnsjekk har. Risikoen handler altså om tilgangskontroll og ikke datakvalitet i NVDB. Sannsynligheten for at dette skal skje er rimelig liten, vil jeg tro. Men, dere får vurdere om jeg skal gjøre noe med dette.

Vennlig hilsen

Tore Eide Andersen
 

On 11 Sep 2020, at 14:15, Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]> wrote:


Dette må vi finne ut av. Takk, Jan Kristian, for konkret »case»!

Vedlagte skript-logg viser alle låser i NVDB for litt siden, bl.a. ransko sin lås og hvilke objekttyper som låses.

Og jeg finner ikke 905 blant dem, men derimot div. vegnettsrelaterte objekttyper.

grep '18381709 .* 905' listAllLocksWithTypes.log

gir ingen treff.

Tore, kan du løse mysteriet for oss?

Hilsen Hans Anton – og Linda og Jan Kristian m.fl.
 

*Fra:* Jensen Jan Kristian <[jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]> 
 *Sendt:* fredag 11. september 2020 13:58
 *Til:* Tore Eide Andersen <[Tore.Eide.Andersen@kantega.no|mailto:Tore.Eide.Andersen@kantega.no]>; Støeng Linda Therese <[linda.stoeng@vegvesen.no|mailto:linda.stoeng@vegvesen.no]>
 *Kopi:* Gjendem Torbjørn <[torbjorn.gjendem@vegvesen.no|mailto:torbjorn.gjendem@vegvesen.no]>; Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]>; Ekker Hans Jørgen <[hans.jorgen.ekker@vegvesen.no|mailto:hans.jorgen.ekker@vegvesen.no]>; Rønningen Kjetil <[kjetil.ronningen@vegvesen.no|mailto:kjetil.ronningen@vegvesen.no]>
 *Emne:* RE: Låsekonflikter i SKRIV

Bruksklasse-objektene har ingen relasjoner til noe som helst.

Men dette endringssettet er like fullt blokkert av en vegnettslås: 69313562-efef-4a92-8394-d183a6b6c082
 

*From:* Tore Eide Andersen <[Tore.Eide.Andersen@kantega.no|mailto:Tore.Eide.Andersen@kantega.no]> 
 *Sent:* fredag 11. september 2020 12:50
 *To:* Støeng Linda Therese <[linda.stoeng@vegvesen.no|mailto:linda.stoeng@vegvesen.no]>
 *Cc:* Gjendem Torbjørn <[torbjorn.gjendem@vegvesen.no|mailto:torbjorn.gjendem@vegvesen.no]>; Jensen Jan Kristian <[jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]>; Ålien Hans Anton <[hans.alien@vegvesen.no|mailto:hans.alien@vegvesen.no]>; Ekker Hans Jørgen <[hans.jorgen.ekker@vegvesen.no|mailto:hans.jorgen.ekker@vegvesen.no]>; Rønningen Kjetil <[kjetil.ronningen@vegvesen.no|mailto:kjetil.ronningen@vegvesen.no]>
 *Subject:* Re: Låsekonflikter i SKRIV

Hei, 

Jeg har laget et nytt testcase som først etablerer en vegnettslås på en vehglenkesekvens og inkluderer en vegobjekttype. Deretter prøver jeg å etablere en fagdatalås på samme veglenkesekvens, men for en annen vegobjekttype. Dette går fint, ingen konflikt blir rapportert.

Det er imidlertid en “gotcha” her. Låsedefinisjonen fra klienten blir jo som kjent utvidet med sekunderlåser for alle vegobjekttyper som angitt vegobjekttype har assosiasjon til. Dette kan fort skape konflikter i scenariet over. Hvis f.eks. den andre låsen inneholder en vegobjekttype som er datterobjekt av den vegobjekttypen som ble låst i første lås, vil vi få en konflikt.

Tore
 

On 10 Sep 2020, at 14:00, Støeng Linda Therese <[linda.stoeng@vegvesen.no|mailto:linda.stoeng@vegvesen.no]> wrote:

Hei!

I øyeblikket jobbes det hardt med oppdatering av bruksklasse-objektene i NVDB. De som jobber med disse har lagt opp til en arbeidsprosess som gjør at de bare tar ut det vegnettet de skal oppdatere på, uavhengig av om objektene dekker større område. Konkret betyr dette at de får problemer dersom et objekt er stedfestet på f.eks. både kommunal veg og fylkesveg, eller om et objekt er stedfestet på to forskjellige vegnummer. (Dette er bare litt bakgrunnsinfo, og har ikke noe med selve problemet vårt å gjøre.)

For å lette på denne arbeidsprosessen for denne gjengen, så har Jan Kristian laget et opplegg der han henter ut alle bruksklasseobjekter som er stedfestet på flere vegkategorier eller flere vegnummer. (Og flere trafikantgrupper tror jeg.) Når han da skal sjekke inn endringen til NVDB gjennom Skriv, så får han låsekonflikt dersom noen av disse objektene er stedfestet på lenker som er låst i et vegnettsredigeringsprosjekt. Dette gjelder da selv om vegnettsredigeringsprosjektet ikke har med seg den objekttypen Jan Kristian endrer. 

Dersom det faktisk er sånn skriv fungerer, og er ment å fungere (?), så betyr vel også dette at man ikke får sjekket inn noen endringer på skilt eller dekker eller hva det måtte være i alle områdene vi har et vegnettsprosjekt ute? Sånn kan det i så fall ikke være… I klassisk får man sjekket inn endringer i slike tilfeller.

Mvh Linda
{quote}

h2. Analyse

Som angitt i epostutvekslingen over skal vi droppe sekundærlåsing av innleste Vegsystem-objekter under behandling av rene fagdatainnsjekk.

h2. Løsning

Filtrerer bort vegobjekter av Vegsystem med operasjon READ i JobWorker.lockOptimistically() ved kall til LockService.getLocksNeededForFeatures().
",NVDB-6937,Skriv-API,
Feil i sortering av kategori,"Kategoriar er ikkje alltid rett sortert (alfabetisk/numerisk).

Innmeldt sak av Nikolaj Fyhn
E-postadresse: nikolaj.fyhn@vegvesen.no:
{quote}Utdypning av hva henvendelsen gjelder: 
Når man kategoriser en objekttype i vegkart bør verdiene alltid sorteres i henhold til ""sorteringsnummeret"" fra datakatalogen.

Eksempler på feil:

Funksjonsklasse skal sorteres med A først og E til slutt:
https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@199905,6563117,10/hva:~(~(category~(type~'enum~id~11216)~id~912))/hvor:~(kommune~(~3806))

Fartsgrense skal sorteres med lavest fartsgrense først:
https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@199905,6563117,10/hva:~(~(category~(type~'enum~id~2021)~id~105))/hvor:~(kommune~(~3806))
{quote}",NVDB-6937,Vegkart,
Feilaktig returnert rutesegment gitt tid,"h2. Observasjon

Denne er riktig

[https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute?start=13538.741999999387,6696449.226&slutt=15041.6770000002,6696842.327999998&maks_avstand=10&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&pretty=true&tidspunkt_start=2011-03-20&tidspunkt_slutt=2011-03-24&kortform=false]

Men denne gir samme svar

[https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute?start=13538.741999999387,6696449.226&slutt=15041.6770000002,6696842.327999998&maks_avstand=10&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&pretty=true&tidspunkt_start=2011-03-20&kortform=false]

Her er sluttdato satt åpen, og da bør ikke segment med sluttdato 2011-03-25 vært med.",NVDB-6937,Les-API,
"Systemfeil med ""unable to locate feature"" ved stedfesting","Ser ut som denne dukka opp med 2.4.0, finner i alle fall ikke feilen før det.
Vi feiler når vi skal finne et NVDB-objekt ved koordinering av stedfesting.
Eksempel fra logg: https://vegdata.kantega.no/kibana/goto/d05807b308d71c7a89788a41ed027312",NVDB-6937,Datafangst,
Automatisk stedfesting stedfester FKB-objekter,"Når jeg tar automatisk stedfesting for en vegobjektstype viser det seg at evetuelle FKB-vegobjekter med sakke type i kontrakten også får stedfesting. FKB-objekter har ikke behov for stedfesting, siden dette er spesifikt til NVDB.

Antar at spørring som henter relevante vegobjekter for automatisk stedfesting trenger et ekstra parameter for å kun hente NVDB-objekter.

I tillegg bør vi rydde i databasen og slette alle stedfestinger som er gjort på FKB-objekter. Vi trenger et Flyway-script som kan rydde opp i eksisterende stedfestinger.

For å reprodusere, last opp to vedlagte filer (""FKB46_veg.sos"" som FKB, den andre som NVDB) og kjør automatisk stedfesting.",NVDB-6937,Datafangst,
Tillate bruker å trykke `enter` i stedet for OK,"`enter` bør kunne brukes i stedet for museklikk for:

Kontraktgrupper og brukere -> Ny kontraktgruppe: ""OK""

Kontraktgrupper og brukere -> Brukere: ""Legg til""",NVDB-6937,Datafangst,
NullPointerException ved stedfesting med Skriv,"h2. Observasjon
Finner en del av denne i loggen:
java.lang.NullPointerException: null at no.svv.nvdb.datafangst.integration.nvdbapi.DefaultNvdbWriteApiGateway.toFase(DefaultNvdbWriteApiGateway.java:270)

I det ene tilfellet jeg har kikket nøyere på så skjer dette i forbindelse med redigering av geometri, og formodentlig at objekt automatisk blir stedfestet på nytt ved redigering: https://vegdata.kantega.no/kibana/goto/04e6350d7be3c09bd4b1bd086d0d049e
Har ikke sett på om det er det samme for andre.

h2. Analyse
Alle disse kommer fra automatisk stedfesting når vegkategori og -nummer er satt i kontrakten, men status ikke er satt.

h2. Løsning
Problemet var at vi prøver å mappe en null-verdi fra kontrakten. Testing viser imidlertid at denne ikke kan være tom ved innsending, så skrevet om til å alltid oppgi verdier som beskrevet i analyse.",NVDB-6937,Datafangst,
Feiler med endring av sideposisjon,"h2. Observasjon

(fra support på Datafangst, Raymond).

Et 335-objekt er datter av et 3-objekt. Begge NVDB-objekter. Disse ligger med sideposisjon V i NVDB. I Endringen fra Datafangst er begge endret til H. Men Skriv klager over at datter ikke har samme sideposisjon som mor.

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335/377099404/1]
[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3/101895592/5]
[https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/0e432a08-d641-4381-9f28-bdc36bbd4b7f]

*MERK* at det også er en overlappsfeil i endringen, men den er grei nok.

h2. Analyse

h3. STEDFESTING_UTENFOR_MOROBJEKT (CoveredByParentValidator)

Feilmelding: 377099398:1 DelvisOppdater Objektet har ikke stedfesting som fullstendig dekkes av morobjekt av type Skjerm (3): nvdbId 377099396:1

*Morobjektversjon*

{noformat}
typeId=3,operation=READ,nvdbId=377099396,version=1,validFrom=2013-04-30,validTo=2020-07-22,attributes=[LocationalAttribute{typeId=120003, operation=READ, values=[LocationalValue{typeId=100003, operation=READ, data=521397: 0.70615913<-0.71041502 | RIGHT}]}, AssociationAttribute{typeId=220454, operation=READ, values=[AssociationValue{typeId=200454, operation=READ, data=377099398}]}],procInfo=ProcessingInfo{nvdbAction=NONE, extension=true, extensionOrigin='ReadMissingParentFeaturesEnricherFilter', validationRequired=false, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.70615913<-0.71041502 | RIGHT

I endringssettet: v2 med gyldighet fra 2020-07-22 oppdateres med overskriv til 521397: 0.70615909->0.71041488 | LEFT

*Datterobjektversjon*

{noformat}
typeId=335,operation=MODIFY_IN_PLACE,nvdbId=377099398,version=1,validFrom=2013-04-30,validTo=<null>,attributes=[RealAttribute{typeId=2248, operation=READ, values=[RealValue{typeId=2248, operation=READ, data=5.0}]}, RealAttribute{typeId=7566, operation=READ, values=[RealValue{typeId=7566, operation=READ, data=9.0}]}, LocationalAttribute{typeId=120335, operation=UPDATE, values=[LocationalValue{typeId=100335, operation=IMPLICIT, data=521397: 0.70613329-0.71039652 | LEFT}]}],procInfo=ProcessingInfo{nvdbAction=UPDATE, extension=false, extensionOrigin='null', validationRequired=true, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.70613329-0.71039652 | LEFT

*Konklusjon*

Korrekt feilmelding fordi v1 av morobjektet i NVDB har overlappende gyldighet med datterobjektet, men dekker ikke stedfestingen til den oppdaterte datterobjektversjonen i endringssettet.

h3. STEDFESTING_INNENFOR_MOROBJEKT_MEN_ANNEN_SIDEPOSISJON (CoveredByParentValidator)

Feilmelding: 377099404:1 DelvisOppdater Objektet har stedfesting som fullstendig dekkes av morobjekt av type Skjerm (3), men sideposisjonene er forskjellige: nvdbId 101895592:4

*Morobjektversjon*

{noformat}
typeId=3,operation=READ,nvdbId=101895592,version=4,validFrom=2013-04-30,validTo=2020-07-24,attributes=[LocationalAttribute{typeId=120003, operation=READ, values=[LocationalValue{typeId=100003, operation=READ, data=521397: 0.6900282<-0.69876732 | LEFT}]}, AssociationAttribute{typeId=220454, operation=READ, values=[AssociationValue{typeId=200454, operation=READ, data=377099404}]}],procInfo=ProcessingInfo{nvdbAction=NONE, extension=true, extensionOrigin='ReadMissingParentFeaturesEnricherFilter', validationRequired=false, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.6900282<-0.69876732 | LEFT

I endringssettet: v5 med gyldighet fra 2020-07-24 oppdateres med overskriv til 521397: 0.69002807->0.69876715 | RIGHT

*Datterobjektversjon*

{noformat}
typeId=335,operation=MODIFY_IN_PLACE,nvdbId=377099404,version=1,validFrom=2013-04-30,validTo=<null>,attributes=[RealAttribute{typeId=2248, operation=READ, values=[RealValue{typeId=2248, operation=READ, data=10.0}]}, RealAttribute{typeId=7566, operation=READ, values=[RealValue{typeId=7566, operation=READ, data=10.0}]}, LocationalAttribute{typeId=120335, operation=UPDATE, values=[LocationalValue{typeId=100335, operation=IMPLICIT, data=521397: 0.69002807-0.69876715 | RIGHT}]}],procInfo=ProcessingInfo{nvdbAction=UPDATE, extension=false, extensionOrigin='null', validationRequired=true, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.69002807-0.69876715 | RIGHT

*Konklusjon*

Korrekt feilmelding fordi v4 av morobjektet i NVDB har overlappende gyldighet med den oppdaterte datterobjektversjonen i endringssettet, og dekker datterobjektversjonens stedfesting (med litt toleranse), men har ulik sideposisjon (og typeId 335 krever identisk sideposisjon).

h3. STEDFESTING_DEKKER_IKKE_DATTEROBJEKT (CoversChildValidator)

Feilmelding: 377099396:2 DelvisOppdater Objektet har ikke stedfesting som fullstendig dekker datterobjekt av type Avstandsmåling (335): nvdbId 377099398:1

*Morobjektversjon*

{noformat}
typeId=3,operation=MODIFY_IN_PLACE,nvdbId=377099396,version=2,validFrom=2020-07-22,validTo=<null>,attributes=[AssociationAttribute{typeId=220454, operation=READ, values=[AssociationValue{typeId=200454, operation=READ, data=377099398}]}, RealAttribute{typeId=1352, operation=READ, values=[RealValue{typeId=1352, operation=READ, data=78.0}]}, StringAttribute{typeId=1546, operation=READ, values=[StringValue{typeId=1546, operation=READ, data=Fylkeskommune}]}, StringAttribute{typeId=1549, operation=READ, values=[StringValue{typeId=1549, operation=READ, data=Fylkeskommune}]}, RealAttribute{typeId=1296, operation=READ, values=[RealValue{typeId=1296, operation=READ, data=31.0}]}, RealAttribute{typeId=9823, operation=READ, values=[RealValue{typeId=9823, operation=READ, data=2.5}]}, StringAttribute{typeId=1247, operation=READ, values=[StringValue{typeId=1247, operation=READ, data=Støyskjerm}]}, LocationalAttribute{typeId=120003, operation=UPDATE, values=[LocationalValue{typeId=100003, operation=IMPLICIT, data=521397: 0.70615909-0.71041488 | LEFT}]}, StringAttribute{typeId=1087, operation=READ, values=[StringValue{typeId=1087, operation=READ, data=Tre}]}],procInfo=ProcessingInfo{nvdbAction=UPDATE, extension=false, extensionOrigin='null', validationRequired=true, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.70615909-0.71041488 | LEFT

*Datterobjektversjon*

{noformat}
typeId=335,operation=MODIFY_IN_PLACE,nvdbId=377099398,version=1,validFrom=2013-04-30,validTo=<null>,attributes=[RealAttribute{typeId=2248, operation=READ, values=[RealValue{typeId=2248, operation=READ, data=5.0}]}, RealAttribute{typeId=7566, operation=READ, values=[RealValue{typeId=7566, operation=READ, data=9.0}]}, LocationalAttribute{typeId=120335, operation=UPDATE, values=[LocationalValue{typeId=100335, operation=IMPLICIT, data=521397: 0.70613329-0.71039652 | LEFT}]}],procInfo=ProcessingInfo{nvdbAction=UPDATE, extension=false, extensionOrigin='null', validationRequired=true, cascadingOperation=false, lifetimeChanged=false, removedAttributeTypeIds=[]}]
{noformat}

Stedfesting: 521397: 0.70613329-0.71039652 | LEFT

*Konklusjon*
Samme som første tilfelle, bare sett fra morobjektet.
",NVDB-6937,Datafangst,
Feil mapping av valgt veg fra bruker,"h2. Observasjon

Importer følgende url-er som Korriger

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Gå til stedfesting og manuelt stedfest (med Skriv) Skjerm 101895592 og Avstandsmåling 377099404 til nærmeste vei. Da gir Skriv beskjed om _Ingen relevant vegnettstilknytning ble funnet._

Kallet som går til Skriv er

/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegnummer=32&vegkategori=F&typeVeg=ENKEL_BILVEG&fase=V

Fra Vegkart ser det ut til at det her ikke eksisterer noen typeVeg ""enkelBilveg"", men kun ""kanalisertVeg"". Se

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@194926,6567452,18/hva:~(~(id~335)~(id~3))/vegnett:~'geometri+~(typeveg~(~'enkelBilveg))]

vs

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@194926,6567452,18/hva:~(~(id~335)~(id~3))/vegnett:~'geometri+~(typeveg~(~'kanalisertVeg))]

Derfor vil man ikke få stedfestet disse objektene.

h2. Løsning
Vi spør fra før Les om typeVeg for vegsegment, siden vi ikke har dette fra VisvegInfo. Så ENKEL_BILVEG kommer også fra Les. Men vi har så langt bare gitt det første svaret vi finner for typeVeg fra Les, men Skriv (og les) støtter en liste med parametre. Så kode er endret til at vi sender inn alle typer for et vegsegment.",NVDB-6937,Datafangst,
Finner ingen stedfesting oppdaterer feilaktig venstremeny,"h2. Observasjon

Importer følgende url-er som Korriger

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/335?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3?segmentering=true&kartutsnitt=194782.071%2C6567374.944%2C195070.715%2C6567529.56&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter]

Gå til stedfesting og manuelt stedfest (med Skriv) Skjerm 101895592 og Avstandsmåling 377099404 til nærmeste vei. Da gir Skriv beskjed om _Ingen relevant vegnettstilknytning ble funnet_ og objektene blir oppdaterte i venstremenyen med mangler stedfesting. Reload så ser du at de fortsatt har samme stedfesting. Ingenting er endret.

Her bør ikke GUI oppdateres med _mangler stedfesting_.",NVDB-6937,Datafangst,
HTTP 500 for /rute,"h2. Observasjon

POST [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?debug=true]
{noformat}
{""geometri"":""LINESTRING (229301.02 7039446.87, 229301.41 7039449.31, 229299.77 7039455.35, 229299.01 7039463.36, 229299.22 7039472.76, 229300.56 7039481.37, 229306.87 7039503.02, 229307.37 7039513.2, 229307.59 7039519.65, 229309.22 7039530.13, 229312.88 7039538.3, 229316.38 7039543.5, 229322.49 7039549.66, 229327.61 7039555.05, 229333.64 7039561.17, 229337.46 7039565.74, 229341.86 7039570.04, 229345.01 7039573.93, 229350.93 7039586.31, 229353.64 7039591.51, 229358.44 7039597.88, 229370.03 7039611.57, 229373.83 7039617.57, 229376.88 7039628.2, 229378.28 7039633.68, 229379.99 7039640.6, 229383.44 7039652.78, 229386.12 7039659.54, 229395.47 7039677.39, 229402.85 7039688.27, 229405.27 7039692.48, 229405.78 7039693.41, 229406.8 7039696.09, 229407.78 7039698.85, 229408.88 7039702.42, 229409.98 7039706.3, 229412.98 7039713.01, 229414.93 7039717.26, 229417.8 7039722.91, 229418.94 7039724.74, 229422.98 7039729.05, 229426.79 7039733.04, 229433.23 7039739.18, 229441.5 7039742.49, 229449.49 7039743.55, 229457.8 7039747.08, 229463.75 7039750.63, 229470.23 7039751.84, 229476.96 7039750.1, 229482.5 7039748.55, 229487.1 7039747, 229489.89 7039746.14, 229494.65 7039744.3, 229499.38 7039741.89)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""R,E,F,K"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-25"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
gir HTTP 500 med mld
{noformat}
Caused by: java.lang.IllegalArgumentException: no such edge in graph: RoadNetSegment{locational=2610207@0.40644294-0.57466358, partNumber=6, segmentNumber=6, type=MAIN, superExtent=null, startDate=2020-08-19, endDate=null, startConnection=2874174-1-null-null-2, endConnection=2874175-1-null-null-2, contracts=[706925699, 376882576, 902857769], routes=[], municipality=5059, county=50, laneset=[1, 2, 4], topologyLevel=null, typeOfRoad=ENKEL_BILVEG, detailLevel=VEGTRASE_OG_KJOREBANE, measurementMethod=2, dateOfMeasurement=null, lastModifiedDate=null, roadSysRef=RoadSysRef{roadSystem=RoadSystem{id=1002134449, version=1, roadNumber=714, roadCategory='F', phase='V'}, section=Section{id=1003440352, version=1, sectionNumber=2, sectionPartNumber=1, arm=false, sepratePassages='NEI', sepratePassagesNumber='null', trafficType='K', sequenceNumber=7000, direction=WITH, startMeter=5007.205, endMeter=5522.599}, sideArea=null, intersection=null}}Caused by: java.lang.IllegalArgumentException: no such edge in graph: RoadNetSegment{locational=2610207@0.40644294-0.57466358, partNumber=6, segmentNumber=6, type=MAIN, superExtent=null, startDate=2020-08-19, endDate=null, startConnection=2874174-1-null-null-2, endConnection=2874175-1-null-null-2, contracts=[706925699, 376882576, 902857769], routes=[], municipality=5059, county=50, laneset=[1, 2, 4], topologyLevel=null, typeOfRoad=ENKEL_BILVEG, detailLevel=VEGTRASE_OG_KJOREBANE, measurementMethod=2, dateOfMeasurement=null, lastModifiedDate=null, roadSysRef=RoadSysRef{roadSystem=RoadSystem{id=1002134449, version=1, roadNumber=714, roadCategory='F', phase='V'}, section=Section{id=1003440352, version=1, sectionNumber=2, sectionPartNumber=1, arm=false, sepratePassages='NEI', sepratePassagesNumber='null', trafficType='K', sequenceNumber=7000, direction=WITH, startMeter=5007.205, endMeter=5522.599}, sideArea=null, intersection=null}} 
at org.jgrapht.graph.BaseIntrusiveEdgesSpecifics.getEdgeSource(BaseIntrusiveEdgesSpecifics.java:99)
{noformat}
Denne feilen kommer av lang kabel som vedlagt i skjermbilde. SOSI-fil er også vedlagt. Det er veldig godt mulig at det ikke finnes rute her, men man skal ikke få HTTP 500",NVDB-6937,Les-API,
Geometri i kontraktsområde vert representert feil frå Les,"h1. Feilmelding frå brukar
{quote}{{POB-sak: 3666540}}
{{Meldt av: Randi Skoglund}}
{quote}
Jeg kom over denne opptegningen av kontraktsområde i vegkart. Dette bør det gjøres noe med.

[!image-2020-09-25-13-45-32-315.png!|https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@995843,7841781,14/hva:~(~(id~580]

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@995843,7841781,14/hva:~(~(id~580]))

Med hilsen
 Randi Skoglund",NVDB-6937,Les-API,
Ny type: Vedlikeholdskontrakt og Samlekontrakt,"Innmeldt ønske frå Steinar Johansen i Innlandet FK (steinar.johansen@innlandetfylke.no):

Innlandet fylke har to kontrakstyper som går igjen, men som ikkje er valgbar type i Datafangst.
 * Samlekontrakt
 * Vedlikeholdskontrakt

Et raskt søk i kontrakslisten i DF viser at liknande tekstar går igjen i mange fylker, og kommunar.

Behovet ser ut til å være til stede, så dei bør nok leggast til.
Vedlikeholdskontrakt er ei klar definert kontrakstype. Samlekontrakt er meir vagt, og kjenner ikkje denne betegnelsen frå SVV. Men det er tydeleg at fylka har deffinert dette som ein mal, og ønsker då sikkert å dele dette frå samletypen ""Andre"".",NVDB-6937,Datafangst,
Er det mogleg å vise kontraktsområde med TilDato og FraDato fram og tilbake i tid i Vegkart?,"Det er ønske om å vise kontraksområder i Vegkart som ikkje er innanfor gyldig TilDato og FraDato, men som ikkje er sett historisk (lukka).

Utfordringa er at kontraktsområde har gyldigdata frå og til tidsrommet kontrakta gjeld, men mange av objekta er gyldige og etter at kontrakte ikkje gjeld lenger.

Ei anna utfordring er framtidige kontrakter. Det er mange som har interesse i å sjå kontraktsområde som er klare, men ikkje er gyldige for å planlegge aktivitet.

Oprinneleg melding frå [Torgeir.Boyum@vlfk.no|mailto:Torgeir.Boyum@vlfk.no]
{quote}Mange brukarar opplever at ikkje alle kontraktsområda blir tilgjengeleg som filter i Vegkart. Det er spesielt dette kontraktsområdet (1405 Indre Sunnfjord 2015-2020) som ikkje er tilgjengeleg:

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@26278,6850383,7/hvor:~(kontraktsomrade~(~'1405*20Indre*20Sunnfjord*202015-2020))]

 

Kan det ha noko å seie at eigenskapen Dato til er passert? Objektet er fortsatt tilgjengeleg i NVDB og er ikkje lagt historisk. Har sjekka opp mot andre kontraktsområder som også har passert Dato til-eigenskapen, og desse er heller ikkje tilgjengeleg (eks. 0504 SØR-GUDBRANDSDALEN 2015-2020). Uansett merkeleg at det er mange som får det opp i søkefeltet og andre ikkje.
{quote}
 

*Løsning*

For kontraktsområder bruker vi nå objektets gyldighetsperiode og ikke egenskapene fra og til. Det gjør at alle kontrakter der objektet ikke er lukket vil komme opp i lista under /omrader/kontraktsomrader som brukes av vegkart.

 ",NVDB-6937,Les-API,
Objekter med for tette punkter lar seg ikke stedfeste,"h2. Observasjon

Vedlagte SOSI inneholder to objekter som har en geometri med for tette punkter. Dette blir rapportert som feil ved import, noe som fører til at Datafangst opplyser om at for tette punkter er fjernet.

*MEN:* Stedfesting med Skriv går ikke pga feil-kode GEOMETRI_MED_FOR_TETTE_PUNKTER. De lar seg derfor ikke lagre.
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><stedfestingResultat xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt tempId=""04bd8ad3-2544-4d85-bb1d-88d339b4dc77""><feil><feil kode=""GEOMETRI_MED_FOR_TETTE_PUNKTER""><melding >Geometrien har nabopunkter som er nærmere hverandre enn 0.01 m</melding><referanse>https://datakatalogen.vegdata.no/15</referanse><egenskapTypeId>4723</egenskapTypeId><geometrideler srid=""5973""><wkt>LINESTRING Z (298317.0029693155 6749194.52900 4241 237.978, 298317.0029693155 6749194.529004241 237.978)</wkt></geometrideler></feil></feil></vegobjekt><vegobjekt tempId=""c2209ac4-23aa-4edf-82b7-fb098d5e6c44""><feil><feil kode=""GEOMETRI_MED_FOR_TETTE_PUNKTER""><melding>Geometrien har nabopunkter som er nærmere hverandre enn 0.01 m</melding><referanse>https://datakatalogen.vegdata.no/15</referanse><egenskapTypeId>4723</egenskapTypeId><geometrideler srid=""5973""><wkt>LINESTRING Z (298317.0039679891 6749194.528950906 237.978, 298317.0039679891 6749194.528950906 237.978)</wkt></geometrideler></feil></feil></vegobjekt></stedfestingResultat>
{noformat}
Stedfesting uten Skriv går fint, men da stopper objektene ved registrering.

 

Her virker det som om Datafangst ikke klarer å fjerne alle punktene som ligger for nærme hverandre.",NVDB-6937,Datafangst,
NullPointerException når ikke tilgang til objekttype - forbedre feilmelding,"Egendefinert driftskontrakt-rapport V4 med skjermet objekttype.

Feiler med NullPointerException - bør feile med noe a'la ""ikke tilgang"" siden underliggende årsak er 403.

 

Log fra PROD:

2020-09-24 10:53:52,988 ERROR [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Server returned 403 for object 895
2020-09-24 10:53:52,988 INFO  [no.svv.vei.eng.ReportGenerator] (ForkJoinPool.commonPool-worker-0) 0 features found
2020-09-24 10:53:52,988 INFO  [no.svv.vei.eng.ReportGenerator] (ForkJoinPool.commonPool-worker-0) Starting download of roadnet from NVDB
2020-09-24 10:53:52,989 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Downloading VT+KB in bulk; this might take some time
2020-09-24 10:53:54,502 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Downloaded 366 segment IDs.
2020-09-24 10:53:54,502 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Downloading VT in bulk
2020-09-24 10:53:54,556 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Downloaded 2 segment IDs.
2020-09-24 10:53:54,556 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) Hunting for missing segments
2020-09-24 10:53:54,556 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-0) 0 missing Segmentlinks founds.
2020-09-24 10:53:54,556 INFO  [no.svv.vei.eng.ReportGenerator] (ForkJoinPool.commonPool-worker-0) 4076 segments found amongst 368 IDs
2020-09-24 10:53:54,556 INFO  [no.svv.vei.eng.ReportGenerator] (ForkJoinPool.commonPool-worker-0) Working on subreport 1 out of 1
2020-09-24 10:53:54,556 ERROR [no.veg.nvd.RapportResource] (ForkJoinPool.commonPool-worker-0) Handling exception for job c9724d6c-305e-4bc7-8d53-bdeacbc1e6ac: java.util.concurrent.CompletionException: java.lang.NullPointerException
 at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
 at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
 at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
 at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
 at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:163)
Caused by: java.lang.NullPointerException
 at no.svv.veirapporter.engine.ReportGenerator.getObjectsReport(ReportGenerator.java:125)
 at no.svv.veirapporter.engine.ReportGenerator.getReport(ReportGenerator.java:93)
 at no.svv.veirapporter.engine.ReportGenerator.getReport(ReportGenerator.java:100)
 at no.svv.veirapporter.engine.ReportGenerator.createReport(ReportGenerator.java:83)
 at no.vegvesen.nvdbrapportapi.RapportService.getDriftskontrakt(RapportService.java:306)
 at no.vegvesen.nvdbrapportapi.RapportService_ClientProxy.getDriftskontrakt(RapportService_ClientProxy.zig:223)
 at no.vegvesen.nvdbrapportapi.RapportResource.lambda$getDriftskontrakt$4(RapportResource.java:285)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)
 ... 5 more",,Rapportgenerator,
Sjekk om det mangler data for 532,"Fra gitter
{quote}
Daniel Strømme Solberg
15:18
På et litt høyere nivå; Vet du om det er noen forskjellig på datakvaliteten til 532-vegreferansene vi får fra NVDB sitt API sammenlignet med VisVegInfo? Når jeg sammenligner historikkene finner jeg litt forskjeller mellom dem og litt avvik på begge sider (dvs manglende vegreferanser for enkelte tidsintervall). Er det noe forskjellig i kvalitet/pålitelighet mellom datasettene?

Marvin Bredal Lillehaug
15:21
Dataene kommer jo fra NVDB, så vil tro det skal være rett der. Eksempler?

Daniel Strømme Solberg
15:30
For eksempel her https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/532?srid=6173&veglenkesekvens=0.14877@22180&alle_versjoner=true. Her mangler NVDB de to første innslagene som vi har fra VisVegInfo (NVDB sin første er fra 1992)

1950-01-01 - 1987-08-20: RV9 HP 2 Meter 2890
1987-08-20 - 1992-06-16: RV9 HP 2 Meter 2875


Daniel Strømme Solberg
15:36
Et annet eksempel er på punktet 0.04293@1060674, som har historikk fra 1950 til nåtid, men hos NVDB er det et hull i historikken fra 1989-06-27 til 1992-06-16
{quote}",NVDB-6937,NVDB-IND,
Får ikke koblet korrigert datter til oppdatert mor,"h2. Observasjon

(Fra support. Innmelder Lisbeth By)

Har importert inn en NVDB-mor som Oppdater og en NVDB-datter som Korriger. Prøver å koble disse ved å velge NVDB-mor i assosiasjonsfanen og koble til NVDB-datteren. Både kobling til datter i kontrakt og datter i NVDB gir konsoll-feil (se scenario på skjermbildene):
{noformat}
Uncaught TypeError: Cannot read property 'typeId' of null at actions.ts:1220 
at index.js:8 
at Object.onFetchNvbdObjects (redux.js:475) 
at i.handleFetchFeaturesFromNvdb (NvdbChildAssociationsTab.tsx:57) 
at onClick (NvdbChildAssociationsTab.tsx:136) 
at Object.l (react-dom.production.min.js:14)
{noformat}
Aktuell test-kontrakt i ATM: [https://datafangst-test.kantega.no/#!/contract/606cc7b1-85a6-4197-9ea4-6a9defcab313/association]

 ",NVDB-6937,Datafangst,
Få med fase i vegsystemreferanse-visning,"[~tormos] added a comment - 43 minutes ago
 
Når jeg legger til filter på ""R"" kommer ""Riksveg"" som filter, men legger jeg til ""RV"" kommer ""R"" som filter. Tilsvarende for ""F"" vs ""FV"" og ""E"" vs ""EV"".",NVDB-6937,Vegkart,
Stedfesting feiler når mor bare har assosiasjoner til NVDB.,"h2. Observasjon

Stedfesting feiler når et objekt har assosiasjoner, men alle assosiasjonene er assosiasjoner til NVDB-objekter som ikke er importert i prosjektet.

Feilen oppstår fordi objektet har barn, men siden ingen av dem ligger i datafangst, kastes en illegal argument exception fordi listen av barn som skal flyttes blir tom.
h2. Løsning

Sjekk på om listen er tom

 

 ",NVDB-6937,Datafangst,
GEOMETRYCOLLECTION EMPTY,"h2. Observasjon

Datafangst fikk en feil ved uthenting av wkt for noen trær. Hele kontrakten låste seg. Dette kom av at noen importerte NVDB-Trær hadde GEOMETRYCOLLECTION EMPTY som wkt under lokasjon.geometri:
{noformat}
""geometri"": { ""wkt"": ""GEOMETRYCOLLECTION EMPTY"", ""srid"": 5973 }
{noformat}
[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/199/784933441/1.json]

De berørte trærne var
{noformat}
784933439 784933443 784933441 784933438 784933437 784933440 784933436
{noformat}
Mangler vegnettet geometri, er det feil på objektet, eller er det Les/NVDBIND som ikke henter inn riktig?",NVDB-6937,Les-API,
Feil med geometri for vegfunksjon på kryssdel,"Geometri vises som punkt, men rundkjøringen dekkes hvis man trykker på punktet.

Flere eksempler i vedlagte bilder.

https://vegkart.utv.atlas.vegvesen.no/#kartlag:topo4/@255796,6594154,18/hva:~(~(id~577))/hvor:~(vegsystemreferanse~(~'FV118))/valgt:909980951:577



I prod vises geometri som en kort strek og ikke punkt.",NVDB-6937,Les-API,
For lang streng i X-Client trigger SQLException,"h2. Observasjon

En del endringssett (f.eks. https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/d88cffdb-d179-4ff1-ae7c-a418599d65d8) fra Jan Kristian havarer med SYSTEMFEIL pga for lang streng i X-Client header:

{code:java}
java.lang.RuntimeException: Failed to execute update
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Executors.executeUpdate(Executors.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Executors.lambda$executeUpdate$1(Executors.java:52)
	at java.util.stream.ReferencePipeline$4$1.accept(ReferencePipeline.java:210)
	at java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:948)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.IntPipeline.reduce(IntPipeline.java:457)
	at java.util.stream.IntPipeline.sum(IntPipeline.java:415)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Executors.executeUpdate(Executors.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobrepository.JdbcStatisticsRepository.saveChangesetStats(JdbcStatisticsRepository.java:43)
	at no.vegvesen.vt.nvdb.apiskriv.statistics.DefaultStatisticsService.saveStats(DefaultStatisticsService.java:42)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$22(JobWorker.java:702)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:110)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:109)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:105)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$updateNvdb$23(JobWorker.java:683)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:110)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:109)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:105)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.updateNvdb(JobWorker.java:683)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:201)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1390)
	at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)
	at org.apache.activemq.ActiveMQSessionExecutor.execute(ActiveMQSessionExecutor.java:81)
	at org.apache.activemq.ActiveMQSession.dispatch(ActiveMQSession.java:1678)
	at org.apache.activemq.ActiveMQConnection$3.processMessageDispatch(ActiveMQConnection.java:1885)
	at org.apache.activemq.command.MessageDispatch.visit(MessageDispatch.java:113)
	at org.apache.activemq.ActiveMQConnection.onCommand(ActiveMQConnection.java:1865)
	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)
	at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)
	at org.apache.activemq.transport.failover.FailoverTransport$3.onCommand(FailoverTransport.java:209)
	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)
	at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)
	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)
	at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)
	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.sql.SQLException: ORA-12899: value too large for column ""NVDBAPISKRIV"".""STATS_CHANGESET"".""CLIENT"" (actual: 67, maximum: 64)
{code}

h2. Analyse

Verdien i X-Client er på 67 tegn. Endringssettet registreres i JOB-tabellen, der CLIENT-kolonnen er på 100 tegn. Dette går bra. I etterkant av behandlingen av endringssettet skal det registreres noe statistikk, inkludert hvilken klient det var. I STATS_CHANGESET-tabellen er imidlertid CLIENT-kolonnen på bare 64 tegn.

h2. Løsning

Utvider kolonnen STATS_CHANGESET.CLIENT til 100 tegn og trunkerer X-Client-headeren til 100 tegn dersom for lang.
",NVDB-6937,Skriv-API,
Skjul koblede skjuler alle,"h2. Observasjon

Fra support (Øystein Lund). På assosiasjonsfanen kan man skjule koblede objekter undre manuell assosiering for enklere å se hvem som skal kobles. Denne funksjonen skjuler nå alle.

For å gjenskape, last opp vedlagte SOSI-filer og assosier auto. Fjern koblingen for et par objekter. Merk deretter et rekkverksobjekt, og se på datterobjekter som kan assosieres fra kontrakten (se skjermbilde). Her er da alle koblet - med unntak av de du nettopp fjernet. Prøv sjekkboks ""Skjul koblede"". Da skjules alle - ikke bare koblede.",NVDB-6937,Datafangst,
"gå tilbake til Geodata-kart, øke zoomnivå på geodata-kart","h2. Observasjon

Vi har i en periode prøvd ut webatlas/norkart-kartene som default i stedfesting, siden geodata-kartene hadde for dårlig oppløsning ved høye zoomnivå, og man fikk ""ingen kartdata tilgjengelig"" hvis man prøvde å zoome inn for mye.

Problemet er at webatlas-kartene er veldig mye tregere, så løsningen føles veldig treg.

Webatlas/norkart skulle egentlig øke ytelsen sin, men det  har de ikke gjort.

Vi bør gå tilbake til geodatakartene som default, siden det er det kartet de bruker for å lete fram og få oversikt. vi kan sette en toggle som sier til leaflet at den skal gjenbruke kart-tiles fra lavere zoomnivå, slik at kart vises, men med dårligere oppløsning.

Når brukere har funnet sin plass kan de bytte til norkart hvis de trenger flere detaljer.
h2. Løsning

sette geodatakart som default, gjenbruke lavere zoominvå.",NVDB-6937,Datafangst,
HTTP 500 segmentLengthFraction,"h2. Observasjon

POST /nvdb/apiskrivbeta/rest/v3/stedfest?maksimumAvstandTilVeg=300
{noformat}
<vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""853"" tempId=""031b85a7-c90e-4e65-8774-5e14dae76f1c""><egenskaper><egenskap typeId=""9843""><geometri><srid>25833</srid><wkt>POINT (302975.53973862587 6751349.649176841 267.38800000000003)</wkt><referansegeometri>false</referansegeometri><kvalitet/></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-09-18</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
gir HTTP 500 og _segmentLengthFraction must be <= 1.0_

Rute-kall mot Les: POST [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""geometri"":""POINT (302975.53973862587 6751349.649176841)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""F,K,E,R"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-18"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}{noformat}

h2. Analyse

Etablerte testcase, men fikk ikke reprodusert feilen, sannsynligvis fordi koden som trigger denne exception'en ble omarbeidet i NVDB-5914.",NVDB-6937,Skriv-API,
HTTP 500 NPE for /rute,"h2. Observasjon

POST https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?debug=true
{noformat}
{""geometri"":""LINESTRING (136413.38 6499763.59, 136414.4 6499768.35, 136414.47 6499768.58, 136416.32 6499773.77, 136416.45 6499774.05, 136416.6 6499774.31, 136419.89 6499779.09, 136419.92 6499779.14, 136422.64 6499782.92, 136422.8 6499783.12, 136422.98 6499783.3, 136425.07 6499785.17, 136425.17 6499785.25, 136432.13 6499790.79, 136432.25 6499790.91, 136435.74 6499794.34, 136435.8 6499794.4, 136441.48 6499800.34, 136441.52 6499800.38, 136446.61 6499805.97, 136446.69 6499806.06, 136455.39 6499814.9, 136455.5 6499815.03, 136466.55 6499828.92, 136466.63 6499829.02, 136476.37 6499843.16, 136476.66 6499843.5, 136485.27 6499852, 136485.41 6499852.13, 136491.82 6499857.69, 136491.88 6499857.75, 136501.92 6499866.09, 136502.02 6499866.16, 136512.42 6499873.96, 136512.47 6499874, 136519.61 6499879.83, 136519.76 6499879.97, 136519.89 6499880.12, 136523.29 6499884.7, 136523.39 6499884.86, 136523.48 6499885.02, 136525.36 6499889.1, 136525.46 6499889.34, 136526.88 6499894.02, 136526.89 6499894.05, 136528.58 6499899.37, 136528.62 6499899.49, 136535.45 6499918.9, 136535.53 6499919.2, 136537.52 6499931.56, 136537.54 6499931.74, 136537.86 6499937.67, 136537.87 6499937.83, 136537.8 6499940.93, 136537.76 6499941.21, 136537.68 6499941.49, 136537.56 6499941.74, 136537.39 6499941.97, 136535.57 6499944.03, 136535.48 6499944.14, 136527.49 6499953.41, 136527.33 6499953.62, 136523.28 6499959.12, 136523.06 6499959.49, 136522.9 6499959.9, 136522.83 6499960.33, 136522.84 6499960.76, 136523.06 6499961.35, 136524.22 6499968.64)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""E,R,K,F"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-17"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
gir HTTP 500 og en NPE.",NVDB-6937,Les-API,
HTTP 500 med Failed to calculate geometry på stedfesting,"h2. Observasjon

POST /nvdb/apiskrivbeta/v3/stedfest?maksimumAvstandTilVeg=300
{noformat}
<vegobjekter xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><vegobjekt typeId=""181"" tempId=""d01adb10-dd4a-4339-86e8-bc5749b7fa13""><egenskaper><egenskap typeId=""4838""><geometri><srid>25833</srid><wkt>POINT (225407.25 6584218.62 0)</wkt><referansegeometri>false</referansegeometri><kvalitet><målemetode>99</målemetode></kvalitet></geometri></egenskap></egenskaper><gyldighetsperiode><startdato>2020-09-16</startdato></gyldighetsperiode></vegobjekt></vegobjekter>
{noformat}
gir HTTP 500
{noformat}
""Failed to calculate geometry for extent [0.64301822, 0.64301822] from ref link 1150508, period 2020-09-16 - >""
{noformat}
Kallet som går mot Les er: POST [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""geometri"":""POINT (225407.25 6584218.62)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""R,E,K,F"",""trafikantgruppe"":null,""typeveg"":null,""tidspunkt_start"":""2020-09-16"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
Legger videre merke til at Les da gir tilbake et segment 0.39576997-0.64301822@1150508 hvor det ikke finnes gyldig segment fra 0.64301822 -> ([https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/1150508)]

h2. Analyse

Det kastes exception fra ComputedLocational.createFromPointExtent() fordi punktstedfestingen det skal beregnes geometri fra er identisk med sluttposisjonen til den ene relevante veglenken. Sluttposisjonen er ikke-inklusiv og det finnes derfor ingen match mellom stedfestingen [0.64301822] og veglenkens utstrekning [0.39576997, 0.64301822). Veglenken som har 0.64301822 som startposisjon er ikke gyldig i det aktuelle tidsrommet (2020-09-16 ->).

h2. Løsning

Laget nye metoder i RefLink (getGeometryForPosition) og RefLinkPart (getGeometryForPosition) som beregner punktgeometri ut fra en punktstedfesting (singular extent). Denne vil finne siste posisjon/punkt i veglenkegeometrien som representerer sluttposisjonen til veglenken. Stedfestingen er i dette tilfelle (sluttposisjon på veglenke) egentlig ugyldig, men API Skriv godtar 1 mm avvik fra nærmeste gyldige veglenkeposisjon, ved validering av stedfestingen.
",NVDB-6937,Skriv-API,
Rute gir POINT-geometri tilbake for type Linje,"h2. Observasjon

Skriv kaster en feil _om.vividsolutions.jts.geom.Point cannot be cast to com.vividsolutions.jts.geom.LineString_ på følgende spørring

POST [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute]
{noformat}
{""geometri"":""LINESTRING (67443.5 6597165, 67441.69 6597162.98, 67432.64 6597151.15, 67422.76 6597154.71, 67422.74 6597154.75, 67418.13 6597152.69, 67413.09 6597147.2, 67412.62 6597146.03, 67411.16 6597141.56, 67410.42 6597137.82, 67407 6597127.36, 67406.62 6597126.69, 67405.52 6597122.86)"",""maks_avstand"":""300"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""RA9"",""trafikantgruppe"":null,""typeveg"":""enkelBilveg"",""tidspunkt_start"":""2020-09-16"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}
{noformat}
Responsen gir geometri for hvert enkelt segment. Segment #2 gir kun {{type: Linje}} med kortform=true, men på aktuelt kall er kortform=false og gir da tilbake
{noformat}
""geometri"": { ""wkt"": ""POINT Z(67434.87 6597157.95 410.816)"", ""srid"": 5973 }
{noformat}
Denne kan re-testes med å stedfeste vedlagte SOSI i Datafangst.",NVDB-6937,Les-API,
Stedfesting med Skriv: En feil avbryter stedfesting for alle,"h2. Observasjon

Vedlagte SOSI-fil 92a.sos kaster (per nu) en feil i ATM fra Skriv pga /rute i Les.
{code:java}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>com.vividsolutions.jts.geom.Point cannot be cast to com.vividsolutions.jts.geom.LineString</message></fault> 

2020-09-15T15:47:18.526 ERROR [LocalizationWorker-1] [exttxm] [b78361ff-d1dc-4672-b1ed-7cd9f9a125f1] n.s.n.d.l.async.SkrivLocalizationWorker Failed while localizing feature(s) for contract b78361ff-d1dc-4672-b1ed-7cd9f9a125f1 
2020-09-15T15:47:18.526 ERROR [LocalizationWorker-1] [] [] n.s.n.d.l.async.LocalizationScheduler Skriv worker failed
{code}
Dette gjør at stedfesting avbrytes og ikke alle objekter som kan stedfestes blir det.

Stedfester man først 226 og deretter 92a, blir alle 226 stedfestet, mens stedfestingen av 92a avbrytes ved samme feil.

*MERK*: Merk at dette ikke gjelder om Skriv rapporterer om feil i en 200-respons, kun om Skriv kaster en 500 tilbake.

*MERK 2*: Hvis feilen i /rute rettes før denne saken tas vil man evt måtte mocke en feil fra Skriv for å fremprovosere oppførselen.",NVDB-6937,Datafangst,
Stedfesting med Skriv: Døtre flytter ikke inn,"h2. Observasjon # 1

Autoassosier vedlagte SOSI (5_ed og 14_ed) og stedfest. Registrer.

UTEN Skriv som stedfesting flytter døtrene hjem og ting blir lagret.

MED Skriv som stedfesting flytter døtrene IKKE hjem.
h2. Analyse

Innflytting er ikke aktivert for stedfesting med skriv
h2. Løsning

Legge inn innflytting med Skriv

Omskriving av metoden for å støtte å kunne sende berørte barn til GUI for oppdatering

omskriving av handleren på GUI for å støtte batch-innsending av stedfestinger for å fikse progressbaren som var ødelagt med Skriv. Stedfestinger deles inn i opptil 10 batches når multiple stedfestinger gjøres samtidig.

Enhetstester på Frontend for å teste batch-oppdelingen

 ",NVDB-6937,Datafangst,
ClassCastException i AbsoluteMaximumValidator,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/e01d76ae-c3f8-4e2c-be13-e444a92c28cd havarerer i AbsoluteMaximumValidator:

{code:java}
java.lang.ClassCastException: java.lang.Long cannot be cast to java.lang.String
	at java.lang.String.compareTo(String.java:111)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.value.AbsoluteMaximumValidator.isValid(AbsoluteMaximumValidator.java:13)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.value.AbsoluteMaximumValidator.isValid(AbsoluteMaximumValidator.java:8)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.ConstraintEnforcer.enforce(ConstraintEnforcer.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.validation.value.ConstraintValueFilter.doFilter(ConstraintValueFilter.java:33)
	at no.vegvesen.vt.nvdb.apiskriv.validation.attribute.AttributeValueFilters.doFilter(AttributeValueFilters.java:32)
	at no.vegvesen.vt.nvdb.apiskriv.validation.feature.FeatureAttributeFilters.doFilter(FeatureAttributeFilters.java:32)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.JobFeatureFilters.doFilter(JobFeatureFilters.java:36)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:449)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:171)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

I endringssettet delviskorrigeres vegobjektversjon 296004:1 (Gate) der egenskap 4588 (Gatekode) settes til 8092. I tillegg delvisoppdateres samme vegobjekt der kun stedfestingen endres i ny versjon (2). I PartialFeatureEnricherJobFilter kompletteres den delvise korreksjonen med manglende egenskaper fra originalen i NVDB. Det samme gjøres for oppdateringen, men egenskap 4588 kopieres fra korreksjonen. I det første tilfellet er egenskapen av korrekt datatype, IntegerAttribute, mens i det andre tilfellet er datatypen StringAttribute. Alle egenskaper som er innlest fra NVDB har operation READ. I et senere filter, TransformAttributeFilter, transformeres eventuelle StringAttribute til sin sterkt typede variant. Her ville normalt egenskap 4588 i oppdatering blitt omdannet til IntegerAttribute, men filteret behandler ikke egenskaper med operation READ, fordi de ansees å være innlest fra NVDB og derfor allerede er typet riktig. Denne svakheten ble introdusert da vi implementerte støtte for korrigering og oppdatering av/fra samme vegobjektversjon i NVDB-5270.

h2. Løsning

Fjerner filteret på operation READ i TransformAttributeFilter.",NVDB-6937,Skriv-API,
Systemfeil i SanitationJobFilter,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/bfaa50a0-2625-4a3e-a8a1-47c7c4a115a3 havarerer med systemfeil i SanitationJobFilter:

{code:java}
java.lang.IllegalStateException: Detected conflicting actions on 3 feature version(s):

  op:DISCONTINUE_CASCADING tid:538 id:844165507 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:changeset vr:true co:true - [LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=367437: 0.0->1.0}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, AssociationAttribute{typeId=202184, operation=READ, values=[AssociationValue{typeId=202184, operation=READ, data=1002101665}]}],  op:CORRECT tid:538 id:844165507 v:1 sd:2017-11-10 ed:2020-07-07 - ac:UPDATE or:changeset vr:true co:false - [StringAttribute{typeId=9793, operation=READ, values=[StringValue{typeId=9793, operation=READ, data=Ja}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=367437: 0.0->1.0}]}, IntegerAttribute{typeId=4588, operation=READ, values=[IntegerValue{typeId=4588, operation=READ, data=2133}]}, StringAttribute{typeId=4589, operation=READ, values=[StringValue{typeId=4589, operation=READ, data=Standalsvegen}]}],  op:DISCONTINUE_CASCADING tid:538 id:844165507 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:AdaptFeaturesToClosedNetworkEnricherFilter vr:false co:true - [StringAttribute{typeId=9793, operation=IMPLICIT, values=[StringValue{typeId=9793, operation=IMPLICIT, data=Ja}]}, AssociationAttribute{typeId=200699, operation=IMPLICIT, values=[AssociationValue{typeId=200699, operation=IMPLICIT, data=256}]}, LocationalAttribute{typeId=120538, operation=IMPLICIT, values=[LocationalValue{typeId=100538, operation=IMPLICIT, data=367437: 0.0->1.0}]}, AssociationAttribute{typeId=202184, operation=IMPLICIT, values=[AssociationValue{typeId=202184, operation=IMPLICIT, data=1002101665}]}, IntegerAttribute{typeId=4588, operation=IMPLICIT, values=[IntegerValue{typeId=4588, operation=IMPLICIT, data=2133}]}, StringAttribute{typeId=4589, operation=IMPLICIT, values=[StringValue{typeId=4589, operation=IMPLICIT, data=Standalsvegen}]}]
,

  op:DISCONTINUE_CASCADING tid:538 id:844165574 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:changeset vr:true co:true - [LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=368100: 0.0->1.0}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, AssociationAttribute{typeId=202184, operation=READ, values=[AssociationValue{typeId=202184, operation=READ, data=1002101665}]}],  op:CORRECT tid:538 id:844165574 v:1 sd:2017-11-10 ed:2020-07-07 - ac:UPDATE or:changeset vr:true co:false - [StringAttribute{typeId=9793, operation=READ, values=[StringValue{typeId=9793, operation=READ, data=Ja}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=368100: 0.0->1.0}]}, IntegerAttribute{typeId=4588, operation=READ, values=[IntegerValue{typeId=4588, operation=READ, data=2129}]}, StringAttribute{typeId=4589, operation=READ, values=[StringValue{typeId=4589, operation=READ, data=Brufjordvegen}]}],  op:DISCONTINUE_CASCADING tid:538 id:844165574 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:AdaptFeaturesToClosedNetworkEnricherFilter vr:false co:true - [StringAttribute{typeId=9793, operation=IMPLICIT, values=[StringValue{typeId=9793, operation=IMPLICIT, data=Ja}]}, AssociationAttribute{typeId=200699, operation=IMPLICIT, values=[AssociationValue{typeId=200699, operation=IMPLICIT, data=256}]}, LocationalAttribute{typeId=120538, operation=IMPLICIT, values=[LocationalValue{typeId=100538, operation=IMPLICIT, data=368100: 0.0->1.0}]}, AssociationAttribute{typeId=202184, operation=IMPLICIT, values=[AssociationValue{typeId=202184, operation=IMPLICIT, data=1002101665}]}, IntegerAttribute{typeId=4588, operation=IMPLICIT, values=[IntegerValue{typeId=4588, operation=IMPLICIT, data=2129}]}, StringAttribute{typeId=4589, operation=IMPLICIT, values=[StringValue{typeId=4589, operation=IMPLICIT, data=Brufjordvegen}]}]
,

  op:DISCONTINUE_CASCADING tid:538 id:844165503 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:changeset vr:true co:true - [LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=368021: 0.0->1.0}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, AssociationAttribute{typeId=202184, operation=READ, values=[AssociationValue{typeId=202184, operation=READ, data=1002101665}]}],  op:CORRECT tid:538 id:844165503 v:1 sd:2017-11-10 ed:2020-07-07 - ac:UPDATE or:changeset vr:true co:false - [StringAttribute{typeId=9793, operation=READ, values=[StringValue{typeId=9793, operation=READ, data=Ja}]}, AssociationAttribute{typeId=200699, operation=READ, values=[AssociationValue{typeId=200699, operation=READ, data=256}]}, LocationalAttribute{typeId=120538, operation=READ, values=[LocationalValue{typeId=100538, operation=READ, data=368021: 0.0->1.0}]}, IntegerAttribute{typeId=4588, operation=READ, values=[IntegerValue{typeId=4588, operation=READ, data=2133}]}, StringAttribute{typeId=4589, operation=READ, values=[StringValue{typeId=4589, operation=READ, data=Standalsvegen}]}],  op:DISCONTINUE_CASCADING tid:538 id:844165503 v:1 sd:2017-11-10 ed:2020-07-07 - ac:CLOSE or:AdaptFeaturesToClosedNetworkEnricherFilter vr:false co:true - [StringAttribute{typeId=9793, operation=IMPLICIT, values=[StringValue{typeId=9793, operation=IMPLICIT, data=Ja}]}, AssociationAttribute{typeId=200699, operation=IMPLICIT, values=[AssociationValue{typeId=200699, operation=IMPLICIT, data=256}]}, LocationalAttribute{typeId=120538, operation=IMPLICIT, values=[LocationalValue{typeId=100538, operation=IMPLICIT, data=368021: 0.0->1.0}]}, AssociationAttribute{typeId=202184, operation=IMPLICIT, values=[AssociationValue{typeId=202184, operation=IMPLICIT, data=1002101665}]}, IntegerAttribute{typeId=4588, operation=IMPLICIT, values=[IntegerValue{typeId=4588, operation=IMPLICIT, data=2133}]}, StringAttribute{typeId=4589, operation=IMPLICIT, values=[StringValue{typeId=4589, operation=IMPLICIT, data=Standalsvegen}]}]

	at no.vegvesen.vt.nvdb.apiskriv.validation.job.SanitationJobFilter.ensureNonConflictingActions(SanitationJobFilter.java:74)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.SanitationJobFilter.doFilter(SanitationJobFilter.java:43)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateAfterLocking(DefaultValidationService.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateAfterLock(JobWorker.java:575)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:192)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:54)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

I endringssettet korrigeres og lukkes samme vegobjektversjon. Dette er tillatt siden de angir samme sluttdato. I forbindelse med vegnettslukking berikes imidlertid jobben med ny lukking av samme vegobjektversjon med samme sluttdato. Dette kommer ikke i konflikt med de to operasjonene i endringssettet. Behandlingen havarerer imidlertid i det siste filteret i pipeline som foretar sanity check av jobben og eventuelt fjerner overflødige vegobjektversjoner (korrigeringen dekker begge de to lukkingene). SanitationJobFilter sjekker bl.a. om multiple operasjoner på samme vegobjektversjon er kompatible, men tar bare høyde for at det er to operasjoner, ikke flere som her. Feilen her er imidlertid i EnrichmentEvaluator som ikke dropper lukking fra følgeoppdateringen, når den allerede finnes i jobben.

h2. Løsning

Oppdaterer EnrichmentEvaluator til å ta høyde for at samme lukking allerede finnes i jobben.",NVDB-6937,Skriv-API,
CSV-eksport feiler med merkelig inkluder-feilmelding," 
{panel:title=Mail om feilmelding}
 

Hei,

Det kjem feilmelding

HTTP error 422 for request f6028ea1-409c-08da-0a55-a5e1a0c8e848: Error 4006: Ugyldig verdi for parameteren 'inkluder': 'polygon'. Gyldige verdier: [kartutsnitt, senterpunkt, alle, vegobjekt]

ved cvs-eksport av dette datasettet:

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@30330,6847059,7/hva:~(~(id~517))/hvor:~(kontraktsomrade~(~'9305*20Sunnfjord))]

 
{panel}
 ",NVDB-6937,Eksport,
Stedfesting feiler med feil deserialisering av Long,"h2. Observasjon

POST [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300] med body som vedlagt feiler med beskjed
{noformat}
<fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>Error reading entity from input stream.</message><message>Cannot deserialize value of type `java.lang.Long` from String ""320576-1-7 0"": not a valid Long value at [Source: (org.glassfish.jersey.message.internal.ReaderInterceptorExecutor$UnCloseableInputStream); line: 1, column: 1653] (through reference chain: no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.RuteResponse[""vegnettsrutesegmenter""]- &gt;java.util.ArrayList[1]-&gt;no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.DetaljertRuteSegment[""sluttnode""])</message></fault>
{noformat}

h2. Analyse

Responsen fra /rute (API Les) inneholder ""sluttnode"":""320576-1-70"" i DetaljertRuteSegment. API Skriv forventer at dette er et gyldig heltall (nodeId). Dette forårsaker havari ved deserialisering.

h2. Løsning

Endrer startnode og sluttnode fra Long til String i DetaljertRuteSegment og innkapsler innholdet i ny domeneklasse, NodeRef.",NVDB-6937,Skriv-API,
Ruteberegning: Hindre for stor bbox ved parsing av punkter og omkrets,Det tittelen sier. Skal forhindre for store søk som kræsjer Solr-nodene.,NVDB-6937,Les-API,
Feil med indeksering av objekt med MANGE stadfestingar,"Der ser ut som det er ein feil i Les på objekt med veldig mange stadfestingar. Datakatalog 577-Vegfunksjon har gjerne eitt objekt for alle vegar i ein funksjon i eit større geografisk område (typisk fylke-2019). Problemet er tydeleg beskrevet og dokumentert i vedlagt e-post.

Det set no ein stoppar for produksjon av veglister etter at det var gjort endring i eit objekt som kryssar ny fylkesgrense Vestland/Møre og Romsdal. Før endring i objektet fungerte rapport, men no gir Les 200-error i retur.

Det ser ut som om de gigantiske 577-objektene (vegfunksjon) gir følgefeil og kluss i NVDB api LES.

 

I og for seg er det ingenting galt med 577 vegfunksjon: Et objekt uten egeongeometri, stedfestet på en eller flere lenkesekvenser. I praksis stedfestet på *_utrolig +mange+_* lenkesekvenser, gjerne ett objekt som dekker store deler av fylkesvegnettet i et fylke.

 

Jeg tror at antallet stedfestinger er så stort at indekseringen og/eller nvdbapi får problemer. Med så digre objekter blir det uhorvelig mange segmenteringer, i tid og rom.

 

Symptom nr 1: Spørring etter 577-objekter på fylkesveg i fylke 15 feiler, men fungerer uten filter

[https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/577?fylke=15&inkluder=alle]

 

feiler, mens spørring på andre fylker eller for hele landet fungerer. Inklusive paginering. Søket kan innsnevres med vegsystemreferanse=F, feiler fortsatt, men fungerer for vegsystemreferanse=E,R.

 

Feilen ser ut til å inntreffe på første side i paginering

 

Java klienten feiler med http 200 – error,

2020-09-11 12:54:37,185 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-1) Preparing to fetch data for 577, 1 out of 2

2020-09-11 12:55:14,825 ERROR [no.veg.nvd.RapportResource] (ForkJoinPool.commonPool-worker-1) Handling exception for job 75c031b1-dba3-4410-a837-54ed8515d3c4: java.util.concurrent.CompletionException: HTTP error 200 for request 745536aa-e8e2-a58d-bc15-71cadc9e0676: at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
 at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
 at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
 at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
 at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:163)
 Caused by: HTTP error 200 for request 745536aa-e8e2-a58d-bc15-71cadc9e0676: at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:113)
 at no.vegvesen.nvdbapi.client.clients.AsyncResult.lambda$null$0(AsyncResult.java:52)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at java.lang.Thread.run(Thread.java:748)
 Caused by: org.apache.http.ConnectionClosedException: Premature end of chunk coded message body: closing chunk expected
 at [org.apache.http.impl.io|https://slack-redir.net/link?url=http%3A%2F%2Forg.apache.http.impl.io].ChunkedInputStream.getChunkSize(ChunkedInputStream.java:263)
 at [org.apache.http.impl.io|https://slack-redir.net/link?url=http%3A%2F%2Forg.apache.http.impl.io].ChunkedInputStream.nextChunk(ChunkedInputStream.java:222)
 at org.apache.http.impl.io.ChunkedInputStream.read(ChunkedInputStream.java:183)
 at org.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:135)
 at [java.io|https://slack-redir.net/link?url=http%3A%2F%2Fjava.io].BufferedInputStream.read1(BufferedInputStream.java:284)
 at java.io.BufferedInputStream.read(BufferedInputStream.java:345)
 at java.io.FilterInputStream.read(FilterInputStream.java:133)
 at [java.io|https://slack-redir.net/link?url=http%3A%2F%2Fjava.io].BufferedInputStream.read1(BufferedInputStream.java:284)
 at java.io.BufferedInputStream.read(BufferedInputStream.java:345)
 at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
 at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
 at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
 at java.io.InputStreamReader.read(InputStreamReader.java:184)
 at com.google.gson.stream.JsonReader.fillBuffer(JsonReader.java:1291)
 at com.google.gson.stream.JsonReader.nextNonWhitespace(JsonReader.java:1329)
 at com.google.gson.stream.JsonReader.doPeek(JsonReader.java:468)
 at com.google.gson.stream.JsonReader.hasNext(JsonReader.java:415)
 at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:87)
 ... 4 more

 

 

Python:

 

ChunkedEncodingError: ('Connection broken: IncompleteRead(0 bytes read)', IncompleteRead(0 bytes read))

> /home/jajens/anaconda3/envs/mars2020/lib/python3.8/site-packages/requests/models.py(754)generate()

    752                         yield chunk

    753                 except ProtocolError as e:

--> 754                     raise ChunkedEncodingError(e)

    755                 except DecodeError as e:

    756                     raise ContentDecodingError(e)

 

Med håp om å forenkle debugging har jeg brukt X-Client = ""jajens_debug_577feil"" på denne spørringen.

 

*Symptom nr 2: Kartvisning av vegsegmenter er rotete spagetti*

 _[Bilete 1]_

Dette er definitivt ikke et godt tegn!

 

 

Når jeg leser inn 577-objekt for hele landet i QGIS ser det slik ut:

 _[Bilete 2]_

Min metode for innlesning i QGIS er å spørre etter 577?inkluder=alle. Så tar jeg ett og ett vegsegment (gyldige i dag, dvs uten sluttdato), spleiser egenskapverdier og legger vegsegmentet i kartet.

 

Det normale er jo at det ser slik ut: Ett objekt mappet til et eller flere (mange) vegsegmenter:

 _[Bilete 3]_

ObjektId 237271713 er her markert med rødt. Ett objekt, fordelt på 17 vegsegmenter får jeg det til.

 

Mens objektid   218016717 er fordelt på et eneste monster-spagettisegment på 884km. 

 _[Bilete 4]_

 

Min teori: Dette blir for uhåndterlig for leseAPI.

 

Vennlig hilsen
 Jan Kristian Jensen

Statens vegvesen, Transport og samfunn
 Transportutvikling, Transportdata
 *Besøksadresse:* Abels gate 5, TRONDHEIM
 *Mobil:* +47 40202790 *epost:* [jan.kristian.jensen@vegvesen.no|mailto:jan.kristian.jensen@vegvesen.no]
 [www.vegvesen.no|http://www.vegvesen.no/] *epost:* [firmapost@vegvesen.no|mailto:firmapost@vegvesen.no]

 ",NVDB-6937,Les-API,
"Sortere kontrakter, kontraktgrupper og brukere i admingrensesnitt","Se https://jira.kantega.no/browse/NVDB-5627

Må oppdateres til å også fungere for brukere med Chrome på engelsk.",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Test i AT av leverandør:*
 * NVDB-5605: Sjekk opplasting av SOSI-fil i saken
 * NVDB-5833: Sjekk at varsel ikke er der
 * NVDB-5766: Verifiser at kontraktsgruppenavn vises

*Test i AT av SVV:*
 * NVDB-5157: Verifiser testbeskrivelsen
 * NVDB-5721: Gjør klar en registrering til NVDB. Vent 6 timer - eller natta over og sjekk at man får beskjed om å logge inn på nytt når man forsøker å registrere.

Sak NVDB-5867 trenger ikke å eksplisitt testes i ATM.",NVDB-6937,Datafangst,
Gje notabene om mogleg overlapp,"h2. Bakgrunn

Lang sak i support/nvdb.

Det er aktuelt å lagre til dømes fortau med sideposisjon H og V, men det kan og vere aktuelt med eit 3. alternativ ""ingen sidepossisjon"".

Det same kan gjelde vegdekke med felt 1, 2 osb. og ""felt ikkje angitt"".

Det bør vere ein sjekk i Skriv på om det finnst objekt med og utan spesifisert possisjon og gje ei åtvaring/notabene om mogleg overlapp og be om å kontrollere.

h2. Analyse

Overlapp detekteres via Job-constrainten NoOverlaps. Constraints har kun ett utfall gitt en verdi som skal valideres: gyldig eller ugyldig. Dersom utfallet er ugyldig, oversettes dette til et varsel med grad feil eller advarsel avhengig av hvordan constrainten er konfiguert. Det er med andre ord ingen mekanisme for å formidle notabener ut av constraints.

h2. Løsning

Utvider constraint-rammeverket til å levere ut violations (ugyldig verdi) som i dag, men i tillegg også notabener. Dette krever i tillegg endringer i ConstraintEnforcer og alle filtere på ulike nivåer som håndhever constraints. Notabener oversettes til varsler med grad notabene.",NVDB-6937,Skriv-API,
Avvist endringssett pga overlapp,"h2. Observasjon

Fra Hans Jørgens test av NVDB-5716:

Testet i ATM: https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/328dca78-a2d8-48d4-b0c5-125cdfab4e72

Fikk prosjektet avvist med melding om overlapp mellom to objekter, 100348667 og 100348668. Dette er to strekningsobjekter som først fikk korrigert stedfesting, deretter ble de lukket.

I endringssettet havner lukkingen i ""Lukk"" og korreksjonen i ""DelvisKorriger"".

Det kan hende Trimble må gjøre en liten jobb her om dette ikke er i henhold - eks. at både korreksjon og lukking havner i delvisKorriger? Vi hadde jo en prat om dette før sommeren.

h2. Analyse

I NoOverlapsValidator kontrolleres at endrede vegobjekter i endringssettet ikke overlapper med eksisterende vegobjekter i NVDB eller andre endrede vegobjekter i endringssettet. Den sistnevnte gruppen bruker imidlertid den lukkede versjonen av vegobjektet ikke den med korrigerte stedfesting. I den lukkede versjonen er det gammel stedfesting og validatoren tolker derfor dette som overlapp.

h2. Løsning

Ved uthenting av underliggende vegobjektversjoner i validatoren må eventuelle lukkede versjoner erstattes med de korrigerte om det finnes. Å kopiere over korrigerte egenskaper fra korrigering til lukking i PrepareForDiscontinueEnricherFilter er ikke en løsning, fordi gammel stedfesting brukes til låsing (lukking fører til normallås på gammel stedfesting, korrigering fører til sekundærlås på gammel stedfesting via innlest READ-versjon) og må reflektere hvilket vegnett det manipuleres på. ",NVDB-6937,Skriv-API,
Systemfeil ved lukking av deassosierte vegobjekter,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/cd41d795-438b-46e2-8ae3-bb82657af992 havner i status SYSTEMFEIL:


{code:java}
java.util.NoSuchElementException: No value present
          at java.util.Optional.get(Optional.java:135)
          at no.vegvesen.vt.nvdb.apiskriv.validation.job.TruncateDeassociatedFeaturesEnricherFilter.lambda$null$7(TruncateDeassociatedFeaturesEnricherFilter.java:141)
          at java.util.ArrayList.forEach(ArrayList.java:1257)
          at no.vegvesen.vt.nvdb.apiskriv.validation.job.TruncateDeassociatedFeaturesEnricherFilter.lambda$createEnrichments$8(TruncateDeassociatedFeaturesEnricherFilter.java:140)
          at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
          at java.util.stream.SortedOps$SizedRefSortingSink.end(SortedOps.java:352)
          at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:483)
          at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
          at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
          at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
          at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
          at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
          at no.vegvesen.vt.nvdb.apiskriv.validation.job.TruncateDeassociatedFeaturesEnricherFilter.createEnrichments(TruncateDeassociatedFeaturesEnricherFilter.java:139)
          at no.vegvesen.vt.nvdb.apiskriv.validation.job.TruncateDeassociatedFeaturesEnricherFilter.doFilter(TruncateDeassociatedFeaturesEnricherFilter.java:84)
          at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
          at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
          at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
          at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
          at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:449)
          at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:171)
          at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
          at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
          at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
          at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

Feilen oppstår i TruncateDeassociatedFeaturesEnricherFilter som har som oppgave å lukke eller fjerne versjoner fra datterobjektet når assosiasjonen i morobjektet er fjernet i en oppdatering (med eller uten overskriving). I dette caset oppdateres morobjekt 1008991281:1 av type 919 og assosiasjonen til 1008991282:1 av type 920 er tatt vekk. I samme endringssett fjernes imidlertid datterobjektet. TruncateDeassociatedFeaturesEnricherFilter tar hensyn til eksplisitt fjernede datterobjekter, men prøver likevel (feilaktig) å gjennomføre trunkering når det ikke er noen datterobjekter igjen å trunkere. Metoden createEnrichments anropes med tom childCandidates-liste. Metoden forventer at det finnes vegobjekter der for hver fjernede assosiasjon i morobjektet og feiler derfor med NoSuchElementException.

h2. Løsning

I metoden createEnrichments kontrolleres om det faktisk finnes ikke-fjernede datterobjektversjoner før beriking skjer.",NVDB-6937,Skriv-API,
Veglenkesekvenser med åpne veglenker på tidspunkt,"Det var mulig å ha ?historisk og tidspunktpå /veglenkesekvenser uten at det har noen effekt. 
Dette ble fjernet i https://github.com/nvdb-vegdata/nvdb-rest-api/commit/4ab1b215e526f65ad3e66f6e6be7f2f499a5c1ca 

Forslag til reintrodusering av «tidspunkt»: Dersom veglenkesekvensen har en eller flere veglenkesekvenser som er åpne på tidspunktet kommer den ut.",NVDB-6937,Les-API,
Leaflet får av og til ugyldige coordinater og kaster exception,"Leaflet får av og til ugyldige koordinater og kaster en exception som ikke håndteres, som kan føre til at DF slutter å respondere.

ca 160 tilfeller siste uke

[https://sentry.kantega.org/kantega/datafangst/issues/453/]

analyser og håndter
h2. Analyse

Feilen oppstår når man har valgt norkart og er zoomet inn til nederste nivå og dobbelklikker i kartet. leaflet prøver å zoome til klikket posisjon, men får ugyldige koordinater.

Dette er en feil i leaflet, og den er ikke fikset på nyeste versjon. Det finnes en toggle slik at  man kan slå av at dobbelklikk-zoom zoomer til  musepekeren, og istedet zoomer til senter av kartvinduet. ved å toggle denne av, vil ikke feilen lenger oppstå, og det vil i de aller fleste tilfeller være ubetydelig for brukerne siden zoom til musepeker ved scroll-zoom fungerer som før.
h2. Løsning

toggle av zoom til musepeker ved dobbelklikk

 ",NVDB-6937,Datafangst,
Logg hele request og response ved feil mot Skriv,"400-feil mot Skriv er vanskelige å feilsøke i logg fordi vi bare logger et utdrag av request, og det blir som regel kutta av før dataene vi trenger.

Når det oppstår en 4xx eller 5xx burde vi ha en eksplisitt logg av hele request og response, sånn at vi kan finne ut av det.",NVDB-6937,Datafangst,
Presentere 400-feil fra Skriv for bruker,"Forrige runde da vi så på 400-feil fra Skriv ble vi etter litt diskusjon (med Tore) enige om å _ikke_ prøve å parse disse og presentere de til bruker. Ser i det siste at vi har fått såpass mange av dem, og det er en gjenganger på support. Dette er bl.a. fordi antall stedfestingsfeil har økt, og mye verdivalidering på stedfesting gjøres på en måte som gir 400 heller enn 200 med feilrapport.

Mye stedfestingsfeil er forhåpentligvis en forbigående fase, men siden Skriv validerer så mye i den fasen som gir 400-feil så bør det vurderes å gjøre noe for å presentere disse meldingene til bruker.

Vi må kunne parse feilmelding, men den er strukturert og kan mappes tilbake til request, som vi fortsatt har i dette tilfellet. Siden dette er en mekanisme som ligger i XML-biblioteket så risiker at formatet endrer seg uten at det er villet fra Skriv, men det vil antakeligvis i verste fall bare skje i en ny major-versjon av biblioteket.",NVDB-6937,Datafangst,
Sentry: Uhåndtert feilsituasjon ved henting av vegnet,"h2. Observasjon

[https://sentry.kantega.org/kantega/datafangst/issues/11/events/81073/]

Det ser ut som kall til vegnettet av og til feiler. når det skjer, kastes det en exeption som ikke håndteres, og som kan forårsake at DF ikke responderer.

ca 70 tilfeller siste 14 dager

Analyser og legg inn feilhåndtering
h2. Analyse

Her er det snakk om feil som oppstår når DF ikke håndterer at kall til vegnett feiler av ymse årsaker. Når det skjer, kastes en exception fordi en promise blir rejected og ikke håndtert.

Kan gjenskapes ved å f.eks blokkere kallet i devtool.
h2. Løsning

Legg inn error håndtering som returnerer null ved feilet kall. Når null returneres til redux, vil redux bare ignorere det og fortsette å vise vegnettet vi allerede har og prøve på nytt ved neste panorering, og vise en feilmelding.

 ",NVDB-6937,Datafangst,
"Får ikkje med alle objekt i CSV-eskport ved ""store"" kartutsnitt","Melding om mogleg feil frå Jan Kristian Jensen. Det er vel ei øvre grense for talet på objekt som vert med i Vegkart og i eksport ved store kartutsnitt, men det han viser til her ser ikkje ut til å skulle ha så store mengder data.

Melding: 

CSV-eksport av _Bruksklasse, tømmertransport_ får ikke med alt av data innafor kartutsnitt når kartutsnittet dekker store områder. Eksempel på område som feiler nedenfor. Lett å verifisere: Last ned CSV og hiv dem i kart, så ser du at vi er langt unna å ha heldekkende data. Spørring direkte mot NVDB api gir ønsket resultat, uavhengig av kartutsnitt.

 

Zoomer man inn til mindre område så får man heldekkende data for det mindre området. Uavklart hvor eksakt grense for stort kartutsnitt / antall objekter kan være før problemet inntreffer.

 

_En observasjon fra dem som knadde på data fra det store kartutsnittet: Ingen objektId som startet med sifrene «10» eller «8». Aner ikke om dette er verdifullt for feilsøking._",NVDB-6937,Eksport,
Leveranseinformasjon,"*Test i AT av leverandør:*
 * NVDB-5799: Ta inn et eksisterende NVDB-objekt og verifiser brukergrensesnittet når man sletter/angrer koblinger. Sjekk at objektene ikke er dirty etter å ha angret en kobling.
 * NVDB-5877: Sjekk at NVDB-tilstand tilbakestilles etter at ny kobling slettes.
 * NVDB-5834: Manipuler opplastet data til 6173/NN54 og registrer. Verifiser at 5973 da benyttes.

*Test i AT av SVV:*
 * NVDB-5847: Logg inn med en SVV- og epost-bruker. Bruk gjerne en SVV-bruker som har æ/ø/å i passordet.

NVDB-5866 trenger ikke å testes eksplisitt i ATM.",NVDB-6937,Datafangst,
"Sletting av ny kobling oppdaterer ikke ""dirty""","h2. Observasjon
# Koble et nytt skilt til et importert skiltpunkt
# Fjern kobling igjen, skiltpunkt skal da ikke ha noen endringer
# Skiltpunkt vises fortsatt med endringer (""dirty"" satt i database)

h2. Analyse
Ved sletting av ny kobling (som da blir fjernet fra database) trenger vi en sjekk på om parent er uendret, på samme måte som det er gjort i NVDB-5799.",NVDB-6937,Datafangst,
Punktgeometri ruteberegnes til to like punktstedfestinger,"h2. Observasjon

Følgende input til rute-endepunktet:

 geometri = ""POINT (270196.99 7041858.13)""
 maks_avstand = ""100""
 konnekteringslenker = false
 detaljerte_lenker = false
 vegsystemreferanse = ""F,K,E,R""
 trafikantgruppe = null
 typeveg = ""kanalisertVeg,enkelBilveg,rampe,rundkjøring""
 tidspunkt_start = ""2020-01-01""
 tidspunkt_slutt = null
 pretty = false
 kortform = false

Responderer to instanser av samme punktstedfesting:

vegnettsrutesegmenter = {java.util.ArrayList@19885}  size = 2
 0 = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.DetaljertRuteSegment@19888} 
  veglenkesekvensid = {java.lang.Long@19903} 2510771
  startposisjon = {java.lang.Double@19904} 0.1429407
  sluttposisjon = {java.lang.Double@19905} 0.1429407
  kortform = ""0.1429407@2510771""
  veglenkenummer = {java.lang.Integer@19894} 1
  startnode = null
  sluttnode = null
  type = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Type@19895} ""HOVED""
  detaljnivå = ""Vegtrase""
  typeVeg = ""Kanalisert veg""
  feltoversikt = {java.util.ArrayList@19909}  size = 4
  geometri = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Geometri@19910} 
  lengde = {java.lang.Double@19911} 0.0
  vegsystemreferanse = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Vegsystemreferanse@19912} 
 1 = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.DetaljertRuteSegment@19889} 
  veglenkesekvensid = {java.lang.Long@19890} 2510771
  startposisjon = {java.lang.Double@19891} 0.1429407
  sluttposisjon = {java.lang.Double@19892} 0.1429407
  kortform = ""0.1429407@2510771""
  veglenkenummer = {java.lang.Integer@19894} 1
  startnode = null
  sluttnode = null
  type = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Type@19895} ""HOVED""
  detaljnivå = ""Vegtrase""
  typeVeg = ""Kanalisert veg""
  feltoversikt = {java.util.ArrayList@19898}  size = 4
  geometri = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Geometri@19899} 
  lengde = {java.lang.Double@19900} 0.0
  vegsystemreferanse = {no.vegvesen.vt.nvdb.apiskriv.localization.nvdbapiread.binding.Vegsystemreferanse@19901} ",NVDB-6937,Les-API,
Leveranseinformasjon,"*Test i ATM av leverandør:*
 * NVDB-5874: Kall url i beskrivelsen for å verifisere at norske tegn støttes. Sørg for at en bruker med norske tegn testes.

Øvrige saker på 2020.13 leveranser trenger ikke eksplisitt testing i AT.

Denne leveransen vil forøvrig inkludere 2020.12.1, hvor NVDB-5874 er fix på denne. Se derfor også NVDB-5850.",NVDB-6937,Skriv-API,
Anrop SoaBasis feiler for bruker med norske tegn i navnet,"h2. Observasjon

Bruker Jørn Maurseth får exception-respons fra https://www.test.vegvesen.no/nvdb/apiskriv/rest/v1/ldap/bruker/jormau etter utrulling av 2020-12.1:

{code:xml}
<fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1"">
  <message>javax.xml.ws.WebServiceException: java.lang.IndexOutOfBoundsException: start 0, end 4496, s.length() 4493</message>
  <message>java.lang.IndexOutOfBoundsException: start 0, end 4496, s.length() 4493</message>
  <message>start 0, end 4496, s.length() 4493</message>
</fault>{code}

h2. Analyse

Problemet oppstår i LoggingSoapHandler. Innholdet i responsen fra SoaBasis skal logges, men bare inntil et visst antall tegn eller hele meldingen om den er liten nok. Antall tegn som skal logges beregnes imidlertid fra stream'ens size() ikke lengden på den encodede strengen. Dersom meldingen inneholder norske tegn vil disse to størrelsene være forskjellige. Dermed oppstår IndexOutOfBoundsException.

h2. Løsning

Hentet meldingen inn i en lokal strengvariabel (encodet) og bruker denne sin lengde ved logging.",NVDB-6937,Skriv-API,
Støtte realm external,"Legg til mulighet til å ha usertype: external, og sett opp tokenvalidatorer for dette. ",NVDB-6937,Les-API,
Noen brukere får ikke hentet roller ved innlogging,"Etter at henting av roller ble innført ved innlogging feiler innlogging for noen brukere fordi rolle-kallet feiler. Skriv krever en gitt rolle av bruker, selv om det er brukers egne data som hentes.

Løsning er å bruke systembruker ved henting av roller.",NVDB-6937,Datafangst,
500 for request med kontraktsområde,"https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/570?kartutsnitt=-32466.553,6734380.598,-32307.886,6734474.525&kontraktsomrade=4604+Bergen-Os-Austevoll++2021-2026&segmentering=true&inkluder=metadata,egenskaper,lokasjon,geometri",NVDB-6937,Les-API,
Exception lekker til std. out.,"Disse havner i std. out. Og muligens også i vanlig logg. 
Forhindre at de havner i std. out.
{quote}
2020-09-07 09:44:49.438 level=""SEVERE"" message=""An I/O error has occurred while writing a response message entity to the container output stream."" source=""org.glassfish.jersey.server.ServerRuntime$Responder writeResponse"" trace=""
org.glassfish.jersey.server.internal.process.MappableException: HTTP[500] Error[Code=(5001) Message=(Error from server at http://svvpnvdbsolr06.vegvesen.no:8983/solr/nvdb-roadobjects:  org.apache.catalina.connector.ClientAbortException: java.io.IOException: Connection reset by peer)] 
	at org.glassfish.jersey.server.internal.MappableExceptionWrapperInterceptor.aroundWriteTo(MappableExceptionWrapperInterceptor.java:67)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor.proceed(WriterInterceptorExecutor.java:139)
	at org.glassfish.jersey.message.internal.MessageBodyFactory.writeTo(MessageBodyFactory.java:1115)
	at org.glassfish.jersey.server.ServerRuntime$Responder.writeResponse(ServerRuntime.java:638)
	at org.glassfish.jersey.server.ServerRuntime$Responder.processResponse(ServerRuntime.java:371)
	at org.glassfish.jersey.server.ServerRuntime$Responder.process(ServerRuntime.java:361)
	at org.glassfish.jersey.server.ServerRuntime$1.run(ServerRuntime.java:256)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:248)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:244)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:292)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:274)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:244)
	at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:265)
	at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:232)
	at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:680)
	at org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:392)
	at org.glassfish.jersey.servlet.WebComponent.service(WebComponent.java:346)
	at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:365)
	at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:318)
	at org.glassfish.jersey.servlet.ServletContainer.service(ServletContainer.java:205)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at io.smallrye.metrics.jaxrs.JaxRsMetricsServletFilter.doFilter(JaxRsMetricsServletFilter.java:53)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at ch.qos.logback.classic.selector.servlet.LoggerContextFilter.doFilter(LoggerContextFilter.java:69)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at no.vegvesen.nvdb.shared.web.filters.RateLimiterFilter.lambda$doFilter$0(RateLimiterFilter.java:73)
	at io.github.resilience4j.ratelimiter.RateLimiter.lambda$decorateCheckedRunnable$3(RateLimiter.java:248)
	at io.vavr.control.Try.run(Try.java:118)
	at no.vegvesen.nvdb.shared.web.filters.RateLimiterFilter.doFilter(RateLimiterFilter.java:76)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at no.vegvesen.nvdb.shared.web.filters.AcceptFilter.doFilter(AcceptFilter.java:71)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.logging.log4j.web.Log4jServletFilter.doFilter(Log4jServletFilter.java:71)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:543)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:139)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:609)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:818)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1623)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.Thread.run(Thread.java:748)
Caused by: HTTP[500] Error[Code=(5001) Message=(Error from server at http://svvpnvdbsolr06.vegvesen.no:8983/solr/nvdb-roadobjects:  org.apache.catalina.connector.ClientAbortException: java.io.IOException: Connection reset by peer)] 
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.translate(SolrClientWrapperImpl.java:144)
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.queryAndStreamResponse(SolrClientWrapperImpl.java:99)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.lambda$queryAndStreamResponse$1(SolrBulkHead.java:42)
	at io.github.resilience4j.bulkhead.Bulkhead.lambda$decorateCallable$4(Bulkhead.java:177)
	at io.github.resilience4j.bulkhead.Bulkhead.executeCallable(Bulkhead.java:525)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.tryQuery(SolrBulkHead.java:48)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.queryAndStreamResponse(SolrBulkHead.java:42)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectService.query(RoadObjectService.java:247)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectService.segmented(RoadObjectService.java:220)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectService.executeRequest(RoadObjectService.java:206)
	at no.vegvesen.nvdbapi.v3.web.resources.RoadObjectResource.lambda$getObjectList$1(RoadObjectResource.java:146)
	at no.vegvesen.nvdb.shared.StreamingOutputWrapper.write(StreamingOutputWrapper.java:52)
	at org.glassfish.jersey.message.internal.StreamingOutputProvider.writeTo(StreamingOutputProvider.java:55)
	at org.glassfish.jersey.message.internal.StreamingOutputProvider.writeTo(StreamingOutputProvider.java:37)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor$TerminalWriterInterceptor.invokeWriteTo(WriterInterceptorExecutor.java:242)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor$TerminalWriterInterceptor.aroundWriteTo(WriterInterceptorExecutor.java:227)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor.proceed(WriterInterceptorExecutor.java:139)
	at org.glassfish.jersey.server.internal.JsonWithPaddingInterceptor.aroundWriteTo(JsonWithPaddingInterceptor.java:85)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor.proceed(WriterInterceptorExecutor.java:139)
	at org.glassfish.jersey.server.internal.MappableExceptionWrapperInterceptor.aroundWriteTo(MappableExceptionWrapperInterceptor.java:61)
	... 58 more
Caused by: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://svvpnvdbsolr06.vegvesen.no:8983/solr/nvdb-roadobjects:  org.apache.catalina.connector.ClientAbortException: java.io.IOException: Connection reset by peer
	at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:638)
	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:265)
	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:248)
	at org.apache.solr.client.solrj.impl.LBSolrClient.doRequest(LBSolrClient.java:368)
	at org.apache.solr.client.solrj.impl.LBSolrClient.request(LBSolrClient.java:296)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.sendRequest(BaseCloudSolrClient.java:1128)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.requestWithRetryOnStaleState(BaseCloudSolrClient.java:897)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.request(BaseCloudSolrClient.java:829)
	at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:211)
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.queryAndStreamResponse(SolrClientWrapperImpl.java:95)
	... 76 more
Caused by: java.lang.RuntimeException: org.apache.catalina.connector.ClientAbortException: java.io.IOException: Connection reset by peer
	at com.google.common.base.Throwables.propagate(Throwables.java:241)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectStreamer.streamSolrDocument(RoadObjectStreamer.java:63)
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl$TimingStreamingResponseCallback.streamSolrDocument(SolrClientWrapperImpl.java:208)
	at org.apache.solr.client.solrj.impl.StreamingBinaryResponseParser$3.readSolrDocument(StreamingBinaryResponseParser.java:135)
	at org.apache.solr.common.util.JavaBinCodec.readObject(JavaBinCodec.java:330)
	at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:281)
	at org.apache.solr.client.solrj.impl.StreamingBinaryResponseParser$3.readSolrDocumentList(StreamingBinaryResponseParser.java:164)
	at org.apache.solr.common.util.JavaBinCodec.readObject(JavaBinCodec.java:332)
	at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:281)
	at org.apache.solr.common.util.JavaBinCodec.readOrderedMap(JavaBinCodec.java:225)
	at org.apache.solr.common.util.JavaBinCodec.readObject(JavaBinCodec.java:299)
	at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:281)
	at org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:194)
	at org.apache.solr.client.solrj.impl.StreamingBinaryResponseParser.streamDocs(StreamingBinaryResponseParser.java:170)
	at org.apache.solr.client.solrj.impl.StreamingBinaryResponseParser.processResponse(StreamingBinaryResponseParser.java:62)
	at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:636)
	... 85 more
Caused by: org.apache.catalina.connector.ClientAbortException: java.io.IOException: Connection reset by peer
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:330)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:293)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:118)
	at org.glassfish.jersey.servlet.internal.ResponseWriter$NonCloseableOutputStreamWrapper.flush(ResponseWriter.java:306)
	at org.glassfish.jersey.message.internal.CommittingOutputStream.flush(CommittingOutputStream.java:263)
	at org.glassfish.jersey.message.internal.WriterInterceptorExecutor$UnCloseableOutputStream.flush(WriterInterceptorExecutor.java:281)
	at java.io.FilterOutputStream.flush(FilterOutputStream.java:140)
	at com.fasterxml.jackson.core.json.UTF8JsonGenerator.flush(UTF8JsonGenerator.java:1153)
	at no.vegvesen.nvdbapi.common.serialization.json.JsonGeneratorEx.flush(JsonGeneratorEx.java:257)
	at no.vegvesen.nvdbapi.serialization.roadobjects.RoadObjectJsonSerializer.write(RoadObjectJsonSerializer.java:113)
	at no.vegvesen.nvdbapi.serialization.roadobjects.RoadObjectsJsonSerializer.write(RoadObjectsJsonSerializer.java:55)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectStreamer.streamSolrDocument(RoadObjectStreamer.java:59)
	... 99 more
Caused by: java.io.IOException: Connection reset by peer
	at sun.nio.ch.FileDispatcherImpl.write0(Native Method)
	at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47)
	at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)
	at sun.nio.ch.IOUtil.write(IOUtil.java:65)
	at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:468)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:136)
	at org.apache.tomcat.util.net.NioBlockingSelector.write(NioBlockingSelector.java:101)
	at org.apache.tomcat.util.net.NioSelectorPool.write(NioSelectorPool.java:157)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1308)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:692)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:645)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:635)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:646)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:166)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:252)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1379)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:405)
	at org.apache.coyote.Response.action(Response.java:206)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:326)
	... 110 more
{quote}",NVDB-6937,Les-API,
Oppgradere til Flyway 5,"Mellomsteg i oppdatering, kreves for å kunne gå opp på Flyway 6 som er versjonen som Quarkus bruker.

Må gjøres etter at Flyway 4 (NVDB-5866) er i prod.",NVDB-6937,Datafangst,
Oppgradere Flyway til versjon 4,"Flyway kan bare oppdateres én major-versjon om gangen, detter er første steg for å komme à jour.",NVDB-6937,Datafangst,
Logging av Exceptions i IntelliJ,"Logging lokalt i console i IntelliJ er litt håpløst.

Fiks slik at det logges feilmelding (log ERROR ikke WARN i Exceptionmapper)
Slutt å log request payloads i console",NVDB-6937,Datafangst,
Mangler filtrering på kryss og sideanlegg ved vegsystemreferansesøk i /veg,"https://nvdbapiles-v3.atlas.vegvesen.no/veg\?vegsystemreferanse\=Fv704S1D1m0 gir vekslende svar. 
Det er fordi det er kryss og sideanlegg der, vi må legge på ekskludering av kryss og sideanlegg når det ikke inngår i vegsystemreferansen.",NVDB-6937,Les-API,
Endepunkt for etablering av OIDC-token,"For å forenkle livet til NVDB API Skriv sine klienter ved overgang til Atlas, skal det utvikles endepunkter for å:

- etablere OIDC-tokens (idToken + refreshToken)
- refreshe et idToken

Inspirasjon kan hentes fra AuthResource i NVDB API Les.",NVDB-6937,Skriv-API,
Omruting til OIDC pålogging i Kontrollpanel og Generator,"SSO fungerer ikke med OpenIdConnect-baserte applikasjoner og de må derfor selv rute om til påloggingssiden for å få etablert et JWT-token. Generator og Kontrollpanel må utvides med denne omrutingen i den versjonen av NVDB API Skriv som kjører på Atlas.

Atlas-gjengen har ferdiglaget JavaScript som kan brukes til dette formålet.

Se også:

https://github.com/nvdb-vegdata/nvdb-admin/tree/master/src/main/webapp/browser/svv-login-page
https://github.com/nvdb-vegdata/nvdb-admin/blob/master/src/main/webapp/browser/app.jsx
https://www.npmjs.com/package/oidc-client
https://git.vegvesen.no/projects/NVDBDATA/repos/atlas-config/browse/nvdbapil/utvikling-v3/services.json#12",NVDB-6937,Skriv-API,
Stedfesting gir like start og sluttpunkt,"h2. Observasjon

Fra support. Stedfest vedlagte SOSI automatisk. Deretter stedfest KURVE 2 til RA9 (veien ligger rett ved). Da blir stedfestingen delt i to hvor hver bit har lik start og slutt. Gjenskapt på df-utv.

[https://datafangst.kantega.no/#!/contract/81f608cd-c711-46f0-9923-df63846a1ea7/locational2]

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.12-2020.09.02/doc/?id=r4XvTXQBsUoQFJJym18g]

Fra Prod: select * from feature_locational2 where feature_id='5af85066-4058-4a5c-82c6-96bbcb2245f3';

Se forøvrig KURVE 1 og KURVE 3 hvor KURVE 2 burde fått posisjon mellom disse. Ta også en titt på [https://nvdb-vegdata.github.io/nvdb-visrute/PROD/] som viser hvilken rute Les ville valgt, hvor den inkluderer delene mellom KURVE 1 og KURVE 3 (bruk startposisjon ""66235.3397186895,6598615.837483798"" og sluttposisjon ""66652.66353714647,6597105.584636308"" med vegsystemreferanse ""RA"". Da får du lenker som 

[https://nvdbapiles-v3.atlas.vegvesen.no/beta/vegnett/rute?start=66235.3397186895,6598615.837483798&slutt=66652.66353714647,6597105.584636308&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&vegsystemreferanse=RA&pretty=true&kortform=true]

Dvs at stedfesting skulle vært noe a la 

0.0-003@3103849

0.0-1.0@3103848

0.999-1.0@3103847",NVDB-6937,Datafangst,
"Meir informasjon i ""Velkommen til Datafangst!""-mailen.","[~hans.alien@vegvesen.no] foreslår å legge til meir informasjon i ""Velkommen""-mailen som nye brukarar i DF får:

Jeg foreslår at invitasjonseposten utvides til å inneholde navn og kontaktinfo på forvalteren som inviterer, samt muligens tips om å kontakte vedkommende dersom fristen er passert.
----
Etter litt diskusjon tror vi at det som Hans Anton egentlig vil oppnå er at brukere som blir invitert inn på kontrakt vet hva de skal gjøre når de 7 dagene som lenke for registrering har gått ut.

En god måte å oppnå det på er å vise til veiviseren for innloggingsproblemer ([https://datafangst.kantega.no/noauth/#!/user/login-help)] nederst i malen for mail som sendes når ny bruker er gitt tilgang på kontrakt.

I første omgang trenger vi ikke å ha med navn og kontaktinfo for forvalter, dette var basert på en feilaktig antakelse om at forvalter kunne løse dette ved å legge til deltaker på kontrakten på nytt.",NVDB-6937,Datafangst,
"Autentisering med AAA-tjenesten, avvikle OpenAM","OpenAM fases ut.
Datafangst må ta i bruk AAA-tjenesten.

OpenAM er på veg ut, så DF bør snarest omprogrammeres til å autentisere via AAA-tjenesten. Dette er en fasade-tjeneste som dekobler klienter fra underliggende IAM-teknologi og gjør derfor livet enklere for alle parter.

https://apiskriv.vegdata.no/autentisering",NVDB-6937,Datafangst,
Rettigheter blir ikke satt riktig for brukere,"h2. Observasjon

Fra support. En bruker ""ERLSON"" var lagt til som kontraktsgruppeforvalter på gruppe ""TOG BjB40"". Denne fikk ikke de rettighetene denne skulle ha. Etter at han ble lagt inn som ""erlson"" fikk han de rettighetene han skulle ha. Se vedlegg som viser rettigheter for ""eivgil"" på samme gruppe.

select * from user_role where username in ('eivgil', 'EIVGIL');

For å se om jeg fikk gjenskapt fjernet jeg ""rikrye"" fra ""TEST"" i df-utv og la henne inn som ""RIKRYE"". Da kommer på spørringen over innslag for ""rikrye"" og ""RIKRYE"". Dette observerte jeg imidlertid ikke i Prod da caps-lock bruker ikke var med overhodet. Men det bør sees på hva som skjer når man legger inn bruker med små vs store boksatver.

h2. Forslag til løsning
Brukernavn konverteres til små bokstaver før det lagres i database.",NVDB-6937,Datafangst,
Sjekk at transaksjon under behandling blir tatt ved oppstart,"Vi trenger sjekke at transaksjonen som er under behandling ved restart av NVDBIND blir tatt opp på nytt når applikasjonen starter igjen. 

Transaksjon 4923822 2020-08-31 14:35:06 ble avbrutt, og en annen transaksjon var første som ble behandlet etter oppstart.


*Analyse*
I dette tilfellet er det flere ting som tilsammen gjør at dette skjedde. Transaksjoner blir lest inn i batcher til IND, og de blir sortert på tid fra transaksjonsid-en før de legges i kø for prosessering. Det er noe tidsforsinkelse på tidspunkt i transaksjonsid og når transkasjonen er skrevet til NVDB. Dette har gjort at den ikke ble lest og sortert riktig av IND, den har sansyligvis kommet i neste batch og blitt sortert sammen med transaksjonene der.

Når en transaksjon er ferdig behandlet i IND blir syncInfo-fila oppdatert med tidspunktet til den aktuelle transaksjonen.
I dette tilfellet ble en transaksjon med senere tidspunkt prosessert først slik at syncInfo hadde tidspunkt som var senere og derfor ble ikke den aktuelle transaksjonen plukket opp igjen ved start.

Det er også en mekanisme i IND som gjør at IND sjekker 10 minutter (konfigurerbart) tilbake i tid ved oppstart igjen. Da er det 10 minutter fra sist sjekket tidspunkt. I tilfellet her lå vi noen timer bak, så derfor ble ikke transaksjonen fanget opp av denne mekanismen.

Behandling i skriv, https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/e69edce1-4d9b-4760-a9cd-01acbd94b9fb, ser at ""4923822 2020-08-31 14:35:06"" ble skrevet ca 30 sekunder etter, ""2020-08-31 14:35:36.742	STORED_IN_NVDB""


*Løsning*
Gjør ikke noe med dette nå, men det vil bli løst av https://jira.kantega.no/browse/NVDB-4181 der køa skrives til disk. Da mister man ikke transaksjoner som allerede er lagt til køa ved omstart.",NVDB-6937,NVDB-IND,
Statistikkspørringer med område feiler,"På grunn av endringer i dokumentene i NVDB-5738 feiler statistikkspørringer.
Apiet:
{quote}
2020-09-01T13:59:47,798+0200 TRANSID=""b906016b-2c43-6ed1-96f8-188a0466ae85"" SEVERITY=""ERROR"" ORIGIN=""GenericExceptionMapper"" MESSAGE=""Unexpected exception encountered for URL: http://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/902/statistikk?kartutsnitt=-93364.246%2C7289338.623%2C1640612.555%2C8165809.709&vegsystemreferanse=P&segmentering=true""
no.vegvesen.nvdbapi.common.exceptions.SolrCommunicationException: HTTP[500] Error[Code=(5001) Message=(No live SolrServers available to handle this request:[http://svvpnvdbsolr12.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr11.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr14.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr07.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr13.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr08.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr09.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr15.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr06.vegvesen.no:8983/solr/nvdb-roadobjects])] 
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.translate(SolrClientWrapperImpl.java:124)
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.query(SolrClientWrapperImpl.java:66)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.lambda$query$0(SolrBulkHead.java:37)
	at io.github.resilience4j.bulkhead.Bulkhead.lambda$decorateCallable$4(Bulkhead.java:177)
	at io.github.resilience4j.bulkhead.Bulkhead.executeCallable(Bulkhead.java:525)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.tryQuery(SolrBulkHead.java:48)
	at no.vegvesen.nvdbapi.common.solr.SolrBulkHead.query(SolrBulkHead.java:37)
	at no.vegvesen.nvdbapi.data.service.roadobject.RoadObjectService.getStats(RoadObjectService.java:153)
	at no.vegvesen.nvdbapi.v3.web.resources.RoadObjectResource.lambda$getStats$2(RoadObjectResource.java:178)
	at no.vegvesen.nvdb.shared.StreamingOutputWrapper.write(StreamingOutputWrapper.java:52)
	...
	at java.lang.Thread.run(Thread.java:748)
Caused by: org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request:[http://svvpnvdbsolr12.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr11.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr14.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr07.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr13.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr08.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr09.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr15.vegvesen.no:8983/solr/nvdb-roadobjects, http://svvpnvdbsolr06.vegvesen.no:8983/solr/nvdb-roadobjects]
	at org.apache.solr.client.solrj.impl.LBSolrClient.request(LBSolrClient.java:345)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.sendRequest(BaseCloudSolrClient.java:1128)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.requestWithRetryOnStaleState(BaseCloudSolrClient.java:897)
	at org.apache.solr.client.solrj.impl.BaseCloudSolrClient.request(BaseCloudSolrClient.java:829)
	at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:211)
	at org.apache.solr.client.solrj.SolrClient.query(SolrClient.java:1035)
	at no.vegvesen.nvdbapi.common.solr.SolrClientWrapperImpl.query(SolrClientWrapperImpl.java:61)
	... 74 common frames omitted
Caused by: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://svvpnvdbsolr08.vegvesen.no:8983/solr/nvdb-roadobjects: Error from server at null: Parent query must not match any docs besides parent filter. Combine them as must (+) and must-not (-) clauses to find a problem doc. docID=6234
	at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:665)
	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:265)
	at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:248)
	at org.apache.solr.client.solrj.impl.LBSolrClient.doRequest(LBSolrClient.java:368)
	at org.apache.solr.client.solrj.impl.LBSolrClient.request(LBSolrClient.java:319)
	... 80 common frames omitted
{quote}
Solr:
{quote}
2020-09-01T11:11:20.542+0000 ERROR (qtp124734309-36389) [c:nvdb-roadobjects s:shard1 r:core_node56 x:nvdb-roadobjects_shard1_replica_n55] o.a.s.s.HttpSolrCall null:java.lang.IllegalStateException: Parent query must not match any docs besides parent filter. Combine them as must (+) and must-not (-) clauses to find a problem doc. docID=748
	at org.apache.lucene.search.join.ToChildBlockJoinQuery$ToChildBlockJoinScorer.validateParentDoc(ToChildBlockJoinQuery.java:276)
	at org.apache.lucene.search.join.ToChildBlockJoinQuery$ToChildBlockJoinScorer.access$300(ToChildBlockJoinQuery.java:132)
	at org.apache.lucene.search.join.ToChildBlockJoinQuery$ToChildBlockJoinScorer$1.nextDoc(ToChildBlockJoinQuery.java:178)
	at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:265)
{quote}
",NVDB-6937,Les-API,
Takler ikke datakatalogoppdatering når IND er stoppet,"Dersom NVDB får en datakatalogoppdatering mens NVDBIND er stoppet vil NVDBIND stoppe med 
{quote}
2020-08-31 17:39:54 [taskexecutor] ERROR TaskExecutor - Task FullExport() failed 
no.vegvesen.nvdbind.OutdatedDatakatException: Exported datakatalog is out of date, exported version: 2.21 current version: 2.22
	at no.vegvesen.nvdbind.tasks.DatakatTask.checkCurrent(DatakatTask.java:61)
	at no.vegvesen.nvdbind.tasks.DatakatTask.run(DatakatTask.java:41)
	at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:209)
	at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:149)
	at no.vegvesen.nvdbind.tasks.DefaultTaskExecutionContext.execute(DefaultTaskExecutionContext.java:42)
	at no.vegvesen.nvdbind.tasks.FullExportTask.run(FullExportTask.java:36)
	at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:201)
	at no.vegvesen.nvdbind.tasks.TaskExecutor.start(TaskExecutor.java:115)
	at no.vegvesen.nvdbind.NvdbindCore$TaskExecutorThread.run(NvdbindCore.java:503)
{quote}
ved oppstart.",NVDB-6937,NVDB-IND,
Systemfeil pga NPE i NoOverlapsValidator,"h2. Observasjon

Dette endringssettet får NPE og systemfeil:

[https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/9bd15214-1dcd-425b-852c-d5030654caa8]

Stacktrace:

{code:java}
java.lang.NullPointerException: from can't be null
	at java.util.Objects.requireNonNull(Objects.java:228)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Lifetime.<init>(Lifetime.java:52)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Lifetime.between(Lifetime.java:48)
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.getLifetime(Feature.java:294)
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.hasCommonLifetimeWith(Feature.java:312)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.shouldValidateOverlap(NoOverlapsValidator.java:100)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.isValid(NoOverlapsValidator.java:52)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.job.NoOverlapsValidator.isValid(NoOverlapsValidator.java:30)
	at no.vegvesen.vt.nvdb.apiskriv.domain.validation.ConstraintEnforcer.enforce(ConstraintEnforcer.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.ConstraintJobFilter.doFilter(ConstraintJobFilter.java:28)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:449)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:171)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

I endringssettet bestilles lukking vegobjekt type 301, id 82383926, versjon 1. I NVDB er imidlertid versjon 2 den siste versjonen: https://www.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/301/82383926. Dette avdekkes korrekt i filteret PrepareForDiscontinueEnricherFilter, og en valideringsfeil registreres. Videre behandling avbrytes imidlertid ikke med anrop til ValidationResult.abortProcessing(). Dermed fortsetter valideringen og i JobConstraint'en NoOverlapsValidator havarerer behandlingen fordi vegobjektet som lukkes mangler startdato. I endringssettet er kun sluttdato angitt ved lukking, men PrepareForDiscontinueEnricherFilter vil kopiere inn startdato fra originalen i NVDB. I og med at det ble avdekket valideringsfeil der, skjedde ikke det.

h2. Løsning

I PrepareForDiscontinueEnricherFilter anropes ValidationResult.abortProcessing() dersom det er versjonsfeil eller vegobjektversjonen allerede er lukket. Dermed vil behandling avsluttes korrekt med valideringsfeil i dette tilfellet.",NVDB-6937,Skriv-API,
Konvertering av geometri ved innsending fungerer ikke,"En live case fra support der et vegobjekt med geometri med srid 6173 / NN54, som Skriv ikke godtar, skulle ha blitt konvertert ved innsending, men det blir det ikke.

Skriv avviser med validerings-feilmelding om at geometritype er ugyldig.

Geometrien er lagret slik i databasen :


{code:java}
{
   ""type"":""POINT"",
   ""representationPoint"":null,
   ""shape"":{
      ""@class"":""no.svv.nvdb.datafangst.domainmodel.geometry.shapes.Point"",
      ""position"":{
         ""northing"":6964293.98026751,
         ""easting"":173496.768292179,
         ""height"":14.4938896217843
      }
   },
   ""srid"":6173,
   ""heightRef"":""NN54"",
   ""properties"":{
      ""map"":{
         ""MEASUREMENT_METHOD"":""97"",
         ""ACCURACY_HEIGHT"":""0""
      }
   },
   ""length"":0.0,
   ""operation"":""WRITE""
}
{code}
",NVDB-6937,Datafangst,
Fjern varsel om ny stedfesting,"på stedfesting vises et varsel om at du bruker ny stedfesting, og at man kan klikke her for å gå til gammel.

Fjern varselet, men behold feature toggle i admin.",NVDB-6937,Datafangst,
Mangler informasjon om barn under relasjoner,"h2. Observasjon

Ved å inkludere relasjoner så er det enkelte barn som ikke gir annen info enn kun id. Mangler href og relasjoner.

Eksempler:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/67/78728421/3.json?dybde=3&inkluder=relasjoner]

(søk etter _78728481_)

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/67/78729244/9.json?dybde=3&inkluder=relasjoner]

(søk etter _78729865)_

Analyse:
Eksempel 1) Type 461 er ikke indeksert i UTV, sannsynligvis derfor objektinfo ikke kommer ut, det kommer i de andre miljøene
Eksempel 2) Objektet som kun har id er lukket, derfor blir det ikke hentet ut i solr-spørringen som bruker dato som del av spørreparamter.",NVDB-6937,Les-API,
Startdato blir ikke oppdatert for kontinuerlig sammenhengende segmenter i tid med ulik ID,"For søk som dette, der segmenter har fått oppdatert Locational-objektet gjennom tid, får vi ikke oppdatert datofeltet:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?start=13538.741999999387,6696449.226&slutt=15041.6770000002,6696842.327999998&maks_avstand=10&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&pretty=true&tidspunkt_start=2011-03-20&tidspunkt_slutt=2011-03-26&kortform=false]

Søket treffer disse to segmentene:

!Screenshot from 2020-08-25 16-42-43.png|thumbnail!

Det må altså utføres en ekstra sjekk på start- og sluttnode for å avgjøre om to segmenter skal ""slås sammen"" i tid.

 ",NVDB-6937,Les-API,
Mødre og døtre fra NVDB må også kunne flyttes inn til mor,"h2. Observasjon

Vi har logikk fra gamle dager da NVDB-objekter kun ble brukt som referanse, som hindrer døtre fra nvdb til å flyttes inn til sin mor.

Nå i moderne dager kan vi importere objekter fra nvdb for endring, og de kan få ny stedfesting, og da må vi også tillate at vi flytter dem inn til sin mor.

I praksis betyr dette at hvis dataforvalter re-stedfester NVDB-objekter (både datter og mor) der de har miniskule forskjeller i geometrisk posisjon, ikke vil få godkjent endringssettet av SKRIV  fordi datter ikke er innenfor mor.

Per nå flytter vi bare døtre inn til mor ved sammenkobling, så denne saken bør også sees i sammenheng med NVDB-5822 (flytte datter også ved stedfesting)

 

 

 ",NVDB-6937,Datafangst,
Ikke segmentere historiske objekter for kontrakt/riksvegrute,"Oppfølging av saken NVDB-5674 etter antallet segmenter ikke ble som forventet.

*Løsning*
Etter ny gjennomgang ble det oppdaget at ikke alle historiske kontraktsområder og riksvegruter ble droppet ved segmentering. Dette er nå rettet og verifisert med integrasjonstest.",NVDB-6937,NVDB-IND,
Vegsystemreferanse på overgang E39 F710,"{quote}Har støtt på en edge case i overgang mellom vegsystemreferanser. Trafikkulykke 264593895 har koordinatene (240233, 7030667.4) og ligger på EV39 S4D1 m2347.
 /posisjon-oppslag gir 0.25636204@72837 - EV39 S4D1 m2347.
 /veg?veglenkesekvens=0.25636204@72837 gir FV710 S1D1 m0.
{quote}
[https://nvdbapiles-v3.utv.atlas.vegvesen.no/veg.json?veglenkesekvens=0.25636204@72837]
 [https://nvdbapiles-v3.utv.atlas.vegvesen.no/posisjon.json?ost=240233&nord=7030667.4&maks_antall=2]

/veg veksler mellom dem.

EV39 S4D1 m2347 slutter der, FV710 S1D1 m0 starter der.

 

*Test*

Sjekk trafikkulykker stedfestet i krysset her (mellom EV39 og FV710). De som er stedfestet på 0.25636204@72837 skal ha vegSysRef FV710 nå.

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@240242,7030658,18/hva:~(~(id~570))/vegsystemreferanse:240231.371:7030664.807]

Bildet vedlagt viser objektene med vegSysRef EV39 slik det har vært. Det er vegSysRef fra slutten av lenka som stopper i 0.25636204@72837.

 ",NVDB-6937,NVDB-IND,
Ny stedfesting må prøve å flytte seg innenfor sin mor,"h2. Observasjon

I dag flyttes døtre innenfor sin mor bare når de blir sammenkoblet, men i de tilfellene der man lager en ny stedfesting etter at en sammenkobling er gjort, så flyttes ikke datter inn til mor, og brukeren får sannsynligvis en feilmelding fra Skriv. I tillegg gjør dagens løsning det nødvendig å lage en  ny sammenkobling til mor for å få flyttet datter inn, som lager unødvendige endingssett, og vil fremprovosere duplikat-assosiasjons-buggen. 
h2. Implementasjon

Ved stedfesting hentes forelder til objektet. vi gjør så et forsøk på å flytte objektet inn til forelder. Hvis det ikke går, bevares stedfestingen, men den blir markert som uncertain, og en beskrivende tilbakemelding sendes til brukeren.

Deretter hentes barn til objektet. barnene forsøkes å flyttes inn til mor. Hvis en eller flere av barnene ikke kan flyttes, bevares stedfestingen de hadde, men stedfestingen blir markert som uncertain og en forklarende tilbakemelding sendes til brukeren. 

Ved begge tilfellene forsøker vi aldri å flytte mor, men flytter alltid barnene, og vi begynner øverst i hierarkiet. så det er bestemor som styrer hvor barnebarna blir plassert.

Vi ser kun på den umiddelbare mor til objektet som skal stedfestes, og de umiddelbare barna. så kun 3 nivåer av hierarkiet forsøkes flyttet. Det bør likevel være tilstrekkelig for å kunne flytte et større hierarki ved å gjøre operasjonen i flere ledd, der man begynner høy og slutter lavt i hierarkiet.

Ved endt stedfesting, sendes oppdaterte vegobjekter til frontend. Stedfestingsfanen er endret for å kunne ta i mot flere objekter ved stedfesting (tidligere bare ett), og de oppdaterte stedfestingene vises umiddelbart når de mottas. 
h2. NB!

Denne oppgraderingen gjelder ikke automatisk stedfesting. Vi kan implementere det senere, men det er teknisk litt mer utfordrende, siden autostedfesting kjøres asynkront. Helt klart løselig, men siden Skriv skal ta over stedfesting og ta innflytting til mor automatisk gir det mer mening å avvente dette. Denne oppgaven skal først og fremst løse problemet med at manuell stedfesting ikke flyttet døtre, og krevde at brukeren måtte fjerne sammenkobling og lage en  ny sammenkobling for å få flyttet døtre.",NVDB-6937,Datafangst,
Ingen strekningsmeter for kryssdel i annen kommune enn kryssystem,"KV9999 K1000D1 kommune: 1103 veglenkesekvens:2343045

*Analyse*
 Ser ut til å skyldes datafeil. Vegsystemet for kommunal veg KV9999, med id 1002896754, har to ulike kommuner. 1103 og 1124. I vegkart ser det ut som rundkjøringa ligger i 2 kommuner. Hvis vegsystemet deles i 2 objekter, 1 for hver kommune skal meterberegningen gå bra.

Siden det er kommunal veg forventes det bare 1 kommune på vegsystemet, så det er bare den ene kommuenen som blir lagt til i cache. Ved uthenting for den andre kommunen under beregning av meterverdier er det ikke noe innslag i cachen, da blir meterverdi satt til -1.

Vegsystemet med 2 kommuner:
 [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/915/1002896754/1]
{quote}""lokasjon"": {
 ""kommuner"": [
 1103,
 1124
 ],
{quote}

https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-34965,6566738,16/hva:~(~(id~915)~(id~917))/hvor:~(vegsystemreferanse~(~'KV9999))

*Løsning*
Endret til å hente kommunenummer fra stedfestingen til kryssystemet/sideanlegget for meterberegning til punket der krysset/sideanlegget er stedfestet. Tidligere ble det brukt kommunenummer fra stedfesting til den delen det ble beregnet meterverdi på.
I tillegg er det gjort en  jobb i prod med å dele vegsystemet i 2 objekter, 1 objekt for hver kommune i krysset.",NVDB-6937,NVDB-IND,
Bedre UI for stedfestinger i kartet,"h2. Observasjon

Når man har flere objekter tett på hverandre, og man skal prøve å finne ut hvilken av de som har feil stedfesting, så kan det være vanskelig, fordi det er vanskelig å se hvilken stedfesting som tilhører hvilke objekter.

- stedfesting bør markeres sammen med objektet som er valgt
- stedfestinger bør bli klikkbare, slik at man kan klikke på en stedfesting som er feil og få markert det objektet den tilhørert

!image-2020-08-25-08-29-57-760.png!",NVDB-6937,Datafangst,
Leveranseinformasjon NVDBIND V3 2020.12.2,"Kan testes ved å kjøre en transaksjon, stoppe NVDBIND og sjekke at «Cloud - Tree - nvdb - transaction» har innhold «sync» og «latest» under seg.",NVDB-6937,NVDB-IND,
«sist_prosesserte_transaksjon» er feil ved reindeksering,"Sinus Infra frå Triona må ha verdi «sist_prosesserte_transaksjon» for å fungere. Under reindeksering 22/8-20 feila den, og Sinus Infra var utilgjengeleg for brukarane til indeksering var ferdig mandag ettermiddag/kveld.

Triona ber om endring og viser til tidlegare melding:

Ja, nå er «sist_prosesserte_transaksjon» satt og SINUS infra virker Ok igjen 😊.

 

Sist dette skjedde fikk vi inntrykk av at det er unødvendig for NVDB å ta vekk dette tidspunktet ifb. med reindeksering og at man skulle la tidspunktet stå. Jeg vet ikke om man etterpå har tenkt annerledes eller om man bare glemte å justere det.

 

Om ikke NVDB løser det må SINUS løse det, men da ønsker vi synspunkter på hvilket tidspunkt vi skal sette. Hva er rett? Er det tidspunktet for når vi leser ned dataene vi skal bruke?

 ",NVDB-6937,Les-API,
Retning på stedfesting skrives ikke til NVDB,"h2. Observasjon

Fra Sigmund Fredriksen:

Når vi sletter geometrien på f.eks. et rekkverk med Oppdater så kan det se ut som den nye versjonen som dannes i NVDB SKRIV mangler Retning på Stedfestingen.
 
Aktuelt endringssett: https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/502dc74c-3003-4e9a-90d3-bd678b853a1e . Versjon 1 har retning på stedfesting, mens versjon 2 av objektet (som ikke lenger har egengeometri) mangler retning.
 
I SINUS bruker vi retning ved uttegning av strekningsobjekter uten egengeometri med SIDEPOS=H eller V (parallellforskyve ift. vegnettsgeometrien). Uten retning blir objektene tegnet ihht vegnettsgeometrien (senterlinja) selv om de har SIDEPOS H eller V.

h2. Analyse

I endringssettet utføres delvis oppdatering på tre vegobjekter. Samtlige vegobjekter har oppgitt stedfesting. Ingen av stedfestingene inneholder imidlertid retning. Stedfestingene for de versjonene som registreres i NVDB skrives inn slik de er definert i endringssettet. At foregående versjon har retning på stedfestingene påvirker ikke dette. Stedfestingen må oppgis komplett, inkludert retning, ved oppdatering/korrigering/registrering (inkl. delvise varianter) i endringssett. 
",NVDB-6937,Skriv-API,
Redirect-URL for /vegobjekter/id fungerer ikke lenger,"Denne redirecten er hardkodet til å vise til hash-komponenten #vegobjekt:id som ble tatt bort i forbindelse med utvidelsen der man også kan lenke direkte til vegnettslenke-segmenter. Ny komponent har navnet #valgt:id, der id-en kan bestå av flere felter for å antyde vegobjekttype, segmentdel osv.

Oppgaven består i å tilpasse redirect til nytt format, og bonuspoeng om man lager en tilsvarende redirect for vegnettslenker som har et litt annerledes format.",NVDB-6937,Vegkart,
Importere liste med INVD-ID,"*[Jan.O.Pedersen@agderfk.no|mailto:Jan.O.Pedersen@agderfk.no] spør:*

*Savner en mulighet for å importere en excelfil som inneholder masse NVDB-Id til vegkart for visning.*",NVDB-6937,Vegkart,
Bedre håndtering av OutOfMemoryError,"NVDBIND havner i limbo dersom heap blir full og GC ikke klarer fikse det. 
Legg til logging for mer informasjon og gjør det mulig å definere oppførsel ved OutOfMemoryError.",NVDB-6937,NVDB-IND,
Info om siste behandlede transaksjon slettes ved stopp,Informasjonen slettes fra ZK når NVDBIND stoppes. ,NVDB-6937,NVDB-IND,
Verktøy for å konvertere lukket kurve-geometri til flate,"Mail fra Raymond Krossøy Hermansen (raymond.hermansen@vtfk.no), som lurer på om vi har noe som kan konvertere en kurve-geometri til en flate-geometri.

Har sett i data ellers at det er ganske vanlig at entreprenør måler inn en kurve som omslutter objektet, og da i realiteten er en flate i stedet. Å enkelt kunne konvertere disse til en flate vil forbedre datakvaliteten i NVDB.

Det hjelper også Raymond som får automatisk utregnet areal for vegobjektet når det er en flate.",NVDB-6937,Datafangst,
Oppgradere sårbare avhengigheter,"Bygg med NPM rapporterer om en rekke sårbare avhengigheter, noen med høy alvorlighetsgrad. 

Avhengigheter for Java bør også sjekkes.",NVDB-6937,Datafangst,
Søke på NVDB-ID i Vegkart,"*[Jan.O.Pedersen@agderfk.no|mailto:Jan.O.Pedersen@agderfk.no] spør:*

*Savner en mulighet i vegkart til å kunne spørre på NVDB-ID*",NVDB-6937,Vegkart,
Se på flaky integrasjonstester,"Det er stadig vekk at bygging av Datafangst på Jenkins feiler pga integrasjonstestene. Feilene som kommer _kan_ være reelle, men i de fleste tilfeller er det en flaky test som går fint om man re-kjører jobben.

Denne oppgaven går på å se om man kan finne noen fellestrekk på de gangene testene feiler. Det er laget en jobb på Jenkins som jevnlig kun kjører integrasjonstestene ([https://ci.kantega.org/view/Datafangst/job/Datafangst%20Integration%20Tests/]) for å se om det er noen gjengangere eller om det er tilfeldig.

Vedlagte html-fil viser en oversikt over Datafangst sine integrasjonstester og resultatet av disse for de 20 siste kjøringene (per 2020-08-21 12:30).",NVDB-6937,Datafangst,
Filter på NVDB / FKB for samlinger til ekstern API,"Mail fra Sinus ved Sigmund Fredriksen, de får ut vegobjekter uten ""operation"" satt, som forvirrer Sinus. Viser seg at dette er en samling med FKB-data, men det er ikke synlig på noen måte for Sinus.

Det hadde vært bedre for alle om de bare får ut det de trenger, så vi kunne lagt på et query-parameter for ""destination"" på spørring etter feature collections i API.",NVDB-6937,Datafangst,
kommuner og fylker ut på /omrader/kontraktsomrader og /omrader/riksvegruter,Gi ut kommuner og fylker for kommuner og fylker ut på /omrader/kontraktsomrader og /omrader/riksvegruter,NVDB-6937,Les-API,
Fjern metrikk-logger som ikke virker,"Hvert 30. sekund er det en feil i loggen med ""Reporting returned code 302 Moved Temporarily: {}"". Dette er fra en metrikk-logger som ikke har virka på lenge. Fikses ved å fjerne ubrukt metrikklogging.",NVDB-6937,Datafangst,
"500 på grunn av feil ved utpakking av ""","Spørringer med «?egenskap=""id=verdi""» ble ikke pakket ut rett, så requesten feiler med 
{quote}
2020-08-20T09:54:39,533+0200 TRANSID=""f439eeaa-9df7-4d09-553a-5cbab15a5918"" SEVERITY=""ERROR"" ORIGIN=""SolrClientWrapperImpl"" MESSAGE=""
==== SolrQuery start ====
Solr collection : nvdb-roadobjects 
q = *:*
fq = exportId:5d12064e
fq = typeId:461
fq = +start_date:[0 TO 20200820] +(end_date:{20200820 TO *] (*:* -end_date:[* TO *]))
fq = ""5644=7935""
fq = docType:object
rows = 300
fl = end_date,route_id,contract_id,typeId,own_geometry,id,versjonsId,counties,last_modified,municipalities,start_date
cursorMark = *
sort = id asc,docId asc
shards.preference = replica.base:stable:hash:sessionId
sessionId = 85.164.136.234
_stateVer_ = nvdb-roadobjects:2619
==== SolrQuery stop ====
""
org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://svvpnvdbsolr08.vegvesen.no:8983/solr/nvdb-roadobjects: no field name specified in query and no default specified via 'df' param
{quote}",NVDB-6937,Les-API,
Gi klienter beskjed om at multigeometri ikke er tillatt,"Det er besluttet at Skriv ikke skal tillate multigeometri. Klienter vi kjenner må varses, og det må inn i API-dokumentasjon.",NVDB-6937,Datafangst,
Gjenopprett databasetilkobling ved connection timeout,"Vi har byttet fra Oracle connection pool til Hikari, siden indeksering gikk betydelig tregere med Oracle enn Hikari. 
Dersom den ene av databaseserverne blir borte kan Oracle-driveren i noen tilfeller havne i en tilstand der den tror alt er nede:

{quote}
2020-08-16 00:30:51 [ForkJoinPool.commonPool-worker-2] WARN  DBHealthChecker - NVDB database ping failure! null
java.lang.reflect.UndeclaredThrowableException: null
	at com.sun.proxy.$Proxy9.getConnection(Unknown Source)
	at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:57)
	at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:49)
	at no.vegvesen.nvdb.common.healthcheck.db.DBHealthChecker.test(DBHealthChecker.java:25)
	at no.vegvesen.nvdbind.oracle.OracleNvdbResource.lambda$getHealthChecker$0(OracleNvdbResource.java:46)
	at no.vegvesen.nvdb.common.healthcheck.HealthCheckReport.runTest(HealthCheckReport.java:76)
	at no.vegvesen.nvdb.common.healthcheck.HealthCheckReport.lambda$null$0(HealthCheckReport.java:53)
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)
	at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)
Caused by: java.lang.reflect.InvocationTargetException: null
	at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at no.vegvesen.common.hikaricp.HikariDatasourceProvider$CloseableDataSourceHandler.invoke(HikariDatasourceProvider.java:294)
	... 13 common frames omitted
Caused by: java.sql.SQLTransientConnectionException: NVDB - Connection is not available, request timed out after 34361ms.
	at com.zaxxer.hikari.pool.HikariPool.createTimeoutException(HikariPool.java:697)
	at com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:196)
	at com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:161)
	at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:100)
	... 17 common frames omitted
Caused by: com.zaxxer.hikari.pool.PoolBase$ConnectionSetupException: java.sql.SQLRecoverableException: IO Error: Operation interrupted, connect lapse 27882 ms., Authentication lapse 0 ms.
	at com.zaxxer.hikari.pool.HikariPool.createPoolEntry(HikariPool.java:501)
	at com.zaxxer.hikari.pool.HikariPool.access$100(HikariPool.java:71)
	at com.zaxxer.hikari.pool.HikariPool$PoolEntryCreator.call(HikariPool.java:727)
	at com.zaxxer.hikari.pool.HikariPool$PoolEntryCreator.call(HikariPool.java:713)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.sql.SQLRecoverableException: IO Error: Operation interrupted, connect lapse 27882 ms., Authentication lapse 0 ms.
	at oracle.jdbc.driver.T4CConnection.logon(T4CConnection.java:794)
	at oracle.jdbc.driver.PhysicalConnection.connect(PhysicalConnection.java:688)
	at oracle.jdbc.driver.T4CDriverExtension.getConnection(T4CDriverExtension.java:39)
	at oracle.jdbc.driver.OracleDriver.connect(OracleDriver.java:691)
	at oracle.jdbc.pool.OracleDataSource.getPhysicalConnection(OracleDataSource.java:384)
	at oracle.jdbc.pool.OracleDataSource.getConnection(OracleDataSource.java:273)
	at oracle.jdbc.pool.OracleDataSource.getConnection(OracleDataSource.java:198)
	at oracle.jdbc.pool.OracleDataSource.getConnection(OracleDataSource.java:176)
	at com.zaxxer.hikari.pool.PoolBase.newConnection(PoolBase.java:353)
	at com.zaxxer.hikari.pool.PoolBase.newPoolEntry(PoolBase.java:201)
	at com.zaxxer.hikari.pool.HikariPool.createPoolEntry(HikariPool.java:473)
	... 7 common frames omitted
Caused by: java.io.IOException: Operation interrupted, connect lapse 27882 ms., Authentication lapse 0 ms.
	at oracle.jdbc.driver.T4CConnection.logon(T4CConnection.java:790)
	... 17 common frames omitted
Caused by: java.io.IOException: Operation interrupted, connect lapse 27882 ms.
	at oracle.net.ns.NSProtocolNIO.negotiateConnection(NSProtocolNIO.java:127)
	at oracle.net.ns.NSProtocol.connect(NSProtocol.java:317)
	at oracle.jdbc.driver.T4CConnection.connect(T4CConnection.java:1438)
	at oracle.jdbc.driver.T4CConnection.logon(T4CConnection.java:518)
	... 17 common frames omitted
Caused by: java.io.InterruptedIOException: Operation interrupted
	at oracle.net.nt.TimeoutSocketChannel.handleInterrupt(TimeoutSocketChannel.java:311)
	at oracle.net.nt.TimeoutSocketChannel.write(TimeoutSocketChannel.java:221)
	at oracle.net.ns.NIOPacket.writeToSocketChannel(NIOPacket.java:211)
	at oracle.net.ns.NIOConnectPacket.writeToSocketChannel(NIOConnectPacket.java:232)
	at oracle.net.ns.NSProtocolNIO.negotiateConnection(NSProtocolNIO.java:108)
	... 20 common frames omitted
{quote}
{quote}
2020-08-13 07:53:57 [daemon] ERROR UpdatePoller - Escaped exception!
java.lang.reflect.UndeclaredThrowableException: null
	at com.sun.proxy.$Proxy9.getConnection(Unknown Source)
	at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:57)
	at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:49)
	at no.vegvesen.nvdb.jdbc.NvdbImpl.openSession(NvdbImpl.java:35)
	at no.vegvesen.nvdb.reader.datakat.DatakatalogUpdateChecker.updateInProgress(DatakatalogUpdateChecker.java:38)
	at no.vegvesen.nvdbind.daemon.UpdatePoller.doPoll(UpdatePoller.java:83)
	at no.vegvesen.nvdbind.daemon.UpdatePoller.run(UpdatePoller.java:58)
	at no.vegvesen.nvdbind.daemon.NvdbindDaemon.daemonThread(NvdbindDaemon.java:103)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.reflect.InvocationTargetException: null
	at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at no.vegvesen.common.hikaricp.HikariDatasourceProvider$CloseableDataSourceHandler.invoke(HikariDatasourceProvider.java:294)
	... 13 common frames omitted
Caused by: java.sql.SQLTransientConnectionException: NVDB - Connection is not available, request timed out after 15000ms.
	at com.zaxxer.hikari.pool.HikariPool.createTimeoutException(HikariPool.java:697)
	at com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:196)
	at com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:161)
	at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:100)
	... 17 common frames omitted
{quote}

Siden vi har konkludert med at vi ikke skal bruke Oracle connection pool må vi lage en mekanisme som detekterer slikt og kobler til databasen på nytt.",NVDB-6937,NVDB-IND,
Sentry rapporterer ikke,"Sentry ble disablet på en tidligere release

usikker hvorfor, antakelig en glipp.

re-aktiver sentry ",NVDB-6937,Datafangst,
Slett og opprett for samme kobling gir feil ved innsending,"En 400-mot-Skriv-feil på support viser seg å være at samme sammenkobling står som både DELETE og WRITE. Fordi vi ikke viser slettede koblinger (se NVDB-5799) er det lett å havne her, og dette problemet bør hovedsaklig løses gjennom NVDB-5799. Men selv etter at det er fikset så må vi passe på at det ikke er mulig å opprette en kobling der samme kobling står som slettet (men ikke innsendt). Dette gjelder både for kobling internt i kontrakten, og for kobling til mor eller datter i NVDB.",NVDB-6937,Datafangst,
Slettet sammenkobling vises ikke i brukergrensesnitt,"Når bruker sletter en eksisterende sammenkobling mellom to vegobjekter som begge er i NVDB, så vises ikke denne i brukergrensesnittet etterpå.
Dette gjør at brukene ikke kan se at dette er noe som sendes inn, og det gjør at hen ikke kan angre sletting etterpå.

Eksisterende koblinger som er satt til sletting bør fortsatt vises, men med markering (f.eks. gjennomstreking) som markerer de som slettet. Det bør være mulig å oppheve sletting ved å trykke på et ikon i kobling.",NVDB-6937,Datafangst,
Ruteberegning: Segmenter med kun ett punkt,"Ved søk etter rute dukker det opp noen segmenter som kun inneholder ett punkt. Finn ut om dette er ok oppførsel eller om noe går galt.

Eksempel 1:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING%20Z(277058.8%206651286.5%20172.075,%20277064.2%206651287.9%20172.075,%20277069.6%206651289.2%20171.975,%20277127.667%206651318.79%20171.975,%20277148.665%206651328.257%20171.875,%20277161.328%206651331.08%20171.875,%20277174.338%206651331.761%20171.775,%20277188.096%206651329.973%20171.775,%20277194.961%206651327.461%20171.675,%20277200.116%206651325.446%20171.675,%20277208.065%206651320.969%20171.675,%20277216.3%206651317.087%20171.592)&maks_avstand=10&konnekteringslenker=false&detaljerte_lenker=false&pretty=true&kortform=true]

Eksempel 2:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?start=0.0@625612&slutt=0.14364615@626970&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&kortform=true]

Eksempel 3 (Punkt først og til slutt):

[https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute.json?start=0.0@1176591&slutt=0.65698432@1175844&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&kortform=true]

Eksempel 4:

Oppgi geometri gir fin rute: [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute.json?geometri=LINESTRING%20Z(226327.432%206564594.167%209.226,%20226326.204%206564603.913%209.326,%20226325.03%206564611.74%209.376,%20226324.37%206564614.86%209.416,%20226322.59%206564620.63%209.436,%20226320.95%206564625.5%209.436,%20226318.69%206564631.57%209.496,%20226315.05%206564641%209.586,%20226312%206564648.92%209.646,%20226308.92%206564657.01%209.746,%20226304.83%206564667.79%209.846,%20226303.82%206564670.49%209.896,%20226299.94%206564680.86%2010.026,%20226296.12%206564691.05%2010.096,%20226293.02%206564699.27%2010.266,%20226289.87%206564707.61%2010.476,%20226287.74%206564713.17%2010.586,%20226283.3%206564724.76%2010.796,%20226279.56%206564734.5%2010.996,%20226276.63%206564742.17%2011.136,%20226275.59%206564744.94%2011.166,%20226272.47%206564753.24%2011.266,%20226271.5%206564755.91%2011.296,%20226267.58%206564766.66%2011.406,%20226265.69%206564772.07%2011.456,%20226262.02%206564782.93%2011.636,%20226259.44%206564790.73%2011.786,%20226256.4%206564800.5%2011.936,%20226253.2%206564811.46%2012.076,%20226251.67%206564816.92%2012.166,%20226248.64%206564827.88%2012.326,%20226244.72%206564842.55%2012.526,%20226240.95%206564856.4%2012.806,%20226238.24%206564866.36%2013.016,%20226235.54%206564876.21%2013.146,%20226232.38%206564887.72%2013.406,%20226231.05%206564892.51%2013.436,%20226229.02%206564899.69%2013.466,%20226228.22%206564902.4%2013.496,%20226225.85%206564910.46%2013.576,%20226224.12%206564916.17%2013.716,%20226223.22%206564919.01%2013.786,%20226221.4%206564924.67%2013.926,%20226219.57%206564930.28%2014.066,%20226218.62%206564932.95%2014.086,%20226216.71%206564938.32%2014.126,%20226214.84%206564943.09%2014.166,%20226212.776%206564947.972%2014.196,%20226212.24%206564949.31%2014.276,%20226209.63%206564954.88%2014.306,%20226207.21%206564959.329%2014.356,%20226203.163%206564966.408%2014.696,%20226200.16%206564967.25%2014.701,%20226197.548%206564968.563%2014.706,%20226194.566%206564970.973%2014.746,%20226193.676%206564972.194%2014.739,%20226192.053%206564974.424%2014.726,%20226190.929%206564977.325%2014.726,%20226190.632%206564978.092%2014.726,%20226190.16%206564981.834%2014.746,%20226190.377%206564983.72%2014.771,%20226190.589%206564985.574%2014.796,%20226191.863%206564989.047%2014.706,%20226192.894%206564990.783%2014.703,%20226194.698%206564993.041%2014.676)&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&kortform=true]

Rute med start og stopp basert på geometri over gir samme rute, *men* med et punkt først og sist: [https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute.json?start=226327.432,6564594.167,9.226&slutt=226194.698,6564993.041,14.676&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&kortform=true]",NVDB-6937,Les-API,
Sortere kontraktgruppelista alfabetisk,Lista over kontraktgrupper begynner å bli lang. Det ville vært kjekt om den var sortert. Også kommet som ønske på support fra Jan Vidar Strømsvold. ,NVDB-6937,Datafangst,
"Legge inn telefonnummer til BSS på ""problemer med innlogging""-siden","Ref. at vi får mail fra kommune-brukere som sier ""dere er jo vegvesen"" når de spør om hjelp til glemt passord, ettersom det står at de skal kontakte BSS/Statens vegvesen. 
BSS sier at vi kan henvise dem direkte til telefonnummeret: 240 58000",NVDB-6937,Datafangst,
Leveranseinformasjon NVDBIND 2020.12.1,"Innholder både https://jira.kantega.no/projects/NVDB/versions/34410, https://jira.kantega.no/browse/NVDB/fixforversion/34711 og https://jira.kantega.no/browse/NVDB/fixforversion/35110

Test i AT:
 * NVDB-4705: Kjør kontroll av FV409 og sjekk at det ikke er negative meter
 * NVDB-5674: Gjør en oppsummering av segmentene i ATM før og etter release a la den i beskrivelsen",NVDB-6937,NVDB-IND,
"Ruteberegning: Ved umulig rute, lever den lengste sammenhengende delruten","For situasjoner der det ikke er mulig å levere en sammenhengende rute, skal den lengste sammenhengende ruten leveres sammen med en indikasjon på at dette ikke er en komplett rute.


Indikasjonen skal være i form av en status i et statusfelt, se egen sak NVDB-5791.",NVDB-6937,Les-API,
Ruteberegning: Statusfelt,"Det er nå tydelig at det trengs et statusfelt i tillegg til vegsegmentene som leveres. Statusfeltet må kunne oppgi om en komplett rute er returnert, og i tillegg er det kjekt å få enkel statistikk som f.eks hvor mange vegsegmenter som returneres. Se metadata-feltet for vegobjekter og vegnett for inspirasjon.",NVDB-6937,Les-API,
Å skru av vegnettet skal avbryte søk,"Dersom man skrur på visning av vegnett over et større område, for så å skru det av igjen, vil det fortsettes å hente ned vegnett frem til det kan vises. Vegnettet vil også skru seg på igjen automatisk ved fullført nedlasting av data.

Ønsket oppførsel er at dersom vegnett skrus av, skal all nedlasting umiddelbart stoppe og vegnettet skal ikke forsøke å skru seg på av seg selv.",NVDB-6937,Vegkart,
Gi tilbakemelding på sensitive vegobjekttyper,"Ved å søke etter sensitive vegobjekttyper (871, 890, 892, 894, 895, 901, 903, 905) får man evigvarende ""laster..."" og en feil i konsollen p.g.a. 403.

Det hadde vært bedre å fange opp feilen og erstatte ""laster..."" med et varsel på at dataene er sensitive og ikke kan aksesseres.",NVDB-6937,Vegkart,
Ruteberegning: Definer og implementer korrekt respons på tidspunkt-intervaller,"*Grunnlag*

Det er usikkerhet rundt hvordan ulike konfigurasjoner av tidspunkt_start og tidspunkt_slutt burde gi respons på spørringer til ruteberegneren.

Dette gjelder f.eks åpen sluttdato og oppdaterte segmenter mellom start og slutt. Detaljert liste over problemer lages.

 
{panel}
*NVDB-5458*
----
Det ønskes to parametere, fraDato og tilDato, som skal føre til at ruten bare beregnes over veglenker som er gyldige på begge datoer. Den siste, tilDato, må kunne settes til ""null"" for å angi at kun veglenker med åpen sluttdato er aktuelle.
{panel}
{panel}
*NVDB-5758*
----
Det er angitt tidspunkt_start = 2010-01-01 og ingen tidspunkt_slutt. Eneste gyldige stedfesting fra 2010-01-01 til ""evig tid"" er veglenkene 1 og 40, men siden ruten skal være sammenhengende forventes respons med rute 0.0-0.12832022@805705. Får imidlertid en feilmelding.
{panel}
 *Spørsmål å ta stilling til:*
 * Dersom det forsøkes å beregne en rute fra A til B med kun tidspunkt_start satt, men det ikke finnes nok åpne segmenter mellom A og B til å beregne en rute, burde resultatet være tomt?
 * Dersom det forsøkes å beregne en rute fra A til B med tidspunkt_start satt og tidspunkt_slutt satt, hvordan skal man behandle segmenter som har blitt oppdatert mellom disse punktene og tidspunktene?

 ",NVDB-6937,Les-API,
Behandling avbrytes etter valideringsfeil på veglenkegeometri,"h2. Observasjon

Funnet under testing av NVDB-5636, fra Hans Jørgen:

Testet denne ved å registrere en ny lenkekvens uten høyde, og en ny lenkesekvens med for stor helning. Her blir det først avvisning pga. helning og når den er rettet kommer avvisningen pga. manglende høyde.

Skulle dette nå ha kommet samlet?

https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/1bf2fc82-5516-4a5d-a94b-aabbe1902538

h2. Analyse

Den første avvisningen skjer i constraint'en MaximumSlope, mens den andre skjer i constraint'en GeometryWithHeightCoords. Den første håndheves *før* låsing, mens den andre håndheves *etter*. Når API Skriv ser at det er valideringsfeil vil den ikke utføre låsing og begynne validering på ""etter låsing""-regler. Når det er valideringsfeil vil heller ikke all beriking som skjer umiddelbart før låsing gjennomføres. Dette for å unngå lang behandlingstid på et endringssett som uansett avvises.

Hvorfor er GeometryWithHeightCoords håndhevet etter låsing og ikke før som den andre? Validering på at veglenker har høydekoordinater skjer bare på veglenker for vegkategoriene E, R og F. For å vite hvilken vegkategori en veglenke representerer må API Skriv lese inn Vegsystem (evt Vegreferanse)-vegobjekter som er stedfestet der. Denne berikingen skjer umiddelbart før låsing, fordi de innleste vegobjektene må sekundærlåses.

I dette tilfellet er det helt nye veglenkesekvenser, med helt nytt Vegsystem-objekt som leveres i endringssettet. Sånn sett trenger man ikke beriking og låsing for å håndheve GeometryWithHeightCoords. Men koden som håndhever denne regelen er laget kompakt og generell og dekker både nye og oppdaterte veglenkesekvenser. Dette er forøvrig eneste geometrivalidering som gjøres etter låsing.

Å bygge om dette systemet til å validere nye veglenkesekvenser før låsing og bare oppdaterte etter låsing, er en relativt omfattende sak, er jeg redd. Kan det være en løsning å skille mellom registrering og oppdatering, ved at nye veglenkesekvenser alltid skal leveres med høydekoordinat +uansett vegkategori+ og kun validerere på ERF når det er oppdatering? Det vil i så fall være fort gjort å realisere i koden.",NVDB-6937,Skriv-API,
Gi arkiveringsstatus for en kontrakt via API,"I dag vil ikke kall mot hverken /api/v1/contract eller /api/v1/contract/<contractId> gi noen informasjon om arkiveringsstatus. Dette er uheldig for bl.a. SINUS som oppdaget at man kan sende inn nye objekter på en arkivert kontrakt.

Vi bør gi ut kontraktens arkiveringsstatus på ressursen /api/v1/contract s.a. SINUS (og andre) kan filtrere bort arkiverte kontrakter - evt vise de på en annen måte.

Intern-API benytter ""archivedState: OPEN/ARCHIVED"" for å filtrere i UI på ressursen /rest/contract/.",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Testes i AT:*
 * NVDB-5775: Regististrer to nye kryssystem med hhv ugyldig og gyldig stedfesting. Sjekk at ugyldig stedfesting gir AVVIST og gyldig stedfesting gir UTFØRT med autogenerering av id-egenskapen.

NVDB-5679 trenger ingen spesifikk testing i ATM.",NVDB-6937,Skriv-API,
Sortering i kontraktslista,"h2. Observasjon

Ved sortering på navn i kontrktslista kommer Å etter tall, men før B.

Sortering på Ansvarlig fungerer ikke.",NVDB-6937,Datafangst,
Vegliste: Dubletter for noen kommunale veger,"Noen kommunale veger blir delt opp i mange små segmenter selv om BK-verdiene er identiske. For eksempel Kv4560 i Hå kommune, Rogaland. Ser ut til å gjelde både publisering og arbeid med veglister. ",NVDB-6825,Rapportgenerator,
"Veglister:  Formattering ""tillatt vogntoglengde""","i word + excel: Kolonnen ""Tillatt vogntoglengde (m)"" skal være formattert med to desimaler og midtstilt, ikke tre desimaler og høyrestilt. Dette gjelder både ""arbeid med veglister"" og publisering. 

 Denne er litt spesiell, fordi egenkapverdien vi bruker (Maks vogntoglengde) er tekstfelt som enten inneholder teksten ""spesiell begrensning"" eller en tallverdi. Motoren returnerer tekst hvis verdien er ""spesiell begrensning"", ellers returneres Double. https://www.vegvesen.no/jira/browse/NVDBREF-629

 ",NVDB-6825,Rapportgenerator,
Dokumentere ruteberegning,,NVDB-6937,Les-API,
ID-egenskap genereres ikke for Kryssystem,"h2. Observasjon

Endringssett https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/d1f39c75-f3f4-420d-854b-56c848da0729 behandles uten feil. Det inneholder registrering av ett Kryssystem-objekt med tempId -17. Dette skal få ID-egenskapen automatisk generert, men dette skjedde ikke.

h2. Analyse

Kryssystemet har stedfesting er 0.571446896631202@67570 og startdato 2020-08-11.

I Splunk finner vi:

{noformat}
Found no effective ref link part in job for location 0.571446896631202@67570 on date 2020-08-11
{noformat}

AutoGenIdAttributeEnricherFilter fant altså ingen gyldig veglenke for denne posisjonen på angitt startdato, og dropper derfor å legge inn ID-egenskap.

Men hvorfor blir ikke Kryssystem-objektet avvist pga. ugyldig stedfesting?

Gyldigheten til stedfestinger valideres av LocationNetElementExistsValidator. Valideringen her tillater imidlertid et avvik på 1 mm i hver retning. Dette for å unngå at numeriske anomalier og unøyaktigheter i klienter (og API Skriv) skal påvirke valideringsresultatet. Java og det fleste andre programmeringsspråk klarer som kjent ikke å representere alle reelle tall presist. Slingringsmonnet på 1 mm konfigureres i Kontrollpanelet. I dette tilfellet havner punktstedfestingen til Kryssystemet innenfor en avstand på 1 mm til nærmeste gyldige stedfesting og blir dermed godtatt og endringssettet effektueres i NVDB.

h2. Løsning

AutoGenIdAttributeEnricherFilter trenger å finne veglenken som Kryssystemet er stedfestet på for å få tak i kommunenummeret på stedet. Dette brukes i anrop mot NVDB der reservasjon av Kryssystem-ID gjøres. Dette gjøres for alle stedfesting på KPS-veg. For ERF-veg er ikke dette noen problemstilling.

Koden som finner korrekt veglenke må endres til å takle at en punktstedfesting ikke treffer nøyaktig på en gyldig veglenke og tillate et lite slingringsmonn, slik som i LocationNetElementExistsValidator.

Estimat: 1 - 2 timer

For det aktuelle Kryssystemet som gikk gjennom til NVDB uten ID-egenskap, må det kjøres et script som legger på denne. Korrekt ID genereres av lagret prosedyre RoadSystemUtils.reserveAttributeNumbers.
",NVDB-6937,Skriv-API,
Hvordan produsere og tilgjengeligjøre en endringslogg hvor våre konsumenter kan lese om endringer ?,"Mail fra Triona:

Vi har registrert at det 4. juni ble innført Ratelimiter på kall til NVDB-API’ene. Om vi har forstått det rett er det nå en begrensning på 50 kall/sekund fra samme IP-adresse. Vi ser at dette er kommunisert i API-dokumentasjonen, men finnes det en annen offisiell infokanal der slike endringer blir lagt ut i forkant slik at vi som jobber med applikasjonsutvikling kan forberede oss på slike større endringer før de kommer? Og er det mulig i dokumentasjonen å ha litt info innledningsvis om hva som er endret i ny versjon? Nå må hele dokumentasjonen leses igjennom og så må vi selv finne/huske hvor det er gjort endringer.

 

Vi plukket opp informasjon angående ratelimiter via Gitter, men også i den sammenheng så ønsker vi oss en mer formalisert prosess rundt sporing av endringer (endringslogg) i API-et for oss som er eksterne. Gitter-kommunikasjonen er veldig «hoppende», så det er vanskelig å være sikker på at vi får med oss alt derfra.

 

 ",NVDB-6937,Les-API,
NPE ved bruk av tidspunkt på /rute,"h2. Observasjon

Dersom man oppgir en dato før generering av strekninger, har vegsystemreferansen kun vegsystem, og da får man en HTTP 500. Stacktrace:
{noformat}
Caused by: java.lang.NullPointerException at no.vegvesen.nvdb.roadsysref.RoadSysRef.getStartMeter(RoadSysRef.java:120) at no.vegvesen.nvdb.netelements.RoadNetSegment.getRoadSysRef(RoadNetSegment.java:266) at no.vegvesen.nvdb.netelements.RoadNetSegment.updateRelativePositionGeometryAndRoadRef(RoadNetSegment.java:258)
{noformat}
Eksempel-kall: [https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/beta/vegnett/rute?start=874760.8015977107,7849485.011404951&slutt=874968.4411868226,7849609.54906524&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&tidspunkt=2019-10-07&pretty=true&debug=true]

Brukeren burde her fått en eller annen beskjed om hva som gikk galt - evt en generell melding om at vegsystemref ikke er fullstendig på ønsket tidspunkt.",NVDB-6937,Les-API,
Få tilbake vegsystem-teksten i søk-oversikta,"Når det vert lagt til vegsystem for begrense/spesifisere søket vert den berre vist med tomt felt med markør og kryss i lista til høgre. 

Her der det lagt til Europa-, Riks- og Fylkesveg som det kjem fra i adressefeltet, men i lista i kartet er det berre tre blanke felt.

Søket fungerer som det skal og viser berre objekt på valgte vegsystem.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@268102,7030868,8/hva:~(~(id~532))/hvor:~(kommune~(~5001)~vegsystemreferanse~(~'R~'E~'F))]",NVDB-6937,Vegkart,
Mismatch i stedfestiner mellom API LES og VVI,"h2. Observasjon

VVI og API LES gir stedfestinger som avviker litt, men nok til at de ikke er kompatible ved sammenkobling.
h2. Analyse

vi bruker 2 måter å hente ut stedfestinger og geometri i datafangst.

For linjer bruker vi VVI sin ruteplanlegger og for punkter henter vi geometri direkte fra LES.

problemet er kommer antakelig fra små variasjoner i geometrisk kompleksitet i de to versjonene, der VVI antakelig har en litt forenklet geometri, som vi gi avvik i lengdenene som måles i geometriene. Det gjør at når vi trimmer stedfestinger (døtre innenfor mor) eller skal koble sammen linjer og punkter, får stedfestinger som avviker mer enn vi tillater.
h2. Løsning

Vi antar at stedfestingene fra VVI er generelt sett riktig, men har små unøyaktigheter i lenkeposisjonen. for å få riktig posisjon basert på geometriene i API LES, gjør vi en re-projisering av endene i stedfestingen mot geometri fra API LES og henter ut riktig geometri der det er hensiksmessig.

For Punkt-stedfesting betyr det at vi VVI henter ut riktig reflink, og internt i datafangst iterere vi over alle delene i reflinken, finner den som er nærmest, og projiserer posisjonen fra vegobjektet til reflinkpart-geometrien.

For multiline betyr det at VVI henter alle vegsegmentene, og vi internt reprojiserer endene av reflinkene for å få riktig posisjon.

Når både punkt-stedfestinger og linjestedfestinger har konsistent posisjon, skal de kunne sammenkobles riktig, og døtre skal kunne flyttes riktig innenfor mor der det er minimale forskjeller i geometri.

 

 ",NVDB-6937,Datafangst,
Import av vegobjekter uten stedfesting blokkerer type,"h2. Observasjon
Jeg importerte noen skredoverbygg for å ha testdata. Det viste seg at to av disse (fra URL under) ikke har stedfesting. Import går uten feil, men Datafangst gir systemfeil når type skal leses ut i datafanen.
https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@172705,7027791,8/hva:~(~(id~66))

I databasen så ligger disse inne med en entry i stedfesting, men med posisjon ""-1"" og med null for ""projected_from_wtk"". Det er den sistnevnte som gir systemfeil når typen skal leses.

{code}
java.lang.NullPointerException: wkt can't be null or empty
        at java.util.Objects.requireNonNull(Objects.java:228)
        at no.svv.nvdb.datafangst.domainmodel.geometry.WktString.<init>(WktString.java:31)
        at no.svv.nvdb.datafangst.domainmodel.geometry.WktString.of(WktString.java:22)
        at no.svv.nvdb.datafangst.representation.LocationalOverviewJson.getLineExtentWkt(LocationalOverviewJson.java:176)
        at no.svv.nvdb.datafangst.representation.LocationalOverviewJson.fromDomain(LocationalOverviewJson.java:131)
        at no.svv.nvdb.datafangst.representation.viewmodel.Feature.fromDomain(Feature.java:92)
        at no.svv.nvdb.datafangst.representation.viewmodel.FeatureTypeView.lambda$getContractFeatures$15(FeatureTypeView.java:198)
        at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
        at java.util.stream.SortedOps$SizedRefSortingSink.end(SortedOps.java:357)
        at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:483)
        at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
        at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
        at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
        at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
        at no.svv.nvdb.datafangst.representation.viewmodel.FeatureTypeView.getContractFeatures(FeatureTypeView.java:199)
        at no.svv.nvdb.datafangst.representation.viewmodel.FeatureTypeView.lambda$getFeatures$4(FeatureTypeView.java:89)
        at java.util.Optional.map(Optional.java:215)
        at no.svv.nvdb.datafangst.representation.viewmodel.FeatureTypeView.getFeatures(FeatureTypeView.java:87)
        at no.svv.nvdb.datafangst.rest.ContractResource.doGetFeatures(ContractResource.java:464)
        at no.svv.nvdb.datafangst.rest.ContractResource.lambda$getFeatures$1(ContractResource.java:458)
        at no.svv.nvdb.datafangst.rest.ContractBaseResource.lambda$getResponseWithLastModified$2(ContractBaseResource.java:84)
        at java.util.Optional.map(Optional.java:215)
        at no.svv.nvdb.datafangst.rest.ContractBaseResource.getResponseWithLastModified(ContractBaseResource.java:74)
        at no.svv.nvdb.datafangst.rest.ContractResource.getFeatures(ContractResource.java:458)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
{code}",NVDB-6937,Datafangst,
Navnebytte generiske => egendefinerte rapporter,"Tilbakemelding og diskusjon på demo: ""Generiske rapporter"" [https://nvdb-vegnett-og-objektdata.utv.atlas.vegvesen.no/generisk] bør hete ""Egendefinerte rapporter"". 

Men URL er grei, og trenger ikke endres. ",NVDB-6827,Rapportgenerator,
Kontraktsgruppe vises ikke,"h2. Observasjon

Dersom en bruker ikke har rettigheter innenfor en kontraktsgruppe, så vises det ikke hvilken kontraktsgruppe kontrakten er en del av på innstillingsfanen. Merk at man her må ha en global rolle for å kunne se innstillingsfanen. Så langt jeg kan se er det aktuelle scenarioet som i rapportert sak på support: Bruker har global forvalter rolle, men ingen rolle i kontraktsgruppen.

Det kan forøvrig bemerkes at vi bør styre unna at brukere har globale roller - og heller flytte disse til kontraktsgrupperoller. _Det_ er nok den egentlig løsningen.
h2. Analyse

Feilen oppstår fordi brukeren i dette tilfellet ikke har rettigheter i gruppen som kontrakten tilhører. 

I listen over kontraktgrupper brukeren kan velge mellom vises bare kontraktgrupper brukeren har tilgang til. Feilen oppstår fordi kontraktens kontraktgruppe ikke er en av disse kontraktene. 

Feilen oppstår i de tilfeller der kontrakten ligger i en kontraktgruppe og brukeren har rettigheter til å endre kontrakten, men ikke har rettigheter til kontraktgruppen kontrakten ligger i. Dette vil slå ut for de med global forvalter-rolle (som bør fjernes)
h2. Løsning

Når vi henter ut kontraktens kontraktgruppe må vi legge denne til i listen over kontraktegrupper som skal vises i evt dropdown hvis den ikke finnes der fra før.

Hvis brukeren har rettigheter til å endre kontrakten og rettigheter til å endre fjerne kontrakten fra kontraktgruppen (som global forvalter har) så vil brukeren nå kunne se og endre kontraktgrupper, inkludert den som kontrakten har. Global forvalter vil da kunne bytte kontraktgruppe til en av sine egne, men vil ikke kunne bytte tilbake ved en senere anledning.

 

 ",NVDB-6937,Datafangst,
Skiltpunkt gir ikke statistikkpunkter ved for mange resultater,"Åpne Vegkart og behold standard zoom-nivå. Søk etter Skiltpunkt.

Applikasjonen prøver nå å laste ned alle objekter i stedet for å vise statistikkpunkter på kart, selv om antallet treff er langt over grensen på 30 000.",NVDB-6937,Vegkart,
Test hvor høy sidestørrelse vi kan ha,"Antallet objekter per side er nå ganske lavt. 
 Kjør tester for å finne ut hvor høyt det kan settes. 
 Kanskje utvid med å ha forskjellig grense på punkt og linjeobjekter i tillegg til det vi har nå.",NVDB-6937,Les-API,
Filtrering med negative verdier,"{panel:title=Vs: Trøbbel med filtrering i Vegkart}
{color:#000000}*Fra:* Børnes Vilhelm <[vilhelm.bornes@vegvesen.no|mailto:vilhelm.bornes@vegvesen.no]>
 *Sendt:* onsdag 29. juli 2020 12:52
 *Til:* May Britt Hanstad <[may.hanstad@vegvesen.no|mailto:may.hanstad@vegvesen.no]>
 *Kopi:* Marvin Lillehaug <[Marvin.Lillehaug@kantega.no|mailto:Marvin.Lillehaug@kantega.no]>
 *Emne:* Trøbbel med filtrering i Vegkart{color}
  
 Hei!

Jeg prøver å få til filtrering av alle stigninger (VT=825) brattere enn 15%, dvs stigning må være < -15 eller > 15. Versjon 2019 satte jeg opp dette slik:

 

[https://vegkart-2019.atlas.vegvesen.no/#kartlag:geodata/hva:(~(farge:'0_0,filter:(~(operator:'*3c*3d,type_id:9396,verdi:(~-15))),id:825),(farge:'1_1,filter:(~(operator:'*3e*3d,type_id:9396,verdi:(~15))),id:825))/@649482,7105251,3/vegobjekt:788691855:40a744:825]

I siste Vegkart versjon fungerer ikke dette. Det er 2 problem:
 # Får ikke til å legge inn negativt tall i filterfelt. Se figur under.
 # Får ikke til å angi samme vegobjekttype 2 ganger. Hvis jeg i stedet legger det til som to filter har jeg ikke mulighet til å angi om begge kriterier må være oppfylt, eller at det er nok at ett av kriteriene er oppfylt. Ser ut til at standard er at begge krav må være oppfylt, dermed ikke mulig.{panel}
!image003.jpg|width=222,height=100,thumbnail!",NVDB-6937,Vegkart,
Kontraktsliste er ikke navigerbar med keyboard eller skjermleser,"h2. Observasjon

Sett i forbindelse med testing av NVDB-5755 (forbedringer for skjermleser).

Jeg får ikke brukt skjermleser for å navigere til kontraktsnavn, hele kontraktslista er uresponsiv. Det samme gjelder for keyboardnavigasjon i form av tab fra lenke til lenke.
 Årsak er nok at det er brukt <span> i stedet for <a> i lista.
h2. Analyse

Kontraktlista er en tabell med klikkbarhet lagt til via javascript. For at den skal kunne være tilgjengelig for skjermlesere med samtidig ha tabell-funksjonalitet, må kontrakene også også implementeres som semantiske lenker. Det gjør at de kan aktiveres via en skjermleser, og at man kan navigere mellom kontrakter med TAB.

Actionknappene i kontraklista er ikke synlige for skjermlesere, siden det eneste innholdet i knappene er ikoner, og de er implementert som spans med javascript for klikkbarhet. Knappene må implementeres som button-elementer eller lenker, og ha beskrivende titler som er synlig for skjermlesere. knappene popper en modal, som også må få beskrivende felter via ARIA. 

Filter-rekken i toppen er tildels brukbare, men mangler LABEL-felter på noen av feltene. Label-feltene trenger bare å være synlig for skjermlesere, da de er beskrivende nok i GUI. toggleknappene må få ARIA-PRESSED attributter, slik at en skjermleser forstår om en knapp er aktiv eller ikke.
h2. Tiltak

Implementert som foreslått i Analysen.

 

 ",NVDB-6937,Datafangst,
Systemfeil i AutoGenIdAttributeEnricherFilter,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/3e1caf01-4956-4b55-ba83-3598fd4cfc39 havarerer pga systemfeil under automatisk generering av id for et Kryssystem-objekt:

{code:java}
java.lang.IllegalStateException: Found no ref link part in job for location 0.124973095734052@760203 on date 2020-05-10
	at no.vegvesen.vt.nvdb.commons.core.functional.Suppliers.lambda$illegalStateException$1(Suppliers.java:16)
	at java.util.Optional.orElseThrow(Optional.java:290)
	at no.vegvesen.vt.nvdb.apiskriv.validation.feature.AutoGenIdAttributeEnricherFilter.createAutoGenIdAttribute(AutoGenIdAttributeEnricherFilter.java:109)
	at no.vegvesen.vt.nvdb.apiskriv.validation.feature.AutoGenIdAttributeEnricherFilter.lambda$doFilter$0(AutoGenIdAttributeEnricherFilter.java:73)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.feature.AutoGenIdAttributeEnricherFilter.doFilter(AutoGenIdAttributeEnricherFilter.java:64)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.JobFeatureFilters.doFilter(JobFeatureFilters.java:35)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateAfterLocking(DefaultValidationService.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateAfterLock(JobWorker.java:532)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:179)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1390)
	at org.apache.activemq.ActiveMQMessageConsumer.iterate(ActiveMQMessageConsumer.java:1552)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:191)
	at org.apache.activemq.ActiveMQSessionExecutor.wakeup(ActiveMQSessionExecutor.java:111)
	at org.apache.activemq.ActiveMQMessageConsumer.start(ActiveMQMessageConsumer.java:1527)
	at org.apache.activemq.ActiveMQMessageConsumer$7.run(ActiveMQMessageConsumer.java:1308)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Timer.java:555)
	at java.util.TimerThread.run(Timer.java:505)
{code}

h2. Analyse

Endringssettet inneholder oppdatering av veglenkesekvens 760203. Det registreres også et nytt Kryssystem med startdato 2020-05-10, tempId=""-58"" og punktstedfesting i 0.124973095734052@760203. Etter oppdatering av veglenkesekvens 760203 er eneste veglenke som dekker denne posisjonen ny veglenke med nr 11. Men denne har sluttdato 2020-05-10. Stedfestingen til Kryssystemet er derfor ugyldig. Dette er avdekket i en tidligere validering.

Systemfeil oppstår senere i behandlingen der Kryssystem skal gis automatisk ID. I denne prosessen må API Skriv vite kommunenummeret fordi det aktuelle kryssystemet befinner seg på kommunal veg, privat veg eller skogsbilveg. ID skal jo da genereres unik innenfor kommunen. For å finne kommunenr letes etter veglenken som dekker stedfestingen, men denne finnes ikke, som beskrevet over. Dermed kastes en exception fordi automatisk ID-generering ikke kan utføres.

h2. Løsning

I stedet for å kaste IllegalStateException når relevant veglenke ikke kan lokaliseres, returneres verdi som indikerer at ID-egenskap ikke skal genereres. Endringssett vil jo uansett avvises med valideringsfeil.",NVDB-6937,Skriv-API,
Mangelfull validering for deltakere i kontrakt,"Det er validering for brukernavn / e-post for å legge til deltaker i kontrakt i dag, men den godtar verdier som f.eks. "" * havwig@kantega.no"", og gjør ingenting etterpå heller for å fjerne ekstra tegn fra e-post.

Vi bør fikse eksisterende validering sånn at den virker, og med det samme rydde litt i databasen for de som åpenbart er feil. Kjør ""select distinct username from user_role order by username limit 100;"" som spørring for å få ut kandidater.",NVDB-6937,Datafangst,
Ruteberegning: Fant ikke startpunkt,"Sender inn en lang sammenhengde geometri, satt sammen av geometrien til naboveglenkene 1, 39 og 40 som til sammen dekker posisjonene 0.0 - 0.22613915. Veglenkene som alle har startdato 1950-01-01 tilhører veglenkesekvens 805705. Den midterste veglenken (#39) er lukket med sluttdato 2011-03-25 og gjelder for intervallet 0.12832022 - 0.17491341.

Det er angitt tidspunkt_start = 2010-01-01 og ingen tidspunkt_slutt. Eneste gyldige stedfesting fra 2010-01-01 til ""evig tid"" er veglenkene 1 og 40, men siden ruten skal være sammenhengende forventes respons med rute 0.0-0.12832022@805705. Får imidlertid en feilmelding:


{noformat}
9 > POST https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute
9 > Accept: application/json
9 > X-Client: NVDB API Skriv
9 > Content-Type: application/json
{""geometri"":""LINESTRING (13478.41 6696409.36, 13635.84 6696504.98, 14092.47 6696692.85, 14425.9 6696762.7, 14618.7 6696755.3, 14875.7 6696781.6, 14960.7 6696801.9, 15041.68 6696842.33)"",""maks_avstand"":""100"",""konnekteringslenker"":false,""detaljerte_lenker"":false,""vegsystemreferanse"":""K,E,R,F"",""trafikantgruppe"":null,""typeveg"":""kanalisertVeg,enkelBilveg,rampe,rundkjøring"",""tidspunkt_start"":""2010-01-01"",""tidspunkt_slutt"":null,""pretty"":false,""kortform"":false}

2020-08-06T13:24:02.961 INFO  [qtp1971111020-69] [] n.v.v.nvdb.apiskriv.jersey.LoggingFilter 10 * LoggingFilter - Response received on thread qtp1971111020-69
10 < 422
10 < X-Robots-Tag: none
10 < Cache-Control: no-cache
10 < Access-Control-Allow-Origin: *
10 < Access-Control-Allow-Methods: GET, POST, OPTIONS
10 < Set-Cookie: 64e1275b536a3a9f08af7df4c4bb169c=98837086eace32e5157615edd2caa0ac; path=/; HttpOnly; Secure
10 < X-REQUEST-ID: 43bcd940-5126-db40-4411-f267d02ff1bc
10 < Content-Length: 150
10 < Access-Control-Max-Age: 1728000
10 < Date: Thu, 06 Aug 2020 11:24:02 GMT
10 < Access-Control-Allow-Headers: accept, x-client, x-client-session, origin, content-type
10 < Content-Type: application/json;charset=utf-8
[ {
    ""code"" : 4000,
    ""message"" : ""Fant ikke startpunkt :POINT (13478.41 6696409.36)"",
    ""help_url"" : ""https://nvdbapilesv3.docs.apiary.io""
} ]
{noformat}

Dersom tidspunkt_start-parameteren endres til 2020-01-01 får vi gyldig rute tilbake, men ikke sammenhengende. Det er et hull for intervallet til veglenke 39.
",NVDB-6937,Les-API,
UU: forvirrende markup og skrivefeil,"h2. Observasjon

Hans Ålien rapporterer:

 

 
{quote}Nå har jeg oppretta ei personlig testkontrakt, uten særlig besvær. Underveis kom jeg inn på ei side med mye info.

Her fant jeg to ting som kanskje kan fikses:

«Legg til tilnyttet bruker»

*** Skrivefeil i overskriften.

«Slett kontrakt

En slettet kontrakt kan ikke gjenopprettes!

 Slett

Arkiver kontrakt

Kontrakt låses og skjules i kontraktlista

 

Arkiver

»

*** Litt usikker på hvordan dette skal oppfattes. Er det to knapper her, som skjermleseren ikke oppfatter som knapper?
{quote}
 

Dette gjelder de to knappene nederst på innstillinger-fanen. De må endres til å være HTML <button>.",NVDB-6937,Datafangst,
Hovedmeny støtter ikke skjermleser,"h2. Observasjon
Mail fra Hans Anton:
""Jeg må innrømme at jeg knapt har vært inne i Datafangst, men gikk inn nå. Da finner jeg ikke noen «Nytt»-knapp, der endringsloggen skulle kunne finnes. Jeg søkte etter knapper og brukte tab m.m, men fant ingenting med Chrome og mitt skjermleserprogram.

Til slutt fant jeg ei liste med tre lenker: Kontrakter, samt to uten noen tekst/etikett. Ved å velge disse to, kom jeg til henholdsvis Brukerveiledning og Endringslogg.

Kan jeg be om at det legges inn tekst på de to for meg tomme lenkene, på samme måte som «Kontrakter», eller altText, tror jeg det heter, slik at skjermleseren kan formidle det. Samtiidig kan kanskje «Nytt»-knappen alltid presenteres med dynamisk tekst, f.eks. datoen for siste oppdatering, i tillegg til animering/fargenyanse.

 

Det jeg også fant, etter innlogging, var en knapp som framkommer for meg med teksten «Uten etikett 0». Like under står teksten «Logg ut» (ikke klikkbar). Når jeg aktiverer «Uten etikett 0»-knappen, kommer jeg til påliggingsdialogen, som kanskje betyr at jeg er logget ut.

Kan dette kombineres til en enkel «Logg ut»-knapp?""

h2. Analyse
Ser ut som problemer med manglende tekst på ""Nytt"" og de andre der bare er der når vinduet blir så smalt at teksten forsvinner og det bare vises ikoner. ""Logg ut"" ser konsekvent ut til å mangle tekst.",NVDB-6937,Datafangst,
Fjerner unødvendige permissions-oppslag,"gamle oppslag mot persmissions henger igjen fra en gammel refaktorisering, som førte til at permissionresolveren og alle permission-oppslag mot DB ble kjørt 2 ganger ved kall til /session

 

Fjernet de skyldige kodelinjene",NVDB-6937,Datafangst,
Feilmelding for værutsatt veg,"{panel:title=Support-mail}
*Fra:* Erik Jensen <[erikjens@viken.no|mailto:erikjens@viken.no]>
*Sendt:* mandag 3. august 2020 11:13
*Til:* NVDB <[nvdb@vegvesen.no|mailto:nvdb@vegvesen.no]>
*Emne:* Feilmelding i Vegkart.no

 Hei,

Jeg får en feilmelding når jeg skal hente ut data fra [vegkart.no|http://vegkart.no/]. Det gjelder objekttype «+værutsatt veg+» som jeg forsøker å eksportere til CSV, da dukker det opp en feilmelding. 

Til nå så har jeg ikke hatt dette problemet med andre kriterier jeg har lagt inn.
{panel}",NVDB-6937,Eksport,
Detaljerte lenker med meterverdi -1,"Sjekk om det er datafeil eller noe feil med beregning. Noen detaljerte lenker på E18 med -1 som gjør at meterverdier blir feil.

""netelemid"":626896,
 ""startpos"":0.40588117,
 ""endpos"":0.41875179,

""netelem_superid"":625294,
 ""netelem_super_start"":0.36701772,
 ""netelem_super_end"":0.38071378

 

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@260479,6649122,17/hva:~(~(id~916))/hvor:~(vegsystemreferanse~(~'E18))/vegnett:~'geometri+~()/valgt:625751:19:18/vegsystemreferanse:260710.379:6649197.187]

og

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@260560,6649132,17/hva:~(~(id~916))/hvor:~(vegsystemreferanse~(~'E18))/vegnett:~'geometri+~()/valgt:625751:19:17/vegsystemreferanse:260710.379:6649197.187]

 

 

Funnet ved å se etter segmenter som har -1 i prod:

[https://nvdbapiles-admin-v3.atlas.vegvesen.no/solr/nvdb-roadnet-segments/select?fq=!end_date%3A*&fq=!sysref_roadsystem_road_number%3A9999&fq=sysref_section_start_meter%3A%5C-1&q=*%3A*&rows=20]

 ",NVDB-6937,NVDB-IND,
"API-import med ""Prosjektreferanse har verdi"" feiler","Jeg prøver å importere skiltpunkter som har filter ""Prosjektreferanse har verdi"". Får systemfeil ved import.

URL i Vegkart: https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@273632,7042720,16/hva:~(~(filter~(~(operator~'*21*3d~type_id~11078~verdi~null))~id~95))

API-URL: https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/95?segmentering=true&egenskap=(11078!%3Dnull)&kartutsnitt=273314.005%2C7042558.314%2C273949.007%2C7042882.099&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter

Stacktrace:

{code}
java.lang.IllegalArgumentException: featureTypeIds can't be empty
        at no.svv.nvdb.datafangst.commons.Requires.require(Requires.java:35)
        at no.svv.nvdb.datafangst.commons.Requires.requireNonEmpty(Requires.java:23)
        at no.svv.nvdb.datafangst.api.FeatureCriteria.withFeatureTypeIds(FeatureCriteria.java:58)
        at no.svv.nvdb.datafangst.contract.ContractManagerImpl.importNvdbFeatures(ContractManagerImpl.java:1036)
        at no.svv.nvdb.datafangst.rest.ContractResource.addExistingFeatures(ContractResource.java:1807)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory$1.invoke(ResourceMethodInvocationHandlerFactory.java:81)
        at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:144)
        at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:161)
        at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:160)
        at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:99)
        at org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:389)
        at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:347)
        at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:102)
        at org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:326)
        at org.glassfish.jersey.internal.Errors$1.call(Errors.java:271)
        at org.glassfish.jersey.internal.Errors$1.call(Errors.java:267)
        at org.glassfish.jersey.internal.Errors.process(Errors.java:315)
        at org.glassfish.jersey.internal.Errors.process(Errors.java:297)
        at org.glassfish.jersey.internal.Errors.process(Errors.java:267)
        at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:317)
        at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:305)
        at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1154)
        at org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:473)
        at org.glassfish.jersey.servlet.ServletContainer.serviceImpl(ServletContainer.java:408)
        at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:583)
        at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:524)
        at no.svv.nvdb.datafangst.jersey.JerseyPlugin$1.doFilter(JerseyPlugin.java:81)
        at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:461)
{code}
",NVDB-6937,Datafangst,
Prosjektreferanse blir ikke lagret i database etter innsending,"h2. Observasjon

Ser litt nærmere på prosjektreferanser i forbindelse med NVDB-5432. Vi sender inn prosjektreferanse til NVDB, men den blir aldri satt i databasen. Det vil si at etter at et vegobjekt med prosjektreferanse er lagret i NVDB så vil ikke lengre det som vises i Datafangst gjenspeile innholdet i NVDB.
h2. Analyse

Prosjektreferanser er litt spesielle siden de vanligvis settes i forbindelse med innsending, så å lagre prosjektreferanse som attributt i database i forbindelse med innsending kan også bli feil, i tilfelle innsending blir avvist.
h2. Forslag til løsning

Ta vare på prosjektreferanse som en del av data om innsending, og sett eller oppdater lokal prosjektreferanse etter vellykket innsending.

nytt felt i DB for prosjektreferanse på Nvdb_submission.

I ChangesetMonitors postprocessor endres eller oppdateres egenskapen for prosjektreferanse for vegobjektene som ligger i endringssettet.",NVDB-6937,Datafangst,
SQL-feil ved kopiering av objekt,"Jeg opplevde i en felles sesjon med Torbjørn at vi fikk en feil da Torbjørn skulle kopiere et vegobjekt til en annen type.
 Feilen kommer fra registrering av event, så typen i seg selv ble kopiert.

Feilen er at feltet som skal motta data er for lite, men jeg synes også det ser ut som vi prøver å putte ting i feil felt. Se stacktrace under, ""object"" kan ikke ta i mot så lange data, men synes det ser mer ut som noe som skulle vært i kolonne ""data"" i stedet.
{code:java}
java.lang.RuntimeException: Failed to execute update
	at no.svv.nvdb.datafangst.jdbc.Executors.executeUpdate(Executors.java:128)
	at no.svv.nvdb.datafangst.jdbc.Executors.executeUpdate(Executors.java:81)
	at no.svv.nvdb.datafangst.repository.EventLogDaoImpl.save(EventLogDaoImpl.java:90)
	at no.svv.nvdb.datafangst.security.EventLoggerImpl.lambda$saveEvent$0(EventLoggerImpl.java:69)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.lambda$transactional$0(Jdbc.java:85)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.transactional(Jdbc.java:107)
	at no.svv.nvdb.datafangst.jdbc.Jdbc.transactional(Jdbc.java:84)
	at no.svv.nvdb.datafangst.database.DatabaseImpl.transactional(DatabaseImpl.java:112)
	at no.svv.nvdb.datafangst.security.EventLoggerImpl.saveEvent(EventLoggerImpl.java:69)
	at no.svv.nvdb.datafangst.security.EventLoggerImpl.created(EventLoggerImpl.java:33)
	at no.svv.nvdb.datafangst.contract.ContractManagerImpl.copyGeometry(ContractManagerImpl.java:930)
	at no.svv.nvdb.datafangst.rest.ContractResource.copyFeatureGeometry(ContractResource.java:1706)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory$1.invoke(ResourceMethodInvocationHandlerFactory.java:81)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:144)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:161)
	at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:160)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:99)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:389)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:347)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:102)
	at org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:326)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:271)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:267)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:315)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:297)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:267)
	at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:317)
	at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:305)
	at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1154)
	at org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:473)
	at org.glassfish.jersey.servlet.ServletContainer.serviceImpl(ServletContainer.java:408)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:583)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:524)
	at no.svv.nvdb.datafangst.jersey.JerseyPlugin$1.doFilter(JerseyPlugin.java:81)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:461)
	at org.kantega.reststop.servlets.ReststopInitializer$PluginFilterChain.doFilter(ReststopInitializer.java:517)
	at no.svv.nvdb.datafangst.security.SessionTokenSecurityFilter.doFilter(SessionTokenSecurityFilter.java:60)
	at org.kantega.reststop.servlets.ReststopInitializer$PluginFilterChain.doFilter(ReststopInitializer.java:517)
	at no.svv.nvdb.datafangst.security.CORSFilter.doFilter(CORSFilter.java:42)
	at org.kantega.reststop.servlets.ReststopInitializer$PluginFilterChain.doFilter(ReststopInitializer.java:517)
	at no.svv.nvdb.datafangst.jersey.AccessLogFilter.doFilter(AccessLogFilter.java:44)
	at org.kantega.reststop.servlets.ReststopInitializer$PluginFilterChain.doFilter(ReststopInitializer.java:517)
	at org.kantega.reststop.servlets.ReststopInitializer$PluginDelegatingFilter.doFilter(ReststopInitializer.java:467)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:199)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:543)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:139)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:615)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:818)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1627)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.sql.SQLDataException: (conn=6916) Data too long for column 'object' at row 1
	at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.get(ExceptionMapper.java:225)
	at org.mariadb.jdbc.internal.util.exceptions.ExceptionMapper.getException(ExceptionMapper.java:165)
	at org.mariadb.jdbc.MariaDbStatement.executeExceptionEpilogue(MariaDbStatement.java:238)
	at org.mariadb.jdbc.MariaDbPreparedStatementServer.executeInternal(MariaDbPreparedStatementServer.java:429)
	at org.mariadb.jdbc.MariaDbPreparedStatementServer.execute(MariaDbPreparedStatementServer.java:388)
	at org.mariadb.jdbc.MariaDbPreparedStatementServer.executeUpdate(MariaDbPreparedStatementServer.java:375)
	at com.zaxxer.hikari.proxy.PreparedStatementProxy.executeUpdate(PreparedStatementProxy.java:61)
	at com.zaxxer.hikari.proxy.PreparedStatementJavassistProxy.executeUpdate(PreparedStatementJavassistProxy.java)
	at no.svv.nvdb.datafangst.jdbc.Executors.executeUpdate(Executors.java:125)
	... 67 common frames omitted
Caused by: java.sql.SQLException: Data too long for column 'object' at row 1
Query is: INSERT INTO event (id, project_id, user_id, occured_instant, event_type, object_type, object, data) VALUES (?,?,?,?,?,?,?,?), parameters ['6af1ee5d-3e5e-43db-a62a-51aea74979a6','be683f88-7588-466f-98b4-540186ab4665','exttxm','2020-07-31 10:02:37.404','CREATE','Feature','Kopiert geometri til nytt objekt. Ny id: 8cc405ad-6242-4caf-95e9-2fa0d2d32d42. Kilde: DATAFANGST. Ny type: 24','']
java thread: http-nio-127.0.0.1-8080-exec-21
	at org.mariadb.jdbc.internal.util.LogQueryTool.exceptionWithQuery(LogQueryTool.java:163)
	at org.mariadb.jdbc.internal.protocol.AbstractQueryProtocol.executePreparedQuery(AbstractQueryProtocol.java:1041)
	at org.mariadb.jdbc.MariaDbPreparedStatementServer.executeInternal(MariaDbPreparedStatementServer.java:422)
	... 72 common frames omitted
{code}",NVDB-6937,Datafangst,
NullPointerException ved stedfesting med ankerpunkter,"h2. Observasjon

I forbindelse med testing av en annen sak ser jeg at jeg får NPE ved bruk av manuelle ankerpunkter.

Jeg får det i alle tilfeller jeg prøver. Tipper at det har noe med endringer på input-parametere som ble gjort før sommeren.

Feilen rapporteres også som ""en feil i baksystem"", noe den ikke er. Har oppretta egen sak på dette, NVDB-5744.
{code:java}
java.lang.NullPointerException: null
	at no.svv.nvdb.datafangst.rest.RoadObjectResource.localizeWithAnchors(RoadObjectResource.java:185)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory$1.invoke(ResourceMethodInvocationHandlerFactory.java:81)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:144)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:161)
	at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$ResponseOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:160)
	at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:99)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:389)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:347)
	at org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:102)
	at org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:326)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:271)
	at org.glassfish.jersey.internal.Errors$1.call(Errors.java:267)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:315)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:297)
	at org.glassfish.jersey.internal.Errors.process(Errors.java:267)
	at org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:317)
	at org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:305)
	at org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1154)
	at org.glassfish.jersey.servlet.WebComponent.serviceImpl(WebComponent.java:473)
	at org.glassfish.jersey.servlet.ServletContainer.serviceImpl(ServletContainer.java:408)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:583)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:524)
	at no.svv.nvdb.datafangst.jersey.JerseyPlugin$1.doFilter(JerseyPlugin.java:81)
	at org.glassfish.jersey.servlet.ServletContainer.doFilter(ServletContainer.java:461)
{code}
h2. Analyse

Stedfesteren tåler at vi sender objekter til stedfesting uten at veg er valgt, den mest sannsynlige kandidaten blir da valgt og stedfestingen får en pålitelighets-score.

Stedfesting med ankerpunkter tåler ikke at veg ikke er valgt, fordi den bruker ruteplanleggeren for stedfesting, og den har et knippe begrensninger på hvilke veger som kan brukes, og vi må derfor angi hvilken veg vi vil ha.
h2. Løsning

Forhindre at brukeren kan trykke på knappen for stedfesting hvis stedfesting med ankerpunkter er valgt, og veg ikke er valgt.

Gi feilmelding med forklaring hvis det likevel skulle skje.

 ",NVDB-6937,Datafangst,
Støtte for status KANSELLERT fra Skriv,"Skriv API har fått støtte for at bruker selv kan kansellere endringsett som venter på lås (NVDB-5467) , men Datafangst forstår ennå ikke denne statusen. Datafangst må utvides til å støtte denne, og fjerne status ""til eksport"" for berørte vegobjekter.

Rapportert på support-mail av Marius Thorsen <marius.thorsen@vegvesen.no>.",NVDB-6937,Datafangst,
Optimalisering av UUID i database,"(!) *Ta backup av databasen før denne kjører i produksjon. Script kjører automatisk, men kan ta tre timer eller mer å kjøre, og kan time ut.*

Etter NVDB-5499 (Unicode i database) ser vi at responstidene har gått opp, og database bruker mye CPU.

Det viser seg at MariaDB bruker mye ressurser på å dekode UTF-8, selv om innholdet bare inneholder ASCII. I stedet for å gå tilbake til ISO-8859-1 for hele databasen kan vi sette kun UUID-kolonner til å være ASCII. I tillegg så kan vi optimalisere litt ved at UUID-felter alltid er char i stedet for varchar.",NVDB-6937,Datafangst,
IllegalArgumentException ved restedfesting etter utskifting av vegnettsgeometri,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/d02da1e3-3967-4faa-a4d7-a0ed3467551a havner i SYSTEMFEIL under restedfesting i AdaptFeaturesToChangedRefLinkGeometryEnricherFilter:

{code:java}
java.lang.IllegalArgumentException: Expecting end less than or equal to 1.0, but is 1.0000000000000002
	at no.vegvesen.vt.nvdb.commons.core.contract.Requires.require(Requires.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Extent.validateRange(Extent.java:115)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Extent.of(Extent.java:78)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Extent.between(Extent.java:98)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalizeToPoint(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:1035)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:1010)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableFeature.relocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:832)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:493)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:160)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:406)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:165)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

Ved restedfesting etter utskiftning av vegnettsgeometri havarerer endringssettet fordi ny beregnet relativ posisjon for et punktobjekt er bittelitt større enn 1.0 (som er max). Dette skyldes numeriske anomalier og unøyaktigheter knyttet til flyttallsrepresentasjon i Java.

h2. Løsning

Endrer resultatet fra LocationCalculator.calcRelativePosition slik at det aldri returneres verdier utenfor intervallet [0.0, 1.0].",NVDB-6937,Skriv-API,
Bruke inkluder_egenskaper-parameter i oppslag.,"Bruk 
{code:java}
?inkluder_egenskaper=alle|basis|geometri|assosiasjon|stedfesting {code}
for å fjerne uønskede egenskaper i vegobjekt-søk.",NVDB-6937,Vegkart,
Ikke lagre geometri for vegobjektsegmenter,"Nå lagrer vi hele eller deler av vegnettsgeometrien i objektenes segmenter. Så vegnettsgeometrien for et objekt er lagret to ganger.

Objektsegmentets geometri blir kun brukt for visning, det søkes aldri i. Så det er mulig å droppe å indeksere den.

I stedet kan vi ved indeksering lagre hvilken del av objektets geometri på vegnettet segmentet representerer, og ved uthenting kan geometri lages ved å klippe objektets fullstendige vegnettsgeometri.

 

Gjenstående:

-Håndtere retning på geometri, ok

-Utvide med noen flere tester i reader, ok

-Tester i apiet som verifiserer at segmenter får geometri, få med stedfestinger med forskjellige retninger, ok",NVDB-6937,NVDB-IND,
Mulig å ekskludere assosiasjon- og stedfestingsegenskap,"?inkluder_egenskaper=alle|basis|geometri|assosiasjon|stedfesting

 ",NVDB-6937,Les-API,
Kjøre NVDBIND på Java 11,"Definer at rpm avhenger av java 11

 

Husk å endre JAVA_HOME i STM, og å definere steg i endringsdok for å sette java 11 som default i ATM og Prod",NVDB-6937,NVDB-IND,
Dupliserte assosiasjoner gir 400-feil ved innsending til skriv,"Nytt tilfelle med dupliserte assosiasjoner, linker denne til [#NVDB-5410]
 Dette skulle vel egentlig vært løst gjennom 5410, men nytt tilfelle 7. Juli. 

*Observasjon:*

Innsending endringssett: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.14/doc?id=c8uCeXEBxoPaAPabhBqO&_g=()]

Svar fra skriv: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.10-2020.07.07/doc/?id=2DC6J3MBycWn0Lra0-Z1] 

Det hører med at endringssettet ble forsøkt sendt inn 7. Juli 2020, men vegobjektene det gjelder ble importert/kopiert fra NVDB tilbake i februar/mars 2020. Kontrakten det gjelder er denne: [https://datafangst.kantega.no/#!/contract/87e792b7-5cff-4cad-adbd-79958e266dda/] 


_Må reproduseres/undersøkes om slike tilfeller kan oppstå også i fremtiden, og hva som skal til for å forhindre det._",NVDB-6937,Datafangst,
Tilgjengeliggjøre objekter fra SOSI i e-API,"Det kom en support henvendelse til Datafangst via SINUS support om å kunne se og redigere objekter innlest via SOSI med vårt eksterne API.

Alle objekter som er opplastet via SOSI bør kunne leses og endres gjennom API på samme måte som objekter som er opprettet via API.

Denne er relatert til to andre saker som omhandler å se API-opprettede objektsamlinger i filfanen og kunne hente ut kart-importerte NVDB-objekter via API.

I bunn og grunn bør man kunne aksessere objekter via API uansett hvordan de har kommet inn i kontrakten.",NVDB-6937,Datafangst,
Rampe på kjørefeltnivå blir avvist av Skrive-API,"h2. Observasjon

Et endringssett (https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/b01f0262-e892-46d2-a11d-d577220e240f) inneholder en rampe med lenker på alle detaljnivå. Kjørebane- og Kjørefelt-rampene er superstedfestet på Vegtrase-rampen. Feltegenskapen er angitt på alle detaljnivå. Likevel blir endringssettet avvist av skrive-API med denne meldingen:

*0: STEDFESTET_PÅ_UGYLDIG_TYPEVEG_ELLER_DETALJNIVÅ Veglenkens typeVeg/detaljnivå er ikke kompatibel med tilsvarende verdier for veglenkesekvensen den er superstedfestet på, ved veglenkens startdato: 1950.01.01*

*Markør navn: Lenke (Detaljert) (1)*

I håndbok V830 Nasjonalt vegreferansesystem avsnitt 5.4.1 er TypeVeg=Rampe tillat på alle detaljnivå. Kan det være en feil i valideringen i Skrive-API som gjør at endringssettet blir avvist?

h2. Analyse

Endringssettet avvises med følgende feil:

|1951743|STEDFESTET PÅ UGYLDIG TYPEVEG ELLER DETALJNIVÅ|Veglenkens typeVeg/detaljnivå er ikke kompatibel med tilsvarende verdier for veglenkesekvensen den er superstedfestet på, ved veglenkens startdato: 1950-01-01|
|1951747|STEDFESTET PÅ UGYLDIG TYPEVEG ELLER DETALJNIVÅ|Veglenkens typeVeg/detaljnivå er ikke kompatibel med tilsvarende verdier for veglenkesekvensen den er superstedfestet på, ved veglenkens startdato: 1950-01-01|

h3. Første feilmelding

Oppdatert veglenke 1 på veglenkesekvens 1951743
- Gyldighet 1950-01-01 ->
- Konnekteringslenke
- Detaljnivå KJØREFELT
- TypeVeg RAMPE
- Superstedfestet på 0.0-0.00992063 @ 521089 (port 1 - 6, altså veglenke 1):
-- Gyldighet 1950-01-01 ->
-- Konnekteringslenke
-- Detaljnivå VEGTRASE
-- TypeVeg KANALISERT_VEG

En rampe på kjørefeltnivå superstedfestes på kanalisert veg på vegtrasenivå. Dette er ikke tillatt i følge reglene vi har implementert i API Skriv.

h3. Andre feilmelding

Oppdatert veglenke 1 på veglenkesekvens 1951747
- Gyldighet 1950-01-01 ->
- Ikke konnekteringslenke
- Detaljnivå KJØREFELT
- TypeVeg RAMPE
- Superstedfestet på 0.00992063 - 0.0621469906256782 @ 521089 (port 6 - 11 (ny), altså veglenke 2 (oppdatert)):
-- Gyldighet 1950-01-01 ->
-- Ikke konnekteringslenke
-- Detaljnivå VEGTRASE
-- TypeVeg RAMPE

En rampe på kjørefeltnivå superstedfestes på rampe på vegtrasenivå. Dette er heller ikke tillatt i følge reglene som håndheves nå. Kun ramper på kjørebanenivå tillates i dag superstedfestet på rampe på vegtrasenivå. [~linda.stoeng@vegvesen.no] og [~nikolaj.fyhn@vegvesen.no]: Ønskes en endring på dette?

h2. Løsning

Oppdaterte SuperLocationRefLinkExistsValidator med de nye tillatte superstedfestingkombinasjonene.",NVDB-6937,Skriv-API,
Følg opp endringssett som feiler på grunn av NVDB-5695,"https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/d0d60c24-7911-4930-8b65-c4ead07f4994 ser ut til å feil på grunn av manglende sideposisjon, som er fikset i NVDB-5695.

",NVDB-6937,Skriv-API,
Filtrer på adskilte løp gir feil i data (Prod),"h2. Observasjon

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/105?antall=5&adskiltelop=Mot] lister noen objekter, hvor ex [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/105/78718468/2] kun har adskilte løp = Nei.

Samme med [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/5?antall=5&adskiltelop=Mot]

*MERK*: Begge disse søkene med filter gir samme objekter tilbake i UTV, STM og ATM - hvor alle objektene der har adskilte løp = MOT. Datafeil et sted?",NVDB-6937,Les-API,
Visning med delingslenke crasher på rettigheter,"h2. Observasjon
Fra møte med Ole Jørgen Skavhaug og Olav Løberg.

Visning med delingslenke fungerer ikke lengre etter endring av rettighetssjekk i 2020.1.11. Får feinlelding på console om undefined.

Steg for å reprodusere:
# Gå til status-fanen
# Klikk på (eller kopiér lenke) fra knapp med ""Delingslenke"" øverst til høyre
# Få opp innhold fra lenke
# Kart er tomt, og det er ikke noe informasjon i tabellen under kartet

h2. Analyse
Før endring ble det brukt en rettighetssjekk som tok høyde for at ingen bruker var satt, dette må gjøres på en tilsvarende måte nå. Sjekk siste endring i contract-status-controllers.ts",NVDB-6937,Datafangst,
Utløpt OpenAM-token gir systemfeil ved innsending til NVDB,"h2. Observasjon
I møte med Ole Jørgen Skavhaug og Olav Løberg fra Trøndelag FK for å gå gjennom feil.

Ett av de tilfellene der de får systemfeil med feilkode skyldes det at kall mot Skriv blir avvist fordi innlogging har utløpt. Søk etter ""OafEgEhe"" for ett konkret tilfelle, eller ""HTTP 302 from NVDB API Skriv"" for å finne alle.

h2. Analyse
Vi har automatisk fornying av token for servicebruker, men ikke for sluttbrukere. Vi har fått denne feilen fra starten av juni (med mindre den var maskert av annen feil før), mulig at det ble endra på levetid for OpenAM-token da.
Skriv skal over på Atlas og kommer da til å ta i bruk JWT, og det samme gjelder Datafangst når (hvis) det blir innflytting.
Vi må vurdere hva vi skal gjøre her på kort sikt, og hva som skal vente på innlogging med OIDC og JWT.

h2. Forslag til løsning
Den langsiktige løsningen er JWT og at nettleser fornyer denne før den går ut. Det kommer på plass i forbindelse med innflytting. 

I mellomtida bør bruker få en bedre feilmelding. Gi beskjed om at innlogging er utløpt, og at bruker må logge inn i Datafangst igjen for å sende inn til NVDB.",NVDB-6937,Datafangst,
Laster ikke vegobjekter ved kategorisering,"h2. Observasjon

Når man legger til kategorisering så lastes ingen objekter. Observerer dette i UTV og TEST, men ikke i Prod - så det må ha kommet med siste versjon.

Prøv å legge til Trondheim. Deretter tunnelløp. Resultater vises. Deretter kategoriser på noe. Ingen resultater vises, og ingen kall mot /vegobjekter sendes. Bruk evt lenke [https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@268102,7030868,9/hva:~(~(category~(type~'enum~id~8944)~id~67))/hvor:~(kommune~(~5001))]

Og sammenlign med Prod.",NVDB-6937,Vegkart,
Marker som feil på kommentar er utilgjengelig for kontrakteier,"Observasjon fra Eli Stenvik

På hvert enkelt vegobjekt kan man legge inn en kommentar og markere om denne skal gi en feil på vegobjektet. Denne er nå ikke lengre tilgjengelig for gruppe-admin og -forvalter. Den er der for globaladmin og forvalter.",NVDB-6937,Datafangst,
Tillate endringssett med både lukke- og korrigeringsoperasjon på samme vegobjektversjon,"h2. Bakgrunn

* Bruker ønsker å redigere stedfesting til et eksisterende vegobjekt, samtidig som objektet skal lukkes.
* Bruker ønsker å redigere en egenskap, eks. sekvensnummer på FT916, samtidig som objektet skal lukkes.

Dette medfører at objektet både blir korrigert (delvisKorriger) og eksplisitt lukket (lukk) i endringssettet. Dette tilllates ikke av API Skriv i dag og innsjekk avvises.

Vegnettsbrukere må i slike tilfeller tilbakestille korreksjonen og nøye seg med at objektet blir lukket.

Trimble v. Eivind og Richard, Tore E.A og Hans Jørgen/Kjetil hadde en prat om denne saken 25. juni.

h2. Løsning

Fjernet sperre i UniqueNvdbIdVersionValidator som hindrer korrigering og lukking av samme vegobjektversjon.
Oppdaterte PrepareForCorrectEnricherFilter til å validere at sluttdato i korrigering og eventuell lukking er den samme, og setter sluttdato lik lukkedato dersom korrigering ikke setter sluttdato.
La til ny attributt ""operasjon"" i VegobjektResultat for å kunne skille mellom ulike operasjoner på vegobjekter i <resultat>
",NVDB-6937,Skriv-API,
Visning av intervall på SD og KD,"h2. Observasjon

[https://vegkart.utv.atlas.vegvesen.no/#kartlag:geodata/@561395,7613925,9/hva:~(~(id~919)~(id~920))/hvor:~(vegsystemreferanse~(~'EV6S32D1M80SD1-2))]

Ser at jeg ikke får til å skrive {{...SD1-2}} i søkefeltet. Den hopper tilbake til {{...SD1}}, men blir riktig i søk bakover. Det samme gjelder for KD.

 

BONUSOPPGAVE: Sett riktige meterverdier på strekning i vegsystemreferansen.

!Screenshot from 2020-09-10 10-45-02.png|thumbnail!",NVDB-6937,Vegkart,
Manglende oppdatering på relasjon til mor,"h2. Observasjon #1

Triona klager på at en mor-løs datter ikke har fått mor etter en transaksjon i Skriv. Endringssettet [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/a8096224-636f-427b-b5cc-a710f05d7b2e?inkluderResultat=JA]

kobler to døtre til en mor. Mor får begge døtrene ut:

[https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/487/837513801/3]

En datter har tilbakekobling til mor: [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/25/871528419/1]

Men ikke den andre: [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/25/489137099/1]

Skriv har lagret dette om mor: [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/487/837513801/3]

Transaksjonen: [https://nvdbapiles-v3.test.atlas.vegvesen.no/transaksjoner?ider=4821867]
h2. Observasjon #2

Her har Triona fjernet en datter fra en mor og koblet datter til en annen mor: [https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/ccb48b7a-abad-4ebd-8f59-11b67dcb4520?inkluderResultat=JA]

Gammel mor ([https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/487/589434986/1]) og ny mor ([https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/487/589434991/1]) er oppdatert riktig i NVDB. Les gir ut riktig på begge mødrene, men datter har fortsatt gammel mor i relasjonene: [https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/25/589434987/1]

Transaksjon: [https://nvdbapiles-v3.test.atlas.vegvesen.no/transaksjoner?ider=4821864]

 ",NVDB-6937,NVDB-IND,
"Vegobjekt har to vegsystemreferanser, skulle vært én?",https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/3/1006875798/1,NVDB-6937,NVDB-IND,
Stedfesting med Skriv som standard,"Når utestående ting er fikset i Skriv og Les, og stedfesting med Skriv er testet nok, så kan vi gå over til å bruke denne som standard.

Det bør være mulig for bruker å bytte fram og tilbake mellom Skrivs og Datafangsts stedfesting fra GUI på stedfestingsfanen.
 * refaktoriser toggle-logikken fra å referere til ""skrivlocationals"" til ""legacylocationals"" og snu om logikken slik at skriv er default og legacy styres med en toggle
 *  fjern toggle knappen fra admin
 * legg inn en toggle-knapp synlig for alle for å toggle ""bruk gammel metode for stedfesting""",NVDB-6937,Datafangst,
Negativ meterverdi for ankerpunkt hos vegnettsegmenter i rundkjøring på FV409,"Håvard sin kontroll ""meterNegative"" viser etter siste reindeksering kun ett tilfelle (12 rader, men alt er samme rundkjøring:

ERROR;MeterNegative;4203;21815;0;0,10147498;32965;2375019;0;;F;V;409;S1D1 M-1;K;1000;1;29;38;K;;;;4;1;;140071;6497253;19;140062;6497253;19

https://ftp.triona.no/NyttVegnett-2020/Logger/RoadNetwork-Norge-ERF-K-2020-06-29.log

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@140098,6497246,16/hvor:~(vegsystemreferanse~(~'FV409))/vegnett:~'geometri+~()/valgt:21815:10:6]

Lenkesekvensen til rundkjøringen er 21815.
 Lenkesekvensen til hovedløpet hvor Kryssystem er stedfestet på er 22196.

Jeg ser ingen feil i vegnettet, men har snappet nivådelt vegnett på nytt, snappet strekning- og vegsystem, stedfestet kryssdel og kryssystem på nytt uten at inkrementell oppdatering har løst problemet.

Kryssystem-objektet har riktig vegsystemreferanse, metreringen til rundkjøringen er også riktig, men det er altså ""ankerpunktet"" til segmentene i selve rundkjøringen som har en negativ meter: FV409 K S1D1 M-1 KD1 M0-5

Spørsmålet er om reindeksering av de to lenkesekvensene eller evt. full reindeksering av vegnett vil kunne løse problemet etter mine ""restedfestinger"" i dag.",NVDB-6937,NVDB-IND,
Deltaker på kontrakt kan ikke importere fra NVDB,"h2. Observasjon
Med 2020-1.11.0 ble det innført en feil som gjør at ""Importer""-knappen på datafanen ikke lengre er aktiv for de som kun er lagt til på en kontrakt, og som ikke er i kontraktsgruppe eller er global admin.",NVDB-6937,Datafangst,
Få lasten på svvpnvdbsolr13 til å bli mer lik resten av solrnodene,"svvpnvdbsolr13 har i lengre tid hatt betydelig høyere CPU-bruk enn de andre solrnodene i prod.

Vi kjenner ikke årsaken til dette.

Drift har kikket på konfigurasjonen av noden og mener den er riktig satt opp. En reboot av noden hadde heller ingen effekt.

Kan det være en ide å prøve følgende for å teste ut om det likevel er noe med solr13 som ikke er som de andre nodene:
 * bytte om shardene på solr13 og f.eks solr14. For å sjekke ut om solr13 normaliserer seg og solr14 må ta høyere last. Hvis ja er det sannsynlig at det er kombinasjonen last+type spørringer som forårsaker problemet, og at det ikke er noe galt med solr13. Hvis det ikke endrer situasjonen vil det vel bety at det er noe med selve solr13 som avviker fra andre?
 * Erstatte solr13 med en helt ny vm (som er lik de andre). Hvis det hjelper og gjør at lasten på solr13 blir lik de andre, har vi påvist at det var noe feil med selve solr13 noden. 

Er det andre grep som kan taes for å få lastfordelingen til å bli jevnere mellom nodene?

 

 ",NVDB-6937,Les-API,
Kontraktlisten skalerer ikke for store grupper,"h2. Observasjon

På datafangst-test er det i gruppen TEST ca 550 kontrakter. Når gruppeforvalter eller -admin skal få opp denne listen (uten at de har noen globale roller) så tar det veldig lang tid.

Brukere med globale rettigheter merker ikke dette da det er mange flere sjekker og databasekall involvert for gruppe-rollene.

Denne saken blir viktig før vi skal få alle kontrakter over i grupper.",NVDB-6937,Datafangst,
Validering på lengde for input ved ny kontrakt,"h2. Observasjon
Eli Stenvik (eli.stenvik@trondheim.kommune.no) får ""Feil fra baksystem"" under lagring av ny kontrakt. Sjekker logg og ser at det er SQL-feil siden hun sender flere tegn til ""contractor"" (dvs. entreprenør) enn det tabelldefinisjonen tillater.

h2. Forslag til løsning
Den trivielle måten å løse dette på er å sette lengdebegrensning på feltene i HTML som samsvarer med hva som er definert i databasen.",NVDB-6937,Datafangst,
"""Skjul registrerte"" på datafane har ingen effekt","h2. Observasjon
Support-mail fra Øystein Bjøndal Lund (Oystein.bjondal.lund@vegvesen.no). Han får ingen effekt av å trykke på toggle for ""Skjul registrerte"" i datafanen.

Har gjenskapt det samme på utv. Tekst endres på knapp, men vegobjekttyper med ikon for at alt er registrert (dvs, disk med hake) vises fortsatt i lista. ",NVDB-6937,Datafangst,
Snillere håndtering av sideposisjonsvarsel ved datafeil,"h2. Bakgrunn

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/f37e613a-2a41-46d4-ab03-d7f2818db4ed havnet i SYSTEMFEIL fordi et vegobjekt som skulle restedfestes (sideposisjonssammenligning) hadde ugyldig stedfesting i utgangspunktet. Dette er en datafeil og at dette fører til SYSTEMFEIL i forbindelse med sammenligning av ny og gammel sideposisjon er litt voldsomt. Sammenligningen skal jo bare brukes til å generere et notabenevarsel. Vi bør håndtere denne situasjonen litt snillere, f.eks. unnlate å lage notabene når gammel sideposisjon ikke lar seg beregne e.l.

h2. Analyse

SYSTEMFEIL forårsakes av at exception kastes fra SidePositionCalculator.lineSegmentFromPosition() når det ikke er mulig å finne et linjesegment i veglenkegeometrien som passer til oppgitte veglenkesekvensposisjon.

h2. Løsning

Endrer SidePositionCalculator.lineSegmentFromPosition() til å returnere Optional.empty() i stedet for å kaste exception i den aktuelle situasjonen. I kaller (SidePositionCalculator.calculateSidePositionForPointLocational()) trigger det returverdi SidePosition.UNDEFINED.",NVDB-6937,Skriv-API,
Feil med automatisk bygging av cache i ATM/PROD,Bygging av cache feila. Gikk greit i UTV der det ble testa.,NVDB-6937,NVDB-IND,
Modulvogntog regelverkendring,"Først må det gjøres en datakatalogendring for de berørte BK-variantene. 

Deretter ser det ut som om vi må ta med en ekstra egenskapverdi fra NVDB og inn i veglistene. Jeg har ikke klart å finne noen annen logikk vi trenger understøtte (puh!). Gjengir epost fra Tone Wiig nedenfor
----
 

Hei

 

Veg- og trafikkjuridisk arbeider nå med en mulighet for å åpne for modulvogntog og vogntog med 24 m, totalvekt 60 tonn, i de deler av vegnettet som er åpnet for dette for tømmervogntog. Man ser her at det kan bli en mulighet for noen å reservere noen strekninger for ordningen, uten å måtte fjerne rettigheten for tømmertransport.

 

I praksis betyr dette at det må innarbeides ei ny kolonne i vegliste for tømmertransport. Prinsippet vil bli det samme som vi allerede har for modulvogntog, se vedlegg. Altså en kolonne «Gjelder ikke for». Så her må det en endring i datakatalogen, og en endring i rapportgeneratoren.

 

I skrivende stund, har vi ikke økonomi på plass. Dette blir derfor en undersøkelse om hva dere mener det vil bli av omfang på jobben, og om hvor mye det anslagsvis vil koste. Vi håper å ha dette i orden til oktober utgaven av veglista.

 

Vennlig hilsen
 Tone Wiig
 Mobil: +47 95726165",NVDB-6825,Rapportgenerator,
Release og deploy,"Release av:

back-end: 2.0.0

front-end: -v1.1.0-, -v1.1.1-, v1.1.2

Deploy til ATM og PROD

Fjerner deploy til dedikert Vegliste-versjon av nvdb-rapport-api, og flytter ressursene over på den vanlige/originale deployen.",,Rapportgenerator,
Systemdok: oppdatere med flernodedrift,"Oppdatere [systemdokumentasjonen|https://www.vegvesen.no/wiki/display/NVDBogGeodata/Systemdokumentasjon+NVDB+Rapporter] med info om flernodedrift og databaser (NVDBREF-488) som ikke blir med i release til PROD før sommerferien.

{color:#de350b}Frist: 2020-07-03{color}",,Rapportgenerator,
Forbedringer V1 vegnettsrapport,"Tilbakemelding fra Nikolaj Fyhn. Splittes opp i nye deloppgaver ved behov. 

Den første feilen - _vegsystemreferanser utenfor k.området_ - kjenner vi jo til: Vi har jo som kjent mangelfull filtrering og klipping på de bitene som er utafor k.område - avgrensingen. 

--- 

Hei,

Det er en flott jobb som gjøres med NVDB Rapporter 😊

Jeg har testet mere på V1 Vegnettsrapport og har noen tilbakemeldinger.

 

 

*Større feil:*
 * Feil lengde ved kontraktgrense. Jeg fant to vegsystemreferanser som er utenfor kontraktsområdet. Disse er markert med gull farge i vedlagte vegnettsrapport. Kontrakten «9201 Lifjell riksveg 2020-2022» skal starte på RV36 S8D1 M5032, men i vegnettsrapporten er der vegsystemreferanser før dette punktet.
 * Sideanlegg 1029 på E134 har fått feil «Tilmeter» men «Lengde veg» er riktig
 * Noen stedsnavn blir plassert feil i vegnettsrapporten.

For eksempel er stedsnavnet på fylkesgrensen «flyttet» til feil ende av lenken.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@186494,6620846,16/hva:~(~(id~343))/hvor:~(fylke~(~38))/vegnett:~'geometri+~()/valgt:106071196:343]

Stedsnavnet i kryss mellom E134 og fv. 3328 treffer også feil ende av lenken:

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@139488,6610545,17/hva:~(~(id~343))/vegnett:~'geometri+~()/valgt:106071048:343]

 

 

*Kosmetiske ting:*
 * Fjerne faner uten innhold. Driftkontraktene blir delt opp i egne fylkesveg-kontrakter og egne riksveg-kontrakter, da blir det ofte tomme faner.
 * Kolonnen «Lengde veg» trenger ikke mere enn to desimaler. Centimeter-presisjon.
 * Kommunenummer for KPS-veger. KPS-vegene er bare unike innenfor kommunen og derfor må kommunenummeret være med.
 * Vertikal tekstretning på overskrifter kan gi bedre overblikk over rapporten og gjør det enklere å lese vegsystemreferansen:

 

 

 

Med hilsen
 Nikolaj Fyhn",NVDB-6827,Rapportgenerator,
Engine - ObjectListingReport bør ikke bruke headere som nøkler,"Vi hadde et problem hvor headeren ""Lengde"" ble brukt både av NVDB objektet og av oss internt. For å unngå lignende konflikter i fremtiden bør ObjectListingReport generere nøkler basert på attributtID for at vi skal kunne være sikre på at det ikke er noe overlapp.",NVDB-6871,Rapportgenerator,
Trenger sideposisjon i V4-rapporten,"Sammen med øvrig vegnettsinformasjon trenger vi å vite _sideposisjon_ i V4-rapporten. Mange objekter i NVDB mangler egengeometri, og da er _sideposisjon_ eneste mulighet til å skille dem fra hverandre. I tillegg er det veldig kjekt for planlegging av vedlikehold. 

 

Tipper dette er slikt som må fikses i motoren. Må excel-utskriften justeres også? 

 

NB! Vi har en snublefelle ved at brukerne våre forstår sideposisjon relativt til +metreringsretning+, mens sideposisjon angitt i data fra leseApi alltid er slik data er lagret i NVDB: Relativt til +lenkeretning+. Hovedregelen er jo at metrering og lenkeretning går samme vei, men metrering blir relativt ofte snudd stikk motsatt av lenkeretning. Vi må finne ut hva i datagrunnlaget vårt som sikrer at vi kan gi sideposisin relativt til metreringsretning. Mest sannsynlig må vi bruke data fra vegnettet, det vil si sjekke detaljene om hver enkelt lenkesegment. 

 

Jeg tror det er lurt om vi er overtydelige, for dette med at sideposisjon kan være både ihht metrering og lenkeretning er opphav til mye forvirring. Jeg vil at vi vurderer å gi ut +to+ sideposisjonsverdier: 
 * sideposisjon_lenke <= det er denne vi får fra NVDB api V3
 * sideposisjon_metrering <= det er denne som etterspørres, og som vi må regne ut. ",NVDB-6827,Rapportgenerator,
DevOps: UTV - tune minne og CPU,"Vegliste: Normaltransport, Viken fylke går ikke igjennom på UTV pga. ressursmangel.

Tune CPU og minne.

Evt. slå sammen de to deploymentene for nvdb-rapport-api",NVDB-6825,Rapportgenerator,
Endringer i objektlista vil sette alle lagrede vegobjekter til DIRTY,"h2. Observasjon

Via Simon Stølan, support.
{quote}Hei,

Hva er årsaken til at lagrede objekter noen ganger vises med lagretsymbol type «svart hake over svart strek», mens de samme objektene ved neste innlogging (uten at det er gjort endringer) kan vises med «hvit hake på grønn firkant»?

Eks Vegbom og Singalanlegg i [https://datafangst.kantega.no/#!/contract/16724ec7-a5a4-455a-9a2b-b1baf1b94d8a].

Dette er uoversiktlig for oss som jobber med lagring mot NVDB. Skal vel ikke være slik ? Er kanskje en bug som dere kan fikse på?
{quote}
 

Endringer i objektlista ser ut til å sette vegobjekter til DIRTY.
 Det har ikke noe å si hvilke objekter man endrer i objektlista.
 En endring i objektlista setter DIRTY-flagget for vegobjekter i prosjektet, og det ser ut som, og DF behandler de som om de har endringer som skal lagres, men de har ingen reelle endringer, og vil bli avvist av Skriv med ""Empty changeset""-feilmelding.

Feilen kan gjenskapes ved å laste opp en sosi, stedfeste objektene og lagre de i skriv. De er nå markert som lagret. Gå deretter inn i settings for prosjektet, og hak av og på ett av objekttypene i objektlista. Gå tilbake til datafananen og observer at vegobjektene nå er DIRTY.
h2. Analyse

Når objektlistene oppdateres gjøres det en re-evaluering av validation issues, som fører til at alle vegobjekter blir oppdatert (touch) og får satt DIRTY flagg av dao.

Re-validering av vegobjekter bør bare skje på objekter som er DIRTY, siden det ikke er noe poeng å revalidere vegobjekter som er lagret.
h2. Løsning

La til DIRTY som kriterium i utvalget på oppdatering av validation  issues.

 ",NVDB-6937,Datafangst,
Automatisk rebuild av cache,"Rett feilen med automatisk rebuild av cache, slik at vi kan installere IND uten å kjøre full indeksering med en gang.",NVDB-6937,NVDB-IND,
Få med ferjekaier forkledd som bru,"Brukerønske driftskontrakter V2/V3: De savner ferjeleier som er forkledd som bruer, dvs de bruene som har 1263 Brukategori = 7307 Ferjeleie

Saksgang: Avklare med Rune Henning Skår om hva den nye oppramsingen bør hete og slikt, samt hvordan det evt påvirker utlisting av øvrige bru-objekter. deretter er det kun for Magnus å legge det til i rapportdefinisjonen. 

Bruer er som kjent et kodeord for _konstruksjoner som vedlikeholdes i fagsystemet Brutus,_ det du trur at bru betyr = brukategori vegbru, som kun er et subsett av objekttype 60 Bru i NVDB. ",NVDB-6827,Rapportgenerator,
Mer beskrivende filnavn som skiller mellom de ulike rapporttypene,"Brukerønske driftskontrakter: Et filnavn som inneholder mere metadata om innholdet. For eksempel: 
 * rapporttype (V1, V2, ... ) 
 * Nummer for driftskontrakt, for eksempel 9305 for DK ""9305 Sunnfjord"" 
 * Dato rapport kjørt (som i dag)  ",NVDB-6827,Rapportgenerator,
Eksport: Vis bare uregistrerte viser bare registrerte,"h2. Observasjon

supportmail fra oystein.bjondal.lund@vegvesen.no

Se kontrakt [https://datafangst.kantega.no/#!/contract/a959d5b8-ff3d-4cbd-947a-6f01260bc88f/export]

Ett vegobjekt er overført NVDB.
 Merk av for «vis bare uregistrerte»
 Det ser for meg ut som funksjonalitet er motsatt, at det bare er de registrerte som vises ….",NVDB-6937,Datafangst,
URL-parameter for å skru av splash-screen.,Ønske fra bruker Sindre Moldeklev (@sndrem på Gitter).,NVDB-6937,Vegkart,
Kansellere endringssett under behandling,"h2. Bakgrunn

Kontrollpanelet må tillate at et endringssett i status BEHANDLES settes til status KANSELLERT. Dette gjør det bl.a. mulig å stoppe endringssett som er altfor store og havarerer med OutOfMemoryError o.l. ActiveMQ vil i slike tilfeller gjøre redelivery av submit-meldingen og i prinsippet ikke gi seg før endringssettet er behandlet uten problemer.

h2. Analyse

JobWorker bør undersøke om et endringssett under behandling har fått ""kanselleringsordre"" på tre ulike tidpunkter:

1) Ved mottatt submit-melding => Rett før behandling starter.
2) Rett før (eller etter) låsing => Halvveis i behandlingen.
3) Rett før endringssettet effektueres i NVDB => Rett før behandlingen avsluttes.

Kanselleringsordren bør ikke angis ved at endringssettet settes i status KANSELLERT i jobbdatabasen. Under behandling skal det fortsatt ha status BEHANDLES og det er en del logikk i dag for å sette i status VENTER f.eks. som det ikke er hensiktmessig å røre. At endringssettet skal kanselleres under behandling bør heller angis med eget boolsk flagg på endringssettet i jobbdatabasen. JobWorker kan da inspisere dette flagget på de tre stedene angitt over og eventuelt avbryte behandlingen og sette status til KANSELLERT.

h2. Løsning

* (/) Nytt felt for kanselleringsflagg i JOB-tabellen. Tilsvarende property i Job-klassen. Mapping i Repository-klassen.
* (/) Service- og Repositorymetode for å sette og lese kanselleringsflagg.
* (/) Kanselleringslogikk i JobWorker
* (/) Kanselleringsflagg i representasjonsmodell for Endringssett/Status.
* (/) Vis Kanseller-knapp i detaljvisning for endringssett med status BEHANDLES i Kontrollpanelet.
",NVDB-6937,Skriv-API,
Unødvendig beriking av Gate-objekter,"StreetEnricherFilter beriker en jobb under behandling med alle eksisterende Gate-objekter med samme navn som et slikt objekt i endringssettet. Denne berikingen er ikke nødvendig så lenge constrainten UniformStreetCodeForName er deaktivert.

h2. Løsning

Parametriserte beriking og aktiverte kun beriking basert på gatekode. La på ekstra logging for å indikere nøyaktig hvilken type Gate-beriking som gjøres.",NVDB-6937,Skriv-API,
SQLSyntaxErrorException ved henting av Gate-objekter,"h2. Observasjon

Endringssett 8f37423d-3bbc-484e-9312-29470688fd5f m.fl. havarerer med SYSTEMFEIL under innlesing av Gate-objekter fra NVDB:

{code:java}
java.sql.SQLSyntaxErrorException: ORA-00907: missing right parenthesis
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.JdbcFeatureRepository.getFeatureVersions(JdbcFeatureRepository.java:283)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.JobFilter$Context.getFeaturesFromNvdb(JobFilter.java:215)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.StreetEnricherFilter.lambda$getExistingStreetsByName$3(StreetEnricherFilter.java:170)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.StreetEnricherFilter.getExistingStreetsByName(StreetEnricherFilter.java:157)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.StreetEnricherFilter.createStreetEnrichmentsByName(StreetEnricherFilter.java:106)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.StreetEnricherFilter.doFilter(StreetEnricherFilter.java:67)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:406)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:165)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.activemqclient.ActiveMqSubscription.onMessage(ActiveMqSubscription.java:188)
{code}

h2. Analyse

SQL som ikke er korrekt formatert er:

{code:sql}
with UNIQUE_FEATURE_VERSIONS as (
  select distinct
    f.feature.persistentid FID,
    fv.featureversion.versionid VID
  from
    nvdb.features_0538 f,
    table(f.featureversions) fv
  where
    fv.attr_4589.value = 'Harald Dreyer's vei'
    and fv.attr_202184.fid = 1002101811
    and fv.featureversion.versionid = (select max(fv2.featureversion.versionid) from table(f.featureversions) fv2)
)
select
  f.feature.persistentid FID,
  fv.featureversion.versionid VID,
  fv.featureversion.startdate SDATE,
  fv.featureversion.enddate EDATE,
  fv.attr_4588 ATTR_4588,
  fv.attr_4589 ATTR_4589,
  fv.attr_202184 ATTR_202184
from
  nvdb.features_0538 f,
  table(f.featureversions) fv,
  UNIQUE_FEATURE_VERSIONS ufv
where
  ufv.FID = f.feature.persistentid
  and ufv.VID = fv.featureversion.versionid
order by
  FID,
  VID
{code}

Ser ut som at enkelte gater bruker apostrof i navnet og dette skaper trøbbel i SQL der samme tegn brukes til å angi streng.

h2. Løsning

WHERE-klausulen stammer fra StringAttributeHavingValue.asSql. Innfører literal quoting for å unngå problemet med strenger som inneholder apostrofer.",NVDB-6937,Skriv-API,
Ekstremt mange spørringer etter Vegsystem-objekter,"h2. Observasjon

Ser i Splunk at mange endringssett (f.eks. 45106f4c-7c35-4056-ac24-664c0407fc68) under behandling genererer ekstremt mange spørringer etter Vegsystem-vegobjekter i NVDB.

h2. Analyse

Beriking av jobb med Vegsystem-objekter gjøres i RoadSystemEnricherFilter. Dette er et NetElementFilter, men spørs om det burde vært et JobFilter. Samme kan sies om RoadRefEnricherFilter.

h2. Løsning

Bygget om både RoadSystemEnricherFilter og RoadRefEnricherFilter til å bli JobFilter og gjør nå kun ett oppslag i NVDB for å hente hver av de to vegobjekttypene. Eller ett oppslag per 500 veglenkesekvensid, dersom det er mange av dem.",NVDB-6937,Skriv-API,
Droppe segmentering av historiske objekter for kontraktsområder og riksvegruter,"Vi segmenterer nå med endel historikk for kontraktsområder og riksvegruter.

Marvin foreslår at vi dropper å ta med historiske objekter, og kun segmenterer med åpne, som nok tilsvarer det man har mulighet å velge i Vegkart. 

---------------------------------------------------------------------------------------

I forbindelse med utvikling av nye rapporter fra NVDB så har de som følger opp entreprenør gitt uttrykk for at det er viktig å kunne gå tilbake og se hvilke objekt som var tilknyttet et angitt kontraktsområde *på en gitt historisk dato*. Dvs ikke bare historiske objekt, men historiske objekt som overlapper med den historiske utstrekningen til kontraktsområdet.

-------------------------------------------------------------------------------------------------------

Vi vet jo at det er under utvikling nytt ELrapp-system og det vil sannsynligvis komme ønsker og behov fra både divisjon D&V og Fylkeskommuner knyttet til driftskontrakter. Kan vi belyse hva et slikt ønske/behov vil innebære?

 

*Løsning:*

Segmenterer vegnettet bare på aktive kontrakter og riksvegruter. Både de som ikke har sluttdato og de som har sluttdato satt fram i tid. Segmentene fra vegnettet blir igjen brukt ved segmentering av vegobjekter, så det vil få effekt for antall segmenter på både vegnett og vegobjekter.

Det ser ut til å ha en merkbar effekt. -For både vegnett og vegobjekt (type 105) utgjør det ~1/3 færre dokumenter i solr.- Når vi tar med de som har sluttdato satt fram i tid blir ikke resultatet like bra for vegnett, men fortsatt merkbart:

Etter siste endring viser test i UTV:

Antall vegnett-segmenter før: 10861319 etter: 8981518

Antall segmenter for vegobjekt av type 105 før: 3352620 etter: 2215249

Antall segmenter for vegobjekt av type 95 før: 7398499 etter: 2968546

 

 

 ",NVDB-6937,NVDB-IND,
Ratelimiter - begrensning på 50 kall/sekund - bruk av klient-id som nøkkel i stedet for ip-adresse,"Mail fra Triona:

 

 

SINUS infra, SINUS entreprenør og SINUS photo kjøres på Azure. Alle kall fra klientene (de ulike brukerne) går via applikasjonen på Azure. Og alle kallene videre til NVDB kommer fra samme IP-adresse. Her ser vi et potensielt problem når trafikken blir stor. Er det slik at dere, når det er kjent at en IP-adresse gjelder for en hel applikasjonsfamilie (f.eks. SINUS), kan skalere begrensningen på antall kall pr. sekund til en høyere verdi? For vi antar at begrensningene er satt med tanke pr. bruker, ikke pr. applikasjon(sfamilie).",NVDB-6937,Les-API,
GUI: Feil URL til API i PROD,"Veglister feiler ved oppstart i PROD. Feil URL ved henting av områder.
Slik ser URL'en ut i de ulike miljøene: * UTV: [https://nvdbrapportapi-veglister.utv.atlas.vegvesen.no/rapporter/omraader|https://slack-redir.net/link?url=https%3A%2F%2Fnvdbrapportapi-veglister.utv.atlas.vegvesen.no%2Frapporter%2Fomraader]
 * ATM: [https://nvdbrapportapi-veglister.test.atlas.vegvesen.no/rapporter/omraader|https://slack-redir.net/link?url=https%3A%2F%2Fnvdbrapportapi-veglister.test.atlas.vegvesen.no%2Frapporter%2Fomraader]
 * PROD: [https://nvdb-veglister.atlas.vegvesen.no/nvdbrapportapi-veglister.atlas.vegvesen.no/rapporter/omraader|https://slack-redir.net/link?url=https%3A%2F%2Fnvdb-veglister.atlas.vegvesen.no%2Fnvdbrapportapi-veglister.atlas.vegvesen.no%2Frapporter%2Fomraader]

 
PROD er feil",,Rapportgenerator,
GUI: Versjonere FronEnd-appene med package.json,"Versjon ""v1.1.0-RC1"" av front-end ble releaset med bruk av Git tag slik som det ble gjort før konsolidering av de tre applikasjonene i ett felles Git-repo.

Dette bør endret slik at versjonen som står i de ulike appenes package.json er kriterie for versjonering.

Husk også å oppdatere her: [https://www.vegvesen.no/wiki/display/NVDBogGeodata/Systemdokumentasjon+NVDB+Rapporter] når der endres.",,Rapportgenerator,
Kunne registrere nye døtre til samme NVDB-mor på samme dag,"Simon Stølan ønsker å kunne gjøre flere koblinger til samme mor på samme dag gjennom ulike registreringer. Dette går ikke i dag da det lages en ny versjon av mor når man legger til en datter og registrerer. Hvis NVDB-mor ikke er i kontrakten vil man ikke kunne legge til flere endringer med påfølgende endringer før det har gått en ekstra dag (kun en versjon kan opprettes på en og samme dag). Dette kan løses på ulike måter med f.ex å ta inn NVDB-mor i kontrakten og behandle etterfølgende registreringer som korrigeringer.

Fra Simon
{noformat}
Hei, 

Opplever at løsningen er dårlig tilpasset lagring ifbm ferdigstilling av tunneler. Det er da mye data som skal inn av ulike art, gjerne på samme dato. Og man har det travelt, fordi det nå stilles strengere krav om oppdatert NVDB før sikkerhetsgodkjenning av tunnel. 

Det bør på en eller annen måte mulig å lagre i flere operasjoner mot samme morobjekt på samme dato. Da slipper man omveien om NVDB123. En omveg som snart stenges... Objekttyper ferdigstilles fra entreprenør og godkjennes av byggherre fortløpende og i flere bolker per dag i sluttfasen fram mot sikkerhetsgodkjenning, slik at det ikke er naturlig å lagre alle data i samme operasjon. 

Skjønner at dette ikke lar seg løse nå i dag, men antar at det bør være på plass en løsning på dette før NVDB123 fases ut ? , i likhet med mye annet..
{noformat}
Mitt svar
{noformat}
Det er vel slik i dag at dersom du kobler objekter på en NVDB-mor (uten å importere objektet inn i kontrakten) så vil denne NVDB-moren får en ny versjon. Og, som du egentlig sier, så får du ikke oppdatert versjon på et objekt flere ganger på samme dag. Men i ditt tilfelle her er det egentlig korrigeringer du gjør på den nye versjonen du “har startet på”. Korrigeringer kan gjøres mange ganger på samme objekt på samme dag. Vil det kunne hjelpe deg om du importerer NVDB-mor i kontrakten med operasjon “Korriger”, for deretter å jobbe videre med dette objektet? Da skal du kunne oppdatere objektet flere ganger, og mener at dette også gjelder nye assosiasjoner.

Men det “riktige” hadde da sikkert vært å få laget en ny versjon av NVDB-mor som man etterpå korrigerer med nye døtre ettersom man jobber. Litt hazzle, men en kan tenke seg at man først kobler en datter til NVDB-mor, registerer, deretter importerer denne NVDB-mor i kontrakten som “Korriger” og jobber videre. Dette er ikke en enkel arbeidsflyt.
{noformat}
Etter videre diskusjon på Mattermost oppsummerer Håvard en mulighet: Men det rimelige er vel én ny versjon, og så korrigering etterpå for ett prosjekt. Den siste biten har vi ikke noen måte å oppdage i dag. Her også kunne det hjulpet å importere mor ved kobling, da ville det ""gå av seg selv"" med oppdater og korriger. Dessverre så er det en del jobb å endre det.",NVDB-6937,Datafangst,
Vise hele vegsysmetreferanse for objekter,"Det kom inn en henvendelse på support fra Tina Vestersager
{noformat}
Driftsentreprenører og byggeledere trenger informasjon om strekning/delstrekning/meter på hvert vegobjekt. Dette gjelder både nye, redigerte og objekt som er importert for lukking.
{noformat}
Jeg svarte følgende
{noformat}
På det andre punktet så tenker du at vi i tillegg til å vise vegkategori/fase/vegnummer også bør vise strekning/delstrekning/meter i datafenen? 

Dette vil vi i såfall klare for eksisterende NVDB-objekter som er importert (til endring/korreksjon/lukking), men det er litt verre for nye vegobjekter før de er indeksert i API Les - og for NVDB-objekter som får ny stedfesting. Datafangst vil ha et forhold til stadfestingen (posisjon@veglenkesekvens-id), men ikke hvilken vegsystemreferanse denne får etter indeksering. Med forbehold om at jeg ikke sier noe galt om hva som kan oppnås gjennom API Skriv (i samarbeid med API Les), så må dette legges inn som et ønske om at denne tillegsinformasjonen legges til i respons fra API Skriv når vi går over til kun å bruke stedfesting gjennom API Skriv.
{noformat}
Tina svarer da videre at det vil være en god begynnelse om man ser det for eksisterende objekt.

 

Jeg har hørt med Tore om dette vil kunne være mulig gjennom stedfestingsfunksjonen til API Skriv. Tore mener at dette muligens kan løses gjennom informasjonen fra API Les. Tore sier videre
{noformat}
Skriv optimaliserer den segmenterte ruten fra Les, så om dette skal med i responsen fra Skriv, blir det som en separat liste per vegobjekt, ikke en vegsystemreferanse per stedfestingselement. Lag en sak, så kan jeg analysere og drodle litt.
{noformat}
Vi bør først ta en runde i Datafangst hvordan vi skal kunne løse dette. Noen objekter vil jo ha en vegreferanse som består av flere deler. F.ex [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/5/963759499/3] som har delene
{noformat}
EV6 S73D1 m3693-3788
EV6 S74D1 m0-1957
EV6 S74D1 m1957-2062
{noformat}
Og det finnes ""verre""",NVDB-6937,Datafangst,
Stedfesting med Skriv kan ikke brukes på anleggsveg,"Jeg prøver å stedfeste med Skriv med data fra NVDB-5664, den antenna som er målt inn som kurve. Får feil om at ingen rute ble funnet, og grunnen er at vi ikke sender riktig fase til Skriv.

Vi sender følgende spørring: https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/stedfest?maksimumAvstandTilVeg=300&vegnummer=6&vegkategori=E&typeVeg=ENKEL_BILVEG&fase=V

Siste query-parameter ""fase"" skulle vært ""A"" her i stedet. Fase er nå hardkodet til ""V"", siden det var litt vanskelig å navigere den miksen av vegstatuser som var i bruk, se linje ~249 i DefaultNvdbWriteApiGateway. Vi må se på en måte å få med fase på fra de dataene vi har.",NVDB-6937,Datafangst,
Støtte for punktstedfesting med stor geometri,"h2. Observasjon

Simon Stølan prøver å lagre Antenne. Da får han en NPE. Vedlagt er SOSI. Dette er reprodusert i df-test: [https://datafangst-test.kantega.no/#!/contract/f4d883fe-2992-4fee-925b-5ec93f2223db/export]

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.10-2020.06.18/doc/?id=kx9kxnIBVuR5ZJBULewW]

Original kontrakt: [https://datafangst.kantega.no/#!/contract/16724ec7-a5a4-455a-9a2b-b1baf1b94d8a/export]
h2. Analyse

Problemet her er at Datakatalogen krever at Antenne stedfestes som punkt, men Antennen som skaper problemet har en lang linje-geometri.

Vi kommer bort i 2 problemer, som tilsammen har skapt problem-situasjonen som Simon har havnet i.

Det første problemet opptrer som følger: Når Antennen sendes til stedfesting, sjekker Localizeren med Datakatalogen hva slags stedfesting som kreves, finner at det er Punkt, og sender antennten videre til punktstedfesting. Punktstedfesteren sender et søk til VVI, men siden antennen har en lang linjegeomtri blir søkeområdet større enn det VVI støtter. Her sendes det tilbake en dårlig ""Noe gikk galt""-feilmelding, istedet for å forklare hva som er problemet. Her burde vi ha laget en bedre feilmelding, men det er relativt sjeldent at lange linje-geometrier skal ha punkt-stedfesting, så vi har ikke snappet opp den før. Riktig feilmelding fikses enkelt.

Det andre problemet er at Simon, som god forvalter, prøver en annen metode for stedfesting når den første feiler. Han stedfester med ankerpunkter. Og det går utmerket. Ankerpunkt-stedfesting bruker ruteplanleggeren til VVI istedet for søk, og finner stedfestinger langs hele vegstrekket. Det burde den derimot ikke gjøre, for det er en kjent begrensning at ankerpunktstedfesting ikke skal støtte punkt-stedfestinger. Ankerpunkt-stedfesteren skal avvise punkt-stedfestinger med en forklarende feilmelding, men den sjekker bare om geometrien til objektet er et punkt, ikke hva slags stedfesting datakatalogen krever. siden antennen er en strekning, blir ikke stedfestingen avvist, men går gjennom som om det var en linje-stedfesting. Når Simon da prøver å lagre til Skriv, blir den avvist, fordi stedfesingen ikke er et punkt. Riktig feilmelding fra Ankerpunkt-stedfesteren fikses lett. Så da koker det ned til hovedproblemet, som er at Datafangst ikke har god nok funksjonalitet for å stedfeste strekningsobjekter som punkt.
h2.  Implementasjon

stedfesting med ankerpunkter avvises nå hvis Datakatalogen krever punkt-stedfesting

Punktstedfesteren har nå en fallback som lager søkeområde for VVI, basert på objektets senterpunkt. Vi finner senter i objektet og lager et søkeområde basert på det. En utfordring med å bruke senter som utgangspunkt er at senteret kan ligge langt unna veien, noe som er relativt sannsynlig når man har lange objekter med buet form langs en vei. For å sørge for at vi finner noe når senter ligger langt utenfor veie, utvider vi søkeområdet til nær maks av det VVI støtter.

Projisering mellom stedfesting og locational er også skrevet om, siden senterposisjonen ikke ligger på objektet. Vi blir derfor nødt til å finne det punktet på objektet som lilgger nærmest stedfestingen og lage en projisering mellom dem.

 

 

 

 ",NVDB-6937,Datafangst,
Bruk fylke i Solrspørring,"Når det spørres etter fylke=X blir dette til solrsøk municipality:(1 OR 2 ...), her kunne vi brukt county:X",NVDB-6937,Les-API,
Avvelge objekt etter godkjenning av stedfesting,"En bruker (Tina Vestersager) ønsker at objekter man godkjenner stedfestingen til skal automatisk ble deaktivert.
{noformat}
Etter stedfesting.. hvis man velger «godkjenn valgte stedfestinger» tenker jeg at valgte objekt automatisk burde settes som ikke valgt. Nå man finne dem i lista og deaktivere eller klikke på dem i kartet.
{noformat}",NVDB-6937,Datafangst,
API-import fjerner mellomrom på slutten av attributtverdier,"h2. Observasjon
Supportmail fra Sigmund i Triona, de får problemer med å importere skiltplater med enkelte typer. Det er 723.12 og U724.1r, og det disse har felles er at de i datakatalogen per i dag har et mellomrom på slutten av verdien. Mellomrommet blir fjernet ved import, noe som igjen  gjør at Skriv ikke klarer å matche dette til en gyldig attributtverdi.

h2. Analyse
Vi kjører en trim() på attributtverdier ved import, det er problematisk når vi er avhengig av at verdier matcher eksakt det som er i Datakatalogen.

h2. Forslag til løsning
Fjern de to trim()-kallene i GeoJsonNvdbDocumentConverter.",NVDB-6937,Datafangst,
Driftskontrakt V4 feiler pga størrelse,"Driftskontrakt: 9305 Sunnfjord, V4 feiler pga størrelse.

74 tables, and a total of 36.645 lines (avg. 495 lines/table)

Kjøringen blir hengende på generering av Excel-fil.

Tabellen som det stopper opp på har 3393 linjer!

Fra loggen:

2020-06-16 15:40:48,214 INFO [no.veg.nvd.fil.FileCreatorTemplate] (Thread-8) writeContent driftskontrakt with 74 tables, and a total of 36645 lines...
2020-06-16 15:40:48,214 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginFile
2020-06-16 15:40:48,375 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 0: '3 - Skjerm' (500 lines)
2020-06-16 15:40:48,650 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 1: 5 - Rekkverk
2020-06-16 15:40:55,282 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 2: 7 - Gjerde
2020-06-16 15:40:55,918 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 3: 9 - Kantstein
2020-06-16 15:40:56,849 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 4: 14 - Rekkverksende
2020-06-16 15:40:58,726 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 5: 15 - Grasdekker
2020-06-16 15:40:59,128 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 6: 20 - Kantstolper/Refleks
2020-06-16 15:40:59,344 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 7: 21 - Brøytestikk
2020-06-16 15:40:59,459 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 8: 22 - Ferist
2020-06-16 15:40:59,579 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 9: 24 - Skiltportal
2020-06-16 15:40:59,841 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 10: 25 - Leskur
2020-06-16 15:41:00,221 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 11: 26 - Lekeapparat
2020-06-16 15:41:00,450 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 12: 27 - Renovasjon
2020-06-16 15:41:00,766 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 13: 28 - Utemøbler
2020-06-16 15:41:00,958 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 14: 29 - Strøsandkasse
2020-06-16 15:41:01,090 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 15: 37 - Vegkryss
2020-06-16 15:41:01,372 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 16: 39 - Rasteplass
2020-06-16 15:41:01,554 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 17: 40 - Snuplass
2020-06-16 15:41:01,734 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 18: 42 - Kollektivknutepunkt
2020-06-16 15:41:01,924 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 19: 43 - Parkeringsområde
2020-06-16 15:41:02,057 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 20: 44 - Kontroll-/veieplass
2020-06-16 15:41:02,185 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 21: 45 - Bomstasjon
2020-06-16 15:41:02,342 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 22: 47 - Trafikklomme
2020-06-16 15:41:04,325 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 23: 48 - Fortau
2020-06-16 15:41:04,520 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 24: 49 - Trafikkøy
2020-06-16 15:41:04,765 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 25: 60 - Bru
2020-06-16 15:41:05,448 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 26: 62 - Støttekonstruksjon
2020-06-16 15:41:08,442 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 27: 64 - Ferjeleie
2020-06-16 15:41:09,618 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 28: 65 - Bygning
2020-06-16 15:41:09,763 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 29: 66 - Skredoverbygg
2020-06-16 15:41:09,892 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 30: 67 - Tunnelløp
2020-06-16 15:41:11,071 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 31: 72 - Bergsikring
2020-06-16 15:41:12,723 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 32: 78 - Lukket rørgrøft
2020-06-16 15:41:15,249 INFO [no.veg.nvd.fil.DriftskontraktExcelFileCreator] (Thread-8) writeBeginTable 33: 79 - Stikkrenne/Kulvert (3393 lines!)",NVDB-6827,Rapportgenerator,
Release alle komponenter og deploye til ATM og PROD,"* nvdb-rapport-api
To deployments (vanlig + egen dedikert for Veglister)
 * nvdb-rapport-gui
*Hvordan release nå som alle tre front-end applikasjonene er i felles kodebase?*
Separate deployments for Veglister, Driftskontrakter og Kostra",,Rapportgenerator,
Automatisk zoom aktiveres etter geometriredigering,"h2. Observasjon

Deaktiver automatisk zoom i datafanen. Rediger geometri for et objekt (bruker spesifiserer at dette gjelder linje geometri, men gjelder generelt geometriendring). Da blir automatisk zoom aktivert igjen.

Bruker ønsker at valgene som er satt skal gjelde også etter geometriredigering, dvs at automatisk zoom som er dekativert bør være deaktivert også etter geometriredigeringen.
h2. Analyse

mekanismen som resetter rediger-geometri-state resetter også feilaktig autozoom
h2. Løsning

Fjerner den biten av resetEditGeometryState som resetter autozoom.",NVDB-6937,Datafangst,
"Meterberegning, FV123","På FV123 er det et gap i meterverdier på lenkesekvens 971557 i punktet 0.85531374

 

> INFO ;Road=FV123, StretchType=S, TopologyLevel=0, TrafficTypes=K
 > WARN ;Segment1.MeterGap;3014;971557;0,85309189;0,85531374;998217;998220;0;;F;V;123;;S;1;1;6838;6858;K;;;;2;1#2;;297391;6614011;130;297411;6614020;130;Gap=313,000m
 > WARN ;Segment2.MeterGap;3014;971557;0,85531374;0,85697188;998220;3088194;0;;F;V;123;;S;1;1;7171;7186;K;;;;2;1#2;;297411;6614020;130;297424;6614027;130;Gap=313,000m

 

*Analyse:*

De ekstra meterene kommer fra [https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/916/1003465802/1 |https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/916/1003465802/1] på grunn av dette lukkede vegsystemet: [https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/915/1002103808/1]

 

*Løsning:*

Tar med start- og sluttdato for vegsystemet helt ut til sammenslåingen, slik at det kan filtreres på dette for å få riktige strekninger.",NVDB-6937,NVDB-IND,
Endringssett skriver ufullstendig turnextent til NVDB,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/1fe459af-fd6c-47cb-97e4-0594dbfee402 skriver inn en svingerestriksjon som mangler lenkesekvensid for til-punkt i NVDB:

NF_FV_0573_OF(NF_FEATUREVERSION_OT(1, '12-JUN-20', NULL, NULL, NULL), NN_TURNEXT
ENT_OT(100573, 92515, 50001, NN_REFLINKEXTENT_OT(100573, 72370, 50002, 0, 0, 0,
NULL, NN_REFLINKLOC_OT(.32645205), NULL), NN_REFLINKEXTENT_OT(100573, *NULL*, 5000
2, 0, 0, 0, NULL, NN_REFLINKLOC_OT(.44680832), NULL)), NULL, NULL)

h2. Analyse

I endringssettet registreres et vegobjekt av type Svingerestriksjon, der til-punktet i svingstedfestingen refererer til tempId for en veglenkesekvens som registreres i samme endringssett. Det ser ikke ut til at tempId erstattes med nvdbId før skriving til NVDB. Ved nærmere analyse ser det ut til at Feature.populateNvdbIds er synderen. Her oppdateres ikke nvdbId for fra- og tilpunktene med mindre noden også er tempId.

h2. Løsning

Flytt håndteringen av tempId for fra- og tilpunkt til utenfor håndteringen av noden i Feature.populateNvdbIds",NVDB-6937,Skriv-API,
Integrasjonstester mot SVV NVDB,"Endre integrasjonstestene til å kjøre mot SVV NVDB, i stedet for Triona NVDB",NVDB-6937,NVDB-IND,
Begrens antallet samtidige spørringer til Solr,"I tillegg til ratelimit burde vi kanskje sette opp begrensning på hvor mange samtidige kall som skal tillates til Solr.
https://resilience4j.readme.io/docs/bulkhead kan brukes, eller et vanlig threadpool.",NVDB-6937,Les-API,
Følgeoppdateringskonflikt ved sletting av datter i assosiasjon,"h2. Observasjon

Endringssettet https://www.test.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/0c5bc7de-99c2-4f38-b716-577114a0d632 avvises med valideringsfeil:


{code:xml}
<vegobjekt nvdbId=""1007893658"" versjon=""1"">
  <feil>
    <feil kode=""KONFLIKT_MELLOM_VEGOBJEKTER"">
      <melding>
        Kunne ikke fullføre følgeoppdatering i forbindelse med lukking av morløse vegobjekter: Oppdatering av vegobjektversjon 1007893658:1 av type 95 med startdato 2020-05-05 fører til ugyldig lukking av vegobjektversjon 1007893718:1 av type 96 som har startdato (2020-05-12) etter/lik førstnevntes startdato.
      </melding>
    </feil>
  </feil>
</vegobjekt>
{code}

h2. Analyse

APIet protesterer fordi slettingen av datterobjektkoblingen i det skiltpunktet som oppdateres (overskrives), skaper en følgeoppdatering under behandling. Følgeoppdatering består i å lukke datterobjektet (kan ikke eksistere uten morobjekt), men siden startdato for datterobjektet er etter startdato for morobjekt, skulle datterobjektet egentlig vært fjernet. En svakhet i API Skriv, altså. 

h2. Løsning

Ingen kodeendringer i for denne saken. Dette fikses ved å realisere et gammelt endringsønske: NVDB-4058.",NVDB-6937,Skriv-API,
Opprydding i permissions,"NB! Database-script: Ny rettighet
 * egen permission for å se kontraktgruppeadmin
 * Erstatte wildcard med egnet, navngitt metode
 * Fjerne metode som løfter enkelte permissions ut av scope
 * refaktorer permissions
 * I contract settings blir CONTRACTGROUP:REMOVE ikke gitt riktig fordi UserSession ikke er lastet når permission sjekkes
 * Permissions-endepunktet lister unødig ut duplikate permissions
 * Bare brukere med global comment-rettigheter får lage nye kommentarer
 * hasPermission() er implementert 3 ganger, i 2 forskjellige permissionResolvere og i securityService. Fjerner og refaktoriserer slik at bare UserSession.hasPermission finnes
 * Flere enhetstester for permissions",NVDB-6937,Datafangst,
/veg med vegsysref kan gi detaljerte lenker,"Her blir av og til detaljerte lenker returnert:

[https://www.vegvesen.no/nvdb/api/v3/veg?vegsystemreferanse=EV18S50D1m1100]

 

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@247592,6645337,17/vegnett:~'metrering+~()/vegsystemreferanse:247572.285:6645318.651]",NVDB-6937,Les-API,
Vegkart: Liten og stor bokstav for meter,"I vegnettshåndboka og i lese-apiet, så skrives fullstendig vegsystemreferanse sin ""m"" for meter med liten bokstav slik: *EV16 S1D1 m942*. Dette gjøres også når du peker på et punkt i Vegkart. Når du lister opp objekter i Vegkart, så har ""m"" blitt til ""M"". Ingen stor sak, men dette skal helst være likt. (Vi har faktisk fått spørsmål om dette.)",NVDB-6937,Vegkart,
NVDBREF-688 : Feil visning av søkeutvalg,"Jeg ønsker å se trafikklommer på RV83S1-2, og søker opp dette.
 Etter å ha trykket på ""enter"" kommer stedsanvisning: RV83 S1 opp. Det kommer altså ikke fram i søkefeltet at jeg har data for S2 også.

Jeg får altså opp trafikklommene for både S1 og S2, men S2 mangler i stedsangivelsen. Se vedlagt bilde.

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@565032,7622045,9/hva:~(~(id~47))/hvor:~(vegsystemreferanse~(~'RV83S1-2]))",NVDB-6937,Vegkart,
NVDBREF-694: Prøveinnsjekk skal kjøre alle kontroller uten å stoppe,"h2. Bakgrunn

Innspill fra Linda:

Ved prøveinnsjekk av et vegnettsprosjekt stoppes dette når valideringen finner første feil. Dette betyr at brukeren må starte prøveinnsjekket mange ganger for til slutt å ha avdekket alle feil og mangler. Det er derfor ønskelig at når prøveinnsjekket finner en feil, så logges denne, og så går prøveinnsjekket videre til alle valideringer er kjørt.

Vi kan jo komme i situasjoner der en feil gir følgefeil på ""noe annet"" uten at ""dette andre"" egentlig er feil. F.eks. kan feil i nettverket gjøre at det også vil meldes feil i objekter - som altså ikke vil være feil når nettverket blir fikset. For å unngå at brukeren får mange meldinger på feil som egentlig ikke er feil, kan det være en løsning at alle nettverksvalideringer (inkludert geometrivalideringer) kjøres ferdig, og dersom det er feil i nettverket, så samles disse opp og prøveinnsjekket stoppes. Så kan brukeren rette feilen(e), og starte prøveinnsjekk på nytt. Når det ikke er feil på nettverket, så valideres objektene, og alle feil på disse logges. Om vi også her kan komme i situasjoner der en feil gir følgefeil på noe annet som ikke er feil klarer jeg ikke helt å se for meg. Det bør vi tenkte nøye igjennom.

Så er jo spørsmålet om dette programmessig lar seg gjennomføre? Det må vel Tore EA svare på. 

h2. Analyse

Dette er beslektet med NVDB-5271 (rullet ut i slutten av april), der pipelinen for valideringsendepunktet, DataQualityOnlyPipeline, ble justert til å fullføre flere valideringer, selv om det ble avdekket feil. Det ble realisert ved at JobFeatureFilters ikke avbryter kjøring av feature filtere før alle filtere er kjørt på alle features. Før ble valideringen avbrutt etter første FeatureFilter-instans som fant feil. I tillegg ble det parametrisert hvorvidt pipelinen skulle avbrytes ved feil etter hver instans av JobFeatureFilters. Justeringen internt i JobFeatureFilters kom oss også tilgode i BeforeLockingPipeline som brukes ved vanlig behandling av endringssett. Siden april har derfor prøveinnsjekk funnet flere feil før valideringen ble avbrutt.

Det er 100% umulig å få til et prøveinnsjekk som avdekker alle feil. Det er mange valideringsfiltere som kontrollerer grunnleggende ting som at typeId på vegobjekter og egenskaper finnes i datakatalogen, historikken til vegobjekter er sammenhengende og uten hull, og at vegnett henger sammen topologisk via portkoblingene og at portnummere og veglenkenummere er unike. Dersom disse grunnleggende valideringene finner feil er det helt meningsløst å fortsette med annen validering fordi vi vil få potensielt mange misvisende eller pussige feil (i verste fall systemfeil, fordi etterfølgende validatorer forutsetter at grunnstrukturer er korrekte) som bare vil forvirre brukeren.

Foranledningen for saken var at en bruker opplevde at valideringen av gatenavn og -kode bare leverte delvis oversikt over feil. Det stemmer ikke. Denne valideringen går gjennom samtlige Gate-objekter, før pipelinen evt. avgjør om videre validering skal avbrytes.

h2. Løsning

Bygget om mekanismene for avbrudd. Feil fører ikke lenger til automatisk avbrudd uansett hvor de oppstår. Det er de ulike filtrene sitt ansvar å kalle ValidationResult.abortProcessing() dersom en feil anses å være så grunnleggende at videre validering er meningsløs. Dette anropet ble fjernet fra en del filtere som ikke tilfredstilte dette kriteriet. Gjorde en del endringer i ulike iteratorfiltere (f.eks. JobFeatureFilters og FeatureAttributeFilters)for å gjennomføre avbrudd basert på ValidationResult.isProcessingAborted() i stedet for å se om det har oppstått feil.
",NVDB-6937,Skriv-API,
Synkronisere standard FKB objektliste i Datafangst med seneste Excel-objektliste,"h2. Observasjon

Sak er utledet fra en support-dialog med Tanja Molland Caliskaner (Tanja.Jeanette.Molland.Caliskaner@vlfk.no).

Objektlista i et nytt prosjekt er ikke den samme som seneste versjon av objektliste fra Excel for FKB-objekter. Objektliste fra Excel oppdateres (potensielt) hver gang det kommer en ny datakatalog. Det er mulig for bruker å importere objektliste fra Excel, og mange prosjekter gjør også tilpassinger i sin objektliste før de laster opp.

Utvides til å også omfatte problemer etter support-dialog med Anne Kirsti Tryggestad. Hun opplever at avkrysninger i excel-dokumentet ikke gir samsvar med det som vises i datafangst etter opplasting av excel, for FKB-objekter. Legger ved skjermbilder som viser excel-filen og datafangst etter import.
{quote}*Espen:*
 Ok. tolker jeg det riktig som at det ikke er samsvar med det som er haket av i excel-fila og det som blir haket av i datafangst?

og mer spesifikt at det er FKB-objekter det gjelder?
 eksempelvis så burde ikke FKB-objektene Kjørebanekant og Vegskulderkant være haket av i Datafangst siden de ikke er det i excel-lista?

*Anne:*
 Korrekt
{quote}
!image003.jpg|thumbnail!
h2. Analyse

Det er mulig at vi gir bruker et standardvalg (utdatert avkrysset objektliste) som ikke gir så mye mening for FKB. For NVDB-objekter leser vi oppdatert liste fra Datakatalogen, så disse trenger ikke noen synkronisering.
h2. Forslag til løsning

En mulighet er å prøve å være i sync med siste FKB objektliste på Excel, da må vi ha en rutine på å sjekke den hver gang det kommer ny versjon av datakatalogen.

En annen mulighet er å ikke ha valgt noe som default, sånn at bruker alltid må inn og laste opp riktig objektliste. Dette vil i så fall (tror jeg) bare være relevant for visse kontraktstyper.

Valg av løsning her bør gjøres i samråd med brukerne.",NVDB-6937,Datafangst,
FKB vegobjekttyper vises i feil rekkefølge i objektliste,"h2. Observasjon
Supportsak fra Tanja Molland Caliskaner (Tanja.Jeanette.Molland.Caliskaner@vlfk.no). Saken starter med at hun ikke fant igjen noen FKB-typer etter å ha importert objektliste fra Excel. Etter litt dialog viser det seg at de etterlyste typene er der, men de beholder ikke rekkefølge som er i Excel-dokumentet. Vi bevarer rekkefølge for alle NVDB-typer, men bare noen FKB-typer. Eksempel på FKB-typer som ikke kommer på riktig sted er kjørefelt, kjørebane og sykkelvegsenterlinje.

h2. Analyse
Vi har ikke noen kobling til en FKB-datakatalog, men vi har kjente typer i database. Der har vi også et sorteringsnummer, så jeg antar at det kun er snakk om å legge til nye kjente typer, og sette sorteringsnummer riktig.",NVDB-6937,Datafangst,
Endringssett avvises pga datter utenfor mor,"h2. Observasjon

Triona hevder at endringssettet https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/6e8d39a8-809e-45e0-8a69-0c1579024ec4 skal gå gjennom uten valideringsfeil. Det avvises imidlertid pga fire tilfeller av STEDFESTING_UTENFOR_MOROBJEKT.

h2. Analyse

Endringssettet inneholder delvis korrigering av et skiltpunkt (id 203117542 versjon 8) og tilhørende datterobjekter av type skiltplate og systemobjekt. Det avvises med feilkode STEDFESTING_UTENFOR_MOROBJEKT på datterobjektene.

Hvis vi ser nærmere på systemobjektet som korrigeres, så har dette id 487519680, versjon 1 og gyldighetsperiode 2014-02-25 ->

Morobjektet er skiltpunkt med id 203117542. I endringssettet korrigeres kun versjon 8 med gyldighetsperiode 2018-12-03 ->. Feilmeldingen er imidlertid knyttet til versjon 6 av skiltpunktet som har gyldighetsperiode 2014-02-25 - 2015-01-22. Denne versjonen har også assosiasjon til systemobjektet, men har ikke matchende stedfesting. Selv om det ikke meldes i status for endringssettet har vi samme situasjon for versjon 7.

Jeg mener det er korrekt å avvise endringssettet da det er versjoner av morobjektet som har overlappende gyldighetsperiode med datterobjektet men avvikende stedfesting. For å få dette endringssettet gjennom må det utvides med korrigering av stedfestingen til versjon 6 og 7 av skiltpunktet i tillegg.
",NVDB-6937,Skriv-API,
RuntimeException ved beregning av sideposisjon,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/b6f8a6ad-2b0d-44e1-8ac4-23771c211d08 avbrytes med SySTEMERROR under beregning av original sideposisjon ved restedfesting etter oppdatert vegnettsgeometri:

{code:java}
java.lang.RuntimeException: Failed to get line segmenet from locational. Locational part size: 0
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.lineSegmentFromPosition(SidePositionCalculator.java:153)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePositionForPointLocational(SidePositionCalculator.java:111)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePosition(SidePositionCalculator.java:99)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareSidePositions(SidePositionCalculator.java:85)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareUpdatedSidePositionToOld(SidePositionCalculator.java:55)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.compareUpdatedSidePositionToOld(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:609)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.postProcessApprovedRelocalization(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:566)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.lambda$addEnrichmentOrReportConflict$15(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:511)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.EnrichmentEvaluator.evaluate(EnrichmentEvaluator.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:548)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:160)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:132)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:392)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:162)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:136)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

RunbtimeException kastes fordi det ikke lykkes å finne en original refLinkPart for posisjon 0.84231232 (refLink 443409) som er gyldig på vegobjektets (87/628784632/1) sluttdato, 2016-12-14.

h2. Løsning

I stedet for å bruke sluttdato, som er ikke-inklusiv, brukes sluttdato - 1 dag i SidePositionCalculator.compareUpdatedSidePositionToOld. Dette sikrer at de korrekt refLinkParts finnes igjen.",NVDB-6937,Skriv-API,
Universell utforming småting ,"*Tips universell utforming:* 
 * Kunne bruke mellomrom til å velge fra liste
 * Kalenderikon bør ha alt-tekst ""Kalender: Velg gyldighetsdato for uttak fra NVDB""
 * I dag tabber man forbi ""velg rapport""-knappen når den er inaktiv. Kanskje den burde være med i tab-rekkefølgen, men inaktiv. Gjør det mer intuitivt at man må utføre flere handlinger før denne knappen blir aktiv. 
 * Det var litt lite intuitivt hva vegfilter - tekstboks skulle brukes til. Ingen gode løsningsforslag. 

 

 ",NVDB-6827,Rapportgenerator,
nvdb-read-api-v3-client: DatakatalogClient.getFeatureType(s) feiler,"DatakatalogClient's metoder getFeatureTypes og getFeatureType feiler med:

Error setting etag for /vegobjekttypernull: java.nio.file.NoSuchFileException: ?/.nvdb-api-read-v3/_vegobjekttypernull.etag

Versjon 1.8.4

Se log",,Rapportgenerator,
Alfabetisk sortering i admingrensesnitt for kontraktsgrupper,"Noen kontraktgrupper har veldig mange kontrakter. Det hadde vært kjekt å få sortert disse alfabetisk. 

Andre lister i admin-grensesnittet for brukere og kontraktsgrupper bør også sorteres alfabetisk for å være navigerbare.",NVDB-6937,Datafangst,
Sosikontroll av FKB-data,"Mail til datafangst-support
bq. Den 10.06.2020 10:03, skrev Espen Refsdal Thiem:
bq. Hei. 
bq. 
bq. Hvorfor har dere ikke integrert en sosikontroll av FKB-data på samme måte som for NVDB?
bq.  
bq. Mvh
bq. Espen Refsdal Thiem
bq. 
bq. Vestland Fylkeskommune, Infrastruktur og veg, Geodata
bq. Mobil: +47 41844169 
bq. Epost: espen.refsdal.thiem@vlfk.no
",NVDB-6937,Datafangst,
Tydeligere feilmelding ved multiple operasjoner på samme nvdbId-versjon,"h2. Bakgrunn

Et endringssett fra NovaPoint inneholdt både lukking og delvis korrigering av samme vegobjekt (identisk nvdbId og versjon). Dette ble avvist ved mottak via 400 BAD REQUEST og fault message ""Må være unik: nvdbId+versjon"". Dette er litt for knapt til at brukeren forstår hva som er problemet. Som et minimum må den konkrete nvdbId- og versjonsverdien angis.

h2. Analyse

Feilmeldingen stammer fra UniqueNvdbIdVersionValidator.

h2. Løsning

Introduserer skreddersydde feilmelding via expression properties i Hibernate Validation. Expression properties inneholder liste med id'er med duplikater. Skreddersømmen håndteres av ny klasse ConstraintViolationReporter.",NVDB-6937,Skriv-API,
Noen store meteravvik,"Sammenlignet med prod er det kommet noen store meteravvik vi må undersøke:

 

Segment nummer 15, fra lenke nummer 17 (""startposisjon"": 0.26205316,""sluttposisjon"": 0.26306464) har rar meterverdi, starter på 0 igjen.

[https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/1125774]

[https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:topo4/@707204,7712581,18/vegnett:~'geometri+~()/valgt:1125774:17:15/vegsystemreferanse:707198.993:7712573.409]

Strekning: [https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/vegobjekter/916/1004695694/1]

 

Andre eksempler på andre som kanskje er relatert:

WARN ;Segment1.MeterGap;5426;1126292;0,98023146;1;2834165;1259957;0;;E;V;6;;S;186;1;2333;2545;K;;;;2;1#2;;722173;7721645;18;722345;7721768;10;Gap=5627,865m
 WARN ;Segment2.MeterGap;5426;1126293;0;0,00958931;1259957;2834184;0;;E;V;6;;S;186;1;8173;8257;K;;;;2;1#2;;722345;7721768;10;722421;7721803;10;Gap=5627,865m

WARN ;Segment1.MeterGap;5426;1126293;0,47903275;0,48620153;2834173;2314049;0;;E;V;6;;S;186;1;6148;6212;K;;;;2;1#2;;726125;7720491;4;726185;7720472;4;Gap=6227,293m
 WARN ;Segment2.MeterGap;5426;1126293;0,48620153;0,59880558;2314049;2834174;0;;E;V;6;;S;186;1;12439;13427;K;;;;2;1#2;;726185;7720472;4;727030;7719967;6;Gap=6227,293m

WARN ;Segment1.MeterGap;4621;805598;0,31058791;0,31695888;2787308;2398686;0;;E;V;16;;S;10;60;2017;2071;K;A;;;2;1#2;;30543;6752137;50;30491;6752124;51;Gap=519,664m
 WARN ;Segment2.MeterGap;4621;2398663;0;0,50987059;2398686;2398682;0;;E;V;16;;S;10;60;2591;2670;K;A;;;2;1#2;;30491;6752124;51;30437;6752069;51;Gap=519,664m

 

*Løsning:*

Perioden til det aktuelle vegsystemet for segment blir brukt for å hente strekninger fra cache. Håndterer strekninger som overlapper med flere vegsystemobjekter i tid, slik at strekningsmeteren bare blir tatt med en gang. Verifisert med integrasjonstester for noen av de tilfellene som ble rapportert.

 ",NVDB-6937,NVDB-IND,
"teksten ved feltet ""legg til bruker"" burde vises hele tiden","På Instillinger, under Tilknyttede brukere, når du skal legge til en ny bruker kommer ikke teksten ""SVV-brukernavn eller e-postadresse må oppgis"" opp før du har gjort noe feil.

Legg gjerne til at det ikke er noen evaluering av epostadresse eller sjekk av at brukeren finnes, så folk må sjekke at de har skrevet brukernavn og/eller epost riktig",NVDB-6937,Datafangst,
"""Kopier til alle"" virker ikke når kvalitetsparametre er slått på.","h2. Observasjon

aktiver ""vis kvalitets parametre"".

Nå er det ikke lenger mulig å benytte funksjonene ""Kopier til alle"" med venner, i verktøymenyen.
h2. Analyse

FocusedAttribute-selectoren tar ikke høyde for kvalitetsparametre
h2. Løsning

focusedattribute-selectoren tar høyde for kvalitetsparametre

Lagde et knippe enhetstester som tester focusedFeature og FocusedAttribute

 

 ",NVDB-6937,Datafangst,
Tilpasse og rulle ut i Atlas (UTV),"* (/) Bytte køtype fra ""mirror"" til ""quorum"" i RabbitMQClient for bedre avbruddsikkerhet.
* (/) Etablere RabbitMQ-tjeneste i applikasjonsmiljø ""utvikling"".
* (/) Etablere logging og loggaggregering i tråd med Atlas-standarder.
* (/) Etablerer datasources programmatisk i API Skriv om de ikke finnes ved JNDI-oppslag
* (/) Tilpasse API Skrivs web-konfig til alle scenarier: Jetty, Tomcat, Integrasjonstester, Live integrasjonstester osv
* (/) Etablere velv med brukernavn og passord for jobdb og nvdb.
* (/) Etablere datasource og miljøvariable for de to databasene i deploymentbeskrivelse. 
* (/) Etablere velv med brukernavn og passord for soabasis.
* (/) Oppsett av pluginConfigDir, kontekststi m.m for Tomcat
* (/) Oppsett av Route, Probes og Resources
* (/) Støtte og konfigurere OpenIdConnect
* (/) Test",NVDB-6937,Skriv-API,
Fjern mulighet til å kategorisere/filtrere på egenskaper med skjermede data,"Når man prøver å filtrere på egenskaper med skjermede data, vil laster-indikatoren henge seg opp på grunn av 403-respons fra API-et.

 !Screenshot from 2020-06-03 08-51-38.png|thumbnail! 

Sjekk om det er mulig å gråe ut eller fjerne de egenskapene som er merket som sensitive.",NVDB-6937,Vegkart,
Legg til meter for strekningsobjekter i kategoriresultater,"{panel:title=Fra mail:}

Hei

I versjon 2 fikk vi opp antall meter når vi kategorisert objekten. F.eks Vegreferanse så fikk hvor mange meter det var av hver kategori.

 !Picture (Device Independent Bitmap) 1.jpg|thumbnail! 

Har dette forsvunnet eller er det jeg som velger noe feil i den nye versjonen ?

 !Picture (Device Independent Bitmap) 2.jpg|thumbnail! 

Vennlig hilsen

Arne Henry Grottvik
Fagansvarlig Veg – Idrett og Park
Tysvær kommune
Tlf 52 75 71 75 Mob. 901 46 683
E-post: arne.henry.grottvik@tysver.kommune.no


{panel}
",NVDB-6937,Vegkart,
Filopplasting feiler med exception fra SQL,"{quote}Tanja Jeanette Molland Caliskaner <Tanja.Jeanette.Molland.Caliskaner@vlfk.no>
{color:#172b4d}Tue 2020-06-02 11:33 {color}

{color:#172b4d}Hei!
{color}{color:#172b4d}Ser nå at en del sosi-filer blir forkastet med flammetegn eller innkjøring forbudt tegn etter opplastning, og det er bra! Men når det er flammer så er det ingen beskjed om hva som er feil. Har ingen eksempel å vise til akkurat nå da entreprenør fikset det uten å egentlig vite helt hvorfor filen ble akseptert til slutt. Da vi så på filoppbyggingen så så alt bra ut, men en kommentar om feil hadde vært topp.
{color}{color:#172b4d}Med vennleg hilsen
{color}{color:#172b4d}Tanja Molland Caliskaner{color}
{quote}
 

Last opp vedlagt fil,

Den feiler, og ""kontroll""-fanen sier at det er ""intern feil under behandling""

Loggen sier exception
{quote}at no.svv.nvdb.datafangst.database.DatabaseImpl.transactional(DatabaseImpl.java:111)at no.svv.nvdb.datafangst.database.DatabaseImpl.transactional(DatabaseImpl.java:111) at no.svv.nvdb.datafangst.orm.FeatureStorageImpl.saveFeatureValidationIssues(FeatureStorageImpl.java:413) at no.svv.nvdb.datafangst.submission.handler.GenericSubmissionHandler.saveFeatureValidationIssues(GenericSubmissionHandler.java:333) at no.svv.nvdb.datafangst.submission.handler.GenericSubmissionHandler.process(GenericSubmissionHandler.java:139) at no.svv.nvdb.datafangst.submission.SubmissionServiceImpl.lambda$createFeatureCollectionAsync$1(SubmissionServiceImpl.java:119) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748)Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Cannot add or update a child row: a foreign key constraint fails (`datafangst`.`validation_issue2`, CONSTRAINT `fk_vi2_feature_id` FOREIGN KEY (`feature_id`) REFERENCES `feature2` (`id`) ON DELETE CASCADE) at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
{quote}

h2. Analyse
Vegobjekter blir avvist (og dermed ikke lagret) etter validering mot Skriv, men før dette skjer så er det allerede lagret en advarsel fra SOSI-parsing som har en referanse til featureId. Når den første feilen skal lagres i databasen får vi da en referansefeil fordi feature ikke finnes.",NVDB-6937,Datafangst,
Vegkart krasjer konsekvent ved opplistning/visning av fagdata på enkelte rundkjøringer,"Jeg har oppdaget et problem med å hente data ved flere tilfeller. Dette ender ofte med et fullstendig krasj av vegkart og vi får et fint varselbilde om at vegkart har havnet i en ulykke. Under nærmere undersøkelse så har jeg funnet ut at dette krasjer er forårsaket av rundkjøringer i vegnettet som har problemer med å lese vegsystemreferansen. 

Her har dere link til hovedeksemplet mitt:

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-30953,6577346,16/hva:~(~(id~532)~(id~105)~(id~519))/hvor:~(vegsystemreferanse~(~'R13))]

[https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@-30953,6577346,16/hva:~(~(id~519)~(id~532)~(id~917))/hvor:~(vegsystemreferanse~(~'R13))]

Det virker som at det skjer et eller annet med tydingen av kryssdelen når rundkjøringen er koblet med lenker som har adskilte løp. Jeg har funnet to eksempler på forskjellige ""koblinger"" hvor dette er gjeldene. 

Hordaland:

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-38337,6732992,16/hva:~(~(id~532)~(id~105)~(id~519))/hvor:~(vegsystemreferanse~(~'F562))]

[https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@-38366,6732984,16/hva:~(~(id~917)~(id~519)~(id~532))/hvor:~(vegsystemreferanse~(~'F562))/valgt:1007884111:916]

Det som er interessant med hele denne saken, er at jeg har klart å løse problemet på et område. I stavanger så har vi i vegnettet definert enkelte kryss i gang- og sykkelvegnettet som rundkjøring. På et område så lå koblingspunktet til kryssystemet noen meter unna rundkjøringen. Veglenka lå heller ikke inne som rundkjøring i NVDB. I NVDB vegnett så gikk jeg inn og flyttet på kryssystemet til rett lenke knutepunkt og rettet opp lenka fra GSvegsenterlinje til rundkjøring. Plutselig kunne jeg nå i PROD hente og liste opp data uten krasj. Så det er mulig å rette opp i det. Men hadde vært fint å vite hva som egentlig fører til at dette er et problem:

GSrundkjøring FØR retting(test):

[https://vegkart.test.atlas.vegvesen.no/#kartlag:topo4/@-31902,6573213,18/hva:~(~(id~532)~(id~917))/hvor:~(vegsystemreferanse~(~'F441))/vegnett:~'geometri+~()/valgt:805722:3:7]

GSrundkjøring ETTER retting(prod):

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@-31906,6573215,18/hva:~(~(id~532)~(id~917))/hvor:~(vegsystemreferanse~(~'F441))]",NVDB-6937,Vegkart,
Bruke geometristruktur i konverteringsendepunktet,"h2. Bakgrunn

Nødvendige forbedringer av konverteringsendepunktene for SOSI og SosiGeoJson:

- Bruker nå gammel (streng-basert) egenskapsverdi (<verdi>) for geometri. Skal bruke (strukturert) <geometri>.
- Må kontrollere at VERT-DATUM bruker NN2000, siden det er det NVDB vil ha.

h2. Analyse & løsning

Konverteringen foregår i hhv klassene SosiConverter og SosiGeoJsonConverter. Oppdaterer geometrigenereringen der.",NVDB-6937,Skriv-API,
NPE ved utlisting av endringssett uten sorteringsnøkkel,"h2. Observasjon

Ved anrop til /nvdb/apiskriv/rest/v3/endringssett uten å angi parameter sorterPå gir NullPointerException.

h2. Analyse

Når ChangesetResource.getList anropes uten query-parameter vil JobSearch-instansen få null som verdi for sortField. Denne transporteres hele vegen inn til JdbcJobRepository.getAll som anroper SelectStatement.orderBy med null-verdien. Men den metoden kaster NPE dersom det orders er null.

h2. Løsning

Endret JobSearch.sortBy til å bare oppdatere sortField om parameteren er ulik null. JobSearch har allerede TIME som default sortField.",NVDB-6937,Skriv-API,
Vise mer info i eventlog når berikede vegobjekter er endret,"h2. Bakgrunn

Endringssett https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/b2d2498e-52ea-4f99-8d27-916f0f5c1783?inkluderResultat=NEI restartes automatisk fordi ""en annen prosess har endret enkelte objekter etter at denne prosessen leste dem fra NVDB"". Her ønskes informasjon om vegobjekttype, vegobjektid og bruker.

h2. Analyse

Meldingen har opphav i StaleFeatureVersionChecker. I dagens kode svarer denne bare med true eller false, og dersom true legges inn meldingen over i eventloggen.

h2. Løsning

StaleFeatureVersionChecker utvides til å returnere liste med beskrivelse av hva som er galt og hvilke vegobjektversjoner det gjelder. Listen puttes inn som event-data i JobWorker.hasStaleJobExtensions.",NVDB-6937,Skriv-API,
Sjekke om vi kan få færre segmenter for objekter,"Sjekk om det er mulig å slå sammen vegobjektsegmenter der segmentene er like, men har forskjellig dato.
 Kan muligens ses i sammenheng med NVDB-5592.

 

Løsning:

Lagt til et steg som slår sammen vegobjekt-segmenter som er like og henger sammen i tid. Funksjonaliteten kan skrues av ved å sette config: nvdbind.objectreader.segmenting.mergeintime=false.

Det ser ikke ut til å ha en veldig stor effekt. På typeId:105 utgjør det ~2000 dokumenter av 3,3millioner.",NVDB-6937,Les-API,
Støtte for ny versjon av excel-objektliste,"Fra bruker Tanja Molland Caliskaner

_Hei!_  

_I objektlisten i datafangst så ligger objektet FKB «fortauskant ytre». Dette er et utgått objekt, og har vært utgått en god stund. Det er erstattet av AnnetVegarealAvgrensning som er i listen. Objektet er fjernet fra siste oppdaterte excel objektliste som vegvesenet opererer med her: [https://www.vegvesen.no/fag/teknologi/nasjonal+vegdatabank/objektliste] så datafangst burde få oppdatert sin objektliste iht siste versjon av excel objektlisten. Det gjelder nok flere objekt enn fortauskant ytre, og jeg mener (uten å huske hvilke) det er noen objekt som er lagt til som ikke ligger i datafangst sin liste. Dette må dere sikkert diskutere internt, men det hadde vært fint at disse to objektlistene er like. Vi laster opp excel i datafangst og da kommer ikke alle objekt med, noe som er uheldig når prosjekt har tilpasset listen og entreprenør ikke finner objektene i datafangst._

Vi må se på hvilke endringer som er gjort, og passe på at vi nå støtter SVV 5.0 og Nye Veger 1.08.",NVDB-6937,Datafangst,
Automatisk test for sammenhengende meter,"Feil med metrering på vegnett blir oppdaget sent og gjerne av andre.

Vi skulle hatt en automatisk/halvautomatisk test som kan traversere deler av vegnettet og avdekker eventuelle usammenhengende meterverdier eller overlapp.

Vi kunne kjørt denne testen hver gang det er endringer i IND som kan påvirke metrering på vegnettet.

 

---

Sjekk med Håvard Lerstad om vi kan få testen han kjører så vi kan bruke den.",NVDB-6937,NVDB-IND,
Hente status på vilkårlig endringssett med tjenestebruker,"h2. Bakgrunn

Datafangst og muligens andre klienter som bruker tjenestebruker har behov for å kunne hente status for endringssett som har annen eier enn denne tjenestebrukeren. Anropende bruker av type tjenestebruker skal da får svar på følgende requester, uansett verdi på <id>:

{noformat}
GET /nvdb/apiskriv/rest/v3/endringssett/<id>/fremdrift
GET /nvdb/apiskriv/rest/v3/endringssett/<id>/fremdriftOgÅrsak
GET /nvdb/apiskriv/rest/v3/endringssett/<id>/status
{noformat}

h2. Analyse

Endepunktene /fremdrift og /fremdriftOgÅrsak er allerede tilgjengelig for alle brukere, uavhengig av eierskap. Endepunktet for /status, derimot krever i dag at anropende bruker enten eier endringssettet eller har Permission.GET_ANY_CHANGESET. Denne tilgangen er bare gitt til bruker med system-admin-rollen.

h2. Løsning

Etablerte nye Permissions: GET_OWN_CHANGESET_STATUS og GET_ANY_CHANGESET_STATUS. Sistnevnte ble koblet til tjenestebrukere i DefaultPermissionManager. Endret ChangesetResource.getStatus sin PermissionsAllowed-annotasjon til å akseptere GET_OWN_CHANGESET_STATUS og GET_ANY_CHANGESET_STATUS. Internt i metoden kontrolleres at anropende bruker har GET_ANY_CHANGESET_STATUS-permission hvis han/hun ikker eier endringssettet.",NVDB-6937,Skriv-API,
Små meteravvik på detaljerte lenker," 

Eksempel 1:

Her har den detaljerte lenka som krysser fått feil startmeter og kanskje sluttmeter. Den starter på meter 1009, men har meter 1013 (denne er lik i prod):

[https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:topo4/@289096,6746856,18/vegnett:~'geometri+~()/valgt:706451:1:20/vegsystemreferanse:289008.498:6746838.856]

 

Eksempel 2: 

-Her er det flere eksempel på avvik med både start/slutt-meter på detaljerte konnekteringslenker (denne er bedre i prod):-

-[https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:topo4/@289506,6746849,18/vegnett:~'geometri+~()/valgt:1997271:1:14/vegsystemreferanse:289008.498:6746838.856]-

Superstedfesting på detaljert lenke 1997271 er korrigert i prod, så derfor er det sannsynligvis datafeil vi ser i STM.

 

Eksempel 3:

< WARN ;Segment2.MeterGap;3421;705473;0,81553627;0,94109061;2254145;752481;1;;R;V;25;;S;11;1;10743;10767;K;;;;1;1;;355152;6795985;358;355169;6796011;357;Gap=6,482m

[https://vegkart.atlas.vegvesen.no/#kartlag:topo4/@355166,6796000,18/vegnett:~'geometri+~()/valgt:705473:5:7/vegsystemreferanse:293232.608:6740608.765]

Denne er lik i STM og PROD. Ser ut til å skyldes datafeil. To detaljerte lenker (706479 og 705473) slutter i samme punkt i geometri, men har forskjellig sluttpunkt i superstedfesting som gir forskjellige meterverdier på samme punket.

 

Eksempel 4:

WARN ;Segment1.MeterGap;5425;2491861;0;0,46369639;2491842;2491835;0;;E;V;6;;S;182;1;12320;12424;K;;;;1;1;;707495;7704877;37;707577;7704942;37;Gap=3,742m

WARN ;Segment2.MeterGap;5425;2491847;0;0,16867876;2491835;2836606;0;C;E;V;6;;S;182;1;12428;12436;K;;;;1;;;707577;7704942;37;707582;7704953;37;Gap=3,742m

[https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:topo4/@707589,7704959,18/vegnett:~'geometri+~()/valgt:2491847:1:8]

Kun i den siste kjøringen. Skyldes stedfesting og geometri som ikke henger sammen. Likt i prod.

  

Flere eksempler på tilsvarende i [https://ftp.triona.no/NyttVegNett-2020-Test/Logger-2020-05-27/Diff-STM1-STM2.log]

 

 ",NVDB-6937,NVDB-IND,
Enkel oppstartsskjerm for Vegkart,"Når Vegkart først laster så er det som regel et par sekunder først der skjermen er helt hvit. Hvis man har en treig nettleser eller treig internettforbindelse så kan denne perioden være lengre. (Tor sier at det har kommet rapporter om dette internt i SVV for de som bruker Edge.)

Det er lett å tro at det er noe feil med applikasjonen når man får opp en helt hvit skjerm, siden det ofte er sånn  tekniske feil arter seg ellers.

Vi kan legge på en enkel tekst og eventuelt en spinner som vises mens javaScript laster, sånn at bruker får opp noe på skjermen umiddelbart når den åpner vegkart.",NVDB-6937,Vegkart,
Valgt vegobjekt henger igjen på kartet,"Gå til:

https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@154239,6513881,12/hva:~(~(id~105)~(id~540))/hvor:~(fylke~(~42)~vegsystemreferanse~(~'FV411S3D1))/valgt:84193056:540

# Zoom til valgt objekt
# Kryss ut valgt vegobjekt.
# Se at den hvite linjen for valgt vegobjekt henger igjen i kartet.
# Det er ikke mulig å klikke på at annet vegobjekt på samme sted som den hvite linjen dekker.

 !Screenshot from 2020-05-26 13-47-15.png|thumbnail! 

Kan ta et par forsøk med klikk og utkryssing før feilen reproduseres.",NVDB-6937,Vegkart,
API-import: Egen feilmelding ved timeout eller feil mot Les,"Virker som Sinus Entreprenør og de som bruker den ute på veien sliter en del med timeout mot Les for tida. Vi kunne gjort det bedre for disse ved å kunne gi en spesifik feilmelding og kode for timeout eller andre midlertidige problemer mot Les.

Da kunne også Sinus forklare sine brukere at problemet var midlertidig, og vi hadde sluppet en del support for begge parter.",NVDB-6937,Datafangst,
SYSTEMFEIL ved beregning av sideposisjon,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/868e1f7d-9aaf-4e58-aad6-8a888b3d7e30 (og 7 andre fra oddlskil) havner i SYSTEMFEIL ved beregning av sideposisjon når et vegobjekt skal restedfestes i forbindelse med geometriutskiftning på vegnett:

{code:java}
java.lang.RuntimeException: No line segment found for refLinkPosition 1.0
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.lambda$lineSegmentFromPosition$2(SidePositionCalculator.java:151)
	at java.util.Optional.orElseThrow(Optional.java:290)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.lineSegmentFromPosition(SidePositionCalculator.java:151)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePositionForPointLocational(SidePositionCalculator.java:111)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePosition(SidePositionCalculator.java:99)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareSidePositions(SidePositionCalculator.java:85)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareUpdatedSidePositionToOld(SidePositionCalculator.java:55)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.compareUpdatedSidePositionToOld(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:607)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.postProcessApprovedRelocalization(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:564)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.lambda$addEnrichmentOrReportConflict$15(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:509)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.EnrichmentEvaluator.evaluate(EnrichmentEvaluator.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:546)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:159)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:116)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:129)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:391)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:161)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

Exception kastes fordi RefLinkPart.getLineSegmentAtPosition() ikke finner linjesegmentet av geometrien som dekker posisjon 1.0. Den aktuelle lenken dekker imidlertid intervallet [0.436352d, 1.0d]. Beregningen av linjesegment baserer seg på angitt geometrisk (3D) lengde for lenken, men denne ser ut til å avvike med ca 0,5 mm fra den virkelige lengden i dette tilfellet. Dette er nok til at algoritmen faller utenfor det siste linjesegmentet i geometrien og returnerer ingen funn.

h2. Løsning

Ny metode calcGeometricLength i RefLinkPart som regner ut eksakt geometrisk lengde. Denne metoden brukes alle andre steder i RefLinkPart der beregninger basert på geometrilengde utføres.",NVDB-6937,Skriv-API,
Vegobjekt med kun endring av mor i NVDB blir ikke etterbehandlet,"h2. Observasjon
Ser i forbindelse med testing av NVDB-5367 at et vegobjekt som kun har endret mor i NVDB ikke har fått status for assosiasjoner oppdatert etter at endringssett er ferdig behandlet.
Videre graving der viser at aktuelt vegobjekt ikke har {{nvdb_submission_id}} satt, slik at det ikke blir plukket opp som et vegobjekt som skal oppdateres når endringssettet etterbehandles.

Å sende inn endringer for dette vegobjektet på nytt vil gi feil, siden endringer i koblinger allerede er behandlet.

h2. Analyse
Vegobjektet var et eksisterende NVDB-objekt som ikke hadde andre endringer enn endring i mor, dette er antakeligvis en forutsetning. Når endringssettet settes sammen, så behandles kobling til NVDB-mor spesielt (se potensiell forbedring i NVDB-4510), så disse vegobjektene blir da tydeligvis ikke merket som at de er med i  endringssettet.

h2. Forslag til løsning
Vi kan merke de aktuelle vegobjektene også med {{nvdb_submission_id}}, sånn at de følger samme løypa i etterbehandling. I så fall viktig å teste grundig, jeg har ikke oversikt over om det vil ha noen konsekvenser ut over dette.

Alternativet er å se behandle innholdet i resultatet vi får fra Skriv, i stedet for å bruke {{nvdb_submission_id}}. Dette er en ganske omfattende endring, og vil nok kreve en del jobb å få riktig.",NVDB-6937,Datafangst,
Avviser detaljert lenke pga ugyldig felt på sluttdato,"h2. Observasjon

Epost fra Hans Jørgen:

En bruker i Agder får dette endringssettet avvist med mange meldinger om ugyldig felt:
 
https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/b9c40b03-4fb6-42a2-a5bc-96af9f865d8c
 
Han har lagt inn konnekteringslenker inn og ut av rundkjøringen. Dette er gjort ved å opprette nye lenker på eksisterendelenkesekvenser, slik at det blir historikk på alle nivåer. Ingen nye lenkesekvenser i bildet her.
 
NVDB Vegnett melder ikke om noe feil og jeg klarer heller ikke å finne noen. Det er selvsagt en viss sjanse for at det er noe jeg ikke klarer å se her, men tror vi trenger litt hjelp til å forstå.

h2. Analyse

Endringssettet avvises med en rekke feilmeldinger. De fleste avdekkes i SuperLocationLaneExistsValidator som har som oppgave å validere at et felt brukt i en superstedfesting faktisk finnes i hovedveglenkesekvensen i levetiden til den detaljerte veglenken.

I endringssettet oppdateres hovedveglenkesekvens 2432560 med endret veglenke nr 1 og tre nye veglenker. Etter oppdateringen har veglenkesekvensen følgende veglenker:

* Nr 1 - gyldig: 2012-07-05 - 2020-05-20, dekker: 0.0 - 0.848741, felt: 1#2
* Nr 4 - gyldig: 2020-05-20 - >, dekker: 0.0 - 0.848741, felt: 1#2
* Nr 2 - gyldig: 2012-07-05 - 2020-05-20, dekker: 0.848741 - 1.0, felt: 1#2
* Nr 3 - gyldig: 2020-05-20 - >, dekker: 0.848741 - 1.0, felt: (ingen), konnekteringsveglenke

I samme endringssett oppdateres detaljert veglenkesekvens 2432559, og veglenke nr 2 ser slik ut etter oppdatering:

* Nr 2 - gyldig: 2012-07-05 - 2020-05-20, superstedfesting: 0.848741 - 1.0, felt 1

I SuperLocationLaneExistsValidator valideres at felt 1 finnes for 0.848741 - 1.0 på hovedveglenkesekvensen, både på startdato og sluttdato for den detaljerte veglenken. For startdato går dette bra, siden felt 1 finnes for hele veglenkesekvensen på den datoen. For sluttdato finnes imidlertid bare hovedveglenke nr 3, som ikke har felt siden det er en konnekteringslenke. Validatoren varsler derdor dette som feil.

Dette er en bug i API Skriv, fordi sluttdato alltid er ikke-inklusiv. Når det skal valideres på gyldighet for sluttdato, må vi bruke *dagen før*, som er siste inklusive gyldighetsdato.

h2. Løsning

La inn ny metode getValidToInclusive() i Feature, Node og RefLinkPart som leverer siste gyldige dato i objektets levetid. Bruker denne i stedet for getValidTo() i SuperLocationLaneExistsValidator og andre lignende scenarier.",NVDB-6937,Skriv-API,
Finner ikke meter på grunn av avvik i siste desimal eller treffer feil strekning,"Det finnes endel tilfeller der meterberegning ikke finner start eller sluttmeter på grunn av relativ posisjon på beregnet/segmentert superstedfesting avviker 0.00000001 fra start/sluttpos for strekning.
Eksempel:
https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/444364.json
https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/444364.json

Her har veglenke 11 et segment 0.12170972-0.1239413@444364, super: 0.36141955-0.36808559@443149

Strekningen som er beregnet for dette segmentet er
https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/916/1003623307/1.json 
som er stedfestet på 0.36141956-0.44850952@443149

Vi legger til at avvik på 0.00000001 «snapper» til den tidligere beregnede strekningen.",NVDB-6937,NVDB-IND,
Direktelenking av filtre med tekst,"Gå til 

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-51388,6620725,16/hva:~(~(filter~(~(operator~'*3d~type_id~11404~verdi~(~'*2a307946*2a)))~id~301)~(filter~(~(operator~'*3d~type_id~11109~verdi~(~'*2a307946*2a)))~id~234))/vegnett:~'geometri+~()|https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-51388,6620725,16/hva:~(~(filter~(~(operator~'*3d~type_id~11404~verdi~(~'*2a307946*2a)))~id~301)~(filter~(~(operator~'*3d~type_id~11109~verdi~(~'*2a307946*2a)))~id~234))/vegnett:~'geometri+~() ] 

og se at tekststrengene i filteret ikke blir parset riktig.

Start med å se på HashToState.hvaState() om filteret blir parset riktig der. Dersom ja, gå videre til komponenten Egenskapsfilter og se om komponenten leser state riktig.",NVDB-6937,Vegkart,
Ta med ID til morobjektet,Hvis man ber NVDB api om å inkludere relasjoner så får man ID og type til mor eller mødre i relasjonstreet. ,NVDB-6827,Rapportgenerator,
Utvidet og konfigurerbar timeout mot Skriv,"h2. Observasjon

Phillip Longva Karlsen (Phillip.Longva.Karlsen@sandefjord.kommune.no) får problemer med å sende inn til NVDB fra sitt prosjekt fordi han sender inn ~11000 objekter i en innsending, og vi treffer vår hardkodede timeout mot Skriv på 25 sekunder.
h2. Analyse

25 sekunder er kanskje litt i vel korteste laget her. Dette er timeout for å lese svar, vi har en separat (og kortere) timeout for å koble opp.
h2. Forslag til løsning

Vi burde både gjøre denne timeout'en konfigurerbar (med default-verdier), og sette den høyere som default.
h2. Løsning

La til configbare verdier i datafangst.config
{quote}{{Write APi Client timeout in milliseconds}}
{{writeApiConnectionTimeout=5000}}
{{writeApiReadTimeout=60000}}
{quote}
{{Disse har også defaultverdier satt til det samme i Integration plugin.}}

Disse verdiene settes nå direkte på client-objektet, og ikke lenger som overrides inne på NvdbWriteApiGateway

 ",NVDB-6937,Datafangst,
Appkræsj ved meterverdi = 0 i vegsystemreferanse,"https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@264898,7030140,16/hva:~(~(id~915))/valgt:1002201965:915


{code:java}
TypeError: Cannot read property 'toFixed' of null
    at e.toString (Vegsystemreferanse.ts:72)
    at t.toVegkartKortform (Vegsystemreferanse.ts:18)
    at VegobjektComponent.tsx:192
    at t.VegobjektComponent (VegobjektComponent.tsx:78)
    at Ho (react-dom.production.min.js:153)
    at vs (react-dom.production.min.js:261)
    at cu (react-dom.production.min.js:246)
    at su (react-dom.production.min.js:246)
    at Qs (react-dom.production.min.js:239)
    at react-dom.production.min.js:123
    at e.unstable_runWithPriority (scheduler.production.min.js:19)
    at Bi (react-dom.production.min.js:122)
    at Vi (react-dom.production.min.js:123)
    at Wi (react-dom.production.min.js:122)
    at tu (react-dom.production.min.js:240)
    at Object.notify (Subscription.js:19)
    at t.e.notifyNestedSubs (Subscription.js:92)
    at t.e.handleChangeWrapper (Subscription.js:97)
    at v (redux.js:221)
    at middleware.ts:34
    at middleware.ts:21
    at index.js:11
    at dispatch (redux.js:638)
    at fetchVegobjekter.ts:65
{code}
",NVDB-6937,Vegkart,
"Endring av kontraktsgruppe feiler, sletter ikke gammel kobling","h2. Observasjon

Jeg slet med endring av kontraktsgruppe på en kontrakt i prod som allerede hadde en gruppe. Endra gruppe uten feilmeldinger, men gammel gruppe var fortsatt på plass etter reload av kontrakt.

Så etter hvert at kontrakten fikk _to_ kontraktsgrupper i databasen etter endring, både den eksisterende og den som jeg endra til.
h2. Analyse

En bug har ført til at gamlel kontraktgrupper ikke ble fjernet som tenkt. I tillegg slettes bare en av da gamle kontraktene ved flytting, så hvis en kontrakt hadde fått flere grupper, kunne det ikke løses uten å kjøre SQL manuelt. Det betyr at det antakelig finnes flere kontrakter med flere grupper.

Fant også en bug der vi bare ser på roller for å avgjøre om en bruker har rettigheter til å flytte kontrakter, istedet for å bruke PermissionResolver, som gjorde at global admin ikke kunne flytte kontrakter uten å også være administrator for gruppene
h2. Løsning

Vi sjekker nå rettigheter ved å bruke PermissionResolver.

Ved tilegning av ny kontraktgruppe fjernes nå alle gamle kontraktgrupper.",NVDB-6937,Datafangst,
Global admin kan ikke endre kontraktsgruppe,"h2. Observasjon
Som global admin kan jeg sette kontraktsgruppe for en kontrakt selv om jeg ikke er medlem av kontraktsgruppa. Når jeg etterpå prøver å endre til en annen kontraktsgruppe så får jeg ikke lov til dette, med melding om at jeg ikke har rettigheter til å fjerne kontrakten fra den eksisterende gruppa.",NVDB-6937,Datafangst,
Metrering på fylkesveger som krysser fylkesgrense,"Fylkesveger som krysser fylkesgrenser får ikke sammenhengende metrering.

Endres slik at fylkesveger behandles likt Riks og Europaveier.

 

Eksempel:

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-43292,6632597,12/hva:~(~(id~916))/hvor:~(vegsystemreferanse~(~'FV4942))/vegnett:~'metrering+~()/valgt:1003459772:916]

 

*Løsning:*

Endret håndtering av fylkesveger slik at det blir likt som for riks- og europaveger. Denne saken krever full indeksering.",NVDB-6937,NVDB-IND,
userDao.hasRole() funker ikke hvis rollen forekommer flere ganger,"h2. Observasjon

En særegenhet i userDao.hasRole() gjør at en rolle ikke blir resolvet hvis den er satt flere ganger.

den returnerer true hvis oppgitt rolle opptrer kun en gang (count = 1). Av en eller annen grunn har jeg ADMIN-rollen satt 2 ganger.

metoden brukes i dag bare for å sjekke om en bruker har ADMIN-rollen, hvor den fungerer greit for alle andre enn meg, men man kan se for seg at den kan brukes for å avgjøre om en bruker har gruppeadmin-rollen for en eller flere grupper, og da vil den ikke fungere.
h2. Tiltak

endre til count > 0",NVDB-6937,Datafangst,
Noder slettes ikke,Ved transaksjoner som sletter noder slettes ikke noden fra Solr.,NVDB-6937,NVDB-IND,
Vegobjekter importert fra kart ikke tilgjengelig for ekstern API,"h2. Observasjon
Vegobjekter som importeres fra kartet i datafanen legges i ikke i noen ""fil"" / FeatureCollection. Dette gjør at de ikke er tilgjengelige for ekstern API, men de finnes fortsatt i kontrakten. Dette gjør at f.eks. Sinus Entreprenør ikke kan få ut alle vegobjekter i en kontrakt, og ikke på forhånd kan oppdage duplikater i kontrakt.

h2. Analyse
Vi kan legge importerte vegobjekter i en felles samling for ""importerte vegobjekter"", eller vi kan opprette en ny samling per import. Vi bør tenke litt framover mot en opprydding av fil-fanen, men dette bør kunne implementeres før vi endrer på filfanen.",NVDB-6937,Datafangst,
mål bruk av stedfesting 1,"h2. Observasjon

vi må måle bruk av stedfesting 1 slik at vi vet når vi kan slå det av.
h2. Tiltak 

Lasting av siden logger nå meldingen ""User has requested Locational1""",NVDB-6937,Datafangst,
Ruteberegning: Kneler ved for store geometrier,"h2. Observasjon

Datafangst forsøkte å stedfeste en laaang LINESTRING via API Skriv. Request-URL til ruteberegner var:


{noformat}
https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING+%28-39394.61+6562838.58%2C+-39396.05+6562838.13%2C+-39397.48+6562837.7%2C+-39397.74+6562838.55%2C+-39398.03+6562839.52%2C+-39398.58+6562841.47%2C+-39399.11+6562843.44%2C+-39399.54+6562845.13%2C+-39399.61+6562845.39%2C+-39399.84+6562846.38%2C+-39400.08+6562847.36%2C+-39400.31+6562848.35%2C+-39400.52+6562849.34%2C+-39400.67+6562849.98%2C+-39400.8+6562850.63%2C+-39400.95+6562851.33%2C+-39401.23+6562852.74%2C+-39401.34+6562853.38%2C+-39401.41+6562853.94%2C+-39401.46+6562854.49%2C+-39401.48+6562855.06%2C+-39401.49+6562855.62%2C+-39401.46+6562856.19%2C+-39401.42+6562856.76%2C+-39401.35+6562857.31%2C+-39401.24+6562857.87%2C+-39401.22+6562858.04%2C+-39401.11+6562858.5%2C+-39400.99+6562858.96%2C+-39400.83+6562859.5%2C+-39400.65+6562860.04%2C+-39400.44+6562860.57%2C+-39400.21+6562861.08%2C+-39399.96+6562861.59%2C+-39399.69+6562862.08%2C+-39399.4+6562862.57%2C+-39399.09+6562863.03%2C+-39398.75+6562863.5%2C+-39398.41+6562863.94%2C+-39398.04+6562864.37%2C+-39397.66+6562864.78%2C+-39397.33+6562865.1%2C+-39397+6562865.41%2C+-39396.83+6562865.56%2C+-39396.47+6562865.86%2C+-39396.1+6562866.16%2C+-39395.96+6562866.26%2C+-39395.49+6562866.59%2C+-39395.02+6562866.89%2C+-39394.86+6562866.98%2C+-39394.12+6562867.42%2C+-39393.22+6562867.92%2C+-39392.3+6562868.41%2C+-39391.38+6562868.87%2C+-39390.45+6562869.32%2C+-39389.51+6562869.75%2C+-39388.56+6562870.17%2C+-39388.07+6562870.38%2C+-39387.62+6562870.56%2C+-39380.2+6562873.61%2C+-39379.26+6562873.99%2C+-39370.92+6562877.41%2C+-39369.63+6562877.94%2C+-39369.07+6562878.18%2C+-39368+6562878.61%2C+-39367.21+6562878.94%2C+-39366.74+6562879.13%2C+-39366.28+6562879.33%2C+-39365.48+6562879.66%2C+-39365.35+6562879.71%2C+-39364.89+6562879.9%2C+-39364.42+6562880.09%2C+-39363.96+6562880.28%2C+-39363.5+6562880.47%2C+-39363.42+6562880.5%2C+-39363.34+6562880.54%2C+-39361.64+6562881.23%2C+-39359.79+6562882%2C+-39358.2+6562882.64%2C+-39357.93+6562882.76%2C+-39356.65+6562883.28%2C+-39356.08+6562883.52%2C+-39355.77+6562883.64%2C+-39355.31+6562883.83%2C+-39354.21+6562884.28%2C+-39352.36+6562885.04%2C+-39351.76+6562885.29%2C+-39350.75+6562885.71%2C+-39350.5+6562885.8%2C+-39348.65+6562886.56%2C+-39348.42+6562886.66%2C+-39348.01+6562886.83%2C+-39346.8+6562887.32%2C+-39346.19+6562887.57%2C+-39345.28+6562887.95%2C+-39344.94+6562888.09%2C+-39343.09+6562888.85%2C+-39343+6562888.88%2C+-39342.54+6562889.07%2C+-39341.63+6562889.45%2C+-39341.22+6562889.61%2C+-39340.98+6562889.71%2C+-39340.48+6562889.92%2C+-39339.37+6562890.37%2C+-39338.89+6562890.57%2C+-39337.51+6562891.14%2C+-39337.07+6562891.32%2C+-39336.89+6562891.38%2C+-39335.66+6562891.9%2C+-39335.25+6562892.06%2C+-39333.8+6562892.66%2C+-39332.51+6562893.19%2C+-39331.95+6562893.42%2C+-39331.6+6562893.56%2C+-39330.09+6562894.19%2C+-39330+6562894.22%2C+-39328.23+6562894.94%2C+-39327.96+6562895.05%2C+-39326.38+6562895.7%2C+-39326.35+6562895.71%2C+-39326.14+6562895.8%2C+-39324.52+6562896.46%2C+-39324.32+6562896.55%2C+-39323.74+6562896.79%2C+-39323.41+6562896.92%2C+-39322.67+6562897.23%2C+-39320.81+6562897.99%2C+-39320.68+6562898.04%2C+-39318.96+6562898.75%2C+-39318.93+6562898.76%2C+-39318.86+6562898.79%2C+-39318.78+6562898.83%2C+-39318.69+6562898.86%2C+-39318.53+6562898.92%2C+-39318.41+6562898.97%2C+-39317.96+6562899.15%2C+-39317.22+6562899.46%2C+-39317.1+6562899.51%2C+-39317.05+6562899.54%2C+-39316.32+6562899.83%2C+-39316.14+6562899.91%2C+-39315.24+6562900.28%2C+-39314.53+6562900.57%2C+-39314.33+6562900.65%2C+-39313.64+6562900.93%2C+-39313.42+6562901.02%2C+-39313.38+6562901.04%2C+-39312.97+6562901.2%2C+-39312.52+6562901.39%2C+-39311.88+6562901.66%2C+-39311.61+6562901.76%2C+-39311.53+6562901.8%2C+-39310.71+6562902.14%2C+-39310.47+6562902.24%2C+-39310.37+6562902.28%2C+-39310.06+6562902.41%2C+-39309.81+6562902.51%2C+-39309.68+6562902.56%2C+-39309.14+6562902.78%2C+-39308.9+6562902.88%2C+-39308.64+6562902.99%2C+-39308.22+6562903.16%2C+-39308+6562903.25%2C+-39307.82+6562903.33%2C+-39307.3+6562903.54%2C+-39307.17+6562903.59%2C+-39307.09+6562903.62%2C+-39306.38+6562903.91%2C+-39306.19+6562903.99%2C+-39305.97+6562904.09%2C+-39305.46+6562904.29%2C+-39305.28+6562904.37%2C+-39304.38+6562904.74%2C+-39304.11+6562904.84%2C+-39303.47+6562905.11%2C+-39302.57+6562905.48%2C+-39302.25+6562905.6%2C+-39301.67+6562905.85%2C+-39300.76+6562906.21%2C+-39300.39+6562906.37%2C+-39299.86+6562906.59%2C+-39298.96+6562906.96%2C+-39298.54+6562907.13%2C+-39298.05+6562907.33%2C+-39297.15+6562907.7%2C+-39296.68+6562907.89%2C+-39296.25+6562908.07%2C+-39295.35+6562908.45%2C+-39295.17+6562908.51%2C+-39294.83+6562908.65%2C+-39294.65+6562908.73%2C+-39294.44+6562908.81%2C+-39293.54+6562909.18%2C+-39293.06+6562909.39%2C+-39292.97+6562909.42%2C+-39292.77+6562909.5%2C+-39292.64+6562909.55%2C+-39292.62+6562909.56%2C+-39292.46+6562909.63%2C+-39292.31+6562909.69%2C+-39292.16+6562909.75%2C+-39292.05+6562909.8%2C+-39292+6562909.82%2C+-39291.86+6562909.87%2C+-39291.73+6562909.92%2C+-39291.71+6562909.93%2C+-39291.56+6562910%2C+-39291.42+6562910.06%2C+-39291.33+6562910.09%2C+-39291.27+6562910.11%2C+-39291.18+6562910.15%2C+-39291.12+6562910.18%2C+-39291.06+6562910.19%2C+-39290.91+6562910.26%2C+-39290.85+6562910.3%2C+-39290.83+6562910.3%2C+-39286.61+6562912.02%2C+-39286.57+6562912.03%2C+-39286.47+6562912.08%2C+-39286.38+6562912.11%2C+-39286.28+6562912.15%2C+-39286.19+6562912.19%2C+-39286.1+6562912.22%2C+-39286.01+6562912.27%2C+-39285.92+6562912.3%2C+-39285.82+6562912.34%2C+-39285.73+6562912.38%2C+-39285.64+6562912.41%2C+-39285.54+6562912.46%2C+-39285.45+6562912.5%2C+-39285.35+6562912.53%2C+-39285.27+6562912.57%2C+-39285.18+6562912.6%2C+-39285.08+6562912.65%2C+-39285.06+6562912.65%2C+-39284.99+6562912.69%2C+-39284.89+6562912.72%2C+-39284.8+6562912.76%2C+-39284.71+6562912.79%2C+-39284.62+6562912.84%2C+-39284.53+6562912.88%2C+-39284.43+6562912.91%2C+-39284.34+6562912.95%2C+-39284.25+6562912.98%2C+-39284.15+6562913.03%2C+-39284.06+6562913.07%2C+-39283.96+6562913.1%2C+-39283.88+6562913.14%2C+-39283.78+6562913.18%2C+-39283.69+6562913.22%2C+-39283.6+6562913.26%2C+-39283.5+6562913.29%2C+-39283.41+6562913.33%2C+-39283.31+6562913.37%2C+-39283.22+6562913.4%2C+-39283.14+6562913.45%2C+-39283.04+6562913.48%2C+-39282.95+6562913.52%2C+-39282.85+6562913.56%2C+-39282.76+6562913.6%2C+-39282.67+6562913.64%2C+-39282.57+6562913.68%2C+-39282.48+6562913.71%2C+-39282.39+6562913.75%2C+-39282.3+6562913.79%2C+-39282.21+6562913.83%2C+-39282.11+6562913.87%2C+-39282.02+6562913.9%2C+-39281.92+6562913.94%2C+-39281.83+6562913.97%2C+-39281.73+6562914.02%2C+-39281.65+6562914.06%2C+-39281.56+6562914.09%2C+-39281.46+6562914.13%2C+-39281.37+6562914.16%2C+-39281.27+6562914.21%2C+-39281.18+6562914.25%2C+-39281.09+6562914.28%2C+-39280.99+6562914.32%2C+-39280.91+6562914.36%2C+-39280.81+6562914.4%2C+-39280.72+6562914.44%2C+-39280.63+6562914.47%2C+-39280.53+6562914.51%2C+-39280.44+6562914.55%2C+-39280.34+6562914.59%2C+-39280.25+6562914.63%2C+-39280.17+6562914.66%2C+-39280.07+6562914.7%2C+-39279.98+6562914.74%2C+-39279.88+6562914.78%2C+-39279.79+6562914.82%2C+-39279.69+6562914.86%2C+-39279.6+6562914.89%2C+-39279.52+6562914.93%2C+-39279.42+6562914.97%2C+-39279.33+6562915.01%2C+-39279.23+6562915.05%2C+-39279.14+6562915.08%2C+-39279.12+6562915.09%2C+-39274.41+6562917.03%2C+-39273.92+6562917.24%2C+-39273.67+6562917.34%2C+-39273.48+6562917.41%2C+-39273.26+6562917.5%2C+-39272.76+6562917.71%2C+-39272.55+6562917.8%2C+-39271.86+6562918.08%2C+-39270.7+6562918.56%2C+-39270.05+6562918.82%2C+-39269.16+6562919.19%2C+-39269.14+6562919.2%2C+-39268.85+6562919.32%2C+-39267.34+6562919.94%2C+-39266.99+6562920.08%2C+-39265.13+6562920.85%2C+-39264.62+6562921.05%2C+-39263.27+6562921.61%2C+-39261.91+6562922.16%2C+-39261.42+6562922.37%2C+-39260.1+6562922.9%2C+-39259.56+6562923.13%2C+-39259.21+6562923.27%2C+-39258.31+6562923.65%2C+-39257.71+6562923.9%2C+-39256.5+6562924.39%2C+-39255.85+6562924.65%2C+-39255.6+6562924.76%2C+-39254.09+6562925.37%2C+-39254+6562925.41%2C+-39253.84+6562925.48%2C+-39253.79+6562925.5%2C+-39252.15+6562926.17%2C+-39251.16+6562926.58%2C+-39251.09+6562926.61%2C+-39250.28+6562926.94%2C+-39248.43+6562927.7%2C+-39248.38+6562927.72%2C+-39246.75+6562928.39%2C+-39246.58+6562928.46%2C+-39246.31+6562928.57%2C+-39245.68+6562928.82%2C+-39244.72+6562929.22%2C+-39242.97+6562929.94%2C+-39242.86+6562929.99%2C+-39242.32+6562930.2%2C+-39242.02+6562930.33%2C+-39241.01+6562930.75%2C+-39240.22+6562931.07%2C+-39239.15+6562931.51%2C+-39237.52+6562932.18%2C+-39237.29+6562932.27%2C+-39236.83+6562932.46%2C+-39235.43+6562933.04%2C+-39235.2+6562933.13%2C+-39234.82+6562933.28%2C+-39233.86+6562933.68%2C+-39233.58+6562933.79%2C+-39232.85+6562934.09%2C+-39232.12+6562934.4%2C+-39231.73+6562934.55%2C+-39231.26+6562934.74%2C+-39230.8+6562934.93%2C+-39230.32+6562935.13%2C+-39230.19+6562935.18%2C+-39229.95+6562935.28%2C+-39229.87+6562935.31%2C+-39229.83+6562935.33%2C+-39229.51+6562935.46%2C+-39229.42+6562935.49%2C+-39229.18+6562935.59%2C+-39229.04+6562935.65%2C+-39228.94+6562935.69%2C+-39228.81+6562935.74%2C+-39228.52+6562935.87%2C+-39228.01+6562936.07%2C+-39227.62+6562936.23%2C+-39227.39+6562936.33%2C+-39227.34+6562936.34%2C+-39227.08+6562936.45%2C+-39226.72+6562936.6%2C+-39226.62+6562936.64%2C+-39226.51+6562936.68%2C+-39226.16+6562936.83%2C+-39225.99+6562936.9%2C+-39225.82+6562936.96%2C+-39225.23+6562937.21%2C+-39224.92+6562937.33%2C+-39224.48+6562937.52%2C+-39224.3+6562937.59%2C+-39223.37+6562937.97%2C+-39222.47+6562938.33%2C+-39222.43+6562938.34%2C+-39222.18+6562938.41%2C+-39221.92+6562938.47%2C+-39221.77+6562938.5%2C+-39221.45+6562938.57%2C+-39221.22+6562938.62%2C+-39220.93+6562938.69%2C+-39220.45+6562938.79%2C+-39220.26+6562938.84%2C+-39219.45+6562939.01%2C+-39219.3+6562939.04%2C+-39218.47+6562939.23%2C+-39218.34+6562939.26%2C+-39217.47+6562939.44%2C+-39217.39+6562939.46%2C+-39216.81+6562939.58%2C+-39216.47+6562939.65%2C+-39216.42+6562939.66%2C+-39215.48+6562939.88%2C+-39214.89+6562940%2C+-39214.51+6562940.08%2C+-39214.48+6562940.09%2C+-39213.99+6562940.2%2C+-39213.52+6562940.39%2C+-39212.59+6562940.77%2C+-39211.67+6562941.15%2C+-39210.73+6562941.53%2C+-39209.8+6562941.91%2C+-39208.88+6562942.29%2C+-39207.95+6562942.67%2C+-39206.08+6562943.44%2C+-39205.5+6562942.05%2C+-39207.38+6562941.28%2C+-39208.3+6562940.9%2C+-39209.23+6562940.52%2C+-39210.17+6562940.14%2C+-39211.09+6562939.76%2C+-39212.02+6562939.38%2C+-39212.95+6562938.99%2C+-39213.41+6562938.8%2C+-39213.88+6562938.61%2C+-39213.9+6562938.61%2C+-39214.27+6562938.46%2C+-39214.8+6562938.23%2C+-39215.69+6562937.87%2C+-39215.73+6562937.86%2C+-39216.04+6562937.72%2C+-39216.59+6562937.51%2C+-39216.66+6562937.48%2C+-39217.48+6562937.14%2C+-39217.59+6562937.1%2C+-39218.37+6562936.77%2C+-39218.51+6562936.72%2C+-39219.26+6562936.41%2C+-39219.44+6562936.34%2C+-39219.89+6562936.15%2C+-39220.15+6562936.04%2C+-39220.37+6562935.95%2C+-39220.68+6562935.82%2C+-39220.81+6562935.78%2C+-39221.05+6562935.68%2C+-39221.29+6562935.58%2C+-39221.3+6562935.56%2C+-39221.33+6562935.55%2C+-39222.23+6562935.18%2C+-39223.15+6562934.8%2C+-39223.33+6562934.72%2C+-39223.78+6562934.54%2C+-39224.08+6562934.42%2C+-39224.67+6562934.17%2C+-39224.85+6562934.11%2C+-39225.01+6562934.04%2C+-39225.36+6562933.89%2C+-39225.47+6562933.85%2C+-39225.57+6562933.81%2C+-39225.94+6562933.66%2C+-39226.19+6562933.55%2C+-39226.24+6562933.54%2C+-39226.47+6562933.44%2C+-39226.86+6562933.28%2C+-39227.37+6562933.06%2C+-39227.66+6562932.95%2C+-39227.79+6562932.9%2C+-39227.89+6562932.85%2C+-39228.03+6562932.79%2C+-39228.27+6562932.7%2C+-39228.36+6562932.66%2C+-39228.68+6562932.53%2C+-39228.72+6562932.51%2C+-39228.8+6562932.48%2C+-39229.05+6562932.38%2C+-39229.17+6562932.33%2C+-39229.65+6562932.13%2C+-39230.11+6562931.94%2C+-39230.57+6562931.75%2C+-39230.97+6562931.6%2C+-39231.7+6562931.29%2C+-39232.43+6562930.99%2C+-39232.72+6562930.88%2C+-39233.67+6562930.48%2C+-39234.05+6562930.32%2C+-39234.28+6562930.23%2C+-39235.68+6562929.65%2C+-39236.15+6562929.46%2C+-39236.37+6562929.37%2C+-39238+6562928.7%2C+-39239.07+6562928.27%2C+-39239.85+6562927.94%2C+-39240.87+6562927.52%2C+-39241.18+6562927.4%2C+-39241.71+6562927.19%2C+-39241.83+6562927.14%2C+-39243.56+6562926.42%2C+-39244.52+6562926.03%2C+-39245.15+6562925.76%2C+-39245.42+6562925.66%2C+-39245.6+6562925.58%2C+-39247.23+6562924.91%2C+-39247.27+6562924.9%2C+-39249.14+6562924.14%2C+-39249.93+6562923.81%2C+-39250.01+6562923.78%2C+-39250.99+6562923.37%2C+-39252.64+6562922.69%2C+-39252.69+6562922.68%2C+-39252.85+6562922.61%2C+-39252.94+6562922.57%2C+-39254.45+6562921.96%2C+-39254.7+6562921.85%2C+-39255.35+6562921.59%2C+-39256.56+6562921.09%2C+-39257.15+6562920.84%2C+-39258.06+6562920.47%2C+-39258.41+6562920.32%2C+-39258.96+6562920.1%2C+-39260.27+6562919.56%2C+-39260.77+6562919.36%2C+-39262.13+6562918.8%2C+-39263.48+6562918.25%2C+-39263.98+6562918.04%2C+-39265.84+6562917.28%2C+-39266.18+6562917.14%2C+-39267.69+6562916.52%2C+-39267.99+6562916.39%2C+-39268.9+6562916.02%2C+-39269.55+6562915.76%2C+-39270.7+6562915.28%2C+-39271.4+6562915%2C+-39271.61+6562914.91%2C+-39272.12+6562914.7%2C+-39272.33+6562914.61%2C+-39272.51+6562914.53%2C+-39272.76+6562914.44%2C+-39273.27+6562914.23%2C+-39273.41+6562914.17%2C+-39273.46+6562914.15%2C+-39273.88+6562913.97%2C+-39274.14+6562913.87%2C+-39274.19+6562913.85%2C+-39274.31+6562913.8%2C+-39274.91+6562913.55%2C+-39275.12+6562913.47%2C+-39275.22+6562913.43%2C+-39275.76+6562913.21%2C+-39276.12+6562913.06%2C+-39276.36+6562912.96%2C+-39276.5+6562912.91%2C+-39277.03+6562912.69%2C+-39277.06+6562912.67%2C+-39277.12+6562912.64%2C+-39277.16+6562912.64%2C+-39277.25+6562912.59%2C+-39277.34+6562912.55%2C+-39277.44+6562912.52%2C+-39277.5+6562912.5%2C+-39277.53+6562912.48%2C+-39277.63+6562912.44%2C+-39277.72+6562912.41%2C+-39277.8+6562912.36%2C+-39277.9+6562912.33%2C+-39277.97+6562912.3%2C+-39277.99+6562912.29%2C+-39278.09+6562912.25%2C+-39278.18+6562912.22%2C+-39278.28+6562912.17%2C+-39278.37+6562912.14%2C+-39278.45+6562912.1%2C+-39278.55+6562912.06%2C+-39278.64+6562912.03%2C+-39278.74+6562911.98%2C+-39278.83+6562911.95%2C+-39278.92+6562911.91%2C+-39279.02+6562911.87%2C+-39279.11+6562911.84%2C+-39279.2+6562911.79%2C+-39279.29+6562911.75%2C+-39279.38+6562911.72%2C+-39279.48+6562911.68%2C+-39279.57+6562911.65%2C+-39279.67+6562911.6%2C+-39279.75+6562911.57%2C+-39279.85+6562911.53%2C+-39279.94+6562911.49%2C+-39280.03+6562911.46%2C+-39280.13+6562911.41%2C+-39280.22+6562911.37%2C+-39280.31+6562911.34%2C+-39280.41+6562911.3%2C+-39280.5+6562911.27%2C+-39280.6+6562911.22%2C+-39280.68+6562911.18%2C+-39280.77+6562911.15%2C+-39280.87+6562911.11%2C+-39280.96+6562911.07%2C+-39281.06+6562911.03%2C+-39281.15+6562910.99%2C+-39281.24+6562910.96%2C+-39281.34+6562910.92%2C+-39281.42+6562910.88%2C+-39281.52+6562910.84%2C+-39281.61+6562910.8%2C+-39281.71+6562910.77%2C+-39281.8+6562910.73%2C+-39281.89+6562910.69%2C+-39281.99+6562910.66%2C+-39282.08+6562910.61%2C+-39282.17+6562910.57%2C+-39282.26+6562910.54%2C+-39282.35+6562910.5%2C+-39282.45+6562910.46%2C+-39282.54+6562910.42%2C+-39282.64+6562910.38%2C+-39282.73+6562910.35%2C+-39282.82+6562910.31%2C+-39282.91+6562910.27%2C+-39283+6562910.23%2C+-39283.1+6562910.19%2C+-39283.19+6562910.16%2C+-39283.29+6562910.12%2C+-39283.38+6562910.09%2C+-39283.47+6562910.04%2C+-39283.56+6562910%2C+-39283.65+6562909.97%2C+-39283.75+6562909.93%2C+-39283.84+6562909.89%2C+-39283.91+6562909.86%2C+-39283.93+6562909.85%2C+-39284.03+6562909.81%2C+-39284.12+6562909.78%2C+-39284.22+6562909.74%2C+-39284.3+6562909.7%2C+-39284.39+6562909.66%2C+-39284.49+6562909.62%2C+-39284.58+6562909.59%2C+-39284.68+6562909.55%2C+-39284.77+6562909.51%2C+-39284.86+6562909.47%2C+-39284.96+6562909.43%2C+-39285.04+6562909.39%2C+-39285.14+6562909.36%2C+-39285.23+6562909.32%2C+-39285.32+6562909.28%2C+-39285.42+6562909.24%2C+-39285.45+6562909.22%2C+-39285.51+6562909.2%2C+-39285.59+6562909.18%2C+-39285.61+6562909.17%2C+-39285.65+6562909.14%2C+-39285.7+6562909.13%2C+-39285.77+6562909.1%2C+-39285.88+6562909.05%2C+-39285.9+6562909.04%2C+-39285.97+6562909.01%2C+-39286.03+6562908.99%2C+-39286.07+6562908.98%2C+-39286.15+6562908.94%2C+-39286.25+6562908.9%2C+-39286.29+6562908.89%2C+-39286.42+6562908.83%2C+-39286.56+6562908.77%2C+-39286.71+6562908.71%2C+-39286.83+6562908.66%2C+-39286.98+6562908.61%2C+-39287.12+6562908.54%2C+-39287.28+6562908.48%2C+-39287.43+6562908.42%2C+-39287.58+6562908.35%2C+-39287.74+6562908.29%2C+-39287.85+6562908.24%2C+-39287.9+6562908.23%2C+-39288.05+6562908.16%2C+-39288.11+6562908.14%2C+-39288.22+6562908.1%2C+-39288.54+6562907.96%2C+-39288.68+6562907.9%2C+-39288.78+6562907.86%2C+-39288.83+6562907.85%2C+-39288.97+6562907.78%2C+-39289.13+6562907.71%2C+-39289.29+6562907.66%2C+-39289.45+6562907.59%2C+-39289.6+6562907.52%2C+-39289.69+6562907.49%2C+-39289.76+6562907.46%2C+-39289.92+6562907.39%2C+-39289.97+6562907.38%2C+-39290.02+6562907.35%2C+-39290.13+6562907.31%2C+-39290.18+6562907.28%2C+-39290.27+6562907.25%2C+-39290.41+6562907.19%2C+-39290.56+6562907.13%2C+-39290.59+6562907.12%2C+-39290.71+6562907.07%2C+-39290.86+6562907.01%2C+-39290.89+6562907%2C+-39291+6562906.95%2C+-39291.16+6562906.89%2C+-39291.32+6562906.82%2C+-39291.46+6562906.76%2C+-39291.49+6562906.75%2C+-39291.62+6562906.7%2C+-39291.82+6562906.62%2C+-39291.9+6562906.58%2C+-39292.39+6562906.38%2C+-39293.29+6562906.01%2C+-39293.5+6562905.92%2C+-39293.68+6562905.85%2C+-39294.03+6562905.71%2C+-39294.19+6562905.64%2C+-39295.09+6562905.27%2C+-39295.53+6562905.09%2C+-39296+6562904.9%2C+-39296.9+6562904.53%2C+-39297.39+6562904.33%2C+-39297.8+6562904.16%2C+-39298.71+6562903.78%2C+-39299.25+6562903.57%2C+-39299.61+6562903.42%2C+-39300.51+6562903.05%2C+-39301.1+6562902.8%2C+-39301.42+6562902.68%2C+-39302.32+6562902.31%2C+-39302.96+6562902.04%2C+-39303.23+6562901.94%2C+-39304.13+6562901.56%2C+-39304.32+6562901.49%2C+-39304.81+6562901.28%2C+-39305.03+6562901.19%2C+-39305.23+6562901.11%2C+-39305.94+6562900.82%2C+-39306.02+6562900.79%2C+-39306.15+6562900.74%2C+-39306.67+6562900.52%2C+-39306.84+6562900.45%2C+-39307.07+6562900.36%2C+-39307.49+6562900.18%2C+-39307.75+6562900.08%2C+-39307.98+6562899.98%2C+-39308.52+6562899.75%2C+-39308.65+6562899.7%2C+-39308.9+6562899.61%2C+-39309.21+6562899.47%2C+-39309.33+6562899.43%2C+-39309.56+6562899.33%2C+-39310.38+6562899%2C+-39310.47+6562898.96%2C+-39310.73+6562898.85%2C+-39311.37+6562898.59%2C+-39311.83+6562898.41%2C+-39312.24+6562898.24%2C+-39312.28+6562898.22%2C+-39312.5+6562898.13%2C+-39313.19+6562897.85%2C+-39313.39+6562897.77%2C+-39314.09+6562897.48%2C+-39315+6562897.1%2C+-39315.17+6562897.03%2C+-39315.91+6562896.73%2C+-39315.95+6562896.71%2C+-39316.07+6562896.66%2C+-39316.82+6562896.35%2C+-39317.27+6562896.17%2C+-39317.37+6562896.13%2C+-39317.54+6562896.05%2C+-39317.63+6562896.02%2C+-39317.72+6562895.99%2C+-39317.78+6562895.96%2C+-39317.8+6562895.95%2C+-39319.54+6562895.24%2C+-39319.66+6562895.19%2C+-39321.51+6562894.43%2C+-39322.27+6562894.12%2C+-39322.59+6562893.98%2C+-39323.18+6562893.74%2C+-39323.37+6562893.66%2C+-39325+6562893%2C+-39325.2+6562892.91%2C+-39325.23+6562892.9%2C+-39326.82+6562892.25%2C+-39327.09+6562892.14%2C+-39328.85+6562891.42%2C+-39328.94+6562891.38%2C+-39330.46+6562890.75%2C+-39330.8+6562890.61%2C+-39331.36+6562890.38%2C+-39332.65+6562889.85%2C+-39334.1+6562889.26%2C+-39334.51+6562889.1%2C+-39335.75+6562888.58%2C+-39335.92+6562888.52%2C+-39336.36+6562888.34%2C+-39337.74+6562887.77%2C+-39338.22+6562887.57%2C+-39339.32+6562887.11%2C+-39339.84+6562886.91%2C+-39340.08+6562886.81%2C+-39340.48+6562886.64%2C+-39341.39+6562886.27%2C+-39341.84+6562886.08%2C+-39341.93+6562886.05%2C+-39343.79+6562885.29%2C+-39344.12+6562885.15%2C+-39345.05+6562884.77%2C+-39345.64+6562884.52%2C+-39346.86+6562884.03%2C+-39347.27+6562883.86%2C+-39347.5+6562883.76%2C+-39349.35+6562883%2C+-39349.6+6562882.9%2C+-39350.6+6562882.49%2C+-39351.22+6562882.24%2C+-39353.07+6562881.47%2C+-39354.16+6562881.03%2C+-39354.62+6562880.84%2C+-39354.93+6562880.71%2C+-39355.5+6562880.47%2C+-39356.78+6562879.95%2C+-39357.04+6562879.85%2C+-39358.63+6562879.19%2C+-39360.49+6562878.43%2C+-39362.2+6562877.73%2C+-39362.27+6562877.7%2C+-39362.34+6562877.67%2C+-39362.81+6562877.48%2C+-39363.28+6562877.29%2C+-39363.74+6562877.1%2C+-39364.21+6562876.91%2C+-39364.33+6562876.86%2C+-39365.13+6562876.53%2C+-39365.6+6562876.34%2C+-39366.06+6562876.15%2C+-39366.85+6562875.82%2C+-39367.92+6562875.38%2C+-39368.47+6562875.16%2C+-39369.77+6562874.62%2C+-39378.13+6562871.19%2C+-39379.04+6562870.81%2C+-39386.48+6562867.78%2C+-39386.92+6562867.59%2C+-39387.39+6562867.4%2C+-39388.28+6562867.01%2C+-39389.17+6562866.6%2C+-39390.04+6562866.17%2C+-39390.92+6562865.74%2C+-39391.77+6562865.28%2C+-39392.62+6562864.81%2C+-39393.32+6562864.4%2C+-39393.45+6562864.33%2C+-39393.81+6562864.09%2C+-39394.17+6562863.83%2C+-39394.28+6562863.76%2C+-39394.57+6562863.52%2C+-39394.86+6562863.29%2C+-39394.99+6562863.17%2C+-39395.25+6562862.93%2C+-39395.49+6562862.68%2C+-39395.79+6562862.36%2C+-39396.09+6562862.03%2C+-39396.36+6562861.68%2C+-39396.61+6562861.33%2C+-39396.86+6562860.96%2C+-39397.08+6562860.59%2C+-39397.29+6562860.2%2C+-39397.48+6562859.81%2C+-39397.66+6562859.41%2C+-39397.82+6562859%2C+-39397.97+6562858.58%2C+-39398.1+6562858.16%2C+-39398.19+6562857.8%2C+-39398.26+6562857.44%2C+-39398.29+6562857.31%2C+-39398.36+6562856.87%2C+-39398.42+6562856.44%2C+-39398.45+6562856.01%2C+-39398.47+6562855.56%2C+-39398.47+6562855.12%2C+-39398.46+6562854.69%2C+-39398.42+6562854.25%2C+-39398.37+6562853.81%2C+-39398.28+6562853.32%2C+-39398+6562851.93%2C+-39397.86+6562851.24%2C+-39397.72+6562850.61%2C+-39397.58+6562849.99%2C+-39397.37+6562849.02%2C+-39397.15+6562848.05%2C+-39396.92+6562847.08%2C+-39396.68+6562846.12%2C+-39396.62+6562845.85%2C+-39396.19+6562844.19%2C+-39395.68+6562842.27%2C+-39395.14+6562840.37%2C+-39394.86+6562839.41%2C+-39394.61+6562838.58%29&maks_avstand=300&detaljerte_lenker=false&pretty=false&kortform=false&vegsystemreferanse=E%2CK%2CF%2CR
{noformat}

Dette blir for mange tegn i URL'en og Tomcat kneler med følgende respons:

{noformat}
6 < 400
6 < Set-Cookie: 220dc34f3d07f10f55591555f8bb93c2=1acac74f84a313d516ef56b635313768; path=/; HttpOnly; Secure
6 < Content-Length: 1866
6 < Date: Sat, 16 May 2020 15:48:32 GMT
6 < Content-Language: en
6 < Content-Type: text/html;charset=utf-8
<!doctype html><html lang=""en""><head><title>HTTP Status 400 – Bad Request</title><style type=""text/css"">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 400 – Bad Request</h1><hr class=""line"" /><p><b>Type</b> Exception Report</p><p><b>Message</b> Request header is too large</p><p><b>Description</b> The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid request message framing, or deceptive request routing).</p><p><b>Exception</b></p><pre>java.lang.IllegalArgumentException: Request header is too large
	org.apache.coyote.http11.Http11InputBuffer.fill(Http11InputBuffer.java:726)
	org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:464)
	org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:502)
	org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:810)
	org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1506)
	org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	java.lang.Thread.run(Thread.java:748)
</pre><p><b>Note</b> The full stack trace of the root cause is available in the server logs.</p><hr class=""line"" /><h3>Apache Tomcat/8.5.49</h3></body></html>
{noformat}

Til tross for at API Skriv kjører Douglas-Peucker og stripper bort unødvendige desimaler i koordinatene ble det altså for langt.

Ruteberegneren i API Les bør skrives om til å ta i mot geometriene som request-payload via POST.",NVDB-6937,Les-API,
Forbedre tekst / endre flyt på glemt passord,"h2. Observasjon
Et tilbakevendende problem på datafangst-support er brukere i SVV og fylkeskommune som sier at de har brukt ""glemt passord"" og ikke fått noen mail.

De får ikke noen mail fordi de ikke er registrert som e-postbruker i Datafangst (noe vi uansett ikke vil), og de får heller ikke beskjed om at mail ikke er sendt. Hvis de hadde fått beskjed hadde sida kunne brukes til å gjette registrerte brukere i Datafangst, noe som er dårlig sikkerhetspraksis.

h2. Analyse
Problemet oppstår fordi denne løsningen ikke er ment for dem, og det er lite der som kan hjelpe dem å skjønne at de ikke kan bruke denne funksjonen når de ikke kommer inn i datafangst.

h2. Forslag til løsning
Det bør være en tekst der som tydelig formidler hvem som kan bruke ""glemt passord"", og hva som er alternativene for andre brukere.
Siden vi vet at folk ikke leser tekst og heller går rett på input, kan vi vurdere om folk først må velge sin kategori før de får fram tekst eller skjema som er relevante for dem.",NVDB-6937,Datafangst,
Sjekk for overlapp internt i kontrakt og vis feilmelding,"h2. Observasjon
Et problem som dukker opp relativt ofte er at bruker får feil ved overlapp internt i kontrakten ved innsending til NVDB. En del vegobjekttyper tillater ikke overlapp med andre av samme type, som gjør at Skriv API avvise disse når det er overlapp i stedfesting.

Ett konkret eksempel er to vegobjekter av type veidekke med lik geometri, men forskjellige attributter for lagtype. Et annet eksempel kan være en unøyaktig måling som gjør at det er litt overlapp mellom objekter.

h2. Analyse
Ved import av vegobjekter burde vi kunne gå over alle typer som ikke kan ha overlapp, og sjekke om det er overlappende geometri. Bittelitt overlapp på geometri må kunne tolereres, siden vi kan lirke til dette med stedfesting. Hvis det er vesentlig overlapp bør det vises som en feil på alle vegobjekter involvert i overlapp.",NVDB-6937,Datafangst,
Statistikkpunkter vises for områder utenfor søk,"Gå til:

https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@205513,6656638,5/hva:~(~(id~532))/hvor:~(fylke~(~30)~vegsystemreferanse~(~'FV))

 !Screenshot from 2020-05-15 12-10-57.png|thumbnail! 

Selv om resultatlisten er korrekt, vises statistikkpunkter for fylker utenfor filtrert område.

Dette skjer fordi fetchVegobjekter.fetchVegobjekterStatisticsByFylke() og fetchVegnett.fetchVegnettStatisticsByFylke() ikke tar hensyn til områder i søket når det er for mange objekter å hente, og man skal opprette områdestatistikk i stedet.

Feil introdusert i refaktorering av area-bruk i egenskapsfilter til kun områdefilter (NVDB-5379).",NVDB-6937,Vegkart,
Ved feil med stedfesting med Skriv henger spinner,"h2. Observasjon
Ved stedfesting med Skriv, og når vi får feil i NVDB-5535, så fortsetter spinner å gå etter at stedfesting er avbrutt.

h2. Analyse
Vi fanger feilen og sender den videre på riktig måte, men mottaker til kjøring har ikke håndtert at exception er wrappet.",NVDB-6937,Datafangst,
Ruteberegning: Punkter i rute for polygon,"h2. Observasjon

Request til ruteberegner:

{noformat}
GET https://nvdbapiles-v3.test.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING+%28270203.15+7041918.45%2C+270203.12+7041921.1%2C+270202.94+7041928.89%2C+270202.66+7041928.89%2C+270202.44+7041933.08%2C+270202.25+7041935.64%2C+270200.05+7041935.65%2C+270200.05+7041935.8%2C+270199.01+7041935.78%2C+270198.99+7041934.8%2C+270199.16+7041934.81%2C+270199.19+7041934.7%2C+270199.11+7041932.03%2C+270198.99+7041930.45%2C+270200.05+7041930.55%2C+270200.14+7041925.46%2C+270200.14+7041924.67%2C+270200.24+7041918.54%2C+270200.28+7041916.14%2C+270200.43+7041908.83%2C+270200.49+7041906.44%2C+270200.64+7041899.43%2C+270200.81+7041891.73%2C+270201.33+7041866.85%2C+270201.38+7041864.6%2C+270201.65+7041854.5%2C+270199.18+7041854.59%2C+270199.27+7041851%2C+270199.31+7041850.23%2C+270199.41+7041849.44%2C+270199.55+7041848.68%2C+270199.98+7041847.36%2C+270200.4+7041846.4%2C+270200.64+7041845.98%2C+270201.12+7041845.19%2C+270201.97+7041844.02%2C+270202.49+7041843.43%2C+270203.15+7041842.75%2C+270204.44+7041841.7%2C+270205.79+7041840.88%2C+270206.53+7041840.52%2C+270208.16+7041839.97%2C+270209.05+7041839.76%2C+270213.19+7041839.19%2C+270213.46+7041839.15%2C+270218.3+7041843.78%2C+270215.37+7041844.24%2C+270215.4+7041844.64%2C+270214.77+7041844.75%2C+270215.12+7041848.74%2C+270214.22+7041851.31%2C+270213.63+7041851.39%2C+270205.68+7041852.3%2C+270205.4+7041852.44%2C+270205.14+7041852.67%2C+270204.91+7041852.92%2C+270204.69+7041853.33%2C+270204.64+7041853.47%2C+270204.22+7041854.08%2C+270204.21+7041855.44%2C+270204.16+7041857.09%2C+270203.69+7041857.07%2C+270203.68+7041858.67%2C+270204.31+7041858.68%2C+270204.32+7041858.79%2C+270204.38+7041858.78%2C+270204.38+7041859.94%2C+270204.44+7041859.93%2C+270204.44+7041859.95%2C+270204.43+7041860.7%2C+270204.37+7041860.7%2C+270204.25+7041866.91%2C+270204.16+7041870.76%2C+270203.94+7041881.99%2C+270203.56+7041881.99%2C+270203.51+7041883.67%2C+270203.9+7041883.67%2C+270203.72+7041891.79%2C+270203.45+7041903.53%2C+270203.41+7041905.85%2C+270203.17+7041917.19%2C+270203.15+7041918.45%29&maks_avstand=300&detaljerte_lenker=false&pretty=false&kortform=false&vegsystemreferanse=FV6690&typeveg=enkelBilveg
1 > Accept: application/json
1 > X-Client: NVDB API Skriv
{noformat}

Respons:

{noformat}
2 < 200
2 < Access-Control-Allow-Origin: *
2 < Access-Control-Allow-Methods: GET, POST, OPTIONS
2 < X-REQUEST-ID: 9c43bfc9-7e4e-9805-dc1d-b02327f86c89
2 < Date: Thu, 14 May 2020 17:24:15 GMT
2 < Access-Control-Allow-Headers: accept, x-client, x-client-session, origin
2 < X-Robots-Tag: none
2 < Cache-Control: no-cache
2 < X-Datakatalog-Versjon: 2.20
2 < Set-Cookie: 220dc34f3d07f10f55591555f8bb93c2=1acac74f84a313d516ef56b635313768; path=/; HttpOnly; Secure
2 < Content-Length: 4647
2 < Access-Control-Max-Age: 1728000
2 < Content-Type: application/json;charset=utf-8
[{""href"":""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/72812"",""metadata"":{""startdato"":""2020-03-04""},""veglenkesekvensid"":72812,""startposisjon"":0.78970927,""sluttposisjon"":0.78970927,""kortform"":""0.78970927@72812"",""veglenkenummer"":27,""startnode"":""1869851"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2"",""3K"",""4""],""geometri"":{""wkt"":""POINT Z(270191.86 7041929.32 9.233)"",""srid"":5973},""lengde"":0.0,""fylke"":50,""kommune"":5001,""vegsystemreferanse"":{""vegsystem"":{""id"":1002159798,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":6690},""strekning"":{""id"":1003469232,""versjon"":1,""strekning"":2,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""meter"":1016.314,""retning"":""MOT""},""kortform"":""FV6690 S2D1 m1016""},""kontraktsområder"":[{""id"":376447712,""navn"":""1610 Trondheim Indre 2015-2020""},{""id"":920262210,""navn"":""5006 Trondheim 2020-2028""},{""id"":218658146,""navn"":""1609 TrondheimBydrift 2011-2015""}],""riksvegruter"":[{""id"":137054102,""nummer"":""6A"",""navn"":""RUTE6A"",""periode"":""2010-2019""}]},{""href"":""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/72812"",""metadata"":{""startdato"":""2020-03-04""},""veglenkesekvensid"":72812,""startposisjon"":0.78970927,""sluttposisjon"":0.79084754,""kortform"":""0.78970927-0.79084754@72812"",""veglenkenummer"":27,""startnode"":""1869851"",""sluttnode"":""2860952"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2"",""3K"",""4""],""geometri"":{""wkt"":""LINESTRING Z(270191.86 7041929.32 9.233, 270192.65 7041934.83 9.183)"",""srid"":5973},""lengde"":5.567000000000007,""fylke"":50,""kommune"":5001,""vegsystemreferanse"":{""vegsystem"":{""id"":1002159798,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":6690},""strekning"":{""id"":1003469232,""versjon"":1,""strekning"":2,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":1016.314,""til_meter"":1021.881,""retning"":""MOT""},""kortform"":""FV6690 S2D1 m1016-1022""},""kontraktsområder"":[{""id"":376447712,""navn"":""1610 Trondheim Indre 2015-2020""},{""id"":920262210,""navn"":""5006 Trondheim 2020-2028""},{""id"":218658146,""navn"":""1609 TrondheimBydrift 2011-2015""}],""riksvegruter"":[{""id"":137054102,""nummer"":""6A"",""navn"":""RUTE6A"",""periode"":""2010-2019""}]},{""href"":""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/2510770"",""metadata"":{""startdato"":""2020-03-04""},""veglenkesekvensid"":2510770,""startposisjon"":0.6140563,""sluttposisjon"":1.0,""kortform"":""0.6140563-1.0@2510770"",""veglenkenummer"":2,""startnode"":""1869850"",""sluttnode"":""2510767"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2"",""3K"",""4K""],""geometri"":{""wkt"":""LINESTRING Z(270193.69 7041838.28 10.034, 270193.4 7041839.38 10.034, 270192.565 7041842.816 10.034, 270192.045 7041846.112 10.034)"",""srid"":5973},""lengde"":8.009999999999998,""fylke"":50,""kommune"":5001,""vegsystemreferanse"":{""vegsystem"":{""id"":1002159797,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":6690},""strekning"":{""id"":1003469234,""versjon"":1,""strekning"":3,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""fra_meter"":0.0,""til_meter"":8.01,""retning"":""MOT""},""kortform"":""FV6690 S3D1 m0-8""},""kontraktsområder"":[{""id"":376447712,""navn"":""1610 Trondheim Indre 2015-2020""},{""id"":920262210,""navn"":""5006 Trondheim 2020-2028""},{""id"":218658146,""navn"":""1609 TrondheimBydrift 2011-2015""}],""riksvegruter"":[]},{""href"":""https://nvdbapiles-v3.test.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert/72812"",""metadata"":{""startdato"":""2020-03-04""},""veglenkesekvensid"":72812,""startposisjon"":0.78970927,""sluttposisjon"":0.78970927,""kortform"":""0.78970927@72812"",""veglenkenummer"":27,""startnode"":""1869851"",""type"":""HOVED"",""detaljnivå"":""Vegtrase og kjørebane"",""typeVeg"":""Enkel bilveg"",""typeVeg_sosi"":""enkelBilveg"",""feltoversikt"":[""1"",""2"",""3K"",""4""],""geometri"":{""wkt"":""POINT Z(270191.86 7041929.32 9.233)"",""srid"":5973},""lengde"":0.0,""fylke"":50,""kommune"":5001,""vegsystemreferanse"":{""vegsystem"":{""id"":1002159798,""versjon"":1,""vegkategori"":""F"",""fase"":""V"",""nummer"":6690},""strekning"":{""id"":1003469232,""versjon"":1,""strekning"":2,""delstrekning"":1,""arm"":false,""adskilte_løp"":""Nei"",""trafikantgruppe"":""K"",""meter"":1016.314,""retning"":""MOT""},""kortform"":""FV6690 S2D1 m1016""},""kontraktsområder"":[{""id"":376447712,""navn"":""1610 Trondheim Indre 2015-2020""},{""id"":920262210,""navn"":""5006 Trondheim 2020-2028""},{""id"":218658146,""navn"":""1609 TrondheimBydrift 2011-2015""}],""riksvegruter"":[{""id"":137054102,""nummer"":""6A"",""navn"":""RUTE6A"",""periode"":""2010-2019""}]}]
{noformat}

Inngående geometri er et polygon. Returnert rute starter med et punkt, fortsetter med to linjer og avsluttes med et punkt som er identisk med det første. Det gir ingen mening å levere med disse punktene. En rute må bestå av utstrekning.",,Les-API,
Ulovlig versjonering i følgeoppdatering ved lukking av vegnett,"Ad akseptansetesting av NVDB-5375.

h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/3a65998f-463f-4c48-9658-0bd295bb0316 avvises på grunn av ulovlig versjonering i en følgeoppdatering.

h2. Analyse

Endringssettet er litt annerledes her enn det i NVDB-5375. I sistnevnte lukkes alle vegobjektene som blir delvis berørt av vegnettslukking på lukkedato for vegnettet. I denne saken sitt endringssett er det to berørte vegobjekter som ikke lukkes:

VEGOBJEKTTYPE=GSV langs annen vegkategori (949); ID=1006516746; VERSJON=2; STARTDATO=2020-05-08; SLUTTDATO=null
VEGOBJEKTTYPE=GSV langs annen vegkategori (949); ID=1006516614; VERSJON=2; STARTDATO=2020-05-08; SLUTTDATO=null

Dersom disse to også hadde blitt lukket i endringssettet ville det gått gjennom uten feil.

Dette er et litt annerledes case, men likefullt noe som bør håndteres bedre av API Skriv. De to vegobjektene er delvis berørt av vegnettslukking og forsøkes derfor versjonert med redusert stedfesting i v2. Men - de kan ikke versjoneres. Hvordan skal dette håndteres?

1) Vegobjektene lukkes på lukkedato for vegnettet?
2) Som over + nyregistrering av kopi av disse vegobjektene med redusert stedfesting?

I samråd med Arne Sonflå og Hans Jørgen Ekker går vi for alternativ 2.

h2. Løsning

Oppdaterte AdaptFeaturesToClosedNetworkEnricherFilter.createEnrichmentsForFeature() med forgreining som trigger splitting av ikke-versjonerbar vegobjekttype. Splitting fører til to berikinger i jobben; DISCONTINUE på originalen og CREATE med lokasjonsredusert kopi av originalen. Operasjon CREATE som beriking i jobben er nytt og krevde noen tilpasninger i JobResultWriter, JobEnricher and JobWorker. ",NVDB-6937,Skriv-API,
Nytt gatenavn på eksisterende gatekode i samme kommune avvises ikke,"Ad akseptansetesting av NVDB-5464.

h2. Observasjon

Bruker ragntunh fikk utført følgende endringssett i ATM: https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/e9900805-05c5-4292-a1d1-a111d5a3ba98

Beskrivelse fra bruker:

Jeg testet dette nå og jeg fikk sjekket inn 3 gateobjekt med feil gatenavn i forhold til gatekoden i Indre Østfold. Legger ved informasjon om endringssettet mitt, slik at dere kan se på det. Jeg la på nye gateobjekt og brukte gatekoder som er brukt andre steder i kommunen, men la inn et annet gatenavn enn det navnet gaten har på de andre stedene i kommunen. Det gjelder gatekode 1002 som fikk navnet ""Arnolds veg"", men som heter ""Arnoldts vei"" andre steder i kommunen. Gatekode 10053 som fikk navnet ""Båsstadveien"", som heter ""Båstadveien"" andre steder i kommunen. Og gatekode 22500 som fikk navnet ""Fredheimvegen"", som skal ha navnet ""Fredheimsveien"".

h2. Analyse

I endringssettet registreres tre nye Gate-objekter i kommune ""Indre Østfold"" som har kommunenr 3014:

*1) Gate tempId ""-1"" med gatekode ""1002"" og gatenavn ""Arnolds veg""*

I NVDB-ATM finner jeg ingen andre Gate-objekter i denne kommunen med gatekode ""1002"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4588)=1002%20AND%20relasjon(946,egenskap(11769)=3014)%22
Jeg finner heller ingen andre Gate-objekter i denne kommunen med gatenavn ""Arnolds veg"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4589)=%27Arnolds%20veg%27%20AND%20relasjon(946,egenskap(11769)=3014)%22

*2) Gate tempId ""-2"" med gatekode ""10053"" og gatenavn ""Båsstadveien""*

I NVDB-ATM finner jeg ingen andre Gate-objekter i denne kommunen med gatekode ""10053"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4588)=10053%20AND%20relasjon(946,egenskap(11769)=3014)%22
Jeg finner heller ingen andre Gate-objekter i denne kommunen med gatenavn ""Båsstadveien"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4589)=%27Båsstadveien%27%20AND%20relasjon(946,egenskap(11769)=3014)%22

*3) Gate tempId ""-3"" med gatekode 22500 og gatenavn ""Fredheimvegen""*

I NVDB-ATM finner jeg ingen andre Gate-objekter i denne kommunen med gatekode ""22500"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4588)=22500%20AND%20relasjon(946,egenskap(11769)=3014)%22
Jeg finner heller ingen andre Gate-objekter i denne kommunen med gatenavn ""Fredheimvegen"": https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/538?egenskap=%22egenskap(4589)=%27Fredheimvegen%27%20AND%20relasjon(946,egenskap(11769)=3014)%22

Basert på funnene over er det altså korrekt oppførsel av API Skriv og utføre endringssettet uten innsigelser.",NVDB-6937,Skriv-API,
Tillate endring av FeatureCollection med ERROR eller REJECT,"h2. Observasjon
Dersom det oppstår en feil (usikkert hva) så låses en featurecollection. Tilstand settes i ERROR og nye forsøk på å sende inn blir avviste med melding om at feil i collection må rettes før noe annet kan bli registrert.

Vi bør finne ut hvorfor en featurecollection er designet til å hindre nye innsendinger hvis en tidligere innsending har en feil. Vi bør se på om dette berører feil som sendes inn mot

POST /featurecollection

PUT /featurecollection/<id>

POST /featurecollection/<id>/feature

PUT /featurecollection/<id>/feature/<id>

og evt andre som jeg ikke kommer på i farten.

Denne er relatert til NVDB-5541 og kanskje NVDB-5511. 

(Se gjerne også gjennom support-henvendelser fra SINUS og Andre Løset)

h2. Analyse
Har sjekka med Tore (som skrev opprinnelig kode), han kommer ikke på noen spesiell grunn til at det ble lagt inn.

h2. Løsning
Fjerne kode som blokkerer endring for FeatureCollection med ERROR eller REJECT.",NVDB-6937,Datafangst,
Featurecollection havner i ERROR-tilstand,"SINUS opplever til stadig at en featurecollection havner i tilstand ERROR som gjør at de ikke får sendt inn noen flere objekter før feil på collection er rettet.

Vi må se på hvorfor en collection havner i tilstand ERROR. Hva er det som gjør dette?

*Her er foreløpige observasjoner jeg har (gjengitt fra Mattermost)*

Begynte på det nå, og for meg ser det ut til at det skjer noe ved import av objekt [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/83/114825508]

Men det ser også ut til at bruker har noen endringer siden DF etterpå sender valideringsmld til Skriv med <delvisOppdater>.

Jeg er på datafangst-server og kjører grep etter e1afa5a3-b85b-4cbd-8711-1de0a80c484d på fil zless datafangst.kantega.no_trace.2020-05-13_12.log.gz. Utdrag fra denne er vedlagt.

Rett etter dette ser det ut som om det er en ERROR-tilstand som kommer, og neste innsending går ikke gjennom.

Ting starter ved tid 2020-05-13T12:27:44.692

Min første tanke var å sette opp en kontrakt og sende inn import av dette objektet med de endringene som ligger i valideringsmld mot Skriv

Forsøkte så å mappe inn de endringene det ser ut til at han har gjort, og ""uheldigvis"" går alt fint inn: ACCEPTED. Brukte vedlagte geojson for dette.

 

Denne er relatert til NVDB-5542 og kanskje NVDB-X.

(Se gjerne også gjennom support-henvendelser fra SINUS og Andre Løset)

h2. Analyse
Feil fra Skriv (f.eks. timeout) gjør at vi havner i exception handler, og denne setter alltid status for fila til ERROR.

h2. Løsning
Ikke sett fil-status når vi legger til en fil. Å legge til håndteres også annerledes ellers i koden (sjekk enum ProcessingMode).",NVDB-6937,Datafangst,
Manuell stedfesting bruker aldri Skriv,"h2. Observasjon

Fiks i NVDB-5534 (for alltid Skriv) ha avslørt en annen feil, som gjør at flagg fra sesjonen ikke blir brukt.
h2. Analyse

Gyldig bruker blir ikke satt i state. Det finnes en action for dette, men den blir ikke kalt. I stedet kalles ensureCurrentUser direkte i komponent, disse bør samkjøres.
h2. Løsning

kaller initLocational som setter usersession i state når locational-komponenten mountes",NVDB-6937,Datafangst,
Automatisk bygg og deploy til Atlas,Jenkinsfile og atlas-config,NVDB-6826,Rapportgenerator,
Noen GUI-justeringer,"fikse noen småissues som har oppstått på GUI
 * progress overlay overlayer ikke hele skjermen
 * progress overlay viser numerisk progress i hjørnet
 * automatisk stedfestings-modalen bør lukkes før progress overlay vises
 * automatisert stedfesting sier at objektlisten er oppdatert, men det er misvisende, siden objektliste er spesifikt begrep brukt om noe annet.
 * changelog alert gir feilmeldinger i console før usesession er lastet
 * Fjernet bootstrap-alert, siden det genererte feilmeldinger i console, og siden vi har lyst til å fase ut bootstrap på sikt.",NVDB-6937,Datafangst,
Avrunding av posisjon for Locational gjør stedfesting umulig i grensetilfeller,"*Bug som hindrer bruker og ikke kan omgås.*

*Grunnlag*
 Fikk inn en supportsak om uvanlig feil på trær som ble forsøkt stedfestet. (12.5.2020, feil-id: GckwsMtS og vRmqMLYg). Se vedlagt bilde.

*Analyse*
 Det viser seg i dette tilfellet at posisjonen på trærne havner _utenfor_ range på tilknyttet vegsegment. 

Feilen oppstår fordi vi runder av desimalene i posisjonen for opprettet Locational-objekt, men ikke for range from-to på vegsegmentet. Det gjør at en avrundet posisjon kan havne utenfor range i grensetilfeller.

*Eksempel:*
 I denne saken har vi følgende for Punkt 106 ved stedfesting:

Verdi for posisjon før den avrundes: 0.69418185309819
 Avrundet verdi for posisjon: 0.69418185
 Range for vegsegment:  0.69418185309819 - 0.75878276

Vi ser at før avrunding er verdien på posisjonen innenfor range, men etter avrunding er den ikke innenfor.

*Hvordan gjenskape:*
 Last opp vedlagt SOSI-fil. [^NVDB_Trær_199_Del1.sos]
 Stedfest treet med alias *Punkt 106* manuelt

Bruker du *stedfesting 1*, får du feilmeldingen ""Uvanlig feil"", som skyldes at posisjonen til vegobjektet ikke ble funnet blant vegsegmentene. _(Exception kastes fra metoden getSegmentIndexOfLocationalPosition i LocationalLineExtender.java)_

Feilen oppstår også i _stedfesting 2_ når vi bruker stedfesting fra skriv, men da med ei riktigere feilmelding: _Ingen relevant vegnettstilknytning ble funnet med de angitte parametere_

*Mulig løsning:*

Her må man først se på hvorfor vi runder av antall desimaler på posisjon for Locational.  Vi kan ikke nødvendigvis bare slutte med det, uten at det kan gi andre problemer i motsatt ende. Må eventuelt vurdere om avrunding på posisjonen kan gjøres på et mer egnet sted, der vi trenger det.

Evt vurdere å gjøre tilsvarende avrunding, eller tillate et visst slingringsmonn der vi henter ut segmentet for posisjonen? Se _getSegmentIndexOfLocationalPosition i LocationalLineExtender.java_

 

 ",,Datafangst,
Manglende tilbakemelding når vi ikke finner stedfestinger (manuell stedfesting),"h1. Observasjon

Når vi ikke finner noen stedfesting for et enkelt objekt, vises en tilbakemelding ""udefined"" i GUI.
h2. Implementasjon

la til message i response som sier ""finner ingen stedfesting""",NVDB-6937,Datafangst,
Manuell stedfesting bruker alltid Skriv,"h2. Observasjon

En bug i localize tool gjør at vi alltid bruker skriv ved manuell stedfesting
h2. Løsning

Feilen ligger i en if-setning som skal sjekke om et boolean flagg er satt for om skriv er aktivert. if-setningen sjekker om metoden for å avklare flagget finnes, ikke om flagget er satt.
h2. Fix

hent flagget fra props

 ",NVDB-6937,Datafangst,
Avvik i meter på fylkesveg,"Gjennomgang av rapport etter testing av 9.1.

Sjekk ut de største avvikene. Noen avvik henger mulig sammen med NVDB-5101.

 

[https://ftp.triona.no/NyttVegNett-2020-Test/Logger-2020-05-12/RoadNetwork-Norge-ERF-K-1.log]
 * WARN ;Segment1.MeterGap;3007;180814;0,98393417;1;3010491;213321;0;;E;V;16;;S;47;1;5925;5933;K;;;;2;1#2;;237382;6683178;161;237386;6683172;161;Gap=412,170m
 ** Ser ikke ut til å være noe feil. Litt spesielt ""kryss"" som gjør at det ser ut som meter hopper: [https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:geodata/@237384,6683214,16/hva:~(~(id~916))/vegnett:~'geometri+~()/valgt:1007827752:916]
 * WARN ;Segment1.MeterGap;3411;650735;0;0,10196736;715063;715043;0;;E;V;6;;S;31;50;0;35;K;A;;;2;1#2;;279135;6756287;128;279103;6756300;127;Gap=124,000m
 ** Rekkefølgen på stedfestinger for strekningen gjør at meter ikke blir sammenhengende: [https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:geodata/@279061,6756304,16/hva:~(~(id~916))/vegnett:~'geometri+~()/valgt:1006836709:916|https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@279061,6756304,16/hva:~(~(id~916))/vegnett:~'geometri+~()/valgt:1006836709:916]
 * WARN ;Segment1.MeterGap;3033;443452;0,68360583;0,68766603;475479;475480;0;;E;V;16;;S;56;10;0;10;K;A;Med;1-1;2;1#3;;283363;6678039;204;283363;6678030;204;Gap=4366,045m
 ** [https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:topo4/@283412,6678033,17/hva:~(~(id~916))/vegnett:~'geometri+~()/valgt:1003442491:916|https://vegkart.test.atlas.vegvesen.no/#kartlag:topo4/@283412,6678033,17/hva:~(~(id~916))/vegnett:~'geometri+~()/valgt:1003442491:916] Ser ut som noe feil med sekvensnummer/stedfesting på strekningsobjekt. Det gjør at 0-10M kommer på meter 4376. Sekvensnummer før er 21000 og etter er 22000. Mens strekningen som ligger mellom har sekvensnummer 11000. 

 

*Løsning:*

Det er 2 feil som har blitt avdekket:
 # Fylkesveger som krysser fylkesgrenser starter telling av meter fra 0 igjen
 # Veg bytter vegsystem uten at strekning blir oppdatert, slik at strekning dekker begge vegsystem i tid

 

Nummer 1 ble løst i NVDB-5562.

Nummer 2 ble løst ved å ta med perioden for vegsystemet i sectionCache-tabellen, og la perioden bli endel av nøkkelen for innslagene.

 ",NVDB-6937,NVDB-IND,
Feilmelding ved stedfesting,"h2. Observasjon

Prøvde å stedfeste (MED Skriv) vedlagte SOSI-fil Vegoppmerking. Da fikk jeg følgende feil
{noformat}
java.lang.IllegalArgumentException: fromIndex(0) > toIndex(-100)
{noformat}
Kibana: https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.8-2020.05.13/doc/?id=sg3UDHIB1fw3jcDZf3o6

Prøvde også å stedfeste både Vegoppmerking og Vegdekke samtidig. Da får jeg bare feil fra backend. Ser ikke ut til at jeg får noe respons. Konsoll kaster
{noformat}
VM15323:1 POST https://datafangst-test.kantega.no/rest/vegobjekt/fc9c8fea-412a-4e72-b03f-f1d77fe89d8b/autostedfest net::ERR_EMPTY_RESPONSE
{noformat}
og spinner bare henger og henger

h2. Løsning
Fikser bug i partisjonering av liste for å dele innsendinger til Skriv, for første feil.

Klarer ikke å reprodusere feil nummer to (ERR_EMPTY_RESPONSE). Får noen følgefeil om at progress helger siden den har mista tellinga, men det er en annen sak.",NVDB-6937,Datafangst,
Får ikke slettet kontrakter fra kontraktslista,"h2. Observasjon

Jeg får ikke slettet egne kontrakter fra kontraktslista. Denne muligheten er ""grået ut"". Jeg kan gå inn på en av mine og slette fra Innstillinger, så det er ikke feil på rettighetene, men feil i GUI.

Sammenheng med at det er fullt navn og ikke brukernavn som vises?
h2. Analyse

selectoren som avaluerer om brukeren har rettigheter til å slette kontrakten ser på name istedet for username. dermed funker ikke evalueringen etter at navn har blitt erstattet med ldapnavn.
h2. Løsning

evaluer username istedet for name i selectoren",NVDB-6937,Datafangst,
Stedfesting med Skriv: Manuell stedfesting gir rare resultater,"h2. Observasjon

Denne observasjonen er uavhengig av med/uten Skriv. Last inn vedlagte SOSI. Aut.stedfest (se resultat på vedlegg). Merk vei litt bortenfor (se vedlegg), manuelt stedfest PUNKT 1. Da blir ikke stedfestingen som forventet (se vedlegg) - og heller ikke likt som før (ref Prod - som også er vedlagt).
h2. Analyse

Skriv bruker veg som holdepunkt når den skal finne kandidater (fx E6).

I kompleksevegsystemer så er ikke det nok til at Skriv finner nøyaktig riktig veglenke å stedfeste til, i dette tilfellet ønsker man å stedfeste til en rampe i et kryss med rampesystem og undergang, og hele vegsystemet ligger under E6.

Skriv tar også i mot en paramtere typeVeg, men det var implementert feil, ved at vegstatus ble brukt istedet.

Ved å benytte typeVeg riktig kan vi gi Skriv en parameter til for å snevre inn kandidatene. Vegnettet i Datafnagst hentes fra VVI, som ikke har noe forhold til TypeVeg. vi må derfor hente TypeVeg fra LES v3 for den aktuelle veglenken.

Skriv vil nå kunne hente ut Rampe-kandidater fra vegsystemet, og finne den som er nærmest. Det betyr samtidig at brukeren ikke har noen mulighet til å selv velge hvilken rampe i vegsystemet det skal stedfestes til, det blir alltid den nærmeste. Det kan eksemplifiseres ved å prøve å stedfeste til rampen på andre siden av vegen, som vil gi feil resultat.
h2. Implementasjon

frontend sender nå inn hele vegsegmentet til backend, som inneholder det vi trenger, inkludert vegsegmentId.
 locationalService kaller ReadApiGateway som har fått metoder for å hente ut typeVeg gitt et vegsegment. 

Det er litt prematurt å hente inn TypeVeg som avhengighet fra API LES v3 ennå, så ReadApiGateway konverterer verdiene fra Enum til Streng, som sendes videre inn til les.

 

 ",NVDB-6937,Datafangst,
NVDBREF-642 : Feil status i kontrollpanelet ved opplasting av prosjekter samtidig med start av reindeksering,"Status på fremdrift endres ikke fra UTFØRT til UTFØRT_OG_ETTERBEHANDLET i kontrollpanelet, noe som medfører at låsen må fjernes manuelt av vegnettsredigererne.
Eksempel:
Vi har etter 2 av de siste reindekseringene av PROD opplevd at prosjekter som leses inn ca 15.30 blir liggende som UTFØRT etterpå. Dette er prosjekter som vi ser er etterbehandlet og vi må ta låsen på manuelt. Hadde samme problemstilling for noen måneder siden, men da gjaldt det mange flere prosjekter. Eksemplene er Fredag 08.05 kl 15.27.34 (Karoline Aylin Atakan [3ce8f8c9-d461-4038-b6c4-15b99efbda5d|https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/3ce8f8c9-d461-4038-b6c4-15b99efbda5d?inkluderResultat=NEI] ) og (788c7dec-b9b1-4c49-897e-15a223c03989 lest inn kl 15.30.13  24.04 av Ragnhild Tunheim)
 
 
 
[ {color:#344563}Permalink{color}|https://www.vegvesen.no/jira/browse/NVDBREF-642?focusedCommentId=298973&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-298973] [ {color:#344563}Edit{color}|https://www.vegvesen.no/jira/secure/EditComment!default.jspa?id=167340&commentId=298973] [ {color:#344563}Delete{color}|https://www.vegvesen.no/jira/secure/DeleteComment!default.jspa?id=167340&commentId=298973]
[~linsto] added a comment - 7 hours ago
Kommentar fra Hans Jørgen på mail 11.05.2020:

_Handler (tror vi) om kommunikasjon mellom Les og Skriv for prosjekter som blir lagret i NVDB i tidsrommet rundt full reindeksering._

_Brukeren får melding om status «Utført» (lagret i NVDB), men får ikke melding om «Utført og etterbehandlet» i Skriv sitt Kontrollpanel etter at full reindeksering er fullført. Ei heller blir +låsen+ slettet._
 ",NVDB-6937,NVDB-IND,
Tillat ny verdi i ikke-eksisterende listeegenskap,"h2. Observasjon

Endringssettet under avvises med ""Egenskapstypen 220004 finnes ikke i objektet"".

{code:json}
{
  ""låsing"": null,
  ""kontekst"": null,
  ""validering"": null,
  ""registrer"": {
    ""vegobjekter"": [
      {
        ""egenskaper"": [
          {
            ""verdi"": [
              ""116 - Glatt kjørebane""
            ],
            ""typeId"": 5530,
            ""struktur"": null,
            ""geometri"": null,
            ""binaer"": null,
            ""enum"": null
          }
        ],
        ""assosiasjoner"": null,
        ""stedfesting"": {
          ""linje"": null,
          ""punkt"": [
            {
              ""retning"": ""MED"",
              ""sideposisjon"": null,
              ""kjørefelt"": null,
              ""veglenkesekvensNvdbId"": 287671,
              ""veglenkesekvensTempId"": null,
              ""posisjon"": 0.1836126
            }
          ],
          ""sving"": null
        },
        ""gyldighetsperiode"": {
          ""startdato"": ""2020-05-12"",
          ""sluttdato"": null
        },
        ""validering"": null,
        ""typeId"": 96,
        ""tempId"": ""57428801-3537-4f41-9e73-34304699c4aa""
      },
      {
        ""egenskaper"": [
          {
            ""verdi"": [
              ""117 - Farlig vegskulder""
            ],
            ""typeId"": 5530,
            ""struktur"": null,
            ""geometri"": null,
            ""binaer"": null,
            ""enum"": null
          }
        ],
        ""assosiasjoner"": null,
        ""stedfesting"": {
          ""linje"": null,
          ""punkt"": [
            {
              ""retning"": ""MED"",
              ""sideposisjon"": null,
              ""kjørefelt"": null,
              ""veglenkesekvensNvdbId"": 287671,
              ""veglenkesekvensTempId"": null,
              ""posisjon"": 0.1836126
            }
          ],
          ""sving"": null
        },
        ""gyldighetsperiode"": {
          ""startdato"": ""2020-05-12"",
          ""sluttdato"": null
        },
        ""validering"": null,
        ""typeId"": 96,
        ""tempId"": ""dec527f7-eea8-47ef-858d-a1e9a651a797""
      }
    ],
    ""vegnett"": null
  },
  ""oppdater"": null,
  ""korriger"": null,
  ""lukk"": null,
  ""fjern"": null,
  ""delvisOppdater"": {
    ""vegobjekter"": [
      {
        ""egenskaper"": [
          {
            ""verdi"": [
              ""Kommune""
            ],
            ""typeId"": 7999,
            ""struktur"": null,
            ""geometri"": null,
            ""binaer"": null,
            ""enum"": null,
            ""operasjon"": ""oppdater""
          }
        ],
        ""assosiasjoner"": [
          {
            ""operasjon"": ""oppdater"",
            ""nvdbId"": [],
            ""tempId"": [
              {
                ""verdi"": ""57428801-3537-4f41-9e73-34304699c4aa"",
                ""operasjon"": ""ny""
              },
              {
                ""verdi"": ""dec527f7-eea8-47ef-858d-a1e9a651a797"",
                ""operasjon"": ""ny""
              }
            ],
            ""typeId"": 220004
          }
        ],
        ""stedfesting"": null,
        ""gyldighetsperiode"": null,
        ""validering"": {
          ""lestFraNvdb"": ""2020-05-11T16:20:51"",
          ""overlappsautomatikk"": null,
          ""reduserPunkttetthet"": null
        },
        ""typeId"": 95,
        ""nvdbId"": 1007893605,
        ""versjon"": 1,
        ""overskriv"": ""JA""
      }
    ],
    ""vegnett"": null
  },
  ""delvisKorriger"": null,
  ""status"": null,
  ""ansvarlig"": null,
  ""datakatalogversjon"": ""2.20"",
  ""id"": null
}
{code}

h2. Analyse

Feilmeldingen stammer fra PartialFeatureEnricherJobFilter, som reagerer på at det forsøkes å legge inn en ny assosiasjonsverd i en assosiasjonsattributt som ikke finnes. Oppførselen er ""by design"", men oppleves litt urimelig siden det å fjerne alle verdier fra slik attributt godtas og fører til attributten fjernes i sin helhet. Saken endres til ""New Feature"" for å implementere støtte for den ønskede operasjonen.

h2. Løsning

Sjekken i PartialFeatureEnricherJobFilter på om den delvise egenskapsoperasjonen kan gjennomføres endres til å bare se på operasjon SLETT på egenskapen og operasjon OPPDATER med en eller flere verdier fjernet. Operasjon OPPDATER med en eller flere verdier lagt til skal da gå gjennom.",NVDB-6937,Skriv-API,
Lokal kjøring og tester får TLS-feil pga. gammel bundlet keystore,"Vi har et oppsett med en bundlet keystore fra 2015, som nå ikke virker med nye sertifikater på www.utv og www.test.vegvensen.no.

Ser ut til å virke uten custom keystore ellers, så den kan slettes.",NVDB-6937,Datafangst,
"""Helsesjekk"" på full reindeksering","Vi bør ha en automatisert måte å sjekke om full reindeksering med påfølgende inkrementell indeksering har gått bra eller ikke, slik at vi ikke behøver å vente på at brukerne oppdager at det. f.eks mangler data.

En enkel variant kan kanskje være å telle opp hvor mange man har av de ulike objekttypene før og etter indekseringen, og varsle fra om avviket er større enn forventet.

Hvor og hvordan det skal varsles må avklares som en del av saken. Det er ikke tilstrekkelig å varsle på et sted hvor bare Kantega-ansatte kan se det, som f.eks mattermost.

 

*Løsning*

Det er lagt inn en konsistenssjekk som kjøres for hvert type under full indeksering. Den teller opp antall dokumenter som har blitt skrevet til Solr, og sammenligner med antallet i NVDB. Hvis antallet er forskjellig logges det en melding. På dashboard-et til NVDBIND i Splunk legger vi en varsling på denne type meldinger, slik at man kan se eventuelle avvik der etter full indeksering.",NVDB-6937,Les-API,
Feil ved lagring når attributt er null,"h2. Observasjon

Sak NVDB-5481 løste at man får opp objekter i datafanen som har ""null"" som verdi for en egenskapstype. Men hvis man prøver å registrere en slik får man svar fra Skriv:
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>Request body unmarshalling failed at line: 1, col: 633: cvc-elt.3.1: Attribute 'http://www.w3.org/2001/XMLSchema-instance,nil' must not appear on element 'verdi', because the {nillable} property of 'verdi' is false.</message></fault>
{noformat}
[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.8-2020.05.08/doc/?id=Rf5C83EBQ6NGvyzfIbQw]

Gjenskap ved å laste opp vedlagte fil. Sett attributt 1910 til null i databasen (samme beskrivelse som i NVDB-5481), koble til en mor i NVDB (hvis det ikke eksisterer så opprett en), og registrer.",NVDB-6937,Datafangst,
LocationalTrimmer må ta høyde for høyde i alle scenarier.,"Dette er en utvidelse av NVDB-5441
h2. Analyse

En feil i ReadApiGateway gjør at vi henter veglenker som er utgått på dato. Veglenker som er utgått på dato er ofte erstattet med nye veglenker, pga vegarbeid og utbedringer på vegnettet. Dette resulterer i at vi jobber på en sekvenser med overlappende veglenker. 

Når vi skal passe på at datter er innenfor mor, gjør vi det ved å sammenlikne stedfestingen til mor med stedfestingen mor _burde ha hatt_ hvis mor var utvidet til å omfavne sin datter. Dette gjør vi ved å slå sammen stedfestingen til mor og datter, og så *genererer vi en geometri basert på denne stedfestingen*, ved hjelp av veglenkegeometriene fra API LES. Vi gjør så en sammenlikning av geometrisk lengde på geometrien fra den gamle stedfesingen, og den nye, genererte geometrien.

I de tilfellene vi genererer en geometri basert på overlappende veglenker, blir det veldig rare resultater, og vi får ofte geometrier som har en lengde som er helt feil, og som vil variere så mye fra den opprinnelige stedfestingen at konklusjonen blir at datter må ligge alt for langt unna mor, og vi avviser sammenkoblingen.
h2. Implementasjon

Legger til datofelter til vårt domeneobjekt VegLenke. Legger til et filter som bare slipper gjennom veglenker som er gyldige på dags dato.

 ",NVDB-6937,Datafangst,
Returner fylke i vegobjektsøk,"Ved søk etter vegobjekter for en type returneres kommune i lokasjonen, mens om man spør direkte på enkeltobjekt så kommer både kommune og fylke med.

Plania trenger informasjon om fylke, og denne manglen betyr at de må gjøre noen ekstra kall.

Eksempel:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/67?inkluder=metadata,egenskaper,lokasjon&antall=10]

vs

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/67/78728407/4]

Oppgaven går på å legge til fylke i tillegg til kommune for vegobjektsøk.",NVDB-6937,Les-API,
Logge spørretider mot Solr,"Metrikkene for responstider vi får fra Solr er periodevise metrikker som gir gjennomsnittlige verdier siste minutt, siste 15 minutt, siden oppstart, etc. 

Det hadde vært nyttig å kunne få spørretiden fra Solr per spørring i Splunk. Ta da gjerne med TRANSID som kan binde sammen kallet mot API og spørringene API gjør mot Solr før et svar returneres. Og i tillegg hadde det vært nyttig å ta med f.ex collection det spørres mot.

Når vi får sammenstilt dette er det enklere å se om all tid går med til å spørre Solr eller om det er noe tid som går til andre operasjoner i API før svaret sendes tilbake.",NVDB-6937,Les-API,
Legge på JVM-metrikker på Solr,"I dag har vi disse metrikkene: [https://github.com/nvdb-vegdata/nvdb-common/blob/master/solr/dist/config/solr.xml]

Denne spesifiserer noen JVM-metrikker, men finner de ikke igjen i Splunk på søk a la
{noformat}
host IN (svvunvdbsolr06,svvunvdbsolr07,svvunvdbsolr08,svvunvdbsolr09,svvunvdbsolr10) sourcetype=""solr_metrics-log""
{noformat}
Fra  [https://lucene.apache.org/solr/guide/8_4/metrics-reporting.html#jvm-registry] ser det ut til at JVM-metrikkene benytter `group=jvm` og ikke `group=core`.

Derfor må sikkert disse:
{noformat}
<str name=""filter"">gc.G1-Young-Generation.time</str>
<str name=""filter"">gc.G1-Young-Generation.count</str>
<str name=""filter"">gc.G1-Old-Generation.time</str>
<str name=""filter"">gc.G1-Old-Generation.count</str>
<str name=""filter"">memory.heap.usage</str>
{noformat}
legges inn som noe a la
{noformat}
<metrics>
  <reporter name=""log_metrics"" group=""core"" class=""org.apache.solr.metrics.reporters.SolrSlf4jReporter"">
  ...
  </reporter>
  <reporter name=""log_metrics"" group=""jvm"" class=""org.apache.solr.metrics.reporters.SolrSlf4jReporter"">
    <str name=""filter"">gc.G1-Young-Generation.time</str>
    <str name=""filter"">gc.G1-Young-Generation.count</str>
    <str name=""filter"">gc.G1-Old-Generation.time</str>
    <str name=""filter"">gc.G1-Old-Generation.count</str>
    <str name=""filter"">memory.heap.usage</str>
  </reporter>
</metrics>
{noformat}
{{}}",NVDB-6937,Les-API,
Ta ibruk nvdb-api-client v1.8.4,"Ta ibruk nvdb-api-client v1.8.4 når den releases.

Dette for å få med endring som ikke sluker exceptions i feilhåndteringen.",,Rapportgenerator,
Konsollfeil: Cannot read property map,"h2. Observasjon

Gå til [https://datafangst-utv.kantega.no/#!/contract/d90aa2ea-684e-41dd-95e3-867aa2f3e3f8/export]

Merk en av objekttypene. Da kastes en haug av disse i konsoll
{noformat}
TypeError: Cannot read property 'map' of undefined
{noformat}",NVDB-6937,Datafangst,
Ta imot veglenketype som liste i vegnettssøk.,"I arbeid med NVDB-5502 kommer det frem at det må gjøres én spørring per veglenketype dersom man vil filtrere på flere enn én. Dette er ikke tilfelle for de andre parametrene. Se spesielt på adskilte løp, som ble endret til å ta imot liste i forbindelse med NVDB-4704. 

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?kartutsnitt=243932.194,6817569.028,246588.616,6821315.535&vegsystemreferanse=E,R,F,K,P,S&veglenketype=hoved,detaljert]",NVDB-6937,Les-API,
Progress i stedfesting 2 henger seg når VisVegInfo-tjenesten er nede.,"__________
Oppdaget en uheldig effekt av at VisVeginfo-tjenesten var nede i stedfesting 2. Loading-indikatoren ble stående og henge og overlappe innholdet. Loading fullføres aldri.

!nvdb-5507.PNG|width=769,height=282!

 



Dette problemet gjelder generelt i stedfesting2, når vi venter på en respons fra server for å legge til en verdi på loading progress. 

Ved feilsituasjoner som gir 500-error fra server, har vi ikke angitt en egen error-callback for metodene i server-service.ts. Erroren kastes derfor videre, men blir ikke håndtert. Progress blir ikke lagt til, og progress goal blir aldri nådd.

Progress overlay blir stående og henge i evig tid. For brukeren ser det ut som visningen fortsatt laster. I seg selv gir den ingen info hvis loadingen av en eller annen grunn ikke vil la seg fullføre.

*Hvordan reprodusere:*
 Med mindre en ekstern avhengighet er nede, må man nesten reprodusere dette gjennom kode. 
 F.eks: Endre koden til å kaste en exception i metoden getVVITimestamp (StatusResource.java). Åpne stedfesting 2.

*Forslag til løsning:*

Forslag 1 er å håndtere error på server-kallet i action-metodene, slik at dispatcheren for å legge til progress nås, progress goal blir møtt og progress overlay forsvinner. Altså fullføre innlasting til tross for feil. Feilmeldingen for server error vises uansett som ei melding i øvre høyre hjørne.

Forslag 2 gjelder også å håndtere error, men å sette et ""loading failure""-flagg som følge av det. Og i slike tilfeller vise ei skikkelig tilbakemelding til bruker om at visningen ikke lar seg laste pga systemfeil/eksterne avhengigheter som er nede. 

Valg av løsning avhenger jo litt av om det fortsatt er verdi i å laste inn fanen selv om eksterne avhengigheter er nede.",NVDB-6937,Datafangst,
Trykk på stedsnavn gir feil-side,"h2. Observasjon

Åpen Vegkart i ATM og søk etter et stedsnavn. F.ex ""Melhus"" og velg ""Melhus kirke"". Da kommer Vegkart til feilside med feil i konsoll:
{noformat}
ypeError: Cannot read property 'offsetWidth' of undefined at o (dom.js:41) 
at e.panIntoView (Overlay.js:405) 
at e.performAutoPan (Overlay.js:386) 
at e.handleMapChanged (Overlay.js:303) 
at e.dispatchEvent (Target.js:112) 
at e.notify (Object.js:152) 
at e.set (Object.js:171) 
at e.setMap (Overlay.js:354) 
at e.addOverlayInternal_ (PluggableMap.js:496)
...
{noformat}
*NB: Dette fungerer heller ikke i UTV*",NVDB-6937,Vegkart,
NVDBREF-627 : Filter for konnektering på kjørebane og kjørefelt,"Filteret «konnektering» funker bare på lenker på vegtrase-nivå. Det bør også være mulig å benytte filteret for konnektering på kjørebane- og kjørefelt-nivå. Disse lenkene er merket som «DETALJERT_KONNEKTERING». Hvis man prøver å slå på filteret forsvinner lenkene av typen kjørebane og kjørefelt.

 

!image-2020-05-04-11-22-52-561.png!",NVDB-6937,Vegkart,
NVDBREF-634: Flere metergap på EV6 S1 i STM og ATM som er ok i Prod,"Håvard oppdaget noen metergap på EV6 S1 i sin kontroll. Det er riktig i Prod, men oppstår etter kloning og full reindeksering til STM og ATM.

STM: [https://vegkart-stm.utv.atlas.vegvesen.no/#kartlag:geodata/@285468,6557600,16/hvor:~(vegsystemreferanse~(~'EV6))/vegnett:~'metrering+~()/valgt:971774:4:16]

ATM: [https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@285385,6557578,16/vegnett:~'metrering+~()/valgt:971774:4:11]

Prod: [https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@285434,6557596,16/hvor:~(vegsystemreferanse~(~'EV6))/vegnett:~'metrering+~()/valgt:971774:4:11]

Opprinnelig melding fra Håvard (fra STM):

INFO ;Road=EV6, StretchType=S, TopologyLevel=0, TrafficTypes=K
 WARN;Segment1.MeterGap;3001;971774;0,14246255;0,14412295;3088748;1797463;0;;E;V;6;;S;1;1;1018;1030;K;;;;1;1#2#3#4;;285408;6557584;45;285414;6557594;45;Gap=2358,684m
 WARN;Segment2.MeterGap;3001;971774;0,14412295;0,1456891;1797463;3088749;0;;E;V;6;;S;1;1;3389;3400;K;;;;1;1#2#3#4;;285414;6557594;45;285420;6557604;45;Gap=2358,684m
 WARN;Segment1.MeterGap;3001;971774;0,1456891;0,19564084;3088749;2578245;0;;E;V;6;;S;1;1;3400;3757;K;;;;1;1#2#3#4;;285420;6557604;45;285570;6557925;56;Gap=7127,069m
 WARN;Segment2.MeterGap;3001;971774;0,19564084;0,21154681;2578245;3088746;0;;E;V;6;;S;1;1;10884;10998;K;;;;1;1#2#3#4;;285570;6557925;56;285598;6558035;58;Gap=7127,069m
 WARN;Segment1.MeterGap;3001;971774;0,22570891;0,23283812;3088745;1797467;0;;E;V;6;;S;1;1;11099;11150;K;;;;1;1#2#3#4;;285628;6558132;60;285647;6558180;61;Gap=554,000m
 WARN;Segment2.MeterGap;3001;971774;0,23283812;0,24182985;1797467;2532381;0;;E;V;6;;S;1;1;11704;11769;K;;;;1;1#2#3#4;;285647;6558180;61;285674;6558238;62;Gap=554,000m
 WARN;Segment1.MeterGap;3001;971774;0,24429056;0,24547458;3088750;991802;0;;E;V;6;;S;1;1;11786;11795;K;;;;1;1#2#3#4;;285682;6558254;62;285685;6558261;62;Gap=225,000m
 WARN;Segment2.MeterGap;3001;971774;0,24547458;0,24719798;991802;3088747;0;;E;V;6;;S;1;1;12020;12032;K;;;;1;1#2#3#4;;285685;6558261;62;285691;6558272;62;Gap=225,000m

 

*Analyse*

I spørringen som henter ut vegsystem for en strekning til cachen hentes det med dato ""fra-og-med"" til ""til-og-med"". Det gjør at akkurat på datoen et vegsystem ble erstattet av et nytt ble begge vegsystemene hentet ut. Det påvirker senere beregning av meter for strekninger på de vegsystemene.

For S1D1 sekvens 1000 på EV6 ble deler av lenkesekvenser: 930591, 1842458, 930590 og 2582832 feilaktig brukt som førte til det første hoppet.

*Løsning*

Endret slik at vegsystemer for cache hentes med dato ""fra-og-med"" til ""til"". Endringen krever full indeksering.",NVDB-6937,NVDB-IND,
Database er kun konfigurert for ISO-8859-1,"(!) *Manuelle steg ved installasjon, se detaljer lengre ned.*
h2. Observasjon

Vegobjekttype 96: Skiltplate

har egenskap 5530 Skiltnavn.

Dette er en enum-egenskap. Enum 7807 inneholder et uvanlig tegn (U+0085) og fører mest sannsynlig til at egenskaper med denne verdien ikke validerer og kan lagres til skriv.

<enumverdi>
 <id>7807</id>
 <kortnavn>808.343</kortnavn>
 <type>Tekst</type>
 <verdi>808.343 - Minste kjøretøyavstand …m</verdi>
 <beskrivelse>
 Minste kjøretøyavstand  m. (F.o.m. ver. 1.76: Skiltnummer endret fra ""808.32b"")
 </beskrivelse>
 <sorteringsnummer>1142</sorteringsnummer>
 <objektliste_dato>2012-05-08</objektliste_dato>
 <standardverdi>false</standardverdi>
 </enumverdi>

I redigeringsmodus i Jira kan man også se [0085] mellom ""Minste kjøretøyavstand "" og ""m."" Det vises også som [0085] i drop-down (se vedlegg), men når det er lagret og vises etterpå står det som et vanlig spørsmålstegn.

Vi må finne ut hvorfor dette blir feil i Datafangst, og om det også kan påvirke andre tegn.

I tillegg er det greit å ha en dialog med innhold i datakatalogen, det var antakeligvis ikke dette tegnet som de mente å ha der.
h2. Analyse

Frontend sender 0085 som en Unicode-escape, ""\u0085"". Denne blir tatt i mot riktig av Java, fortsatt verdi 0x0085 for tegn. Vi validerer mot Skriv uten feil, da antar jeg at denne fortsatt er riktig, ellers så burde vi fått samme feil som når vi sender inn.

Ser ut som det fortsatt er riktig før vi skriver til database, men etter at endring er skrevet og lest tilbake så er 0x0085 konvertert til ""?"". Ser ut til at database står på [MariaDB / MySQL default|https://mariadb.com/kb/en/setting-character-sets-and-collations/], som er ""latin1"". Derfor kan vi ikke lagre andre enn vest-europeiske tegn i dag. Så ingen polsk Ł for eksempel, og i alle fall ingen ☺.
h2. Løsning

Database konverteres til Unicode / UTF-8. Databasedriver må oppdateres for å få Unicode til å virke.
h1. Installasjon

Installasjon av denne saken krever noen manuelle steg.

Husk backup av databasen!
h2. Før installasjon

Connect string for database må endres i datafangst.conf, fra "":mysql:"" til "":mariadb:"".
h2. Etter installasjon

Script for endring av tegnsett må kjøres. Dette krever ca 3 timer der Datafangst er avskrudd, og må gjøres på kveld eller helg, pluss varsles på forhånd.
 # Stopp Datafangst
 # Kjør vedlagt SQL-script
 # Sjekk at alle tabeller er konvertert, ved å kjøre spørring i kommentar
 # Slett ""mysql-connector-java-5.1.35.jar"" fra ""/opt/svv/vt/tc-vt-u04/base-datafangst-01/lib""
 # Start Datafangst på nytt og verifiser",NVDB-6937,Datafangst,
Hjelpefunksjonalitet for lagring,"*Problem*: Fagklienter har spesifikke behov for lagring til NVDB som ikke er ivaretatt idag.


*Mål*: Sikre at alle klienter får nødvendig hjelp til lagring.


*Tiltak*: 
Kartlegge omkringliggende klienters behov og problemer knyttet til lagring. Start med logganalyse.
Prioritere og implementere identifiserte tiltak.


*Interessenter*:
Andre klienter:
Brutus, Bruksklasse, SINUS, Målestasjonsregisteret,",NVDB-6937,Skriv-API,
NVDB API Client skjuler/sluker exceptions,"Den +eksterne+ komponenten *nvdb-api-client* som vi bruker for kommunikasjon med NVDB Les API skjuler/sluker exceptions, slik at vår kode ikke har mulighet for å reagere på enkelte feil.

Dette er feil som oppstår når Les API er presset og ikke svarer fort nok. Det er visstnok Openshift/Atlas som ikke venter lenge nok på svar fra Les API.

Det er uheldig at brukere av klienten ikke får informasjon om at noe er feil.

 

+*Logg* (etter endring slik at exception ikke slukes):+

{{2020-04-29 15:48:16,406 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-3) Preparing to fetch data for 79, 40 out of 802020-04-29 15:48:16,406 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (ForkJoinPool.commonPool-worker-3) Preparing to fetch data for 79, 40 out of 802020-04-29 15:49:55,695 ERROR [no.veg.nvd.cli.exc.JsonExceptionParser] (pool-123-thread-1) Could not parse '<html><body><h1>504 Gateway Time-out</h1>The server didn't respond in time.</body></html>' as json ({}): com.google.gson.JsonSyntaxException: com.google.gson.stream.MalformedJsonException: Use JsonReader.setLenient(true) to accept malformed JSON at line 1 column 22 path $ at com.google.gson.JsonParser.parseReader(JsonParser.java:66) at com.google.gson.JsonParser.parseString(JsonParser.java:47) at no.vegvesen.nvdbapi.client.exceptions.JsonExceptionParser.parse(JsonExceptionParser.java:53) at no.vegvesen.nvdbapi.client.clients.util.JerseyHelper.parseError(JerseyHelper.java:64) at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:75) at no.vegvesen.nvdbapi.client.clients.AsyncResult.lambda$null$0(AsyncResult.java:54) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748)Caused by: com.google.gson.stream.MalformedJsonException: Use JsonReader.setLenient(true) to accept malformed JSON at line 1 column 22 path $ at com.google.gson.stream.JsonReader.syntaxError(JsonReader.java:1564) at com.google.gson.stream.JsonReader.checkLenient(JsonReader.java:1405) at com.google.gson.stream.JsonReader.doPeek(JsonReader.java:543) at com.google.gson.stream.JsonReader.peek(JsonReader.java:426) at com.google.gson.JsonParser.parseReader(JsonParser.java:61) ... 8 more}}

 ",NVDB-6827,Rapportgenerator,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-3826: Verifiser at områdefilter med en type kun viser typen i området. F.ex Trondheim og Rekkverk.
 * NVDB-5148 (NVDBREF-447): Se beskrivelse og kommentarer. [https://vegkart.test.atlas.vegvesen.no/#kartlag:topo4/@639344,7665312,17/hva:~(~(id~49))/hvor:~(vegsystemreferanse~(~'FV86S1D1))/valgt:91610807:49] kan benyttes (om NVDB-id er lik i UTV og ATM).
 * NVDB-5444: Verifiser at trafikantgruppe er med i vegsystemreferansen (både liste og på objketet).
 * NVDB-5007: Sjekk at det logges i ATM
 * NVDB-5379: Verifiser akseptansekriteriene
 * NVDB-5406 (NVDBREF-610): Verifiser at beskrivelsen nå fungerer
 * NVDB-5428 (NVDBREF-611): Verifiser at beskrivelsen nå fungerer
 * NVDB-5429 (NVDBREF-433): Verifiser akseptansekriteriene
 * NVDB-5298: Se at vegnett vises i både Trondheim, Trøndelag og Bergen
 * NVDB-5435 (NVDBREF-623): Oppdatert info i spash om v2 og v2-url

Saker i leveransen som ikke er eksplisitt nevnt over trenger ikke å testes spesifikt i ATM.",NVDB-6937,Vegkart,
Fjerne twitter-feed i åpningsbildet til v2,"-Har fått tips på mail fra Stephanie. Vi diskuterte også noe lignende i et møte med bla. May Britt og Hans Anton:-

-------------------
 -Hei igjen.- 
 -Jeg håper du er den riktige person til det 😊.-
 -Kan jeg komme med en liten forslag.- 
 -Ved vegkart v2 kommer det opp en vindu med en eldre NVDB twit. ( se bilde) Jeg tror ideen er veldig bra. Kan man ikke i ny V3 versjonen lage en kopling til den aktuelle NVDB-Twitter-account? [https://twitter.com/NVDBapi]-

-Hilsen Stephanie 😊-
 ------------------- 
 -Altså legge inn Twitter-feeden i åpningsbildet i vegkart.- 
 -Stephanie sin epostadresse er: [stephanie.lupfert-streich@vegvesen.no|mailto:stephanie.lupfert-streich@vegvesen.no]-

Vi fjerner Twitter-feeden i V2 i stedet.",NVDB-6937,Vegkart,
Tomme verdier sendes inn til API Skriv,"h2. Observasjon

Det er flere ganger at det kommer support-henvendelser på at man ikke får registrert mot Skriv. Dette gjelder ikke når man får AVVIST, men når man får en rød feilmelding ved trykk på Registrer. Da får gjerne DF en HTTP 400 med beskjed om at noe er feil ihht skjema på endringssettet.

I mange tilfeller skyldes dette at DF sender inn tomme verdier. Dvs at for en egenskapstype så sender vi inn _<verdi></verdi>_. Slike typer kommer typisk inn via API, og vi har gjort en fix på API for å filtrere bort slike verdier (NVDB-5205). Dette kan sees i datafanen ved at en celle for en egenskap er merket oransje/endret uten at det står en verdi der.

Eksemplet fra Kibana

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.30/doc/?id=Td2TyXEB7uutkyPZqC_y]

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.30/doc/?id=Ud2TyXEB7uutkyPZqC_y]

Denne oppgaven går ut på å fjerne de egenskapene som har _<verdi></verdi>_ fra endringssettet før vi sender det inn mot Skriv. Brukeren får ingen info om at dette er problemet, og blir stuck.

Videre bør vi nok også ta en kikk på at filtrering i API fungerer for tomme verdier - spesielt dersom det sendes inn mange features i en innsending hvor noen egenskapstyper har tomme verdier, mens andre har verdier for disse egenskapene.",NVDB-6937,Datafangst,
Sjekk søkeparametere også i paginering,"Vi kan spare kall ved å sjekke om søkeparameterne er utdaterte på flere steder enn det vi gjør i dag, blant annet mellom hvert page-kall.

 

Estimat (Anders-fart): 2 dager",NVDB-6937,Vegkart,
Stedfesting 2: Mulighet for å beholde zoom,"Tilbakemelding fra Jan Vidar Strømsvold etter test av stedfesting 2
{noformat}
Den tingen som står ut når eg jobber med denne er at den zoomer ut til hele kontraktsområdet når en fjerner valgt objekt etter stedfesting. 

Det gjelder spesielt i driftkontrakten DK1107 Haugesund. Den strekker seg fra nord på Stord til sør på Bokn, og da blir det mye zooming. 

Ønsker: Autozoom-knapp slik vi har i objektoversikten. For da kan en få begge deler.
{noformat}
Vedlagt ligger den knappen han ønsker seg for at det skal være helt tydelig.",NVDB-6937,Datafangst,
Stedfesting 2: Tilbakemelding etter stedfesting av en type,"En tilbakemelding etter test av stedfesting 2 (Geir Magnus Tungland og Joakim Møyholm) sier
{noformat}
Når operasjonen automatisk stedfesting er ferdig, hadde det vært greit med en dialog/annen knapp enn avbryt for å gi brukeren beskjed.
{noformat}
Her tenkes det kanskje på en slags status på at ønskede typer ble stedefestet, eller lignende.",NVDB-6937,Datafangst,
Crash når skilttekst er null i database,"h2. Observasjon
Jan Vidar Strømsvold melder om feil under lasting som gjør at data i kontrakten ikke kommer fram.

Årsaken viser seg å være en NullPointerException når en skiltplate har attributten tekst, men at verdien for attributten er {{null}}. For å reprodusere, sett attributt-ID 1910 til null i databasen for en skiltplate.

Stacktrace:
{noformat}
java.lang.NullPointerException: null
	at no.svv.nvdb.datafangst.descriptivename.SkiltplateDescriptiveNameGenerator.generate(SkiltplateDescriptiveNameGenerator.java:27)
	at no.svv.nvdb.datafangst.descriptivename.FeatureDescriptiveNameGeneratorImpl.generateDescriptiveName(FeatureDescriptiveNameGeneratorImpl.java:37)
	at no.svv.nvdb.datafangst.representation.FeatureJson.fromDomain(FeatureJson.java:216)
	at no.svv.nvdb.datafangst.representation.FeatureListJson.lambda$fromDomain$0(FeatureListJson.java:28)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
	at no.svv.nvdb.datafangst.representation.FeatureListJson.fromDomain(FeatureListJson.java:28)
	at no.svv.nvdb.datafangst.rest.ContractResource.lambda$listFeatures$8(ContractResource.java:684)
	at no.svv.nvdb.datafangst.rest.ContractBaseResource.lambda$getResponseWithLastModified$2(ContractBaseResource.java:84)
	at java.util.Optional.map(Optional.java:215)
	at no.svv.nvdb.datafangst.rest.ContractBaseResource.getResponseWithLastModified(ContractBaseResource.java:74)
	at no.svv.nvdb.datafangst.rest.ContractResource.listFeatures(ContractResource.java:677)
{noformat}",NVDB-6937,Datafangst,
NVDBREF 538 - Hvilke endringer må gjøres i NVDB API Les ifm fjerning av assosiasjon til kommune i gateobjektet?,"Det er ønskelig å få en vurdering av hvordan navneendring på dagens objekttype 538 Gate berører NVDB API Les. Grovestimat er ønskelig.

Objektnavnet Gate vil bli endret til _Vegadresse, fjerning av dagens assosiasjon til 946 Kommune og 536 Kommune 2019, samt_ 
 * Ny ET _Kommune_
 * ET 4588 _Adressekode_ (tall)
 * ET 4589 _Adressenavn_ (tekst)
 * ET 9793 _Sideveg_ med tillatte verdier _Ja_ eller _Nei_ (uendret)

*API Les* 
 * Spesialhåndteres objekttypen 538 Gate på noen måte i Les V2 eller V3?
 * Har det noen konsekvens for V2 at det ikke lengre vil være noe forhold til 2019-kommuner?
 * Vil det være mest praktisk med en overgangsløsning der objektet har kommunetilhørighet både via assosiasjon og egenskap samtidig?
 * Er det noe annet det må tas høyde for i denne saken?

 

NVDB API Skriv har gjort egen analyse av saken https://jira.kantega.no/browse/NVDB-5346

Se forøvrig også [https://www.vegvesen.no/jira/browse/NVDBREF-568]

 

 

 ",NVDB-6937,Les-API,
Fjerne brukerveiledning og linke til brukerveiledning,"Brukerveiledning på pdf er tungvint å oppdatere. 
Foreslår å fjerne den som ligger i Datafangst nå, og heller linke til https://www.vegdata.no/datafangst/brukerveiledning-datafangst/

Denne siden trenger fortsatt litt finpuss, men den er like god som den gamle. ",NVDB-6937,Datafangst,
Sjekk avvik mellom segment og strekningslengde,Vi logger avvik mellom segment og beregnet meter. Sjekk hvorfor det er så mye avvik.,NVDB-6937,NVDB-IND,
Like farger i kategorisering,"h2. Observasjon

Legg inn Trondheim og Fartsgrense. Kategoriser på fartsgrense. Da vil alle kategoriene ha lik farge (grå). Her burde de fått ulike farger.
{noformat}
https://vegkart.utv.atlas.vegvesen.no/#kartlag:geodata/@268102,7030868,10/hva:~(~(category~(type~'enum~id~2021)~id~105))/hvor:~(kommune~(~5001))
{noformat}
Legger merke til at søk etter rekkverk og kategorisering på rekkverkstype gir farger i kategoriene. Noe med typen data?",NVDB-6937,Vegkart,
Henting av vegnett kræsjer,"h2. Observasjon

Hent inn Trondheim. Vis vegnett. Hent opp Trøndelag. Da kræsjer etterhvert Vegkart med en konsoll-feil
{noformat}
TypeError: Cannot read property 'wkt' of null
{noformat}
Sentry-url sendt: [https://sentry.kantega.org/api/4/store/?sentry_key=0c7933dc738f4239b24be0be4aeff2ce&sentry_version=7]

Det samme skjer ved å vise vegnett i Trondheim. Bergen og Stavanger. Dette går bra, men når Rogaland legges til blir det kræsj.

Ser at det går separate kall for f.ex

/vegnett/veglenkesekvenser/segmentert?kartutsnitt=-609707.338,6466105.14,796020.558,7051059.45&fylke=11&vegsystemreferanse=S

/vegnett/veglenkesekvenser/segmentert?kartutsnitt=-609707.338,6466105.14,796020.558,7051059.45&kommune=5001,4601,1103&vegsystemreferanse=S

men det er når det begynner å gå et kall per fylke sammen med kommunene at det til slutt kræsjer. A la

/vegnett/veglenkesekvenser/segmentert?geometritoleranse=30&kartutsnitt=-609707.338,6466105.14,796020.558,7051059.45&fylke=54&kommune=5001,4601,1103&vegsystemreferanse=E,R,F,K,P,S",NVDB-6937,Vegkart,
Direktelenking av områder henter ikke geometri automatisk,"Eks. [https://vegkart.utv.atlas.vegvesen.no/#kartlag:geodata/@-23756,6587210,8/hvor:~(kommune~(~1103)~vegsystemreferanse~(~'KV9999))]

StateToHash blir riktig, men siden trigger på henting av områdegeometri nå er flyttet bort fra OLMap-komponenten, får vi ikke områder tegnet på kartet.",NVDB-6937,Vegkart,
Endringssett restartes gjentatte ganger pga versjonssjekk,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/49f0eb8e-e98e-4d0e-b15c-ac6d895bf4f9 restartes flere ganger i løpet av en time pga ENRICHMENT_VERSION_CHECK_FAILED, altså at en annen prosess har endret vegobjekter som denne jobben har beriket inn. Deretter hindres ny versjonssjekk fordi det ikke lar seg gjøre å etablere optimistisk lås.

Det virker litt mistenkelig at versjonssjekk for berikinger ikke kommer videre etter en time (muligens mer). Må sjekkes ut via Splunk.

h2. Analyse

Fra Splunk:

{noformat}
2020-04-23T10:42:04.840 INFO  [ActiveMQ Transport: tcp://localhost/127.0.0.1:61616@51916] [49f0eb8e-e98e-4d0e-b15c-ac6d895bf4f9] n.v.v.n.a.j.StaleFeatureVersionChecker Feature version op:MODIFY tid:96 id:78798880 v:2 sd:2020-01-01 ed:2020-01-09 - ac:ADD or:AdaptFeaturesToChangedMeterDirectionEnricherFilter vr:false co:false is stale, last version no in NVDB is 2
{noformat}

Som vi ser, skyldes versjonskonflikten et forsøk på å versjonere skiltplaten 78798880v1 fordi det er stedfestet på veglenkesekvens som får endret metreringsretning og datoen for retningsskiftet er innenfor gyldighetsperioden til vegobjektversjonen. Rett etter låsing sikrer StaleFeatureVersionChecker at all beriking av jobben forholder seg til korrekte versjoner. Når den ser at v2 av et vegobjekt forsøkes etablert sjekkes at v1 er siste versjon i NVDB. Det er det ikke.

Hvorfor ble v2 forsøkt etablert av AdaptFeaturesToChangedMeterDirectionEnricherFilter? Når det søkes i NVDB etter vegobjektversjoner som er berørt av metreringsendringen, søkes det etter versjoner som er stedfestet på en bestemt veglenkesekvens og er gyldige etter datoen for retningsendringen. I dette tilfelle har v2 av skiltplaten fått stedfesting på en annen veglenkesekvens og det returneres derfor ikke i søket. Senere i AdaptFeaturesToChangedMeterDirectionEnricherFilter undersøkes om v1 er en framtidig versjon i ensureCurrentVersionsOnly(). I så fall skal endringssettet avvises med feilmelding, noe det ville gjort om det var v2 som ble undersøkt. Men v1 passer ikke kriteriet for ""framtidig versjon"" og går derfor videre og blir oppdatert til v2.

h2. Løsning

Lager ny metode som invokeres etter ensureCurrentVersionsOnly, der det undersøkes om noen av de berørte vegobjektversjonene er historiske versjoner. I så fall genereres en feilmelding a la den i ensureCurrentVersionsOnly.",NVDB-6937,Skriv-API,
Fix e2e-tester,E2E-testene feiler. Sannsynligvis pga ny måte å hente kall fra API på. Dette innebærer høyst sannsynlig noen endringer på ruting i e2e-testene og nye wiremock opptak.,NVDB-6937,Vegkart,
NVDBREF-626 - Validere at kombinasjon av gatekode og gatenavn blir unike innenfor kommunen,"h2. Bakgrunn

Skriv validerer i dag ikke at kombinasjonen av gatekode/gatenavn som sjekkes inn er unike innenfor kommunen. Dersom samme gatekode eller gatenavn eksisterer i samme kommune fra før, så skal ikke endringer som sjekkes inn fravike fra disse.

Valideringen gjelder objekttype 538 Gate sine egenskapstyper 4588 Gatekode og 4589 Gatenavn.
Sjekk om nye og endrede gatekoder og gatenavn eksisterer fra før i kommunen. Avviker kombinasjonen av disse, så skal innsjekket stoppes, og brukeren meldes om hvilke gateobjekter som ikke stemmer overens.
Ønsket meldingstekst: Kombinasjonen Gatekode: [gatekode] og Gatenavn: [gatenavn] på objekt [-ID] i prosjektet stemmer ikke overens med kombinasjonen Gatekode: [gatekode] og Gatenavn: [gatenavn] objekt [ID] som eksisterer i NVDB.
Dersom brukeren sender inn gatekode og gatenavn, og så ligger det objekter i NVDB med kun aktuell gatekode uten gatenavn, så skal innsjekket stoppes. Brukeren skal i slike tilfeller ta bort gatenavn på aktuelle objekter i prosjektet sitt, og så sjekke inn på nytt.
Samme meldingstekst som over benyttes, det vil bare ikke være noe gatenavn på objektet som ligger i NVDB.
Det er ikke behov for varsling når gateobjekt har kun gatekode ved innsjekk dersom gatekoden ikke finnes i NVDB, eller dersom det ligger gateobjekter inne i samme kommune med samme gatekode som heller ikke har gatekode.
Det må tas høyde for eventuelle påvirkninger NVDBREF-568 vil få for dette. Det samme gjelder behovet vi har for å lese inn endrede gatenavn (""gatenavnimporten""). Valideringene her må ikke gjøre det umulig å endre gatenavn på objekter som ligger i NVDB på en så enkel måte som det er lagt opp til i dag.

h2. Analyse

API Skriv utfører allerede delvis den ønskede valideringen på Gate-vegobjekter via constraint'en UniformStreetNameForCode. Denne avviser en ny eller endret Gate, når eksisterende gater i NVDB med samme gatekode og kommunetilknytning har et annet gatenavn. Det som må gjøres er dermed den motsatte valideringen: avvise dersom en ny eller endret Gate har en annen gatekode for angitt gatenavn og kommunetilknytning.

h2. Løsning

Implementerer ny constraint UniformStreetCodeForName etter mønster av UniformStreetNameForCode.",NVDB-6937,Skriv-API,
Online API-dokumentasjon,https://apiskriv.vegdata.no/,NVDB-6937,Skriv-API,
Kopiering av ekisterende med tomme verdier gir feil ved innsending,"h2. Observasjon

[https://datafangst.kantega.no/#!/contract/d8faf56e-0a16-462f-80f9-639860436948/features3]

Ser ut til at verdier for vedlikeholdsansvarlig og eier er fjernet på objekt 
 Skiltpunkt:1006287405. Deretter er dette kopiert til et nytt 95. Denne får da satt tomme verdier for disse ved registrering:
 [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.22/doc/?id=wOsNonEBO6kjk0-YSq1F]
  
 [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.22/doc/?id=s-sNonEBO6kjk0-YSq1E]
  
 Feilmelding fra Skriv er at tomme felter ikke er tillatt. Melding kommer kun for nytt objekt, ikke endring på eksisterende.
h2. Analyse

For eksisterende vegobjekter tar vi vare på endringer til tom verdi for å kunne fortelle Skriv at her skal verdien slettes.

Dette må behandles annerledes på nye vegobjekter, siden det ikke er snakk om noen sletting her.

Tomme egenskaper må derfor filtreres bort i kopieringsfasen. 
h2. Løsning

implementerte et filter i FeatureCloner som fjerner attributter med tom verdi.",NVDB-6937,Datafangst,
Rydd opp i toppmenyen,"h2. Toppmenyen i DF trenger en overhaling.

<a>-element benyttes semantisk feil

Brukernavn ser ut som det er klikkbart, men det er det ikke

ikoner har ikke visuell feedback ved hover

konsistens: alle menyvalg bør ha ikon og tekst

lett omstrukturering:
 * brukernavn bør adskilles fra menyvalg-gruppen
 * log ut bør grupperes sammen brukernavn

 

Lag designskisse og implementer",NVDB-6937,Datafangst,
Ruteberegning: Parameter for start- og sluttdato,"Relatert til sak NVDB-4399, som tilbyr en enkelt betraktningsdato som parameter. Dette er nok nyttig for flere klienter, men for API Skriv som skal beregne stedfesting for et vegobjekt med gyldighet fra og med en dato (startdato) og til en dato (sluttdato), vil det ikke hjelpe. 

Det ønskes to parametere, fraDato og tilDato, som skal føre til at ruten bare beregnes over veglenker som er gyldige på begge datoer. Den siste, tilDato, må kunne settes til ""null"" for å angi at kun veglenker med åpen sluttdato er aktuelle.",NVDB-6937,Les-API,
Aktivere stedfesting2 som default,"sett stedfesting2 som default, tilgjengeliggjør stedfesting 1 som toggle som fallback",NVDB-6937,Datafangst,
Forplantning til detaljerte veglenker: maximum number of expressions in a list is 1000,"{quote}
2020-04-22 08:02:51 [taskexecutor] ERROR TaskExecutor - Task IndexTransaction(4814206, 2020-04-21 15:35:31) failed [4814206 2020-04-21 15:35:31]
no.vegvesen.nvdbind.ExportException: Unable to process netelements for transaction 4814206 2020-04-21 15:35:31
        at no.vegvesen.nvdbind.indexing.RoadnetUpdater.run(RoadnetUpdater.java:60)
        at no.vegvesen.nvdbind.tasks.IndexTransactionTask.run(IndexTransactionTask.java:88)
        at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:193)
        at no.vegvesen.nvdbind.tasks.TaskExecutor.start(TaskExecutor.java:113)
        at no.vegvesen.nvdbind.NvdbindCore$TaskExecutorThread.run(NvdbindCore.java:493)
Caused by: java.sql.SQLSyntaxErrorException: ORA-01795: maximum number of expressions in a list is 1000

        at oracle.jdbc.driver.T4CTTIoer11.processError(T4CTTIoer11.java:494)
        at oracle.jdbc.driver.T4CTTIoer11.processError(T4CTTIoer11.java:446)
        at oracle.jdbc.driver.T4C8Oall.processError(T4C8Oall.java:1054)
        at oracle.jdbc.driver.T4CTTIfun.receive(T4CTTIfun.java:623)
        at oracle.jdbc.driver.T4CTTIfun.doRPC(T4CTTIfun.java:252)
        at oracle.jdbc.driver.T4C8Oall.doOALL(T4C8Oall.java:612)
        at oracle.jdbc.driver.T4CStatement.doOall8(T4CStatement.java:213)
        at oracle.jdbc.driver.T4CStatement.doOall8(T4CStatement.java:37)
        at oracle.jdbc.driver.T4CStatement.executeForDescribe(T4CStatement.java:733)
        at oracle.jdbc.driver.OracleStatement.executeMaybeDescribe(OracleStatement.java:904)
        at oracle.jdbc.driver.OracleStatement.doExecuteWithTimeout(OracleStatement.java:1082)
        at oracle.jdbc.driver.OracleStatement.executeQuery(OracleStatement.java:1276)
        at oracle.jdbc.driver.OracleStatementWrapper.executeQuery(OracleStatementWrapper.java:366)
        at com.zaxxer.hikari.pool.ProxyStatement.executeQuery(ProxyStatement.java:111)
        at com.zaxxer.hikari.pool.HikariProxyStatement.executeQuery(HikariProxyStatement.java)
        at no.vegvesen.nvdb.common.jdbc.dbix.DbSessionImpl.executeQuery(DbSessionImpl.java:185)
        at no.vegvesen.nvdb.common.jdbc.dbix.DbSessionImpl.mapOne(DbSessionImpl.java:118)
        at no.vegvesen.nvdbind.processor.netelements.ModifiedNetElementIdReader.getDetailedLinksCount(ModifiedNetElementIdReader.java:127)
        at no.vegvesen.nvdbind.processor.netelements.ModifiedNetElementIdReader.count(ModifiedNetElementIdReader.java:105)
        at no.vegvesen.nvdbind.processor.netelements.IncrementalNetElementReader.count(IncrementalNetElementReader.java:65)
        at no.vegvesen.nvdbind.indexing.RoadnetUpdater.update(RoadnetUpdater.java:81)
        at no.vegvesen.nvdbind.indexing.RoadnetUpdater.run(RoadnetUpdater.java:58)
        ... 4 common frames omitted
Caused by: oracle.jdbc.OracleDatabaseException: ORA-01795: maximum number of expressions in a list is 1000
{quote}",NVDB-6937,NVDB-IND,
Systemfeil pga endPos > 1.0 ved restedfesting etter geometriutskiftning,"h2. Observasjon

Bruker mortfinn fikk SYSTEMFEIL på fem endringssett fra NovaPoint den 20. april. Eksempel: https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/f461c3f1-d546-40f7-9898-5557942f3b75

{code:java}
java.lang.IllegalArgumentException: end must be less than or equal to 1.0
	at no.vegvesen.vt.nvdb.commons.core.contract.Requires.require(Requires.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Extent.validateRange(Extent.java:115)
	at no.vegvesen.vt.nvdb.apiskriv.domain.Extent.of(Extent.java:78)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.LocationCalculator.calcLocationalLine(LocationCalculator.java:138)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalizeToLine(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:1040)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:1010)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableFeature.relocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:830)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:491)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:159)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:114)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:92)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:128)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:393)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

Det kastes en IllegalArgumentException fra Extent.of fordi et reberegnet stedfestingselement har fått sluttposisjon som er (antageligvis) hårfint større enn maksverdien 1.0. Dette skjer i forbindelse med restedfesting pga ny vegnettsgeometri i AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.

Det er ikke mulig å reprodusere feilen med noen av de fem endringssettene fra mortfinn, fordi data i NVDB har endret seg siden de ble forsøkt sendt inn.

h2. Løsning

Det er lagt inn kontroll og justering av stedfestingselementet dersom det er utenfor gyldighetsområdet [0.0, 1.0]. I tillegg er unntaksbeskrivelsen fra Extent.of utvidet til å ta med hva den relative posisjonen faktisk er sånn at det er enklere å tolke lignende situasjoner i framtida.

Under kodeanalyse ble det avdekket at beregnet sluttposision er hårfint for kort dersom veglenkens geometri er ""bratt"". Rettet dette i samme slengen.",NVDB-6937,Skriv-API,
Gå gjennom loggmeldinger fra meterberegning,"Følg opp alle meldinger fra meterberegning.
Målet er at det ikke skal være noen feilmeldinger, og ingen -1-meter.

Loggmeldinger vi skal prøve få bort: 
{quote}
WARN RoadNetMeterCalculatorImpl - Failed to get roadsystem and section for netelementid 
WARN RoadSysMeterValue - Position 0.70859735 on netelemtid 625641 was not within reflinkExtent 
WARN RoadNetMeterCalculatorImpl - Could not find start or end section for segment
{quote}

At det ikke er noen -1-meter kan sjekkes ved å kjøre filter ""sysref_section_start_meter:\-1"" i nvdb-roadnet-segments""",NVDB-6937,NVDB-IND,
URL-import feiler hvis tekstboks inneholder linjeskift,"h2. Observasjon
Får noen ganger feil når jeg skal importere fra Les API-URL, og tror at mønsteret er at det kommer med et linjeskift etter URL når jeg kopierer fra dokument.

Også rart at jeg få to feilmeldinger (se vedlegg), så mulig det er noe mer på gang her.

h2. Forslag til løsning
Trenger sikkert bare en .trim() på riktig sted.",NVDB-6937,Datafangst,
Vegsystemreferanse mangler i lokasjonsobjekt for vegobjekter-søk,"h2. Observasjon

For et søk etter vegobjekter får jeg ikke med vegsystemreferansen i lokasjons-objektet:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/5?kartutsnitt=269397.028,7041828.583,269773.399,7042295.573&segmentering=true&egenskap=1089%3D13744&inkluder=metadata,egenskaper,lokasjon,geometri&antall=1]

_(Søk i siden etter objekt med id 579117363)_


Følger jeg direktelenken til det aktuelle vegobjektet, finner jeg derimot vegsystemreferansen inkludert:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/5/579117363/1]",NVDB-6937,Les-API,
Bruker som inviterer skal ha riktig sensitiv-rolle,"Basert på diskusjon på mail og i NVDB-5258 opprettes flere saker. 

Brukere som inviterer andre inn på en kontrakt skal ha tilsvarende sensitiv rolle som det kreves for å se alle objekter og egenskaper i kontrakten, for å kunne invitere.

Se også relaterte saker. ",NVDB-6937,Datafangst,
Collection i skjema,"Nå er collections hardkodet. Vi tror at det vil være en fordel dersom full reindeksering oppretter nye collections.
Ved å putte dette i skjemaet vil APIet bytte til nye collection på samme måte som nå.

-----

*OBS*
For å ta i bruk dette må config endres før full indeksering, og den/de gamle collections må slettes manuelt når API-et har tatt i bruk den nye collection-en.

For å få ny collection for vegobjekter, legg til dette i /data/vegkart/config/nvdbind/nvdbind.properties:
solr.migrate.nvdb-roadobjects.collectionName=nvdb-roadobjects2",NVDB-6937,NVDB-IND,
stedfesting med datter innenfor mor fører til alt for lange stedfestinger,"h2. Observasjon

Via support
{quote}Heia
 Her er noen punkter som jeg sliter med å få på plass i Datafangst og NVDB.
 Kontrakten er her:
 [https://datafangst.kantega.no/#!/contract/b9606b08-29ec-404e-a140-fc757469b61a]
 # Jeg sliter med å få sammenkoblet belysningsstrekning til belysningspunkter. Får melding om: _*Belysningsstrekning ligger for langt unna en eller flere døtre.*_ Jeg har sjekket data i et annet program og koordinater i belysningspunkt er helt identiske mot knekkpunkter i belysningstrekning. {quote}
Denne kan gjenskapes lokalt.
 Sosi ligger vedlagt: stedfest og sammenkoble objektene. dette fører til en feilmelding.
h2. Analyse

Når vi evaluerer om datter er innenfor mor, sammenlikner vi geometrien til mor med geometrien til mor og datter.
 Geometrien til mor og datter finner vi ved å lage en ny geometri basert på kombinert range til mor og datter. I dette tilfellet er Range til mor identisk med Range til mor og datter kombinert. med andre ord er datter innendor mor. Men når vi genererer en ny geometri basert på range, så blir den nye geometerien litt annerledes enn geometrien til mors stedfesting. blandt annet fordi ny geometri kan inneholde høydedata, og fordi vegnettet kan ha endret seg.
h2.  Løsning

Når vi skal sammenligne gammel og ny geometri kan vi få en annen geometri fra LES, selv om range er den samme. Vi må derfor generere ny geometri A basert på gammel range, og geometri B basert på ny range. Da blir begge geometriene basert på samme og oppdatert data fra API LES. samme range vil da garantere lik lengde, og døtre vil bli riktig evaluert som innenfor mor. 

 ",NVDB-6937,Datafangst,
Feil feilmelding ved endring av ansvarlig på kontrakt,"Jeg har endret ansvarlig på en haug med kontrakter. Hvis jeg staver brukernavn på den som skal være ny ansvarlig feil, får jeg feilmelding om at jeg ikke har rettigheter til å endre kontrakten.

*Observasjon*

Hvis jeg oppdaterer ansvarlig på en kontrakt med et brukernavn som ikke finnes får jeg beskjed om
{noformat}
{""message"":[""Kan ikke sette maybehaa som ansvarlig for kontrakt, bruker har ikke tilgang til å redigere kontrakter""]}
{noformat}
[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.8-2020.04.23/doc/?id=A_xGp3EBO6kjk0-Y9svp]

Den samme meldingen kommer om jeg prøver å sette et brukernavn som eksisterer, men som ikke har riktig rolle.",NVDB-6937,Datafangst,
NVDBREF-623 Endre URL i info-boks - benytte vegkart-2019.atlas.vegvesen.no,"I infoboksen henviser vi til forrige versjon av vegkart og [https://www.vegvesen.no/nvdb/vegkart/v2]

Denne bør endres til vegkart-2019.atlas.vegvesen.no",NVDB-6937,Vegkart,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5339: Prøv testbeskrivelse i saken
 * NVDB-5343: Send et endringssett med og uten ""x-nvdb-dryrun-nolocking"" og ventetid. Sjekk antallet låser i kontrollpanelet.
 * NVDB-5238: Bruk gjerne en tilpasset versjon av vedlegg i saken
 * NVDB-5271: Test innsedning av vedlagte SOSI-filer mot Datafangst i ATM for å verifisere.

Saker i leveransen som ikke er nevnt over trenger ikke å testes eksplisitt i ATM.",NVDB-6937,Skriv-API,
Prosjektreferanse settes feilaktig på ikke-importerte objekter,"h2. Observasjon

Når man har et nytt objekt som man kobler inn under NVDB-mor, så vil ikke NVDB-mor ligge i kontrakten, men være med i endringssettet fordi NVDB-mor sin assosiasjon er oppdatert med det nye objektet. *MEN*, dersom man i registreringen velger å bruke kontraktens prosjektreferanse i innsendingen så vil også denne NVDB-moren få oppdatert sin egenskap ""Prosjektreferanse"" med kontraktens referanse.

Dette blir feil. Det er kun objektene i kontrakten (altså typen som velges for innsending) som skal få satt prosjektreferanse. Se f.ex endringssett
{noformat}
https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/af58b342-37b4-4a0e-b49e-0fc55e60a2f9
{noformat}
Her er det kun er Leskur (type 25) som er valgt for innsending. Men også mødrene blir oppdaterte med denne referansen.",NVDB-6937,Datafangst,
segmentlengde skal være basert veglenke.lengde,"Nå er segment.lengde basert på veglenke.geometri.lengde, endre til veglenke.lengde (godkjent lengde)",NVDB-6937,NVDB-IND,
Dok: Systemskisse til drift,"Tegne systemskisse for NVDB Rapporter og legge under:
[https://www.vegvesen.no/wiki/display/NVDBogGeodata/Systemdokumentasjon+NVDB+Rapporter] 

For inspirasjon, se på Vegkart:

[https://www.vegvesen.no/wiki/pages/viewpage.action?spaceKey=NVDBogGeodata&title=Systemdokumentasjon+Vegkart+GUI] ",NVDB-6825,Rapportgenerator,
NVDBREF-433 : Zooming i kartet,"Når jeg skriver inn og velger Fylke eller Kommune zoomes det inn til riktig sted.  Men når jeg skriver inn og velger f. eks. vegnummer, stedsnavn eller kontraktsområde zoomes det ikke inn.
Jeg ønsker meg at det zoomes inn i kartet for de valg jeg velger under ""Hvor"".",NVDB-6937,Vegkart,
NVDBREF-611 : Dokumentasjon - Last ned bilder og pdf,"Velger Fysisk inngrep i vannforekomst og fv860 s2.  Objekt 915510048 har tre datterobjekt, dokumentasjon.  I disse dokumentasjonsobjektene er det lastet inn bilder og pdf-dokument til NVDB, objekt id: 915510049, 915510050 og 1005594528.
Jeg ønsker å få sett på disse bildene og pdf-dokumentet, men det går ikke.  Jeg får tatt ut i NVDB123, men ikke i vegkart.
https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@603515,7677330,10/hva:~(~(id~783))/hvor:~(vegsystemreferanse~(~'FV860S2))/valgt:915510048:783",NVDB-6937,Vegkart,
NVDBREF-295 : Endre konfigurasjon av produksjonsmiljøet for NVDB,"* Øke fra 5 til 6 noder (VM’er)
 * Øke antall shards til 18, dvs kjøre 3 per VM
 * Øke RAM fra 16G til 64G
 * Beholde roterende disker",NVDB-6937,Les-API,
"NVDBREF-249 : Oppdatere informasjonsboksen i Vegkart ""Velkommen til Vegkart!""","Fjerne teksten ""Kommunikasjonen med bakenforliggende...""
Utkast til tekst som kan legges til: Vegkart er nå tilpasset nytt referansesystem, se informasjon om nytt referansesystem her: https://vegnett.no/2019/10/nytt-referansesystem-for-veg-tas-i-bruk/
Det er også mulig å benytte Vegkart som benytter gammelt referansesystem det finner du her: 
https://www.vegvesen.no/nvdb/vegkart/v2/#kartlag:geodata/@600000,7225000,3",NVDB-6937,Vegkart,
"NVDBREF-599 : Adskilte løp - Ramper markeres ""Med""","Jeg velger EV8 og zoomer inn til Breivika i Tromsø.  
Test-atlas: Ser at ramper markeres som ""Adskilte løp med"".  Adskilte løp finnes kun på hovedløpet på vegen der vi registrerer strekningsobjekter. Og det gjør vi jo ikke på ramper.
https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@654516,7735147,14/hvor:~(vegsystemreferanse~(~'EV8))/vegnett:~'geometri+~(adskiltelop~(~'med))
Det er riktig i prod:
https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@654515,7735088,14/hvor:~(vegsystemreferanse~(~'EV8))/vegnett:~'geometri+~(adskiltelop~(~'med))/vegsystemreferanse:653755.047:7735607.996
 ",NVDB-6937,Vegkart,
NVDBREF-575 : sosi eksport. feil i datofelt," 
 
Endredato 20191022082133  
Her der det litt for mange tall..
 
 
!image-2020-03-25-13-33-00-567.png!",NVDB-6937,Eksport,
Gjøre det mulig å markere feilmelding i GUI,"Brukere får ikke til å markere og kopiere feilmeldinger som dukker opp i grensesnittet i Datafangst. Dette er grunnet at klikk på feilmeldingen fjerner visningen av den.

Det vil likevel fortsatt være behov for å kunne ta bort feilmeldinger etterhvert som de dukker opp, så forslaget er å legge på et x-ikon som er klikkbart for å lukke meldingen. Klikk på selve teksten bør ikke fjerne feilmeldingen.

En x vil også gjøre det lettere å skjønne at man kan klikke for å få bort feilmeldingen. 

 ",NVDB-6937,Datafangst,
NVDBREF-618 Feil visning av ulykker i Vegkart,"Ulykkesmiljøet har importert ulykker til NVDB og ved søk etter ulykker i Vegkart v3  for kommunen Nore og Uvdal  er responsen at det finnes 1287 ulykker, men i kartet innenfor kommunens grense vises det langt færre enn 1287. 

Dersom vi legger på et filter >= 1/1-2012 så er responsen 331 ulykker, men ca 100 stykker vises innenfor kommunegrensen. I dette tilfellet vises resterende ulykker utenfor kommunens grenser.

Ved søk i vekart-2019 (v2) finnes også 1287 ulykker i Nore og Uvdal, noen vises innenfor kommunegrensen og noen utenfor selv uten at det er lagt på datofilter.",NVDB-6937,Vegkart,
Vise vegsystemreferanse for enkeltobjekter,"Simon Stølan via support og med hjelp fra Jan Kristian til å tolke: 

Ønsker at datafangst skal vise hvilken vegreferanse (gammelt system) objektet vil få før objektet er registrert i NVDB (både gammelt og nytt system hvis mulig).

Ønsker at datafangst skal vise den vegsystemreferansen objektet vil få før objektet er registrert i NVDB.

Jan sier at begge deler er selvsagt mulig, men Ingunn må svare på om det er gjennomførbart med de midlene vi har nå. 

Prinsippielt er det ingen presist vet veg(system)referansene før objektet er registrert i NVDB,  men når vi kjenner posisjonen (på vegnett eller koordinat) så kan vi selvsagt sjekke hvilken referanse som finnes akkurat der. Det er f.eks. fullt mulig å slå opp både gammel og ny veg(system)referanse i NVDB api V2 og V3 basert på start- og sluttpunkt for vegtilknytningen (ut fra geometri eller stedfesting på vegnett).  Men jeg kjenner datafangstløsningen for dårlig til å vite om det er en god løsning, om det er enkelt å implementere eller om det vil blir uhorvelig mye pirk fordi det ikke passer inn med resten av løsningen. 

Jan peker på støtteverktøy: Ellers har vi jo en del støtteverktøy for å oversette gamle lister til nye vegsystemreferanser. To kartklienter og et FME workspace med forklaring av logikken. 
•	https://www.vegdata.no/2019/12/20/kartlosning-nytt-vegreferansesystem/
•	https://www.vegdata.no/2019/09/24/kartlosning-vis-dagens-og-historisk-vegreferanse/
•	https://github.com/LtGlahn/fme_diverse/tree/master/konverter_vegreferanse

Simon says: Disse støtteverktøyene er sikkert gode, men tror ikke vi kan forvente at våre byggeledere/kontrollingeniører vil benytte disse. Det handler å å gjøre det så enkelt tilgjengelig som mulig slik det blir prioritert å gjennomføre det, tror jeg. Så hvis det er en mulighet å vist vegreferanse og vegsystemreferanse i Datafangst er det et stort pluss for disse brukerne.

Opprinnelig spørsmål: 
Ifbm oppdatering av etterslep for Vegoppmerking Tverrgående er det ønsket fra fagmiljøet visning av vegrefranse for enkeltobjekter. Dette for å kryssreferere mot gamle sidesystemer/lister.
",NVDB-6937,Datafangst,
Dupliserte assosiasjoner gir HTTP 500 ved registrering,"h2. Observasjon #1

Bruker (Raymond Hermansen, [https://datafangst.kantega.no/#!/contract/f9d684c7-1303-4603-afcb-c93cc7afae52]) melder om at man får systemfeil (HTTP 500 fra DF backend) ved registrering. Det som egentlig kommer er HTTP 400 fra API Skriv pga duplikate nvdb-id'er i samme assosiasjon. Det som skal ha vært utført er at objekter er importert fra NVDB, for deretter å endret på assosiasjonene.

Innsending av /endringssett: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.14/doc/?id=E8Xgd3EBxoPaAPabfHl]

Svar fra API Skriv: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.14/doc/?id=LsXgd3EBxoPaAPabfHl]
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>delvisOppdater.vegobjekter[3].assosiasjoner[0]: Må være unik: nvdbId</message><message>delvisOppdater.vegobjekter[0].assosiasjoner[0]: Må være unik: nvdbId</message><message>delvisOppdater.vegobjekter[4].assosiasjoner[0]: Må være unik: nvdbId</message></fault>
{noformat}
Ser fra assosiasjonstabellen at det ligger mange duplikate der (se vedlegget):
{noformat}
select * from feature_association2 where parent_feature_id in (select id from feature2 where project_id='f9d684c7-1303-4603-afcb-c93cc7afae52');
{noformat}
h2. Observasjon #2

Annen bruker (Simon Stølan, [https://datafangst.kantega.no/#!/contract/032017ce-62f6-4ce2-bea1-dc1a5b05785d]) melder om samme problem. Ser i kontrakten at også her er det eksisterende objekter, og utførte assosiasjoner.

Innsending av /endringssett: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.14/doc/?id=c8uCeXEBxoPaAPabhBqO]

Svar fra API Skriv: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-beats-6.8.8-2020.04.14/doc/?id=bcuCeXEBxoPaAPabhBqO]

h2. Analyse
Som Tor viser i kommentarene så får vi flere sammenkoblinger mellom sammen objekter ved Les API-import av både mor og datter. Dette må løses i NVDB-4843 sånn at det ikke er sånn framover.

h2. Løsning
Oppretter Flyway-script for å rydde i gamle duplikater. Endringer i NVDB-4843 skal sørge for at det ikke blir nye duplikater, så denne saken bør deployes samtidig som eller etter NVDB-4843.
 
For sikkerhets skyld kan det være lurt å ha en fersk backup av database før installasjon i prod.",NVDB-6937,Datafangst,
Vegkart SOSI-eksport tar for lang tid,"Det går ikke an å teste sosieksport fordi knappen er ""død"". Det fremgår kun som en tekst. Mulig dette handler om mine tilganger?

[https://www.utv.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@600000,6895453,3]

 

Jeg ser nå at jeg har vært for utålmodig - både på Edge og Chrome kommer med sosi-resultat etter ca 20 sek. (og det er jo såpass

lenge at man gir opp...) ",NVDB-6937,Eksport,
NVDBREF-610 : Dokumentasjon - Hyperlink virker ikke,"Velger Dokumentasjon og FV860 S2. Velger objektet på meter 7882 id 927786735.

Hyperlinken virker ikke.

[https://vegkart.test.atlas.vegvesen.no/#kartlag:geodata/@609344,7674171,8/hva:~(~(id~446))/hvor:~(vegsystemreferanse~(~'FV860S2))/valgt:927786735:446]

Tester det samme i vegkart-2019

[https://vegkart-2019.test.atlas.vegvesen.no/#kartlag:geodata/hva:(~(farge:'0_0,id:446))/hvor:(vegreferanse:(~'FV860))/@611433,7672251,9/vegobjekt:927786735:40a744:446]

og her virker linken og jeg kommer inn i saksdokumentet.",NVDB-6937,Vegkart,
Feil i hodet på sosifil,"I eksporten så blir ekstremalverdiene i sosifila feil. Og sosiversjon 5.0 tror eg er litt tidlig å bruke ennå.. dessuten tror jeg det er riktig å bruke 8.1 siden det er NVDB data
Slik filen er direkte fra vegkart så får man bla ikke transformert eller tegnet/vist den for eksempel i gisline. import til quadri og eksport til ny sosifil gir riktige ekstremalverdier

Eksport fra vegkart:
!image-2020-03-25-11-11-14-309.png|width=460,height=255!
 
Her er sosifil importert i quadribase (gisline) og eksportert ut til sosi. Ekstremalverdier er nå riktige.. 
!image-2020-03-25-11-11-53-512.png|width=422,height=252!",NVDB-6937,Eksport,
En del vegstrekninger og sideanlegg mangler strekning i vegref,"{color:#172b4d}En del vegstrekning mangler utstrekning i vegreferansen{color}
{color:#172b4d} Eksempler:{color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/3174486]
{color:#172b4d} ""kortform"": ""EV6""{color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/121759]
{color:#172b4d} ""referanse"": ""121759-3-1"",{color}
{color:#172b4d} ""kortform"": ""EV39""{color}
{color:#172b4d}  {color}
{color:#172b4d} Mange sideanlegg mangler strekning i vegreferansen{color}
{color:#172b4d} Eksempler:{color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/1728393]
{color:#172b4d} ""kortform"": ""EV6 SD1 m40-144""{color}
{color:#172b4d} osv.{color}
{color:#172b4d}  {color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/2246024]
{color:#172b4d} ""kortform"": ""EV18 SD1 m0-12""{color}
{color:#172b4d}  {color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/141495]
{color:#172b4d} ""kortform"": ""EV18 SD1 m107-111""{color}
{color:#172b4d} osv.{color}
{color:#172b4d}  {color}
 [https://www.test.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/2507018]
{color:#172b4d} ""kortform"": ""EV18 SD1 m115-152""{color}
{color:#172b4d} osv.{color}
{color:#172b4d}  {color}",NVDB-6937,Les-API,
NVDBREF-597 : Vegkart viser ikke alle objekter / feiler ved innhenting av vegobjekter,"Har oppdaget et problem i datafangst, med at jeg ikke kan sammenkoble objekter mot et spesifikt vegobjekt (tunelløp). Etter å ha sjekket i vegkart.no så var ikke objektet å finne der heller, så da sjekket jeg mot NVDB123 og forsikret meg at vegobjektet enda eksisterte. Det som er merkelig er at samme vegobjekt er å finne i v2 av vegkart. Jeg har linket til URL for v2 og v3 mot samme vegobjekt, slik at dere kan finne ut av dette. Jeg trenger tilgang til dette slik at jeg kan fullføre innlesing av datafangstprosjektet mitt.

[https://www.vegvesen.no/nvdb/vegkart/v2/#kartlag:geodata/hva:(~(farge:'0_1,id:67))/@-32118,6573055,14/vegobjekt:1004740896:40a744:67]

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-31923,6573235,13/hva:~(~(id~581))/valgt:1004740896:67]

OPPDATERING: Denne saken er ganske kritisk, siden dette påvirker hvert enkelt system som bruker v3. Jeg hørte fra noen som jobber i Plania, at antallet i summeringsrapportene deres gir feil utslag. I vegkart v2 er antallet rett. Dette var et eksempel på Vifte/ventiltor.

I BRUTUS så dukker feilmelding opp i kartvisningen: Det har oppstått en feil. Følgende feilmelding ble mottatt fra NVDB: 503.",NVDB-6937,Les-API,
Mangler valideringsfeil ved opplasting av enkeltstående vegobjekt,"h2. Observasjon
Last opp ett enkelt vegobjekt til en samling med ekstern API (dvs. POST til en feature collection). Legg inn en valideringsfeil av typen som valideres mot Skriv for data i vegobjektet, f.eks. ulovlig verdi for attributt. Denne feilen blir ikke gitt tilbake i respons.

h2. Analyse
Ved opplasting av enkeltobjekter gjøres validering synkront. Da er det kun feil fra ""file validation"" som gis tilbake, dvs. syntax for GeoJSON, versjon av datakatalog, osv. 
For å få ønsket resultat må også resultatet fra ""feature validation"" være med i retur.",NVDB-6937,Datafangst,
Posisjonsoppslag finner ikke vegobjekt,"Halvor Lund på Gitter:
{quote}
Da har vi byttet over til Atlas! Kan det hende at v3 mangler noen feltstrekninger (616-objekter)? Som eksempel har veglenke(sekvens) 0.38202973@2433139 feltstrekning i v2, men ikke i v3, men mistenker at det gjelder flere veglenke(sekvens)er:
NVDB v2: https://www.vegvesen.no/nvdb/api/v2/vegobjekter/616?inkluder=egenskaper&veglenke=0.38202973@2433139&antall=1000
NVDB v3: https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/616?inkluder=egenskaper&veglenkesekvens=0.38202973@2433139&antall=1000
{quote}
",NVDB-6937,Les-API,
Avvise import av vegobjekter med geometrifeil,"h2. Observasjon
Det er en del type geometrifeil som bruker ikke kan rette selv på en fornuftig måte. Noen (målemetode og nøyaktighet) er synlige i Datafangst, men er ikke redigerbare. Andre (som høyde) kan heller ikke vises direkte. Det er også lite hensiktsmessig at dataforvalter skal rette en del av disse feilene. Når det er feil med geometrien er det vanskelig å vite nøyaktig hvordan det skulle ha vært.

Det er tidligere opprettet egne saker for noen slike feil, se NVDB-5273 for feil med høydekoordinater, NVDB-5274 for feil med irregulær geometri, og NVDB-5369 for ugyldig målemetode.

h2. Analyse
Bruker har ikke muligheten til å rette opp denne typen feil i Datafangst i dag. Når det er feil med geometri virker det også mer hensiktsmessig at denne feilen blir meldt tilbake til entreprenør, sånn at hen kan sende inn riktige data.

Datafangst burde avvise vegobjekter med geometrifeil på import, på samme måte som geometriparametre utenfor tillatt område i schema blir avist i NVDB-5356.

h2. Forslag til løsning
I dag så kjøres det en validering mot Skriv ved import. Denne bør endres slik at gitte koder gjør at en feil merkes som ""belongsToRejectedFeature"" (på Location under feilen), da vil vegobjektet automatisk bli avvist etter at endringer i NVDB-5356 er merget inn.

Koder som må hånteres er:
* IRREGULÆR_GEOMETRI (NVDB-5274)
* UGYLDIG_KVALITETSPARAMETER (NVDB-5369)
* HØYDE_UTENFOR_GYLDIGHETSOMRÅDE (NVDB-5273)

Eventuelt også GEOMETRI_MED_INKONSEKVENT_HØYDE, er litt usikker på om vi klarer å få til denne i Datafangst. De kommer når noen koordinater har høyde satt i en geometri, og andre ikke. Kan testes ved å fjerne en høyde fra en fil som ellers har det, og se hvor langt den kommer.

Se DefaultFeatureListValidator.validateNvdb for et egnet sted å koble på sjekk av kode.

h2. Test
Se sakene med enkeltfeil som er lenket i denne saken for å finne testcase.",NVDB-6937,Datafangst,
Innsending med prosjektreferanse bør oppdatere objektene i datafanen,"Basert på sak NVDB-5323.

Hvis man har satt en verdi for prosjektreferanse på enkeltobjektene i datafanen, men registrerer med kontraktens prosjektreferanse, så vil enkeltobjektene ligge som synkroniserte i datafanen - *men* med en prosjektreferanse som ikke stemmer med hva som er lagret i NVDB.

Her ville det naturlige være å oppdatere disse objektenes prosjektreferanseegenskap med den som er lagret på objektet. Det samme gjelder objekter som ikke har satt prosjektreferanseegenskapen i datafanen.

Usikker på om dette vil skape krøll for de som bruker referansen aktivt. Evt kan vi høre med Jan Vidar Strømsvold, som under demo brukte prosjektreferansen aktivt.",NVDB-6937,Datafangst,
filter `relasjon` in `vegobjekter?egenskap` is failing,https://github.com/nvdb-vegdata/nvdb-api-client/issues/60,NVDB-6937,Les-API,
Bedre gruppering av logglinjer fra ett request,"Logging i Datafangst bruker i dag feltet ""requestNo"" i logg for å gruppere alle linjer i ett request. Dette er bare et løpenummer, som gjør det vanskelig å søke på. I tillegg så er ikke navnet tydelig på hva det er, og gjør at flere ikke vet om det.

Som et minimum så burde feltet endre navn, og nummer kodes som en fast streng i BASE36 (""00000A01C2"") sånn at det er enklere å søke opp uten å spesifisere feltet direkte.

I tillegg så kan det gjøres flere forbedringer rundt dette (muligens som egne saker):
 * Ta inn generert request-ID fra klient og kombinere med intern request-ID (logges som ""frontend07-00000A01C2"")
 * Lage en request-ID på frontend før hver kall og sende den med for logging

Disse siste to punktene er registrert som NVDB-5623",NVDB-6937,Datafangst,
Grafbare responstider i Datafangst,"Datafangst logger responstid per kall i dag (i AccessLogFilter), men gjør det på en måte som er vanskelig å lese og å grafe.

Vi har tidvis klager om at Datafangst er treigt, såd et hadde vært veldig nyttig å grafe responstider over tid. Det skal veldig lite til for å omstrukturere denne logginga for å gjøre det enkelt å grafe. Responstid må logges som et eget felt, og gjerne også responskode.

Tekst som logges bør også endres til å være mindre krypisk.",NVDB-6937,Datafangst,
Gjøre eksternAPI-dokumentasjonen lettere å lese,"[https://apiskriv.vegdata.no/datafangst.html]

Gjøre API-dokumentasjonen lettere å lese:
 * Alle endepunkt med
 * Dataobjekt beskrevet
 * Evt gruppere på type
 * Bedre visning 

Repo: [https://github.com/nvdb-vegdata/apiskrivdokumentasjon]",NVDB-6937,Datafangst,
Paus NVDBIND dersom Solr ikke er OK,"Paus alle operasjoner mot Solr dersom en eller flere av Solr-helsesjekkene feiler. 
Pausing kan også gjøres fra Forvaltning.

Testes ved å se i logg at progresjon stopper.",NVDB-6937,NVDB-IND,
Bruk soft commit,Se om vi kan bruke soft commit mer i nvdbind,NVDB-6937,NVDB-IND,
En spørring per område,"Når man velger flere områder lager Vegkart en spørring med alle områdene i en egenskapspørring.
Endre til å gjøre en spørring per område",NVDB-6937,Vegkart,
Konverteringsfeil på posisjoner med lesing fra ekstern API,"h2. Observasjon
Sigmund Fredriksen rapporterer på datafangst-support 27. mars om at de mener at de ser en forskjell på posisjon i WGS84 på hva de sender inn med ekstern API, og hva de leser tilbake.

""Som tidligere nevnt jobber vi nå med å skrive oss bort fra internAPI’et i Datafangst.

Vi ser at dere nå i kartet i Datafangst konverterer korrekt fra UTM33 til WGS84. Vi har også dataene korrekt i vår gamle klient (da konverterer vi selv fra UTM33 til WGS84). Men i vår nye klient er den lille forskyvingen tilbake. Her mottar vi dataene i WGS84 fra Datafangst.

Kan dere sjekke om dere fortsatt konverterer litt unøyaktig i dataene som leveres ut via GeoJSON på endepunktet SINUS entreprenør mottar dataene?

Antenne i Vardø i SINUS entreprenør med WGS84 koordinater konvertert i datafangst. Antenne ligger på «prikken» både i gamle SINUS entreprenør og i Datafangst-kartet.""

h2. Analyse
Jeg har ikke test-data fra Triona, men tester med et vilkårlig punkt i Vardø sentrum, 31.107466° øst, 70.370236° nord. 

Hvis jeg konverterer dette til UTM 33 og tilbake til WGS 84 igjen med JTS, så blir det er avvik som kan samsvare med det Triona ser. Jeg har også prøvd med [Proj4J|https://github.com/locationtech/proj4j], som gir et veldig likt resultat. Konverteringa som Triona gjør fra UTM 33 gjøres i JavaScript med [Proj4JS|https://github.com/proj4js/proj4js]. Har også kjørt en test med konvertering fram og tilbake der, og da ender jeg opp med posisjonen som ble putta inn, så den er i alle fall symetrisk.


||          || JTS                                                                           || Proj4J (java)                                                         || Proj4JS (JavaScript)                                              ||
| UTM 33 | 1097734.0253844042E, 7886942.538062702N | 1097734.0257150712E, 7886942.536846994N | 1097734.0328950887E, 7886942.538235272N |
| WGS 84 | 31.107395949840612E, 70.37023701197327    | 31.107395949840626E, 70.37023697572975N | 31.107466000000006E, 70.370236N                  |

Når JTS kjøres med assertions (default i IDEA) så får jeg denne meldinga: 
bq. The transform result may be 2.622 meters away from the expected position. Are you sure that the input coordinates are inside this map projection area of validity? The point is located 16°06.4'E away from the central meridian and 70°22.2'N away from the latitude of origin. The projection is ""Transverse_Mercator"".
Forventet avvik der stemmer i alle fall ganske godt med resultatet.
",NVDB-6937,Datafangst,
NVDBREF - 600 (B) Feil i metrering av kryssdeler,"Håvard har meldt feil på kryssdeler. Har sjekket originaldataene for disse eksemplene, og kryssdelene ser helt riktige ut når jeg henter dem ut i NP. Så her spørs det om LES ikke håndterer dette riktig. Bør sjekkes om tilsvarende problem gjelder sideanleggsdeler.

*Rampefeil:*

Det viser seg også å være mange metreringsfeil på ramper.  En gjenganger ser ut til å være at rampeløpet starter på et høyt metertall (burde vært 0) og stiger for deretter å sprette tilbake til 0 og så stige igjen.

 

Eksempel 1:

WARN  Segment1.MeterBreak;3001;2572844-3-6;0,69121467;1;2793371;2572840;0;;E;V;6;S1D1 M4229;K;1001;4;654;668;K;;;;3;1;;286644;6560321;28;286635;6560332;28

WARN  Segment2.MeterBreak;3001;971313-2-11;0,00713499;0,14238919;2572840;3087634;0;;E;V;6;S1D1 M4229;K;1001;4;0;88;K;;;;3;1;;286635;6560332;28;286565;6560380;28

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@286575,6560318,16/hvor:~(vegsystemreferanse~(~'EV6S1D1))/vegnett:~'geometri+~()/valgt:2572844:3:6]

 

Eksempel 2:

WARN  Segment1.MeterBreak;3003;971315-1-10;0;0,03556154;990196;1717232;0;C;E;V;6;S2D1 M4241;K;1002;4;342;346;K;;;;3;;;283119;6566219;20;283120;6566223;20

WARN  Segment2.MeterBreak;3003;1717245-1-8;0;0,71273572;1717232;3091737;0;;E;V;6;S2D1 M4241;K;1002;4;0;243;K;;;;3;1;;283120;6566223;20;283267;6566085;20

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@283258,6566203,15/hvor:~(vegsystemreferanse~(~'EV6S2D1))/vegnett:~'geometri+~()/valgt:971315:1:10]

 

Andre rampeproblemer:

Eksempel 3: Sør for Ryenkrysset. Komplisert rampesystem: Skjønner ikke helt hva som er problemet her

WARN  Segment1.MeterGap 49,000m;301;2516106-2-6;0,35819621;1;2516103;2516104;0;;E;V;6;S16D1 M545;K;1028;2;41;114;K;;;;3;1;;265435;6646451;134;265393;6646508;132

WARN  Segment2.MeterGap 49,000m;301;625635-12-6;0,19867722;0,46165134;2516104;640323;0;;E;V;6;S16D1 M545;K;1028;2;163;365;K;;;;3;1#3K;;265393;6646508;132;265338;6646702;130

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@265487,6646387,15/hvor:~(vegsystemreferanse~(~'EV6S16D1))/vegnett:~'geometri+~()/valgt:2516106:2:6/vegsystemreferanse:265482.78:6646950.581]

 

Eksempel 4:

Ryenkrysset: Skjønner ikke konstruksjonen her!

WARN  Segment1.MeterDirectionProblem?;301;2704126-1-6;1;0;2703939;2703938;0;;E;V;6;S16D1 M1209;K;1029;5;42;61;K;;;;2;1;MOT;265439;6647182;129;265437;6647200;130

WARN  Segment2.MeterDirectionProblem?;301;2373738-4-8;0,73567446;0,91670658;2703938;3066632;0;;E;V;6;S16D1 M1209;K;1029;5;42;72;K;;;;3;1;;265437;6647200;130;265430;6647208;129

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@265433,6647068,15/hvor:~(vegsystemreferanse~(~'EV6S16D1))/vegnett:~'geometri+~()/valgt:2704126:1:6]

 

Eksempel 5: Åpenbar metreringsfeil men skjønner ikke hva som er årsaken: En veldig kort lenke med mange meter (fra 0 til 285), deretter en lang lenke med få meter (fra 0 til 35) - atpåtil på samme veglenke.

WARN  Segment1.MeterDirectionProblem?;4204;121315-1-9;0;0,04750256;140647;2946519;0;C;E;V;18;S4D1 M265;K;1006;2;0;285;K;;;;3;;;94920;6468350;16;94916;6468353;16

WARN  Segment2.MeterDirectionProblem?;4204;121315-2-9;0,04750256;0,38372629;2946519;140638;0;;E;V;18;S4D1 M265;K;1006;2;0;35;K;;;;3;1;;94916;6468353;16;94905;6468384;15

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:topo4/@94918,6468336,17/hvor:~(vegsystemreferanse~(~'EV18S4D1))/vegnett:~'geometri+~()/valgt:121315:1:9/vegsystemreferanse:95211.199:6469009.446]

 

Eksempel 6: Rampeløpet er metrert i feil retning?

WARN  Segment1.MeterDirectionProblem?;4202;21738-13-12;0,31928508;0,48617094;3096409;27110;0;;E;V;18;S10D1 M160;K;1017;3;0;185;K;;;;3;1;;123769;6484776;33;123692;6484783;35

WARN  Segment2.MeterDirectionProblem?;4202;21738-4-11;0,48617094;0,61975806;27110;1706661;0;;E;V;18;S10D1 M160;K;1017;3;0;65;K;;;;2;1#2;;123692;6484783;35;123637;6484774;33

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@123832,6484737,16/hvor:~(vegsystemreferanse~(~'EV18S10D1))/vegnett:~'geometri+~()/valgt:21738:12:10]

 

*Løsning*

Finner ikke noe mer feil enn det som er rettet i NVDB-5200. I tillegg er det endel ""datafeil"" ved at rekkefølgen på stedfestinger til kryssdeler er feil, slik at meter 0 starter midt inne i kryssdelen osv. Gjennomgang av alle eksempler her:
 * Eksempel 1 og 2: Ser rett ut fra dataene som ligger der, men det kan se ut som det er en ""datafeil"". Om stedfestingene til kryssdelen hadde byttet plass, ville meter 0 startet ut fra rundkjøringen. Rekkefølgen på stedfestingene for kryssdel er avgjørende for meterberegningen, starter med meter 0 på starten på første stedfesting.
 * Eksempel 3: Her er det 3 stedfestinger på kryssdelen. Det ser ut som den første og andre må bytte plass for å få meter 0 i starten av kryssdelen. Nå starter meter 0 litt inni, noe likt eksempel 1 og 2. Forsatt ser det riktig ut gitt de dataene som er der.
 * Eksempel 4: Litt vanskelig å knekke denne, KD5 består av en slags liggende T, der ene utløpet har metreringsretning MOT. Her er det en feil med meterberegning, men den ser ut til å ha blitt rettet i NVDB-5200. Vedlagt bilde på hvordan metrering går.
 * Eksempel 5: Retting i NVDB-5200 ser ut til å forbedre der det mangler start/sluttmeter (altså den som har 0-285). I tillegg er det likt eksempel 1, at rekkefølgen på stedfestinger til kryssdel burde endres litt for at det skal bli riktig (meter 0 ut fra rundkjøringen)
 * Eksempel 6: Første og andre stedfesting til kryssdelen (kryssdel 3) må bytte plass. I tillegg har feilen som gav 0-185m på den ene lenken blitt rettet i NVDB-5200.

 Det er altså ingen kodeendringer i denne saken, men tester den igjen etter NVDB-5200 er klar.

 ",NVDB-6937,Les-API,
Avviser følgeoppdatering av ikke-versjonerbart vegobjekt som lukkes i endringssettet,"h2. Observasjon

Endringssettet https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/0589bee7-0a8f-488c-8ab7-8d39dc67b713 avvises fordi det ikke kan lages følgeoppdatering (ny versjon med redusert stedfesting) på vegobjekt av type som ikke tillater versjonering.

h2. Analyse

I endringssettet lukkes strekningen 0.497689207642542-1.0 på lenkesekvens 3198119 på dato 2020-03-25. Under behandling finner filteret AdaptFeaturesToClosedNetworkEnricherFilter ut at følgende fire vegobjekter som alle har stedfesting 0.0-1.0@3198119, dvs. er delvis stedfestet på det lukkede vegnettet:

1) Serviceveg (924), id 1006280902:1
2) Vegmyndighet kan bli endret (922), id 1006280900:1
3) Beredskapsveg (923), id 1006280901:1
4) GSV langs annen vegkategori (949), id 1006280899:1

Samtlige vegobjekter har startdato 2020-03-01, som er før lukkedato for vegnettet. Dermed forsøker det nevnte filteret å versjonere de fire vegobjektene med startdato 2020-03-25 på versjon 2. Før jobben berikes med denne følgeoppdateringen kontrolleres at vegobjekttypen tillater versjonering. I dette tilfelle gjør ingen av de fire vegobjekttypene det, og det registreres en følgeoppdateringsfeil pga. dette. At de fire vegobjektene blir lukket i endringssettet på samme dato som vegnettet lukkes, tas ikke hensyn til før litt senere i filteret.

h2. Løsning

Flytter kontrollen på versjonerbarhet til etter berikingen er godkjent for jobben og nye versjoner skal til å bli innlemmet i jobben.",NVDB-6937,Skriv-API,
Catch-all-route i veglister,Håndtere dynamiske ruter i vegliste-applikasjonen slik at for eksemel */arbeid* kan deles som en lenke,,Rapportgenerator,
Stedfesting 2: Blå ramme rundt checkbox på Firefox,"På Firefox kommer det en blå ramme rundt checkboxer på visningsvalg.

Litt feilsøking viser at disse er knyttet til CSS for outline på klasse placeholder-checkbox, dvs. hvis man fjerner denne definisjonen i inspector så blir ramme borte.",NVDB-6937,Datafangst,
NVDBREF-576: (A) Alle objekter mangler segmenter,"Url=https://www.vegvesen.no/nvdb/api/v3/vegobjekter/538?inkluder=egenskaper,vegsegmenter,metadata
Dette har fungert tidligere men gir nå fullstendig manglende stedfesting for absolutt alle objekter. Kun egenskaper og metadata kommer ut mens stedfestingen returneres som ""vegsegmenter"": []
Problemet startet i natt og er vedvarende i dag. 
Det ser imidlertid ut som relativt begrensede datamengder inneholder vegsegmenter.",NVDB-6937,Les-API,
Ønske om å oppgi posisjon for å få ut det aktuelle segmentet for posisjonen,"Mottatt fra Tor K Moseng:

Et ønske fra gitter er å kunne hente ut et vegsegment for en gitt posisjon på en veglenkesekvens. F.ex [https://www.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser/segmentert/2726198] gir ut alle for 2726198, mens brukeren ønsket å kunne gi inn posisjon for å få ut kun det aktuelle segmentet for denne posisjonen.",NVDB-6937,Les-API,
Analyser datafeil 2,"*Gjøres først i mai/juni.*

Oppgaven går på å gjøre samme oppgave som i NVDB-5034 med fokus på fra og med april da flere av feilene som ble oppdaget er fikset. Se om det har kommet til noen flere/andre.

I nvdb-skrive-api prosjektet ligger det et skript man kan kjøre (nvdb-skrive-api/performance-test/src/test/python/rejectReasonsInProd). Eksempel:
{noformat}
** Example 1 **
Find reject reasons for all clients Des 2019 - Feb 2020
$ python3 getChangesets.py --user exttxm --fTime 1575154800000 --tTime 1583017200000

** Example 2 **
Find reject reasons for Datafangst Des 2019 - Feb 2020 and changeset ids for errors that Datafangst should handle (found through Example 1)
$ python3 getChangesets.py --user exttxm --fTime 1575154800000 --tTime 1583017200000 --client Datafangst --errorCodes UGYLDIG_KVALITETSPARAMETER,UGYLDIG_FLERVERDI,IRREGULÆR_GEOMETRI,HØYDE_UTENFOR_GYLDIGHETSOMRÅDE,STØRRE_ENN_ABSOLUTT_MAKSIMUM,MANGLER_OBLIGATORISKE_EGENSKAPER,EGENSKAPEN_FINNES_IKKE,FLERE_ENN_MAKSIMUM_ANTALL,OVERSKRIDER_FELTLENGDE{noformat}
Se på NVDB-5034 og de identifiserte feilene for å se om ting er bedre.",NVDB-6937,Datafangst,
NVDBREF-597: Vegkart viser ikke alle objekter/feiler ved innhenting av vegobjekter,"Har oppdaget et problem i datafangst, med at jeg ikke kan sammenkoble objekter mot et spesifikt vegobjekt (tunelløp). Etter å ha sjekket i vegkart.no så var ikke objektet å finne der heller, så da sjekket jeg mot NVDB123 og forsikret meg at vegobjektet enda eksisterte. Det som er merkelig er at samme vegobjekt er å finne i v2 av vegkart. Jeg har linket til URL for v2 og v3 mot samme vegobjekt, slik at dere kan finne ut av dette. Jeg trenger tilgang til dette slik at jeg kan fullføre innlesing av datafangstprosjektet mitt.

[https://www.vegvesen.no/nvdb/vegkart/v2/#kartlag:geodata/hva:(~(farge:'0_1,id:67))/@-32118,6573055,14/vegobjekt:1004740896:40a744:67]

[https://vegkart.atlas.vegvesen.no/#kartlag:geodata/@-31923,6573235,13/hva:~(~(id~581))/valgt:1004740896:67]",NVDB-6937,Les-API,
Ugyldig målemetode blir innsendt til Skriv,"h2. Observasjon

Datafangst tar ikke hensyn til valideringsfeil fra Skriv ved opplasting. Se relaterte saker det er lenket til. Her er det ugyldig høydemetode som Skriv sier i fra om, Datafangst gir beskjed i filfanen, men laster inn objektene. En bruker som ikke er oppmerksom i filfanen (og hvorfro skal hen det når objektene blir importert) får først beskjed om dette ved registrering til API Skriv.

Eksempel endringssett: [https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/2509943f-f16d-4c83-b00b-ca22e0f2267f]

Endringssettet kommer fra kontrakt: [https://datafangst.kantega.no/#!/contract/ddd092b6-863e-499f-8cfd-c160465257c3/files]

Bruk gjerne vedlagte SOSI for å gjenskape.",NVDB-6937,Datafangst,
Endrede assosiasjoner oppdateres ikke i databasen etter registrering,"h2. Observasjon

Kommer fra testing av NVDB-5348. Viste seg at feilen eksisterte før denne saken. Observasjonene ligger i kommentarer på denne saken, men er gjengitt her.

Tar inn en NVDB-skiltplate, kobler denne til ny NVDB-mor. Da vil sammenkoblingsfanen vise at skiltplata er koblet til to mødre. Fjerner da manuelt den gamle koblinga. Registrerer. Så tar jeg inn en helt ny skiltplate og kobler til ny NVDB-mor. Endringssettet ser riktig ut for akkurat denne koblinga, *men* forrige re-assosiasjon kommer også med på denne registreringen. Dvs at allerede utført re-assosiasjon kommer med på ny registrering s.a. denne feiler med versjonskrøll da Datafangst vil oppdatere versjon 1 som nå er blitt til versjon 2 pga forrige registrering. Ny registrering bør ikke ta med endringer som allerede er utført.

Feil som kastes i eskportfanen: _1006280773: Versjon oppgitt for oppdatering er ikke siste versjon. Siste versjon er 4_

Databasen ser slik ut ved de ulike stegene
{noformat}
Initielt
99a8ae06-9f0a-4bed-8a19-0f72e534bac3 1006280030 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 READ 
Koblet til ny mor (derfor vises det dobbelt i UI)
99a8ae06-9f0a-4bed-8a19-0f72e534bac3 1006280030 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 READ
dd0a5d27-ebdc-45e5-a74a-15fe370655ac 1006280773 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 WRITE 
Koblet fra gammel mor (manuelt i UI)
3f085af4-1629-45fd-b2c7-dca479ab2814 1006280773 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 WRITE
99a8ae06-9f0a-4bed-8a19-0f72e534bac3 1006280030 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 DELETE
Etter registrering
3f085af4-1629-45fd-b2c7-dca479ab2814 1006280773 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 WRITE
99a8ae06-9f0a-4bed-8a19-0f72e534bac3 1006280030 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 DELETE 
Lagt inn ny skiltplate
aaf6640b-f392-4212-8cab-71cd12dd21cf 1006280908 52073785-7f8f-4746-9607-6e70e6d8651e WRITE
3f085af4-1629-45fd-b2c7-dca479ab2814 1006280773 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 WRITE
99a8ae06-9f0a-4bed-8a19-0f72e534bac3 1006280030 fd3e6e54-1976-4f96-b94e-cb7e30e31b03 DELETE
{noformat}
Basert på databaseinfo så oppdaterer ikke Datafangst assosiasjonene til READ etter registrering.",NVDB-6937,Datafangst,
Ruteberegning:  Returnerte segmenter henger ikke sammen," 

Avhenger av at sak NVDB-5259 er behandlet.    De rutene som beregnes over avstander feiler fort uten NVB-5259!

 

Ruteberegning får noen strekker med feil geometri som vist på feil_geometri.png (ut av og sør for Lillehammer).  Geometrien er klippet feil vei og går fra hverandre og ikke mot.   Her skulle jo den blå streken gått fra start til slutt, og ikke slik den er på bildet hvor det går fra hverandre..

Parametre som ble brukt var disse:
 start=256051.91275786122,6783157.609644701
 &slutt=255761.9136374836,6779041.962313057
 &maks_avstand=100
 &omkrets=100

Lenke: 
 [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?start=256051.91275786122,6783157.609644701&slutt=255761.9136374836,6779041.962313057&maks_avstand=100&omkrets=1000&konnekteringslenker=true&detaljerte_lenker=true&pretty=true&kortform=true]

 

 

Jeg fikk også feil på denne feil_geometri.png (Vestby):     
  [https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?start=259500.4664128776,6614944.128838652&slutt=259544.12486595605,6614376.287577341&maks_avstand=100&omkrets=100&konnekteringslenker=true&detaljerte_lenker=true&pretty=true&kortform=true]

 
h2.  TODO
 * Koblingen mellom lenker er noder. I dag er denne koblingen kun på nodeid.
 Endre koblingen i klassen Vertex til  å gjelde:
 ** part
 ** segment 
 ** nodeid

 Og derav fikse feilaktige segmenter returnert.",NVDB-6937,Les-API,
Sårbarheter i JavaScript-avhengigheter,"NPM rapporterer om 38316(!) sårbarheter. Heldigvis er nok noen av dem telt flere ganger.

Kun i byggesystem og test, men greit å ordne sånn at det ikke maskerer sårbarheter i biblioteker som brukes av kode.",NVDB-6937,Datafangst,
NVDBREF-618 filtrering av trafikkulykke på ulykkesdato og område gir snåle resultatsett.,"{quote}Heisann, filtrering av trafikkulykke på ulykkesdato og område (kommune=3052 Nore og Uvda) gir snåle resultatsett. [https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/570?segmentering=true&kartutsnitt=64013.815,6561187.485,302687.692,6808292.777&egenskap=(area(946,3052))+AND+(5055]>='2011-01-01')
 Filtering kun på område kommune=3052 Nore og Uvdal gir ønsket resultat. Her er lenke til vegkart-søk som demonstrerer problemet tydelig: vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@158050,6713655,5/hva:~(~(filter~(~(operator~'3e3d~type_id~5055~verdi~(~'2011-01-01)))~id~570))/hvor:~(kommune~(~3052))
{quote}
Spørring etter ulykker i Vegkart v2 gir heller ikke ut  korrekt svar ved spørring innenfor en kommune.

 

Har dette sammenheng med at mange av ulykkene er stedfestet på fiktiv veg?

 

Det er heller ikke samsvar mellom antallet i søkeresultatet og hva som kommer ut på CSV-eksport. Oppdal kommune og trafikkulykke gir et søkeresultat på 605, mens csv-eksporten gir 632 ulykker.",NVDB-6937,Les-API,
Mulighet til å velge flere kjørefelt,"Skriv vil ha inn en liste med kjørefelt.

Skriv om kjørefelt-editoren til en modal med checkboxer

kjørefeltvisningen må kunne vise flere kjørefelt på en god måte

 ",NVDB-6937,Datafangst,
API: Helsesjekk utvides med mer info om NVDB-status,"Helsesjekk tar med metadata om egen og Les-API's status.
Ref. for eksempel [https://nvdbrapportapi.utv.atlas.vegvesen.no/health]).

Denne utvides med oppdateringstidspunkt for NVDB. Dette er interessant når man gjør endringer i NVDB og ønsker å ta ut rapport når det er tilgjengelig fra Les API.

Ref. [https://nvdbapiles-v3.atlas.vegvesen.no/status]

Info fra Helsesjekk er kanskje også aktuelt å vise i GUI med en egen link/knapp, eller fortløpende polling? Nyttig for Vegliste-gruppa å få denne informasjonen i rapport-verktøyet (front-end).",NVDB-6825,Rapportgenerator,
entertast fører til error hvis ingen elementer har fokus,"h2. Observasjon

fra sentry: [https://sentry.kantega.org/kantega/datafangst/issues/10]

trykk på enter hvis ingen elementer har fokus fører til feilmeldinger i konsoll
h2. Analyse

Noen ganger har vi ikke fokus, f.eks hvis bruker har søkt etter noe som ikke finnes.

gjenskapes ved å søke etter noe som ikke gir resultat, og deretter trykker enter.

metoden som håndterer entertrykk må returnere hvis den ikke klarer å finne fokus-cellen.

 

 ",NVDB-6937,Datafangst,
"Datafanen: ""undefined error"" i focusedattribute selector","h2. Observasjon

fra Sentry: [https://sentry.kantega.org/kantega/datafangst/issues/17]

FocusedAttribute selectoren kræsjer hvis vi ingen vegobjekter har fokus.
h2. Analyse

Legg inn sjekk for undefined focused feature og returner null.",NVDB-6937,Datafangst,
Validering av grenseverdier fra Skriv XML-schema ved import av data,"h2. Analyse
Skriv har to typer validering. Den ene er den som kommer i en vanlig respons med feil / advarsel / notabene per vegobjekt og HTTP-respons 200. Den andre er validering av XML-schema, som gir HTTP-respons 400 tilbake. 

På validering av XML-schema så får vi feilmeldinger som er vanskelige å bruke direkte (se NVDB-5321 for et eksempel), så de ender opp med en generisk feil i stedet. (I skrivende stund også en systemfeil, helt til NVDB-5321 er håndtert.)

Å mappe de feilene vi får fra XML-schema tilbake til noe som kan forstås av bruker er ikke nødvendigvis enkelt. [Tore sier|https://mattermost.kantega.no/svv/pl/58kthfxf8fyumcagwqa9p7edea] ""når jeg snakker med klientutviklere til API Skriv, fraråder jeg å behandle payloaden fra 400-responser på annen måte enn å logge den og gi en generell systemfeil-melding til brukeren. 400-responsen har en temmelig åpen kontrakt, som i praksis sier at den består av en liste med strenger, uten noen garantert formattering eller syntaks. Meldingene kan endre ordlyd over natta.""


h2. Forslag til løsning

Tores [forslag til løsning|https://mattermost.kantega.no/svv/pl/dy1sh9i3rtncbe6pkhnxysib1a] er at Datafangst går over alle [constraint-annotasjonene|https://javaee.github.io/javaee-spec/javadocs/javax/validation/constraints/package-summary.html] (@Min / @Max o.l) i de [relevante dataklassene|https://github.com/nvdb-vegdata/nvdb-skrive-api/tree/master/plugins/representation/src/main/java/no/vegvesen/vt/nvdb/apiskriv/representation/model/domain/changeset/v3] i Skriv, og lager valideringsregler i Datafangst basert på dem.

Vi bør i hovedsak avvise data som bryter med disse valideringsreglene, da f.eks. en målemetode for høyde oppgitt uten for lovlig intervall ikke enkelt kan rettes av bruker. Vi kan se etter hvert om det er enkelte feil som kan tillate import, men gi feil på objektet i stedet. Merk at data som har schema-feil ikke kan sendes inn til Skriv for validering før alle verdier er innenfor lovlig verdi for schema.

Vi bør samle opp alle feil for hvert datasett og presentere dem samlet til bruker, med referanse til fil / linje eller objekt-ID for hver feil.

Se NVDB-5357 for relatert problemstilling, implementasjonen her bør kunne gjenbrukes til sjekk også i andre sammenhenger.",NVDB-6937,Datafangst,
Cluster forsvinner på lavt nivå,"h2. Observasjon

Last inn vedlagte SOSI og vis eksisterende objekter i datafanen. Velg Norkart. Da sees cluster, f.ex 11 i et cluster. Zoom inn et hakk (evt flere), men fra et nivå til neste så mister man cluster, og bare et enkeltstående NVDB-objekt står igjen i stedet for cluster. Se vedlagt bilder for zoom på nivå n og n+1.",NVDB-6937,Datafangst,
Ruteberegning:  Gir punkt sammen med linjegeometri,"Ruteberegning via geometri beregner rute fra punkt til punkt. Dersom noen punkter er veldig nærme, så nærme at strekningslengden blir 0, så blir det altså et punkt.   Neste strekning starter da i samme punktet, men har en utstrekning og blir til en linje.    Når ruteberegningen kjører , så slår den sammen segmenter som overlapper, men det ser ut til at noen punkter ikke blir slått sammen med neste strekning.    

 

Man kan fint gjenskape dette ved å kjøre en geometri som har samme punktet flere ganger i geometrien.

 

 

 

Denne geomtrien gir ut et punkt sammen med mange linjer.   Akkurat denne geometrien lar seg ikke teste mot en server som indekserer Trionadatabasen NVDB01. Den mangler vegsystemer og får ikke dette punktet med i resultatet:

 
 <type>Punkt</type>
 <veglenkesekvensid>42330</veglenkesekvensid>
 <relativPosisjon>0.0</relativPosisjon>
 <kortform>0.0@42330</kortform>
  

 

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING%20Z(270203.15%207041918.45%209.11,%20270203.12%207041921.1%209.03,%20270202.94%207041928.89%208.85,%20270202.66%207041928.89%208.86,%20270202.44%207041933.08%208.92,%20270202.25%207041935.64%208.93,%20270200.05%207041935.65%208.87,%20270200.05%207041935.8%208.86,%20270199.01%207041935.78%208.86,%20270198.99%207041934.8%208.77,%20270199.16%207041934.81%208.78,%20270199.19%207041934.7%208.75,%20270199.11%207041932.03%209.49,%20270198.99%207041930.45%208.9,%20270198.74%207041927.6%208.9,%20270198.06%207041923.11%208.95,%20270197.77%207041919.43%208.96,%20270197.78%207041918.45%208.99,%20270198%207041907.98%209.07,%20270198.19%207041899.17%209.09,%20270198.36%207041891.49%209.18,%20270198.9%207041866.11%209.51,%20270198.94%207041864.52%209.53,%20270199.12%207041857.34%209.64,%20270199.18%207041854.59%209.68,%20270199.27%207041851%2010.48,%20270199.31%207041850.23%2010.49,%20270199.41%207041849.44%2010.51,%20270199.55%207041848.68%2010.49,%20270199.98%207041847.36%2010.51,%20270200.4%207041846.4%2010.54,%20270200.64%207041845.98%2010.54,%20270201.12%207041845.19%2010.54,%20270201.97%207041844.02%2010.55,%20270202.49%207041843.43%2010.57,%20270203.15%207041842.75%2010.57,%20270204.44%207041841.7%2010.57,%20270205.79%207041840.88%2010.58,%20270206.53%207041840.52%2010.57,%20270208.16%207041839.97%2010.53,%20270209.05%207041839.76%2010.53,%20270213.19%207041839.19%2010.54,%20270213.46%207041839.15%209.77,%20270218.3%207041843.78%209.74,%20270215.37%207041844.25%209.74,%20270215.4%207041844.64%209.77,%20270214.77%207041844.75%209.76,%20270215.12%207041848.74%209.82,%20270214.22%207041851.31%209.85,%20270213.63%207041851.39%2010.6,%20270205.68%207041852.3%2010.53,%20270205.4%207041852.44%2010.57,%20270205.14%207041852.67%2010.55,%20270204.91%207041852.92%2010.58,%20270204.69%207041853.33%2010.57,%20270204.64%207041853.47%2010.42,%20270204.22%207041854.08%209.84,%20270204.21%207041855.44%2010.5,%20270204.16%207041857.09%209.8,%20270203.69%207041857.07%209.65,%20270203.68%207041858.67%209.64,%20270204.31%207041858.68%209.65,%20270204.32%207041858.79%209.76,%20270204.38%207041858.78%209.78,%20270204.38%207041859.94%209.88,%20270204.44%207041859.93%209.88,%20270204.43%207041860.7%209.88,%20270204.37%207041860.7%209.88,%20270204.25%207041866.91%209.88,%20270204.16%207041870.76%209.64,%20270203.94%207041881.99%209.57,%20270203.56%207041881.99%209.36,%20270203.51%207041883.67%209.36,%20270203.9%207041883.67%209.36,%20270203.72%207041891.79%209.38,%20270203.45%207041903.53%209.25,%20270203.41%207041905.85%209.19,%20270203.17%207041917.19%209.17,%20270203.15%207041918.45%209.16)&maks_avstand=100&pretty=true&kortform=true]",NVDB-6937,Les-API,
Statistikk og antall vegobjekter,"*Observasjon #1 med vegref og med egenskapsfilter - {color:#de350b}AVVIK{color}*

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8&egenskap=%282326%21%3D4200%29]

--> 0 (UTV og ATM)

vs

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8&egenskap=%282326%21%3D4200%29|https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8&egenskap=%282326%21%3D4200%29]

--> 21 (UTV og ATM)

*Observasjon #1 med vegref og uten egenskapsfilter - {color:#de350b}AVVIK{color}*

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8]

--> 37 (UTV og ATM)

vs

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8|https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608&vegsystemreferanse=EV8]

--> 44 (UTV og ATM)

*Observasjon #1 uten vegref og uten egenskapsfilter - {color:#00875a}OK{color}*

[https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608]

--> 1316 (UTV), 1313 (ATM)

[https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/445?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608|https://nvdbapiles-v3.test.atlas.vegvesen.no/vegobjekter/445/statistikk?segmentering=true&kartutsnitt=626430.051%2C7662359.568%2C712746.312%2C7763587.608]

--> 1316 (UTV), 1313 (ATM)

*Observasjon #2*

Se lenker i NVDB-5345

 ",NVDB-6937,Les-API,
Sjekk filtrering av segmenter for objekter med sluttdato,"Det ser ut som det kun filtreres på tidspunktparameter, så alle_versjoner=true vil kanskje gi tom segmentliste for objekter med sluttdato. 
Disse skal ha segmentene med samme sluttdato som selve objektet.",NVDB-6937,Les-API,
Kan ikke sende inn vegobjekt med kobling til mor i NVDB,"h2. Observasjon
Får systemfeil ved innsending av endringsett der mor er eksisterende NVDB-objekt (men i kontrakten) med eksisterende døtre, og har i tillegg en datter som er ny i kontrakten.

For å reprodusere, importer f.eks. et skiltpunkt i kontrakt, kopiér geometri til skiltplate, og koble skiltplate til skiltpunkt. Får da systemfeil ved innsending.

h2. Analyse
Skriv har endret på sin XSD (https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/endringssett.xsd) i forbindelse med muligheten for å ikke sende inn alle sammenkoblinger. Så den XML'en vi sender i dette tilfellet validerer ikke lengre. Sjekk feilen ""Invalid content was found starting with element 'tempId'"" i Kibana, tror alle tilfeller siden midten av februar er dette.

Ser ut som rekkefølgen på elementene har blitt byttet om, i tillegg er det et problem at vi sender XML som er en blanding av DelvisAssosiasjon (som er endret i ny XSD) og Assosiasjon (som antakeligvis er den som vi burde brukt slik det er i dag).

h2. Løsning
Ta i bruk DelvisAssosiasjon slik den nye versjonen av Skriv åpner for. Årsaken til denne endringa i Skriv var å gjøre det mulig å sende inn  kun endrede sammenkoblinger. Dette var ikke mulig før februar, og derfor har Datafangst kode for å hente de andre sammenkoblingene fra eksisterende NVDB-objekter og sende de inn samtidig. Vi går over til å lage DevisAssosiasjon med kun endrede elementer, og sletter koden som henter inn eksisterende koblinger fra Skriv.",NVDB-6937,Datafangst,
"NVDBREF 568: 538 Gate: Fjerne assosiasjon til kommune, innføre egenskap i stedet","h2. Bakgrunn

Gateobjektene i NVDB har bl.a. informasjon om vegnavn. Dette er viktig informasjon for blålysetater, ruteplanleggere generelt og adressekart. Denne objekttypen ble definert i NVDB for mange år siden, og vi ser nå at det er behov for å gjøre noen endringer på denne.

_Fjerne assosiasjon til kommune_

Gateobjektet har i dag en assosiasjon til objekttype 946 Kommune og 536 Kommune 2019. Dette er koblingen til kommunen den aktuelle gata hører hjemme i. Vi skal nå forenkle denne objekttypen ved å fjerne denne assosiasjonen, og heller innføre _kommune _som en _egenskap _til objektet.

_Endre navn på objekttype og egenskaper_

Objekttype 538 Gate er i dag definert med disse egenskapene:
* ET 4588 _Gatekode _(tall)
* ET 4589 _Gatenavn_ (tekst)
* ET 9793 _Sideveg_ med tillatte verdier _Ja_ eller _Nei_

I tillegg har objekttypen en assosiasjon til 946 Kommune og 536 Kommune 2019 som beskrevet over.

Objekttypen 538 Gate vil få nytt navn; Vegadresse, og bli definert slik:
* Ny ET Kommune
* ET 4588 Adressekode (tall)
* ET 4589 Adressenavn (tekst)
* ET 9793 Sideveg med tillatte verdier Ja eller Nei (uendret)

Dette betyr at 538 Vegadresse etter denne endringen kun kjenner til kommunene som var gyldige etter 1.1.2020.

[Samlesak i SVV-Jira|https://www.vegvesen.no/jira/browse/NVDBREF-568] viser oversikt over nødvendige endringer i alle berørte komponenter. 

h2. Analyse

Omleggingen av måten kommunetilhørighet angis på for en gate får følger for et par valideringstrinn i API Skriv. Disse validerer at assosiert kommune er den samme kommunen som indikeres av veglenkene gaten er stedfestet på og at bruk av gatenavn (adressenavn) er uniform gitt gatekode (adressekode) og kommune. En overgangsløsning der API Skriv takler kommunetilhørighet både via assosiasjon og egenskap går an, men det dobler kompleksiteten på saken og estimatet. Gevinsten er API Skriv da kan rulles ut når man ønsker FØR det gjøres endringer i NVDB eller datakatalog. Det krever imidlertid at egenskapsid for den nye kommuneegenskapen er kjent på forhånd.

Berørte klasser i API Skriv og det som må gjøres med dem:
* LocationMatchesAssociatedMunicipalityVallidator - Constraint som validerer at assosiert kommune stemmer med kommunen(e) på veglenkene Gate-objektet er stedfestet på. Omdøpes til LocationMatchesMunicipalityAttributeValidator. Bruk av kommuneassosiasjon erstattes med kommuneegenskap. En del metode med ""Street"" i navnet omdøpes til ""RoadAddress"". Logikk relatert til pre-2020 gater kan fjernes.
* UniformStreetNameForCodeValidator - Constraint som validerer at gatenavnet er ens for alle gater med samme gatekode i samme kommune. Omdøpes til UniformRoadAddressNameForCodeValidator. Bruk av municipalityNvdbId (fra assosiasjon) erstattes med municipalityNo (fra egenskap). En del metode med ""Street"" i navnet omdøpes til ""RoadAddress"". Logikk relatert til pre-2020 gater kan fjernes.
* StreetEnricherFilter - Filteret beriker jobben med eksisterende Gate-objekter som forberedelse til validering i UniformStreetNameForCodeValidator. Omdøpes til RoadAddressEnricherFilter. Metoden getExistingStreets omdøpes til getExistingRoadAddresses og finner Vegadresse-objekter gitt adressekode og kommunenr i stedet for kommuneassosiasjon. Logikk relatert til pre-2020 gater kan fjernes.
* StreetId - Omdøpes til RoadAddress. Property municipalityNvdbId erstattes med municipalityNo fra egenskap. Logikk relatert til pre-2020 gater kan fjernes.
* MunicipalityEnricherFilter - Filter som beriker jobben med Kommune-objekter. Kan fjernes siden kommunenr nå er angitt eksplisitt i Vegadresse-objektene.

Estimat: 1 dv",NVDB-6937,Skriv-API,
Feil på veglengder,"2020-03-23 16:01
 Nybakken Lars Erik:
 Er det flere som har feil på veglengde? Ser at det er over dobbel lengde mot det skal være på noen veger. Ser også at det er feil på riksveglisten for 12/65. F.eks. E6 viken gr. - Åkerjordet er vel ca. 15mil, men står med nesten 35 mil. 892 Bk 12/65, uoff

 

 

*De nedenfor var feil, men ble løst. Bruker dem som testcase:* 

905 Bk normal, Vestladn Eksempel fra Vestland (det finnes flere):  I NVDB har vegen en totallengde på 83.852: 

!image001.png|thumbnail!

I Rapporten kommer det slik: 

!image002.png|thumbnail!

 

905 Bk normal, uoff Fv17 i Nord-Trøndelag og Nordland - ser grei ut

905 Bk normal, uoff: Fv 40 Kongsberg - X E134 - Geilo x rv.7 - 160 km. 

 ",,Rapportgenerator,
"NVDBREF-474: Prøveinnsjekk av vegnettsendring (Dry run) skal ikke sette låser, eller stoppes av låser","h2. Bakgrunn

Prøveinnsjekk må kjøres uten at det settes noen låser, eller at prøveinnsjekket stoppes av andre låser.

h2. Analyse

Låsing sikrer at valideringen er gyldig. Bruk av ""dry-run"" header skal behandle et endringssett på vanlig måte, inkludert låsing, for å indikere om det er feilfritt og kan sendes inn ""på ekte"". Vi kan ikke endre denne kontrakten, da den brukes av mange klienter. For å realisere prøveinnsjekk uten låsing, må vi definere en ny header, f.eks. ""dry-run-no-locking"", for dette scenariet.

Når låsing droppes kan vi risikere at et endringssett lykkes i prøveinnsjekket, men feiler pga. låsekonflikt eller relasjonell valideringsfeil i det ekte innsjekket. Vegnettsgruppa har bekreftet at dette er OK.

h2. Løsning

ChangesetResource: aksepter ny header ""x-nvdb-dryrun-nolocking"".
job/ProcessingDirectives: ny property, noLocking
JobWorker: etabler oppdrag og optimistiske låser bare når noLocking=false

Estimat: 2 dv",NVDB-6937,Skriv-API,
Transaksjonsendepunktet trigger OutOfMemoryError,"h2. Observasjon

Ved anrop av https://www.vegvesen.no/nvdb/apiskriv/rest/v1/transaksjon, altså uten søkeparametere og resultatavgrensning, står nettelseren og henger og API Skriv trigger OutOfMemoryError.

Default resultatavgrensning er 1000 innslag, men det virker som det ikke har effekt.

h2. Analyse

Følgende SQL brukes:

{code:sql}
SELECT * FROM ( 
   SELECT original.*, ROWNUM row_no FROM ( 
      WITH unique_transactions AS ( 
         SELECT DISTINCT tt.taskid task_id, tt.transactiondatetime tx_time
         FROM nvdb.transactiontasks tt)
      SELECT VALUE(tt) AS tx_task
      FROM nvdb.transactiontasks tt, unique_transactions ut
      WHERE (tt.taskid = ut.task_id) AND (tt.transactiondatetime = ut.tx_time)
   ) original
WHERE ROWNUM <= 1000 ) WHERE row_no >= 0
{code}

Resultatavgrensning ser ut til å være i orden. Men denne query'en genererer et massivt resultatsett fordi transaksjonene er nøstet i NVDB og kan inneholde mengder med objekt-beskrivelser.  SQL-queryer tar noen sekunder, mens transformasjonen til representasjonsmodell tar mange minutter og ender i OutOfMemoryError. Ved nærmere analyse viser det seg at minne- og tidsbruk skyldes oppbygging URIer med UriBuilder.

h2. Løsning

Hindrer fri utlisting av 1000-vis av transaksjoner ved å kontrollere at minst en søkeparameter er angitt i requesten.",NVDB-6937,Skriv-API,
Kan ikke re-sende inn feilet innsending til NVDB,"h2. Observasjon

Sender inn skiltpunkt og skiltplate.

Objektene inneholder  feil og blir avvist av NVDB

Nå kan jeg ikke lenger trykke på Send til NVDB-knappen. klikk på den gjør ingenting.

Når jeg derimot navigerer til en ny objekttype, blir denne forsøkt sendt inn automatisk, og uten at jeg vil det.

Se: [http://localhost:8082/#!/contract/aa9ab282-e332-4164-ab54-b35418511761/export2]",NVDB-6937,Datafangst,
Datafane: Import av atlas-url feiler,"h2. Observasjon

Gå til datafanen og importer via url. Denne håndterer ikke Atlas-url'er. F.ex:
 * OK v2: https://www.vegvesen.no/nvdb/api/v2/vegobjekter/581?segmentering=true&inkluder=lokasjon%2Cegenskaper%2Cmetadata&kartutsnitt=-2326086%2C5579077%2C3526086%2C8870923&egenskap=5225%3D%27L%C3%A6rdalstunnelen%27
 * OK v3: https://www.vegvesen.no/nvdb/api/v3/vegobjekter/581?segmentering=true&inkluder=lokasjon%2Cegenskaper%2Cmetadata&kartutsnitt=-2326086%2C5579077%2C3526086%2C8870923&egenskap=5225%3D%27L%C3%A6rdalstunnelen%27
 * Feil v2: https://nvdbapiles-v2.atlas.vegvesen.no/vegobjekter/581?segmentering=true&inkluder=lokasjon%2Cegenskaper%2Cmetadata&kartutsnitt=-2326086%2C5579077%2C3526086%2C8870923&egenskap=5225%3D%27L%C3%A6rdalstunnelen%27
 * Feil v3: https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/581?segmentering=true&inkluder=lokasjon%2Cegenskaper%2Cmetadata&kartutsnitt=-2326086%2C5579077%2C3526086%2C8870923&egenskap=5225%3D%27L%C3%A6rdalstunnelen%27",NVDB-6937,Datafangst,
Stedfesting2: Filter for leverte objekter,"Lag et filter for leverte objekter.

filteret skal skjule leverte objekter som default.",NVDB-6937,Datafangst,
"Feil oppramsing for bruksklasse-egenskap ""Spesiell begrensing"" ","Vi fant en feil i veglisteproduksjon for kommunal- og fylkesveger, Bk 905 Normaltransport, uoffisiell for av den biten av Kv57035 i Gjemnes kommune som har spesiell begrensning, markert med rødt i kartet: 

!image-2020-03-20-14-20-15-905.png!

Til grunn for oppramsingen ligger dette NVDB objektet

 

nvdbid: 779637308
versjon: 3
fraDato: 2017-03-10
sistmodifisert: 2017-05-11T13:33:29
Bruksklasse: Spesiell begrensning
Bruksklasse vinter: NULL 
Maks vogntoglengde: 12,40
Strekningsbeskrivelse: Åbakken bru 
Maks totalvekt kjøretøy, skiltet: NULL
Maks totalvekt vogntog, skiltet: NULL
Merknad: Maks totalvekt 12t
vegsystemreferanse: KV57035 S1D1 m3165-3302
stedfesting: 0.9173444-1.0@224247
segmentlengde: 136,35783423604818
segment nr: 4

 

I tabellen kommer det som 

 
|Kv. 57035|Åbakkvegen: Trøa - Åbakken bru|1.930|BkT8/50|Bk10/50|19.50|

 

Dette skal være: 

 
|Kv. 57035|Åbakken bru
Maks totalvekt 12t|0.235|Spesiell begrensing| |12.40|",,Rapportgenerator,
Feil i beregnet lengde Kv 57035 ,"Vi har avdekket en feil i beregnede lengder for KV57035 i Gjemnes kommune, kommunenummer 1557, for objekttypen 905 bruksklasse normaltransport, uoffisiell 

Langs Kv57305 finnes det 4 NVDB -objekter, fordelt slik: 

!image-2020-03-20-14-07-41-885.png!

Fargelegging her = de ulike bruksklasse-verdiene. 

!image-2020-03-20-14-08-17-234.png!

De to objektene i grønt inngår i sekkeposten ""øvrige veger"", og vi har ikke prøvd å etterprøve lengdeberegning av dem. Feilrapporten gjelder de to NVDB - objektene 777857447 og 779637308, markert med brunt og rødt i kartskissen. 

I vegliste-produksjon er disse objektene opphav til denne utlistingen, påført mine anmerkinger (de to kolonnene lengst til høyre). Alt ettersom man bruker geometrisk lengde eller metrert lengde vil man få litt ulike svar, derfor har vi et intervall. 

 
|Vegnr|Strekningsbeskrivelse|Lengde|Bruksklasse|Bruksklasse, vinger|Lengde|NVDB ID|Riktig lengde|
|Kv. 57035|Åbakkvegen: Trøa - Åbakken bru|1.930|BkT8/50|Bk10/50|19.50|777857447|Riktig lengde=1554-1559 meter.|
|Kv. 57035|Åbakkvegen: Trøa - Åbakken bru
Maks totalvekt 12t|0.235|BkT8/50|Bk10/50|19.50|779637308|Riktig lengde=136-137meter|

 

 

 

 ",,Rapportgenerator,
NVDBREF-275: Mange segmenter på Ev6 S3D1 får beregnet fra/til-meter 0,"Klippet fra SVV-jira. Beskrivelsen der er litt bedre formatert: 

Mange segmenter får ingen vegreferanse-utstrekning:
Eksempel:
 
""veglenkesekvensid"": 3154374,
""startposisjon"": 0.0,
""sluttposisjon"": 0.14183124,
""kortform"": ""0.0-0.14183124@3154374"",
""veglenkenummer"": 1,
""segmentnummer"": 2,
""startnode"": ""3154393"",
""sluttnode"": ""3154385"",
""referanse"": ""3154374-1-2"",
""lengde"": 544.343,
""vegsystemreferanse"": {
    ""kortform"": ""EV6 S13D1 m0""
},
Andre referanser med samme problem:
 
 
3154373-1-2;3154374-1-2;3154374-2-2;3154374-3-2;3154375-1-2;3154375-2-2;
3154375-3-2;3154375-4-2;3154375-5-2;3154376-1-2;3154376-2-2;3154376-3-2;
3154376-4-2;3154376-5-2;3154377-1-2;3154377-2-2;3154377-3-2;3154377-11-2;
3154377-12-2;3154378-1-2;3154403-1-2;",NVDB-6937,NVDB-IND,
Oppdatere datakatalog på fil,"Ny datakatalog er tilgjengelig i Prod. Se [https://apilesv3.atlas.vegvesen.no/status]
 og [http://tfprod1.sintef.no/datakatalog/]
{noformat}
<datakatalog>
  <id>870</id>
  <dato>2020-03-20</dato>
  <versjon>2.20</versjon>
</datakatalog>
{noformat}
Datafangst trenger ny dump av datakatalogen til fil.

*Utført arbeid*
 * Oppdatert bash-script for å hente nye filer
 * Hentet versjon 2.20-870
 * Oppdatert kode og tester til å bruke 2.20-870
 * Refaktorert DataCatalogFromFile, slik at koden er litt ryddigere. Deduplisert kode.
 * Oppdatert dokumentasjon på [https://wiki.kantega.no/display/AV/Datafangst]",NVDB-6937,Datafangst,
Manglende objekter,"Jens Erik Thyholdt @jethy57 10:36 20. mars på gitter:
{quote}
Vi hentet ut alle stikkrenner/kulverter for Vestland fylke. Selvsagt API V3. Sjekket statistikk og antall vi hadde fått over som begge viste 67067. Alt ser derfor ut til å være i orden. Men, så sjekket vi logger og oppdaget at flere vegobjekter var ignorert og ikke tatt med fordi vegsystemreferanse ikke var angitt. Tenkte først at her gjør kanskje vi noe feil, men med dobbeltsjekk mot vegkart.no så har vi i vår løsning (Adaptive Veg) og vegkart samme oppfatning av hvordan slike objekter skal håndteres. Hvis vi f.eks ser på stikkrenne med id 78923149 så mangler denne vegsystemreferanse, men stedfesting har den. Forsøkte derfor å lete opp for å se om denne likevel var i kartet. Skal ligge til veglenkesekvensid 384520 med posisjon 0.4474. (https://www.vegvesen.no/nvdb/api/v3/vegobjekter/79/78923149).

Spørsmålet vi sitter tilbake med er hvorfor forsvinner disse vegobjekter fra statistikk, men dersom man henter ut alle vegobjekter via LES så ligger de i uttrekket? Dessuten, siden stedfesting er angitt – kan ikke vegsystemreferansen beregnes der den mangler? Til slutt – vi kan gjerne beregne vegsystemreferansen og få dette vegobjektet vist i kartet, men da vil ikke vegkart.no og vår løsning vise samme? Helt tilslutt – er det ingen som savner disse vegobjektene?
{quote}

Analyse:
Stikkrenne med id 78923149 er stedfestet på lukket vegnett (384520 med posisjon 0.4474), derfor kommer det ikke noen vegsystemreferanse på det objektet. Mulig stikkrenne-objektet også skulle vært lukka, eller ha endra stedfesting.
Det er 572 åpne objekter uten vegsystemreferanse av typeId 79 i fylke 46, og ved gjennomgang av de går det igjen at de er stedfestet på lukket vegnett.
Hvis man trekker fra disse blir antallet objekter likt statistikk-spørringen.",NVDB-6937,Les-API,
NVDBREF-563 Vegkart v2 og v3 viser forskjelige egenskaper,,NVDB-6937,Vegkart,
Ruteberegning: Fjerne/lime sammen duplikat segmenter om en rute starter og slutter på samme vei," 

Den lange lenken nedenfor gir en rute i prinsenkrysset med duplikatsegmenter:

{color:#FF0000}""kortform"" : ""0.87291786-1.0@2510771""{color}
 ""kortform"" : ""0.78970927-0.79084754@72812""
 ""kortform"" : ""0.79084754-0.79107803@72812""
 ""kortform"" : ""0.79084754-0.79084941@72812""
 ""kortform"" : ""0.78970927-0.79084754@72812""
 {color:#FF0000}""kortform"" : ""0.0-1.0@2510771""{color}
 {color:#0747a6}""kortform"" : ""0.6140563-1.0@2510770{color}""
 ""kortform"" : ""0.41611159-0.6140563@2510770""
 ""kortform"" : ""0.5736928-0.6140563@2510770""
 {color:#0747a6}""kortform"" : ""0.6140563-1.0@2510770""{color}
 {color:#FF0000}""kortform"" : ""0.0-0.87291786@2510771""{color}

 

Dersom du limer inn geometren (fra lenken) og får den vist i nvdb-visrute ([https://nvdb-vegdata.github.io/nvdb-visrute/STM/] ) ,  ser du at den gule geometrien viser et polygon nær Prinsenkrysset i Trondheim.  Se vedlegg rute.png. 

 

Når den lager ruteberegning for et polygon / linje så kjører den gjennom alle punktene og lager raskeste rute mellom to og to punkter ned på vegnettet. Dette polygonet blir stedfestet ned på en og samme veg med vegsystemreferanse=fv6690.   Når den kjører stedfesting for alle punktene i denne gitte geometrien ned på en og samme veg, så blir det duplikate stedfestinger.

 Vi må legge inn logikk slik at man stopper ruten der den begynner å gå tilbake samme veien som den kom.  

 

 

 

Lenke: 

[http://localhost:12002/beta/vegnett/rute?geometri=LINESTRING%20Z(270203.15%207041918.45%209.11,%20270203.12%207041921.1%209.03,%20270202.94%207041928.89%208.85,%20270202.66%207041928.89%208.86,%20270202.44%207041933.08%208.92,%20270202.25%207041935.64%208.93,%20270200.05%207041935.65%208.87,%20270200.05%207041935.8%208.86,%20270199.01%207041935.78%208.86,%20270198.99%207041934.8%208.77,%20270199.16%207041934.81%208.78,%20270199.19%207041934.7%208.75,%20270199.11%207041932.03%209.49,%20270198.99%207041930.45%208.9,%20270198.74%207041927.6%208.9,%20270198.06%207041923.11%208.95,%20270197.77%207041919.43%208.96,%20270197.78%207041918.45%208.99,%20270198%207041907.98%209.07,%20270198.19%207041899.17%209.09,%20270198.36%207041891.49%209.18,%20270198.9%207041866.11%209.51,%20270198.94%207041864.52%209.53,%20270199.12%207041857.34%209.64,%20270199.18%207041854.59%209.68,%20270199.27%207041851%2010.48,%20270199.31%207041850.23%2010.49,%20270199.41%207041849.44%2010.51,%20270199.55%207041848.68%2010.49,%20270199.98%207041847.36%2010.51,%20270200.4%207041846.4%2010.54,%20270200.64%207041845.98%2010.54,%20270201.12%207041845.19%2010.54,%20270201.97%207041844.02%2010.55,%20270202.49%207041843.43%2010.57,%20270203.15%207041842.75%2010.57,%20270204.44%207041841.7%2010.57,%20270205.79%207041840.88%2010.58,%20270206.53%207041840.52%2010.57,%20270208.16%207041839.97%2010.53,%20270209.05%207041839.76%2010.53,%20270213.19%207041839.19%2010.54,%20270213.46%207041839.15%209.77,%20270218.3%207041843.78%209.74,%20270215.37%207041844.25%209.74,%20270215.4%207041844.64%209.77,%20270214.77%207041844.75%209.76,%20270215.12%207041848.74%209.82,%20270214.22%207041851.31%209.85,%20270213.63%207041851.39%2010.6,%20270205.68%207041852.3%2010.53,%20270205.4%207041852.44%2010.57,%20270205.14%207041852.67%2010.55,%20270204.91%207041852.92%2010.58,%20270204.69%207041853.33%2010.57,%20270204.64%207041853.47%2010.42,%20270204.22%207041854.08%209.84,%20270204.21%207041855.44%2010.5,%20270204.16%207041857.09%209.8,%20270203.69%207041857.07%209.65,%20270203.68%207041858.67%209.64,%20270204.31%207041858.68%209.65,%20270204.32%207041858.79%209.76,%20270204.38%207041858.78%209.78,%20270204.38%207041859.94%209.88,%20270204.44%207041859.93%209.88,%20270204.43%207041860.7%209.88,%20270204.37%207041860.7%209.88,%20270204.25%207041866.91%209.88,%20270204.16%207041870.76%209.64,%20270203.94%207041881.99%209.57,%20270203.56%207041881.99%209.36,%20270203.51%207041883.67%209.36,%20270203.9%207041883.67%209.36,%20270203.72%207041891.79%209.38,%20270203.45%207041903.53%209.25,%20270203.41%207041905.85%209.19,%20270203.17%207041917.19%209.17,%20270203.15%207041918.45%209.16)&maks_avstand=100&vegsystemreferanse=FV6690&pretty=true&kortform=true]

 

 

 

 ",NVDB-6937,Les-API,
Release: nvdb-vegnett-og-objektdata-app,,NVDB-6827,Rapportgenerator,
Release: nvdb-veglister-app,,NVDB-6825,Rapportgenerator,
NPE ved restedfesting etter geometriutskiftning,"h2. Observasjon

Endingssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/48e81808-daac-4188-9106-070d73558f8a havner i SYSTEMFEIL:

{code:java}
java.lang.NullPointerException
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableFeature.lambda$removeLocationalsOutOfRange$1(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:810)
	at java.util.ArrayList.removeIf(ArrayList.java:1413)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableFeature.removeLocationalsOutOfRange(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:808)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.lambda$getFeatureVersionsToRelocalize$2(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:241)
	at java.util.ArrayList.forEach(ArrayList.java:1257)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.getFeatureVersionsToRelocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:235)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:153)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:114)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:92)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:128)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:386)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1390)
	at org.apache.activemq.ActiveMQMessageConsumer.iterate(ActiveMQMessageConsumer.java:1552)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:191)
	at org.apache.activemq.ActiveMQSessionExecutor.wakeup(ActiveMQSessionExecutor.java:111)
	at org.apache.activemq.ActiveMQMessageConsumer.start(ActiveMQMessageConsumer.java:1527)
	at org.apache.activemq.ActiveMQMessageConsumer$7.run(ActiveMQMessageConsumer.java:1308)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Timer.java:555)
	at java.util.TimerThread.run(Timer.java:505)
{code}

h2. Analyse

NullPointerException kastes ved beregning av avstand mellom vegobjektgeometri og vegnettgeometri fordi vegobjektet av type Vegdekke (241) med id 724114244v3 fullstendig mangler geometriegenskap(er) i NVDB. Dette er dog ikke en datafeil, siden datakatalogen ikke krever at geometriegenskaper er populert. Versjon 3 berøres egentlig ikke av endret vegnettsgeometri, men versjon 1 gjør det og versjon 3 oppdateres til ny versjon 4 med redusert stedfesting fordi den treffes av lukket vegnett. Derfor er denne versjonen en kandidat for restedfesting. En smule komplisert, for å si det mildt... Dersom v3 ikke hadde blitt truffet av lukket vegnett, ville vi ikke fått NPE fordi det ikke lastes vegobjektversjoner fra NVDB som mangler geometri. 

h2. Løsning

Stopper forsøk på restedfesting av vegobjekter som mangler geometriegenskaper i AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.getAffectedFeatureVersions og registerer en notabene om funnet.",NVDB-6937,Skriv-API,
"NullPointerException i AbstractRoadReportDefinition (Publisering, Tømmer, Trøndelag)","NullPointerException i AbstractRoadReportDefinition (Publisering, Tømmer, Trøndelag).

Oppdaget i versjon 1.0.7

Kjørte ok fire minutter etterpå (ingen kodeendringer, og sannsynligvis ingen endinger i NVDB i mellomtiden)...

 

Logg:

2020-03-18 23:20:45,034 ERROR [no.veg.nvd.RapportResource] (ForkJoinPool.commonPool-worker-10) Handling exception for job 29faa6f6-2461-4ab0-bd6d-69577f6bee98: java.util.concurrent.CompletionException: java.lang.NullPointerException
 at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
 at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
 at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1596)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)
 at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)
 at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)
 Caused by: java.lang.NullPointerException
 at no.svv.veirapporter.engine.reports.roadreport.AbstractRoadReportDefinition.lambda$getDefaultValueProviders$1(AbstractRoadReportDefinition.java:87)
 at no.svv.veirapporter.engine.models.defaultvalueproviders.ConditionalDefaultValueProvider.getValue(ConditionalDefaultValueProvider.java:26)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.lambda$addDefaultValues$14(SegmentPopulator.java:89)
 at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
 at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
 at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
 at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
 at java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)
 at java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:401)
 at java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:734)
 at java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:159)
 at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:173)
 at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
 at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:485)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.addDefaultValues(SegmentPopulator.java:89)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.lambda$populateSegments$7(SegmentPopulator.java:54)
 at java.util.stream.ReferencePipeline$11$1.accept(ReferencePipeline.java:439)
 at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
 at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
 at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
 at java.util.stream.ReduceOps$ReduceTask.doLeaf(ReduceOps.java:747)
 at java.util.stream.ReduceOps$ReduceTask.doLeaf(ReduceOps.java:721)
 at java.util.stream.AbstractTask.compute(AbstractTask.java:327)
 at java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinPool$WorkQueue.pollAndExecCC(ForkJoinPool.java:1190)
 at java.util.concurrent.ForkJoinPool.helpComplete(ForkJoinPool.java:1879)
 at java.util.concurrent.ForkJoinPool.awaitJoin(ForkJoinPool.java:2045)
 at java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:404)
 at java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:734)
 at java.util.stream.ReduceOps$ReduceOp.evaluateParallel(ReduceOps.java:714)
 at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
 at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.populateSegments(SegmentPopulator.java:59)
 at no.svv.veirapporter.engine.ReportGenerator.getReport(ReportGenerator.java:116)
 at no.svv.veirapporter.engine.ReportGenerator.createReport(ReportGenerator.java:81)
 at no.vegvesen.nvdbrapportapi.RapportService.getVegliste(RapportService.java:105)
 at no.vegvesen.nvdbrapportapi.RapportService_ClientProxy.getVegliste(RapportService_ClientProxy.zig:38)
 at no.vegvesen.nvdbrapportapi.RapportResource.lambda$getVeglister$0(RapportResource.java:117)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)

Kjører på nytt uten NPE, men har da en warning:
 2020-03-18 23:24:42,707 WARN [no.veg.nvd.map.VeglisteMapper] (ForkJoinPool.commonPool-worker-1) 0 lengde på veg i Rapport Veglister for: Tømmertransport, uoffisiell (901), fylke=Trøndelag ([50]), kommune=, vegsystemreferanse=[FV, KV], Tabell Trøndelag, Stjørdal kommune, Sekundære- og øvrige fylkesveger, Kolonne: Veglengde (km), Linje FV6810 Kvithammer x E6 - Alstad x fv. 6814",,Rapportgenerator,
stedfesting2: marker valg av start og stopp for ankerpunktene,"h2. Observasjon

Stedfesting 1 markerer tydelig trykk på Start og Stopp med en grønn farge. Dette gjør ikke Stedfesting 2. Om det er grønn som er riktig er en annen ting, men litt mer tydelig at du faktisk har trykket på og satt Start og Stopp.

Bruk gjrene vedlagte SOSI som må ha manuelle ankerpunkter for å bli stedfestet.",NVDB-6937,Datafangst,
stedfesting2: gi beskjed om å bruke manuelle ankerpunkter,"h2. Observasjon

Prøver å stedfeste et objekt med vanlig markering. Kallet _/rest/vegobjekt/<id>/localize2_ gir tilbake beskjed om _Store vegobjekter med samme start og stopp må stedfestes med manuelle ankerpunkter_. Stedfesting 2 bør gi denne beskjeden tilbake til brukeren. Stedfesting 1 gjør dette.

Bruk vedlagte SOSI for å fremprovosere dette.",NVDB-6937,Datafangst,
Feil på innsending med endret prosjektreferanse,"h2. Observasjon

Når man fjerner prosjektreferanse som egenskapsverdi for et eksisterende objekt og samtidig registrer med å bruke kontraktens prosjektreferanse, så feiler innsending. API Skriv gir HTTP 400 med en beskrivende feilmelding tilbake. Datafangst gir bare beskjed om _Systemfeil ved operasjon: Registrere vegobjekter i NVDB_.

Gjenskap ved å:
 * Last opp vedlagte SOSI på en kontrakt _uten_ prosjektref i Innstillingene
 * Stedfest og sett prosjektreferanse i datafanen
 * Registrer -> UTFØRT
 * Slett egenskapsverdien prosjektreferanse i datafanen
 * Sett en annen prosjektreferanse i kontraktens innstillinger
 * Registrer *med* å huke av for å bruke kontraktens prosjektreferanse

Datafangst vil sende
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><endringssett xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><delvisOppdater><vegobjekter><vegobjekt typeId=""95"" nvdbId=""1006280785"" versjon=""1"" overskriv=""JA""><egenskaper><egenskap typeId=""11078"" operasjon=""slett""/><egenskap typeId=""11078"" operasjon=""oppdater""><verdi>Ny_Ref_Id</verdi></egenskap></egenskaper><validering><lestFraNvdb>2020-03-18T14:25:28</lestFraNvdb><reduserPunkttetthet>JA</reduserPunkttetthet></validering></vegobjekt></vegobjekter></delvisOppdater><ansvarlig>exttxm</ansvarlig><datakatalogversjon>2.20</datakatalogversjon></endringssett>
{noformat}
Skriv svarer med HTTP 400 og
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>delvisOppdater.vegobjekter[0].egenskaper: Må være unik: typeId</message></fault>
{noformat}
Denne er relatert til sakene:
 * NVDB-5321
 * NVDB-5322 (notis om Eksportfanen i beskrivelsen)",NVDB-6937,Datafangst,
Datafane: Håndtere HTTP 400 fra Skriv,"h2. Observasjon

Se sak NVDB-5321. Der håndteres ikke HTTP 400 ved filopplasting. Denne er relevant.

Når først noe feil er kommet inn i Datafangst vil en endring på objekt som har feil gjøre at API Skriv gi HTTP 400 tilbake. Datafangst kaster da bare en rød feilmeldingsboks tilbake.

Gjenskap med å laste inn vedlagte SOSI, for deretter å prøve å endre en verdi i datafanen.

Regner med at løsning på NVDB-5321 vil hjelpe i denne saken også, men i stedet for å kaste en feil ""Systemfeil ved operasjon: Oppdater vegobjekter"" så burde man fanget opp HTTP 400 responsen fra Skriv som sier hva som er galt. 

Tror det forøvrig er ofte at når det kommer HTTP 400 fra Skriv - *med* en beskrivelse av hva som er feil - så kastes feilen _Failed to invoke NVDB API Skriv, while validating changeset_ i Datafangst-alarm kanalen.

Stacktrace: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=4-_B7XAB9KCz2i26wu4e]

HTTP 400 respons fra Skriv: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=6u_B7XAB9KCz2i26wu4e]

*Tillegg*

Jeg har ikke laget egen sak, men vi bør også håndtere slike feil i Eksportfanen når Datafangst sender inn noe som Skriv avviser med HTTP 400 og beskrivende feilmelding. 

h2. Analyse
Feilmeldingene fra Skriv er ikke godt egnet for å kunne parses og presenteres til bruker. Tore anbefaler at vi validerer i vår kode før vi sender inn, dette blir håndtert i NVDB-5357.

Det som må gjøres her er å hindre at det blir en systemfeil (fordi vi prøver å parse en feilrespons i et vanlig feilobjekt), og sørge for en god logging av feil mot Skriv.

Når NVDB-5357 og NVDB-5356 er løst burde gjenværende 400-feil bety at det er gjort en feil av utvikler, og sånn sett er det viktig å fange opp dem på en god måte.

h2. Løsning
400 fra Skriv fanges og logges, og rapporteres som systemfeil til bruker. På grunn av endringer fra NVDB-5356 med validering så vil vegobjekter med verdier som er utenfor Skrivs XML-schema ikke bli sendt til Skriv for validering, så det finnes ingen kjent måte å få en HTTP 400 fra Skriv nå.",NVDB-6937,Datafangst,
Filopplasting: Håndtere HTTP 400 fra Skriv,"h2. Observasjon

En bruker har lastet opp en SOSI-fil som API Skriv avviser tidlig i valideringsløypa s.a. Skriv sender HTTP 400 tilbake i stedet for vanlige HTTP 200 med AVVIST om det er noe Datafangst må ta hensyn til. Når Datafangst mottar HTTP 400 fra API Skriv, så kastes en Exception, men brukeren ser ikke at noe er galt.

Når så brukeren vil editere på denne typen med feil, så vil fortsatt Skriv respondere med HTTP 400 - og da kaster Datafangst en feil ""Systemfeil ved operasjon: Oppdatere vegobjekt"" i datafanen.

Vedlagt ligger SOSI med feil målemetode som Skriv reagerer på.

Se request til Skriv : [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=UO-47XAB9KCz2i26usjd]

Se respons fra Skriv: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=Tu-47XAB9KCz2i26usjd]

Se stacktrace i DF: [https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=VO-47XAB9KCz2i26usjd]

og

[https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-test-beats-6.8.7-2020.03.18/doc/?id=z]–47XAB9KCz2i26vsjI

Datafangst bør håndtere HTTP 400 fra Skriv ved validering på opplastet fil på en bedre måte. Skriv sier bare i fra hva som er feil, og dette bør Datafangst høre på.
h2. Analyse

Feilmeldingene fra Skriv er ikke godt egnet for å kunne parses og presenteres til bruker. Tore anbefaler at vi validerer i vår kode før vi sender inn, dette blir håndtert i NVDB-5356.

Det som må gjøres her er å hindre at det blir en systemfeil (fordi vi prøver å parse en feilrespons i et vanlig feilobjekt), og sørge for en god logging av feil mot Skriv.

Når NVDB-5356 er løst burde gjenværende 400-feil bety at det er gjort en feil av utvikler, og sånn sett er det viktig å fange opp dem på en god måte.
h2. Løsning

Når skriv sender tilbake en 400 som følge av at datasettet ikke har gyldig datastruktur, så forkastes hele datasettet. Ugyldig datastruktur kan ikke fikses i datafangst.

Når dette skjer genererer vi en valideringsfeil med grad FATAL, som fører til at datasettet forkastes, og tilbakemelding til brukeren gis i status-fanen for opplastingen.",NVDB-6937,Datafangst,
"Innsending til NVDB er alltid med ""overskriv""","[~tormos] oppdaga at etter NVDB-5222 så går alle innsedinger til NVDB som ""overskriv eksisterende versjoner"", uavhengig om det er denne knappen eller vanlig innsending som brukes.",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5316: Eksport av SOSI skal gi ut NN2000. Se flere detaljer i testbeskrivelse i saken.
 * NVDB-5320: Innsending til NVDB skal ikke bruke ""overskriv"" ved vanlig innsending.
 * NVDB-5292: Regresjonstest av kart og dets oppførsel rundt om.
 * NVDB-5071: Regresjonstest av ny stedfestingsfane. Inkluderer sakene NVDB-5062, NVDB-5064, NVDB-5065, NVDB-5311. Hva disse dekker står i de respektive sakene.",NVDB-6937,Datafangst,
PROD: Håndtere feil med 504 Gateway Timeout,"Logg fra *PROD* (2020-03-18):

2020-03-18 10:09:37,585 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-10) Veglister request 905,[18],[],[FV, KV],2020-03-18,nb_NO,true...
 2020-03-18 10:09:37,586 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-10) Added job ad6b6422-26aa-41e8-af42-df46decb96a0 with TTL PT30M
 2020-03-18 10:09:37,586 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-10) Purge expired jobs...
 2020-03-18 10:09:37,587 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-10) Veglister returns response status 202
 2020-03-18 10:09:37,587 INFO [no.svv.vei.eng.ReportGenerator] (Thread-39) Starting download of data from NVDB
 2020-03-18 10:09:37,671 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Login successful
 2020-03-18 10:09:39,502 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 915, 1 out of 8
 2020-03-18 10:10:39,374 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 7174 objects of type 915
 2020-03-18 10:10:39,375 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 916, 2 out of 8
 2020-03-18 10:11:57,918 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 11105 objects of type 916
 2020-03-18 10:11:57,918 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 917, 3 out of 8
 2020-03-18 10:12:12,957 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 29 objects of type 917
 2020-03-18 10:12:12,958 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 918, 4 out of 8
 2020-03-18 10:12:25,199 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 29 objects of type 918
 2020-03-18 10:12:25,200 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 919, 5 out of 8
 2020-03-18 10:12:31,232 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 21 objects of type 919
 2020-03-18 10:12:31,233 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 920, 6 out of 8
 2020-03-18 10:12:41,835 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 21 objects of type 920
 2020-03-18 10:12:41,835 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 577, 7 out of 8
 2020-03-18 10:12:44,272 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Fetched 3 objects of type 577
 2020-03-18 10:12:44,273 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-39) Preparing to fetch data for 905, 8 out of 8
 2020-03-18 10:13:46,956 WARN [no.veg.nvd.cli.exc.JsonExceptionParser] (pool-333-thread-1) Could not parse '<html><body><h1>504 Gateway Time-out</h1>
 The server didn't respond in time.
 </body></html>
 ' as json.
 2020-03-18 10:13:46,963 ERROR [no.veg.nvd.RapportResource] (Thread-39) Handling exception for job ad6b6422-26aa-41e8-af42-df46decb96a0: java.util.concurrent.CompletionException: HTTP error 504:
 at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
 at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
 at java.lang.Thread.run(Thread.java:748)
 Caused by: HTTP error 504:
 at no.vegvesen.nvdbapi.client.clients.util.JerseyHelper.parseError(JerseyHelper.java:61)
 at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:75)
 at no.vegvesen.nvdbapi.client.clients.AsyncResult.lambda$null$0(AsyncResult.java:54)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 ... 1 more
 2020-03-18 10:13:47,638 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-15) NOT Removing job ad6b6422-26aa-41e8-af42-df46decb96a0 (temporarily disabled - job will be purged after configured TTL PT30M)
 2020-03-18 10:21:52,389 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-6) Veglister request 905,[18],[],[FV, KV],2020-03-18,nb_NO,true...
 2020-03-18 10:21:52,390 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Added job bff79890-1ef1-45f3-87cc-b47c353b5ffb with TTL PT30M
 2020-03-18 10:21:52,390 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Purge expired jobs...
 2020-03-18 10:21:52,390 WARN [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Purge removed 1 expired jobs: 410075e0-114a-42c8-8811-7b12c5a99ca1 (SUCCESS). Timetolive is configured to 30 Minutes - consider increasing it
 2020-03-18 10:21:52,390 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-6) Veglister returns response status 202
 2020-03-18 10:21:52,391 INFO [no.svv.vei.eng.ReportGenerator] (Thread-40) Starting download of data from NVDB
 2020-03-18 10:21:52,511 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-40) Login successful
 2020-03-18 10:21:53,011 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-40) Preparing to fetch data for 915, 1 out of 8
 2020-03-18 10:22:27,431 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-6) Veglister request 903,[15],[],[FV, KV],2020-03-18,nb_NO,true...
 2020-03-18 10:22:27,432 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Added job bd21d4ef-f0f4-426c-a5c4-ecc6bf195267 with TTL PT30M
 2020-03-18 10:22:27,432 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Purge expired jobs...
 2020-03-18 10:22:27,432 WARN [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-6) Purge removed 1 expired jobs: 76976b43-d14a-4195-9405-3d915e3addfa (SUCCESS). Timetolive is configured to 30 Minutes - consider increasing it
 2020-03-18 10:22:27,432 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-6) Veglister returns response status 202
 2020-03-18 10:22:27,432 INFO [no.svv.vei.eng.ReportGenerator] (Thread-41) Starting download of data from NVDB
 2020-03-18 10:22:27,519 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-41) Login successful

 ",NVDB-6825,Rapportgenerator,
Ruteberegning: Api skriv trenger målt/godkjent lengde (ikke geometri lengde)," 

Ruteberegning: Api skriv trenger målt/godkjent lengde (ikke geometri lengde)

I dag regnes lengden på klippede segmenter på geomtrien. Ikke på målt lengde.

 
h2. TODO
 * Sjekk hva nvdbind / reader lagrer av lengde på veglenkene. Er det geometriens lengde eller er det lengden på lenkene. Det mest naturlige var at det er målt lengde som lagres. (Geometriens lengde er bare å regne ut av geometrien).
 * Endre RoadNetSegment.updateRelativePositionGeometryAndRoadRef  til å regne med lenkens lengde og ikke bruke geometrien. 

 

 

*Løsning:* 

NVDB-5431 endret slik at segmenter bruker målt lengde og ikke lengde fra geometri. Har endret klipping av segmenter (updateRelativePositionGeometryAndRoadRef) til å bruke lengde på segmenter og ikke lengde på geometri.

 

 ",NVDB-6937,Les-API,
Eksport av SOSI gis ut på NN54,"h2. Observasjon

Vegobjekter fra både SOSI med satt NN54 og SOSI med satt NN2000 blir eksportert i Eksportfanen med NN54. Dette må rettes raskt.

Se kontrakt [https://datafangst.kantega.no/#!/contract/40e2ba3a-8665-4a36-8cde-51d7cdff9e3d/export]

hvor skiltplatene er lastet inn med SOSI og NN2000, mens skiltpunktene er lastet inn med SOSI og NN54.",NVDB-6937,Datafangst,
Justeringer i vegnettsfilter.,"Fra mail:

 

Hei!
  
 Her er det gjort mange forbedringer 
 Etter å ha testet den nye funksjonaliteten har jeg et par forslag til endringer:
  
 *Grupperingene i utvalget*

Når alle valgene fjernes fra en gruppering bør vegnettet bli borte. For eksempel hvis man slår av alt vegnett for «Kjørende» og alt vegnett for «Gående og syklende» samtidig. Dette gjeller også for grupperingen «Adskilte løp» og grupperingen «Detaljnivå».
 Det er ulogisk at alt slått av gir samme resultat som at alt slått på i en gruppering.
  
 Det kan med fordel gjøres tydeligere hvilke avkryssinger som hører til samme gruppering. For eksempel med bokser eller streker:

!image001.jpg|thumbnail!  

*Tri-state-toggles*

Jeg mener det er mest logisk at første trykk i tri-state-toggles går til «uten». Alt vegnett blir i utgangspunktet tegnet opp og brukeren kan da etterfølgende velge hvilke deler av vegnettet som ikke skal vises. Når brukeren holder på å velge bort vegnett er det ulogisk at første trykk på tri-state-toggles går til «med»

Jeg tror også at der er flere som ønsker å skrue av enn å skru på visningen av armer, kryssystem, sideanlegg og konnektering.

*Detaljnivå*
 I vegnettsmodellen har vi tre detaljnivåer. Vegtrase-, kjørebane- og kjørefeltnivå, der vegtrasenivå og kjørebanenivå er komplett for hele landet. Det mest logiske er at avkryssingsboksen: «vegtrase og kjørebane» fjernes slik at det gjenspeiler de tre detaljnivåene i vegnettsmodellen.
  
 Vegtrase skal da vise lenkene av typen «Vegtrase» og «Vegtrase og kjørebane» som her:

!image011.jpg|thumbnail!
  
 Kjørebane skal vise lenkene av typen «Kjørebane» og «Vegtrase og kjørebane» som her:

!image012.jpg|thumbnail!
  
 Kjørefelt skal vise lenkene av typen «Kjørefelt» som her:

!image013.jpg|thumbnail!
  
 Egenskapene som vises når man trykker på en lenke er uoversiktlig og der er redundant informasjon. Egenskapene kan med fordel sorteres bedre og deles inn i kategorier.
  
 Her er to eksempler på sortering og inndelinger i kategorier:

!image02.png|thumbnail!

 
 Vennlig hilsen
 Nikolaj Fyhn",NVDB-6937,Vegkart,
Systemfeil i RoadCategoryEnricherFilter,"h2. Observasjon

Endringssettet https://www.utv.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/e73dc2f1-7afa-4539-9594-ce4bcae5400f havner i SYSTEMFEIL:

{code:java}
java.lang.IllegalArgumentException: Upper extent can't be empty
	at no.vegvesen.vt.nvdb.commons.core.contract.Requires.require(Requires.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.domain.ExtentProjection.<init>(ExtentProjection.java:30)
	at no.vegvesen.vt.nvdb.apiskriv.domain.ExtentProjection.of(ExtentProjection.java:23)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.getMainRefLinkExtentProjection(RoadCategoryEnricherFilter.java:158)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.getRoadCategoryForPart(RoadCategoryEnricherFilter.java:99)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.lambda$getRoadCategoriesForPart$1(RoadCategoryEnricherFilter.java:79)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:499)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.getRoadCategoriesForPart(RoadCategoryEnricherFilter.java:81)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.lambda$doFilter$0(RoadCategoryEnricherFilter.java:65)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:499)
	at no.vegvesen.vt.nvdb.apiskriv.validation.netelement.RoadCategoryEnricherFilter.doFilter(RoadCategoryEnricherFilter.java:67)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.JobNetElementFilters.doFilter(JobNetElementFilters.java:30)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:114)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:92)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:128)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:386)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

Problemet oppstår i et filter som beriker veglenker med vegkategori-verdi basert på Vegsystem-objekter. Det kastes IllegalArgumentException fra ExtenProjection.of fordi første parameter er en tom extent. Denne verdien stammer fra superstedfestingen til detaljert veglenke 1 hos veglenkesekvens 706044 i uxpdbnvdb1. Superstedfestingen er [0, 0), som er fullstendig meningsløst. Dette er en datafeil i NVDB.
 
Transaksjonsloggen antyder at et script er ""synderen"":

{noformat}
TX_TIME    TASK_TYPE_ID OBJECT_TYPE   OBJECT_TYPE_ID  OBJECT_ID OBJECT_VERSION TX_TYPE       TASKUSER_NAME                  TASK_NAME                                         
---------- ------------ ------------- -------------- ---------- -------------- ------------- ------------------------------ --------------------------------------------------
05.06.2006          500 NETELEMENT             50002     706044                FV_UPDATED(1) Tore Dyvik                                                                       
20.06.2008        11467 NETELEMENT             50002     706044                FV_UPDATED(1) Henning Sørlie                 0403_gs                                           
17.01.2013        44268 NETELEMENT             50002     706044                FV_UPDATED(1) Arne Sonf                      4                                                 
24.02.2014        54146 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: addMunicipality                           
24.02.2014        54146 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: addMunicipality                           
24.02.2014        54146 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: addMunicipality                           
24.02.2014        54146 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: addMunicipality                           
24.02.2014        54146 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: addMunicipality                           
14.09.2018        90706 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Jørgen Ekker              Skript: generateNodesBetweenRefLinkParts          
09.09.2019        99320 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Jørgen Ekker              Skript: fixRefLinkHoles                           
14.02.2020       101565 NETELEMENT             50002     706044                FV_UPDATED(1) Hans Anton Ålien               Skript: fixDetailedInconsistencies                
14.02.2020       101565 NETELEMENT             50002     706044                FV_UPDATED(1)                                Skript: fixDetailedInconsistencies                
{noformat}

Datafeilen finnes ikke i PROD.

h2. Løsning

Kontrollerer om superstedfesting er tom i RoadCategoryEnricherFilter.getMainRefLinkExtentProjection.
",NVDB-6937,Skriv-API,
Beregne sideposisjon for relevante vegobjekttyper,"h2. Bakgrunn

Når stedfestingstjenesten beregner stedfesting for en sideposisjonrelevant vegobjekttype, skal sideposisjon beregnes og angis i responsen.

h2. Analyse

SidePositionCalculator ble implementert i forbindelse med restedfesting ved geometriendring på vegnett. Grunnalgoritmen er derfor allerede på plass.

Estimat: 2 dv.",NVDB-6937,Skriv-API,
stedfesting2: vis avhaking-symbol på aktive pålitelighets-filter,"Knappene som toggler pålitelighetfilter bør ha hake-symboler som forteller at de er aktive

Vi må også ha et filter for leverte vegobjekter.

det er antakelig hensiktsmessig å liste ut filtrene vertikalt istedet for horisontalt når vi får 4 filtre, og forklarende tekst kan også utvides til å bli mer hjelpsom

Filteret for å vise leverte objekter bør default være av

 ",NVDB-6937,Datafangst,
stedfesting 2: små endringer,"Et par observasjoner som må fikses:
 * får ikke til å logge inn via locational2-URL
 ** la inn sjekk for innlogging
 * vis veglenke-info på single stedfesting-info (evt se neste punkt)
 ** la inf reflink info i listne
 * vis mer info om stedfestinger, prøv grense på 5
 ** lister ut opp til 5 vegobjekter ekspandert
 * se om vi kan zoome lengre inn / bytt kartlag til norkart som default og se om vi får reaksjoner
 ** byttet til norkart",NVDB-6937,Datafangst,
Verifiser at /featuretypesummary er borte,"h2. Observasjon

/featuretypesummary benyttes ikke lengre. Dobbeltsjekk at denne er borte og ikke trengs på noe sted.",NVDB-6937,Datafangst,
Gi gruppeadmin tilgang til overskriv i eksport v2,"I dag har kun globale admin tilgang til ""Overskriv i NVDB"" på Eksport v2. Denne funksjonen bør også være tilgjengelig for gruppeadmin, se NVDB-5222 for eksport v1.

Eksport v2 ble utsatt både fordi status på arbeidet er litt usikker, og fordi den ikke har kontraktsgruppe eller annen kontraktinformasjon enn ID i state, så hvis global state for React blir implementert før vi gjør denne blir det mindre endringer og mindre datalasting.",NVDB-6937,Datafangst,
Ingen popup for import på kurve,"h2. Observasjon
Viser eksisterende vegobjekter av en type som er kurve. Får ikke popup når jeg klikker på objekt, selv om musepeker er endret til peker. Ingen feilmelding i console eller nettverksrequester.

Punktobjekter virker fortsatt fint. En sjanse for at dette ble innført med NVDB-5073.",NVDB-6937,Datafangst,
Scrolling skal kun zoome i heltallsintervaller,"Ved å bruke scroll for å navigere i zoomnivåer i kartet kan man få nivåer som er mellom resolusjonen for bakgrunnskartet. Oppgaven består i å sette zoomnivåer til å kun hoppe mellom heltall, da disse representerer de ulike tile-settene vi bruker.",NVDB-6937,Vegkart,
Overgang til Atlas for API Les,"31.mars går API Les over til å bruke Atlas i alle sine miljøer. Foreløpig vil forespørsler mot autopro-miljøene i ATM og Prod bli rutet til Atlas (30x), mens de i UTV og STM vil saneres.

Nye URL-er mot API Les (merk at */nvdb/api/v3* ikke benyttes på Atlas):

Prod: [https://nvdbapiles-v3.atlas.vegvesen.no/status]

ATM: [https://nvdbapiles-v3.test.atlas.vegvesen.no/status]

STM: [https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/status|https://nvdbapiles-v3-stm.utv.atlas.vegvesen.no/]

UTV: [https://nvdbapiles-v3.utv.atlas.vegvesen.no/status]

Eksplisitt satt på eksemplet mot */status* for å markere forksjellen fra tidligere */nvdb/api/v3/status*.",NVDB-6937,Datafangst,
Ta i bruk API Skriv sin stedfestingsfunksjon,"API Skriv utvikler en stedfestingsfunksjon som videre benytter API Les sitt /rute endepunkt. Denne har bedre tilgang til riktige data enn det nå er i Datafangst, og kan også brukes av andre klienter.

Stedfesting i Skriv skal på sikt erstatte stedfestingsalgoritmen i Datafangst, men i første omgang er stedfesting med Skriv tilgjengelig bak en feature toggle.",NVDB-6937,Datafangst,
Ikke konsekvent resultat fra /veg,"h2. Observasjon

Gjentatte relastinger mot [https://www.utv.vegvesen.no/nvdb/api/v3/veg?vegsystemreferanse=RV150%20S2D1%20m5193%20KD8%20m47] gir ulike veglenkeposisjoner:

_0.33696112@625480_ og _0.34779243@625480_

Ser det samme med [https://nvdbapiles-v3.utv.atlas.vegvesen.no/veg?vegsystemreferanse=EV39%20S78D1%20m3284]",NVDB-6937,Les-API,
Backup av GitHub-repos til intern Bitbucket,"SVV har krav om at koderepoene vi har i GitHub skal sikkerhetskopieres over til intern Bitbucket ([https://git.vegvesen.no/projects/NVDBDATA]). Fra før av har vi bare Atlas-config i Bitbucket.

Aktuelle GiHub-repos (pr. 2020-03-12) er:
 * [https://github.com/nvdb-vegdata/nvdb-rapport-api]
 * [https://github.com/nvdb-vegdata/nvdb-veglister-app]
 * [https://github.com/nvdb-vegdata/nvdb-vegnett-og-objektdata-app]

Frist før sommeren? [~exta61]?",NVDB-6825,Rapportgenerator,
Åpne objekter med lukka segmenter,"Åpne objekter uten noen åpne segmenter gjør at det blir avvik mellom objektspørring og statistikkspørring.

 

Sjekk ut hvorfor noen objekter er åpne uten å ha noen åpne segmenter.

 Oppdaget ved testing av NVDB-4651

 

*Analyse*

I [https://nvdbapiles-v3.utv.atlas.vegvesen.no/] er det 32 objekter av typen 95 for kommune 4227 som har åpne objekter uten segmenter. Dette tilsvarer avviket mellom statistikkspørring og antall ved objektspørring.

Noen stikkprøver:

86181964 har stedfesting 0.99481476@121754. Veglenka som er der er lukket, veglenkenummer 82 på 121754.

86253045 har stedfesting 0.33013237@121470. Veglenka som er der er lukket, veglenkenummer 5 på 121470.

86316545 har stedfesting 0.06603622@121755. Veglenka som er der er lukket, veglenkenummer 4 på 121755.

Feilen ser ut til å skyldes datafeil. Vegobjekter har ikke fått satt sluttdato når vegnettet objektet er stedfestet på er lukket.",NVDB-6937,Les-API,
Opplasting av binærobjekter,"Sak
 En bruker har meldt inn ønske om å kunne laste opp binærfiler som brukes som type vedlegg på enkelte objekttyper. F.ex typen Dokumentasjon har en egenskap vedlegg som tar inn et binærobjekt. API Skriv støtter opplasting av binærobjekter, for deretter å bruke den returnerte referansen i den aktuelle egenskapen.
 Se [https://apiskriv.vegdata.no/binaer.html]
  
 Originalt fra bruker (Raymond Hermansen, [raymond.hermansen@vtfk.no|mailto:raymond.hermansen@vtfk.no])
{noformat}
Jeg tenker i første omgang at entreprenør har mulighet til å kunne laste opp filer i kontrakten sånn at vi har tilgang til de i Datafangst helt generelt, at jeg i det minste kan lagre på PC og ta de videre igjen. Hovedpoenget er at entreprenør har kun et sted å levere fra seg dokumentasjon tilhørende NVDB, og ikke flere steder de må laste opp filer for samme jobben og til det samme formål. Det samme gjelder da for oss som skal legge inn, dumt å måtte gå flere steder for å skrive til NVDB for samme jobben. Så det aller beste hadde selvsagt vært å kunne lagre de inn til NVDB også via Datafangst. Fremvisning/det å åpne og lese filene som allerede er lagret i NVDB, i Datafangst, er strengt tatt ikke helt nødvendig, det må vi kunne gjøre i en innloggingsløsning i Vegkart istedenfor. Skal vi kun se på filene som er levert inn så går det veldig raskt å laste de ned før de åpnes vil jeg tro.{noformat}
 Mitt svar
{noformat}
Du tenker nå på å kunne laste opp bilder som skal registreres som en egenskap på enkelte objekter? Altså at du har en objekttype som har en egenskap av typen binær-data (f.ex et png-bilde), og ønsker å registrere dette objektet med bildet som egenskap? 
Som API Skriv dokumenterer her: https://apiskriv.vegdata.no/binaer.html 
For du tenker ikke å kunne lagre bilder/dokumenter knyttet til kontrakten som kun skal lastes opp, ligge som type “vedlegg” i kontrakten, og lastes ned fra Datafangst ved behov?
{noformat}
 Svar fra bruker
{noformat}
Tror jeg forstår hva du spør om, det er ikke tenkt at det skal ligge masse dokumenter som tilhører et prosjekt nei, kun en og annen fil som er naturlig å linke opp mot et NVDB objekt og typisk mest via Driftskontrakter. Der det for større prosjekter er mange filer som med fordel kan kobles til NVDB objekter så lagres det et sted på prosjektserveren uansett og fås tak i der, så det blir en helt annen greie. Ellers så stemmer det du skriver om egenskap til et objekt når det skal lagres inn til NVDB, det kan her tenkes minst to fremtidige løp egentlig. Det du beskriver, legge på en fil inn under objektet Dokumentasjon som en egenskap og at Dokumentasjon da ligger på som en datter til et annet objekt, her snakker vi da om å være datter til Skred og fila kan være en word-/PDF-fil med flere bilder i, eller kun en bildefil. Det kan også tenkes at filene som leveres inn via Datafangst lastes over i en annen lagringsløsning etterhvert for de forskjellige etatene og at det der ifra opprettes en link til fila, også det som en egenskap på et objekt. Det siste her kan jo kanskje løses på andre vis senere, lagres rett på aktuell server og at det opprettes link samtidig f.eks. Uansett ved begge disse løpene så kan det jo tenkes at Datafangst automatisk sletter disse vedleggsfilene når vi arkiverer kontraktene, om det skulle være at dere tenke på lagringskapasitet via Datafangst, men det blir jo ikke vanvittige mengder av filer her sånn jeg tenker da.
{noformat}
 ",NVDB-6937,Datafangst,
Oppgradere GeoTools,Vi bruker en flere år gammel versjon av GeoTools. Oppgradering krever noe kodeendring pga. endrede pakkenavn.,NVDB-6937,Datafangst,
Rulle tilbake «nested path»,Bruken av NestPathField som ble introdusert i NVDB-4342 har negtive konsekvenser for ytelsen. ,NVDB-6937,NVDB-IND,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5246: Verifiser visning i kart ihht sakens testbeskrivelse
 * NVDB-5073: Test importmodul i datafanen
 * NVDB-5248: Utfør påfølgende lukkinger og sjekk at første ikke blir med på andre
 * NVDB-4842: Importer objekt og manipuler datter-relasjonen samtidig som man observerer riktig tilstand i databasen
 * NVDB-5279: Verifiser at vedlagte featurecollections lar seg importere

NVDB-4848 trenger ikke å testes.",NVDB-6937,Datafangst,
Innlesing av områdegrenser med API Skriv,"h2. Bakgrunn

Fra 2006 til i dag har vi brukt innlesingsprogrammet VDBImporter til å oppdatere områdegrenser i NVDB (Fylkesgrenser og Kommunegrenser). Disse mottar vi fra Kartverket på SOSI-format. Det kan være både grensejusteringer og sammenslåinger som krever oppdatering av grensene i NVDB.

Det er flere svakheter ved dette, bl.a. lang tidsbruk på innlesing og ingen støtte for enklaver eller kommuner som er sammenslått, men som ikke grenser til hverandre (eks. Kinn kommune).

Fra Hans Anton: Dette programmet er så vidt jeg vet ikke rørt siden ca. 2006, da NVDB ble etablert. Siden klassisk NVDB skal fases ut, er det uansett naturlig og på høy tid at dette nå kan håndteres i Skriv. Om det må lages en ny funksjon, eller om f.eks. Datafangst eller NVDB Vegnett kan formidle dette som en enkel Korriger-operasjon på Kommune- og Fylke-objekter, gjenstår å se.

Eksempler på enklaver og eksklaver i Norge: https://no.wikipedia.org/wiki/Enklave_og_eksklave

Legger også ved kartutsnitt over Kinn kommune (rødt).

Vi ber altså om at Skriv ser på muligheten for å håndtere disse områdegrensene framover.

h2. Analyse

Om dette handler om å tillate korrigering av geometrien til Fylke- og Kommune-objekter, er dette enkel sak å implementere. Fylke- og Kommune-objekter er i dag blokkert for oppdatering gjennom API Skriv, så de må avblokkeres, men bare for geometriutskiftning.

Her trenger vi flere detaljer, gjerne dokumentasjon på VDB Importer.

Estimat: 1 dv (gitt forutsetningen over).",NVDB-6938,Skriv-API,
"NVDBREF-547 : Forskjell på Edge og Chrome, i visning av objektdetaljer","Hei!
 Har fått ny Edge, uten at jeg har tenkt noe over om det er forskjell fra den gamle. Men en liten observasjon jeg gjorde nå:
 Henter inn den samme linken i Edge og i Chrome:
 [https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/hva:(~(farge:'0_0,id:919),(farge:'1_1,id:920))/hvor:(vegsystemreferanse:(~'E6))/@286398,6689825,15/vegobjekt:1004496343:40a744:919]

 

 

I Edge kommer det opp informasjon om Assosierte Sideanleggsdel, merket i gult. Dette kommer ikke opp i Chrome. Tilsvarende skjer om jeg ser på skiltpunkt som også har assosierte objekter. Litt rart, eller?

Mvh Linda",NVDB-6937,Vegkart,
"NullPointerException ved Publisering: Normal uoff, Trøndelag","Fra loggen (UTV):

2020-03-11 08:15:10,437 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-7) Veglister request 905,[50],[],[FV, KV],2020-03-11,nb_NO,true...
 2020-03-11 08:15:10,438 INFO [no.veg.nvd.val.VeglisteValidator] (vert.x-worker-thread-7) 2020-03-11 -> Wed Mar 11 00:00:00 CET 2020
 2020-03-11 08:15:10,438 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-7) Added job 73380886-60e9-494d-98ba-253246d65833 with TTL PT30M
 2020-03-11 08:15:10,438 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-7) Purge expired jobs...
 2020-03-11 08:15:10,439 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-7) Veglister returns response status 202
 2020-03-11 08:15:10,439 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) Starting download of data from NVDB
 2020-03-11 08:15:10,578 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Login successful
 2020-03-11 08:15:11,940 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 915, 1 out of 8
 2020-03-11 08:15:31,527 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 9022 objects of type 915
 2020-03-11 08:15:31,527 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 916, 2 out of 8
 2020-03-11 08:15:38,779 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 14436 objects of type 916
 2020-03-11 08:15:38,779 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 917, 3 out of 8
 2020-03-11 08:15:39,233 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 186 objects of type 917
 2020-03-11 08:15:39,233 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 918, 4 out of 8
 2020-03-11 08:15:39,363 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 192 objects of type 918
 2020-03-11 08:15:39,363 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 919, 5 out of 8
 2020-03-11 08:15:39,439 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 43 objects of type 919
 2020-03-11 08:15:39,439 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 920, 6 out of 8
 2020-03-11 08:15:39,522 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 46 objects of type 920
 2020-03-11 08:15:39,523 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 577, 7 out of 8
 2020-03-11 08:15:41,995 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 24 objects of type 577
 2020-03-11 08:15:41,996 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Preparing to fetch data for 905, 8 out of 8
 2020-03-11 08:15:51,882 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Fetched 9598 objects of type 905
 2020-03-11 08:15:51,882 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) 33547 features found
 2020-03-11 08:15:51,908 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) Starting download of roadnet from NVDB
 2020-03-11 08:16:09,216 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) Downloaded 63793 segments on main network. Fetching any missing segmentlinks.
 2020-03-11 08:16:15,360 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-12) 0 additional Segmentlinks found.
 2020-03-11 08:16:15,360 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) 63793 segments found
 2020-03-11 08:16:15,360 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) Creating segments
 2020-03-11 08:17:43,942 INFO [no.svv.vei.eng.ReportGenerator] (Thread-12) 65111 additional segments created
 2020-03-11 08:17:43,943 INFO [no.svv.vei.eng.seg.SegmentPopulator] (Thread-12) Starting populating 128904 segments using 33547 roadObjects
 2020-03-11 08:18:21,375 INFO [no.svv.vei.eng.seg.SegmentPopulator] (Thread-12) Basic properties added, adding details and filtering.
 2020-03-11 08:18:22,081 ERROR [no.veg.nvd.RapportResource] (Thread-12) Handling exception for job 73380886-60e9-494d-98ba-253246d65833: java.util.concurrent.CompletionException: java.lang.NullPointerException
 at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
 at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
 at java.lang.Thread.run(Thread.java:748)
 Caused by: java.lang.NullPointerException
 at no.svv.veirapporter.engine.models.derivedvalueproviders.WinterUseClassProvider.deriveValue(WinterUseClassProvider.java:23)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.assignDerivedValue(SegmentPopulator.java:100)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.lambda$addDerivedValues$16(SegmentPopulator.java:96)
 at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
 at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
 at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
 at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
 at java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)
 at java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:401)
 at java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:734)
 at java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:159)
 at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:173)
 at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
 at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:485)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.addDerivedValues(SegmentPopulator.java:96)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.lambda$populateSegments$8(SegmentPopulator.java:56)
 at java.util.stream.ReferencePipeline$11$1.accept(ReferencePipeline.java:439)
 at java.util.stream.ReferencePipeline$11$1.accept(ReferencePipeline.java:440)
 at java.util.stream.ReferencePipeline$11$1.accept(ReferencePipeline.java:440)
 at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
 at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
 at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
 at java.util.stream.ReduceOps$ReduceTask.doLeaf(ReduceOps.java:747)
 at java.util.stream.ReduceOps$ReduceTask.doLeaf(ReduceOps.java:721)
 at java.util.stream.AbstractTask.compute(AbstractTask.java:327)
 at java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)
 at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
 at java.util.concurrent.ForkJoinPool.helpComplete(ForkJoinPool.java:1870)
 at java.util.concurrent.ForkJoinPool.externalHelpComplete(ForkJoinPool.java:2467)
 at java.util.concurrent.ForkJoinTask.externalAwaitDone(ForkJoinTask.java:324)
 at java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:405)
 at java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:734)
 at java.util.stream.ReduceOps$ReduceOp.evaluateParallel(ReduceOps.java:714)
 at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
 at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
 at no.svv.veirapporter.engine.segmentation.SegmentPopulator.populateSegments(SegmentPopulator.java:59)
 at no.svv.veirapporter.engine.ReportGenerator.getReport(ReportGenerator.java:117)
 at no.svv.veirapporter.engine.ReportGenerator.createReport(ReportGenerator.java:81)
 at no.vegvesen.nvdbrapportapi.RapportService.getVegliste(RapportService.java:105)
 at no.vegvesen.nvdbrapportapi.RapportService_ClientProxy.getVegliste(RapportService_ClientProxy.zig:38)
 at no.vegvesen.nvdbrapportapi.RapportResource.lambda$getVeglister$0(RapportResource.java:117)
 at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)
 ... 1 more",,Rapportgenerator,
Geometrifeil ved import av objekter i e-API,"h2. Observasjon

Import av NVDB-objekt gir feil. Kan det ha en sammenheng med at API Les i ATM nå gir 5973 som srid?
{noformat}
{ ""type"": ""FeatureCollection"", ""features"": [{ ""type"": ""Feature"", ""properties"": { ""comment"": ""1"", ""dataCatalogVersion"": ""2.14"", ""nvdbVersion"": 3, ""typeId"": 95, ""tag"": ""85467073"", ""attributes"": {}, ""operation"": ""CORRECT"", ""nvdbId"": 85467073 } }] }
{noformat}
feiler med:
{noformat}
https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.6-2020.03.10/doc/?id=khyXxHABir-TAgFFck9-{noformat}
respons fra API Les:
{noformat}
https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.6-2020.03.10/doc/?id=ohyXxHABir-TAgFFck9_
{noformat}
*Observasjon # 2*

Samme resultat ved import av et rekkverk:
{noformat}
{ ""type"": ""FeatureCollection"", ""features"": [{ ""type"": ""Feature"", ""properties"": { ""comment"": ""1"", ""dataCatalogVersion"": ""2.14"", ""nvdbVersion"": 4, ""typeId"": 5, ""tag"": ""78772629"", ""attributes"": {}, ""operation"": ""CORRECT"", ""nvdbId"": 78772629 } }] }
{noformat}
Kibana: 
{noformat}
https://vegdata.kantega.no/kibana/app/kibana#/doc/datafangst-logs-*/datafangst-logs-utv-beats-6.8.6-2020.03.10/doc/?id=4RyyxHABir-TAgFFueh5
{noformat}

h2. Analyse
Det feiler ved konvertering av koordinater fordi vi ikke får ut noen verdi for ""axis order"" for UTM33 + NN2000. Det finnes en definisjon av denne i JTS, men den virker ikke likt som de vi har lagt inn selv. Muligens fordi dette er en compound definisjon.

h2. Løsning
Legger inn en fil for SRID 5973 i plugins/geodetics/src/main/resources/crs-definitions tilsvarende den vi har for UTM 33 + NN54. På sikt burde vi sett på om vi får hentet axis order ut fra definisjoner bundlet med JTS.",NVDB-6937,Datafangst,
Lengde under lokasjon blir 0,"h2. Observasjon

Eksempelvis [https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/105?antall=7500&egenskap=(area(946,3430))&vegsystemreferanse=FV30&segmentering=true&inkluder=alle] (også for segmentering=false) blir lengde 0 under lokasjon.

Observerer det samme ved å gå direkte på et av objektene: [https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/105/88320495/1]",NVDB-6937,Les-API,
Finner ingen objekter ved å oppgi strekningsmeter eksakt,"h2. Observasjon

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/918/1004493429/1]

gir strekningsmeter 1293.181 og kortform _FV6660 S2D1 m1293 KD1 m0-85_

Oppslag på

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/918?antall=16&vegsystemreferanse=FV6660S2D1M1293&inkluder=lokasjon&inkludergeometri=ingen]

gir ingen treff, mens det blir treff ved å bruke intervall

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/918?antall=16&vegsystemreferanse=FV6660S2D1M1293-1294&inkluder=lokasjon&inkludergeometri=ingen]

Får imidlertid treff ved å legge til kryssystemet:

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/918?antall=16&vegsystemreferanse=FV6660S2D1M1293KS1002&inkluder=lokasjon&inkludergeometri=ingen]",NVDB-6937,Les-API,
Irregulær geometri blir innsendt til Skriv,"h2. Observasjon

Innlasting av vedlagt SOSI gjør at Datafangst reagerer i filfanen og sier at SOSI inneholder en feil av type ""irregulær geometri"". Objektet blir likevel importert og kan registreres. Men da vil API Skriv avvise registreringen med ""irregulær geometri"".

Datafangst burde ikke tatt inn dette objektet - evt flagget det på datafanen eller i eksportfanen i tillegg til filfanen. Skriv gir i hvertfall beskjed om irregulær geometri gjennom /validator-kallet ved opplasting (se svaret under)

Det er flere eksempler på slike kontrakter. En av disse er Trafikklomme i [https://datafangst.kantega.no/#!/contract/487e4c20-cf49-4a39-a5a8-a304bc1ef713/files]

Endringssett: [https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/0d553deb-4db0-4c71-9aa2-4dc1679f45cf]

Svar som fås fra Skriv
{noformat}
<status xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><mottatt>2020-03-20T10:01:52.039</mottatt><fremdrift>AVVIST</fremdrift><fremdriftOppdatert>2020-03-20T10:01:52.039</fremdriftOppdatert><avvistårsak>VALIDERINGSFEIL</avvistårsak><etterbehandling><tilgjengeligILes>false</tilgjengeligILes></etterbehandling><resultat><feil/><advarsler/><notabener/><vegobjekter><vegobjekt tempId=""724aa0eb-c501-43fa-9086-cc8cb23f7e78""><feil><feil kode=""IRREGULÆR_GEOMETRI""><melding>Geometrien har irregulær form: Geometrien krysser seg selv</melding><referanse>https://datakatalogen.vegdata.no/47</referanse><egenskapTypeId>5900</egenskapTypeId><geometrideler srid=""5973""><wkt>POINT (265598.0655644346 7103056.74404415)</wkt></geometrideler></feil></feil><advarsler/><notabener/></vegobjekt></vegobjekter><veglenkesekvenser/><noder/></resultat><eier>tjedatafangst_nvdbapiskriv</eier><klient>Datafangst</klient><apiversjon>3</apiversjon><transaksjon/></status>
{noformat}",NVDB-6937,Datafangst,
Gi valideringsfeil på høydekoordinater utenfor Skriv sine grenser,"h2. Observasjon

Datafangst tar ikke hensyn til valideringsfeil fra Skriv. Dersom det ligger (typisk) feilregistreringer i geometrien for objekter som er utenfor min og max grensene til API Skriv vil disse registreringene bli avvist - både i validering ved filopplasting og ved innsending. Her er valideringsrespons fra Skriv
{noformat}
<status xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><mottatt>2020-03-20T11:06:53.01</mottatt><fremdrift>AVVIST</fremdrift><fremdriftOppdatert>2020-03-20T11:06:53.01</fremdriftOppdatert><avvistårsak>VALIDERINGSFEIL</avvistårsak><etterbehandling><tilgjengeligILes>false</tilgjengeligILes></etterbehandling><resultat><feil/><advarsler/><notabener/><vegobjekter><vegobjekt tempId=""a16c6dd5-fe50-436e-8783-c552f264d37a""><feil><feil kode=""HØYDE_UTENFOR_GYLDIGHETSOMRÅDE""><melding>Vegobjektet har geometri med høyde-koordinat(er) utenfor gyldig verdiområde -500.0 m - 3000.0 m</melding><referanse>https://datakatalogen.vegdata.no/13</referanse><egenskapTypeId>4721</egenskapTypeId></feil></feil><advarsler><advarsel kode=""MANGLER_BETINGET_PÅKREVDE_EGENSKAPER""><melding>Objektet, av typen Port/Dør (13), mangler egenskaper med viktighet 'betinget': [Branndør (3509)]</melding><referanse>https://datakatalogen.vegdata.no/13</referanse></advarsel></advarsler><notabener/></vegobjekt></vegobjekter><veglenkesekvenser/><noder/></resultat><eier>tjedatafangst_nvdbapiskriv</eier><klient>Datafangst</klient><apiversjon>3</apiversjon><transaksjon/></status>
{noformat}
Grensene til API Skriv er min -500 og max 3000 for høydekoordinatene.

Det er flere eksempler på at endringssett er avvist i Skriv, og bruker har ikke noen mulighet til å endre på dette - bortsett fra a manuelt endre objektene før registrering i Datafangst (men da mister brukeren det som er gjort av endringer i Datafangst).

Eksempel endringssett: [https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/54111973-67c4-4fb2-bbf4-b81ba5e5629d]

(hvor et av punktene har koordinat 229212.0771766245 6952109.619714831 4999.897259613275).

Et annet eksempel er fra kontrakt 8f14f6b6-0412-4b7f-8f73-eed4938674de hvor problemobjekt er vedlagt i SOSI for å gjenskape problemet.",NVDB-6937,Datafangst,
Value is not an Enum,"Log fra PROD:

2020-03-09 13:19:53,201 INFO  [no.veg.nvd.RapportResource] (vert.x-worker-thread-13) Veglister request 889,[],[5028],[],2020-03-09,nb_NO,false...
2020-03-09 13:19:53,201 INFO  [no.veg.nvd.RapportResource] (vert.x-worker-thread-13) Setting vegsystemreferanse '[]' to null
2020-03-09 13:19:53,201 INFO  [no.veg.nvd.val.VeglisteValidator] (vert.x-worker-thread-13) 2020-03-09 -> Mon Mar 09 00:00:00 CET 2020
2020-03-09 13:19:53,201 INFO  [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-13) Added job bf58eff0-60a4-4738-a5d6-147bb47c85c3 with TTL PT30M
2020-03-09 13:19:53,201 INFO  [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-13) Purge expired jobs...
2020-03-09 13:19:53,202 WARN  [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-13) Purge removed 4 expired jobs: a7762340-3f7b-4540-9c34-9dfa6fe7bf5b (SUCCESS), 71ba7145-eb95-4cfd-b314-3b3d5b951e5c (SUCCESS), 9b5d9f09-a62f-4b80-a471-797e3df076c6 (SUCCESS), 3753a32a-2d09-4d43-94eb-92e4f18c0b9b (SUCCESS). Timetolive is configured to 30 Minutes - consider increasing it
2020-03-09 13:19:53,202 INFO  [no.veg.nvd.RapportResource] (vert.x-worker-thread-13) Veglister returns response status 202
2020-03-09 13:19:53,203 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Starting download of data from NVDB
2020-03-09 13:19:54,330 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 915, 1 out of 8
2020-03-09 13:20:10,426 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 207 objects of type 915
2020-03-09 13:20:10,426 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 916, 2 out of 8
2020-03-09 13:20:19,743 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 331 objects of type 916
2020-03-09 13:20:19,744 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 917, 3 out of 8
2020-03-09 13:20:19,805 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 14 objects of type 917
2020-03-09 13:20:19,805 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 918, 4 out of 8
2020-03-09 13:20:19,947 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 26 objects of type 918
2020-03-09 13:20:19,947 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 919, 5 out of 8
2020-03-09 13:20:20,000 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 0 objects of type 919
2020-03-09 13:20:20,002 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 920, 6 out of 8
2020-03-09 13:20:20,022 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 0 objects of type 920
2020-03-09 13:20:20,022 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 577, 7 out of 8
2020-03-09 13:20:20,854 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 5 objects of type 577
2020-03-09 13:20:20,855 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Preparing to fetch data for 889, 8 out of 8
2020-03-09 13:20:21,582 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Fetched 8 objects of type 889
2020-03-09 13:20:21,582 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) 591 features found
2020-03-09 13:20:21,582 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Starting download of roadnet from NVDB
2020-03-09 13:20:24,680 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) Downloaded 1896 segments on main network. Fetching any missing segmentlinks.
2020-03-09 13:20:24,683 INFO  [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-31) 0 additional Segmentlinks found.
2020-03-09 13:20:24,683 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) 1896 segments found
2020-03-09 13:20:24,683 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Creating segments
2020-03-09 13:20:24,823 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) 1913 additional segments created
2020-03-09 13:20:24,824 INFO  [no.svv.vei.eng.seg.SegmentPopulator] (Thread-31) Starting populating 3809 segments using 591 roadObjects
2020-03-09 13:20:24,841 INFO  [no.svv.vei.eng.seg.SegmentPopulator] (Thread-31) Basic properties added, adding details and filtering.
2020-03-09 13:20:24,872 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Segments populated and filtered. 266 segments remain
2020-03-09 13:20:24,872 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Starting to merge segments
2020-03-09 13:20:24,873 INFO  [no.svv.vei.eng.seg.Merger] (Thread-31) Starting to merge 266 segments
2020-03-09 13:20:24,876 INFO  [no.svv.vei.eng.seg.Merger] (Thread-31) Done merging 266 segments into 4 segments
2020-03-09 13:20:24,876 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Merging segments complete
2020-03-09 13:20:24,877 INFO  [no.svv.vei.eng.ReportGenerator] (Thread-31) Sorting and segmenting report
2020-03-09 13:20:24,877 ERROR [no.veg.nvd.RapportResource] (Thread-31) Handling exception for job bf58eff0-60a4-4738-a5d6-147bb47c85c3: java.util.concurrent.CompletionException: java.lang.IllegalArgumentException: Value is not an enum
	at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273)
	at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280)
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606)
	at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.IllegalArgumentException: Value is not an enum
	at no.svv.veirapporter.engine.models.SegmentValue.enumValue(SegmentValue.java:78)
	at no.svv.veirapporter.engine.reports.roadreport.ModuleTruckRoadReport.enrichReportLine(ModuleTruckRoadReport.java:47)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)
	at java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)
	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)
	at java.util.concurrent.ForkJoinTask.doInvoke(ForkJoinTask.java:401)
	at java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:734)
	at java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:159)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:173)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:485)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:650)
	at no.svv.veirapporter.engine.reports.roadreport.AbstractRoadReportDefinition.finalizeReport(AbstractRoadReportDefinition.java:147)
	at no.svv.veirapporter.engine.ReportGenerator.calculateSegments(ReportGenerator.java:135)
	at no.svv.veirapporter.engine.ReportGenerator.getReport(ReportGenerator.java:120)
	at no.svv.veirapporter.engine.ReportGenerator.createReport(ReportGenerator.java:81)
	at no.vegvesen.nvdbrapportapi.RapportService.getVegliste(RapportService.java:105)
	at no.vegvesen.nvdbrapportapi.RapportService_ClientProxy.getVegliste(RapportService_ClientProxy.zig:38)
	at no.vegvesen.nvdbrapportapi.RapportResource.lambda$getVeglister$0(RapportResource.java:117)
	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1604)
	... 1 more
",,Rapportgenerator,
Multiple vegsystemreferanser og vegsegmenter som er helt like,"h2. Observasjon

Eksemplene under gir mange vegsystemreferanser tilbake som er helt like (kun med vegsystem).

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/174?antall=14&inkluder=lokasjon&inkludergeometri=ingen&kommune=301]

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/3?antall=14&inkluder=lokasjon&inkludergeometri=ingen&kommune=301]

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/7?antall=14&inkluder=lokasjon,vegsegmenter&inkludergeometri=ingen&kommune=301]

Hvis man hiver på _&inkluder=vegsegmenter_ så kommer det mange duplikate segmenter også. F.ex

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/7?antall=14&inkluder=lokasjon,vegsegmenter&inkludergeometri=ingen&kommune=301]

Annet eksempel. Se forskjellen i vegsystemreferanser for objektet 88320495 ved segmentering false vs true:

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/105?antall=7500&egenskap=(area(946,3430))&vegsystemreferanse=FV30&segmentering=false&inkluder=alle]

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/105?antall=7500&egenskap=(area(946,3430))&vegsystemreferanse=FV30&segmentering=true&inkluder=alle]",NVDB-6937,Les-API,
Release,"Release [nvdb-rapport-api|https://github.com/nvdb-vegdata/nvdb-rapport-api] slik at vi har god nok kontroll på hva som går i prod.

Front-end i egne saker.",NVDB-6825,Rapportgenerator,
"PROD: søk på Normaltrafikk, Stad (4649) feilet med org.apache.http.ConnectionClosedException: Premature end of chunk coded message body: closing chunk expected","Kommune 4649 er Stad.

Bruker prøvde på nytt og det så ut til å fungere da.

Undersøke hva dette var...

Log:

{color:#c1c7d0}2020-03-09 10:41:08,541 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-15) Veglister request 904,[],[4649],[FV],2020-03-09,nb_NO,false...{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,543 INFO [no.veg.nvd.val.VeglisteValidator] (vert.x-worker-thread-15) 2020-03-09 -> Mon Mar 09 00:00:00 CET 2020{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,543 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-15) Added job 6dcb6dd2-bf73-4f29-ae5d-042c336dcfe5 with TTL PT30M{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,543 INFO [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-15) Purge expired jobs...{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,543 WARN [no.veg.nvd.job.ReportJobManager] (vert.x-worker-thread-15) Purge removed 2 expired jobs: 8403f7f7-1539-46f2-8b57-7291196ea7f1 (SUCCESS), 0f5411f6-797a-4910-8b4f-15a43280f86a (SUCCESS). Timetolive is configured to 30 Minutes - consider increasing it{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,543 INFO [no.veg.nvd.RapportResource] (vert.x-worker-thread-15) Veglister returns response status 202{color}
 {color:#c1c7d0} 2020-03-09 10:41:08,544 INFO [no.svv.vei.eng.ReportGenerator] (Thread-25) Starting download of data from NVDB{color}
 {color:#c1c7d0} 2020-03-09 10:41:09,899 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 915, 1 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:24,279 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 44 objects of type 915{color}
 {color:#c1c7d0} 2020-03-09 10:41:24,279 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 916, 2 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:31,212 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 64 objects of type 916{color}
 {color:#c1c7d0} 2020-03-09 10:41:31,213 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 917, 3 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:36,058 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 0 objects of type 917{color}
 {color:#c1c7d0} 2020-03-09 10:41:36,059 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 918, 4 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:36,092 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 0 objects of type 918{color}
 {color:#c1c7d0} 2020-03-09 10:41:36,092 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 919, 5 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,083 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 1 objects of type 919{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,083 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 920, 6 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,182 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 1 objects of type 920{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,183 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 577, 7 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,908 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 24 objects of type 577{color}
 {color:#c1c7d0} 2020-03-09 10:41:37,909 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Preparing to fetch data for 904, 8 out of 8{color}
 {color:#c1c7d0} 2020-03-09 10:41:39,036 INFO [no.svv.vei.dat.rep.NvdbRoadObjectRepository] (Thread-25) Fetched 31 objects of type 904{color}
 {color:#c1c7d0} 2020-03-09 10:41:39,037 INFO [no.svv.vei.eng.ReportGenerator] (Thread-25) 165 features found{color}
 {color:#c1c7d0} 2020-03-09 10:41:39,037 INFO [no.svv.vei.eng.ReportGenerator] (Thread-25) Starting download of roadnet from NVDB{color}

{color:#c1c7d0}2020-03-09 10:42:47,851 ERROR [no.veg.nvd.RapportResource] (Thread-25) Handling exception for job 6dcb6dd2-bf73-4f29-ae5d-042c336dcfe5: java.util.concurrent.CompletionException: HTTP error 200 for request 20de6a6d-1d97-a018-0538-4f0c143315a2:{color}
 {color:#c1c7d0} at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:273){color}
 {color:#c1c7d0} at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:280){color}
 {color:#c1c7d0} at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1606){color}
 {color:#c1c7d0} at java.lang.Thread.run(Thread.java:748){color}
 {color:#c1c7d0} Caused by: HTTP error 200 for request 20de6a6d-1d97-a018-0538-4f0c143315a2:{color}
 {color:#c1c7d0} at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:113){color}
 {color:#c1c7d0} at no.vegvesen.nvdbapi.client.clients.AsyncResult.lambda$null$0(AsyncResult.java:52){color}
 {color:#c1c7d0} at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149){color}
 {color:#c1c7d0} at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624){color}
 {color:#c1c7d0} ... 1 more{color}
 {color:#c1c7d0} Caused by: org.apache.http.ConnectionClosedException: Premature end of chunk coded message body: closing chunk expected{color}
 {color:#c1c7d0} at org.apache.http.impl.io.ChunkedInputStream.getChunkSize(ChunkedInputStream.java:263){color}
 {color:#c1c7d0} at org.apache.http.impl.io.ChunkedInputStream.nextChunk(ChunkedInputStream.java:222){color}
 {color:#c1c7d0} at org.apache.http.impl.io.ChunkedInputStream.read(ChunkedInputStream.java:183){color}
 {color:#c1c7d0} at org.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:135){color}
 {color:#c1c7d0} at java.io.BufferedInputStream.read1(BufferedInputStream.java:284){color}
 {color:#c1c7d0} at java.io.BufferedInputStream.read(BufferedInputStream.java:345){color}
 {color:#c1c7d0} at java.io.FilterInputStream.read(FilterInputStream.java:133){color}
 {color:#c1c7d0} at java.io.BufferedInputStream.read1(BufferedInputStream.java:284){color}
 {color:#c1c7d0} at java.io.BufferedInputStream.read(BufferedInputStream.java:345){color}
 {color:#c1c7d0} at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284){color}
 {color:#c1c7d0} at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326){color}
 {color:#c1c7d0} at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178){color}
 {color:#c1c7d0} at java.io.InputStreamReader.read(InputStreamReader.java:184){color}
 {color:#c1c7d0} at com.google.gson.stream.JsonReader.fillBuffer(JsonReader.java:1291){color}
 {color:#c1c7d0} at com.google.gson.stream.JsonReader.nextNonWhitespace(JsonReader.java:1329){color}
 {color:#c1c7d0} at com.google.gson.stream.JsonReader.doPeek(JsonReader.java:468){color}
 {color:#c1c7d0} at com.google.gson.stream.JsonReader.hasNext(JsonReader.java:415){color}
 {color:#c1c7d0} at no.vegvesen.nvdbapi.client.clients.AsyncResult.doPage(AsyncResult.java:87){color}
 {color:#c1c7d0} ... 4 more{color}

 

 ",,Rapportgenerator,
NVDBREF-531: Kombinere oppdatering med korrigering (samme objekt),"h2. Bakgrunn

Fra SVV-Jira: 
Saken er opprettes som resultat av analyse i NVDBREF-491.
Bruker ville korrigere stedfesting til et objekt før dette skulle lukkes. (Grunnen var at det ikke var snappet korrekt til en port og dette ga feilmelding i NVDB Vegnett).

Det gitte caset er ikke mulig med dagens SKRIV api.
I Klassisk klient API hadde NVDB Vegnett kontroll på versjoner.
Dette er nå litt vanskelig å få til og SKRIV bør endres som beskrevet under.
 
Fra Richard:
Et det mulig å få alt dette til med en endringssett? * Korriger versjon 1 
Oppdater versjon 1 => Skriv oppretter versjon 2 på serveren
Lukk versjon 2 => vil Skriv finne versjon 2?
 
Svar fra Tore:
Per i dag må dette caset realiseres med to separat endringssett, fordi oppdatering ikke kan kombineres med korrigering. Dette er en begrensning som ble etablert i API Skriv sin barndom (2014), og jeg tror ikke det ville vært en stor jobb å implementere støtte for det i dag. Det må i så fall bestilles.

h2. Analyse

Følgeoppdateringene i API Skriv genererer allerede korrigeringer av historiske versjoner samtidig som det oppdateres (lages ny versjon) på samme vegobjekt. Hoveddelen av maskineriet skulle derfor være på plass. Mulig det eneste som må gjøres er å fjerne noen Bean Validation-annotasjoner.

Estimat: 4 dv.

h2. Løsning

* (/) Fjern bean validations som hindrer korrigering og oppdatering på samme vegobjekt.
* (/) Endre PartialFeatureEnricherJobFilter til å ta utgangspunkt i korrigert siste versjon ved delvisOppdatering, dersom det finnes i endringssettet.
* (/) Endre PrepareForModifyEnricherFilter til å ta utgangspunkt i korrigert siste versjon ved validering og generering av beriking, dersom det finnes i endringssettet.
",NVDB-6937,Skriv-API,
NVDBREF-502: Ikke forenkle (slå sammen) stedfesting for Kryssdel i rundkjøring,"h2. Bakgrunn

Fra SVV-Jira. NB! der der det bilder og eksempler som kan være nyttige. 
Rundkjøringer er  en lenkesekvens som biter seg selv i halen og har utstrekning 0-1.
Når vi stedfester Kryssdel-objektet i NVDB Vegnett velger vi startpunktet for objektet der hvor kjørebane fra tilstøtende veg treffer rundkjøringen. I mange tilfeller er dette startpunktet i port 1 til rundkjøringen, mens i andre tilfeller er det en helt annen port.
I de andre tilfellene stedfester vi en ""rute"" langs hele rundkjøringen med definert start- og sluttpunkt. Siden startpunktet er ulik port 1 vil stedfestingen blir delt opp i to. Det kan for eksempel være 0.5-1 + 0-0.5.
(Se vedlagt bilde av rundkjøring før og etter at ny kryssdel med ny stedfesting ble definert.)
I innsjekket vil imidlertid API Skriv slå dette sammen til 0-1. Og da mister vi det definerte startpunktet til rundkjøringen.
Dette vises som en notabenemelding: 
0: FORENKLET_STEDFESTING Stedfestingen ble forenklet fra 2 til 1 verdi
Markør navn: Kryssdel (-3)
Vi trenger et unntak for rundkjøringer.
Eksempel: https://www.test.vegvesen.no/nvdb/apiskrivbeta/kontrollpanel/#/jobs/view/75041e83-fecd-4235-bfe2-21cc5fdac6f2

h2. Analyse

Forenkling av stedfesting skjer i OptimizeLocationalAttributeFilter. For å avgjøre om forenkling skal skje må vi vite lenkesevensens typeVeg. Vegnettet leses imidlertid ikke inn i jobben før lenge senere i dagens pipeline (BeforeLockingPipeline).

I mange filtere sammenlignes gammel og ny verdi for egenskaper (korrigering og oppdatering) og disse kan forutsette at optimalisering/forenkling er gjennomført. Dersom optimaliseringfilteret flyttes til etter NetworkEnricherFilter, må vi sikre at dette ikke skaper trøbbel ved sammenligning av stedfestinger.

Alternativet til å flytte OptimizeLocationalAttributeFilter er å hente inn typeVeg for berørt vegnett rett fra NVDB. Dette er bare realistisk dersom antallet slik database-søk er relativt lite. Her er det jo kun snakk om Kryssdel-objekter.

Estimat: 4 dv

h2. Løsning

Flyttet OptimizeLocationalAttributeFilter til etter NetworkEnricherFilter. La inn sjekk på om vegobjektet er av type Kryssdel og er stedfestet på veglenker med typeVeg rundkjøring. I så fall returneres false fra shouldOptimize().",NVDB-6937,Skriv-API,
NVDBREF-401: Fjerne eksisterende noder og koblinger,"h2. Bakgrunn
 
Saken er overført fra https://jira.kantega.no/browse/VEGREF-334

I dag bruker vi SQL-script for å slette noder som er skaper trøbbel for en vegnettsbruker. Det kan være feilplasserte noder, noder som er koblet til flere porter på en lenkesekvens, noder som er koblet til ""historikk-grums"" fra VDB eller noder som kobler sammen lenker som egentlig skulle vært i to plan.
Ulempen med script-løsning er at brukeren må begynne jobben på nytt om man kommer i en fastlåst node-situasjon.
Det er grunn til å tro at når vegnettsbrukerne skal få inn all historikk fra NVDB i framtidige modeller så vil man kunne støte på slik nodeproblematikk oftere.
Vi ser ingen opplagt grunn til at det ikke skal være mulig å slette en node i NVDB Vegnett på samme måte som med script.
For NVDB Vegnett sin del er dette en liten jobb (1-2 timer). Noden vil bli merket som slettet og alle knytninger mellom noden og lenkesekvensene blir fjernet. I mange tilfeller skal det registreres en ny node med riktige koblinger som erstatning.
Noder er heller ikke bærere av data/objekter så ingen følgeoppdateringer er nødvendige. Det kan imidlertid være svingerestriksjoner knyttet til noder, dette må håndteres.
Vi ønsker at Skriv gjør en vurdering av denne saken.

h2. Analyse

Fjerning av noder innebærer ""ingen"" følgeoppdateringer, siden det ikke stedfestes vegobjekter på noder (untatt Svingerestriksjon). At et nettelement er fjernet innebærer en ny tilstand som behandlingspipelinen i API Skriv må forholde seg til.

Estimat: 5 dv.

h2. Løsning

* (/) Representasjonsmodell: Nye klasser FjernetNode (inneholder kun attributten ""nvdbId"") og FjernetVegnett (inneholder liste med FjernetNode). Klassen Fjerning utvides med element-property ""vegnett"" av type FjernetVegnett.
* (/) Representasjonsmodell: Bean validation som sikrer at samme node ikke både fjernes og oppdateres.
* (/) Domenemodell: NetElement.Operation får ny verdi ""REMOVE"", med høyeste signifikans.
* (/) Transformasjon: NetElementTransforms må utvides til å håndtere transformasjon mellom FjernetNode (representasjonsmodell) og Node (domenemodell).
* (/) Validering: Alle constraints som jobber på noder eller nodeporter må ta hensyn til at noder kan være merket for fjerning (se spesielt på LocationNetElementExistsValidator). I så fall skal det ikke valideres. Dette er muligens allerede håndtert via qualifiers i Node.getErrorConstraints().
* (/) Validering: PrepareForRemoveEnricherFilter må utvides med håndtering av fjernede noder. Det må kontrolleres at angitte noder faktisk finnes i NVDB og om de finnes skal innholdet (geometri, porter) kopieres inn.
* (/) Validering: Alle filtere som jobber på noder må filtrere bort de som er merket for fjerning. De er å anse som ikke-eksisterende.
* (/) Validering: Verifiser at det ikke finnes veglenkesekvenser med kobling til den fjernede noden, verken i NVDB eller endringssettet.
* (/) Validering: Verifiser at det ikke finnes vegobjekter med sving-stedfesting på den fjernede noden, verken i NVDB eller endringssettet. Eget filter a la AdaptToClosedNetwork så vi slipper å berike jobben med Svingrestriksjon.
* (/) Validering: Verifiser at veglenkesekvenser i NVDB er dekoblet fra noden som fjernes. Ny port-constraint aktivert for fjernede noder: PortDisconnected.
* (/) NVDB: NvdbTransactionWriter utvides med ny metode deleteNetElements om invokeres fra writeJob.
* (/) NVDB: NetElementRepository utvides med ny metode deleteNetElements.
* (/) NVDB: SqlGenerationService utvides med ny metode generateDeleteNetElementSql.",NVDB-6937,Skriv-API,
Assosiasjon til flere barn enn tillatt,"h2. Observasjon

Datafangst tillater at man kobler en mor til flere barn enn hva datakatalogen tillater for akkurat denne mor-datter koblingen. API Skriv vil avvise innsendingen.

I dette tilfelle er det Signalanlegg (89) >  Styreapparat (456) som tillater max 1 assosiasjon (se vedlagt bilde fra Datakat Javaapp). Sjekk om API Les gir ut nok info for at DF skal kunne finne ut av dette selv: [https://www.test.vegvesen.no/nvdb/api/v3/vegobjekttyper/89]

Se eksempelkontrakt her: [https://datafangst-test.kantega.no/#!/contract/0ca57876-853c-498a-bd6f-aea369515400/association]

Vedlagt SOSI for signalanlegg og styreapparat. Kan gjenskapes med å koble objektene i SOSI-filene (må ha 100 m som avstand).

Kommer opprinnelig fra kontrakt 1813e611-e55d-42c3-acc1-8f7770e5a5eb og endringssett 2bb054b1-b94f-4d91-a9a6-de6986121e7f.",NVDB-6937,Datafangst,
"NVDBREF-281: Nytt felt for ""ekstern referanse"" i endringssett","h2. Bakgrunn

Endringsønske beskrivelse hentet fra SVV-Jira:

I ""Endringssett"" vinduet, hvor man ser prosjektene man har lastet opp i NVDB, ser vi i dag ID, Låse ID, Transaksjons ID, Eier, Mottatt, Klient, Status og Årsak. Vi synes det er vanskelig å identifisere prosjektene, spesielt dersom man i løpet av en dag har sjekket inn flere prosjekt. Vi ønsker derfor å få inn navnet på Quadri modellen som er jobbet med (feks. NVDB 2019-11-13 16-06). Eventuelt en annen identifikator på hvilket prosjekt det gjelder som er enkel å få inn her. Dette tror vi vil gjøre det enklere å skille mellom prosjektene i Endringssettvinduet.
h2. Analyse

Behovet dekkes av et nytt felt i endringssett for ekstern referanse. Det må etableres et nytt felt i tabellen JOB (EXTERNAL_REF) og tilsvarende property i Job (externalRef) og Endringssett (eksternRef). I kontrollpanelet må verdien i dette feltet vises i toppen av detaljvisningen for et endringssett.
h2. Løsning

Lagt til et nytt felt i endringssettet, for ekstern referanse som blir lagt inn i jobb-databasen. Kun gjort endring for endringssett V3.

 

Estimat: 1 dv",NVDB-6937,Skriv-API,
Laster-indikator ved eksportering,"Det tar litt tid fra man klikker en eksportlenke til resultatet begynner å laste ned, så det er hensiktsmessig å implementere en laster-indikator for eksport av vegobjekter.",NVDB-6937,Vegkart,
Les V3 Metrikker,"Implementer metrikker i Prometheus-format for JVM-informasjon.
",NVDB-6937,Les-API,
NPE ved deassosiering av trunkerte datterobjekter,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/5aad2f0c-d2e2-42f4-a613-e35793371124 havner i SystemFeil under deassosiering av trunkerte datterobjekter:

{code:java}
java.lang.NullPointerException
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.lambda$mergeWith$21(Feature.java:694)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at no.vegvesen.vt.nvdb.apiskriv.domain.feature.Feature.mergeWith(Feature.java:681)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.FeatureConflictResolver.resolveAttemptedModify(FeatureConflictResolver.java:301)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.FeatureConflictResolver.resolveConflict(FeatureConflictResolver.java:65)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.EnrichmentEvaluator.lambda$evaluate$4(EnrichmentEvaluator.java:119)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.enrichment.EnrichmentEvaluator.evaluate(EnrichmentEvaluator.java:118)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.createModifyEnrichmentOrReportConflict(DeassociateTruncatedFeaturesEnricherFilter.java:216)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.lambda$null$1(DeassociateTruncatedFeaturesEnricherFilter.java:127)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:270)
	at java.util.TreeMap$ValueSpliterator.forEachRemaining(TreeMap.java:2897)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.lambda$null$2(DeassociateTruncatedFeaturesEnricherFilter.java:122)
	at java.util.HashMap$ValueSpliterator.forEachRemaining(HashMap.java:1628)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.lambda$null$3(DeassociateTruncatedFeaturesEnricherFilter.java:119)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.lambda$createEnrichmentsOrReportConflicts$4(DeassociateTruncatedFeaturesEnricherFilter.java:114)
	at java.util.ArrayList.forEach(ArrayList.java:1257)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.createEnrichmentsOrReportConflicts(DeassociateTruncatedFeaturesEnricherFilter.java:112)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.DeassociateTruncatedFeaturesEnricherFilter.doFilter(DeassociateTruncatedFeaturesEnricherFilter.java:70)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.lambda$process$0(JobProcessor.java:114)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:92)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:126)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:386)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

I forbindelse med fjerning av en assosiasjon til et datterobjekt (Skiltplate) som lukkes i endringssette forsøker filtereret DeassociateTruncatedFeaturesEnricherFilter å berike jobben med korrigering av morobjektet (Skiltpunkt). Dette morobjektet (nvdbId 1005382545) er imidlertid også korrigert av endringssettet, men denne konflikten løses opp av FeatureConflictResolver ved at endringene som endringssettet gjør på skiltpunktet flettes inn i berikingen. Dette skjer i Feature.mergeWith og det er her NullPointerException kastes fordi skiltpunktet fra endringssettet mangler en ProcessingInfo-instans på geometriegenskapen. Årsaken er at geometriegenskapen transformeres fra StringAttribute til SpatialAttribute i TransformAttributeFilter, men den ProcessingInfo-instansen som finnes i StringAttribute, kopieres ikke over i SpatialAttribute.

h2. Løsning

I TransformAttributeFilter må de tre metodene transformStringAttribute, transformEnumAttribute og transformSpatialStructAttribute utvides til å kalle setDefaultProcInfoIfMissing.",NVDB-6937,Skriv-API,
Analyser løsning for å kunne skjerme for sensitive data,"Formål: SVV skal ikke legge til rette for deling av sensitive data til brukere som ikke har riktig sensitivrolle (sensitivrolle 3) 
To steg:
1. sørge for at data som er lagret i NVDB ikke vises for brukere uten riktig rolle, og ikke kan deles. 
2. finne ut av håndtering av data som er lastet inn i Datafangst men ikke lagret (senere hvis ikke utviklerne ser en smart løsning)

i tillegg:
3. Det er ikke lagt til rette for å hente skjermede data fra Les i Datafangst.
* handler om innloggingsmekanisme mellom Datafangst og Les

Det finnes en tautshetserklæring for de som har rollen, som også sier at de ikke skal dele sensitive data med andre. Men det er antageligvis lurt å sikre i Datafangst i tillegg sånn at ikke noen deler til noen uten rolle uten å tenke seg om. 

Jirasaker er opprettet for å implementere løsning. ",NVDB-6937,Datafangst,
Ruteberegning:   Error loops not allowed," 

Feilmelding :

 

: 2020-03-06T09:32:41,978+0100 TRANSID=""23f004a4-0edf-d5b3-1375-405e752f53ae"" ELAPSED_TIME_MS=""83"" BYTES=""-1"" SESSION="""" CLIENT="""" USER_AGENT=""Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36"" REQUEST_PATH=""/beta/vegnett/rute"" QUERY_PARAMS=""start=0@42317&slutt=1@42317&"" ACCEPT=""application/json, text/plain, /"" RESPONSE_STATUS_CODE=""500"" Error loops not allowed

 

 

Dette skjer når ruteberegning legger inn i grafen en edge som starter og slutt er i samme punkt. Se lenke: [https://stackoverflow.com/questions/35802005/simple-weighted-graph-loops-not-allowed-exception]

 

 

 ",NVDB-6937,Les-API,
Ruteberegning: Feil  - Linestring som input klarer bare å gi  to punkter til svar,"Sjekk lenken nedenfor. Her er det en geometri med en masse punkter som som skal gi stedfesting langs lenkesekvenser.  Responsen man forventer er type linje med start og slutt-posisjoner på lenkesekvenser.   Ikke 2 punkt!

 

 

 

Dagens ruteberegning via geometri  blir feil.  Innebygget validering sjekket at man via input-geometri fikk veglenker som hang sammen i sekvens.  Når man stedfeter geometrier et stykke fra vegnettet (100 meter eller så) vil de nedprojiserte punktene treffe ""tilfeldige"" veglenker som nødvendigvis ikke henger sammen.

 

Derfor skriver vi om ruteberegning via geometri til å bruke punkt til punkt beregning på hele geometriens sekvens av punkter. 

 
h2.  TODO:

Endre ruteberegning når input er geometri.
 * (Ferdig) Lagt inn slik at en kan tegne geometrier i visrute.   Se vedlegg tegnerute.png
 * (Ferdig) Vi endrer slik at beregning via geometri kjører punkt til punkt ruteberegning for inkommende geometris sekvens av punkter.
 * (Ferdig) Resultatet av punkt til punkt ruteberegningene blir flere ""ruter"" med tihørende segmenter, som kommer etter hverandre. Lim sammen de klippede start og slutt-segmentene på rutenes ender slik at de ""henger"" sammen.
 * For noen geometrier får man litt rare ruter. Se eksempel ""rarrute.png"". 
 * Lagt inn klipping av blindvei slik at du i stedet for ""rarrute.png"" får ""klippetrute.png"". Se vedlegg

 

 

 

 

 

 

 

 

 

 

 

 

 

Responsen den gir er to punkt!

 <vegnettsrute>
      <vegnettrutesegment>
        <type>Punkt</type>
       <veglenkesekvensid>42330</veglenkesekvensid>
       <relativPosisjon>0.0</relativPosisjon>
       <kortform>0.0@42330</kortform>
    </vegnettrutesegment>
    <vegnettrutesegment>
        <type>Punkt</type>
        <veglenkesekvensid>41363</veglenkesekvensid>
        <relativPosisjon>0.65968995</relativPosisjon>
        <kortform>0.65968995@41363</kortform>
    </vegnettrutesegment>
 </vegnettsrute>

  

Denne geometrien starter og slutter faktisk i samme punkt også.  

 

Geometri:
 LINESTRING Z(270203.15 7041918.45 9.11, 270203.12 7041921.1 9.03, 270202.94 7041928.89 8.85, 270202.66 7041928.89 8.86, 270202.44 7041933.08 8.92, 270202.25 7041935.64 8.93, 270200.05 7041935.65 8.87, 270200.05 7041935.8 8.86, 270199.01 7041935.78 8.86, 270198.99 7041934.8 8.77, 270199.16 7041934.81 8.78, 270199.19 7041934.7 8.75, 270199.11 7041932.03 9.49, 270198.99 7041930.45 8.9, 270198.74 7041927.6 8.9, 270198.06 7041923.11 8.95, 270197.77 7041919.43 8.96, 270197.78 7041918.45 8.99, 270198 7041907.98 9.07, 270198.19 7041899.17 9.09, 270198.36 7041891.49 9.18, 270198.9 7041866.11 9.51, 270198.94 7041864.52 9.53, 270199.12 7041857.34 9.64, 270199.18 7041854.59 9.68, 270199.27 7041851 10.48, 270199.31 7041850.23 10.49, 270199.41 7041849.44 10.51, 270199.55 7041848.68 10.49, 270199.98 7041847.36 10.51, 270200.4 7041846.4 10.54, 270200.64 7041845.98 10.54, 270201.12 7041845.19 10.54, 270201.97 7041844.02 10.55, 270202.49 7041843.43 10.57, 270203.15 7041842.75 10.57, 270204.44 7041841.7 10.57, 270205.79 7041840.88 10.58, 270206.53 7041840.52 10.57, 270208.16 7041839.97 10.53, 270209.05 7041839.76 10.53, 270213.19 7041839.19 10.54, 270213.46 7041839.15 9.77, 270218.3 7041843.78 9.74, 270215.37 7041844.25 9.74, 270215.4 7041844.64 9.77, 270214.77 7041844.75 9.76, 270215.12 7041848.74 9.82, 270214.22 7041851.31 9.85, 270213.63 7041851.39 10.6, 270205.68 7041852.3 10.53, 270205.4 7041852.44 10.57, 270205.14 7041852.67 10.55, 270204.91 7041852.92 10.58, 270204.69 7041853.33 10.57, 270204.64 7041853.47 10.42, 270204.22 7041854.08 9.84, 270204.21 7041855.44 10.5, 270204.16 7041857.09 9.8, 270203.69 7041857.07 9.65, 270203.68 7041858.67 9.64, 270204.31 7041858.68 9.65, 270204.32 7041858.79 9.76, 270204.38 7041858.78 9.78, 270204.38 7041859.94 9.88, 270204.44 7041859.93 9.88, 270204.43 7041860.7 9.88, 270204.37 7041860.7 9.88, 270204.25 7041866.91 9.88, 270204.16 7041870.76 9.64, 270203.94 7041881.99 9.57, 270203.56 7041881.99 9.36, 270203.51 7041883.67 9.36, 270203.9 7041883.67 9.36, 270203.72 7041891.79 9.38, 270203.45 7041903.53 9.25, 270203.41 7041905.85 9.19, 270203.17 7041917.19 9.17, 270203.15 7041918.45 9.16)

 

Maks_avstand = 100

 

 

 

Direktelenke med geometri:

[https://nvdbapiles-v3.utv.atlas.vegvesen.no/beta/vegnett/rute?geometri=LINESTRING%20Z(270203.15%207041918.45%209.11,%20270203.12%207041921.1%209.03,%20270202.94%207041928.89%208.85,%20270202.66%207041928.89%208.86,%20270202.44%207041933.08%208.92,%20270202.25%207041935.64%208.93,%20270200.05%207041935.65%208.87,%20270200.05%207041935.8%208.86,%20270199.01%207041935.78%208.86,%20270198.99%207041934.8%208.77,%20270199.16%207041934.81%208.78,%20270199.19%207041934.7%208.75,%20270199.11%207041932.03%209.49,%20270198.99%207041930.45%208.9,%20270198.74%207041927.6%208.9,%20270198.06%207041923.11%208.95,%20270197.77%207041919.43%208.96,%20270197.78%207041918.45%208.99,%20270198%207041907.98%209.07,%20270198.19%207041899.17%209.09,%20270198.36%207041891.49%209.18,%20270198.9%207041866.11%209.51,%20270198.94%207041864.52%209.53,%20270199.12%207041857.34%209.64,%20270199.18%207041854.59%209.68,%20270199.27%207041851%2010.48,%20270199.31%207041850.23%2010.49,%20270199.41%207041849.44%2010.51,%20270199.55%207041848.68%2010.49,%20270199.98%207041847.36%2010.51,%20270200.4%207041846.4%2010.54,%20270200.64%207041845.98%2010.54,%20270201.12%207041845.19%2010.54,%20270201.97%207041844.02%2010.55,%20270202.49%207041843.43%2010.57,%20270203.15%207041842.75%2010.57,%20270204.44%207041841.7%2010.57,%20270205.79%207041840.88%2010.58,%20270206.53%207041840.52%2010.57,%20270208.16%207041839.97%2010.53,%20270209.05%207041839.76%2010.53,%20270213.19%207041839.19%2010.54,%20270213.46%207041839.15%209.77,%20270218.3%207041843.78%209.74,%20270215.37%207041844.25%209.74,%20270215.4%207041844.64%209.77,%20270214.77%207041844.75%209.76,%20270215.12%207041848.74%209.82,%20270214.22%207041851.31%209.85,%20270213.63%207041851.39%2010.6,%20270205.68%207041852.3%2010.53,%20270205.4%207041852.44%2010.57,%20270205.14%207041852.67%2010.55,%20270204.91%207041852.92%2010.58,%20270204.69%207041853.33%2010.57,%20270204.64%207041853.47%2010.42,%20270204.22%207041854.08%209.84,%20270204.21%207041855.44%2010.5,%20270204.16%207041857.09%209.8,%20270203.69%207041857.07%209.65,%20270203.68%207041858.67%209.64,%20270204.31%207041858.68%209.65,%20270204.32%207041858.79%209.76,%20270204.38%207041858.78%209.78,%20270204.38%207041859.94%209.88,%20270204.44%207041859.93%209.88,%20270204.43%207041860.7%209.88,%20270204.37%207041860.7%209.88,%20270204.25%207041866.91%209.88,%20270204.16%207041870.76%209.64,%20270203.94%207041881.99%209.57,%20270203.56%207041881.99%209.36,%20270203.51%207041883.67%209.36,%20270203.9%207041883.67%209.36,%20270203.72%207041891.79%209.38,%20270203.45%207041903.53%209.25,%20270203.41%207041905.85%209.19,%20270203.17%207041917.19%209.17,%20270203.15%207041918.45%209.16)&maks_avstand=100&pretty=true&kortform=true]",NVDB-6937,Les-API,
Stramme opp påloggingsregime,"Pga stort tidspress og harde frister tok vi et par snarveier i vår håndtering av pålogging mot NVDB api LES, disse bør ryddes opp i. Men denne endringen settes IKKE i produksjon før veglisteproduksjon er fullført (19.3). ",NVDB-6825,Rapportgenerator,
Rydde i kartprojeksjoner på kart og data i datafangst,"Det er litt rotete med ulike referansesystemer i datafangst, i dag. Noen projeksjoner er oppgitt med WKT, noen med EPSG-id'er. Det er strenger og proj4js-objekter.

Vi burde rydde litt, og legge info om alle referansesystemer én plass, slik at vi er sikre på at alle komponenter bruker samme projeksjon og refsys.",NVDB-6937,Datafangst,
Veglister på MS Edge: søk starter ikke!,"Microsoft Edge 41.16299.1480.0

Kjører Veglister på for eksempel PROD: [https://nvdb-veglister.utv.atlas.vegvesen.no/]

Kallet til server initieres ikke (ingen spor i logg). Spinner går, men viser ingen tid (siden tiden er basert på respons fra server).",,Rapportgenerator,
Fullføre e2e-tester for vegnett,Sverre startet på e2e-testene for vegnett. Oppgaven går på å fullføre dette.,NVDB-6937,Vegkart,
Søk på BK 12/100 og 12/65 gir tom rapport,"Fra Tone Wiig (kjørt 2020-03-04 19:01 i prod):

Søk på 12/100 uoffisiell og 12/65 uoffisiell, Trøndelag, Fv og Kv, Arbeidsmodus gir tomme tabeller",,Rapportgenerator,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5242: Verifiser at riktige roller kommer ut for en tjenestebruker (dersom de har noen roller i LDAP i ATM)
 * NVDB-5188: Sjekk at innsending med srid 6173 blir avvist, mens 5973 blir godkjent. Ta gjerne utg.pkt i generator-case 95.

Sak i leveransen som ikke er nevnt over trenger ikke spesifikk testing i ATM.",NVDB-6937,Skriv-API,
"Ukjent linje 2 på Vegliste E39 Trøndelag, normaltransport (uoff)","Fra Tone Wiig:
Se på E39 Trøndelag, normaltransport i excelfila og rapporten. Hvor i alle dager kommer linje 2 på E39 i rapporten fra. Excelfila er tatt fra NVDB innsyn uof.

[^nvdb-rapport-2020-03-04-9129658659122760080 (1).docx] ",,Rapportgenerator,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5205: Send inn tomme egenskapsverdier via e-API og se at de ikke blir merket som endret i datafanen.
 * NVDB-5201: Registrer i NVDB av påfølgende lukkinger skal ikke ta med tidligere lukkinger ^1)^
 * NVDB-5192: Innsending av NN54 og NN2000 skal konvertere høyden ihht konfig satt på server. Se testbeskrivelse i saken.
 * NVDB-5202: Endringsmarkering på kontrakter skal forsvinne ved besøk på en kontrakt
 * NVDB-5182: Verifiser at eksisterende data med tette nabopunkter blir lagret
 * NVDB-4085: Stedfesting skal ikke ha flere enn 8 desimaler

^1)^ Denne saken fortsettes i sak NVDB-5248. Saken blir med på leveransen siden det som er gjort fortsatt gir verdi.

 ",NVDB-6937,Datafangst,
Lukker objekt på nytt med Utfør lukking nå,"h2. Observasjon

Test av NVDB-5201 viser at dobbel lukking er fjernet fra ""Registrer i NVDB"", men ikke ved bruk av knappen ""Utfør lukking nå"".

Se mer beskrivelse av problemet i navnte sak.",NVDB-6937,Datafangst,
Geopackage ,"Geopackage er et lagringsformat for geografiske data bygget på sqlite. [https://www.geopackage.org/]

Jans forslag er å dumpe alle NVDB-objekter i datauttaket til geopackage, en tabell per objekttype pluss eventuelt en tabell for vegnett.

Geografiske objekter i geopackage består av et skjema med egenskapverdier (flat tabell) pluss en geometri. Standard i geopackage er at geometrien kan være hvilken som helst geometritype (punkt, linje, flate, multi... ). Eventuell kompleksitet med å håndtere at NVDB-objekter kan ha ulike geometrityper blir dermed elegant dyttet over på klienten. Alt som kreves, er at [WKT|https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry]-teksten i ""geometri"" -elementet blir transformert til et fullverdig geometriobjekt.

I tillegg må vi ut fra datakatalogen bygge skjemadefinisjon for angjeldende objekttype. Dernest må de egenskapverdiene som finnes på hvert enkelt objekt _(typisk et subsett av datakatalogdefinisjonen)_ puttes på rett sted ihht dette skjemaet. Vi har litt spillerom på hvilket _navn_ vi bruker på de ulike egenskapverdiene, en av
 1. Navn - Mest brukervennlig, men inneholder litt spesialtegn og nasjonale karrakterer
 1. ID for egenskapen - minst brukervennlig, garantert maskinlesbart.
 1. SOSI navn - En hybrid mellom de to over. Garantert maskinlesbar og stort sett brukervennlig forkortelse av det fulle navnet, pluss ID for egenskapen.

For vegnett får vi en engangsjobb med å bygge skjema som samsvarer med det vegnettet vi får ut fra NVDB api. Ellers er logikken med oversettelse til geografiske objekt pluss fast skjema den samme som for vegobjekter.

Det mest lovende java-biblioteket for skriving av geopackage ser ut til å være [https://github.com/ngageoint/geopackage-java]

 

EDIT: Ser at nvdbapiles bruker [https://locationtech.github.io/jts/javadoc/overview-summary.html] for generell håndtering av geometri. ",NVDB-6827,Rapportgenerator,
Leveranseinformasjon Vegkart 2020.2.2,"Kun endring i konfighåndtering slik at Vegkart starter konsekvent.

Tips til akseptansetest: www.test.vegvesen.no/nvdb/vegkart/v3 og vegkart.test.atlas.vegvesen.no laster.",NVDB-6937,Vegkart,
Feil ved koordinatkonvertering/visning i Nordnorge,"h2. Observasjon
Triona forteller om vegobjekter øst i Finnmark (dvs langt utenfor UTM33) som får feil plassering / en forskyvning på kartet. De har ett eksempel som er vedlagt.

h2. Analyse
Ser ut som data er riktig i databasen, men at en gammel versjon av proj4 (for konvertering av koordinater) på klientsida forårsaker denne feilen.

h2. Løsning
Oppgrader til nyeste proj4. Dette krever endringer i TypeScript-oppsettet, så det drar også med seg noen andre kodeendringer.",NVDB-6937,Datafangst,
Leveranseinformasjon,"*Test i AT:*
 * NVDB-5035: Bruk url som angitt i kommentar på saken til å se at det nå retureners mange 532 innenfor kontraktsområde. Kan gjerne verifiseres av innmelder.
 * NVDB-5145: Test i hht til testbeskrivelse i saken.
 * NVDB-4400: Bruk [https://nvdb-vegdata.github.io/nvdb-visrute/ATM/] til å teste de ulike parametrene. God testbeskrivelse i saken.
 * NVDB-5135: Test er inkludert i regresjonstest nevnt under.
 * NVDB-5227: Sjekk at /beta/vegnett/rute kommer ut i rota av /nvdb/api/v3
 * Regresjonstest av API: Dette kan gjøres ved å kjøre de aut. API-testrene mot ATM.

Saker i denne leveransen som ikke er spesifikt nevnt trenger ikke å testes i ATM utover regresjonstesten nevnt over.",NVDB-6937,Les-API,
Mangler lokasjon.stedfestinger for responsrevisjon 0,"h2. Observasjon

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/573?antall=10&inkluder=alle]

med ""Accept: application/vnd.vegvesen.nvdb-v3-rev0+json"" gir tomt lokasjon.stedfestinger-element.

Samme kall med ""Accept: application/vnd.vegvesen.nvdb-v3-rev1+json"" gir info.",NVDB-6937,Les-API,
Mangler vegsegmenter ved inkludering av vegsegmenter,"h2. Observasjon

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/581?antall=10&inkluder=vegsegmenter,metadata&segmentering=false]

gir ingen vegsegmenter.

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekter/581?antall=10&inkluder=alle&segmentering=false]

gir vegsegmenter.",NVDB-6937,Les-API,
Send inn SRID med høydereferanse til NVDB,"I forbindelse med overgang til NN2000 (NVDB-5192) ser vi at vi sender inn SRID for UTM33 til NVDB, men det er ikke en SRID som også angir høydereferanse som vi bruker.
Vi bruker 25833 (EUREF UTM33), mens vi (etter overgangen) burde bruke 5973 (EUREF UTM33 med NN2000).

På sett og vis er det også treffende at vi bruker en SRID uten høydereferanse, siden vi ikke har helt kontroll i eget hus. Det er noen høyder som ikke blir konvertert til NVDBs høydereferanse, se NVDB-5233 og NVDB-5234. Etter at vi har fått ryddet mer opp her så burde vi begynne å sende inn SRID med høydereferanse.",NVDB-6937,Datafangst,
Systemfeil pga to lukkinger av samme vegobjektversjon,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/12254060-1c8b-40c2-aa62-9adbe7b5bad2 havner i status SYSTEMFEIL pga uventet konflikt mellom to berikinger i jobben:

{code:java}
java.lang.IllegalStateException: Unexpected conflict between op:DISCONTINUE tid:438 id:79022580 v:1 sd:2003-07-22 ed:2012-01-01 - ac:CLOSE or:CascadingTruncateEnricherFilter vr:false and op:INTERNAL tid:438 id:79022580 v:1 sd:2003-07-22 ed:2012-01-01 - ac:CLOSE or:AdaptFeaturesToClosedNetworkEnricherFilter vr:false
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.FeatureConflictResolver.resolveAttemptedDiscontinue(FeatureConflictResolver.java:145)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.FeatureConflictResolver.resolveConflict(FeatureConflictResolver.java:56)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.EnrichmentEvaluator.lambda$evaluate$4(EnrichmentEvaluator.java:118)
	at java.lang.Iterable.forEach(Iterable.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.EnrichmentEvaluator.evaluate(EnrichmentEvaluator.java:117)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.lambda$null$6(CascadingTruncateEnricherFilter.java:161)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:270)
	at java.util.TreeMap$ValueSpliterator.forEachRemaining(TreeMap.java:2897)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.lambda$null$8(CascadingTruncateEnricherFilter.java:145)
	at java.util.HashMap$ValueSpliterator.forEachRemaining(HashMap.java:1628)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.lambda$findAndTruncateChildren$9(CascadingTruncateEnricherFilter.java:138)
	at java.util.ArrayList.forEach(ArrayList.java:1257)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.findAndTruncateChildren(CascadingTruncateEnricherFilter.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.lambda$getFeaturesForCascadingTruncate$2(CascadingTruncateEnricherFilter.java:99)
	at java.util.ArrayList.forEach(ArrayList.java:1257)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.getFeaturesForCascadingTruncate(CascadingTruncateEnricherFilter.java:98)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.CascadingTruncateEnricherFilter.doFilter(CascadingTruncateEnricherFilter.java:65)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:122)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$13(JobWorker.java:389)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$validateBeforeLock$14(JobWorker.java:388)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:387)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

Som angitt av stacktrace over forsøker CascadingTruncateEnricherFilter å lukke (siste versjon av) et vegobjekt som allerede er lukket av et tidligere følgeoppdateringsfilter, AdaptFeaturesToClosedNetworkEnricherFilter, pga. lukket vegnett. Sistnevnte lagde en følgeoppdatering med operation INTERNAL, action CLOSE for å unngå følgeoppdateringer pga lukkingen, siden vegobjektet allerede hadde sluttdato (2012-06-25) i NVDB. CascadingTruncateEnricherFilter, derimot, tar ikke hensyn til at vegobjektversjonene allerede har sluttdato og prøver å legge inn DISCONTINUE med ny sluttdato. Dette avvises korrekt som konflikt.

h2. Løsning

Feilen er at CascadingTruncateEnricherFilter unnlater å bruker INTERNAL:CLOSE når vegobjektversjonen allerede er lukket. Dette rettes i metoden createEnrichmentForTruncation.
",NVDB-6937,Skriv-API,
Atlas: Kjøre nvdb-rapport-api på separate noder for Veglister og Driftskontrakter,"Kjøre nvdb-rapport-api på separate noder for Veglister og Driftskontrakter i miljøene UTV, ATM og PROD. Dette for å forhindre at ulike klienttyper (Veglister og Driftskontrakter) påvirker kjøremiljøet for hverandre.",NVDB-6825,Rapportgenerator,
"NVDBREF-270: Avvis overlappende Strekning, Sideanleggsdel og/eller Kryssdel","h2. Bakgrunn

Registrert i SVV-Jira av Ekker Hans Jørgen
Beskrivelse i NNVDBREF-270: 
I endringssett:

https://www.test.vegvesen.no/nvdb/apiskrivbeta/kontrollpanel/#/jobs/view/c774be4e-13a0-46fb-af2e-f7bb606b428e

har jeg opprettet både Strekning og Sideanleggsdel på samme lenke (lenke 1, lenkesekvens -1). Prosessen gikk fram til Completed i et prøveinnsjekk i ATM.

916 Strekning, 918 Kryssdel og 920 Sideanleggsdel er gjensidig utelukkende.

(NVDB Vegnett validerer dette, men kun som Advarsel og ikke Feil. Dette må endres i egen sak).

h2. Analyse

Det må realiseres en ny constraint som verifiserer at det ikke er overlappende vegystemreferanse-vegobjekter på vegnettet, hverken innenfor endringssettet eller endringssettet+NVDB. Den eksisterende NoOverlap-constraint'en kan brukes som modell. 

Det er ingen beriking av jobben med Kryssdel og Sideanleggsdel i dag, bare Strekning. Dette må antagelig realiseres. I så fall kan filteret AdaptFeaturesToChangedMeterDirectionEnricherFilter omskrives litt. Dette filteret henter også inn Kryssdel- og Sideanleggsdel-objekter.

Estimat: 5 dv

h2. Løsning

Nytt berikingsfilter ReadInterOverlappedFeaturesEnricherFilter leser inn relevante vegsystemreferanse-objekter fra NVDB. Disse brukes ved validering av overlapp innad blant disse vegobjekttypene i den nye constraint'en NoInterOverlap.
",NVDB-6937,Skriv-API,
Mors stedfesting dekker ikke datter,"h2. Observasjon

Det kom inn en henvendelse fra SINUS Infra om en feilmelding fra API Skriv ved delvis korrigering av mor og datter i samme endringssett. Dette er v2 av API. Her endres stedfesting for både mor og døtre, men Skriv sier at stedfestingen til mor ikke dekker datter.

Endringssett: [https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/8a6ac299-340a-480b-98b2-eda6f159f801]

Vedlagt er endringssettet som feiler. Dette feiler med: _Objektet har ikke stedfesting som fullstendig dekker datterobjekt av type Skiltplate (96): nvdbId 86612764_

Har gjenskapt feilen på STM også.

h2. Analyse

I endringssettet korrigeres stedfestingen til:

1) Et morobjekt av type Skiltpunkt, nvdbId 86612765, versjon 1, med levetid 2003-02-17 ->
2) Et datterobjekt av type Skiltplate, nvdbId 86612764, versjon 2, med levetid 2003-06-09 ->

Endringssettet avvises fordi datterobjektet også finnes i versjon 1, med levetid 2003-02-17 - 2003-06-09, og etter korrigering av stedfestingen til morobjektet er ikke lenger v1 av datter stedfestet innenfor mor. Dette kunne vært løst ved at v1 av datterobjektet også fikk sin stedfesting korrigert. Dette støttes imidlertid bare i versjon 3 av endringssett-endepunktet. 

h2. Løsning

Det er ingen bug å fikse, men utvider valideringsmeldingen med versjonsnummer for å tydeliggjøre at problemet ligger på en historisk versjon.
 ",NVDB-6937,Skriv-API,
Implementer endringslogg,"Oppgaven består i å implementere en versjonslogg som brukeren av Vegkart har tilgang til.

Det er mest hensiktsmessig å ha en link til versjonsloggen i splash-vinduet (der ""Ikke vis""-checkboxen er i dag – flytt checkboxen til plassen over footer i stedet).

Et forslag er å ha en fil per release som forklarer endringer i markdown-stil, som kan parses av komponenten som skal vise fram dette. Deretter kan man bestemme hvor mange tidligere versjoner man ønsker å vise i loggen. Muligens de to eller tre siste? For konsistent visning kan man ha scrollbar her som default.

Vurder samtidig om man ønsker en indikator for om noe er endret siden sist brukeren var innom Vegkart. Denne skal ikke vises ved første besøk.

Dersom ønskelig av utvikleren, kan det opprettes et eget byggsteg som sjekker at en fil for neste release er laget, og feile bygget dersom denne ikke eksisterer.",NVDB-6937,Vegkart,
Mulighet for å oppgi høydereferanse ved bruk av eksternt API,"For vegobjekter som kommer inn med ekstern API så er posisjon angitt i WGS 84 (""GPS""), og høyde er også angitt relativ til dette (""WGS 84-ellipsoiden""). Slike objekter har høydesystem (""heightRef"") ""ELLIPSOID"" i databasen.

NVDB API forutsetter at høydereferanse er NN54 (eller snart NN2000, se NVDB-5192), men det skjer ingen konvertering mellom WGS 84 og norsk høydereferanse ved innsending til NVDB, som medfører at alle høyder fra ekstern API blir feil i NVDB hvis det er WGS 84-høyde som brukes.

*Løsning*
Datafangst endres til at ekstern API skal gjøre det mulig å oppgi hva slags høydereferanse som brukes. Kun NN2000 og NN54 skal være tillatte verdier, hvis det er oppgitt en annen verdi enn disse skal vegobjektet avises med beskrivende feilmelding.
Hvis høydereferanse ikke er oppgitt skal høyde tolkes og lagres som  NN2000, men NN54 aksepteres (ettersom vi har en konvertering).
NB! data som ikke har høyde trenger heller ikke høydereferanse, og skal aksepteres. 

API-dokumentasjon skal også oppdateres.",NVDB-6937,Datafangst,
Håndering av gamle høydesystemer i Datafangst,"API Skriv forutsetter at koordinater med høyde som sendes inn er i ""riktig"" høydesystem, dvs. per nå NN54, snart NN2000. Skriv gjør ingen konvertering av data som sendes inn.

Datafangst gjør til en viss grad konvertering av høydedata, men bare for høydesystemer der det er satt opp eksplisitt konvertering. Det vil si i dag fra NN2000 til NN54, og snart også fra NN54 til NN2000.

Det er også andre høydesystemer i bruk i data som sendes inn til Datafangst. Det er noe bruk av gamle systemer med ""OSLO"" (ca 1% av vegobjekter) og NNN57 (ca. 0,01%). Det er ikke noen konvertering for disse i dag, så slik det er nå vil de gå rett inn i NVDB som de er, og høydeverdien i NVDB vil ikke være riktig. Slik det er nå godtar vi alle høydesystemer som er definert i SOSI-standarden, men det er bare NN2000 / NN54 og lokalt høydesystem for Trondheim som konverteres.

Vi bør enten avvise andre høydesystemer enn NN54, NN2000 og WGS84 framover, eller så må vi få på plass konvertering også for de gamle systemene som vi godtar.

Dette dukket opp i forbindelse med overgang til høydesystem NN2000 i NVDB (se NVDB-5192).",NVDB-6937,Datafangst,
Eksport: Markere type innsending,"En bruker ønsker å kunne se operasjon som inngår i en registrering. F.ex dersom et endringssett kun inneholder operasjonen ""Lukk"" vil bruker se dette i tabellen over registreringer. En mulighet er å legge til info om type operasjon i kolonne til høyre for status (eksempelvis UTFØRT | Lukk).

Fra bruker (Tanja Caliskaner, Tanja.Jeanette.Molland.Caliskaner@vlfk.no):
{noformat}
Er det mulig når man oppdaterer NVDB at de objekt som slettes får markert dette bak objektet slik at man ser i loggen at sletting er utført? Se eksempel under hvor jeg først utførte sletting på stikkrenne/kulvert og så oppdatert ny, men de ser helt like ut i loggen.
{noformat}",NVDB-6937,Datafangst,
Låste vegobjekter skal kunne kopieres,"Et ønske fra bruker er at låste objekter skal kunne kopieres til nye objekter. Vi hindrer dette i dag, men ser ingen grunn til at vi ikke kan oppfylle dette ønsket.

Fra bruker (Espen Refsdal Thiem, Espen.Refsdal.Thiem@vlfk.no):
{noformat}
Ved å låse objekter forsvinner muligheten for å kopiere. Burde ikke kopieringsmulighetene vært der fremdeles? Man må da kunne få kopiere et objekt selv det er låst, da låsingen bare skal hindre endringer på det aktuelle objektet. En kopiering medfører ikke noen endring for objektet som blir kopiert.
{noformat}",NVDB-6937,Datafangst,
NVDBREF-493 - Ikke tilgang ved filtrering på sensitiv egenskap,"h2. Observasjon

Bruker exttxm har rolle sensitiv_1 i ATM. Spør etter {{/vegobjekter/570?antall=10&inkluder=egenskaper}} og får opp bl.a. egenskap 5061. Men {{/vegobjekter/570?antall=10&egenskap=(5061!=null)&inkluder=egenskaper}} gir _Anmeldelsesnummer(5061) er en sensitiv egenskapstype som krever innlogging og rettigheter for visning av Trafikkulykke(570)_

Når bruker har riktig rolle skal også filtrering på sensitiv egenskap fungere.

Til info så fungerer filtrering på egenskap (ikke sensitiv) for skjermet type (etter å ha lagt til tilgang for denne) med /vegobjekter/905?antall=1&egenskap=(10914!=null)&inkluder=egenskaper.",NVDB-6937,Les-API,
Ustabil integrasjonstest AssociationIt.shouldRejectIndirectAssociationToChildFeatureWithOperationDelete,"Test shouldRejectIndirectAssociationToChildFeatureWithOperationDelete feiler forholdsvis ofte, uten noen åpenbar årsak.

Logg viser at en grunn til feil er at den får to instanser av en NVDB-ID i databasen. Jeg og Tor klarer ikke å se helt hvordan dette henger sammen, men testen i seg selv er laget sånn at den egentlig tester to forskjellige ting, og gjenbruker NVDB-ID som det testes med. Å splitte testen i to vil kanskje gjøre den mer stabil.",NVDB-6937,Datafangst,
Fjerne mulighet for multigeometri i Datafangst,"h2. Observasjon

TNE klager på en geometri som er lest inn som multilinestring på objekt 1006883957. Dette objektet kommer fra Datafangst.

Kontrakt: [https://datafangst.kantega.no/#!/contract/c7eebb4e-12f7-4f07-afa3-764c10b5fe3d/export]

Endringssett: [https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/486ec384-3166-48d6-b41f-fde6459d76ca]

Det er snakk om objektet ""Ny Vegdekke_1"" (type 241). Det er litt vanskelig å se hvor det kommer fra, men det ser ut som om et NVDB-objekt er kopiert inn med ny geometri, for deretter å bli klippet i to (se event-fanen med å filtrere på objektets guid). Hvorfor dette objektet har blitt liggende med multigeometri er vanskelig å si.

Pga problemene til TNE har Hans Anton slettet geometrien til objektet: [https://www.vegvesen.no/nvdb/apiskriv/rest/v3/les/vegobjekt/241/1006883957/1]

Dette kan sees her: [https://www.vegvesen.no/nvdb/apiskriv/rest/v1/transaksjon?vegobjektId=1006883957]

Det vi kan gjøre i denne saken er å se om hvordan vi håndterer import av NVDB-objekter med multigeometri, samt se om klipping kan generere multigeometri.

 ",NVDB-6937,Datafangst,
Ruteberegning: Legge inn dokumentasjon av endepunkt i apiary,"h2. TODO
 * (Ferdig) Legge inn api-dokumentasjon for beregning av rute punkt til punk og med geometri
 * (Ferdig) Legge inn slik at endepunkt /beta/vegnett/rute vises i oversikt for lenke-url til Leseapi (f.eks vises i lenken [https://apilesv3.atlas.vegvesen.no)|https://apilesv3.atlas.vegvesen.no%29/]
 * (Ferdig) Fikse slik at direktelenkene peker inn på riktig sted i dokumentasjonen når man kaller Leseapi med feil parameter, f.eks:
 ** <errors>
    <error>
       <code>4002</code>
       <message> Ugyldig verdi '3?dsflkjhdsfj' for heltallsparameter 'antall'.</message>
       <help_url>[https://nvdbapilesv3.docs.apiary.io/#/reference/0/vegobjekter]</help_url>
   </error>
 </errors>

 

Når det gjaldt dirktelenkene inn i dokumentasjonen viste det seg å være tegnet ""/"" som kom etter hashtegnet ""#"" som gjorde at direktelenken ikke fungerte.   Oppdaterte defaults.properties og fjernet ""/"" tegnet og da virker lenkene.

 

 

 ",NVDB-6937,Les-API,
Legg på mer informativ tekst rundt Overskriv i NVDB,"Det er i dag ikke mange som vet hva ""Overskriv i NVDB"" gjør til forskjell fra ""Registrer i NVDB"". Når vi nå har fått flere gruppeadmin som ikke har historikken til de ""opprinnelige"" globale admin som denne funskjonen var laget for, trenger denne funksjonen en mer informativ tekst som sier hva den gjør.

Spesielt pga sak NVDB-5222.

Teksten kan evt legges inn i en modal som kommer opp når man trykker på knappen. Bør inneholde råd om å i hovedsak bruke ""Registrer i NVDB"".",NVDB-6937,Datafangst,
Gi gruppeadmin tilgang til overskriv i NVDB funksjonen,"I dag har kun globale admin tilgang til ""Overskriv i NVDB"" på Eksport. Denne funksjonen bør også være tilgjengelig for gruppeadmin.",NVDB-6937,Datafangst,
Støtte kjøring på flere Atlas-noder,"ReportJobManager holder styr på asynkrone jobber mellom frontend og backend. Denne tilstanden holdes i en intern Map. Siden denne manageren er ApplicationScoped vil det feile hvis vi kjører løsningen på flere noder, da den interne tilstanden ikke deles på tvers av VM'er.

Vi kjører derfor i dag bare med én node.

På grunn av store minneproblemer (NVDBREF-482) er det sannsynligvis nødvendig å lastbalansere mellom flere noder. Viktigst for Driftskontrakter, men også for Veglister.

Det har vært diskutert at tilstanden sannsynligvis hører hjemme i en database.",NVDB-6825,Rapportgenerator,
"Oppgradere dependencies, mars 2020","På tide å sjekke dependencies igjen.

Siden sist har Typescript kommet i versjon 3.8: [https://devblogs.microsoft.com/typescript/announcing-typescript-3-8/]

NPM har en ny patch-versjon: 6.13.1 -> 6.13.7",NVDB-6937,Vegkart,
Direktelenke av vegnettsfilter fungerer ikke,"Gå til [https://vegkart-v3.utv.atlas.vegvesen.no/], åpne vegnettsfilteret og klikk ""Rampe"".

Refresh siden. Vegkart enten kræsjer eller klarer ikke parse filteret.",NVDB-6937,Vegkart,
Overgang til nytt høydesystem - fra NN 1954 til NN2000,"Alle Z-koordinater skal ved overgang til NN2000 regnes om ved scriptkjøring - se NVDB klassisk sak https://jira.kantega.no/browse/SVNK-470

Det er ønskelig å få implementert denne endringen i produksjon i midten av mars. I forkant må det gjøres tilpasninger i NVDB api skriv og Datafangst, og vurdering av om det innebærer noe mer enn reindeksering for NVDB api les v2 og v3. https://jira.kantega.no/browse/NVDB-5188 og https://jira.kantega.no/browse/NVDB-5192

 

Hans Anton Ålien vil sørge for retest av scriptet som endrer Z-koordinatene.",NVDB-6937,Eksport,
Atlas: OutOfMemoryError,"UTV har problemer med minne ved kjøring av Normaltransport/Trøndelag
Terminating due to java.lang.OutOfMemoryError: Java heap space",,Rapportgenerator,
Automatisk regresjonstest,"Oppsett av automatisk regresjonstest. Test at for en gitt Vegliste så blir rapporten den samme. For å unngå at testen skal feile ved oppdateringer i NVDB må svar fra lese-apiet lagres og mockes.

Undersøk om testen må kjøre nattlig for å holde byggetid nede, eller om den kan være en del av vanlig bygg.

 
 Estimat, t-skjorte-størrelse: Medium",NVDB-6825,Rapportgenerator,
SOSI-nedlasting feiler,[https://nvdbapi-eksport-v3.utv.atlas.vegvesen.no/vegobjekter/5.sosi?segmentering=true&egenskap=(area(946%2C5021))&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri%2Cvegsegmenter&tegnsett=utf8],NVDB-6937,Eksport,
Leveranseinformasjon  NVDBIND-V3 2020.5.0,"Etter indeksering i produksjon skal dataerror.log deles opp i de forskjellige typene feil og sendes til Hans Anton, Hans Jørgen og Linda.

*Test i AT:*
 * NVDB-5152: Verifiser at multi-geometri kommer ut for de som har dette som egengeometri.
 * NVDB-5074: Verifiser at segmenterte deler uten Vegsystem kommer ut fra API

Saker i leveransen som ikke er nevnt over trenger ikke å testes spesifikt i ATM. ",NVDB-6937,NVDB-IND,
Leveranseinformasjon Skrive-API 2020-3,"*Test i AT:*
 * NVDB-5194: Retest endringssett som angitt i saken. Se også ^1)^
 * NVDB-5157: Retest innsending fra datafangst-test på kontrakt som angitt i saken.
 * NVDB-5110: Verifiser at _/nvdb/apiskriv/rest/v1/autorisasjon/<brukernavn>_ gir rettigheter for en bruker som har satt rettigheter og ingen rettigheter for en systemadmin-bruker (f.ex exttxm)

Saker som ikke er nevnt som er en del av denne leveransen trenger ikke spesifikk test i ATM.

^1)^ Men siden leveranse Skrive-API 2020-2 inneholdt en feil som er rettet her, er det ønskelig at VNE re-tester denne leveransen i ATM. Dette gjelder sakene som beskrevet i NVDB-5176.",NVDB-6937,Skriv-API,
"NVDBREF 476 - CSV-eksport for ""Elektrisk anlegg"" gir kun kryptiske tegn i CSV-fila","Jeg velger Målselv kommune og Elektrisk anlegg, og jeg får fram 14 objekter i kartet. Men jeg får ikke objektene over til CSV-fil. Det eneste som kommer med i fila er ï»¿ i rute A1.

[https://vegkart-v3.test.atlas.vegvesen.no/#kartlag:geodata/@653592,7666650,9/hva:~(~(id~461))/hvor:~(kommune~(~5418]))",NVDB-6937,Eksport,
SQLException ved innhenting av transaksjonstidspunkt,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/556ace93-f8df-443a-a52b-62f98e422b10 havarerer med SYSTEMERROR ved transaksjonskontroll av vegobjekt:

{code:java}
java.lang.RuntimeException: Failed to execute query
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Executors.executeQuery(Executors.java:125)
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.JdbcTransactionRepository.lambda$getLatestTxTimeForFeatureVersions$10(JdbcTransactionRepository.java:169)
	at java.util.HashMap$Values.forEach(HashMap.java:981)
	at no.vegvesen.vt.nvdb.apiskriv.nvdbrepository.JdbcTransactionRepository.getLatestTxTimeForFeatureVersions(JdbcTransactionRepository.java:168)
	at no.vegvesen.vt.nvdb.apiskriv.auditing.DefaultAuditService.lambda$getLatestUpdateTimeForFeatureVersions$6(DefaultAuditService.java:202)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:60)
	at no.vegvesen.vt.nvdb.apiskriv.auditing.DefaultAuditService.getLatestUpdateTimeForFeatureVersions(DefaultAuditService.java:202)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.FeatureVersionContentionFilter.validateFeatures(FeatureVersionContentionFilter.java:49)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.FeatureVersionContentionFilter.doFilter(FeatureVersionContentionFilter.java:42)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateAfterLocking(DefaultValidationService.java:129)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$21(JobWorker.java:512)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$validateAfterLock$22(JobWorker.java:511)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateAfterLock(JobWorker.java:510)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:177)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1390)
	at org.apache.activemq.ActiveMQMessageConsumer.iterate(ActiveMQMessageConsumer.java:1552)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:191)
	at org.apache.activemq.ActiveMQSessionExecutor.wakeup(ActiveMQSessionExecutor.java:111)
	at org.apache.activemq.ActiveMQMessageConsumer.start(ActiveMQMessageConsumer.java:1527)
	at org.apache.activemq.ActiveMQMessageConsumer$7.run(ActiveMQMessageConsumer.java:1308)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Timer.java:555)
	at java.util.TimerThread.run(Timer.java:505)
Caused by: java.sql.SQLException: Missing IN or OUT parameter at index:: 503
	at oracle.jdbc.driver.OraclePreparedStatement.processCompletedBindRow(OraclePreparedStatement.java:2086)
	at oracle.jdbc.driver.OraclePreparedStatement.executeInternal(OraclePreparedStatement.java:3772)
	at oracle.jdbc.driver.T4CPreparedStatement.executeInternal(T4CPreparedStatement.java:1343)
	at oracle.jdbc.driver.OraclePreparedStatement.executeQuery(OraclePreparedStatement.java:3822)
	at oracle.jdbc.driver.OraclePreparedStatementWrapper.executeQuery(OraclePreparedStatementWrapper.java:1165)
	at sun.reflect.GeneratedMethodAccessor304.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at oracle.ucp.jdbc.proxy.PreparedStatementProxyFactory.invoke(PreparedStatementProxyFactory.java:176)
	at com.sun.proxy.$Proxy87.executeQuery(Unknown Source)
	at no.vegvesen.vt.nvdb.apiskriv.database.proxy.PreparedStatementProxy.executeQuery(PreparedStatementProxy.java:37)
	at no.vegvesen.vt.nvdb.apiskriv.database.proxy.PreparedStatementProxy.executeQuery(PreparedStatementProxy.java:37)
	at no.vegvesen.vt.nvdb.apiskriv.database.proxy.PreparedStatementProxy.executeQuery(PreparedStatementProxy.java:37)
	at no.vegvesen.vt.nvdb.apiskriv.database.metric.MetricPreparedStatement.lambda$executeQuery$0(MetricPreparedStatement.java:22)
	at no.vegvesen.vt.nvdb.apiskriv.database.metric.MetricUtils.time(MetricUtils.java:20)
	at no.vegvesen.vt.nvdb.apiskriv.database.metric.MetricPreparedStatement.executeQuery(MetricPreparedStatement.java:22)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Executors.executeQuery(Executors.java:122)
{code}

h2. Analyse

I JdbcTransactionRepository.getLatestTxTimeForFeatureVersions() hentes siste transaksjonstidspunkt for en liste av vegobjektid'er. For å omgå begrensningen i antall verdier for en IN-klausul i Oracle, partisjoneres listen i sublister á 500 id'er. I det aktuelle endringssettet er over 600 vegobjekter som oppdateres med overskriving. Dermed blir det to partisjoner. Men, i oppbyggingen av SQL-setningen lages parametermarkører for hele (mer enn 600) listen av id'er i stedet for bare partisjonen. Dermed blir det flere parametermarkører enn parametere og JDBC kaster SQLException som ventet.

h2. Løsning

Endrer antall parametermarkører til det antallet id'er som finnes i den aktuelle partisjonen.",NVDB-6937,Skriv-API,
Rettigheter på kontraktnivå funker ikke med query-param,"h2. Observasjon

Raymond Krossøy Hermansen har problemer på 

[https://datafangst.kantega.no/#!/contract/1710fb1a-063b-4c35-9dbe-c935f351a9fb/features3]

han får ikke til å kopiere sideposisjon fra mor, men får til å redigere sideposisjon manuelt.

backend svarer med 403 forbidden.

det er samme mekanisme som avklarer permissions i begge tilfellene, men av eller annen grunn funker det ikke på sideposisjon fra mor.

Min bruker får ikke til å gjenskape problemet. 

installerer en fersk database i på dev for å prøve å gjenskape problemet der.

 
h2. Analyse
 * brukeren har de nødvendige rettigheter
 * kallet for manuell sideposisjon bruker path-param, fra mor query-param
 * En feil i Permission resolver gjør at bare kontraktgruppe-rettigheter blir plukket opp ved bruk av query param men ikke kontrakt-rettigheter

h2. Løsning

Legge til evaluering av queryparam for kontrakt-rettigheter

 ",NVDB-6937,Datafangst,
API: Filtrere bort tomme egenskapsverdier,"h2. Observasjon

Innsending til DF via API med tomme egenskapsverdier vil DF tolke som utfylte egenskapsverdier med ingen verdi. Dette inkluderer også egenskapsverdier som enten ikke skal eksistere eller ha en enum-verdi, men altså ikke tom verdi. F.ex Gemini Entreprenør har sendt inn data hvor enum-egenskapsverdier er oppgitt som type _""<id>: """"_ i geojson. 

Frem til nå har API Skriv gitt en feil på dette s.a. API har gitt REJECT tilbake, *men* likevel tatt inn objektene. API Skriv endres nå til å filtrere bort tomme egenskapsverdier s.a. dette er lov å oppgi, men DF-API bør filtrere bort disse s.a. ikke slike egenskapsverdier opptrer i datafanen som endrede verdier uten verdi når de ikke har lov til ikke å ha verdi.

Oppgaven går på å filtrere bort alle egenskaper som har tomme verdier.

Eksempel på geojson som gir denne observasjonen:
{code:java}
{ ""type"": ""FeatureCollection"", ""features"": [ { ""type"": ""Feature"", ""geometry"": { ""type"": ""Polygon"", ""coordinates"": [ [ [10.39241731, 63.43053048], [10.39495434, 63.43043698], [10.39579151, 63.42898665], [10.39272171, 63.42909269], [10.39241731, 63.43053048] ] ] }, ""properties"": { ""tag"": ""Forsterkningslag#1"", ""dataCatalogVersion"": ""2.07"", ""typeId"": 227, ""comment"": ""Usikker på måledatoen"", ""attributes"": { ""5543"": ""20160802"", ""1212"": """", ""1631"": """" } } } ] }
{code}",NVDB-6937,Datafangst,
NVDBREF - 469 Lenke 626064 presenteres i api'et som to segmenter i stedet for et,"En lenke som i NVDB vegnett ser ut til å være 18,114 meter presenteres i api'et ",NVDB-6937,Les-API,
"NVDBREF-466 Valg av Inkluder=""ARMER"" i vegnett gir feil resultat","Det ser ut som man får med seg mer enn armene ut; også midlertidige strekninger (de som er under omklassifisering  gml T-strekninger) samt konnekteringslenker. Se under. 

[https://vegkart-v3.test.atlas.vegvesen.no/#kartlag:geodata/@191522,6572918,11/vegnett:~'geometri*~(arm~'true~kryssystem~'false~sideanlegg~'false)]

!Eksempel arm med feil innhold.JPG|thumbnail!",NVDB-6937,Vegkart,
Markering av sist endret blir ikke borte,"h2. Observasjon

Når en kontrakt er markert som endret i kontraktslisten så blir ikke denne markeringen borte etter å ha besøkt kontrakten.

Kan gjenskapes ved å opprette en kontrakt. Invitere inn en annen deltaker. Logg ut. Logg inn som den andre deltakeren og f.ex laster opp en SOSI. Logg ut. Gå deretter inn som bruker som opprettet kontrakten. Da er kontrakten markert som endret, og kontrakt-id fremkommer i kallet /rest/contract/listchangecounts. Besøk kontrakten. Gå tilbake og se at kontrakten fortsatt er markert.

Tidligere (husker ikke når) var det et kall _/rest/contract/${contractId}/visit_ som gikk da man besøkte en kontrakt. Ser ikke dette nå lengre.

h2. Løsning
Vi knytter oppdatering av visited til åpning av kontrakt i stedet. Da blir det ikke noe eget kall, men forhåpentligvis mer riktig, dekker bl.a. tilfellet der bruker går rett inn på kontrakt med lenke.",NVDB-6937,Datafangst,
Lukker objekt på nytt,"h2. Observasjon

Dette er rapportert fra bruker. Når man registrerer en lukking til NVDB, blir det sendt et endringssett med operasjon Lukk på objektet. Hvis man deretter legger til flere objekter for lukking og trykker registrer, blir også første lukking sendt med på nytt. Gjøres dette på samme dag vil lukkedato stemme overens, men om siste operasjon gjøres en dag senere vil Skriv klage på at versjon til lukking allerede er lukket.

Dette er gjenskapt i kontrakt: [https://datafangst-test.kantega.no/#!/contract/01ee9be7-8331-40b2-8057-3219dee948a9/export]

Del av første endringssett: [https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/89e5dec1-fce5-45ac-af8d-d070fcb64e37]
{noformat}
""lukk"": { ""vegobjekter"": [ { ""lukkedato"": ""2020-02-19"", ""kaskadelukking"": ""JA"", ""typeId"": 96, ""nvdbId"": 85757915, ""versjon"": 6 } ] }
{noformat}
Del av andre endringssett: [https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/fc4696c2-65c0-4b0b-ba71-68e78f8ee13f]
{noformat}
""lukk"": {    ""vegobjekter"": [      {        ""lukkedato"": ""2020-02-19"",        ""kaskadelukking"": ""JA"",        ""typeId"": 96,        ""nvdbId"": 85757912,        ""versjon"": 6      },      {        ""lukkedato"": ""2020-02-19"",        ""kaskadelukking"": ""JA"",        ""typeId"": 96,        ""nvdbId"": 85757915,        ""versjon"": 6      }    ]  },
{noformat}
Opprinnelig problemkontrakt: [https://datafangst.kantega.no/#!/contract/a3f22d82-112d-460f-9ded-3d2985922512/export]

 

*Analyse og retting*

Lukkinger blir alltid håndtert som om de er ""endring"" i datafangst i dag. Dette stemte nok tidligere.

Nå legger vi dirty- og exporting-feltene til grunn når vi velger ut hvilke lukkinger som skal sendes inn.",NVDB-6937,Datafangst,
NVDBREF-447 Sjekk hvorfor objekt har tre vegsystemreferanser,"Det ser ut som de kunne vært slått sammen.

[https://nvdbapiles-v3.atlas.vegvesen.no/vegobjekter/49/91610807/2.json]

 

*Analyse*

De blir ikke slått sammen på grunn av ulike meterverdier. Det er også rare meterverdier, det er et ""ekstra"" segment som ser ut til å gå over hele spennet. Kryssdelen har 2 stedfestinger, 0.89-1 og 0-0.89. Et av segmentene får sluttposisjon 0.89, og da ble stedfestingen 0.89-1 valgt som gir 0 meter siden det er første punkt i første stedfesting. Den skulle valgt 0.89 på den andre stedfestingen som ville gitt lengden fra hele lenken.

FV86 S1D1 m134 KD1 m0-22

FV86 S1D1 m134 KD1 m22-94

FV86 S1D1 m134 KD1 m0-94

*Løsning*

La til en parameter til beregningen av meter som sier om det er start eller slutt som beregnes og ut fra det kan velge riktig stedfesting i tilfeller som dette. ",NVDB-6937,NVDB-IND,
Retry ved connection error,"{quote}
2020-02-19 08:34:48 [queuer] WARN  ProxyConnection - NVDB - Connection oracle.jdbc.driver.T4CConnection@7ff7f947 marked as broken because of SQLSTATE(08006), ErrorCode(17002)
java.sql.SQLRecoverableException: IO Error: Socket read interrupted
    at oracle.jdbc.driver.T4CStatement.executeForDescribe(T4CStatement.java:747)
    at oracle.jdbc.driver.OracleStatement.executeMaybeDescribe(OracleStatement.java:904)
    at oracle.jdbc.driver.OracleStatement.doExecuteWithTimeout(OracleStatement.java:1082)
    at oracle.jdbc.driver.OracleStatement.executeQuery(OracleStatement.java:1276)
    at oracle.jdbc.driver.OracleStatementWrapper.executeQuery(OracleStatementWrapper.java:366)
    at com.zaxxer.hikari.pool.ProxyStatement.executeQuery(ProxyStatement.java:111)
    at com.zaxxer.hikari.pool.HikariProxyStatement.executeQuery(HikariProxyStatement.java)
    at no.vegvesen.nvdb.common.jdbc.dbix.DbSessionImpl.executeQuery(DbSessionImpl.java:185)
    at no.vegvesen.nvdb.common.jdbc.dbix.DbSessionImpl.rows(DbSessionImpl.java:129)
    at no.vegvesen.nvdbind.processor.AbstractBatchQueuer.doReadIds(AbstractBatchQueuer.java:59)
    at no.vegvesen.nvdbind.processor.AbstractBatchQueuer.doReadIds(AbstractBatchQueuer.java:51)
    at no.vegvesen.nvdbind.processor.AbstractBatchQueuer.start(AbstractBatchQueuer.java:45)
    at no.vegvesen.nvdb.threading.prw.Producer.run(Producer.java:25)
    at no.vegvesen.nvdb.threading.prw.Processor$Wrapper.run(Processor.java:282)
    at no.vegvesen.nvdb.threading.prw.Processor.run(Processor.java:71)
    at no.vegvesen.nvdbind.processor.feature.ThreadedFeatureReader.getFeatures(ThreadedFeatureReader.java:62)
    at no.vegvesen.nvdbind.processor.feature.ThreadedFeatureReader.getFeatures(ThreadedFeatureReader.java:33)
    at no.vegvesen.nvdbind.tasks.RebuildSectionCacheTask.run(RebuildSectionCacheTask.java:80)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:199)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:143)
    at no.vegvesen.nvdbind.tasks.DefaultTaskExecutionContext.execute(DefaultTaskExecutionContext.java:42)
    at no.vegvesen.nvdbind.tasks.RebuildCachesTask.run(RebuildCachesTask.java:60)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:199)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:143)
    at no.vegvesen.nvdbind.tasks.DefaultTaskExecutionContext.execute(DefaultTaskExecutionContext.java:42)
    at no.vegvesen.nvdbind.tasks.FullExportTask.run(FullExportTask.java:38)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.execute(TaskExecutor.java:192)
    at no.vegvesen.nvdbind.tasks.TaskExecutor.start(TaskExecutor.java:112)
    at no.vegvesen.nvdbind.NvdbindCore$TaskExecutorThread.run(NvdbindCore.java:488)
Caused by: java.net.SocketTimeoutException: Socket read interrupted
    at oracle.net.nt.TimeoutSocketChannel.read(TimeoutSocketChannel.java:152)
    at oracle.net.ns.NIOHeader.readHeaderBuffer(NIOHeader.java:82)
    at oracle.net.ns.NIOPacket.readFromSocketChannel(NIOPacket.java:139)
    at oracle.net.ns.NIOPacket.readFromSocketCha
{quote}
{quote}
2020-02-18 17:50:22 [daemon] ERROR Dbix - HikariProxyConnection@1228298062 wrapping oracle.jdbc.driver.T4CConnection@18d062c1 closed: false, not valid: true threadLocalSession: null
no.vegvesen.nvdb.common.jdbc.dbix.ConnectionException: Connection closed or not valid
        at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.checkConnection(Dbix.java:87)
        at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:59)
        at no.vegvesen.nvdb.common.jdbc.dbix.Dbix.openSession(Dbix.java:49)
        at no.vegvesen.nvdb.jdbc.NvdbImpl.getSysDate(NvdbImpl.java:47)
        at no.vegvesen.nvdbind.SyncService.getNewTransactions(SyncService.java:31)
        at no.vegvesen.nvdbind.daemon.UpdatePoller.getNewTransactions(UpdatePoller.java:115)
        at no.vegvesen.nvdbind.daemon.UpdatePoller.doPoll(UpdatePoller.java:92)
        at no.vegvesen.nvdbind.daemon.UpdatePoller.run(UpdatePoller.java:57)
        at no.vegvesen.nvdbind.daemon.NvdbindDaemon.daemonThread(NvdbindDaemon.java:94)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
Caused by: java.sql.SQLException: Connection closed or not valid
        ... 14 common frames omitted
{quote}

Ved slike feil skal NVDBIND kunne fortsette ved å prøve på nytt med ny connection.",NVDB-6937,NVDB-IND,
NVDBREF-467: Får bare valgt en veg i hvorutvalget,"Jeg ønsker å få fram vegnett og vegobjekter for EV6 og EV8 i Balsfjord kommune.

Jeg velger først Balsfjord kommune og så EV8, men når jeg skriver inn EV6 skjer det ingenting. Jeg får ikke EV6 opp.

Velger vegobjekt, f.eks. stedsnavn og jeg får bare opp stedsnavn på EV8 i Balsfjord kommune. Jeg ønsket i tillegg å få opp stedsnavn for EV6, men dette lar seg ikke gjøre.",NVDB-6937,Vegkart,
Kontraktsområde blir ikke oppdatert ved transaksjon,"{quote}
Hans Jørgen Ekker

I forbindelse med test av 4729 så ser det ut som jeg har innført to gyldige versjoner av et Kontraktsområde-objekt:
https://www.test.vegvesen.no/nvdb/api/v3/vegobjekter/580/600316727/12?dybde=full
og
https://www.test.vegvesen.no/nvdb/api/v3/vegobjekter/580/600316727/13?dybde=full

Men når jeg søker i basen så skal versjon 12 ha blitt lukket i transaksjon 4714595. (Samme transaksjon som opprettet versjon 13). Er det bare Les som er litt på etterskudd her?

Marvin Lillehaug

Tror det er noe som er feil, ikke på etterskudd. 
På grunn av at det ofte er veldig mange versjoner av kontraktsområder tror jeg det blir litt spesialhåndtert. 
{quote}",NVDB-6937,NVDB-IND,
NVDBREF-471 Enkelte punktobjekter får linjegeometri,"Ved uttak av objekter med segmentert stedfesting får enkelte objekter linjegeometri i stedet for punktgeometri. Og til overmål består linjegeometrien av 2 identiske punkt.

Eksempel for Stedsnavn(343):

[https://www.test.vegvesen.no/nvdb/api/v3/vegobjekter/343?vegsystemreferanse=FV5198S1D10&inkluder=egenskaper,vegsegmenter,metadata]
<segment>
<veglenkesekvensid>1666565</veglenkesekvensid>
<startposisjon>1.4E-7</startposisjon>
<sluttposisjon>1.4E-7</sluttposisjon>
<lengde>0.0</lengde>
<veglenkeType>HOVED</veglenkeType>
<detaljnivå>Vegtrase</detaljnivå>
<typeVeg>Kanalisert veg</typeVeg>
<typeVeg_sosi>kanalisertVeg</typeVeg_sosi>
<startdato>2020-01-01</startdato>
<geometri>
<wkt>
*LINESTRING* Z(-30030.85 6727933.93 102.27, -30030.85 6727933.93 102.27)
</wkt>
<srid>6173</srid>
</geometri>
 
*LINESTRING burde ha vært POINT*",NVDB-6937,NVDB-IND,
Full gjennomgang av domene-klasser,"Vegkart har en domenemappe med klasser som representerer objekter i NVDB.

I mange tilfeller er det overlapp av klasser, og vanskeligheter med å skille domeneklasser fra stateklasser. Noen domeneklasser er ikke i bruk lenger.

Så det trengs en opprydding.",NVDB-6937,Vegkart,
NVDBREF-472 - Følgeoppdatering avvises pga manglende sensitivrolle,"h2. Observasjon

Endringssettet https://www.test.vegvesen.no/nvdb/apiskrivbeta/kontrollpanel/#/jobs/view/94aabcd8-5b3c-49fb-9840-addaf15c5a31 avvises fordi brukeren ikke har rolle til å manipulere sensitive egenskaper. Men det er en følgeoppdatering som ikke (?) endrer slike egenskaper som trigger avvisningen. Det virker litt strengt.

h2. Analyse

Det trigges oppdatering av eksisterende vegobjekter fordi deler av vegnettet lukkes. Et vegobjekt av type Rørledning berøres og dette har sensitive egenskaper. Bruker i dette tilfellet, hanekk, har ingen roller i LDAP som tillater oppdatering av slike egenskaper. I AttributeTypeAuthorizationFilter genereres *ikke* autorisasjonsfeil på ny versjon av rørledningen, fordi der har alle egenskaper (unntatt stedfesting) operasjon READ. Men lukkingen av opprinnelig versjon har operasjon IMPLICIT på alle egenskaper og dermed smeller det...

h2. Løsning

Problemet løses ved å ikke gjøre autorisasjonskontroll på vegobjekter med operasjon MODIFY:CLOSE, det er MODIFY:ADD vi er interessert i.",NVDB-6937,Skriv-API,
Gi tilgang til skjermede data fra Vegkart,"Vi ønsker å gi brukere som har fått tildelt sensitive roller i LDAP  tilgang til skjermede data i NVDB via Vegkart.

 ",NVDB-6937,Vegkart,
Overgang til nytt høydesystem - fra NN 1954 til NN2000,"Alle Z-koordinater skal ved overgang til NN2000 regnes om ved scriptkjøring - se NVDB klassisk sak SVNK-470

Det er ønskelig å få implementert denne endringen i produksjon i midten av mars. I forkant må det gjøres tilpasninger i NVDB API skriv og Datafangst, og vurdering av om det innebærer noe mer enn reindeksering for NVDB api les v2 og v3.

Etter konvertering så vil ikke lengre Skriv godta innsending med NN54 (eller i alle fall SRID som indikerer dette). Datafangst i dag konverterer alle høyder til NN54 før innsending. Vi må endre til at bruk av høydereferanse er konfigurerbar, slik at dette kan skrus om med en bryter når konvertering av NVDB er fullført. I tillegg så må Datafangst endres til å kunne konvertere fra NN54 til NN2000 før innsending, denne konverteringen finnes ikke i Datafangst i dag.",NVDB-6937,Datafangst,
NVDBIND sletter data før full reindeksering,Noe gjør at schemacleanup kjøres ved sletting av eksportmappe.,NVDB-6937,NVDB-IND,
UniversalConnectionPoolException under behandling av endringssett,"h2. Observasjon

En del endringssett har havarert fordi det ikke er ledige connections mot databasene:

{code:java}
Exception occurred while getting connection: oracle.ucp.UniversalConnectionPoolException: All connections in the Universal Connection Pool are in use
	at oracle.ucp.util.UCPErrorHandler.newSQLException(UCPErrorHandler.java:456) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.util.UCPErrorHandler.throwSQLException(UCPErrorHandler.java:133) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl.getConnection(PoolDataSourceImpl.java:2013) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl.access$500(PoolDataSourceImpl.java:198) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl$30.build(PoolDataSourceImpl.java:4353) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl.getConnection(PoolDataSourceImpl.java:1924) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl.getConnection(PoolDataSourceImpl.java:1887) ~[ucp.jar:12.2.0.1.0]
	at oracle.ucp.jdbc.PoolDataSourceImpl.getConnection(PoolDataSourceImpl.java:1872) ~[ucp.jar:12.2.0.1.0]
	at no.vegvesen.vt.nvdb.apiskriv.database.WrappedOracleDataSource.getConnection(WrappedOracleDataSource.java:23) ~[na:na]
	at no.vegvesen.vt.nvdb.apiskriv.database.metric.MetricDataSource.getConnection(MetricDataSource.java:25) ~[na:na]
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.transactional(Jdbc.java:122) ~[nvdbapiskriv-jdbc-2020-1.4.jar:na]
{code}

Se også Splunk: https://loggsentralen.vegvesen.no/loggsentralen/en-GB/app/SVV_nvdb/search?q=search%20index%3Dsvvpnvdb%20host%3Dsvvptomcat25%20OR%20host%3Dsvvptomcat26%20%22Universal%20Connection%20Pool%22&display.page.search.mode=verbose&dispatch.sample_ratio=1&earliest=1579474800&latest=1581548400&sid=1581673723.382900_792DCE67-808E-4AE2-B026-0EE345D04AD5

h2. Analyse

Lengden på tx-skopet ved oppdatering av NVDB i sluttfasen av endringssettbehandling har blitt betydelig lengre i det siste, fordi både AreaLocations og transportlenker genereres *innenfor* transaksjonen for skriving til NVDB. Dette øker risikoen for at connection-pool'en ikke har ledige koblinger i andre tråder.

h2. Løsning

Deler opp databasetransaksjonene mot NVDB i NvdbTransactionWriter i flere mindre transaksjoner der det er mulig.",NVDB-6937,Skriv-API,
Overgang til nytt høydesystem - fra NN 1954 til NN2000,"h2. Bakgrunn

Alle Z-koordinater skal ved overgang til NN2000 regnes om ved scriptkjøring - se sak https://jira.kantega.no/browse/SVNK-470

Det er ønskelig å få implementert denne endringen i produksjon i midten av mars. I forkant må det gjøres tilpasninger i NVDB api skriv og Datafangst, og vurdering av om det innebærer noe mer enn reindeksering for NVDB api les v2 og v3.

Hans Anton Ålien vil sørge for retest av scriptet som endrer Z-koordinatene.

Se også sak for NVDB klassisk https://jira.kantega.no/browse/SVNK-470 sak https://jira.kantega.no/browse/NVDB-5187 for NVDB api Les og https://jira.kantega.no/browse/NVDB-5192 for Datafangst

h2. Analyse

To eller tre enkle tiltak må gjøres i API Skriv:

1) Sett korrekte SRID-verdier i SpatialValue-klassen. Kodeutsnittet under viser dagens SRID-konstanter:

{code:java}
public static final int SRID_WGS84_UTM33N = 32633;
public static final int SRID_EUREF89_UTM33 = 25833;
public static final int SRID_EUREF89_UTM33_NN54 = 6173;
public static final int SRID_EUREF89_UTM33_NN2000 = 5973;

public static final int SRID_CHANGESET_DEFAULT = SRID_WGS84_UTM33N;
public static final int SRID_NVDB = SRID_EUREF89_UTM33;

public static final Set<Integer> SRIDS_COMPATIBLE_WITH_NVDB_SRID = asSet(SRID_WGS84_UTM33N, SRID_EUREF89_UTM33, SRID_EUREF89_UTM33_NN54);
{code}

a) SRID_NVDB må gis verdien av SRID_EUREF89_UTM33_NN2000
b) I SRIDS_COMPATIBLE_WITH_NVDB_SRID fjernes SRID_EUREF89_UTM33_NN54, mens SRID_EUREF89_UTM33_NN2000 legges til

2) Dersom et endringssett leveres med SRID 6173, må det avvises da det har ugyldig høydereferansesystem. Dette kan realiseres som en ny ValueConstraint.
 
3) I dag lagres geometrier fra API Skriv i NVDB med SRID 82347, som er Oracle sin måte å kode SRID 32633 på. Om det skal endres på dette må konstanten ORACLE_SRID_NVDB i klassen SdoGeometry oppdateres. Besluttet i møte 4/3: Bruker 82347 inntil videre. ",NVDB-6937,Skriv-API,
Overgang til nytt høydesystem - fra NN 1954 til NN2000,"Alle Z-koordinater skal ved overgang til NN2000 regnes om ved scriptkjøring - se NVDB klassisk sak https://jira.kantega.no/browse/SVNK-470

Det er ønskelig å få implementert denne endringen i produksjon i midten av mars. I forkant må det gjøres tilpasninger i NVDB api skriv og Datafangst, og vurdering av om det innebærer noe mer enn reindeksering for NVDB api les v2 og v3. https://jira.kantega.no/browse/NVDB-5188 og https://jira.kantega.no/browse/NVDB-5192

 

Hans Anton Ålien vil sørge for retest av scriptet som endrer Z-koordinatene.

 ",NVDB-6937,Les-API,
Øvrige veger - både som sekkepost og detaljert,"Fra demo 2020-02-12 ([https://www.vegvesen.no/wiki/display/NVDBogGeodata/Demo+NVDB+rapporter+2020-02-12])

Data for ""Øvrige veger"" skal håndteres ulikt i genererte veglister fra flytene Arbeid og Produksjon:
 * *Arbeid*: vegliste genereres uten sekkepost.
Dvs full utlisting av alle veger som ellers ville inngått i sekkeposten.
Ønske om at gatenavn føyes til utlisting.
I excel (NVDBREF-375): Ny kolonne. På web tilføyelse Gatenavn: <Oppramsing av Navn fra de gate-objektene i NVDB som overlapper med BK-objektet>


 * *Produksjon*: beholder dagens løsning med sekkepost.",NVDB-6825,Rapportgenerator,
Filer på prosjekter med data mangler nabopunkt rensk,"Per idag så er det en feil på objekter som enda forårsaker at data ikke blir lest inn til NVDB. Dette er nå ""To eller flere nabopunkter i geometrien er mindre enn 0.001 meter fra hverandre"". Datafangst har idag lagt til rette for å utføre rensking når objekter ligger for nære hverandre. Dette fungere kjempefint når jeg laster opp filer til nye datafangst.

Problemet ligger hos datafangst prosjekter som har filer opplaster før denne funksjonen ble implementert. Når jeg redigerer en egenskap på vegopbjektene, så får jeg en notabene som et varsel om at her er det nabopunkter og datafangst har fjernet det. Men dette gjenspeiler seg ikke når en sender data inn til NVDB.

For at jeg skal få lese inn data på slike prosjekter, så bruker jeg å opprette et nytt prosjekt og laster opp filene fra original prosjektet. På den måten får jeg fjernet nabopunktene.

Det jeg ønsker meg er en kanskje en knapp som ""oppfrisker"" geometrien i fil-menyen, uten at en laster fila opp på ny. Dette er jo fordi en ikke har lyst å miste egenskapene som er lagt inn i etterkant av opplasting.",NVDB-6937,Datafangst,
Fil kontroll - Tydeligjøre feil på NVDB objekter,"Kontroll funksjonen i Datafangst har et forbedringspotensial. Nylig har jeg oppdaget noen objekter som bli forkastet pga valideringsfeil. Her finnes det allerede en fin nedtrekksmeny som lister opp hvilke objekter som ble kastet ut og grunnen til dette.

Grunnen til at jeg melder om denne oppdagelsen, er at filen var allerede tilsynelatende ok. Jeg måtte utføre en rensk gjennom et GIS verktøy og eksportere ny fil som skulle bli klar til innlesing. Feilen som førte til valideringsfeil er ""Kun én av NØ eller NØH må oppgis"". I original filen, så er de samme objektene også merket med en feil, men dette kommer ikke tydelig frem noen sted. Her er feilen ""Høyde -2466526 er urimelig lav"".

Det jeg ønsker da er et eget filter som kan skille ut alle objektene med Type = feil. Dette gjør det lettere for oss å samle alt som må rettes opp og rapporte tilbake til entreprenør.",NVDB-6937,Datafangst,
NVDBREF 462 - Ufullstendig vegsystemreferanse på en enkelt veglenke,"[En lenke på en rampe viser ufullstendig vegsystemreferanse, viser kun EV18, strekning eller delstrekning og meterverdier vises ikke. Hans Jørgen har sjekket vegnettet og det ser rett ut. Er det feil ved visning i Vegkart eller er det api'et som gir ut feil verdi?|https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@235713,6639465,18/vegnett]

 

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@235713,6639465,18/vegnett]{color:#3d3c40}:(trafikantgruppe:'alle,veglenketype:'alle,adskiltelop:'alle){color}",NVDB-6937,Les-API,
Leveranseinformasjon Lese API V3 2020.3.0,"*Test i AT:*
 * NVDB-5036: Må vente til sensitive roller er på plass + reindeksering av sensitive egenskaper er gjort. Testes senere.
 * NVDB-5095: Sjekk at feltet medium_nvdb blir gitt ut for geometrien til objekter
 * NVDB-5126: Sjekk Splunk ihht sakens beskrivelse

Saker som ikke er nevnt trenger ikke eksplisitt test i ATM.",NVDB-6937,Les-API,
"API Skriv lager ""hull"" i lokasjonsattributter for noen områdetyper","h2. Observasjon

Klassiske klienter, for eksempel NVDB123 viser fortsatt flere områdegrenser enn fylke og kommune. Derfor må denne mangelen fikses.

Fra beskrivelsen i: [https://www.vegvesen.no/jira/browse/NVDBREF-421] registrert 2020-01-20 

Det har dukket opp noen feil av type ""hull"" i lokasjonsattributt for områder etter vegnettsredigering. Det viser seg at dette også gjelder fylke 2019 og kommune 2019 (i første omgang trodde vi det ikke var feil i disse.)

I øyeblikket er det snakk om disse lenkene:
||Featuretype||Featureid||FeatureStartpos||FeatureEndpos||Netelementid||startdate||enddate||fylkenr||kommunenr||vkat||vstov||vegnr||hp||frameter||tilmeter||Feilid||
|532|292207048|0.91751703|0.9814527|704696|2011.04.06| |4|0|F|V|201|4|7987|8484|2123639296|
|532|292207049|0.9814527|1.0|704696|2011.04.06| |4|0|F|V|201|4|8484|8626|2123639297|
|532|1006511990|0.04606171|0.5428323|2140603|2020.01.10| |4|37|P|V|97559|1|11|133|2123639298|
|532|361115726|0.76114295|1.0|2216339|2011.01.10| |7|16|P|V|97912|1|0|185|2123639299|
|532|330044257|0.0|0.04606171|2140603|2009.07.01| |4|37|P|V|97559|1|0|11|2123639300|

Det siste eksemplet, lenkesekvens 2140603 ble lest inn i NVDB i dag ettermiddag:

[https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/deea8f87-c2e7-447e-8869-26936ce69c03]

Oversikt over lokasjonsattributt for områder for nettelement med id 2140603

FT_ID F_ID V_ID N_ID STARTDIST ENDDIST
 ---------- ---------- ----- ---------- ---------- ----------
 946 1002101499 1 2140603 0 .04606171
 945 1006202690 1 2140603 0 1
 946 1002101498 1 2140603 .04606171 1
 534 1 1 2140603 .5428323 1
 535 5 1 2140603 .5428323 1
 536 84 1 2140603 .5428323 1
 537 459 1 2140603 .5428323 1
 579 488 1 2140603 .5428323 1

Områdetype 534, 535, 536, 537 og 579 må også oppdateres i areaLocations.

Mangler i prod rettes jevnlig med script. Nye mangler avdekkes gjennom de nattlige datakontrollene. 

h2. Analyse

Ser på endringssettet angitt over, og spesielt på AreaLocations som genereres fra veglenkesekvens 2140603. Denne ligger tilsynelatende i Tynset kommune, tett opp mot (og toucher) kommunegrensen til Alvdal: https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/hva:(~(farge:'0_0,id:536))/@273842,6906127,16/vegnett:(trafikantgruppe:'alle,veglenketype:'alle,adskiltelop:'alle)/vegobjekt:85:40a744:536.

Veglenkesekvensen har tre veglenker fordelt på posisjonsintervallene 0.0 - 0.04606171, 0.04606171 - 0.5428323, 0.5428323 - 1.0. Førstnevnte har angitt kommunenr 3428 (Alvdal), de to siste har kommunenr 3427 (Tynset). AreaLocations for Kommune (946) fordeles derfor tilsvarende. Hullene oppstår når det skal genereres AreaLocations for Kommune_2019 (536). Dette skjer i AreaLocationHarvester ved å matche veglenkegeometrien mot geometrien (polygonet) til Kommune_2019-objektene ""i nærheten"". Det gjøres et søk direkte i vegobjekttabellen for Kommune_2019 i NVDB ved hjelp av spesielle geometrioperatorer. Dette finner kommunene som overlapper veglenkesekvensen. Nøyaktig hvilke kommuner og hvor stor del av veglenkesekvensen som hører hjemme i de ulike kommunene beregnes programmatisk etterpå. For veglenkesekvens 2140603 finner imidlertid geometrisøket bare overlapp med Tynset kommune, antagelig fordi geometrien til veglenke 1 stryker langs kommunegrensen mellom Tynset og Alvdal. Når posisjonsintervallene beregnes med stor nøyaktighet etterpå tilordnes bare veglenke 2 og 3 Tynset, mens veglenke 1 utelates siden den ikke matcher med Tynset.

Øvrige innslag i AreaLocations for Fylke_2019, Region, Politidistrikt og Vegavdeling blir alle avledet fra de beregnede Kommune_2019-innslagene. Når det er hull for sistnevnte vil det forplante seg til disse.

h2. Løsning

Ved geometrisøk etter overlappende kommuneobjekter, utvides geometrien til veglenkesekvensen med et ""buffer"" på 5 m for å sikre at nabokommuner tas med når vegnettsgeometrien toucher kommunegrenser. I dette tilfellet fører dette til at både Tynset og Alvdal får treff og posisjonsintervallene for de to kommunene beregnes deretter slik:

Alvdal: 0.0 - 0.04584709
Tynset: 0.04584709 - 1.0

Skillet mellom kommunene (posisjon 0.04584709) avviker med ca 5 cm sammenlignet med kommunenummereringen på veglenkene (0.04606171). Dette skyldes at noden mellom veglenke 1 og 2 ikke er plassert 100% nøyaktig på kommunegrensen.
",NVDB-6937,Skriv-API,
NVDBREF - 459 Operator-feil ved filterering av vegobjekter,"Jeg velger EV8 og Skred og får opp at det er 38 vegobjekter. Skriver ut til CSV.
 Jeg ønsker å filtrere søkeresultatet mitt. Først på type skred, Velger ""=Snø"", får ingen treff. Dette er feil da det er mange snøskred i CSV-lista. Velger så ""!=Snø"", skriver ut resultatet til CSV og får da ut alle skredtyper som ikke er Snø, dette resultatet er riktig. Velger så ""har verdi"" og får ingen treff, til tross for at alle skredene har verdi for ""Type skred"".

[https://www.utv.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@656092,7713661,8/hva:~(~]
 (filter~(~(operator~'*21*3d~type_id~2326~verdi~null))~id~445))/hvor:~(vegsystemreferanse~(~'EV8))

Filtrerer på ""Blokkert veglengde"". Får ikke opp noen resultat når operator er ""="", men når jeg velger ""!="" får jeg opp resultater. 
 Antall objekter ser ut til å være 38 for alle valg som gir treff.",NVDB-6937,Vegkart,
NVDBREF - 458 - Vegkart viser feil antall forekomster ved kategorisering,,NVDB-6937,Vegkart,
Mobilvisning: Blank boks legger seg over kartet,"h2. Observasjon

På mobil (iPhone8 / Chrome) søker jeg etter tunneller. Tar opp panel. Da får jeg vedlagt bilde 1. En blank boks ligger under søkeresultatet. Velger jeg første treff i lista, for deretter å trykke på tunnelløp-datter så ser jeg mye ekstra space under relasjoner (bilde 2).

Men hovedproblemet kommer når jeg fjerner tunnel fra søket. Da legger det seg en blank boks over hele siden uten mulighet til å komme unna (bilde 3).",NVDB-6937,Vegkart,
NVDBIND kan konfigureres fra Forvaltning,,NVDB-6937,NVDB-IND,
"ORA-00936: missing expression, relasjonsspørring","{quote}
Slf4jActivityLogger: Feil i transaksjon 2b07888f-4895-1453-367a-74d225dddd79:
Uventet feil for URL: http://www.vegvesen.no/nvdb/api/v3/vegobjekter/95/statistikk?segmentering=true&kartutsnitt=-445917.7345639113%2C6416283.581025881%2C856943.5945639112%2C6896992.37897412&egenskap=area%28945%2C30%29%20AND%20egenskap=relasjon%2896%2C%20egenskap%285530%29=null%29&alle_versjoner=false
java.sql.SQLSyntaxErrorException: ORA-00936: missing expression
{quote}
{quote}
Slf4jActivityLogger: Feil i transaksjon 2a45f29d-1e1c-dc3e-a9ef-9a4cb5dc71db:
Uventet feil for URL: http://www.vegvesen.no/nvdb/api/v3/vegobjekter/95/statistikk?segmentering=true&kartutsnitt=-445917.7345639113%2C6416283.581025881%2C856943.5945639112%2C6896992.37897412&egenskap=area%28945%2C30%29%20AND%20egenskap=relasjon%2896%2C%20egenskap%285530%29=null%29&alle_versjoner=false
java.sql.SQLSyntaxErrorException: ORA-00936: missing expression
{quote}",NVDB-6937,Les-API,
Gråtonekart i datafanen,"Det er et ønske om å tilby et gråtonekart i datafenen. Ref Vegkart som i dag tilbyr visning på et gråtonekart.
h2. Løsning

Gråtonekart er implementert som en toggle, som ligger ved siden av kartlag-velgeren.
Gråtonekartet er et filter som skal fungere på alle kartlagene",NVDB-6937,Datafangst,
Vise hvilken lås som hindrer registrering ved VENTER_PÅ_LÅS status,"Når brukere får status VENTER og årsak VENTER_PÅ_LÅS fra API Skriv så er det en liten prosess å gå gjennom Kontrollpanel hos Skriv for å se hvilken lås som blokkerer denne registreringen.

Dette kunne vært løst ved at Datafangst henter opp blokkerende lås og gir informasjon om denne til brukeren i eksportfanen. F.ex kallet

[https://www.test.vegvesen.no/nvdb/apiskriv/kontrollpanel/data/lock?max=10&skip=0&sortBy=TIME&sortAscending=true&blockingJobId=0cb46176-d924-4135-900d-84d2454c3135]

Brukes av API Skriv for å vise blokkerende låser for et gitt endringssett. Lenke over gir info
{noformat}
{""count"":1,""locks"":[{""lockId"":16362410,""username"":""lillir"",""fullName"":""Lillian Røang"",""created"":""2020-01-09T12:57:00Z"",""type"":""NORMAL"",""networkLock"":true,""featureTypes"":""Feltstrekning, Vegsystem, Strekning + 11 til"",""refLinks"":""0.0-1.0@1004310, 0.0-1.0@1060089, 0.0-1.0@1036423 + 144 til""}]}
{noformat}",NVDB-6937,Datafangst,
Re-stedfesting av datter ved re-stedfesting av mor,"Ved restedfesting av mor (både nytt objekt og eksisterende NVDB objekt) - enten som manuell endring av stedfesting eller ved geometriendring som trigger re-stedfesting - bør også datter/døtre få oppdaterte sine stedfestinger.

Dette kan skje automatisk med en liten beskjed til bruker, eller som et valg der bruker kan velge bort å re-stedfeste datter/døtre.

Dette scenarioet har kommet fra en bruker på support.",NVDB-6937,Datafangst,
Fjern støtte for responsrevisjon 0,"Finn oversikt over hvem som fortsatt ikke har tatt i bruk rev1 og be dem migrere.

Splunk for februar viser at det er
 * Vegkart (ny versjon i ATM benytter revisjon 1)
 * NVDB2TNE
 * Sweco

som benytter revisjon 0
{noformat}
https://loggsentralen.vegvesen.no/loggsentralen/en-US/app/SVV_nvdbapil/search?q=search%20host%3Dsvvpnvdb*%20AND%20(source%3D*api-v3-request.log%20OR%20sourcetype%3Dnvdbapil-api-v3-request%3ANA-log)%20AND%20%22application%2Fvnd.vegvesen.nvdb-v3-rev0%2Bjson%22%20%20%7C%20stats%20count%20by%20ACCEPT%2C%20CLIENT&display.page.search.mode=fast&dispatch.sample_ratio=1&earliest=1580511600&latest=1583017200&display.page.search.tab=statistics&display.general.type=statistics&display.statistics.sortColumn=count&display.statistics.sortDirection=desc&sid=1583246329.124186_792DCE67-808E-4AE2-B026-0EE345D04AD5 
{noformat}
Se vedlagt bilde.",NVDB-6937,Les-API,
HTTP 500 ved henting av endringssett,"h2. Observasjon

[https://www.vegvesen.no/nvdb/apiskriv/rest/v3/endringssett/2e347a69-7734-41f0-a12b-df2cb1beb81f]

gir HTTP 500 med
{noformat}
{""message"":[""Illegal attribute subclass: no.vegvesen.vt.nvdb.apiskriv.domain.attribute.SpatialStructAttribute""]}
{noformat}
Vedlagt er endringssett som forårsaket dette.

h2. Analyse

Exception kastes fra AttributeTransforms.fromPartialAttribute fordi det mangler en switch-case for delvis egenskap av type SpatialStructAttribute.

h2. Løsning

Oppdaterer AttributeTransforms.fromPartialAttribute med case for SpatialStructAttribute som delegerer til ny metode fromPartialSpatialStructAttribute.",NVDB-6937,Skriv-API,
Egengeometri blir normalisert basert på datakatalogen.,"Noen klager på at de får skrevet multilinestring og ikke får det ut igjen.

{quote}
Sender nytt objekt i endringssett med MULITILINESTRING som egengeometri. Når jeg leser inn dette objektet igjen via les, får jeg tilbake LINESTRING bestående av første linje i innsendt MULTILINESTRING.
Se følgende endringssett (test.vegvesen.no)

Endringssett: c5b7b0fe-49df-41d5-941f-b1831e4d09f9

Objektet hentet tilbake via les:
https://www.test.vegvesen.no/nvdb/api/v3/vegobjekter/470/1006280077/1
{quote}

Dette skjer i OracleFeatureReader.normalizeGeometry",NVDB-6937,NVDB-IND,
Ukjent parameter: typeveg veglenkesekvenser?typeveg=enkelBilveg,"https://www.vegvesen.no/nvdb/api/v3/vegnett/veglenkesekvenser.json?typeveg=enkelBilveg gir 
{code:json}
[
   {
       ""code"": 4013,
       ""message"": ""Ukjent parameter: typeveg"",
       ""help_url"": ""https://nvdbapilesv3.docs.apiary.io/#/reference/0/vegnett""
   }
]
{code}",NVDB-6937,Les-API,
Sette geometri for objekter,"*Problem*

Flere brukere har problemer med nøyaktighet når de skal endre et objekts geometri med dagens ""rediger geometri"" funksjon. I tillegg vil en ikke helt nøyaktig geometri gi ulik stedfesting om et objekt skal sammenkobles med et annet objekt, f.ex ved å bytte et objekt med et annet.

*Mulige alternativ*
 * Gi brukerne mulighet for å lime inn en geometri (type wkt-streng) for et valgt objekt
 * Kopiere en geometri fra et eksisterende objekt (enten NVDB-objekter som er importert i kontrakten eller gjennom en kopieringsknapp i modalen for vsining av NVDB-objekter i kartet). Denne funksjonen kunne blitt utført på alle valgte objekter - evt bare kopiere til clipboard for videre å lime inn for enkeltobjekter.

Løsningsalternativ bør diskuteres litt nærmere.

*Melding fra bruker*
{noformat}
Det blir en del tilfeller av at eksisterende objekt i NVDB flyttes på eller måles inn fra å ikke ha vært målt tidligere. Manga av disse tilfellene ville det ha vært en stor fordel å kunne beholde eksisterende NVDB-id da den kan vær koblet mot andre systemer eller lignende. Quick fix på det problemet kunne ha vært å ha mulighet for å kopiere med seg egengeometrien med Kvalitetsparametrene og så ha mulighet til å lime de inn på eksisterende. Ses dette på som en mulighet det skal jobbes mot frem i tid?
{noformat}
 
{noformat}
Det beste hadde vært om det var mulighet for å massivt koble ny geometri(enten fra Sinus eller SOSI-filer) til nærmeste eksisterende objekter som ligger i NVDB fra før, innenfor samme objekttype som i sosi-fila selvsagt. Litt som stedfestinga funker i dag f.eks. Bruken av dette ville ha vært veldig bra for de tilfellene jeg nevner under, og for å skifte ut objekter koblet direkte på vegreferanse med egengeometri fra FKB-data eller annet som måles inn nytt uten å ha koblet til data fra NVDB gjennom innmålingsløsning.
{noformat}",NVDB-6937,Datafangst,
NVDBREF- 447 Trafikkøy-CSV-fil det listes opp for mange objekter i fila,"Jeg Zoomer meg inn til første rundkjøring på FV86, ca. FV86 S1D1 m130.
 Søker opp trafikkøy og får tegnet 3 objekter i kartet.

[https://www.utv.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@639341,7665314,18/hva:~(~(id~49]))

Trykker på "">"" for å se vegsystemreferansene til disse trafikkøyene, og her kommer det opp 5 referanser. Jeg laster ned CSV-fil og legger denne med her.

Her ser det ut til at det er 3 sentraløyer til rundkjøringa, men det er bare 1. Dette bør rettes opp.",NVDB-6937,Vegkart,
Azerbaijan / Georgia,"Observasjon

Kartet vbil i enkelte tilfeller lastes feil og vise bare grå tiles, bortsett fra Azerbaijan eller Georgia oppe i hjørnet.

Analyse
 * Gjenskapbart ved veldig bredt vindu
 * Georgia ved moderat bredt, Azerbaijan ved bredere
 * Ved brede vinduer vil også kartet vise mye udefinert kart ved default zoomnivå
 * Symptomene dempes ved å justere default zoom-nivå ett hakk.

Løsning

justerer default zoom-nivå

 ",NVDB-6937,Datafangst,
Oppdatere info-boksen Vegkart v2,"Forslag til tekst i info-boks for Vegkart v2:

{color:#0747a6}*Vegkart med gammelt vegreferansesystem*{color}

{color:#0747a6}Denne versjonen av Vegkart baserer seg på gammelt vegrefeansesystem og forholder seg også til kommune- og fylkestrukturen fra 2019 og vil senest bli faset ut 1/8-2021.{color}

{color:#0747a6}Ny versjon av Vegkart med nytt referansesystem finnes her:{color}

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@600000,7225000,3] 

 ",NVDB-6937,Vegkart,
Hoppende meter,"{quote}Vår leverandør Viatech har funnet en snål feil i spørringer mot veg/ endepunktet på veglenkesekvens 2497857, som har snudd metrering på hele veglenkesekvensen . Meterverdiene ""skifter retning"", dvs teller først nedover (riktig), og deretter oppover (galt) når du ber om posisjoner fra 0 til 1.

0.0@2497857 -> EV136 S5D1 m4305
 0.1@2497857 -> EV136 S5D1 m4375
 0.2@2497857 -> EV136 S5D1 m3748
 0.3@2497857 -> EV136 S5D1 m3818
 0.4@2497857 -> EV136 S5D1 m3887
 0.5@2497857 -> EV136 S5D1 m3957
 0.6@2497857 -> EV136 S5D1 m4027
 0.7@2497857 -> EV136 S5D1 m4096
 0.8@2497857 -> EV136 S5D1 m4166
 0.9@2497857 -> EV136 S5D1 m4235
 1.0@2497857 -> EV136 S5D1 m4305

Denne veglenkesekvensen har to veglenker, fra 0 til ca 0.13, og fra 0.13-1. Jeg ser ingenting rart eller mystisk på disse, men utelukker ikke at det er noe snålt jeg overser.

Ut fra litt klikking på Vegkart v3 i UTV - miljøet så klarer jeg lett gjenskape problemet med synkende, deretter stigende meterverdier langs E136 i dette området
 [https://www.utv.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@110664,6959636,16]
 Så det ser dessverre ut som om dette ikke er en feil som er retta i kommende versjoner (ennå)...
{quote}
 

Tillegg

---------- 

Det er hoppende meter langs stedfesting av rekkverk også. Det var en sak på dette tidligere hvor meterverdier hoppet i sak NVDB-4986.

Se vedlegg feilmeter_1-3.png .     

Lenke til visning i vegkart:  [https://vegkart-v3.atlas.vegvesen.no/#kartlag:geodata/vegsystemreferanse:157078.14748962832:6533374.608415884/hva:(~(farge:'0_0,id:5))/hvor:(vegsystemreferanse:(~'EV18S20-21))/@158329,6533722,12/vegobjekt:218329497:40a744:5] . 

 

 

Tillegg 2:

--------------

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/vegsystemreferanse:248855.45432158827:6622518.368734654/@248389,6622785,13/vegnett:(trafikantgruppe:'alle,veglenketype:'alle,adskiltelop:'alle)]

Se vedlegg tillegg2_feilmeter1-4.png 

 

 

 

 

 

 

 ",NVDB-6937,Les-API,
RunTimeException ved beregning av sideposisjon,"h2. Observasjon

Endringssettet https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/1df5e245-70dc-4468-a7fb-85fb2176f987 havner i SYSTEMFEIL i sluttfasen av restedfesting av vegobjekter pga oppdatert vegnettsgeometri:

{code:java}
java.lang.RuntimeException: No line segment found for refLinkPosition 1.0
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.lambda$lineSegmentFromPosition$4(SidePositionCalculator.java:146)
	at java.util.Optional.orElseThrow(Optional.java:290)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.lineSegmentFromPosition(SidePositionCalculator.java:146)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePositionForPointLocational(SidePositionCalculator.java:106)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.calculateSidePosition(SidePositionCalculator.java:94)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareSidePositions(SidePositionCalculator.java:80)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.SidePositionCalculator.compareUpdatedSidePositionToOld(SidePositionCalculator.java:50)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.compareUpdatedSidePositionToOld(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:497)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.lambda$addEnrichmentOrReportConflict$10(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:443)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.EnrichmentEvaluator.evaluate(EnrichmentEvaluator.java:115)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:487)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:153)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:122)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$13(JobWorker.java:389)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$validateBeforeLock$14(JobWorker.java:388)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:387)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

SidePositionCalculator forsøker å finne linjesegmentet av en veglenkegeometri som en relativ posisjon tilhører. Algoritmen i RefLinkPart.getLineSegmentAtPosition finner ikke et slikt linjesegment for posisjon 1.0, selv om veglenken dekker denne posisjonen. Årsaken er mangel på numerisk presisjon ved summering av linjesegmentlengder.

h2. Løsning

Bruker en DoubleComparator som tillater avvik noen brøkdels millimetere ved sammenligning av lengder.",NVDB-6937,Skriv-API,
Datafane: Får ikke satt lengde for rørledning og kabel,"Observasjon

Last inn vedlagte SOSI. Disse har ikke egenskapen lengde satt, s.a. beskrivende navn beregner lengde. Prøv å sette lengde i egenskapen ""Lengde"" (vis alle egenskaper først). Da får du satt lengde med heltall, men ikke som desimaltall. API Les oppgir at denne egenskapen er Flyttall:

[https://www.utv.vegvesen.no/nvdb/api/v3/vegobjekttyper/77.json]
{code:java}
{
""id"": 1322,
""navn"": ""Lengde"",
""kortnavn"": ""leng"",
""beskrivelse"": ""Angir lengde av vegobjektet"",
""kategori"": 23,
""egenskapstype"": ""Flyttall"",
""datatype"": ""Tall"",
""sensitivitet"": 0,
""sorteringsnummer"": 18,
""veiledning"": ""Kan beregnes av egengeometri (linje/kurve). Skal angis manuelt om manglende/mangelfull egengeometri"",
""viktighet"": ""BETINGET"",
""sosinvdbnavn"": ""Lengde_1322"",
""skrivebeskyttet"": false,
""nøyaktighetskrav_grunnriss"": 0,
""høydereferanse_tall"": 0,
""nøyaktighetskrav_høyde"": 0,
""referansegeometri_tilstrekkelig"": false,
""avledet"": false,
""obligatorisk_verdi"": false,
""gruppesorteringsnummer"": 0,
""lengdeavhengig_verdi"": false,
""ajourhold_snu"": false,
""standardverdi"": 0,
""min_anbefalt"": 0,
""maks_anbefalt"": 3000,
""min"": 0,
""maks"": 9999.9,
""desimaler"": 1,
""feltlengde"": 6,
""enhet"": {
""id"": 1,
""navn"": ""Meter"",
""kortnavn"": ""m""
},
""fortegnsendring_snu"": false
},
{code}",NVDB-6937,Datafangst,
Ratelimit V3,https://resilience4j.readme.io/docs/ratelimiter,NVDB-6937,Les-API,
Ratelimit V2,https://resilience4j.readme.io/docs/ratelimiter,NVDB-6937,Les-API,
Søk på vegobjekt med dybde>=2 gir ukomplette relasjoner,"Ved søk på vegobjekt med dybde>=2 får man ut full beskrivelse på noen av relasjonene, men ikke på andre.

Eksempel: [https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/67/85346775/5?inkludergeometri=utledet&dybde=2&inkluder=alle]

Under relasjonen ""Betongutstøpning"" får jeg full informasjon om ett av vegobjektene, men ikke det andre. Se vedlagt bilde.

Vegobjekt jeg ikke får full informasjon om: [https://nvdbapiles-v3.utv.atlas.vegvesen.no/vegobjekter/71/85347379/1?inkluder=alle]",NVDB-6937,Les-API,
Støtt import av vegobjekter med Les API v2,"Brukere har gamle lagrede URL'er med Les API v2, så vi må støtte v2 i tillegg til v3",NVDB-6937,Datafangst,
"Assosierte egenskaper får alltid ""undefined"" i visning av valgt objekt.","På tide å gjøre noe med disse?

[https://vegkart-v3.utv.atlas.vegvesen.no/#kartlag:geodata/@275971,7041297,13/hva:~(~(id~67))/valgt:85346775:67]",NVDB-6937,Vegkart,
Datakontroll - unike sekvensnumre for streknings-objekter,"Jørn Vidar oppdaget et tilfelle hvor en privat veg har to tilfeller av samme sekvensnummer innenfor samme strekning. Vi ønsker i første omgang å se omfanget av dette problemet, og om nødvendig lage et datakontroll-script som holder oversikten over tid.",,Database,
Logg innkommende request (V2),Nå logges kun fullførte requester. Logg innkommende requester til requestlogg.,NVDB-6937,Les-API,
Logg innkommende request (V3),Nå logges kunn fullførte requester. Logg innkommende requester til requestlogg.,NVDB-6937,Les-API,
Vegobjekt uten geometristruktur i søk,"Datafangst har fått feilmelding fra bruker om en API-import som feiler, med denne URL'en: [https://www.vegvesen.no/nvdb/api/v3/vegobjekter/49.json?segmentering=true&vegsystemreferanse=F&egenskap=(area(945%2C34))%20AND%20(10768%3D17447)&inkluder=lokasjon%2Cmetadata%2Cegenskaper%2Cgeometri]

Når jeg ser på dataene jeg får ser jeg at vegobjekt med ID 88357242 mangler ""geometri"" på toppnivå, og det er derfor Datafangst gir feil. Når jeg går direkte på objektet ([https://www.vegvesen.no/nvdb/api/v3/vegobjekter/49/88357242/2.json]) får jeg ut geometri, og noen av dataene for stedfesting virker mer fornuftige (lengde ""0"" i søk, mens lengde er satt når jeg får direkte på vegobjekt).

 

Ekstra info:

- Objektet 88357242 har ikke egengeometri som de andre objektene som kommer opp i søket.

- I utlisting fra søket ser det ut som alle objektene ikke har egengeometri, men hvis man går inn på objektene har de fleste egengeometri (bortsett fra den over)",NVDB-6937,Les-API,
Leveranseinformasjon Datafangst 2020-1.0.4,"h2. Leveranseinformasjon Datafangst 2020-1.0.4

*Test i AT*
 * NVDB-5119: Retting på innsending av korrigerte NVDB-objekter. Testes ved å sende inn et korrigert NVDB-objekt. Kan også teste innsending av et nytt barn som kobles til en eksisterende NVDB-mor.

Det er kun nevnte sak som ligger i denne leveransen.",NVDB-6937,Datafangst,
Kobling til mor i NVDB bør sendes inn som UPDATE,"Fra NVDB-5119: Når vi sender inn en kobling til mor i NVDB, er dette er endring utover det som bør være på korrigér. Mor bør ha operasjon ""oppdater"" i dette tilfellet. 
Dette kan vi sette selv når vi henter mødre fra NVDB.",NVDB-6937,Datafangst,
Korrigering setter ny gyldighetsdato,"h2. Observasjon

En bruker har nye barn som kobles til NVDB-mor. Ved registrering sender DF inn overskrivende oppdatering = JA. Dette betyr korrigering. Samtidig sendes også ny gyldighetsdato inn. Det skal ikke en korrigering av egenskaper og assosiasjoner (her) ha. **MEN** det hadde vært riktigst å lage en ny versjon av mor når mor får nye barn. Da burde ikke overskrivende oppdatering = JA være med.

Kontrakt i DF: [https://datafangst.kantega.no/#!/contract/2e3e39c6-6d9a-4ab7-aa48-dc95d9072f4b/export]

Endringssett i Skriv: [https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/df5e44f9-05e7-40fd-aa18-fc09389eea39]

Aktuell del fra endringssettet:
{noformat}
{""delvisOppdater"": { ""vegobjekter"": [ { ""gyldighetsperiode"": { ""startdato"": ""2020-01-30"" }, ""validering"": { ""lestFraNvdb"": ""2020-01-30T16:23:44.447"" }, ""typeId"": 57, ""nvdbId"": 846434436, ""versjon"": 3, ""overskriv"": ""JA"", ""egenskaper"": [ { ""typeId"": 11055, ""verdi"": [ ""Driftskontrakt"" ], ""operasjon"": ""oppdater"" } ], ""assosiasjoner"": [ { ""typeId"": 220122, ""tempId"": [ ""bacc5216-5ffe-49b9-af4e-ca67bf5d6e20"", ""8a521621-aaaa-4538-af82-0823d8d5b769"", ""172880c2-3c9d-47e8-bb0f-51ca3c78555e"" ], ""nvdbId"": [], ""operasjon"": ""oppdater"" } ] }, { ""gyldighetsperiode"": { ""startdato"": ""2020-01-30"" }, ""validering"": { ""lestFraNvdb"": ""2020-01-30T16:23:44.698"" }, ""typeId"": 57, ""nvdbId"": 846434440, ""versjon"": 2, ""overskriv"": ""JA"", ""egenskaper"": [ { ""typeId"": 11055, ""verdi"": [ ""Driftskontrakt"" ], ""operasjon"": ""oppdater"" } ], ""assosiasjoner"": [ { ""typeId"": 220122, ""tempId"": [ ""8a54b7f8-e0bc-40c3-9f7c-f26fb8329623"" ], ""nvdbId"": [], ""operasjon"": ""oppdater"" } ] } ] }
{noformat}",NVDB-6937,Datafangst,
Fjern ActivityLogger,"Vegkart, Eksport, API og NVDB logger til database. Dette ble sikkert laget før Splunk. 
Det er ikke noe behov for å logge til database lengre. Fjern logging til database.",NVDB-6937,Eksport,
Fjern ActivityLogger,"Vegkart, Eksport, API og NVDB logger til database. Dette ble sikkert laget før Splunk. 
Det er ikke noe behov for å logge til database lengre. Fjern logging til database.",NVDB-6937,Vegkart,
Fjern ActivityLogger,"Vegkart, Eksport, API og NVDB logger til database. Dette ble sikkert laget før Splunk. 
Det er ikke noe behov for å logge til database lengre. Fjern logging til database.",NVDB-6937,NVDB-IND,
Vegnettsparametere endres i direktelenking.,"Åpne [https://vegkart-v3.utv.atlas.vegvesen.no/#kartlag:geodata/@600000,6872424,3/vegnett:~'geometri*~()] og se at hashen endrer seg til å si [https://vegkart-v3.utv.atlas.vegvesen.no/#kartlag:geodata/@600000,6872424,3/vegnett:~'geometri*~(arm~'false~kryssystem~'false~sideanlegg~'false)] i stedet.

Forventet hash og vegnettsfilter er den/det samme som man taster inn.",NVDB-6937,Vegkart,
Endepunkt /omrader gir ikke ut geometri,"Endepunkt for fylke/kommune tilsier at en kan hente ut geometri: https://www.vegvesen.no/nvdb/api/v3/omrader/kommuner?inkluder=asdf

Ugyldig verdi for parameteren 'inkluder': 'asdf'. Gyldige verdier: [kartutsnitt, polygon, senterpunkt, vegobjekt, alle]

Men inkluder=polygon gir ikke noe polygon. 
Parameter inkluder er ikke dokumentert.

 

Eksempel:
[https://www.vegvesen.no/nvdb/api/v3/omrader/kommuner?inkluder=polygon]
[https://www.vegvesen.no/nvdb/api/v3/omrader/fylker?inkluder=polygon]

gir ingen geometri i responsen.

 

 ",NVDB-6937,Les-API,
Endepunkt for å hente datarettigheter,"Ønske fra Per Ola Roald:

Rettigheter for å endre: ""Det finnes ikke et offisielt endepunkt for dette, men datafangst har et internt endepunkt som bl.a Sinus har brukt. Problemet med dette er at det endrer seg uten varsel, siden det ikke er versjonert og dokumentert med tanke på at andre skal bruke det.

Det vi har behov for er et endepunkt i skriv som gir ut datarettigheter.

 

Tore skriver:

Dette er en enkel ting å legge inn i API Skriv. Omlag et dagsverk vil jeg tro.

Informasjonen er lagret i API Skriv sin applikasjonsdatabase, ikke NVDB eller andre generelle databaser i SVV. Det må derfor tilgjengeliggjøres gjennom eget endepunkt i API Skriv.",NVDB-6937,Skriv-API,
Feil ved henting av barn i objektvisning,"h2. Observasjon

Hent opp
{noformat}
https://vegkart-v3.utv.atlas.vegvesen.no/#kartlag:geodata/@254273,7040564,8/hva:~(~(id~581))/valgt:85348132:581
{noformat}
Trykk på barn (tunnelløp). Da kastes feil
{noformat}
Uncaught (in promise) TypeError: Cannot read property 'relasjoner' of null 
at Object.t.addLoadedRelatedRoadObject (functions.ts:91) 
at t.mainReducer (reducers.ts:114) 
at v (redux.js:212) at middleware.ts:34 
at middleware.ts:22 at index.js:11 
at dispatch (redux.js:636) 
at fetchVegobjekter.ts:53
{noformat}
 ",NVDB-6937,Vegkart,
"NVDBREF-431 - Sideanleggsdel viser feil vegsystemreferanse for ""ankerpunkt"" sideanlegg","Velger: EV6S202, Sideanlegg og Sideanleggsdel.

Sideanlegg har vegsystemreferanse EV6 S202D1 m2430, mens sideanleggsdel har ankerpunkt EV6 S202D1 m8323.

Sideanlegg har vegsystemreferanse EV6 S202D1 m5855, mens de to sideanleggsdelene har ankerpunkt EV6 S202D1 m6695. Dette er feil.

Sideanlegg har vegsystemreferanse EV6 S202D1 m9502, mens sideanleggsdelene har ankerpunkt EV6 S202D1 m21183.

Dette er feil.

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/hva:(~(farge:'0_1,id:919),(farge:'1_0,id:920))/hvor:(vegsystemreferanse:(~'EV6S202))/@812060,7788144,10/vegobjekt:1004496487:40a744:919]",NVDB-6937,NVDB-IND,
Feilmelding: Feil ved henting av vegnett da man tar vekk haken på Adskilte løp,"{color:#172b4d}Har valgt EV8 og zoomer inn til stedet Breivika ved Tromsø.{color}
{color:#172b4d}Velger Vegnett og slår på Vis i kart og alle valg er avkrysset. Forsøker å ta vekk hakene for Adskilte løp: uten, med og mot. Da kommer feilmeldingen. ""Feil ved henting av vegnett""{color}

 ",NVDB-6937,Vegkart,
NVDBREF- 432 og  436 - Visning av retning i Vegkart er feil,"Jeg velger EV8.
Jeg ser at på 3 av 5 rundkjøringer på strekningen 1 er det vist at metreringen går i motsatt retning av geometrien. Dette er feil. Det er ikke slik når jeg ser på vegsystemreferansen.

[https://www.utv.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/@654213,7734963,17/hvor:~(vegsystemreferanse~(~'EV8))/vegnett:~'metrering*~()/valgt:1125812:5:2/vegsystemreferanse:654217.101:7734984.815]

 
 * 
 * 
{color:#344563}Opt{color}",NVDB-6937,Vegkart,
Sjekk om segmentering av superstedfesting er kontinuerlig,"Fra @NKAmapper på gitter 
{quote}
""Det forekommer en god del veldig korte veibiter i det segmenterte vegnettet, bare noen centimeter lange. Eksempler: 2177784-2-3, 122395-32-9, 122632-3-2. Alle disse har overlapppende/identisk superstedfesting med naboen, som skaper en del problemer når vegobjekter skal flettes inn i vegnettet."" Alle disse ser ut som bugs.
{quote}

{quote}
Tja, de overlapper ikke lenger, men er ekstremt korte og lager hakk i geometrien. Her er en på 4 cm: 2264914-6-14
{quote}

Sjekk også steder der meterberegning feiler (NVDB-5454)",NVDB-6937,NVDB-IND,
NVDBREF-440 (C) - Kjørebanelenkene i start og slutt på adskilte løp i Lierbakkene får feil vegref,"Fra Håvard Lerstad: 

Kjørebanelenkene I starten og slutten av adskilt løp 1-2 og 1-3 får feil vegref I Lierbakkene.

Hovedstrekning=47, men disse segmentene får strekning=S46D350 og dermed meterverdier som ikke harmonerer med resten av anlegget.

Vegkart:

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/hvor:(vegsystemreferanse:(~'EV18))/@234773,6637486,17/vegnett:(trafikantgruppe:'alle,veglenketype:'alle,adskiltelop:'alle)]",NVDB-6937,NVDB-IND,
NVDBREF-439 (B) Feil metrering på kjørebanenivå for de fleste rundkjøringer i Kongsberg,"Håvard Lerstad melder at kjørebanelenkene inn og ut av rundkjøringer får strekning =1042 for de fleste rundkjøringer på hovedstrekning=42.

[https://www.vegvesen.no/nvdb/vegkart/v3/#kartlag:geodata/vegsystemreferanse:199028.00157162812:6626605.858680467/hvor:(vegsystemreferanse:(~'EV134))/@199028,6626573,18/vegnett:(trafikantgruppe:'alle,veglenketype:'alle,adskiltelop:'alle)]

 

Han har merket saken ""med Major priority""",NVDB-6937,Les-API,
Begrens tilgang til egenskaper basert på roller,"h2. Introduksjon

Det innføres tre nye roller i LDAP for å regulere brukeres tilgang til å lese og skrive egenskaper på vegobjekter i NVDB:

nva/0_sensitive_role1
 nva/0_sensitive_role2
 nva/0_sensitive_role3

Tallet tilsvarer sensitivitetsnivå for egenskapstypene i datakatalogen.

Lese-endepunktet til API Skriv skal maskere bort alle egenskaper som brukeren ikke har rolle for.

Endringssett skal avvises dersom det er angitt en egenskap brukeren ikke har ""tilgang"" til.
h2. Løsning

For lese-endepunktene er det endret slik at sensitive egenskaper brukeren har rolle for ikke blir filtrert bort. For oppdatering av objekter er det lagt inn et nytt filter, AttributeTypeAuthorizationJobFilter, som avviser skriving av sensitive egenskaper brukeren ikke har rolle for. Dette gjelder bare sensitive egenskaper, slik at det vil være mulig å oppdatere egenskaper som ikke er sensitive på et objekt med sensitive egenskaper uten å ha rolle for de sensitieve egenskapene.",NVDB-6937,Skriv-API,
Endringssett opprettet med v2 får ikke oppdatert status på v3,"Vi bruker URL til endringsett sånn den ligger i databasen, men respons fra v2 og v3 er ikke helt like. Derfor vil endringsett som er opprettet med v2 feile når vi bruker v3.",NVDB-6937,Datafangst,
Legg til medium_nvdb,"Les gir ut medium som kortversjonen fra SOSI. Skriv tar inn tallversjonen fra enumegenskapen.
Legg til medium_nvdb som gir ut nvdb-verdien",NVDB-6937,Les-API,
Ugyldig gyldighetsperiode avdekket i SanitationJobFilter,"h2. Observasjon

Endringssett https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/6ebe5c78-fdc3-4886-b463-c35cc2aa4fd7 havner i SYSTEMFEIL etter ""validering"" i SanitationJobFilter:

{code:java}
java.lang.IllegalStateException: Detected invalid lifetime for 1 closed feature version(s):
op:CORRECT tid:616 id:86009923 v:2 sd:1997-05-27 ed:1950-01-01 - ac:UPDATE or:PrepareForRemoveEnricherFilter vr:true - [StringAttribute{typeId=5528, operation=READ, values=[1#2]}, LocationalAttribute{typeId=120616, operation=READ, values=[121369: 0.0->1.0, 121394: 0.0->0.3160925, 121746: 0.0->0.10943457]}]
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.SanitationJobFilter.ensureValidLifetime(SanitationJobFilter.java:139)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.SanitationJobFilter.doFilter(SanitationJobFilter.java:47)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateAfterLocking(DefaultValidationService.java:129)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$21(JobWorker.java:512)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$validateAfterLock$22(JobWorker.java:511)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateAfterLock(JobWorker.java:510)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:177)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
	at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1390)
	at org.apache.activemq.ActiveMQMessageConsumer.iterate(ActiveMQMessageConsumer.java:1552)
	at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:191)
	at org.apache.activemq.ActiveMQSessionExecutor.wakeup(ActiveMQSessionExecutor.java:111)
	at org.apache.activemq.ActiveMQMessageConsumer.start(ActiveMQMessageConsumer.java:1527)
	at org.apache.activemq.ActiveMQMessageConsumer$7.run(ActiveMQMessageConsumer.java:1308)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Timer.java:555)
	at java.util.TimerThread.run(Timer.java:505)
{code}

h2. Analyse

I endringssettet fjernes vegobjekt 86009923v3 av type 616. Under behandling kopieres sluttdato for v3 til v2 via en korrigering (følgeoppdatering). I NVDB er imidlertid v3 registrert med ugyldig levetid: 2003-11-15 - 1950-01-01. Versjon 2 har gyldighetsperiode 1997-05-27 - 2003-11-15. Etter kopiering av sluttdato blir gyldighetsperioden for v2 altså 1997-05-27 - 1950-01-01. Dette fanges opp i SanitationJobFilter som avviser korrigeringen.

Årsaken til hendelsen er altså datafeil i NVDB. Dette ble innført av Klassisk API i 2006: https://www.vegvesen.no/nvdb/apiskriv/rest/v1/oppdrag/32669.

For å få dette endringssettet gjennom kan det utvides med en eksplisitt korrigering av v2, der sluttdato settes til en gyldig dato (eller null).",NVDB-6937,Skriv-API,
Gi kun ett svar per vegreferanse i /posisjon,"Se siste kommentarer i https://github.com/nvdb-vegdata/nvdb-api-client/issues/61

Løsningsforslag: i PosistionService, ha et ekstra Set<String> der vegsystem og strekning legges. Så dersom FV7556 S1D1 allerede er lagt inn skal ikke neste segment for denne være med ut.",NVDB-6937,Les-API,
/veg søker kun i hovedlenker,"https://www.vegvesen.no/nvdb/api/v3/veg?veglenkesekvens=0.5@181449 returnerer ingen svar, fordi veglenkesekvensen er detajert lenke. 

Sjekk om /veg burde hatt ?konnekteringslenker og ?detaljerte_lenker som /posisjon har.
",NVDB-6937,Les-API,
GUI: skille på Arbeid med veglister og Generere/publisere veglister,"Veglister genereres i to kontekster:
 # *Arbeide med veglister*
 Eksperimentere med ulik input - stor fleksibilitet.
 Dette er dagens løsning ([https://nvdb-veglister.utv.atlas.vegvesen.no/]).

 # *Generere veglister for publisering*
 Streng input i henhold til gjeldende regler - liten fleksibilitet (minimere mulighet for feil).

 Basert på disse to brukstilfellene foreslår jeg at dette skillet visualiseres i front-end ved at bruker først må ta stilling til om hvilken av disse det skal jobbes med.

For den første “Arbeid med veglister” endres følgende:
 * *1 a)*
 (/) Dagens front-end utvides med mulighet for å velge flere fylker (på samme måte som kommuner). Må endres i REST API også (mikroskopisk endring). (NVDBREF-425, NVDBREF-426)
 * *1 b)*
 (/) Dagens front-end utvides med mulighet for å angi flere Vegsystemreferanser (kommaseparert liste). Alt klart i REST API og backend/motor. (NVDBREF-424)
 Vegsystemreferanse er for ekspertbrukere - begrepet er ikke godt kjent i veglistemiljøet!

 For den andre “Generere veglister for publisering” endres dette:
 * *2 a)*
 (/) I front-end skjules feltet for å angi Vegsystemreferanse (mindre fleksibilitet), og erstattes av en mulighet for å velge én av: “Riksveger” eller “Fylkes- og kommunale veger”.
 Bak kulissene setter valg av “Riksveger” verdien “EV, RV” i det skjulte feltet for Vegsystemreferanse. Valg av “Fylkes- og kommunale veger” setter “FV, KV” i det samme skjulte feltet.

 * *2 b)*
 (/) Når bruker velger “Riksveger” skal alle fylker forhåndsvelges i front-end (kan ikke endres av bruker)

 * *2 c)*
 (/) Når bruker velger “Fylkes- og kommunale veger” kan bare ett fylke velges i front-end.

 * *2 d)*
 (/) I front-end skjules muligheten for å velge kommuner.",NVDB-6825,Rapportgenerator,
Word-fil formatere innhold,"Ferdigstille formatering av innhold i eksport til Word-format.

Ref. POC i NVDBREF-419",NVDB-6825,Rapportgenerator,
Vegnettrapport og veglengder med stedsnavn,"Vegnettsgruppa etterspør muligheten til å ta ut såkalte ""vegnettsrapporter"" og ""veglengder"" som også inkluderer stedsnavn (fra NVDB) for start- og slutt på hver rad i utlistingen. Altså 1 rad = et stykke veg, og start og slutt angis med nærmeste innenfor søkeradius stedsnavn-forekomst fra NVDB. Stedsnavnet må være tilknyttet samme vegen (samme vegkategori og vegnummer). ",NVDB-6827,Rapportgenerator,
Håndtere status UTFØRT OG ETTERBEHANDLET fra Skriv,"Det ble meldt fra bruker i Prod om at endringssett havnet i status ""ANNEN STATUS"": [https://datafangst.kantega.no/#!/contract/312533fe-645a-4fa2-9e63-9d139b0fde1c/export]

Dette er rett og slett fordi vi ikke mapper fra Skriv sin status UTFØRT_OG_ETTERBEHANDLET. 

Resultatet er at brukerens objekter nå ligger i behandling uten at brukeren får gjort noe med dette.

*Oppgaver*
 * Håndtere status UTFØRT_OG_ETTERBEHANDLET fra Skriv
 * Sjekk databasen for hvor mange dette gjelder og endre fra ""ANNEN STATUS"" til UTFØRT_OG_ETTERBEHANDLET dersom dette gjelder disse endringssettene. Verifiser at objektene blir ""låst opp"" etterpå

Vi bør senere - lag eventuelt en sak på dette - på å polle Skriv _etter_ at status er UTFØRT for å fange opp indekseringen til API Les, noe som da reflekteres gjennom statusen UTFØRT_OG_ETTERBEHANDLET

 
h3. Notater

For å få Datafangst til å oppføre seg konsistent, velger vi å transformere Fremdrift.UTFØRT_OG_ETTERBEHANDLET til ChangesetProgress.COMPLETED. Dette er for å beholde en forutsigbar sluttilstand for innsendinger i datafangst.

Dette er en banal løsning, men det ser ut som om den skal håndteres rett om vi ikke gjør forskjell på  UTFØRT og UTFØRT_OG_ETTERBEHANDLET.

Det er godt mulig at ""utøfrt"" og ""utført og etterbehandlet"" bør behandles ulikt for å følge med på etterbehandlingsstatusen til en innsending, og i så fall må det vurderes om vi skal endre sluttilstand (fra COMPLETED til noe annet) eller om vi skal legge inn en tilstand _før_ COMPLETED som mappes fra UTFØRT, slik at UTFØRT_OG_ETTERBEHANDLET mappes til COMPLETED.",NVDB-6937,Datafangst,
To endringsset fikk opprettet samme versjon av objekt,"h2. Observasjon

Det har blitt sendt inn to identiske endringssett nesten samtidig
https://www.vegvesen.no/nvdb/apiskriv/rest/v1/oppdrag/4723942
https://www.vegvesen.no/nvdb/apiskriv/rest/v1/oppdrag/4723943

Dette førte til at Stikkrenne/Kulvert (79) 635163377 fikk to objekter med versjon 2. 

h2. Analyse

Endringssettet inneholder en delvis oppdatering (versjonering) av vegobjekt type 79, id 635163377.

Hendelseslogg for endringssett 1 (https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/3ff04a6f-5a20-46ad-8049-9d67f87c4ac8):

2020-01-22 14:20:26.188	JOB_PROCESSING_STARTED
2020-01-22 14:20:26.571	SYNTACTIC_VALIDATION_OK
2020-01-22 14:20:28.309	LOCKED
2020-01-22 14:20:28.425	RELATIONAL_VALIDATION_OK
2020-01-22 14:20:28.520	STORED_IN_NVDB
2020-01-22 14:20:28.574	UNLOCKED

Hendelseslogg for endringssett 2 (https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/6f0b7c6d-a472-4751-ac95-17cd277afcd2):

2020-01-22 14:20:28.269	JOB_PROCESSING_STARTED
2020-01-22 14:20:28.651	SYNTACTIC_VALIDATION_OK
2020-01-22 14:20:30.349	LOCKED
2020-01-22 14:20:30.459	RELATIONAL_VALIDATION_OK
2020-01-22 14:20:30.596	STORED_IN_NVDB
2020-01-22 14:20:30.609	UNLOCKED

Normalt ville låsemekanismene hindre at to endringssett endrer samme vegobjekt ""samtidig"". Men som vi ser av hendelsesloggene over, ble låsen til første endringssett fjernet (14:20:28.574) før etablering av lås for det andre (14:20:30.349).

Endringssett 1 ble commit'et rett før låsen ble fjernet (14:20:28.574). Endringssett 2 kjørte PrepareForModifyEnricherFilter 14:20:28.434 i følge Splunk. Dette filteret kontrollerer bl.a. at angitt versjon for oppdatering er faktisk siste versjon i NVDB.
Det ser ut til at dette filteret ble kjørt rett før endringssett 1 ble commit'et og derfor ikke oppdaget at vegobjektet allerede var versjonert.

h2. Løsning

Umiddelbart etter låsing utfører API Skriv versjonssjekk på vegobjektene jobben er blitt beriket med, for å kontrollere at ikke andre prosesser har endret dem (f.eks. versjonert) siden de ble lest inn fra NVDB. Dette skjer i klassen JobExtensionVersionChecker. Denne klassen endres til å utføre versjonssjekk på samtlige vegobjekter, både de som er beriket inn i jobben og de som har opphav i endringssettet.
",NVDB-6937,Skriv-API,
Tech Debt: TsLint er deprecated. Bytt til et annet verktøy,"TS-lint er deprecated: [https://medium.com/palantir/tslint-in-2019-1a144c2317a9]

ES-lint har god støtte for typescript no, og er bransjestandard. Vi bør ta det i bruk.",NVDB-6937,Vegkart,
Tech Debt: Splitte opp reducers.ts til ulike ActionType-grupperinger,,NVDB-6937,Vegkart,
Fjerning av område gir feil,"h2. Observasjon

Åpne Vegkart. Legg til område Trondheim. Fjern Trondheim. Feil
{noformat}
Uncaught TypeError: Cannot read property 'roadNetState' of undefined
{noformat}",NVDB-6937,Vegkart,
"Tech Debt: Full gjennomgang av State, uhensiktsmessig hierarki",,NVDB-6937,Vegkart,
Feiler på å sette blank verdi for NVDB-objekter,"h2. Observasjon

Prøver å fjerne en egenskapsverdi for et importert objekt (sette verdi blank). Dette gir en feil.

Prøv å sette f.ex Fjernavlesning blank for Elektrisk Anlegg i kontrakt [https://datafangst-test.kantega.no/#!/contract/997c62c8-abb7-4aa3-a069-9d77ef85fae4/features3]

Denne observasjonen kommer av en lignende observert i Prod, hvor API Skriv gir en HTTP 400 på valideringen. Riktignok går det fint å sette en verdi blank i Prod nå så usikker på sammenhengen, men feilmld fra Skriv på valideringen er lik her og i observasjonen fra ATM.

Fra prod-observasjon:
{noformat}
https://vegdata.kantega.no/kibana/app/kibana#/context/datafangst-logs-*/doc/6Tnp0W8B9qfWmpvbB0Li?_a=(columns:!(_source),filters:!(),predecessorCount:5,sort:!('@timestamp',desc),successorCount:5)&_g=(refreshInterval:(pause:!t,value:0),time:(from:now-15m,mode:quick,to:now)){noformat}
Request
{noformat}
11189 * LoggingFilter - Request received on thread http-nio-127.0.0.1-8080-exec-14 
11189 > POST https://www.vegvesen.no/nvdb/apiskriv/v3/endringssett/validator?skipLocation=true&useObjectList=true 
11189 > X-Client: Datafangst 11189 > Content-Type: application/xml 
 
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><endringssett xmlns=""http://nvdb.vegvesen.no/apiskriv/domain/changeset/v3""><delvisOppdater><vegobjekter><vegobjekt typeId=""461"" nvdbId=""736973415"" versjon=""2""><egenskaper><egenskap typeId=""5644"" operasjon=""oppdater""><verdi>Trafikkregistreringsstasjon</verdi></egenskap><egenskap typeId=""10032"" operasjon=""oppdater""><verdi>Cu wiret</verdi></egenskap><egenskap typeId=""10022"" operasjon=""oppdater""><verdi>Tavlenorm</verdi></egenskap><egenskap typeId=""10023"" operasjon=""oppdater""><verdi>2019</verdi></egenskap><egenskap typeId=""10038"" operasjon=""oppdater""><verdi>230</verdi></egenskap><egenskap typeId=""10039"" operasjon=""oppdater""><verdi>Forsynes fra Veglysfordeling</verdi></egenskap><egenskap typeId=""11124"" operasjon=""oppdater""><verdi>Driftskontrakt</verdi></egenskap><egenskap typeId=""10028"" operasjon=""slett""><verdi xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"" xsi:nil=""true""/></egenskap><egenskap typeId=""10033"" operasjon=""oppdater""><verdi>En for hver kurs</verdi></egenskap><egenskap typeId=""10021"" operasjon=""oppdater""><verdi>NEK FEL 1998</verdi></egenskap><egenskap typeId=""10029"" operasjon=""oppdater""><verdi>IT</verdi></egenskap><egenskap typeId=""5641"" operasjon=""oppdater""><verdi>ingen måler</verdi></egenskap></egenskaper><gyldighetsperiode><startdato>2020-01-23</startdato></gyldighetsperiode><validering><lestFraNvdb>2019-09-27T12:27:50</lestFraNvdb></validering></vegobjekt></vegobjekter></delvisOppdater><datakatalogversjon>2.19-865</datakatalogversjon></endringssett>
{noformat}
Respons
{noformat}
<?xml version=""1.0"" encoding=""UTF-8"" standalone=""yes""?><fault xmlns=""http://nvdb.vegvesen.no/apiskriv/fault/v1""><message>Request body unmarshalling failed at line: 1, col: 943: cvc-elt.3.1: Attribute 'http://www.w3.org/2001/XMLSchema-instance,nil' must not appear on element 'verdi', because the {nillable} property of 'verdi' is false.</message></fault>{noformat}
h2. Analyse
 * Bad request mot skriv.
 * Vi sender med verdi når operation = slett. det er syntax feil. 

h2. Løsning

- Ikke send verdi når operasjon = slett

 ",NVDB-6937,Datafangst,
Misvisende farge på objekt far direkte url,"h2. Observasjon

Hent opp url med id for vegobjekt.
{noformat}
https://vegkart-v3.utv.atlas.vegvesen.no/#kartlag:geodata/@263412,7014284,10/hva:~(~(id~581))/valgt:85339025:581
{noformat}
Her er tunnel med i søket, og valgt objekt får annen farge enn vegobjekttypen som er med.",NVDB-6937,Vegkart,
IndexOutOfBoundsException ved restedfesting etter geometriutskiftning,"h2. Observasjon

Endringssettene

* https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/e378c3ea-0061-46ce-9962-18c1f63a3a3d
* https://www.vegvesen.no/nvdb/apiskriv/kontrollpanel/#/jobs/view/45bc5dc9-e346-4373-903e-30accf7f0c50

ender med SYSTEMFEIL pga IndexOutOfBoundsException ved utvidelse av ny stedfesting ifm. geometriutskiftning på vegnett:

{code:java}
java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:657)
	at java.util.ArrayList.get(ArrayList.java:433)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.LocationalExtender.extendLengthOneMmIfPossible(LocationalExtender.java:26)
	at no.vegvesen.vt.nvdb.apiskriv.domain.locational.LocationCalculator.calcLocationalLine(LocationCalculator.java:135)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalizeToLine(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:896)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableLocational.relocalize(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:877)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter$RelocalizableFeature.relocalizeIfOutsideDelta(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:702)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.addEnrichmentOrReportConflict(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:425)
	at no.vegvesen.vt.nvdb.apiskriv.validation.job.AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.doFilter(AdaptFeaturesToChangedRefLinkGeometryEnricherFilter.java:153)
	at no.vegvesen.vt.nvdb.apiskriv.validation.JobProcessor.process(JobProcessor.java:107)
	at no.vegvesen.vt.nvdb.apiskriv.validation.DefaultValidationService.validateBeforeLocking(DefaultValidationService.java:122)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$null$13(JobWorker.java:389)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$validateBeforeLock$14(JobWorker.java:388)
	at no.vegvesen.vt.nvdb.apiskriv.jdbc.Jdbc.readOnly(Jdbc.java:75)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.validateBeforeLock(JobWorker.java:387)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.lambda$submit$0(JobWorker.java:163)
	at no.vegvesen.vt.nvdb.apiskriv.logutils.MdcHelper.putAndRemoveJobIdMdc(MdcHelper.java:53)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobWorker.submit(JobWorker.java:137)
	at no.vegvesen.vt.nvdb.apiskriv.jobmanager.JobListener.lambda$new$0(JobListener.java:24)
	at no.vegvesen.vt.nvdb.apiskriv.jms.Subscription.onMessage(Subscription.java:138)
{code}

h2. Analyse

Vegobjektet det skal beregnes ny strekningsstedfesting for har punktgeometri. Punktet er ""bortenfor"" enden av eneste aktuelle veglenke (249130:1), slik at både beregnet start- og sluttposisjon (0.052273299999999995) for den nye utstrekningen blir ""nesten"" identisk med veglenkens endeposisjon (0.0522733). Siden de ikke er eksakt samme verdi, vil ikke LocationCalculator.calcRelativePosition justere posisjonen vekk fra veglenkens endeposisjon, som er ikke-inklusiv. Den beregnede utstrekningen med identisk start- og sluttposisjon forsøkes utvidet via kall til extendLengthOneMmIfPossible. Her forsøkes plukket ut en veglenke som omslutter (encloses) både den beregnede start- og sluttposisjonen. Siden denne posisjonen er svært nær den ikke-inklusive endeposisjonen til eneste relevante veglenke vil Extent.encloses returnere false og get(0) på listen havarerer med IndexOutOfBoundsException.

h2. Løsning

LocationCalculator.calcRelativePosition sin logikk for å unngå at en ikke-inklusiv relativ posisjon returneres, forbedres ved at den reduseres med 1 mm dersom den i utgangspunktet er 1 mm eller mindre fra endeposisjonen til veglenken. Dermed unngår vi at sammenligningstoleransen i Extent.encloses slår til.",NVDB-6937,Skriv-API,
